# Comparing `tmp/ops-2.3.0.tar.gz` & `tmp/ops-2.4.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "ops-2.3.0.tar", last modified: Wed May 31 00:33:43 2023, max compression
+gzip compressed data, was "ops-2.4.0.tar", last modified: Tue Jul  4 03:48:56 2023, max compression
```

## Comparing `ops-2.3.0.tar` & `ops-2.4.0.tar`

### file list

```diff
@@ -1,46 +1,46 @@
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-31 00:33:43.160119 ops-2.3.0/
--rw-r--r--   0 runner    (1001) docker     (123)    11358 2023-05-31 00:33:40.000000 ops-2.3.0/LICENSE.txt
--rw-r--r--   0 runner    (1001) docker     (123)     6977 2023-05-31 00:33:43.160119 ops-2.3.0/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     6283 2023-05-31 00:33:40.000000 ops-2.3.0/README.md
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-31 00:33:43.156119 ops-2.3.0/ops/
--rw-r--r--   0 runner    (1001) docker     (123)     5225 2023-05-31 00:33:40.000000 ops-2.3.0/ops/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-31 00:33:43.156119 ops-2.3.0/ops/_private/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-31 00:33:40.000000 ops-2.3.0/ops/_private/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     1978 2023-05-31 00:33:40.000000 ops-2.3.0/ops/_private/timeconv.py
--rw-r--r--   0 runner    (1001) docker     (123)     1224 2023-05-31 00:33:40.000000 ops-2.3.0/ops/_private/yaml.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    54095 2023-05-31 00:33:40.000000 ops-2.3.0/ops/charm.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    53402 2023-05-31 00:33:40.000000 ops-2.3.0/ops/framework.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     4775 2023-05-31 00:33:40.000000 ops-2.3.0/ops/jujuversion.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-31 00:33:43.156119 ops-2.3.0/ops/lib/
--rw-r--r--   0 runner    (1001) docker     (123)     9839 2023-05-31 00:33:40.000000 ops-2.3.0/ops/lib/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     2525 2023-05-31 00:33:40.000000 ops-2.3.0/ops/log.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    17905 2023-05-31 00:33:40.000000 ops-2.3.0/ops/main.py
--rw-r--r--   0 runner    (1001) docker     (123)   125257 2023-05-31 00:33:40.000000 ops-2.3.0/ops/model.py
--rw-r--r--   0 runner    (1001) docker     (123)    98073 2023-05-31 00:33:40.000000 ops-2.3.0/ops/pebble.py
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-31 00:33:40.000000 ops-2.3.0/ops/py.typed
--rwxr-xr-x   0 runner    (1001) docker     (123)    15197 2023-05-31 00:33:40.000000 ops-2.3.0/ops/storage.py
--rwxr-xr-x   0 runner    (1001) docker     (123)   128227 2023-05-31 00:33:40.000000 ops-2.3.0/ops/testing.py
--rw-r--r--   0 runner    (1001) docker     (123)       46 2023-05-31 00:33:42.000000 ops-2.3.0/ops/version.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-31 00:33:43.156119 ops-2.3.0/ops.egg-info/
--rw-r--r--   0 runner    (1001) docker     (123)     6977 2023-05-31 00:33:43.000000 ops-2.3.0/ops.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)      704 2023-05-31 00:33:43.000000 ops-2.3.0/ops.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (123)        1 2023-05-31 00:33:43.000000 ops-2.3.0/ops.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (123)       34 2023-05-31 00:33:43.000000 ops-2.3.0/ops.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (123)        4 2023-05-31 00:33:43.000000 ops-2.3.0/ops.egg-info/top_level.txt
--rw-r--r--   0 runner    (1001) docker     (123)      983 2023-05-31 00:33:40.000000 ops-2.3.0/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (123)       38 2023-05-31 00:33:43.160119 ops-2.3.0/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (123)     2917 2023-05-31 00:33:40.000000 ops-2.3.0/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-31 00:33:43.160119 ops-2.3.0/test/
--rwxr-xr-x   0 runner    (1001) docker     (123)    21858 2023-05-31 00:33:40.000000 ops-2.3.0/test/test_charm.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    64425 2023-05-31 00:33:40.000000 ops-2.3.0/test/test_framework.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     4658 2023-05-31 00:33:40.000000 ops-2.3.0/test/test_helpers.py
--rw-r--r--   0 runner    (1001) docker     (123)     5124 2023-05-31 00:33:40.000000 ops-2.3.0/test/test_infra.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     6782 2023-05-31 00:33:40.000000 ops-2.3.0/test/test_jujuversion.py
--rw-r--r--   0 runner    (1001) docker     (123)    22453 2023-05-31 00:33:40.000000 ops-2.3.0/test/test_lib.py
--rw-r--r--   0 runner    (1001) docker     (123)     5418 2023-05-31 00:33:40.000000 ops-2.3.0/test/test_log.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    46889 2023-05-31 00:33:40.000000 ops-2.3.0/test/test_main.py
--rwxr-xr-x   0 runner    (1001) docker     (123)   130069 2023-05-31 00:33:40.000000 ops-2.3.0/test/test_model.py
--rw-r--r--   0 runner    (1001) docker     (123)   125097 2023-05-31 00:33:40.000000 ops-2.3.0/test/test_pebble.py
--rw-r--r--   0 runner    (1001) docker     (123)     3900 2023-05-31 00:33:40.000000 ops-2.3.0/test/test_private.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    15155 2023-05-31 00:33:40.000000 ops-2.3.0/test/test_storage.py
--rw-r--r--   0 runner    (1001) docker     (123)   191372 2023-05-31 00:33:40.000000 ops-2.3.0/test/test_testing.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-04 03:48:56.240702 ops-2.4.0/
+-rw-r--r--   0 runner    (1001) docker     (123)    11358 2023-07-04 03:48:53.000000 ops-2.4.0/LICENSE.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     4077 2023-07-04 03:48:56.240702 ops-2.4.0/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     3383 2023-07-04 03:48:53.000000 ops-2.4.0/README.md
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-04 03:48:56.236702 ops-2.4.0/ops/
+-rw-r--r--   0 runner    (1001) docker     (123)     7506 2023-07-04 03:48:53.000000 ops-2.4.0/ops/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-04 03:48:56.240702 ops-2.4.0/ops/_private/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-07-04 03:48:53.000000 ops-2.4.0/ops/_private/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1978 2023-07-04 03:48:53.000000 ops-2.4.0/ops/_private/timeconv.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1224 2023-07-04 03:48:53.000000 ops-2.4.0/ops/_private/yaml.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    52280 2023-07-04 03:48:53.000000 ops-2.4.0/ops/charm.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    53224 2023-07-04 03:48:53.000000 ops-2.4.0/ops/framework.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     4800 2023-07-04 03:48:53.000000 ops-2.4.0/ops/jujuversion.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-04 03:48:56.240702 ops-2.4.0/ops/lib/
+-rw-r--r--   0 runner    (1001) docker     (123)     9839 2023-07-04 03:48:53.000000 ops-2.4.0/ops/lib/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2476 2023-07-04 03:48:53.000000 ops-2.4.0/ops/log.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    17834 2023-07-04 03:48:53.000000 ops-2.4.0/ops/main.py
+-rw-r--r--   0 runner    (1001) docker     (123)   126790 2023-07-04 03:48:53.000000 ops-2.4.0/ops/model.py
+-rw-r--r--   0 runner    (1001) docker     (123)   100804 2023-07-04 03:48:53.000000 ops-2.4.0/ops/pebble.py
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-07-04 03:48:53.000000 ops-2.4.0/ops/py.typed
+-rwxr-xr-x   0 runner    (1001) docker     (123)    15224 2023-07-04 03:48:53.000000 ops-2.4.0/ops/storage.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)   127739 2023-07-04 03:48:53.000000 ops-2.4.0/ops/testing.py
+-rw-r--r--   0 runner    (1001) docker     (123)       46 2023-07-04 03:48:56.000000 ops-2.4.0/ops/version.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-04 03:48:56.236702 ops-2.4.0/ops.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (123)     4077 2023-07-04 03:48:56.000000 ops-2.4.0/ops.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)      704 2023-07-04 03:48:56.000000 ops-2.4.0/ops.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        1 2023-07-04 03:48:56.000000 ops-2.4.0/ops.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (123)       34 2023-07-04 03:48:56.000000 ops-2.4.0/ops.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        4 2023-07-04 03:48:56.000000 ops-2.4.0/ops.egg-info/top_level.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     1082 2023-07-04 03:48:53.000000 ops-2.4.0/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (123)       38 2023-07-04 03:48:56.240702 ops-2.4.0/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (123)     2910 2023-07-04 03:48:53.000000 ops-2.4.0/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-04 03:48:56.240702 ops-2.4.0/test/
+-rwxr-xr-x   0 runner    (1001) docker     (123)    21858 2023-07-04 03:48:53.000000 ops-2.4.0/test/test_charm.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    64425 2023-07-04 03:48:53.000000 ops-2.4.0/test/test_framework.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     4658 2023-07-04 03:48:53.000000 ops-2.4.0/test/test_helpers.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5124 2023-07-04 03:48:53.000000 ops-2.4.0/test/test_infra.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     6782 2023-07-04 03:48:53.000000 ops-2.4.0/test/test_jujuversion.py
+-rw-r--r--   0 runner    (1001) docker     (123)    22453 2023-07-04 03:48:53.000000 ops-2.4.0/test/test_lib.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5418 2023-07-04 03:48:53.000000 ops-2.4.0/test/test_log.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    46874 2023-07-04 03:48:53.000000 ops-2.4.0/test/test_main.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)   132002 2023-07-04 03:48:53.000000 ops-2.4.0/test/test_model.py
+-rw-r--r--   0 runner    (1001) docker     (123)   125097 2023-07-04 03:48:53.000000 ops-2.4.0/test/test_pebble.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3900 2023-07-04 03:48:53.000000 ops-2.4.0/test/test_private.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    15155 2023-07-04 03:48:53.000000 ops-2.4.0/test/test_storage.py
+-rw-r--r--   0 runner    (1001) docker     (123)   191372 2023-07-04 03:48:53.000000 ops-2.4.0/test/test_testing.py
```

### Comparing `ops-2.3.0/LICENSE.txt` & `ops-2.4.0/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `ops-2.3.0/ops/_private/timeconv.py` & `ops-2.4.0/ops/_private/timeconv.py`

 * *Files identical despite different names*

### Comparing `ops-2.3.0/ops/_private/yaml.py` & `ops-2.4.0/ops/_private/yaml.py`

 * *Files identical despite different names*

### Comparing `ops-2.3.0/ops/charm.py` & `ops-2.4.0/ops/charm.py`

 * *Files 4% similar despite different names*

```diff
@@ -18,53 +18,45 @@
 import os
 import pathlib
 from typing import (
     TYPE_CHECKING,
     Any,
     Dict,
     List,
+    Literal,
     Mapping,
     Optional,
     TextIO,
+    Tuple,
     Union,
     cast,
 )
 
 from ops import model
 from ops._private import yaml
 from ops.framework import EventBase, EventSource, Framework, Object, ObjectEvents
 
 if TYPE_CHECKING:
-    from typing_extensions import Literal, Required, TypedDict
+    from typing_extensions import Required, TypedDict
 
-    from ops.framework import Handle, JsonObject, _SerializedData
-    from ops.model import Container, Numerical, Relation, Storage
-
-    # CharmMeta also needs these.
-    _ActionParam = Dict[str, 'JsonObject']  # <JSON Schema definition>
-    _ActionMetaDict = TypedDict(
-        '_ActionMetaDict', {
-            'title': str,
-            'description': str,
-            'params': Dict[str, _ActionParam],
-            'required': List[str]},
-        total=False)
+    from ops.framework import Handle
+    from ops.model import Container, Relation, Storage
 
     _Scopes = Literal['global', 'container']
     _RelationMetaDict = TypedDict(
         '_RelationMetaDict', {
             'interface': Required[str],
             'limit': int,
             'scope': _Scopes},
         total=False)
 
     _MultipleRange = TypedDict('_MultipleRange', {'range': str})
     _StorageMetaDict = TypedDict('_StorageMetaDict', {
         'type': Required[str],
-        'description': int,
+        'description': str,
         'shared': bool,
         'read-only': bool,
         'minimum-size': str,
         'location': str,
         'multiple-range': str,
         'multiple': _MultipleRange
     })
@@ -72,63 +64,18 @@
     _ResourceMetaDict = TypedDict(
         '_ResourceMetaDict', {
             'type': Required[str],
             'filename': str,
             'description': str},
         total=False)
 
-    _PayloadMetaDict = TypedDict('_PayloadMetaDict', {'type': str})
-
     _MountDict = TypedDict(
         '_MountDict', {'storage': Required[str],
                        'location': str},
         total=False)
-    _ContainerMetaDict = TypedDict(
-        '_ContainerMetaDict', {'mounts': List[_MountDict]})
-
-    _CharmMetaDict = TypedDict(
-        '_CharmMetaDict', {  # all are optional
-            'name': Required[str],
-            'summary': Required[str],
-            'description': Required[str],
-            'maintainer': str,
-            'maintainers': List[str],
-            'tags': List[str],
-            'terms': List[str],
-            'series': List[str],
-            'subordinate': bool,
-            'min-juju-version': str,
-            'requires': Dict[str, '_RelationMetaDict'],
-            'provides': Dict[str, '_RelationMetaDict'],
-            'peers': Dict[str, '_RelationMetaDict'],
-            'storage': Dict[str, '_StorageMetaDict'],
-            'resources': Dict[str, '_ResourceMetaDict'],
-            'payloads': Dict[str, '_PayloadMetaDict'],
-            'extra-bindings': Dict[str, Any],  # fixme: _BindingDict?
-            'containers': Dict[str, '_ContainerMetaDict']
-        }, total=False)
-
-    # can't put in *Event because *Event.snapshot needs it.
-    _WorkloadEventSnapshot = TypedDict('_WorkloadEventSnapshot', {
-        'container_name': str
-    }, total=False)
-
-    _RelationDepartedEventSnapshot = TypedDict('_RelationDepartedEventSnapshot', {
-        'relation_name': str,
-        'relation_id': int,
-        'app_name': Optional[str],
-        'unit_name': Optional[str],
-        'departing_unit': Optional[str]
-    }, total=False)
-
-    _StorageEventSnapshot = TypedDict('_StorageEventSnapshot', {
-        'storage_name': str,
-        'storage_index': int,
-        'storage_location': str,
-    }, total=False)
 
 
 class HookEvent(EventBase):
     """Events raised by Juju to progress a charm's lifecycle.
 
     Hooks are callback methods of a charm class (a subclass of
     :class:`CharmBase`) that are invoked in response to events raised
@@ -154,87 +101,92 @@
     invokes a Juju Action. Callbacks bound to these events may be used
     for responding to the administrator's Juju Action request.
 
     To read the parameters for the action, see the instance variable :attr:`params`.
     To respond with the result of the action, call :meth:`set_results`. To add
     progress messages that are visible as the action is progressing use
     :meth:`log`.
-
-    Attributes:
-        params: The parameters passed to the action.
     """
 
-    def defer(self):
-        """Action events are not deferable like other events.
+    params: Dict[str, Any]
+    """The parameters passed to the action."""
+
+    def defer(self) -> None:
+        """Action events are not deferrable like other events.
 
         This is because an action runs synchronously and the administrator
         is waiting for the result.
         """
         raise RuntimeError('cannot defer action events')
 
-    def restore(self, snapshot: 'JsonObject'):
-        """Used by the operator framework to record the action.
+    def restore(self, snapshot: Dict[str, Any]):
+        """Used by the framework to record the action.
 
         Not meant to be called directly by charm code.
         """
         env_action_name = os.environ.get('JUJU_ACTION_NAME')
         event_action_name = self.handle.kind[:-len('_action')].replace('_', '-')
         if event_action_name != env_action_name:
             # This could only happen if the dev manually emits the action, or from a bug.
             raise RuntimeError('action event kind ({}) does not match current '
                                'action ({})'.format(event_action_name, env_action_name))
         # Params are loaded at restore rather than __init__ because
         # the model is not available in __init__.
         self.params = self.framework.model._backend.action_get()
 
-    def set_results(self, results: '_SerializedData'):
+    def set_results(self, results: Dict[str, Any]):
         """Report the result of the action.
 
-        Args:
-            results: The result of the action as a Dict
-            Juju eventually only accepts a str:str mapping, so we will attempt
-            to flatten any more complex data structure like so:
+        Juju eventually only accepts a str:str mapping, so we will attempt
+        to flatten any more complex data structure like so::
+
             >>> {'a': 'b'} # becomes: 'a'='b'
             >>> {'a': {'b': 'c'}} # becomes: 'a.b'='c'
             >>> {'a': {'b': 'c', 'd': 'e'}} # becomes: 'a.b'='c', 'a.d' = 'e'
             >>> {'a.b': 'c', 'a.d': 'e'} # equivalent to previous
-            Note that duplicate keys are not allowed, so
-            >>> {'a': {'b': 'c'}, 'a.b': 'c'} # invalid!
 
-            Note that the resulting keys must start and end with lowercase
-            alphanumeric, and can only contain lowercase alphanumeric, hyphens
-            and periods.
-
-            If any exceptions occur whilst the action is being handled, juju will
-            gather any stdout/stderr data (and the return code) and inject them into the
-            results object. Thus, the results object might contain the following keys,
-            additionally to those specified by the charm code:
-             - Stdout
-             - Stderr
-             - Stdout-encoding
-             - Stderr-encoding
-             - ReturnCode
+        Note that duplicate keys are not allowed, so this is invalid::
+
+            >>> {'a': {'b': 'c'}, 'a.b': 'c'}
+
+        Note that the resulting keys must start and end with lowercase
+        alphanumeric, and can only contain lowercase alphanumeric, hyphens
+        and periods.
+
+        If any exceptions occur whilst the action is being handled, juju will
+        gather any stdout/stderr data (and the return code) and inject them into the
+        results object. Thus, the results object might contain the following keys,
+        additionally to those specified by the charm code:
+
+        - Stdout
+        - Stderr
+        - Stdout-encoding
+        - Stderr-encoding
+        - ReturnCode
+
+        Args:
+            results: The result of the action as a Dict
         """
-        self.framework.model._backend.action_set(results)   # pyright: reportPrivateUsage=false
+        self.framework.model._backend.action_set(results)
 
     def log(self, message: str):
         """Send a message that a user will see while the action is running.
 
         Args:
             message: The message for the user.
         """
-        self.framework.model._backend.action_log(message)  # pyright: reportPrivateUsage=false
+        self.framework.model._backend.action_log(message)
 
     def fail(self, message: str = ''):
         """Report that this action has failed.
 
         Args:
             message: Optional message to record why it has failed.
         """
-        self.framework.model._backend.action_fail(message)  # pyright: reportPrivateUsage=false
+        self.framework.model._backend.action_fail(message)
 
 
 class InstallEvent(HookEvent):
     """Event triggered when a charm is installed.
 
     This event is triggered at the beginning of a charm's
     lifecycle. Any associated callback method should be used to
@@ -271,29 +223,29 @@
     This event fires prior to Juju removing the charm and terminating its unit.
     """
 
 
 class ConfigChangedEvent(HookEvent):
     """Event triggered when a configuration change occurs.
 
-    This event can fire in several situations:
+    This event will fire in several situations:
 
+    - When the admin reconfigures the charm using the Juju CLI, for example
+      ``juju config mycharm foo=bar``. This event notifies the charm of
+      its new configuration. (The event itself, however, is not aware of *what*
+      specifically has changed in the config).
     - Right after the unit starts up for the first time.
       This event notifies the charm of its initial configuration.
-      Typically, this event will fire between a :class:`install <InstallEvent>`
-      and a :class:`starts <StartEvent>` during the startup sequence
-      (when you first deploy a unit), but more in general it will fire whenever
-      the unit is (re)started, e.g. after pod churn on kubernetes, on unit
-      rescheduling, on unit upgrade/refresh, etc...
+      Typically, this event will fire between an :class:`install <InstallEvent>`
+      and a :class:`start <StartEvent>` during the startup sequence
+      (when you first deploy a unit), but in general it will fire whenever
+      the unit is (re)started, for example after pod churn on Kubernetes, on unit
+      rescheduling, on unit upgrade or refresh, and so on.
     - As a specific instance of the above point: when networking changes
       (if the machine reboots and comes up with a different IP).
-    - When the cloud admin reconfigures the charm via the Juju CLI, i.e.
-      `juju config my-charm foo=bar`. This event notifies the charm of
-      its new configuration. (The event itself, however, is not aware of *what*
-      specifically has changed in the config).
 
     Any callback method bound to this event cannot assume that the
     software has already been started; it should not start stopped
     software, but should (if appropriate) restart running software to
     take configuration changes into account.
     """
 
@@ -325,16 +277,16 @@
     into whatever form that is needed by the current charm version.
     """
 
 
 class PreSeriesUpgradeEvent(HookEvent):
     """Event triggered to prepare a unit for series upgrade.
 
-    This event triggers when an administrator executes ``juju upgrade-series
-    MACHINE prepare``. The event will fire for each unit that is running on the
+    This event triggers when an administrator executes ``juju upgrade-machine
+    <machine> prepare``. The event will fire for each unit that is running on the
     specified machine. Any callback method bound to this event must prepare the
     charm for an upgrade to the series. This may include things like exporting
     database content to a version neutral format, or evacuating running
     instances to other machines.
 
     It can be assumed that only after all units on a machine have executed the
     callback method associated with this event, the administrator will initiate
@@ -344,15 +296,15 @@
 
 
 class PostSeriesUpgradeEvent(HookEvent):
     """Event triggered after a series upgrade.
 
     This event is triggered after the administrator has done a distribution
     upgrade (or rolled back and kept the same series). It is called in response
-    to ``juju upgrade-series MACHINE complete``. Associated charm callback
+    to ``juju upgrade-machine <machine> complete``. Associated charm callback
     methods are expected to do whatever steps are necessary to reconfigure their
     applications for the new series. This may include things like populating the
     upgraded version of a database. Note however charms are expected to check if
     the series has actually changed or whether it was rolled back to the
     original series.
     """
 
@@ -367,17 +319,15 @@
     unit. Callback methods bound to this event may take any action
     required for the elected unit to assert leadership. Note that only
     the elected leader unit will receive this event.
     """
 
 
 class LeaderSettingsChangedEvent(HookEvent):
-    """Event triggered when leader changes any settings.
-
-    DEPRECATED NOTICE
+    """DEPRECATED. Event triggered when leader changes any settings.
 
     This event has been deprecated in favor of using a Peer relation,
     and having the leader set a value in the Application data bag for
     that peer relation.  (see :class:`RelationChangedEvent`).
     """
 
 
@@ -388,83 +338,79 @@
     unit. Callback methods bound to this event may use the :meth:`add_metrics`
     method of this class to send measurements to Juju.
 
     Note that associated callback methods are currently sandboxed in
     how they can interact with Juju.
     """
 
-    def add_metrics(self, metrics: Mapping[str, 'Numerical'],
+    def add_metrics(self, metrics: Mapping[str, Union[int, float]],
                     labels: Optional[Mapping[str, str]] = None):
         """Record metrics that have been gathered by the charm for this unit.
 
         Args:
-            metrics: A collection of {key: float} pairs that contains the
-              metrics that have been gathered
-            labels: {key:value} strings that can be applied to the
-                metrics that are being gathered
+            metrics: Key-value mapping of metrics that have been gathered.
+            labels: Key-value labels applied to the metrics.
         """
         self.framework.model._backend.add_metrics(metrics, labels)  # type:ignore
 
 
 class RelationEvent(HookEvent):
     """A base class representing the various relation lifecycle events.
 
     Relation lifecycle events are generated when application units
     participate in relations.  Units can only participate in relations
     after they have been "started", and before they have been
     "stopped". Within that time window, the unit may participate in
     several different relations at a time, including multiple
     relations with the same name.
+    """
 
-    Attributes:
-        relation: The :class:`~ops.model.Relation` involved in this event
-        app: The remote :class:`~ops.model.Application` that has triggered this
-             event
-        unit: The remote :class:`~ops.model.Unit` that has triggered this event. This may be
-              ``None`` if the relation event was triggered as an
-              :class:`~ops.model.Application` level event
+    relation: 'Relation'
+    """The relation involved in this event."""
 
+    # TODO(benhoyt): I *think* app should never be None, but confirm and update type
+    app: Optional[model.Application]
+    """The remote application that has triggered this event."""
+
+    unit: Optional[model.Unit]
+    """The remote unit that has triggered this event.
+
+    This will be ``None`` if the relation event was triggered as an
+    :class:`Application <model.Application>`-level event.
     """
-    if TYPE_CHECKING:
-        _RelationEventSnapshot = TypedDict('_RelationEventSnapshot', {
-            'relation_name': Required[str],
-            'relation_id': Required[int],
-            'app_name': Optional[str],
-            'unit_name': Optional[str]
-        }, total=False)
 
     def __init__(self, handle: 'Handle', relation: 'Relation',
                  app: Optional[model.Application] = None,
                  unit: Optional[model.Unit] = None):
         super().__init__(handle)
 
         if unit is not None and unit.app != app:
             raise RuntimeError(
                 f'cannot create RelationEvent with application {app} and unit {unit}')
 
         self.relation = relation
         self.app = app
         self.unit = unit
 
-    def snapshot(self) -> '_RelationEventSnapshot':
+    def snapshot(self) -> Dict[str, Any]:
         """Used by the framework to serialize the event to disk.
 
         Not meant to be called by charm code.
         """
-        snapshot: 'RelationEvent._RelationEventSnapshot' = {
+        snapshot: Dict[str, Any] = {
             'relation_name': self.relation.name,
             'relation_id': self.relation.id,
         }
         if self.app:
             snapshot['app_name'] = self.app.name
         if self.unit:
             snapshot['unit_name'] = self.unit.name
         return snapshot
 
-    def restore(self, snapshot: '_RelationEventSnapshot'):
+    def restore(self, snapshot: Dict[str, Any]):
         """Used by the framework to deserialize the event from disk.
 
         Not meant to be called by charm code.
         """
         relation = self.framework.model.get_relation(
             snapshot['relation_name'], snapshot['relation_id'])
         if relation is None:
@@ -541,55 +487,53 @@
     references to the departing remote unit, because there’s no
     guarantee that it’s still part of the system; it’s perfectly
     probable (although not guaranteed) that the system running that
     unit has already shut down.
 
     Once all callback methods bound to this event have been run for such a
     relation, the unit agent will fire the :class:`RelationBrokenEvent`.
-
-    Attributes:
-        departing_unit: The :class:`~ops.model.Unit` that is departing.  This
-            can facilitate determining e.g. whether *you* are the departing
-            unit.
     """
 
     def __init__(self, handle: 'Handle', relation: 'Relation',
                  app: Optional[model.Application] = None,
                  unit: Optional[model.Unit] = None,
                  departing_unit_name: Optional[str] = None):
         super().__init__(handle, relation, app=app, unit=unit)
 
         self._departing_unit_name = departing_unit_name
 
-    def snapshot(self) -> '_RelationDepartedEventSnapshot':
+    def snapshot(self) -> Dict[str, Any]:
         """Used by the framework to serialize the event to disk.
 
         Not meant to be called by charm code.
         """
-        snapshot = cast('_RelationDepartedEventSnapshot', super().snapshot())
+        snapshot = super().snapshot()
         if self._departing_unit_name:
             snapshot['departing_unit'] = self._departing_unit_name
         return snapshot
 
     @property
     def departing_unit(self) -> Optional[model.Unit]:
-        """The `ops.model.Unit` that is departing, if any."""
+        """The :class:`ops.Unit` that is departing, if any.
+
+        You can use this to determine (for example) whether *you* are the
+        departing unit.
+        """
         # doing this on init would fail because `framework` gets patched in
         # post-init
         if not self._departing_unit_name:
             return None
         return self.framework.model.get_unit(self._departing_unit_name)
 
-    def restore(self, snapshot: '_RelationDepartedEventSnapshot'):
+    def restore(self, snapshot: Dict[str, Any]):
         """Used by the framework to deserialize the event from disk.
 
         Not meant to be called by charm code.
         """
-        super().restore(snapshot)  # type: ignore
-
+        super().restore(snapshot)
         self._departing_unit_name = snapshot.get('departing_unit')
 
 
 class RelationBrokenEvent(RelationEvent):
     """Event triggered when a relation is removed.
 
     If a relation is being removed (``juju remove-relation`` or ``juju
@@ -608,47 +552,47 @@
 class StorageEvent(HookEvent):
     """Base class representing storage-related events.
 
     Juju can provide a variety of storage types to a charms. The
     charms can define several different types of storage that are
     allocated from Juju. Changes in state of storage trigger sub-types
     of :class:`StorageEvent`.
-
-    Attributes:
-        storage: The :class:`~ops.model.Storage` instance this event is about.
     """
 
+    storage: 'Storage'
+    """Storage instance this event refers to."""
+
     def __init__(self, handle: 'Handle', storage: 'Storage'):
         super().__init__(handle)
         self.storage = storage
 
-    def snapshot(self) -> '_StorageEventSnapshot':
+    def snapshot(self) -> Dict[str, Any]:
         """Used by the framework to serialize the event to disk.
 
         Not meant to be called by charm code.
         """
-        snapshot: '_StorageEventSnapshot' = {}
+        snapshot: Dict[str, Any] = {}
         if isinstance(self.storage, model.Storage):
             snapshot["storage_name"] = self.storage.name
             snapshot["storage_index"] = self.storage.index
             snapshot["storage_location"] = str(self.storage.location)
         return snapshot
 
-    def restore(self, snapshot: '_StorageEventSnapshot'):
+    def restore(self, snapshot: Dict[str, Any]):
         """Used by the framework to deserialize the event from disk.
 
         Not meant to be called by charm code.
         """
         storage_name = snapshot.get("storage_name")
         storage_index = snapshot.get("storage_index")
         storage_location = snapshot.get("storage_location")
 
         if storage_name and storage_index is not None:
             storages = self.framework.model.storages[storage_name]
-            self.storage = next((s for s in storages if s.index == storage_index), None,)
+            self.storage = next((s for s in storages if s.index == storage_index), None)  # type: ignore # noqa
             if self.storage is None:
                 msg = 'failed loading storage (name={!r}, index={!r}) from snapshot' \
                     .format(storage_name, storage_index)
                 raise RuntimeError(msg)
             if storage_location is None:
                 raise RuntimeError(
                     'failed loading storage location from snapshot.'
@@ -703,25 +647,25 @@
     """
 
     def __init__(self, handle: 'Handle', workload: 'Container'):
         super().__init__(handle)
 
         self.workload = workload
 
-    def snapshot(self) -> '_WorkloadEventSnapshot':
+    def snapshot(self) -> Dict[str, Any]:
         """Used by the framework to serialize the event to disk.
 
         Not meant to be called by charm code.
         """
-        snapshot: "_WorkloadEventSnapshot" = {}
+        snapshot: Dict[str, Any] = {}
         if isinstance(self.workload, model.Container):
             snapshot['container_name'] = self.workload.name
         return snapshot
 
-    def restore(self, snapshot: '_WorkloadEventSnapshot'):
+    def restore(self, snapshot: Dict[str, Any]):
         """Used by the framework to deserialize the event from disk.
 
         Not meant to be called by charm code.
         """
         container_name = snapshot.get('container_name')
         if container_name:
             self.workload = self.framework.model.unit.get_container(container_name)
@@ -752,225 +696,252 @@
 
     @property
     def secret(self) -> model.Secret:
         """The secret instance this event refers to."""
         backend = self.framework.model._backend
         return model.Secret(backend=backend, id=self._id, label=self._label)
 
-    def snapshot(self) -> '_SerializedData':
+    def snapshot(self) -> Dict[str, Any]:
         """Used by the framework to serialize the event to disk.
 
         Not meant to be called by charm code.
         """
         return {'id': self._id, 'label': self._label}
 
-    def restore(self, snapshot: '_SerializedData'):
+    def restore(self, snapshot: Dict[str, Any]):
         """Used by the framework to deserialize the event from disk.
 
         Not meant to be called by charm code.
         """
         self._id = cast(str, snapshot['id'])
         self._label = cast(Optional[str], snapshot['label'])
 
 
 class SecretChangedEvent(SecretEvent):
-    """Event raised by Juju on the observer when the secret owner changes its contents.
+    """Event triggered on the secret observer charm when the secret owner changes its contents.
 
     When the owner of a secret changes the secret's contents, Juju will create
     a new secret revision, and all applications or units that are tracking this
     secret will be notified via this event that a new revision is available.
 
     Typically, you will want to fetch the new content by calling
-    :meth:`ops.model.Secret.get_content` with :code:`refresh=True` to tell Juju to
-    start tracking the new revision.
+    :meth:`event.secret.get_content() <ops.Secret.get_content>` with ``refresh=True``
+    to tell Juju to start tracking the new revision.
     """
 
 
 class SecretRotateEvent(SecretEvent):
-    """Event raised by Juju on the owner when the secret's rotation policy elapses.
+    """Event triggered on the secret owner charm when the secret's rotation policy elapses.
 
     This event is fired on the secret owner to inform it that the secret must
     be rotated. The event will keep firing until the owner creates a new
-    revision by calling :meth:`ops.model.Secret.set_content`.
+    revision by calling :meth:`event.secret.set_content() <ops.Secret.set_content>`.
     """
 
-    def defer(self):
+    def defer(self) -> None:
         """Secret rotation events are not deferrable (Juju handles re-invocation)."""
         raise RuntimeError(
             'Cannot defer secret rotation events. Juju will keep firing this '
             'event until you create a new revision.')
 
 
 class SecretRemoveEvent(SecretEvent):
-    """Event raised by Juju on the owner when a secret revision can be removed.
+    """Event triggered on the secret owner charm when a secret revision can be removed.
 
     When the owner of a secret creates a new revision, and after all
     observers have updated to that new revision, this event will be fired to
     inform the secret owner that the old revision can be removed.
 
-    Typically, you will want to call :meth:`ops.model.Secret.remove_revision` to
+    Typically, you will want to call
+    :meth:`event.secret.remove_revision() <ops.Secret.remove_revision>` to
     remove the now-unused revision.
     """
 
     def __init__(self, handle: 'Handle', id: str, label: Optional[str], revision: int):
         super().__init__(handle, id, label)
         self._revision = revision
 
     @property
     def revision(self) -> int:
         """The secret revision this event refers to."""
         return self._revision
 
-    def snapshot(self) -> '_SerializedData':
+    def snapshot(self) -> Dict[str, Any]:
         """Used by the framework to serialize the event to disk.
 
         Not meant to be called by charm code.
         """
         data = super().snapshot()
         data['revision'] = self._revision
         return data
 
-    def restore(self, snapshot: '_SerializedData'):
+    def restore(self, snapshot: Dict[str, Any]):
         """Used by the framework to deserialize the event from disk.
 
         Not meant to be called by charm code.
         """
         super().restore(snapshot)
         self._revision = cast(int, snapshot['revision'])
 
 
 class SecretExpiredEvent(SecretEvent):
-    """Event raised by Juju on the owner when a secret's expiration time elapses.
+    """Event triggered on the secret owner charm when a secret's expiration time elapses.
 
     This event is fired on the secret owner to inform it that the secret revision
     must be removed. The event will keep firing until the owner removes the
-    revision by calling :meth:`model.Secret.remove_revision()`.
+    revision by calling :meth:`event.secret.remove_revision() <ops.Secret.remove_revision>`.
     """
 
     def __init__(self, handle: 'Handle', id: str, label: Optional[str], revision: int):
         super().__init__(handle, id, label)
         self._revision = revision
 
     @property
     def revision(self) -> int:
         """The secret revision this event refers to."""
         return self._revision
 
-    def snapshot(self) -> '_SerializedData':
+    def snapshot(self) -> Dict[str, Any]:
         """Used by the framework to serialize the event to disk.
 
         Not meant to be called by charm code.
         """
         data = super().snapshot()
         data['revision'] = self._revision
         return data
 
-    def restore(self, snapshot: '_SerializedData'):
+    def restore(self, snapshot: Dict[str, Any]):
         """Used by the framework to deserialize the event from disk.
 
         Not meant to be called by charm code.
         """
         super().restore(snapshot)
         self._revision = cast(int, snapshot['revision'])
 
-    def defer(self):
+    def defer(self) -> None:
         """Secret expiration events are not deferrable (Juju handles re-invocation)."""
         raise RuntimeError(
             'Cannot defer secret expiration events. Juju will keep firing '
             'this event until you create a new revision.')
 
 
 class CharmEvents(ObjectEvents):
     """Events generated by Juju pertaining to application lifecycle.
 
-    This class is used to create an event descriptor (``self.on``) attribute for
-    a charm class that inherits from :class:`CharmBase`. The event descriptor
-    may be used to set up event handlers for corresponding events.
-
-    By default the following events will be provided through
-    :class:`CharmBase`::
-
-        self.on.install
-        self.on.start
-        self.on.remove
-        self.on.update_status
-        self.on.config_changed
-        self.on.upgrade_charm
-        self.on.pre_series_upgrade
-        self.on.post_series_upgrade
-        self.on.leader_elected
-        self.on.collect_metrics
-
-
-    In addition to these, depending on the charm's metadata (``metadata.yaml``),
-    named relation and storage events may also be defined.  These named events
-    are created by :class:`CharmBase` using charm metadata.  The named events may be
-    accessed as ``self.on[<name>].<relation_or_storage_event>``
+    By default, the events listed as attributes of this class will be
+    provided via the :attr:`CharmBase.on` attribute. For example::
+
+        self.framework.observe(self.on.config_changed, self._on_config_changed)
+
+    In addition to the events listed as attributes of this class,
+    dynamically-named events will also be defined based on the charm's
+    metadata (``metadata.yaml``) for relations, storage, actions, and
+    containers. These named events may be accessed as
+    ``self.on[<name>].<event>`` or using a prefix like
+    ``self.on.<name>_<event>``, for example::
+
+        self.framework.observe(self.on["db"].relation_created, self._on_db_relation_created)
+        self.framework.observe(self.on.workload_pebble_ready, self._on_workload_pebble_ready)
     """
 
+    # NOTE: The one-line docstrings below are copied from the first line of
+    #       each event class's docstring. Please keep in sync.
+
     install = EventSource(InstallEvent)
+    """Triggered when a charm is installed (see :class:`InstallEvent`)."""
+
     start = EventSource(StartEvent)
+    """Triggered immediately after first configuration change (see :class:`StartEvent`)."""
+
     stop = EventSource(StopEvent)
+    """Triggered when a charm is shut down (see :class:`StopEvent`)."""
+
     remove = EventSource(RemoveEvent)
+    """Triggered when a unit is about to be terminated (see :class:`RemoveEvent`)."""
+
     update_status = EventSource(UpdateStatusEvent)
+    """Triggered periodically by a status update request from Juju (see
+    :class:`UpdateStatusEvent`).
+    """
+
     config_changed = EventSource(ConfigChangedEvent)
+    """Triggered when a configuration change occurs (see :class:`ConfigChangedEvent`)."""
+
     upgrade_charm = EventSource(UpgradeCharmEvent)
+    """Triggered by request to upgrade the charm (see :class:`UpgradeCharmEvent`)."""
+
     pre_series_upgrade = EventSource(PreSeriesUpgradeEvent)
+    """Triggered to prepare a unit for series upgrade (see :class:`PreSeriesUpgradeEvent`)."""
+
     post_series_upgrade = EventSource(PostSeriesUpgradeEvent)
+    """Triggered after a series upgrade (see :class:`PostSeriesUpgradeEvent`)."""
+
     leader_elected = EventSource(LeaderElectedEvent)
+    """Triggered when a new leader has been elected (see :class:`LeaderElectedEvent`)."""
+
     leader_settings_changed = EventSource(LeaderSettingsChangedEvent)
+    """DEPRECATED. Triggered when leader changes any settings (see
+    :class:`LeaderSettingsChangedEvent`)."""
+
     collect_metrics = EventSource(CollectMetricsEvent)
+    """Triggered by Juju to collect metrics (see :class:`CollectMetricsEvent`)."""
 
     secret_changed = EventSource(SecretChangedEvent)
+    """Triggered by Juju on the observer when the secret owner changes its contents (see
+    :class:`SecretChangedEvent`)."""
+
     secret_expired = EventSource(SecretExpiredEvent)
+    """Triggered by Juju on the owner when a secret's expiration time elapses (see
+    :class:`SecretExpiredEvent`)."""
+
     secret_rotate = EventSource(SecretRotateEvent)
+    """Triggered by Juju on the owner when the secret's rotation policy elapses (see
+    :class:`SecretRotateEvent`)."""
+
     secret_remove = EventSource(SecretRemoveEvent)
+    """Triggered by Juju on the owner when a secret revision can be removed (see
+    :class:`SecretRemoveEvent`)."""
 
 
 class CharmBase(Object):
     """Base class that represents the charm overall.
 
-    :class:`CharmBase` is used to create a charm. This is done by inheriting
-    from :class:`CharmBase` and customising the sub class as required. So to
+    :code:`CharmBase` is used to create a charm. This is done by inheriting
+    from :code:`CharmBase` and customising the subclass as required. So to
     create your own charm, say ``MyCharm``, define a charm class and set up the
     required event handlers (“hooks”) in its constructor::
 
         import logging
 
-        from ops.charm import CharmBase
-        from ops.main import main
+        import ops
 
-        logger = logging.getLogger(__name__)
-
-        def MyCharm(CharmBase):
+        def MyCharm(ops.CharmBase):
             def __init__(self, *args):
-                logger.debug('Initializing Charm')
-
                 super().__init__(*args)
-
                 self.framework.observe(self.on.config_changed, self._on_config_changed)
                 self.framework.observe(self.on.stop, self._on_stop)
                 # ...
 
         if __name__ == "__main__":
-            main(MyCharm)
+            ops.main(MyCharm)
 
     As shown in the example above, a charm class is instantiated by
-    :func:`~ops.main.main` rather than charm authors directly instantiating a
+    :code:`ops.main` rather than charm authors directly instantiating a
     charm.
 
     Args:
         framework: The framework responsible for managing the Model and events for this
             charm.
     """
 
-    # note that without the #: below, sphinx will copy the whole of CharmEvents
-    # docstring inline which is less than ideal.
-    # Used to set up event handlers; see :class:`CharmEvents`.
-    on = CharmEvents()  # type: ignore
+    on: CharmEvents = CharmEvents()  # type: ignore
+    """This property is used to create an event handler using :meth:`Framework.observe`,
+    and can be one of the events listed at :class:`CharmEvents`.
+    """
+
     if TYPE_CHECKING:
         # to help the type checker and IDEs:
         @property
         def on(self) -> CharmEvents: ...  # noqa
 
     def __init__(self, framework: Framework):
         super().__init__(framework, None)
@@ -1021,127 +992,146 @@
         """A mapping containing the charm's config and current values."""
         return self.model.config
 
 
 class CharmMeta:
     """Object containing the metadata for the charm.
 
-    This is read from ``metadata.yaml`` and/or ``actions.yaml``. Generally
+    This is read from ``metadata.yaml`` and ``actions.yaml``. Generally
     charms will define this information, rather than reading it at runtime. This
     class is mostly for the framework to understand what the charm has defined.
 
-    The :attr:`maintainers`, :attr:`tags`, :attr:`terms`, :attr:`series`, and
-    :attr:`extra_bindings` attributes are all lists of strings.  The :attr:`containers`,
-    :attr:`requires`, :attr:`provides`, :attr:`peers`, :attr:`relations`,
-    :attr:`storages`, :attr:`resources`, and :attr:`payloads` attributes are all
-    mappings of names to instances of the respective :class:`RelationMeta`,
-    :class:`StorageMeta`, :class:`ResourceMeta`, or :class:`PayloadMeta`.
-
-    The :attr:`relations` attribute is a convenience accessor which includes all
-    of the ``requires``, ``provides``, and ``peers`` :class:`RelationMeta`
-    items.  If needed, the role of the relation definition can be obtained from
-    its :attr:`role <RelationMeta.role>` attribute.
-
-    Attributes:
-        name: The name of this charm
-        summary: Short description of what this charm does
-        description: Long description for this charm
-        maintainers: A list of strings of the email addresses of the maintainers
-                     of this charm.
-        tags: Charm store tag metadata for categories associated with this charm.
-        terms: Charm store terms that should be agreed to before this charm can
-               be deployed. (Used for things like licensing issues.)
-        series: The list of supported OS series that this charm can support.
-                The first entry in the list is the default series that will be
-                used by deploy if no other series is requested by the user.
-        subordinate: True/False whether this charm is intended to be used as a
-                     subordinate charm.
-        min_juju_version: If supplied, indicates this charm needs features that
-                          are not available in older versions of Juju.
-        containers: A dict of {name: :class:`ContainerMeta` } for each of the 'containers'
-                   declared by this charm in the `matadata.yaml` file.
-        requires: A dict of {name: :class:`RelationMeta` } for each 'requires' relation.
-        provides: A dict of {name: :class:`RelationMeta` } for each 'provides' relation.
-        peers: A dict of {name: :class:`RelationMeta` } for each 'peer' relation.
-        relations: A dict containing all :class:`RelationMeta` attributes (merged from other
-                   sections)
-        storages: A dict of {name: :class:`StorageMeta`} for each defined storage.
-        resources: A dict of {name: :class:`ResourceMeta`} for each defined resource.
-        payloads: A dict of {name: :class:`PayloadMeta`} for each defined payload.
-        extra_bindings: A dict of additional named bindings that a charm can use
-                        for network configuration.
-        actions: A dict of {name: :class:`ActionMeta`} for actions that the charm has defined.
     Args:
         raw: a mapping containing the contents of metadata.yaml
         actions_raw: a mapping containing the contents of actions.yaml
+    """
+
+    name: str
+    """Name of this charm."""
+
+    summary: str
+    """Short description of what this charm does."""
+
+    description: str
+    """Long description for this charm."""
+
+    maintainers: List[str]
+    """List of email addresses of charm maintainers."""
+
+    tags: List[str]
+    """Charmhub tag metadata for categories associated with this charm."""
 
+    terms: List[str]
+    """Charmhub terms that should be agreed to before this charm can be deployed."""
+
+    series: List[str]
+    """List of supported OS series that this charm can support.
+
+    The first entry in the list is the default series that will be used by
+    deploy if no other series is requested by the user.
     """
-    if TYPE_CHECKING:
-        # avoid long line in init
-        _ActionsRaw = Optional[Dict[str, '_ActionMetaDict']]
 
-    def __init__(self,
-                 raw: Optional['_CharmMetaDict'] = None,  # type: ignore
-                 actions_raw: '_ActionsRaw' = None  # type: ignore
-                 ):
-        raw: _CharmMetaDict = raw or cast('_CharmMetaDict', {})
-        actions_raw: Dict[str, _ActionMetaDict] = actions_raw or {}
+    subordinate: bool
+    """Whether this charm is intended to be used as a subordinate charm."""
 
-        self.name = raw.get('name', '')
-        self.summary = raw.get('summary', '')
-        self.description = raw.get('description', '')
+    min_juju_version: Optional[str]
+    """Indicates the minimum Juju version this charm requires."""
+
+    containers: Dict[str, 'ContainerMeta']
+    """Container metadata for each defined container."""
+
+    requires: Dict[str, 'RelationMeta']
+    """Relations this charm requires."""
+
+    provides: Dict[str, 'RelationMeta']
+    """Relations this charm provides."""
+
+    peers: Dict[str, 'RelationMeta']
+    """Peer relations."""
+
+    relations: Dict[str, 'RelationMeta']
+    """All :class:`RelationMeta` instances.
+
+    This is merged from ``requires``, ``provides``, and ``peers``. If needed,
+    the role of the relation definition can be obtained from its
+    :attr:`role <RelationMeta.role>` attribute.
+    """
+
+    storages: Dict[str, 'StorageMeta']
+    """Storage metadata for each defined storage."""
+
+    resources: Dict[str, 'ResourceMeta']
+    """Resource metadata for each defined resource."""
+
+    payloads: Dict[str, 'PayloadMeta']
+    """Payload metadata for each defined payload."""
+
+    extra_bindings: Dict[str, None]
+    """Additional named bindings that a charm can use for network configuration."""
+
+    actions: Dict[str, 'ActionMeta']
+    """Actions the charm has defined."""
+
+    def __init__(self, raw: Optional[Dict[str, Any]] = None,
+                 actions_raw: Optional[Dict[str, Any]] = None):
+        raw_: Dict[str, Any] = raw or {}
+        actions_raw_: Dict[str, Any] = actions_raw or {}
+
+        self.name = raw_.get('name', '')
+        self.summary = raw_.get('summary', '')
+        self.description = raw_.get('description', '')
         self.maintainers: List[str] = []
-        if 'maintainer' in raw:
-            self.maintainers.append(raw['maintainer'])
-        if 'maintainers' in raw:
-            self.maintainers.extend(raw['maintainers'])
-        self.tags = raw.get('tags', [])
-        self.terms = raw.get('terms', [])
-        self.series = raw.get('series', [])
-        self.subordinate = raw.get('subordinate', False)
-        self.min_juju_version = raw.get('min-juju-version')
+        if 'maintainer' in raw_:
+            self.maintainers.append(raw_['maintainer'])
+        if 'maintainers' in raw_:
+            self.maintainers.extend(raw_['maintainers'])
+        self.tags = raw_.get('tags', [])
+        self.terms = raw_.get('terms', [])
+        self.series = raw_.get('series', [])
+        self.subordinate = raw_.get('subordinate', False)
+        self.min_juju_version = raw_.get('min-juju-version')
         self.requires = {name: RelationMeta(RelationRole.requires, name, rel)
-                         for name, rel in raw.get('requires', {}).items()}
+                         for name, rel in raw_.get('requires', {}).items()}
         self.provides = {name: RelationMeta(RelationRole.provides, name, rel)
-                         for name, rel in raw.get('provides', {}).items()}
+                         for name, rel in raw_.get('provides', {}).items()}
         self.peers = {name: RelationMeta(RelationRole.peer, name, rel)
-                      for name, rel in raw.get('peers', {}).items()}
+                      for name, rel in raw_.get('peers', {}).items()}
         self.relations: Dict[str, RelationMeta] = {}
         self.relations.update(self.requires)
         self.relations.update(self.provides)
         self.relations.update(self.peers)
         self.storages = {name: StorageMeta(name, storage)
-                         for name, storage in raw.get('storage', {}).items()}
+                         for name, storage in raw_.get('storage', {}).items()}
         self.resources = {name: ResourceMeta(name, res)
-                          for name, res in raw.get('resources', {}).items()}
+                          for name, res in raw_.get('resources', {}).items()}
         self.payloads = {name: PayloadMeta(name, payload)
-                         for name, payload in raw.get('payloads', {}).items()}
-        self.extra_bindings = raw.get('extra-bindings', {})
-        self.actions = {name: ActionMeta(name, action) for name, action in actions_raw.items()}
+                         for name, payload in raw_.get('payloads', {}).items()}
+        self.extra_bindings = raw_.get('extra-bindings', {})
+        self.actions = {name: ActionMeta(name, action) for name, action in actions_raw_.items()}
         # This is taken from Charm Metadata v2, but only the "containers" and
         # "containers.name" fields that we need right now for Pebble. See:
         # https://discourse.charmhub.io/t/charm-metadata-v2/3674
         self.containers = {name: ContainerMeta(name, container)
-                           for name, container in raw.get('containers', {}).items()}
+                           for name, container in raw_.get('containers', {}).items()}
 
     @classmethod
     def from_yaml(
             cls, metadata: Union[str, TextIO],
-            actions: Optional[Union[str, TextIO]] = None):
-        """Instantiate a CharmMeta from a YAML description of metadata.yaml.
+            actions: Optional[Union[str, TextIO]] = None) -> 'CharmMeta':
+        """Instantiate a :class:`CharmMeta` from a YAML description of ``metadata.yaml``.
 
         Args:
             metadata: A YAML description of charm metadata (name, relations, etc.)
-                This can be a simple string, or a file-like object. (passed to `yaml.safe_load`).
-            actions: YAML description of Actions for this charm (eg actions.yaml)
+                This can be a simple string, or a file-like object (passed to ``yaml.safe_load``).
+            actions: YAML description of Actions for this charm (e.g., actions.yaml)
         """
-        meta = cast('_CharmMetaDict', yaml.safe_load(metadata))
+        meta = yaml.safe_load(metadata)
         raw_actions = {}
         if actions is not None:
-            raw_actions = cast(Dict[str, '_ActionMetaDict'], yaml.safe_load(actions))
+            raw_actions = cast(Optional[Dict[str, Any]], yaml.safe_load(actions))
             if raw_actions is None:
                 raw_actions = {}
         return cls(meta, raw_actions)
 
 
 class RelationRole(enum.Enum):
     """An annotation for a charm's role in a relation.
@@ -1153,34 +1143,45 @@
     - A service provider in the relation ('provides')
     """
     peer = 'peer'
     requires = 'requires'
     provides = 'provides'
 
     def is_peer(self) -> bool:
-        """Return whether the current role is peer.
+        """Report whether this role is 'peer'.
 
-        A convenience to avoid having to import charm.
+        ``role.is_peer()`` is a shortcut for ``role == ops.RelationRole.peer``.
         """
         return self is RelationRole.peer
 
 
 class RelationMeta:
     """Object containing metadata about a relation definition.
 
-    Should not be constructed directly by charm code. Is gotten from one of
+    Should not be constructed directly by charm code, but gotten from one of
     :attr:`CharmMeta.peers`, :attr:`CharmMeta.requires`, :attr:`CharmMeta.provides`,
     or :attr:`CharmMeta.relations`.
+    """
 
-    Attributes:
-        role: This is :class:`RelationRole`; one of peer/requires/provides
-        relation_name: Name of this relation from metadata.yaml
-        interface_name: Optional definition of the interface protocol.
-        limit: Optional definition of maximum number of connections to this relation endpoint.
-        scope: "global" (default) or "container" scope based on how the relation should be used.
+    role: RelationRole
+    """Role this relation takes, one of 'peer', 'requires', or 'provides'."""
+
+    relation_name: str
+    """Name of this relation."""
+
+    interface_name: Optional[str]
+    """Definition of the interface protocol."""
+
+    limit: Optional[int]
+    """Maximum number of connections to this relation endpoint."""
+
+    scope: str
+    """Scope based on how this relation should be used.
+
+    Will be either ``"global"`` or ``"container"``.
     """
 
     VALID_SCOPES = ['global', 'container']
 
     def __init__(self, role: RelationRole, relation_name: str, raw: '_RelationMetaDict'):
         assert isinstance(role, RelationRole), \
             f"role should be one of {list(RelationRole)!r}, not {role!r}"
@@ -1196,25 +1197,39 @@
         self.scope = raw.get('scope') or self._default_scope
         if self.scope not in self.VALID_SCOPES:
             raise TypeError("scope should be one of {}; not '{}'".format(
                 ', '.join(f"'{s}'" for s in self.VALID_SCOPES), self.scope))
 
 
 class StorageMeta:
-    """Object containing metadata about a storage definition.
+    """Object containing metadata about a storage definition."""
 
-    Attributes:
-        storage_name: Name of storage
-        type: Storage type
-        description: A text description of the storage
-        read_only: Whether or not the storage is read only
-        minimum_size: Minimum size of storage
-        location: Mount point of storage
-        multiple_range: Range of numeric qualifiers when multiple storage units are used
-    """
+    storage_name: str
+    """Name of storage."""
+
+    type: str
+    """Storage type, "filesystem" or "block"."""
+
+    description: str
+    """Text description of the storage."""
+
+    shared: bool
+    """True if all units of the application share the storage."""
+
+    read_only: bool
+    """True if the storage is read-only."""
+
+    minimum_size: Optional[str]
+    """Minimum size of the storage."""
+
+    location: Optional[str]
+    """Mount point of the storage."""
+
+    multiple_range: Optional[Tuple[int, Optional[int]]]
+    """Range of numeric qualifiers when multiple storage units are used."""
 
     def __init__(self, name: str, raw: '_StorageMetaDict'):
         self.storage_name = name
         self.type = raw['type']
         self.description = raw.get('description', '')
         self.shared = raw.get('shared', False)
         self.read_only = raw.get('read-only', False)
@@ -1227,66 +1242,75 @@
                 self.multiple_range = (int(range), int(range))
             else:
                 range = range.split('-')
                 self.multiple_range = (int(range[0]), int(range[1]) if range[1] else None)
 
 
 class ResourceMeta:
-    """Object containing metadata about a resource definition.
+    """Object containing metadata about a resource definition."""
 
-    Attributes:
-        resource_name: Name of resource
-        filename: Name of file
-        description: A text description of resource
+    resource_name: str
+    """Name of the resource."""
+
+    type: str
+    """Type of the resource. One of ``"file"`` or ``"oci-image"``."""
+
+    filename: Optional[str]
+    """Filename of the resource file."""
+
+    description: str
+    """A description of the resource.
+
+    This will be empty string (rather than None) if not set in ``metadata.yaml``.
     """
 
     def __init__(self, name: str, raw: '_ResourceMetaDict'):
         self.resource_name = name
         self.type = raw['type']
         self.filename = raw.get('filename', None)
         self.description = raw.get('description', '')
 
 
 class PayloadMeta:
-    """Object containing metadata about a payload definition.
+    """Object containing metadata about a payload definition."""
 
-    Attributes:
-        payload_name: Name of payload
-        type: Payload type
-    """
+    payload_name: str
+    """Name of the payload."""
+
+    type: str
+    """Payload type."""
 
-    def __init__(self, name: str, raw: '_PayloadMetaDict'):
+    def __init__(self, name: str, raw: Dict[str, Any]):
         self.payload_name = name
         self.type = raw['type']
 
 
 class ActionMeta:
     """Object containing metadata about an action's definition."""
 
-    def __init__(self, name: str, raw: Optional['_ActionMetaDict'] = None):
+    def __init__(self, name: str, raw: Optional[Dict[str, Any]] = None):
         raw = raw or {}
         self.name = name
         self.title = raw.get('title', '')
         self.description = raw.get('description', '')
         self.parameters = raw.get('params', {})  # {<parameter name>: <JSON Schema definition>}
         self.required = raw.get('required', [])  # [<parameter name>, ...]
 
 
 class ContainerMeta:
     """Metadata about an individual container.
 
     NOTE: this is extremely lightweight right now, and just includes the fields we need for
     Pebble interaction.
-
-    Attributes:
-        name: Name of container (key in the YAML)
-        mounts: :class:`ContainerStorageMeta` mounts available to the container
     """
 
-    def __init__(self, name: str, raw: '_ContainerMetaDict'):
+    name: str
+    """Name of the container (key in the YAML)."""
+
+    def __init__(self, name: str, raw: Dict[str, Any]):
         self.name = name
         self._mounts: Dict[str, ContainerStorageMeta] = {}
 
         # This is not guaranteed to be populated/is not enforced yet
         if raw:
             self._populate_mounts(raw.get('mounts', []))
 
@@ -1329,44 +1353,47 @@
             else:
                 self._mounts[storage] = ContainerStorageMeta(storage, mount)
 
 
 class ContainerStorageMeta:
     """Metadata about storage for an individual container.
 
-    Attributes:
-        storage: a name for the mountpoint, which should exist the keys for :class:`StorageMeta`
-                 for the charm
-        location: the location `storage` is mounted at
-        locations: a list of mountpoints for the key
-
     If multiple locations are specified for the same storage, such as Kubernetes subPath mounts,
-    `location` will not be an accessible attribute, as it would not be possible to determine
-    which mount point was desired, and `locations` should be iterated over.
+    ``location`` will not be an accessible attribute, as it would not be possible to determine
+    which mount point was desired, and ``locations`` should be iterated over.
     """
 
+    storage: str
+    """Name for the mount point, which should exist in the keys of the charm's
+    :class:`StorageMeta`.
+    """
+
+    location: str
+    """The location the storage is mounted at."""
+
     def __init__(self, storage: str, location: str):
         self.storage = storage
         self._locations: List[str] = [location]
 
     def add_location(self, location: str):
-        """Add an additional mountpoint to a known storage."""
+        """Add an additional mount point to a known storage."""
         self._locations.append(location)
 
     @property
     def locations(self) -> List[str]:
         """An accessor for the list of locations for a mount."""
         return self._locations
 
     def __getattr__(self, name: str):
+        # TODO(benhoyt): this should just be a property "location"
         if name == "location":
             if len(self._locations) == 1:
                 return self._locations[0]
             else:
                 raise RuntimeError(
-                    "container has more than one mountpoint with the same backing storage. "
+                    "container has more than one mount point with the same backing storage. "
                     "Request .locations to see a list"
                 )
         else:
             raise AttributeError(
                 f"{self.__class__.__name__} has no such attribute: {name}!"
             )
```

### Comparing `ops-2.3.0/ops/framework.py` & `ops-2.4.0/ops/framework.py`

 * *Files 6% similar despite different names*

```diff
@@ -8,15 +8,15 @@
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
-"""The Operator Framework infrastructure."""
+"""The ops library's infrastructure."""
 
 import collections
 import collections.abc
 import inspect
 import keyword
 import logging
 import marshal
@@ -30,72 +30,59 @@
 import weakref
 from contextlib import contextmanager
 from typing import (
     TYPE_CHECKING,
     Any,
     Callable,
     Dict,
-    Generic,
     Hashable,
     Iterable,
     List,
     Optional,
     Set,
     Tuple,
+    Type,
     TypeVar,
     Union,
 )
 
 from ops import charm
 from ops.storage import JujuStorage, NoSnapshotError, SQLiteStorage
 
-if TYPE_CHECKING:
-    from pathlib import Path
-    from typing import Literal, Protocol, Type
 
-    from ops.charm import CharmMeta
-    from ops.model import JsonObject, Model, _ModelBackend
+class Serializable(typing.Protocol):
+    """The type returned by :meth:`Framework.load_snapshot`."""
 
-    class _Serializable(Protocol):
-        handle_kind = ''
-        @property
-        def handle(self) -> 'Handle': ...  # noqa
-        @handle.setter
-        def handle(self, val: 'Handle'): ...  # noqa
-        def snapshot(self) -> Dict[str, '_StorableType']: ...  # noqa
-        def restore(self, snapshot: Dict[str, '_StorableType']) -> None: ...  # noqa
+    handle_kind = ''
+
+    @property
+    def handle(self) -> 'Handle': ...  # noqa
+    @handle.setter
+    def handle(self, val: 'Handle'): ...  # noqa
+    def snapshot(self) -> Dict[str, Any]: ...  # noqa
+    def restore(self, snapshot: Dict[str, Any]) -> None: ...  # noqa
 
-    class _StoredObject(Protocol):
-        _under: Any = None  # noqa
 
-    # serialized data structure
-    _SerializedData = Dict[str, 'JsonObject']
+if TYPE_CHECKING:
+    from typing import Literal, Protocol
 
-    _ObserverCallback = Callable[[Any], None]
+    from ops.charm import CharmMeta
+    from ops.model import Model, _ModelBackend
 
-    # types that can be stored natively
-    _StorableType = Union[int, bool, float, str, bytes, Literal[None],
-                          List['_StorableType'],
-                          Dict[str, '_StorableType'],
-                          Set['_StorableType']]
+    class _StoredObject(Protocol):
+        _under: Any = None  # noqa
 
     StoredObject = Union['StoredList', 'StoredSet', 'StoredDict']
 
-    # This type is used to denote either a Handle instance or an instance of
-    # an Object (or subclass). This is used by methods and classes which can be
-    # called with either of those (they need a Handle, but will accept an Object
-    # from which they will then extract the Handle).
-    _ParentHandle = Union['Handle', 'Object']
-
     _Path = _Kind = _MethodName = _EventKey = str
     # used to type Framework Attributes
     _ObserverPath = List[Tuple[_Path, _MethodName, _Path, _EventKey]]
     _ObjectPath = Tuple[Optional[_Path], _Kind]
     _PathToObjectMapping = Dict[_Path, 'Object']
-    _PathToSerializableMapping = Dict[_Path, _Serializable]
+    _PathToSerializableMapping = Dict[_Path, Serializable]
 
 _T = TypeVar("_T")
 _EventType = TypeVar('_EventType', bound='EventBase')
 _ObjectType = TypeVar("_ObjectType", bound="Object")
 
 logger = logging.getLogger(__name__)
 
@@ -157,15 +144,15 @@
 
     @property
     def key(self) -> str:
         """Return the handle's key."""
         return self._key
 
     @property
-    def path(self):
+    def path(self) -> str:
         """Return the handle's path."""
         return self._path
 
     @classmethod
     def from_path(cls, path: str) -> 'Handle':
         """Build a handle from the indicated path."""
         handle = None
@@ -178,38 +165,40 @@
             elif len(pair) == 2:
                 kind, key = pair
                 if key and key[-1] == ']':
                     key = key[:-1]
                     good = True
             if not good:
                 raise RuntimeError(f"attempted to restore invalid handle path {path}")
-            handle = Handle(handle, kind, key)  # pyright: reportUnboundVariable=false
-        return handle
+            handle = Handle(handle, kind, key)  # type: ignore
+        return typing.cast(Handle, handle)
 
 
 class EventBase:
-    """The base for all the different Events.
+    """The base class for all events.
 
-    Inherit this and override 'snapshot' and 'restore' methods to build a custom event.
+    Inherit this and override the ``snapshot`` and ``restore`` methods to
+    create a custom event.
     """
 
     # gets patched in by `Framework.restore()`, if this event is being re-emitted
     # after being loaded from snapshot, or by `BoundEvent.emit()` if this
     # event is being fired for the first time.
     # TODO this is hard to debug, this should be refactored
-    framework: 'Framework' = None
+    framework: 'Framework' = None  # type: ignore
+    """The :class:`Framework` instance (set by the framework itself)."""
 
     def __init__(self, handle: Handle):
         self.handle = handle
         self.deferred: bool = False
 
     def __repr__(self):
         return f"<{self.__class__.__name__} via {self.handle}>"
 
-    def defer(self):
+    def defer(self) -> None:
         """Defer the event to the future.
 
         Deferring an event from a handler puts that handler into a queue, to be
         called again the next time the charm is invoked. This invocation may be
         the result of an action, or any event other than metric events. The
         queue of events will be dispatched before the new event is processed.
 
@@ -254,49 +243,50 @@
         3. At some future time, event C happens, which also checks if A can
            proceed.
 
         """
         logger.debug("Deferring %s.", self)
         self.deferred = True
 
-    def snapshot(self) -> '_SerializedData':
+    def snapshot(self) -> Dict[str, Any]:
         """Return the snapshot data that should be persisted.
 
         Subclasses must override to save any custom state.
         """
         return {}
 
-    def restore(self, snapshot: '_SerializedData'):
+    def restore(self, snapshot: Dict[str, Any]):
         """Restore the value state from the given snapshot.
 
         Subclasses must override to restore their custom state.
         """
         self.deferred = False
 
 
-class EventSource(Generic[_EventType]):
+class EventSource:
     """EventSource wraps an event type with a descriptor to facilitate observing and emitting.
 
-    It is generally used as:
+    It is generally used as::
 
         class SomethingHappened(EventBase):
             pass
 
         class SomeObject(Object):
             something_happened = EventSource(SomethingHappened)
 
-    With that, instances of that type will offer the someobj.something_happened
-    attribute which is a BoundEvent and may be used to emit and observe the event.
+    With that, instances of that type will offer the ``someobj.something_happened``
+    attribute which is a :class:`BoundEvent`, and may be used to emit and observe
+    the event.
     """
 
-    def __init__(self, event_type: 'Type[_EventType]'):
+    def __init__(self, event_type: 'Type[EventBase]'):
         if not isinstance(event_type, type) or not issubclass(event_type, EventBase):
             raise RuntimeError(
                 f'Event requires a subclass of EventBase as an argument, got {event_type}')
-        self.event_type: Type[_EventType] = event_type
+        self.event_type: Type[EventBase] = event_type
         self.event_kind: Optional[str] = None
         self.emitter_type: Optional[Type[Object]] = None
 
     def __set_name__(self, emitter_type: 'Type[Object]', event_kind: str):
         if self.event_kind is not None:
             raise RuntimeError(
                 'EventSource({}) reused as {}.{} and {}.{}'.format(
@@ -308,27 +298,27 @@
                     event_kind,
                 ))
         self.event_kind = event_kind
         self.emitter_type = emitter_type
 
     def __get__(self, emitter: Optional['Object'],
                 emitter_type: 'Type[Object]'
-                ) -> 'BoundEvent[_EventType]':
+                ) -> 'BoundEvent':
         if emitter is None:
             return self  # type: ignore
         # Framework might not be available if accessed as CharmClass.on.event
         # rather than charm_instance.on.event, but in that case it couldn't be
         # emitted anyway, so there's no point to registering it.
         framework = getattr(emitter, 'framework', None)
         if framework is not None:
             framework.register_type(self.event_type, emitter, self.event_kind)
-        return BoundEvent(emitter, self.event_type, self.event_kind)
+        return BoundEvent(emitter, self.event_type, typing.cast(str, self.event_kind))
 
 
-class BoundEvent(Generic[_EventType]):
+class BoundEvent:
     """Event bound to an Object."""
 
     def __repr__(self):
         return '<BoundEvent {} bound to {}.{} at {}>'.format(
             self.event_type.__name__,
             type(self.emitter).__name__,
             self.event_kind,
@@ -383,48 +373,48 @@
     identifier. Event handlers use this identity to track the destination of their events, and the
     Framework uses this id to track persisted state between event executions.
 
     The Framework should raise an error if it ever detects that two objects with the same id have
     been created.
 
     """
-    handle_kind: str = HandleKind()
+    handle_kind: str = HandleKind()  # type: ignore
 
     if TYPE_CHECKING:
         # to help the type checker and IDEs:
         # all these are guaranteed to be set at runtime.
         @property
         def on(self) -> 'ObjectEvents': ...  # noqa
 
     def __init__(self, parent: Union['Framework', 'Object'], key: Optional[str]):
-        self.framework: Framework = None
-        self.handle: Handle = None
+        self.framework: Framework = None  # type: ignore
+        self.handle: Handle = None  # type: ignore
 
         kind = self.handle_kind
         if isinstance(parent, Framework):
             self.framework = parent
             # Avoid Framework instances having a circular reference to themselves.
             if self.framework is self:
                 self.framework = weakref.proxy(self.framework)
-            self.handle = Handle(None, kind, key)
+            self.handle = Handle(None, kind, typing.cast(str, key))
         else:
             self.framework = parent.framework
-            self.handle = Handle(parent, kind, key)
-        self.framework._track(self)
+            self.handle = Handle(parent, kind, typing.cast(str, key))
+        self.framework._track(self)  # type: ignore
 
         # TODO Detect conflicting handles here.
 
     @property
     def model(self) -> 'Model':
         """Shortcut for more simple access the model."""
         return self.framework.model
 
 
 class ObjectEvents(Object):
-    """Convenience type to allow defining .on attributes at class level."""
+    """Convenience type to allow defining ``.on`` attributes at class level."""
 
     handle_kind = "on"
 
     def __init__(self, parent: Optional[Object] = None, key: Optional[str] = None):
         if parent is not None:
             super().__init__(parent, key)
         self._cache: weakref.WeakKeyDictionary[Object, 'ObjectEvents'] = \
@@ -440,31 +430,29 @@
             instance = self._cache[emitter] = type(self)(emitter)
         return instance
 
     @classmethod
     def define_event(cls, event_kind: str, event_type: 'Type[EventBase]'):
         """Define an event on this type at runtime.
 
-        cls: a type to define an event on.
-
-        event_kind: an attribute name that will be used to access the
-                    event. Must be a valid python identifier, not be a keyword
-                    or an existing attribute.
-
-        event_type: a type of the event to define.
-
         Note that attempting to define the same event kind more than once will
-        raise a 'overlaps with existing type' runtime error. Ops uses a
+        raise an "overlaps with existing type" runtime error. Ops uses a
         labeling system to track and reconstruct events between hook executions
         (each time a hook runs, the Juju Agent invokes a fresh instance of ops;
         there is no ops process that persists on the host between hooks).
         Having duplicate Python objects creates duplicate labels. Overwriting a
         previously created label means that only the latter code path will be
-        run when the current event, if it does get deferred, is reemitted. This
-        is usually not what is desired, and is error-prone and ambigous.
+        run when the current event, if it does get deferred, is re-emitted. This
+        is usually not what is desired, and is error-prone and ambiguous.
+
+        Args:
+            event_kind: An attribute name that will be used to access the
+                        event. Must be a valid Python identifier, not be a keyword
+                        or an existing attribute.
+            event_type: A type of the event to define.
         """
         prefix = 'unable to define an event with event_kind that '
         if not event_kind.isidentifier():
             raise RuntimeError(f"{prefix}is not a valid python identifier: {event_kind}")
         elif keyword.iskeyword(event_kind):
             raise RuntimeError(f"{prefix}is a python keyword: {event_kind}")
         try:
@@ -485,15 +473,15 @@
         for attr_name, attr_value in inspect.getmembers(type(self)):
             if isinstance(attr_value, EventSource):
                 # We actually care about the bound_event, however, since it
                 # provides the most info for users of this method.
                 event_kinds.append(attr_name)
         return event_kinds
 
-    def events(self) -> Dict[str, EventSource[EventBase]]:
+    def events(self) -> Dict[str, EventSource]:
         """Return a mapping of event_kinds to bound_events for all available events."""
         return {event_kind: getattr(self, event_kind) for event_kind in self._event_kinds()}
 
     def __getitem__(self, key: str) -> 'PrefixedEvents':
         return PrefixedEvents(self, key)
 
     def __repr__(self):
@@ -505,34 +493,38 @@
 class PrefixedEvents:
     """Events to be found in all events using a specific prefix."""
 
     def __init__(self, emitter: Object, key: str):
         self._emitter = emitter
         self._prefix = key.replace('-', '_') + '_'
 
-    def __getattr__(self, name: str) -> BoundEvent[Any]:
+    def __getattr__(self, name: str) -> BoundEvent:
         return getattr(self._emitter, self._prefix + name)
 
 
 class LifecycleEvent(EventBase):
     """Events tied to the lifecycle of the Framework object."""
 
 
 class PreCommitEvent(LifecycleEvent):
-    """Events that will be emitted first on commit."""
+    """Event that will be emitted first on commit."""
 
 
 class CommitEvent(LifecycleEvent):
-    """Events that will be emitted second on commit."""
+    """Event that will be emitted second on commit."""
 
 
 class FrameworkEvents(ObjectEvents):
     """Manager of all framework events."""
+
     pre_commit = EventSource(PreCommitEvent)
+    """Triggered before the :attr:`commit` event."""
+
     commit = EventSource(CommitEvent)
+    """Triggered before event data is committed to storage."""
 
 
 class NoTypeError(Exception):
     """No class to hold it was found when restoring an event."""
 
     def __init__(self, handle_path: str):
         self.handle_path = handle_path
@@ -550,27 +542,32 @@
 
 """
 
 _event_regex = r'^(|.*/)on/[a-zA-Z_]+\[\d+\]$'
 
 
 class Framework(Object):
-    """Main interface from the Charm to the Operator Framework internals."""
+    """Main interface from the Charm to the ops library's infrastructure."""
 
-    on = FrameworkEvents()
+    on = FrameworkEvents()  # type: ignore
+    """Used for :meth:`observe`-ing framework-specific events."""
 
     # Override properties from Object so that we can set them in __init__.
-    model: 'Model' = None
-    meta: 'CharmMeta' = None
-    charm_dir: 'Path' = None
+    model: 'Model' = None  # type: ignore
+    """The :class:`Model` instance for this charm."""
 
-    # to help the type checker and IDEs:
+    meta: 'CharmMeta' = None  # type: ignore
+    """The charm's metadata."""
+
+    charm_dir: 'pathlib.Path' = None  # type: ignore
+    """The charm project root directory."""
 
+    # to help the type checker and IDEs:
     if TYPE_CHECKING:
-        _stored: 'StoredStateData' = None
+        _stored: 'StoredStateData' = None  # type: ignore
         @property
         def on(self) -> 'FrameworkEvents': ...  # noqa
 
     def __init__(self, storage: Union[SQLiteStorage, JujuStorage],
                  charm_dir: Union[str, pathlib.Path],
                  meta: 'CharmMeta', model: 'Model',
                  event_name: Optional[str] = None):
@@ -589,28 +586,29 @@
         self._event_name = event_name
 
         self.meta = meta
         self.model = model
         # [(observer_path, method_name, parent_path, event_key)]
         self._observers: _ObserverPath = []
         # {observer_path: observing Object}
-        self._observer: _PathToObjectMapping = weakref.WeakValueDictionary()
+        self._observer: _PathToObjectMapping = weakref.WeakValueDictionary()  # type: ignore
         # {object_path: object}
-        self._objects: _PathToSerializableMapping = weakref.WeakValueDictionary()
+        self._objects: _PathToSerializableMapping = weakref.WeakValueDictionary()  # type: ignore
         # {(parent_path, kind): cls}
         # (parent_path, kind) is the address of _this_ object: the parent path
         # plus a 'kind' string that is the name of this object.
-        self._type_registry: Dict[_ObjectPath, Type[_Serializable]] = {}
-        self._type_known: Set[Type[_Serializable]] = set()
+        self._type_registry: Dict[_ObjectPath, Type[Serializable]] = {}
+        self._type_known: Set[Type[Serializable]] = set()
 
         if isinstance(storage, (str, pathlib.Path)):
             logger.warning(
                 "deprecated: Framework now takes a Storage not a path")
             storage = SQLiteStorage(storage)
-        self._storage: 'SQLiteStorage' = storage
+        # TODO(benhoyt): should probably have a Storage protocol
+        self._storage: 'SQLiteStorage' = storage  # type: ignore
 
         # We can't use the higher-level StoredState because it relies on events.
         self.register_type(StoredStateData, None, StoredStateData.handle_kind)
         stored_handle = Handle(None, StoredStateData.handle_kind, '_stored')
         try:
             self._stored = typing.cast(StoredStateData, self.load_snapshot(stored_handle))
         except NoSnapshotError:
@@ -623,75 +621,76 @@
         # Parse the env var once, which may be used multiple times later
         debug_at = os.environ.get('JUJU_DEBUG_AT')
         if debug_at:
             self._juju_debug_at = {x.strip() for x in debug_at.split(',')}
         else:
             self._juju_debug_at: Set[str] = set()
 
-    def set_breakpointhook(self):
-        """Hook into sys.breakpointhook so the builtin breakpoint() works as expected.
+    def set_breakpointhook(self) -> Optional[Any]:
+        """Hook into ``sys.breakpointhook`` so the builtin ``breakpoint()`` works as expected.
 
         This method is called by ``main``, and is not intended to be
         called by users of the framework itself outside of perhaps
         some testing scenarios.
 
-        It returns the old value of sys.excepthook.
-
-        The breakpoint function is a Python >= 3.7 feature.
+        The ``breakpoint()`` function is a Python >= 3.7 feature.
 
         This method was added in ops 1.0; before that, it was done as
-        part of the Framework's __init__.
+        part of the Framework's ``__init__``.
+
+        Returns:
+            The old value of ``sys.breakpointhook``.
         """
         old_breakpointhook = getattr(sys, 'breakpointhook', None)
         if old_breakpointhook is not None:
             # Hook into builtin breakpoint, so if Python >= 3.7, devs will be able to just do
             # breakpoint()
             sys.breakpointhook = self.breakpoint
         return old_breakpointhook
 
-    def close(self):
+    def close(self) -> None:
         """Close the underlying backends."""
         self._storage.close()
 
-    def _track(self, obj: '_Serializable'):
+    def _track(self, obj: 'Serializable'):
         """Track object and ensure it is the only object created using its handle path."""
         if obj is self:
             # Framework objects don't track themselves
             return
         if obj.handle.path in self.framework._objects:
             raise RuntimeError(
                 f'two objects claiming to be {obj.handle.path} have been created')
         self._objects[obj.handle.path] = obj
 
-    def _forget(self, obj: '_Serializable'):
+    def _forget(self, obj: 'Serializable'):
         """Stop tracking the given object. See also _track."""
         self._objects.pop(obj.handle.path, None)
 
-    def commit(self):
+    def commit(self) -> None:
         """Save changes to the underlying backends."""
         # Give a chance for objects to persist data they want to before a commit is made.
         self.on.pre_commit.emit()
         # Make sure snapshots are saved by instances of StoredStateData. Any possible state
         # modifications in on_commit handlers of instances of other classes will not be persisted.
         self.on.commit.emit()
         # Save our event count after all events have been emitted.
         self.save_snapshot(self._stored)
         self._storage.commit()
 
-    def register_type(self, cls: 'Type[_Serializable]', parent: Optional['_ParentHandle'],
-                      kind: str = None):
+    def register_type(self, cls: Type[Serializable], parent: Optional[Union['Handle', 'Object']],
+                      kind: Optional[str] = None):
         """Register a type to a handle."""
         parent_path: Optional[str] = None
         if isinstance(parent, Object):
             parent_path = parent.handle.path
         elif isinstance(parent, Handle):
             parent_path = parent.path
 
-        kind: str = kind or cls.handle_kind
-        self._type_registry[(parent_path, kind)] = cls
+        kind_: str = kind or cls.handle_kind
+        self._type_registry[(parent_path, kind_)] = cls
         self._type_known.add(cls)
 
     def save_snapshot(self, value: Union["StoredStateData", "EventBase"]):
         """Save a persistent snapshot of the provided value."""
         if type(value) not in self._type_known:
             raise RuntimeError(
                 f'cannot save {type(value).__name__} values before registering that type')
@@ -706,37 +705,41 @@
             marshal.dumps(data)
         except ValueError:
             msg = "unable to save the data for {}, it must contain only simple types: {!r}"
             raise ValueError(msg.format(value.__class__.__name__, data))
 
         self._storage.save_snapshot(value.handle.path, data)
 
-    def load_snapshot(self, handle: Handle) -> '_Serializable':
+    def load_snapshot(self, handle: Handle) -> Serializable:
         """Load a persistent snapshot."""
         parent_path = None
         if handle.parent:
             parent_path = handle.parent.path
-        cls: Type[_Serializable] = self._type_registry.get((parent_path, handle.kind))
-        if not cls:
+        cls_or_none = self._type_registry.get((parent_path, handle.kind))
+        if not cls_or_none:
             raise NoTypeError(handle.path)
+        cls: Type[Serializable] = cls_or_none
         data = self._storage.load_snapshot(handle.path)
         obj = cls.__new__(cls)
-        obj.framework = self
+        obj.framework = self  # type: ignore
         obj.handle = handle
         obj.restore(data)
         self._track(obj)
         return obj
 
     def drop_snapshot(self, handle: Handle):
         """Discard a persistent snapshot."""
         self._storage.drop_snapshot(handle.path)
 
-    def observe(self, bound_event: BoundEvent[Any], observer: "_ObserverCallback"):
+    def observe(self, bound_event: BoundEvent, observer: Callable[[Any], None]):
         """Register observer to be called when bound_event is emitted.
 
+        If this is called multiple times for the same event type, the
+        framework calls the observers in the order they were observed.
+
         The bound_event is generally provided as an attribute of the object that emits
         the event, and is created in this style::
 
             class SomeObject:
                 something_happened = Event(SomethingHappened)
 
         That event may be observed as::
@@ -760,15 +763,15 @@
             raise RuntimeError(
                 f'Framework.observe requires a method as third parameter, got {observer}')
 
         event_type = bound_event.event_type
         event_kind = bound_event.event_kind
         emitter = bound_event.emitter
 
-        self.register_type(event_type, emitter, event_kind)
+        self.register_type(event_type, emitter, event_kind)  # type: ignore
 
         if hasattr(emitter, "handle"):
             emitter_path = emitter.handle.path
         else:
             raise RuntimeError(
                 f'event emitter {type(emitter).__name__} must have a "handle" attribute')
 
@@ -825,15 +828,15 @@
                 self.save_snapshot(event)
                 saved = True
             # Again, only commit this after all notices are saved.
             self._storage.save_notice(event_path, observer_path, method_name)
         if saved:
             self._reemit(event_path)
 
-    def reemit(self):
+    def reemit(self) -> None:
         """Reemit previously deferred events to the observers that deferred them.
 
         Only the specific observers that have previously deferred the event will be
         notified again. Observers that asked to be notified about events after it's
         been first emitted won't be notified, as that would mean potentially observing
         events out of order.
         """
@@ -865,15 +868,15 @@
         old_hook_is_running = backend._hook_is_running
         backend._hook_is_running = event_name
         yield
         backend._hook_is_running = old_hook_is_running
 
         self._event_name = old_event_name
 
-    def _reemit(self, single_event_path: str = None):
+    def _reemit(self, single_event_path: Optional[str] = None):
         last_event_path = None
         deferred = True
         for event_path, observer_path, method_name in self._storage.notices(single_event_path):
             event_handle = Handle.from_path(event_path)
 
             if last_event_path != event_path:
                 if not deferred and last_event_path is not None:
@@ -920,15 +923,15 @@
 
             if event.deferred:
                 deferred = True
             else:
                 self._storage.drop_notice(event_path, observer_path, method_name)
             # We intentionally consider this event to be dead and reload it from
             # scratch in the next path.
-            self.framework._forget(event)
+            self.framework._forget(event)  # type: ignore
 
         if not deferred and last_event_path is not None:
             self._storage.drop_snapshot(last_event_path)
 
     def _show_debug_code_message(self):
         """Present the welcome message (only once!) when using debugger functionality."""
         if not self._breakpoint_welcomed:
@@ -945,15 +948,15 @@
         The framework also provides a standard breakpoint named "hook", that will
         stop execution when a hook event is about to be handled.
 
         For those reasons, the "all" and "hook" breakpoint names are reserved.
         """
         # If given, validate the name comply with all the rules
         if name is not None:
-            if not isinstance(name, str):  # pyright: reportUnnecessaryIsInstance=false
+            if not isinstance(name, str):
                 raise TypeError('breakpoint names must be strings')
             if name in ('hook', 'all'):
                 raise ValueError('breakpoint names "all" and "hook" are reserved')
             if not re.match(r'^[a-z0-9]([a-z0-9\-]*[a-z0-9])?$', name):
                 raise ValueError('breakpoint names must look like "foo" or "foo-bar"')
 
         indicated_breakpoints = self._juju_debug_at
@@ -968,15 +971,15 @@
             code_frame = inspect.currentframe().f_back  # type: ignore
             pdb.Pdb().set_trace(code_frame)
         else:
             logger.warning(
                 "Breakpoint %r skipped (not found in the requested breakpoints: %s)",
                 name, indicated_breakpoints)
 
-    def remove_unreferenced_events(self):
+    def remove_unreferenced_events(self) -> None:
         """Remove events from storage that are not referenced.
 
         In older versions of the framework, events that had no observers would get recorded but
         never deleted. This makes a best effort to find these events and remove them from the
         database.
         """
         event_regex = re.compile(_event_regex)
@@ -992,32 +995,32 @@
 
 
 class StoredStateData(Object):
     """Manager of the stored data."""
 
     def __init__(self, parent: Object, attr_name: str):
         super().__init__(parent, attr_name)
-        self._cache: Dict[str, '_StorableType'] = {}
+        self._cache: Dict[str, Any] = {}
         self.dirty: bool = False
 
-    def __getitem__(self, key: str) -> '_StorableType':
+    def __getitem__(self, key: str) -> Any:
         return self._cache.get(key)
 
-    def __setitem__(self, key: str, value: '_StorableType'):
+    def __setitem__(self, key: str, value: Any):
         self._cache[key] = value
         self.dirty = True
 
     def __contains__(self, key: str):
         return key in self._cache
 
-    def snapshot(self) -> Dict[str, '_StorableType']:
+    def snapshot(self) -> Dict[str, Any]:
         """Return the current state."""
         return self._cache
 
-    def restore(self, snapshot: Dict[str, '_StorableType']):
+    def restore(self, snapshot: Dict[str, Any]):
         """Restore current state to the given snapshot."""
         self._cache = snapshot
         self.dirty = False
 
     def on_commit(self, event: EventBase) -> None:
         """Save changes to the storage backend."""
         if self.dirty:
@@ -1026,20 +1029,18 @@
 
 
 class BoundStoredState:
     """Stored state data bound to a specific Object."""
     if TYPE_CHECKING:
         # to help the type checker and IDEs:
         @property
-        def _data(self) -> StoredStateData:
-            pass
+        def _data(self) -> StoredStateData: ...  # noqa, type: ignore
 
         @property
-        def _attr_name(self) -> str:
-            pass  # pyright: reportGeneralTypeIssues=false
+        def _attr_name(self) -> str: ...  # noqa, type: ignore
 
     def __init__(self, parent: Object, attr_name: str):
         parent.framework.register_type(StoredStateData, parent)
 
         handle = Handle(parent, StoredStateData.handle_kind, attr_name)
         try:
             data = parent.framework.load_snapshot(handle)
@@ -1050,56 +1051,56 @@
         self.__dict__["_data"] = data
         self.__dict__["_attr_name"] = attr_name
 
         parent.framework.observe(parent.framework.on.commit, self._data.on_commit)  # type: ignore
 
     if TYPE_CHECKING:
         @typing.overload
-        def __getattr__(self, key: Literal['on']) -> ObjectEvents:
+        def __getattr__(self, key: Literal['on']) -> ObjectEvents:  # type: ignore
             pass
 
-    def __getattr__(self, key: str) -> Union['_StorableType', 'StoredObject', ObjectEvents]:
+    def __getattr__(self, key: str) -> Any:
         # "on" is the only reserved key that can't be used in the data map.
         if key == "on":
             return self._data.on  # type: ignore  # casting won't work for some reason
         if key not in self._data:
             raise AttributeError(f"attribute '{key}' is not stored")
         return _wrap_stored(self._data, self._data[key])
 
-    def __setattr__(self, key: str, value: Union['_StorableType', '_StoredObject']):
+    def __setattr__(self, key: str, value: Any):
         if key == "on":
             raise AttributeError("attribute 'on' is reserved and cannot be set")
 
         unwrapped = _unwrap_stored(self._data, value)
 
         if not isinstance(unwrapped, (type(None), int, float, str, bytes, list, dict, set)):
             raise AttributeError(
                 'attribute {!r} cannot be a {}: must be int/float/dict/list/etc'.format(
                     key, type(unwrapped).__name__))
 
         self._data[key] = unwrapped
 
-    def set_default(self, **kwargs: '_StorableType'):
+    def set_default(self, **kwargs: Any):
         """Set the value of any given key if it has not already been set."""
         for k, v in kwargs.items():
             if k not in self._data:
                 self._data[k] = v
 
 
 class StoredState:
-    """A class used to store data the charm needs persisted across invocations.
+    """A class used to store data the charm needs, persisted across invocations.
 
     Example::
 
         class MyClass(Object):
             _stored = StoredState()
 
-    Instances of `MyClass` can transparently save state between invocations by
-    setting attributes on `_stored`. Initial state should be set with
-    `set_default` on the bound object, that is::
+    Instances of ``MyClass`` can transparently save state between invocations by
+    setting attributes on ``_stored``. Initial state should be set with
+    ``set_default`` on the bound object, that is::
 
         class MyClass(Object):
             _stored = StoredState()
 
         def __init__(self, parent, key):
             super().__init__(parent, key)
             self._stored.set_default(seen=set())
@@ -1126,15 +1127,15 @@
         def __get__(
                 self,
                 parent: '_ObjectType',
                 parent_type: 'Type[_ObjectType]') -> BoundStoredState:
             pass
 
     def __get__(self,
-                parent: '_ObjectType',
+                parent: Optional['_ObjectType'],
                 parent_type: 'Type[_ObjectType]') -> Union['StoredState',
                                                            BoundStoredState]:
         if self.parent_type is not None and self.parent_type not in parent_type.mro():
             # the StoredState instance is being shared between two unrelated classes
             # -> unclear what is expected of us -> bail out
             raise RuntimeError(
                 f'StoredState shared by {self.parent_type.__name__} and {parent_type.__name__}')
@@ -1176,45 +1177,42 @@
             parent.__dict__[self.attr_name] = bound
             return bound
 
         raise AttributeError(
             f'cannot find {self.__class__.__name__} attribute in type {parent_type.__name__}')
 
 
-def _wrap_stored(parent_data: StoredStateData, value: '_StorableType'
-                 ) -> Union['StoredDict', 'StoredList', 'StoredSet', '_StorableType']:
+def _wrap_stored(parent_data: StoredStateData, value: Any) -> Any:
     if isinstance(value, dict):
-        return StoredDict(parent_data, value)
+        return StoredDict(parent_data, value)  # type: ignore
     if isinstance(value, list):
-        return StoredList(parent_data, value)
+        return StoredList(parent_data, value)  # type: ignore
     if isinstance(value, set):
-        return StoredSet(parent_data, value)
+        return StoredSet(parent_data, value)  # type: ignore
     return value
 
 
-def _unwrap_stored(parent_data: StoredStateData,
-                   value: Union['_StoredObject', '_StorableType']
-                   ) -> '_StorableType':
+def _unwrap_stored(parent_data: StoredStateData, value: Any) -> Any:
     if isinstance(value, (StoredDict, StoredList, StoredSet)):
-        return value._under  # pyright: reportPrivateUsage=false
-    return typing.cast('_StorableType', value)
+        return value._under  # pyright: ignore[reportPrivateUsage]
+    return value
 
 
 def _wrapped_repr(obj: '_StoredObject') -> str:
     t = type(obj)
-    if obj._under:  # pyright: reportPrivateUsage=false
+    if obj._under:
         return f"{t.__module__}.{t.__name__}({obj._under!r})"  # type: ignore
     else:
         return f"{t.__module__}.{t.__name__}()"
 
 
-class StoredDict(typing.MutableMapping[Hashable, '_StorableType']):
+class StoredDict(typing.MutableMapping[Hashable, Any]):
     """A dict-like object that uses the StoredState as backend."""
 
-    def __init__(self, stored_data: StoredStateData, under: Dict[Any, Any]):
+    def __init__(self, stored_data: StoredStateData, under: Dict[Hashable, Any]):
         self._stored_data = stored_data
         self._under = under
 
     def __getitem__(self, key: Hashable):
         return _wrap_stored(self._stored_data, self._under[key])
 
     def __setitem__(self, key: Hashable, value: Any):
@@ -1238,15 +1236,15 @@
             return self._under == other
         else:
             return NotImplemented
 
     __repr__ = _wrapped_repr  # type: ignore
 
 
-class StoredList(typing.MutableSequence['_StorableType']):
+class StoredList(typing.MutableSequence[Any]):
     """A list-like object that uses the StoredState as backend."""
 
     def __init__(self, stored_data: StoredStateData, under: List[Any]):
         self._stored_data = stored_data
         self._under = under
 
     def __getitem__(self, index: int):
@@ -1312,15 +1310,15 @@
             return self._under >= other
         else:
             return NotImplemented
 
     __repr__ = _wrapped_repr  # type: ignore
 
 
-class StoredSet(typing.MutableSet['_StorableType']):
+class StoredSet(typing.MutableSet[Any]):
     """A set-like object that uses the StoredState as backend."""
 
     def __init__(self, stored_data: StoredStateData, under: Set[Any]):
         self._stored_data = stored_data
         self._under = under
 
     def add(self, key: Any):
```

### Comparing `ops-2.3.0/ops/jujuversion.py` & `ops-2.4.0/ops/jujuversion.py`

 * *Files 4% similar despite different names*

```diff
@@ -20,27 +20,28 @@
 from typing import Union
 
 
 @total_ordering
 class JujuVersion:
     """Helper to work with the Juju version.
 
-    It knows how to parse the ``JUJU_VERSION`` environment variable, and exposes different
-    capabilities according to the specific version, allowing also to compare with other
-    versions.
+    It knows how to parse the ``JUJU_VERSION`` environment variable, and
+    exposes different capabilities according to the specific version. It also
+    allows users to compare ``JujuVersion`` instances with ``<`` and ``>``
+    operators.
     """
 
-    PATTERN = r'''^
+    _pattern_re = re.compile(r'''^
     (?P<major>\d{1,9})\.(?P<minor>\d{1,9})       # <major> and <minor> numbers are always there
     ((?:\.|-(?P<tag>[a-z]+))(?P<patch>\d{1,9}))? # sometimes with .<patch> or -<tag><patch>
     (\.(?P<build>\d{1,9}))?$                     # and sometimes with a <build> number.
-    '''
+    ''', re.VERBOSE)
 
     def __init__(self, version: str):
-        m = re.match(self.PATTERN, version, re.VERBOSE)
+        m = self._pattern_re.match(version)
         if not m:
             raise RuntimeError(f'"{version}" is not a valid Juju version string')
 
         d = m.groupdict()
         self.major = int(m.group('major'))
         self.minor = int(m.group('minor'))
         self.tag = d['tag'] or ''
@@ -57,15 +58,15 @@
         return s
 
     def __eq__(self, other: Union[str, 'JujuVersion']) -> bool:
         if self is other:
             return True
         if isinstance(other, str):
             other = type(self)(other)
-        elif not isinstance(other, JujuVersion):  # pyright: reportUnnecessaryIsInstance=false
+        elif not isinstance(other, JujuVersion):
             raise RuntimeError(f'cannot compare Juju version "{self}" with "{other}"')
         return (
             self.major == other.major
             and self.minor == other.minor
             and self.tag == other.tag
             and self.build == other.build
             and self.patch == other.patch)
@@ -91,34 +92,34 @@
             return self.patch < other.patch
         elif self.build != other.build:
             return self.build < other.build
         return False
 
     @classmethod
     def from_environ(cls) -> 'JujuVersion':
-        """Build a JujuVersion from JUJU_VERSION."""
+        """Build a version from the ``JUJU_VERSION`` environment variable."""
         v = os.environ.get('JUJU_VERSION')
         if v is None:
             v = '0.0.0'
         return cls(v)
 
     def has_app_data(self) -> bool:
-        """Determine whether this Juju version knows about app data."""
+        """Report whether this Juju version supports app data."""
         return (self.major, self.minor, self.patch) >= (2, 7, 0)
 
     def is_dispatch_aware(self) -> bool:
-        """Determine whether this Juju version knows about dispatch."""
+        """Report whether this Juju version supports dispatch."""
         return (self.major, self.minor, self.patch) >= (2, 8, 0)
 
     def has_controller_storage(self) -> bool:
-        """Determine whether this Juju version supports controller-side storage."""
+        """Report whether this Juju version supports controller-side storage."""
         return (self.major, self.minor, self.patch) >= (2, 8, 0)
 
     @property
     def has_secrets(self) -> bool:
-        """Determine whether this Juju version supports the `secrets` feature."""
+        """Report whether this Juju version supports the "secrets" feature."""
         # Juju version 3.0.0 had an initial version of secrets, but:
         # * In 3.0.2, secret-get "--update" was renamed to "--refresh", and
         #   secret-get-info was separated into its own hook tool
         # * In 3.0.3, a bug with observer labels was fixed (juju/juju#14916)
         # TODO(benhoyt): update to 3.0.3+ once shipped (for juju/juju#14916 fix)
         return (self.major, self.minor, self.patch) >= (3, 0, 2)
```

### Comparing `ops-2.3.0/ops/lib/__init__.py` & `ops-2.4.0/ops/lib/__init__.py`

 * *Files identical despite different names*

### Comparing `ops-2.3.0/ops/log.py` & `ops-2.4.0/ops/log.py`

 * *Files 16% similar despite different names*

```diff
@@ -18,28 +18,28 @@
 import sys
 import typing
 
 if typing.TYPE_CHECKING:
     from types import TracebackType
     from typing import Type
 
-    from ops.model import _ModelBackend  # pyright: reportPrivateUsage=false
+    from ops.model import _ModelBackend
 
 
 class JujuLogHandler(logging.Handler):
     """A handler for sending logs to Juju via juju-log."""
 
     def __init__(self, model_backend: "_ModelBackend", level: int = logging.DEBUG):
         super().__init__(level)
         self.model_backend = model_backend
 
     def emit(self, record: logging.LogRecord):
         """Send the specified logging record to the Juju backend.
 
-        This method is not used directly by the Operator Framework code, but by
+        This method is not used directly by the ops library, but by
         :class:`logging.Handler` itself as part of the logging machinery.
         """
         self.model_backend.juju_log(record.levelname, self.format(record))
 
 
 def setup_root_logging(model_backend: "_ModelBackend", debug: bool = False):
     """Setup python logging to forward messages to juju-log.
```

### Comparing `ops-2.3.0/ops/main.py` & `ops-2.4.0/ops/main.py`

 * *Files 1% similar despite different names*

```diff
@@ -8,15 +8,15 @@
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
-"""Main entry point to the Operator Framework.
+"""Main entry point to the framework.
 
 Note that this module is callable, and calls the :func:`ops.main.main` function.
 This is so that :code:`import ops` followed by :code:`ops.main(MyCharm)` works
 as expected.
 """
 
 import logging
@@ -64,15 +64,15 @@
         # Assume $JUJU_CHARM_DIR/lib/op/main.py structure.
         charm_dir = Path(f'{__file__}/../../..').resolve()
     else:
         charm_dir = Path(charm_dir).resolve()
     return charm_dir
 
 
-def _create_event_link(charm: 'CharmBase', bound_event: 'EventSource[Any]',
+def _create_event_link(charm: 'CharmBase', bound_event: 'EventSource',
                        link_to: Union[str, Path]):
     """Create a symlink for a particular event.
 
     Args:
         charm: A charm object.
         bound_event: An event for which to create a symlink.
         link_to: What the event link should point to
@@ -146,15 +146,15 @@
     if event_to_emit is not None:
         args, kwargs = _get_event_args(charm, event_to_emit)
         logger.debug('Emitting Juju event %s.', event_name)
         event_to_emit.emit(*args, **kwargs)
 
 
 def _get_event_args(charm: 'CharmBase',
-                    bound_event: 'BoundEvent[Any]') -> Tuple[List[Any], Dict[str, Any]]:
+                    bound_event: 'BoundEvent') -> Tuple[List[Any], Dict[str, Any]]:
     event_type = bound_event.event_type
     model = charm.framework.model
 
     relation = None
     if issubclass(event_type, ops.charm.WorkloadEvent):
         workload_name = os.environ['JUJU_WORKLOAD_NAME']
         container = model.unit.get_container(workload_name)
@@ -372,18 +372,18 @@
         use_juju_for_storage: whether to use controller-side storage. If not specified
             then kubernetes charms that haven't previously used local storage and that
             are running on a new enough Juju default to controller-side storage,
             otherwise local storage is used.
     """
     charm_dir = _get_charm_dir()
 
-    model_backend = ops.model._ModelBackend()  # pyright: reportPrivateUsage=false
+    model_backend = ops.model._ModelBackend()
     debug = ('JUJU_DEBUG' in os.environ)
     setup_root_logging(model_backend, debug=debug)
-    logger.debug("Operator Framework %s up and running.", ops.__version__)  # type:ignore
+    logger.debug("ops %s up and running.", ops.__version__)  # type:ignore
 
     dispatcher = _Dispatcher(charm_dir)
     dispatcher.run_any_legacy_hook()
 
     metadata = (charm_dir / 'metadata.yaml').read_text()
     actions_meta = charm_dir / 'actions.yaml'
     if actions_meta.exists():
```

### Comparing `ops-2.3.0/ops/model.py` & `ops-2.4.0/ops/model.py`

 * *Files 2% similar despite different names*

```diff
@@ -21,21 +21,21 @@
 import json
 import logging
 import math
 import os
 import re
 import shutil
 import stat
+import subprocess
 import tempfile
 import time
 import typing
 import weakref
 from abc import ABC, abstractmethod
-from pathlib import Path
-from subprocess import PIPE, CalledProcessError, run
+from pathlib import Path, PurePath
 from typing import (
     Any,
     BinaryIO,
     Callable,
     Dict,
     Generator,
     Iterable,
@@ -44,73 +44,43 @@
     MutableMapping,
     Optional,
     Sequence,
     Set,
     TextIO,
     Tuple,
     Type,
-    TypeVar,
     Union,
 )
 
 import ops
 import ops.pebble as pebble
 from ops._private import timeconv, yaml
 from ops.jujuversion import JujuVersion
 
+# a k8s spec is a mapping from names/"types" to json/yaml spec objects
+K8sSpec = Mapping[str, Any]
+
 if typing.TYPE_CHECKING:
-    from pebble import (  # pyright: reportMissingTypeStubs=false
-        CheckInfo,
-        CheckLevel,
-        Client,
-        ExecProcess,
-        FileInfo,
-        LayerDict,
-        Plan,
-        ServiceInfo,
-    )
     from typing_extensions import TypedDict
 
-    from ops.framework import _SerializedData
     from ops.testing import _ConfigOption
 
     _StorageDictType = Dict[str, Optional[List['Storage']]]
     _BindingDictType = Dict[Union[str, 'Relation'], 'Binding']
-    Numerical = Union[int, float]
-
-    # all types that can be (de) serialized to json(/yaml) fom Python builtins
-    JsonObject = Union[None, Numerical, bool, str,
-                       Dict[str, 'JsonObject'],
-                       List['JsonObject'],
-                       Tuple['JsonObject', ...]]
-
-    # a k8s spec is a mapping from names/"types" to json/yaml spec objects
-    # public since it is used in ops.testing
-    K8sSpec = Mapping[str, JsonObject]
 
     _StatusDict = TypedDict('_StatusDict', {'status': str, 'message': str})
 
-    # the data structure we can use to initialize pebble layers with.
-    _Layer = Union[str, LayerDict, pebble.Layer]
-
     # mapping from relation name to a list of relation objects
     _RelationMapping_Raw = Dict[str, Optional[List['Relation']]]
-    # mapping from relation name to relation metadata
-    _RelationsMeta_Raw = Dict[str, ops.charm.RelationMeta]
     # mapping from container name to container metadata
     _ContainerMeta_Raw = Dict[str, ops.charm.ContainerMeta]
-    _NetworkAddress = Union[ipaddress.IPv4Address, ipaddress.IPv6Address, str]
-    _Network = Union[ipaddress.IPv4Network, ipaddress.IPv6Network]
-
-    _ServiceInfoMapping = Mapping[str, pebble.ServiceInfo]
 
     # relation data is a string key: string value mapping so far as the
     # controller is concerned
     _RelationDataContent_Raw = Dict[str, str]
-    UnitOrApplication = Union['Unit', 'Application']
     UnitOrApplicationType = Union[Type['Unit'], Type['Application']]
 
     _AddressDict = TypedDict('_AddressDict', {
         'address': str,  # Juju < 2.9
         'value': str,  # Juju >= 2.9
         'cidr': str
     })
@@ -121,50 +91,54 @@
     _NetworkDict = TypedDict('_NetworkDict', {
         'bind-addresses': List[_BindAddressDict],
         'ingress-addresses': List[str],
         'egress-subnets': List[str]
     })
 
 
-StrOrPath = typing.Union[str, Path]
-
 logger = logging.getLogger(__name__)
 
 MAX_LOG_LINE_LEN = 131071  # Max length of strings to pass to subshell.
 
 
 class Model:
     """Represents the Juju Model as seen from this unit.
 
-    This should not be instantiated directly by Charmers, but can be accessed as `self.model`
-    from any class that derives from Object.
+    This should not be instantiated directly by Charmers, but can be accessed
+    as ``self.model`` from any class that derives from :class:`Object`.
     """
 
     def __init__(self, meta: 'ops.charm.CharmMeta', backend: '_ModelBackend'):
         self._cache = _ModelCache(meta, backend)
         self._backend = backend
         self._unit = self.get_unit(self._backend.unit_name)
-        relations: _RelationsMeta_Raw = meta.relations
+        relations: Dict[str, 'ops.RelationMeta'] = meta.relations
         self._relations = RelationMapping(relations, self.unit, self._backend, self._cache)
         self._config = ConfigData(self._backend)
         resources: Iterable[str] = meta.resources
         self._resources = Resources(list(resources), self._backend)
         self._pod = Pod(self._backend)
         storages: Iterable[str] = meta.storages
         self._storages = StorageMapping(list(storages), self._backend)
         self._bindings = BindingMapping(self._backend)
 
     @property
     def unit(self) -> 'Unit':
-        """A :class:`Unit` that represents the unit that is running this code (eg yourself)."""
+        """The unit that is running this code (that is, yourself).
+
+        Use :meth:`get_unit` to get an arbitrary unit by name.
+        """
         return self._unit
 
     @property
     def app(self) -> 'Application':
-        """A :class:`Application` that represents the application this unit is a part of."""
+        """The application this unit is a part of.
+
+        Use :meth:`get_app` to get an arbitrary application by name.
+        """
         return self._unit.app
 
     @property
     def relations(self) -> 'RelationMapping':
         """Mapping of endpoint to list of :class:`Relation`.
 
         Answers the question "what am I currently related to".
@@ -189,15 +163,21 @@
     @property
     def storages(self) -> 'StorageMapping':
         """Mapping of storage_name to :class:`Storage` as defined in metadata.yaml."""
         return self._storages
 
     @property
     def pod(self) -> 'Pod':
-        """Use ``model.pod.set_spec`` to set the container specification for Kubernetes charms."""
+        """Represents the definition of a pod spec in legacy Kubernetes models.
+
+        DEPRECATED: New charms should use the sidecar pattern with Pebble.
+
+        Use :meth:`Pod.set_spec` to set the container specification for legacy
+        Kubernetes charms.
+        """
         return self._pod
 
     @property
     def name(self) -> str:
         """Return the name of the Model that this unit is running in.
 
         This is read from the environment variable ``JUJU_MODEL_NAME``.
@@ -211,22 +191,26 @@
         This is read from the environment variable ``JUJU_MODEL_UUID``.
         """
         return self._backend.model_uuid
 
     def get_unit(self, unit_name: str) -> 'Unit':
         """Get an arbitrary unit by name.
 
+        Use :attr:`unit` to get your own unit.
+
         Internally this uses a cache, so asking for the same unit two times will
         return the same object.
         """
         return self._cache.get(Unit, unit_name)
 
     def get_app(self, app_name: str) -> 'Application':
         """Get an application by name.
 
+        Use :attr:`app` to get your own application.
+
         Internally this uses a cache, so asking for the same application two times will
         return the same object.
         """
         return self._cache.get(Application, app_name)
 
     def get_relation(
             self, relation_name: str,
@@ -287,24 +271,21 @@
         except ModelError:
             # TODO(benhoyt): remove the secret-info-get fallback once
             #  juju/juju#14916 is fixed (should be in Juju 3.0.3)
             info = self._backend.secret_info_get(id=id, label=label)
             return Secret(self._backend, id=info.id, label=info.label)
 
 
-_T = TypeVar('_T', bound='UnitOrApplication')
-
-
 class _ModelCache:
     def __init__(self, meta: 'ops.charm.CharmMeta', backend: '_ModelBackend'):
         if typing.TYPE_CHECKING:
             # (entity type, name): instance.
             _weakcachetype = weakref.WeakValueDictionary[
                 Tuple['UnitOrApplicationType', str],
-                Optional['UnitOrApplication']]
+                Optional[Union['Unit', 'Application']]]
 
         self._meta = meta
         self._backend = backend
         self._weakrefs: _weakcachetype = weakref.WeakValueDictionary()
 
     @typing.overload
     def get(self, entity_type: Type['Unit'], name: str) -> 'Unit': ...  # noqa
@@ -324,19 +305,21 @@
 
 
 class Application:
     """Represents a named application in the model.
 
     This might be your application, or might be an application that you are related to.
     Charmers should not instantiate Application objects directly, but should use
+    :attr:`Model.app` to get the application this unit is part of, or
     :meth:`Model.get_app` if they need a reference to a given application.
+    """
 
-    Attributes:
-        name: The name of this application (eg, 'mysql'). This name may differ from the name of
-            the charm, if the user has deployed it to a different name.
+    name: str
+    """The name of this application (eg, 'mysql'). This name may differ from the name of
+    the charm, if the user has deployed it to a different name.
     """
 
     def __init__(self, name: str, meta: 'ops.charm.CharmMeta',
                  backend: '_ModelBackend', cache: _ModelCache):
         self.name = name
         self._backend = backend
         self._cache = cache
@@ -394,15 +377,15 @@
             assert isinstance(getattr(value, _key), str), f'status.{_key} must be a string'
         self._backend.status_set(value.name, value.message, is_app=True)
         self._status = value
 
     def planned_units(self) -> int:
         """Get the number of units that Juju has "planned" for this application.
 
-        E.g., if an operator runs "juju deploy foo", then "juju add-unit -n 2 foo", the
+        E.g., if an admin runs "juju deploy foo", then "juju add-unit -n 2 foo", the
         planned unit count for foo will be 3.
 
         The data comes from the Juju agent, based on data it fetches from the
         controller. Pending units are included in the count, and scale down events may
         modify the count before some units have been fully torn down. The information in
         planned_units is up-to-date as of the start of the current hook invocation.
 
@@ -465,20 +448,22 @@
 
 
 class Unit:
     """Represents a named unit in the model.
 
     This might be your unit, another unit of your application, or a unit of another application
     that you are related to.
-
-    Attributes:
-        name: The name of the unit (eg, 'mysql/0')
-        app: The Application the unit is a part of.
     """
 
+    name: str
+    """Name of the unit, for example "mysql/0"."""
+
+    app: Application
+    """Application the unit is part of."""
+
     def __init__(self, name: str, meta: 'ops.charm.CharmMeta',
                  backend: '_ModelBackend', cache: '_ModelCache'):
         self.name = name
 
         app_name = name.split('/')[0]
         self.app = cache.get(Application, app_name)
 
@@ -536,16 +521,14 @@
         return f'<{type(self).__module__}.{type(self).__name__} {self.name}>'
 
     def is_leader(self) -> bool:
         """Return whether this unit is the leader of its application.
 
         This can only be called for your own unit.
 
-        Returns:
-            True if you are the leader, False otherwise
         Raises:
             RuntimeError: if called for a unit that is not yourself
         """
         if self._is_our_unit:
             # This value is not cached as it is not guaranteed to persist for the whole duration
             # of a hook execution.
             return self._backend.is_leader()
@@ -604,15 +587,15 @@
 
     def open_port(self, protocol: typing.Literal['tcp', 'udp', 'icmp'],
                   port: Optional[int] = None):
         """Open a port with the given protocol for this unit.
 
         Calling this registers intent with Juju that the application should be
         accessed on the given port, but the port isn't actually opened
-        externally until the operator runs "juju expose".
+        externally until the admin runs "juju expose".
 
         On Kubernetes sidecar charms, the ports opened are not strictly
         per-unit: Juju will open the union of ports from all units.
         However, normally charms should make the same open_port() call from
         every unit.
 
         Args:
@@ -647,19 +630,19 @@
         return self._backend.opened_ports()
 
 
 @dataclasses.dataclass(frozen=True)
 class OpenedPort:
     """Represents a port opened by :meth:`Unit.open_port`."""
 
-    """The IP protocol: 'tcp', 'udp', or 'icmp'."""
     protocol: typing.Literal['tcp', 'udp', 'icmp']
+    """The IP protocol."""
 
-    """The port number. Will be None if protocol is 'icmp'."""
     port: Optional[int]
+    """The port number. Will be ``None`` if protocol is ``'icmp'``."""
 
 
 class LazyMapping(Mapping[str, str], ABC):
     """Represents a dict that isn't populated until it is accessed.
 
     Charm authors should generally never need to use this directly, but it forms
     the basis for many of the dicts that the framework tracks.
@@ -697,15 +680,15 @@
     def __repr__(self):
         return repr(self._data)
 
 
 class RelationMapping(Mapping[str, List['Relation']]):
     """Map of relation names to lists of :class:`Relation` instances."""
 
-    def __init__(self, relations_meta: '_RelationsMeta_Raw', our_unit: 'Unit',
+    def __init__(self, relations_meta: Dict[str, 'ops.RelationMeta'], our_unit: 'Unit',
                  backend: '_ModelBackend', cache: '_ModelCache'):
         self._peers: Set[str] = set()
         for name, relation_meta in relations_meta.items():
             if relation_meta.role.is_peer():
                 self._peers.add(name)
         self._our_unit = our_unit
         self._backend = backend
@@ -753,15 +736,15 @@
             else:
                 # The relation may be dead, but it is not forgotten.
                 is_peer = relation_name in self._peers
                 return Relation(relation_name, relation_id, is_peer,
                                 self._our_unit, self._backend, self._cache)
         relations = self[relation_name]
         num_related = len(relations)
-        self._backend._validate_relation_access(  # pyright: reportPrivateUsage=false
+        self._backend._validate_relation_access(
             relation_name, relations)
         if num_related == 0:
             return None
         elif num_related == 1:
             return self[relation_name][0]
         else:
             # TODO: We need something in the framework to catch and gracefully handle
@@ -808,19 +791,18 @@
         raise NotImplementedError()
 
     def __len__(self) -> int:
         raise NotImplementedError()
 
 
 class Binding:
-    """Binding to a network space.
+    """Binding to a network space."""
 
-    Attributes:
-        name: The name of the endpoint this binding represents (eg, 'db')
-    """
+    name: str
+    """The name of the endpoint this binding represents (eg, 'db')."""
 
     def __init__(self, name: str, relation_id: Optional[int], backend: '_ModelBackend'):
         self.name = name
         self._relation_id = relation_id
         self._backend = backend
         self._network = None
 
@@ -838,80 +820,93 @@
                     raise
                 # If a relation is dead, we can still get network info associated with an
                 # endpoint itself
                 self._network = self._network_get(self.name)
         return self._network
 
 
-def _cast_network_address(raw: str) -> '_NetworkAddress':
+def _cast_network_address(raw: str) -> Union[ipaddress.IPv4Address, ipaddress.IPv6Address, str]:
     # fields marked as network addresses need not be IPs; they could be
     # hostnames that juju failed to resolve. In that case, we'll log a
     # debug message and leave it as-is.
     try:
         return ipaddress.ip_address(raw)
     except ValueError:
         logger.debug(f"could not cast {raw} to IPv4/v6 address")
         return raw
 
 
 class Network:
     """Network space details.
 
     Charm authors should not instantiate this directly, but should get access to the Network
-    definition from :meth:`Model.get_binding` and its ``network`` attribute.
+    definition from :meth:`Model.get_binding` and its :code:`network` attribute.
+    """
+
+    interfaces: List['NetworkInterface']
+    """A list of network interface details. This includes the information
+    about how your application should be configured (for example, what IP
+    addresses you should bind to).
+
+    Multiple addresses for a single interface are represented as multiple
+    interfaces, for example::
+
+        [NetworkInfo('ens1', '10.1.1.1/32'), NetworkInfo('ens1', '10.1.2.1/32'])
+    """
+
+    ingress_addresses: List[Union[ipaddress.IPv4Address, ipaddress.IPv6Address, str]]
+    """A list of IP addresses that other units should use to get in touch with you."""
 
-    Attributes:
-        interfaces: A list of :class:`NetworkInterface` details. This includes the
-            information about how your application should be configured (eg, what
-            IP addresses should you bind to.)
-            Note that multiple addresses for a single interface are represented as multiple
-            interfaces. (eg, ``[NetworkInfo('ens1', '10.1.1.1/32'),
-            NetworkInfo('ens1', '10.1.2.1/32'])``)
-        ingress_addresses: A list of :class:`ipaddress.ip_address` objects representing the IP
-            addresses that other units should use to get in touch with you.
-        egress_subnets: A list of :class:`ipaddress.ip_network` representing the subnets that
-            other units will see you connecting from. Due to things like NAT it isn't always
-            possible to narrow it down to a single address, but when it is clear, the CIDRs
-            will be constrained to a single address. (eg, 10.0.0.1/32)
-    Args:
-        network_info: A dict of network information as returned by ``network-get``.
+    egress_subnets: List[Union[ipaddress.IPv4Network, ipaddress.IPv6Network]]
+    """A list of networks representing the subnets that other units will see
+    you connecting from. Due to things like NAT it isn't always possible to
+    narrow it down to a single address, but when it is clear, the CIDRs will
+    be constrained to a single address (for example, 10.0.0.1/32).
     """
 
     def __init__(self, network_info: '_NetworkDict'):
-        self.interfaces: List[NetworkInterface] = []
+        """Initialize a Network instance.
+
+        Args:
+            network_info: A dict of network information as returned by ``network-get``.
+        """
+        self.interfaces = []
         # Treat multiple addresses on an interface as multiple logical
         # interfaces with the same name.
         for interface_info in network_info.get('bind-addresses', []):
             interface_name: str = interface_info.get('interface-name')
             addrs: Optional[List[_AddressDict]] = interface_info.get('addresses')
             if addrs is not None:
                 for address_info in addrs:
                     self.interfaces.append(NetworkInterface(interface_name, address_info))
-        self.ingress_addresses: List[_NetworkAddress] = []
+
+        self.ingress_addresses = []
         for address in network_info.get('ingress-addresses', []):
             self.ingress_addresses.append(_cast_network_address(address))
-        self.egress_subnets: List[_Network] = []
+
+        self.egress_subnets = []
         for subnet in network_info.get('egress-subnets', []):
             self.egress_subnets.append(ipaddress.ip_network(subnet))
 
     @property
-    def bind_address(self) -> Optional['_NetworkAddress']:
+    def bind_address(self) -> Optional[Union[ipaddress.IPv4Address, ipaddress.IPv6Address, str]]:
         """A single address that your application should bind() to.
 
         For the common case where there is a single answer. This represents a single
         address from :attr:`.interfaces` that can be used to configure where your
         application should bind() and listen().
         """
         if self.interfaces:
             return self.interfaces[0].address
         else:
             return None
 
     @property
-    def ingress_address(self) -> Optional['_NetworkAddress']:
+    def ingress_address(self) -> Optional[
+            Union[ipaddress.IPv4Address, ipaddress.IPv6Address, str]]:
         """The address other applications should use to connect to your unit.
 
         Due to things like public/private addresses, NAT and tunneling, the address you bind()
         to is not always the address other people can use to connect() to you.
         This is just the first address from :attr:`.ingress_addresses`.
         """
         if self.ingress_addresses:
@@ -921,44 +916,50 @@
 
 
 class NetworkInterface:
     """Represents a single network interface that the charm needs to know about.
 
     Charmers should not instantiate this type directly. Instead use :meth:`Model.get_binding`
     to get the network information for a given endpoint.
+    """
+
+    name: str
+    """The name of the interface (for example, 'eth0' or 'ens1')."""
 
-    Attributes:
-        name: The name of the interface (eg. 'eth0', or 'ens1')
-        subnet: An :class:`ipaddress.ip_network` representation of the IP for the network
-            interface. This may be a single address (eg '10.0.1.2/32')
+    address: Optional[Union[ipaddress.IPv4Address, ipaddress.IPv6Address, str]]
+    """The address of the network interface."""
+
+    subnet: Optional[Union[ipaddress.IPv4Network, ipaddress.IPv6Network]]
+    """The subnet of the network interface. This may be a single address
+    (for example, '10.0.1.2/32').
     """
 
     def __init__(self, name: str, address_info: '_AddressDict'):
         self.name = name
         # TODO: expose a hardware address here, see LP: #1864070.
 
         address = address_info.get('value')
         if address is None:
             # Compatibility with Juju <2.9: legacy address_info only had
             # an 'address' field instead of 'value'.
             address = address_info.get('address')
 
         # The value field may be empty.
         address_ = _cast_network_address(address) if address else None
-        self.address: Optional[_NetworkAddress] = address_
+        self.address = address_
         cidr: str = address_info.get('cidr')
         # The cidr field may be empty, see LP: #1864102.
         if cidr:
             subnet = ipaddress.ip_network(cidr)
         elif address:
             # If we have an address, convert it to a /32 or /128 IP network.
             subnet = ipaddress.ip_network(address)
         else:
             subnet = None
-        self.subnet: Optional[_Network] = subnet
+        self.subnet = subnet
         # TODO: expose a hostname/canonical name for the address here, see LP: #1864086.
 
 
 class SecretRotate(enum.Enum):
     """Secret rotation policies."""
 
     NEVER = 'never'  # the default in juju
@@ -984,15 +985,15 @@
         self.label = label
         self.revision = revision
         self.expires = expires
         self.rotation = rotation
         self.rotates = rotates
 
     @classmethod
-    def from_dict(cls, id: str, d: '_SerializedData') -> 'SecretInfo':
+    def from_dict(cls, id: str, d: Dict[str, Any]) -> 'SecretInfo':
         """Create new SecretInfo object from ID and dict parsed from JSON."""
         expires = typing.cast(Optional[str], d.get('expires'))
         try:
             rotation = SecretRotate(typing.cast(Optional[str], d.get('rotation')))
         except ValueError:
             rotation = None
         rotates = typing.cast(Optional[str], d.get('rotates'))
@@ -1223,47 +1224,61 @@
 
         This is normally called when handling :class:`ops.charm.SecretRemoveEvent`
         or :class:`ops.charm.SecretExpiredEvent`.
 
         Args:
             revision: The secret revision to remove. If being called from a
                 secret event, this should usually be set to
-                :attr:`SecretEvent.revision`.
+                :attr:`SecretRemoveEvent.revision`.
         """
         if self._id is None:
             self._id = self.get_info().id
         self._backend.secret_remove(typing.cast(str, self.id), revision=revision)
 
-    def remove_all_revisions(self):
+    def remove_all_revisions(self) -> None:
         """Remove all revisions of this secret.
 
         This is called when the secret is no longer needed, for example when
         handling :class:`ops.charm.RelationBrokenEvent`.
         """
         if self._id is None:
             self._id = self.get_info().id
         self._backend.secret_remove(typing.cast(str, self.id))
 
 
 class Relation:
     """Represents an established relation between this application and another application.
 
-    This class should not be instantiated directly, instead use :meth:`Model.get_relation`
-    or :attr:`ops.charm.RelationEvent.relation`. This is principally used by
-    :class:`ops.charm.RelationMeta` to represent the relationships between charms.
-
-    Attributes:
-        name: The name of the local endpoint of the relation (eg 'db')
-        id: The identifier for a particular relation (integer)
-        app: An :class:`Application` representing the remote application of this relation.
-            For peer relations this will be the local application.
-        units: A set of :class:`Unit` for units that have started and joined this relation.
-            For subordinate relations, this set will include only one unit: the principal unit.
-        data: A :class:`RelationData` holding the data buckets for each entity
-            of a relation. Accessed via eg Relation.data[unit]['foo']
+    This class should not be instantiated directly, instead use :meth:`Model.get_relation`,
+    :attr:`Model.relations`, or :attr:`ops.RelationEvent.relation`. This is principally used by
+    :class:`ops.RelationMeta` to represent the relationships between charms.
+    """
+
+    name: str
+    """The name of the local endpoint of the relation (for example, 'db')."""
+
+    id: int
+    """The identifier for a particular relation."""
+
+    app: Optional[Application]
+    """Represents the remote application of this relation.
+
+    For peer relations, this will be the local application.
+    """
+
+    units: Set[Unit]
+    """A set of units that have started and joined this relation.
+
+    For subordinate relations, this set will include only one unit: the principal unit.
+    """
+
+    data: 'RelationData'
+    """Holds the data buckets for each entity of a relation.
+
+    This is accessed using, for example, ``Relation.data[unit]['foo']``.
     """
 
     def __init__(
             self, relation_name: str, relation_id: int, is_peer: bool, our_unit: Unit,
             backend: '_ModelBackend', cache: '_ModelCache'):
         self.name = relation_name
         self.id = relation_id
@@ -1294,54 +1309,54 @@
 
         self.data = RelationData(self, our_unit, backend)
 
     def __repr__(self):
         return f'<{type(self).__module__}.{type(self).__name__} {self.name}:{self.id}>'
 
 
-class RelationData(Mapping['UnitOrApplication', 'RelationDataContent']):
+class RelationData(Mapping[Union['Unit', 'Application'], 'RelationDataContent']):
     """Represents the various data buckets of a given relation.
 
     Each unit and application involved in a relation has their own data bucket.
-    Eg: ``{entity: RelationDataContent}``
-    where entity can be either a :class:`Unit` or a :class:`Application`.
+    For example, ``{entity: RelationDataContent}``,
+    where entity can be either a :class:`Unit` or an :class:`Application`.
 
     Units can read and write their own data, and if they are the leader,
     they can read and write their application data. They are allowed to read
     remote unit and application data.
 
-    This class should not be created directly. It should be accessed via
+    This class should not be instantiated directly, instead use
     :attr:`Relation.data`
     """
 
     def __init__(self, relation: Relation, our_unit: Unit, backend: '_ModelBackend'):
         self.relation = weakref.proxy(relation)
-        self._data: Dict[UnitOrApplication, RelationDataContent] = {
+        self._data: Dict[Union['Unit', 'Application'], RelationDataContent] = {
             our_unit: RelationDataContent(self.relation, our_unit, backend),
             our_unit.app: RelationDataContent(self.relation, our_unit.app, backend),
         }
         self._data.update({
             unit: RelationDataContent(self.relation, unit, backend)
             for unit in self.relation.units})
         # The relation might be dead so avoid a None key here.
         if self.relation.app is not None:
             self._data.update({
                 self.relation.app: RelationDataContent(self.relation, self.relation.app, backend),
             })
 
-    def __contains__(self, key: 'UnitOrApplication'):
+    def __contains__(self, key: Union['Unit', 'Application']):
         return key in self._data
 
     def __len__(self):
         return len(self._data)
 
     def __iter__(self):
         return iter(self._data)
 
-    def __getitem__(self, key: 'UnitOrApplication'):
+    def __getitem__(self, key: Union['Unit', 'Application']):
         if key is None and self.relation.app is None:
             # NOTE: if juju gets fixed to set JUJU_REMOTE_APP for relation-broken events, then that
             # should fix the only case in which we expect key to be None - potentially removing the
             # need for this error in future ops versions (i.e. if relation.app is guaranteed to not
             # be None. See https://bugs.launchpad.net/juju/+bug/1960934.
             raise KeyError(
                 'Cannot index relation data with "None".'
@@ -1354,27 +1369,27 @@
 
 
 # We mix in MutableMapping here to get some convenience implementations, but whether it's actually
 # mutable or not is controlled by the flag.
 class RelationDataContent(LazyMapping, MutableMapping[str, str]):
     """Data content of a unit or application in a relation."""
 
-    def __init__(self, relation: 'Relation', entity: 'UnitOrApplication',
+    def __init__(self, relation: 'Relation', entity: Union['Unit', 'Application'],
                  backend: '_ModelBackend'):
         self.relation = relation
         self._entity = entity
         self._backend = backend
         self._is_app: bool = isinstance(entity, Application)
 
     @property
     def _hook_is_running(self) -> bool:
         # this flag controls whether the access we have to RelationDataContent
         # is 'strict' aka the same as a deployed charm would have, or whether it is
         # unrestricted, allowing test code to read/write databags at will.
-        return bool(self._backend._hook_is_running)  # pyright: reportPrivateUsage=false
+        return bool(self._backend._hook_is_running)
 
     def _load(self) -> '_RelationDataContent_Raw':
         """Load the data from the current entity / relation."""
         try:
             return self._backend.relation_get(self.relation.id, self._entity.name, self._is_app)
         except RelationNotFoundError:
             # Dead relations tell no tales (and have no data).
@@ -1506,56 +1521,63 @@
             return '<n/a>'
         return super().__repr__()
 
 
 class ConfigData(LazyMapping):
     """Configuration data.
 
-    This class should not be created directly. It should be accessed via :attr:`Model.config`.
+    This class should not be instantiated directly. It should be accessed via :attr:`Model.config`.
     """
 
     def __init__(self, backend: '_ModelBackend'):
         self._backend = backend
 
     def _load(self):
         return self._backend.config_get()
 
 
 class StatusBase:
     """Status values specific to applications and units.
 
-    To access a status by name, see :meth:`StatusBase.from_name`, most use cases will just
-    directly use the child class to indicate their status.
+    To access a status by name, use :meth:`StatusBase.from_name`. However, most use cases will
+    directly use the child class such as :class:`ActiveStatus` to indicate their status.
     """
 
     _statuses: Dict[str, Type['StatusBase']] = {}
 
     # Subclasses should override this attribute and make it a string.
     name = NotImplemented
 
     def __init__(self, message: str = ''):
-        self.message = message
-
-    def __new__(cls, *args: Any, **kwargs: Dict[Any, Any]):
-        """Forbid the usage of StatusBase directly."""
-        if cls is StatusBase:
+        if self.__class__ is StatusBase:
             raise TypeError("cannot instantiate a base class")
-        return super().__new__(cls)
+        self.message = message
 
     def __eq__(self, other: 'StatusBase') -> bool:
         if not isinstance(self, type(other)):
             return False
         return self.message == other.message
 
     def __repr__(self):
         return f"{self.__class__.__name__}({self.message!r})"
 
     @classmethod
     def from_name(cls, name: str, message: str):
-        """Get the specific Status for the name (or UnknownStatus if not registered)."""
+        """Create a status instance from a name and message.
+
+        If ``name`` is "unknown", ``message`` is ignored, because unknown status
+        does not have an associated message.
+
+        Args:
+            name: Name of the status, for example "active" or "blocked".
+            message: Message to include with the status.
+
+        Raises:
+            KeyError: If ``name`` is not a registered status.
+        """
         if name == 'unknown':
             # unknown is special
             return UnknownStatus()
         else:
             return cls._statuses[name](message)
 
     @classmethod
@@ -1608,15 +1630,15 @@
         super().__init__(message)
 
 
 @StatusBase.register
 class BlockedStatus(StatusBase):
     """The unit requires manual intervention.
 
-    An operator has to manually intervene to unblock the unit and let it proceed.
+    An admin has to manually intervene to unblock the unit and let it proceed.
     """
     name = 'blocked'
 
 
 @StatusBase.register
 class MaintenanceStatus(StatusBase):
     """The unit is performing maintenance tasks.
@@ -1646,59 +1668,59 @@
     def __init__(self, names: Iterable[str], backend: '_ModelBackend'):
         self._backend = backend
         self._paths: Dict[str, Optional[Path]] = {name: None for name in names}
 
     def fetch(self, name: str) -> Path:
         """Fetch the resource from the controller or store.
 
-        If successfully fetched, this returns a Path object to where the resource is stored
-        on disk, otherwise it raises a NameError.
+        If successfully fetched, this returns the path where the resource is stored
+        on disk, otherwise it raises a :class:`NameError`.
         """
         if name not in self._paths:
             raise NameError(f'invalid resource name: {name}')
         if self._paths[name] is None:
             self._paths[name] = Path(self._backend.resource_get(name))
         return typing.cast(Path, self._paths[name])
 
 
 class Pod:
-    """Represents the definition of a pod spec in Kubernetes models.
+    """Represents the definition of a pod spec in legacy Kubernetes models.
+
+    DEPRECATED: New charms should use the sidecar pattern with Pebble.
 
-    Currently only supports simple access to setting the Juju pod spec via :attr:`.set_spec`.
+    Currently only supports simple access to setting the Juju pod spec via
+    :attr:`.set_spec`.
     """
 
     def __init__(self, backend: '_ModelBackend'):
         self._backend = backend
 
     def set_spec(self, spec: 'K8sSpec', k8s_resources: Optional['K8sSpec'] = None):
         """Set the specification for pods that Juju should start in kubernetes.
 
-        See `juju help-tool pod-spec-set` for details of what should be passed.
+        See ``juju help-tool pod-spec-set`` for details of what should be passed.
 
         Args:
             spec: The mapping defining the pod specification
             k8s_resources: Additional kubernetes specific specification.
-
-        Returns:
-            None
         """
         if not self._backend.is_leader():
             raise ModelError('cannot set a pod spec as this unit is not a leader')
         self._backend.pod_spec_set(spec, k8s_resources)
 
 
 class StorageMapping(Mapping[str, List['Storage']]):
     """Map of storage names to lists of Storage instances."""
 
     def __init__(self, storage_names: Iterable[str], backend: '_ModelBackend'):
         self._backend = backend
         self._storage_map: _StorageDictType = {storage_name: None
                                                for storage_name in storage_names}
 
-    def __contains__(self, key: str):  # pyright: reportIncompatibleMethodOverride=false
+    def __contains__(self, key: str):  # pyright: ignore[reportIncompatibleMethodOverride]
         return key in self._storage_map
 
     def __len__(self):
         return len(self._storage_map)
 
     def __iter__(self):
         return iter(self._storage_map)
@@ -1716,15 +1738,15 @@
                 storage_list.append(storage)  # type: ignore
         return storage_list
 
     def request(self, storage_name: str, count: int = 1):
         """Requests new storage instances of a given name.
 
         Uses storage-add tool to request additional storage. Juju will notify the unit
-        via <storage-name>-storage-attached events when it becomes available.
+        via ``<storage-name>-storage-attached`` events when it becomes available.
         """
         if storage_name not in self._storage_map:
             raise ModelError(('cannot add storage {!r}:'
                               ' it is not present in the charm metadata').format(storage_name))
         self._backend.storage_add(storage_name, count)
 
     def _invalidate(self, storage_name: str):
@@ -1732,46 +1754,44 @@
 
         Not meant to be used by charm authors -- this exists mainly for testing purposes.
         """
         self._storage_map[storage_name] = None
 
 
 class Storage:
-    """Represents a storage as defined in metadata.yaml.
+    """Represents a storage as defined in ``metadata.yaml``."""
 
-    Attributes:
-        name: Simple string name of the storage
-        index: The index number for storage
-    """
+    name: str
+    """Name of the storage."""
 
     def __init__(self, storage_name: str, storage_index: int, backend: '_ModelBackend'):
         self.name = storage_name
         self._index = storage_index
         self._backend = backend
         self._location = None
 
     @property
     def index(self) -> int:
-        """The index associated with the storage (usually 0 for singular storage)."""
+        """Index associated with the storage (usually 0 for singular storage)."""
         return self._index
 
     @property
     def id(self) -> int:
-        """DEPRECATED (use ".index"): The index associated with the storage."""
+        """DEPRECATED. Use :attr:`Storage.index` instead."""
         logger.warning("model.Storage.id is being replaced - please use model.Storage.index")
         return self.index
 
     @property
     def full_id(self) -> str:
-        """Returns the canonical storage name and id/index based identifier."""
+        """Canonical storage name with index, for example "bigdisk/0"."""
         return f'{self.name}/{self._index}'
 
     @property
     def location(self) -> Path:
-        """Return the location of the storage."""
+        """Location of the storage."""
         if self._location is None:
             raw = self._backend.storage_get(self.full_id, "location")
             self._location = Path(raw)
         return self._location
 
     @location.setter
     def location(self, location: str) -> None:
@@ -1780,83 +1800,79 @@
         For :class:`StorageAttachedEvent` and :class:`StorageDetachingEvent` in case
         the actual details are gone from Juju by the time of a dynamic lookup.
         """
         self._location = Path(location)
 
 
 class MultiPushPullError(Exception):
-    """Aggregates multiple push/pull related exceptions into one."""
+    """Aggregates multiple push and pull exceptions into one.
 
-    def __init__(self, message: str, errors: List[Tuple[str, Exception]]):
-        """Create an aggregation of several push/pull errors.
+    This class should not be instantiated directly. It is raised by
+    :meth:`Container.push_path` and :meth:`Container.pull_path`.
+    """
 
-        Args:
-            message: error message
-            errors: list of errors with each represented by a tuple (<source_path>,<exception>)
-                where source_path is the path being pushed/pulled from.
-        """
-        self.errors = errors
+    message: str
+    """The error message."""
+
+    errors: List[Tuple[str, Exception]]
+    """The list of errors.
+
+    Each error is represented by a tuple of (<source_path>, <exception>),
+    where source_path is the path being pushed to or pulled from.
+    """
+
+    def __init__(self, message: str, errors: List[Tuple[str, Exception]]):
         self.message = message
+        self.errors = errors
 
     def __str__(self):
         return f'{self.message} ({len(self.errors)} errors): {self.errors[0][1]}, ...'
 
     def __repr__(self):
-        return f'MultiError({self.message!r}, {len(self.errors)} errors)'
+        return f'MultiPushPullError({self.message!r}, {len(self.errors)} errors)'
 
 
 class Container:
     """Represents a named container in a unit.
 
     This class should not be instantiated directly, instead use :meth:`Unit.get_container`
     or :attr:`Unit.containers`.
-
-    Attributes:
-        name: The name of the container from metadata.yaml (eg, 'postgres').
     """
 
+    name: str
+    """The name of the container from ``metadata.yaml``, for example "postgres"."""
+
     def __init__(self, name: str, backend: '_ModelBackend',
-                 pebble_client: Optional['Client'] = None):
+                 pebble_client: Optional[pebble.Client] = None):
         self.name = name
 
         if pebble_client is None:
             socket_path = f'/charm/containers/{name}/pebble.socket'
             pebble_client = backend.get_pebble(socket_path)
-        self._pebble: 'Client' = pebble_client
-
-    @property
-    def pebble(self) -> 'Client':
-        """The low-level :class:`ops.pebble.Client` instance for this container."""
-        return self._pebble
+        self._pebble: pebble.Client = pebble_client
 
     def can_connect(self) -> bool:
         """Report whether the Pebble API is reachable in the container.
 
-        :meth:`can_connect` returns a bool that indicates whether the Pebble API is available at
+        This method returns a bool that indicates whether the Pebble API is available at
         the time the method is called. It does not guard against the Pebble API becoming
-        unavailable, and should be treated as a 'point in time' status only.
+        unavailable, and should be treated as a "point in time" status only.
 
-        If the Pebble API later fails, serious consideration should be given as to the reason for
-        this.
-
-        Example::
+        For example::
 
             container = self.unit.get_container("example")
             if container.can_connect():
                 try:
                     c.pull('/does/not/exist')
                 except ProtocolError, PathError:
                     # handle it
             else:
                 event.defer()
         """
         try:
-            # TODO: This call to `get_system_info` should be replaced with a call to a more
-            #  appropriate endpoint that has stronger connotations of what constitutes a Pebble
-            #  instance that is in fact 'ready'.
             self._pebble.get_system_info()
         except pebble.ConnectionError as e:
             logger.debug("Pebble API is not ready; ConnectionError: %s", e)
             return False
         except FileNotFoundError as e:
             # In some cases, charm authors can attempt to hit the Pebble API before it has had the
             # chance to create the UNIX socket in the shared volume.
@@ -1865,19 +1881,19 @@
         except pebble.APIError as e:
             # An API error is only raised when the Pebble API returns invalid JSON, or the response
             # cannot be read. Both of these are a likely indicator that something is wrong.
             logger.warning("Pebble API is not ready; APIError: %s", e)
             return False
         return True
 
-    def autostart(self):
-        """Autostart all services marked as startup: enabled."""
+    def autostart(self) -> None:
+        """Autostart all services marked as ``startup: enabled``."""
         self._pebble.autostart_services()
 
-    def replan(self):
+    def replan(self) -> None:
         """Replan all services: restart changed services and start startup-enabled services."""
         self._pebble.replan_services()
 
     def start(self, *service_names: str):
         """Start given service(s) by name."""
         if not service_names:
             raise TypeError('start expected at least 1 argument, got 0')
@@ -1904,15 +1920,16 @@
     def stop(self, *service_names: str):
         """Stop given service(s) by name."""
         if not service_names:
             raise TypeError('stop expected at least 1 argument, got 0')
 
         self._pebble.stop_services(service_names)
 
-    def add_layer(self, label: str, layer: '_Layer', *, combine: bool = False):
+    def add_layer(self, label: str, layer: Union[str, pebble.LayerDict, pebble.Layer], *,
+                  combine: bool = False):
         """Dynamically add a new layer onto the Pebble configuration layers.
 
         Args:
             label: Label for new layer (and label of layer to merge with if
                 combining).
             layer: A YAML string, configuration layer dict, or pebble.Layer
                 object containing the Pebble layer to add.
@@ -1920,94 +1937,94 @@
                 as the top layer with the given label (must be unique). If
                 combine is True and the label already exists, the two layers
                 are combined into a single one considering the layer override
                 rules; if the layer doesn't exist, it is added as usual.
         """
         self._pebble.add_layer(label, layer, combine=combine)
 
-    def get_plan(self) -> 'Plan':
+    def get_plan(self) -> pebble.Plan:
         """Get the combined Pebble configuration.
 
         This will immediately reflect changes from any previous
         :meth:`add_layer` calls, regardless of whether :meth:`replan` or
         :meth:`restart` have been called.
         """
         return self._pebble.get_plan()
 
-    def get_services(self, *service_names: str) -> '_ServiceInfoMapping':
+    def get_services(self, *service_names: str) -> Mapping[str, 'pebble.ServiceInfo']:
         """Fetch and return a mapping of status information indexed by service name.
 
         If no service names are specified, return status information for all
         services, otherwise return information for only the given services.
         """
         names = service_names or None
         services = self._pebble.get_services(names)
         return ServiceInfoMapping(services)
 
-    def get_service(self, service_name: str) -> 'ServiceInfo':
+    def get_service(self, service_name: str) -> pebble.ServiceInfo:
         """Get status information for a single named service.
 
         Raises :class:`ModelError` if service_name is not found.
         """
         services = self.get_services(service_name)
         if not services:
             raise ModelError(f'service {service_name!r} not found')
         if len(services) > 1:
             raise RuntimeError(f'expected 1 service, got {len(services)}')
         return services[service_name]
 
     def get_checks(
             self,
             *check_names: str,
-            level: Optional['CheckLevel'] = None) -> 'CheckInfoMapping':
+            level: Optional[pebble.CheckLevel] = None) -> 'CheckInfoMapping':
         """Fetch and return a mapping of check information indexed by check name.
 
         Args:
             check_names: Optional check names to query for. If no check names
                 are specified, return checks with any name.
             level: Optional check level to query for. If not specified, fetch
-                checks with any level.
+                all checks.
         """
         checks = self._pebble.get_checks(names=check_names or None, level=level)
         return CheckInfoMapping(checks)
 
-    def get_check(self, check_name: str) -> 'CheckInfo':
+    def get_check(self, check_name: str) -> pebble.CheckInfo:
         """Get check information for a single named check.
 
-        Raises :class:`ModelError` if check_name is not found.
+        Raises :class:`ModelError` if ``check_name`` is not found.
         """
         checks = self.get_checks(check_name)
         if not checks:
             raise ModelError(f'check {check_name!r} not found')
         if len(checks) > 1:
             raise RuntimeError(f'expected 1 check, got {len(checks)}')
         return checks[check_name]
 
-    def pull(self, path: StrOrPath, *,
+    def pull(self, path: Union[str, PurePath], *,
              encoding: Optional[str] = 'utf-8') -> Union[BinaryIO, TextIO]:
         """Read a file's content from the remote system.
 
         Args:
             path: Path of the file to read from the remote system.
-            encoding: Encoding to use for decoding the file's bytes to str,
-                or None to specify no decoding.
+            encoding: Encoding to use for decoding the file's bytes to string,
+                or ``None`` to specify no decoding.
 
         Returns:
-            A readable file-like object, whose read() method will return str
-            objects decoded according to the specified encoding, or bytes if
-            encoding is None.
+            A readable file-like object, whose ``read()`` method will return
+            strings decoded according to the specified encoding, or bytes if
+            encoding is ``None``.
 
         Raises:
             pebble.PathError: If there was an error reading the file at path,
                 for example, if the file doesn't exist or is a directory.
         """
         return self._pebble.pull(str(path), encoding=encoding)
 
     def push(self,
-             path: StrOrPath,
+             path: Union[str, PurePath],
              source: Union[bytes, str, BinaryIO, TextIO],
              *,
              encoding: str = 'utf-8',
              make_dirs: bool = False,
              permissions: Optional[int] = None,
              user_id: Optional[int] = None,
              user: Optional[str] = None,
@@ -2034,16 +2051,16 @@
         """
         self._pebble.push(str(path), source, encoding=encoding,
                           make_dirs=make_dirs,
                           permissions=permissions,
                           user_id=user_id, user=user,
                           group_id=group_id, group=group)
 
-    def list_files(self, path: StrOrPath, *, pattern: Optional[str] = None,
-                   itself: bool = False) -> List['FileInfo']:
+    def list_files(self, path: Union[str, PurePath], *, pattern: Optional[str] = None,
+                   itself: bool = False) -> List[pebble.FileInfo]:
         """Return list of directory entries from given path on remote system.
 
         Despite the name, this method returns a list of files *and*
         directories, similar to :func:`os.listdir` or :func:`os.scandir`.
 
         Args:
             path: Path of the directory to list, or path of the file to return
@@ -2053,28 +2070,28 @@
             itself: If path refers to a directory, return information about the
                 directory itself, rather than its contents.
         """
         return self._pebble.list_files(str(path),
                                        pattern=pattern, itself=itself)
 
     def push_path(self,
-                  source_path: Union[StrOrPath, Iterable[StrOrPath]],
-                  dest_dir: StrOrPath):
+                  source_path: Union[str, Path, Iterable[Union[str, Path]]],
+                  dest_dir: Union[str, PurePath]):
         """Recursively push a local path or files to the remote system.
 
         Only regular files and directories are copied; symbolic links, device files, etc. are
         skipped.  Pushing is attempted to completion even if errors occur during the process.  All
         errors are collected incrementally. After copying has completed, if any errors occurred, a
-        single MultiPushPullError is raised containing details for each error.
+        single :class:`MultiPushPullError` is raised containing details for each error.
 
         Assuming the following files exist locally:
 
-            * /foo/bar/baz.txt
-            * /foo/foobar.txt
-            * /quux.txt
+        * /foo/bar/baz.txt
+        * /foo/foobar.txt
+        * /quux.txt
 
         You could push the following ways::
 
             # copy one file
             container.push_path('/foo/foobar.txt', '/dst')
             # Destination results: /dst/foobar.txt
 
@@ -2091,32 +2108,34 @@
             # Destination results: /dst/baz.txt, /dst/quux.txt
 
             # copy a file and a directory
             container.push_path(['/foo/bar', '/quux.txt'], '/dst')
             # Destination results: /dst/bar/baz.txt, /dst/quux.txt
 
         Args:
-            source_path: A single path or list of paths to push to the remote system.  The
-                paths can be either a file or a directory.  If source_path is a directory, the
-                directory base name is attached to the destination directory - i.e. the source path
-                directory is placed inside the destination directory.  If a source path ends with a
-                trailing "/*" it will have its *contents* placed inside the destination directory.
-            dest_dir: Remote destination directory inside which the source dir/files will be
-                placed.  This must be an absolute path.
+            source_path: A single path or list of paths to push to the remote
+                system. The paths can be either a file or a directory. If
+                ``source_path`` is a directory, the directory base name is
+                attached to the destination directory -- that is, the source
+                path directory is placed inside the destination directory. If
+                a source path ends with a trailing ``/*`` it will have its
+                *contents* placed inside the destination directory.
+            dest_dir: Remote destination directory inside which the source
+                dir/files will be placed. This must be an absolute path.
         """
         if hasattr(source_path, '__iter__') and not isinstance(source_path, str):
-            source_paths = typing.cast(Iterable[StrOrPath], source_path)
+            source_paths = typing.cast(Iterable[Union[str, Path]], source_path)
         else:
-            source_paths = typing.cast(Iterable[StrOrPath], [source_path])
+            source_paths = typing.cast(Iterable[Union[str, Path]], [source_path])
         source_paths = [Path(p) for p in source_paths]
         dest_dir = Path(dest_dir)
 
         def local_list(source_path: Path) -> List[pebble.FileInfo]:
             paths = source_path.iterdir() if source_path.is_dir() else [source_path]
-            files = [self._build_fileinfo(source_path / f) for f in paths]
+            files = [self._build_fileinfo(f) for f in paths]
             return files
 
         errors: List[Tuple[str, Exception]] = []
         for source_path in source_paths:
             try:
                 for info in Container._list_recursive(local_list, source_path):
                     dstpath = self._build_destpath(info.path, source_path, dest_dir)
@@ -2132,28 +2151,28 @@
                             group=info.group)
             except (OSError, pebble.Error) as err:
                 errors.append((str(source_path), err))
         if errors:
             raise MultiPushPullError('failed to push one or more files', errors)
 
     def pull_path(self,
-                  source_path: Union[StrOrPath, Iterable[StrOrPath]],
-                  dest_dir: StrOrPath):
+                  source_path: Union[str, PurePath, Iterable[Union[str, PurePath]]],
+                  dest_dir: Union[str, Path]):
         """Recursively pull a remote path or files to the local system.
 
         Only regular files and directories are copied; symbolic links, device files, etc. are
         skipped.  Pulling is attempted to completion even if errors occur during the process.  All
         errors are collected incrementally. After copying has completed, if any errors occurred, a
-        single MultiPushPullError is raised containing details for each error.
+        single :class:`MultiPushPullError` is raised containing details for each error.
 
         Assuming the following files exist remotely:
 
-            * /foo/bar/baz.txt
-            * /foo/foobar.txt
-            * /quux.txt
+        * /foo/bar/baz.txt
+        * /foo/foobar.txt
+        * /quux.txt
 
         You could pull the following ways::
 
             # copy one file
             container.pull_path('/foo/foobar.txt', '/dst')
             # Destination results: /dst/foobar.txt
 
@@ -2170,27 +2189,29 @@
             # Destination results: /dst/baz.txt, /dst/quux.txt
 
             # copy a file and a directory
             container.pull_path(['/foo/bar', '/quux.txt'], '/dst')
             # Destination results: /dst/bar/baz.txt, /dst/quux.txt
 
         Args:
-            source_path: A single path or list of paths to pull from the remote system.  The
-                paths can be either a file or a directory but must be absolute paths.  If
-                source_path is a directory, the directory base name is attached to the destination
-                directory - i.e.  the source path directory is placed inside the destination
-                directory.  If a source path ends with a trailing "/*" it will have its *contents*
-                placed inside the destination directory.
-            dest_dir: Local destination directory inside which the source dir/files will be
-                placed.
+            source_path: A single path or list of paths to pull from the
+                remote system. The paths can be either a file or a directory
+                but must be absolute paths. If ``source_path`` is a directory,
+                the directory base name is attached to the destination
+                directory -- that is, the source path directory is placed
+                inside the destination directory. If a source path ends with a
+                trailing ``/*`` it will have its *contents* placed inside the
+                destination directory.
+            dest_dir: Local destination directory inside which the source
+                dir/files will be placed.
         """
         if hasattr(source_path, '__iter__') and not isinstance(source_path, str):
-            source_paths = typing.cast(Iterable[StrOrPath], source_path)
+            source_paths = typing.cast(Iterable[Union[str, Path]], source_path)
         else:
-            source_paths = typing.cast(Iterable[StrOrPath], [source_path])
+            source_paths = typing.cast(Iterable[Union[str, Path]], [source_path])
         source_paths = [Path(p) for p in source_paths]
         dest_dir = Path(dest_dir)
 
         errors: List[Tuple[str, Exception]] = []
         for source_path in source_paths:
             try:
                 for info in Container._list_recursive(self.list_files, source_path):
@@ -2201,15 +2222,15 @@
                             shutil.copyfileobj(typing.cast(BinaryIO, src), dst)
             except (OSError, pebble.Error) as err:
                 errors.append((str(source_path), err))
         if errors:
             raise MultiPushPullError('failed to pull one or more files', errors)
 
     @staticmethod
-    def _build_fileinfo(path: StrOrPath) -> 'FileInfo':
+    def _build_fileinfo(path: Union[str, Path]) -> pebble.FileInfo:
         """Constructs a FileInfo object by stat'ing a local path."""
         path = Path(path)
         if path.is_symlink():
             ftype = pebble.FileType.SYMLINK
         elif path.is_dir():
             ftype = pebble.FileType.DIRECTORY
         elif path.is_file():
@@ -2229,17 +2250,16 @@
             last_modified=datetime.datetime.fromtimestamp(info.st_mtime),
             user_id=info.st_uid,
             user=pwd.getpwuid(info.st_uid).pw_name,
             group_id=info.st_gid,
             group=grp.getgrgid(info.st_gid).gr_name)
 
     @staticmethod
-    def _list_recursive(list_func: Callable[[Path],
-                        Iterable['FileInfo']],
-                        path: Path) -> Generator['FileInfo', None, None]:
+    def _list_recursive(list_func: Callable[[Path], Iterable[pebble.FileInfo]],
+                        path: Path) -> Generator[pebble.FileInfo, None, None]:
         """Recursively lists all files under path using the given list_func.
 
         Args:
             list_func: Function taking 1 Path argument that returns a list of FileInfo objects
                 representing files residing directly inside the given path.
             path: Filepath to recursively list.
         """
@@ -2254,86 +2274,137 @@
             elif info.type in (pebble.FileType.FILE, pebble.FileType.SYMLINK):
                 yield info
             else:
                 logger.debug(
                     'skipped unsupported file in Container.[push/pull]_path: %s', info.path)
 
     @staticmethod
-    def _build_destpath(file_path: StrOrPath, source_path: StrOrPath, dest_dir: StrOrPath) -> Path:
+    def _build_destpath(
+            file_path: Union[str, Path],
+            source_path: Union[str, Path],
+            dest_dir: Union[str, Path]) -> Path:
         """Converts a source file and destination dir into a full destination filepath.
 
         file_path:
             Full source-side path for the file being copied to dest_dir.
         source_path
             Source prefix under which the given file_path was found.
         dest_dir
             Destination directory to place file_path into.
         """
         # select between the two following src+dst combos via trailing '/*'
         # /src/* --> /dst/*
         # /src --> /dst/src
         file_path, source_path, dest_dir = Path(file_path), Path(source_path), Path(dest_dir)
         prefix = str(source_path.parent)
-        if os.path.commonprefix([prefix, str(file_path)]) != prefix:
+        if prefix != '.' and os.path.commonprefix([prefix, str(file_path)]) != prefix:
             raise RuntimeError(
                 f'file "{file_path}" does not have specified prefix "{prefix}"')
         path_suffix = os.path.relpath(str(file_path), prefix)
         return dest_dir / path_suffix
 
-    def exists(self, path: str) -> bool:
-        """Return true if the path exists on the container filesystem."""
+    def exists(self, path: Union[str, PurePath]) -> bool:
+        """Report whether a path exists on the container filesystem."""
         try:
-            self._pebble.list_files(path, itself=True)
+            self._pebble.list_files(str(path), itself=True)
         except pebble.APIError as err:
             if err.code == 404:
                 return False
             raise err
         return True
 
-    def isdir(self, path: str) -> bool:
-        """Return true if a directory exists at the given path on the container filesystem."""
+    def isdir(self, path: Union[str, PurePath]) -> bool:
+        """Report whether a directory exists at the given path on the container filesystem."""
         try:
-            files = self._pebble.list_files(path, itself=True)
+            files = self._pebble.list_files(str(path), itself=True)
         except pebble.APIError as err:
             if err.code == 404:
                 return False
             raise err
         return files[0].type == pebble.FileType.DIRECTORY
 
     def make_dir(
-            self, path: str, *, make_parents: bool = False, permissions: Optional[int] = None,
-            user_id: Optional[int] = None, user: Optional[str] = None,
-            group_id: Optional[int] = None, group: Optional[str] = None):
+            self,
+            path: Union[str, PurePath],
+            *,
+            make_parents: bool = False,
+            permissions: Optional[int] = None,
+            user_id: Optional[int] = None,
+            user: Optional[str] = None,
+            group_id: Optional[int] = None,
+            group: Optional[str] = None):
         """Create a directory on the remote system with the given attributes.
 
         Args:
             path: Path of the directory to create on the remote system.
             make_parents: If True, create parent directories if they don't exist.
             permissions: Permissions (mode) to create directory with (Pebble
                 default is 0o755).
             user_id: User ID (UID) for directory.
             user: Username for directory. User's UID must match user_id if
                 both are specified.
             group_id: Group ID (GID) for directory.
             group: Group name for directory. Group's GID must match group_id
                 if both are specified.
         """
-        self._pebble.make_dir(path, make_parents=make_parents,
+        self._pebble.make_dir(str(path), make_parents=make_parents,
                               permissions=permissions,
                               user_id=user_id, user=user,
                               group_id=group_id, group=group)
 
-    def remove_path(self, path: str, *, recursive: bool = False):
+    def remove_path(self, path: Union[str, PurePath], *, recursive: bool = False):
         """Remove a file or directory on the remote system.
 
         Args:
             path: Path of the file or directory to delete from the remote system.
             recursive: If True, recursively delete path and everything under it.
         """
-        self._pebble.remove_path(path, recursive=recursive)
+        self._pebble.remove_path(str(path), recursive=recursive)
+
+    # Exec I/O is str if encoding is provided (the default)
+    @typing.overload
+    def exec(  # noqa
+        self,
+        command: List[str],
+        *,
+        environment: Optional[Dict[str, str]] = None,
+        working_dir: Optional[str] = None,
+        timeout: Optional[float] = None,
+        user_id: Optional[int] = None,
+        user: Optional[str] = None,
+        group_id: Optional[int] = None,
+        group: Optional[str] = None,
+        stdin: Optional[Union[str, TextIO]] = None,
+        stdout: Optional[TextIO] = None,
+        stderr: Optional[TextIO] = None,
+        encoding: str = 'utf-8',
+        combine_stderr: bool = False
+    ) -> pebble.ExecProcess[str]:
+        ...
+
+    # Exec I/O is bytes if encoding is explicitly set to None
+    @typing.overload
+    def exec(  # noqa
+        self,
+        command: List[str],
+        *,
+        environment: Optional[Dict[str, str]] = None,
+        working_dir: Optional[str] = None,
+        timeout: Optional[float] = None,
+        user_id: Optional[int] = None,
+        user: Optional[str] = None,
+        group_id: Optional[int] = None,
+        group: Optional[str] = None,
+        stdin: Optional[Union[bytes, BinaryIO]] = None,
+        stdout: Optional[BinaryIO] = None,
+        stderr: Optional[BinaryIO] = None,
+        encoding: None = None,
+        combine_stderr: bool = False
+    ) -> pebble.ExecProcess[bytes]:
+        ...
 
     def exec(
         self,
         command: List[str],
         *,
         environment: Optional[Dict[str, str]] = None,
         working_dir: Optional[str] = None,
@@ -2341,55 +2412,61 @@
         user_id: Optional[int] = None,
         user: Optional[str] = None,
         group_id: Optional[int] = None,
         group: Optional[str] = None,
         stdin: Optional[Union[str, bytes, TextIO, BinaryIO]] = None,
         stdout: Optional[Union[TextIO, BinaryIO]] = None,
         stderr: Optional[Union[TextIO, BinaryIO]] = None,
-        encoding: str = 'utf-8',
+        encoding: Optional[str] = 'utf-8',
         combine_stderr: bool = False
-    ) -> 'ExecProcess':
+    ) -> pebble.ExecProcess[Any]:
         """Execute the given command on the remote system.
 
         See :meth:`ops.pebble.Client.exec` for documentation of the parameters
         and return value, as well as examples.
         """
         return self._pebble.exec(
             command,
             environment=environment,
             working_dir=working_dir,
             timeout=timeout,
             user_id=user_id,
             user=user,
             group_id=group_id,
             group=group,
-            stdin=stdin,
-            stdout=stdout,
-            stderr=stderr,
-            encoding=encoding,
+            stdin=stdin,  # type: ignore
+            stdout=stdout,  # type: ignore
+            stderr=stderr,  # type: ignore
+            encoding=encoding,  # type: ignore
             combine_stderr=combine_stderr,
         )
 
     def send_signal(self, sig: Union[int, str], *service_names: str):
         """Send the given signal to one or more services.
 
         Args:
-            sig: Name or number of signal to send, e.g., "SIGHUP", 1, or
-                signal.SIGHUP.
+            sig: Name or number of signal to send, for example ``"SIGHUP"``, ``1``, or
+                ``signal.SIGHUP``.
             service_names: Name(s) of the service(s) to send the signal to.
 
         Raises:
             pebble.APIError: If any of the services are not in the plan or are
                 not currently running.
         """
         if not service_names:
             raise TypeError('send_signal expected at least 1 service name, got 0')
 
         self._pebble.send_signal(sig, service_names)
 
+    # Define this last to avoid clashes with the imported "pebble" module
+    @property
+    def pebble(self) -> pebble.Client:
+        """The low-level :class:`ops.pebble.Client` instance for this container."""
+        return self._pebble
+
 
 class ContainerMapping(Mapping[str, Container]):
     """Map of container names to Container objects.
 
     This is done as a mapping object rather than a plain dictionary so that we
     can extend it later, and so it's not mutable.
     """
@@ -2406,22 +2483,22 @@
     def __len__(self):
         return len(self._containers)
 
     def __repr__(self):
         return repr(self._containers)
 
 
-class ServiceInfoMapping(Mapping[str, 'ServiceInfo']):
-    """Map of service names to :class:`ops.pebble.ServiceInfo` objects.
+class ServiceInfoMapping(Mapping[str, pebble.ServiceInfo]):
+    """Map of service names to :class:`pebble.ServiceInfo` objects.
 
     This is done as a mapping object rather than a plain dictionary so that we
     can extend it later, and so it's not mutable.
     """
 
-    def __init__(self, services: Iterable['ServiceInfo']):
+    def __init__(self, services: Iterable[pebble.ServiceInfo]):
         self._services = {s.name: s for s in services}
 
     def __getitem__(self, key: str):
         return self._services[key]
 
     def __iter__(self):
         return iter(self._services)
@@ -2429,22 +2506,22 @@
     def __len__(self):
         return len(self._services)
 
     def __repr__(self):
         return repr(self._services)
 
 
-class CheckInfoMapping(Mapping[str, 'CheckInfo']):
+class CheckInfoMapping(Mapping[str, pebble.CheckInfo]):
     """Map of check names to :class:`ops.pebble.CheckInfo` objects.
 
     This is done as a mapping object rather than a plain dictionary so that we
     can extend it later, and so it's not mutable.
     """
 
-    def __init__(self, checks: Iterable['CheckInfo']):
+    def __init__(self, checks: Iterable[pebble.CheckInfo]):
         self._checks = {c.name: c for c in checks}
 
     def __getitem__(self, key: str):
         return self._checks[key]
 
     def __iter__(self):
         return iter(self._checks)
@@ -2472,18 +2549,16 @@
         self.max_supported = max_supported
 
 
 class RelationDataError(ModelError):
     """Raised when a relation data read/write is invalid.
 
     This is raised if you're either trying to set a value to something that isn't a string,
-    or if you are trying to set a value in a bucket that you don't have access to. (eg,
-    another application/unit or setting your application data but you aren't the leader.)
-    Also raised when you attempt to read a databag you don't have access to
-    (i.e. a local app databag if you're not the leader).
+    or if you are trying to set a value in a bucket that you don't have access to. (For example,
+    another application/unit, or setting your application data without being the leader.)
     """
 
 
 class RelationDataTypeError(RelationDataError):
     """Raised by ``Relation.data[entity][key] = value`` if `key` or `value` are not strings."""
 
 
@@ -2492,29 +2567,29 @@
 
     This typically means that you don't have permission to write read/write the databag,
     but in some cases it is raised when attempting to read/write from a deceased remote entity.
     """
 
 
 class RelationNotFoundError(ModelError):
-    """Backend error when querying juju for a given relation and that relation doesn't exist."""
+    """Raised when querying Juju for a given relation and that relation doesn't exist."""
 
 
 class InvalidStatusError(ModelError):
     """Raised if trying to set an Application or Unit status to something invalid."""
 
 
 class SecretNotFoundError(ModelError):
     """Raised when the specified secret does not exist."""
 
 
 _ACTION_RESULT_KEY_REGEX = re.compile(r'^[a-z0-9](([a-z0-9-.]+)?[a-z0-9])?$')
 
 
-def _format_action_result_dict(input: Dict[str, 'JsonObject'],
+def _format_action_result_dict(input: Dict[str, Any],
                                parent_key: Optional[str] = None,
                                output: Optional[Dict[str, str]] = None
                                ) -> Dict[str, str]:
     """Turn a nested dictionary into a flattened dictionary, using '.' as a key seperator.
 
     This is used to allow nested dictionaries to be translated into the dotted format required by
     the Juju `action-set` hook tool in order to set nested data on an action.
@@ -2553,15 +2628,15 @@
             raise ValueError("key '{!r}' is invalid: must be similar to 'key', 'some-key2', or "
                              "'some.key'".format(key))
 
         if parent_key:
             key = f"{parent_key}.{key}"
 
         if isinstance(value, MutableMapping):
-            value = typing.cast(Dict[str, 'JsonObject'], value)
+            value = typing.cast(Dict[str, Any], value)
             output_ = _format_action_result_dict(value, key, output_)
         elif key in output_:
             raise ValueError("duplicate key detected in dictionary passed to 'action-set': {!r}"
                              .format(key))
         else:
             output_[key] = value  # type: ignore
 
@@ -2598,37 +2673,39 @@
 
         self._is_leader: Optional[bool] = None
         self._leader_check_time = None
         self._hook_is_running = ''
 
     def _run(self, *args: str, return_output: bool = False,
              use_json: bool = False, input_stream: Optional[str] = None
-             ) -> Union[str, 'JsonObject', None]:
-        kwargs = dict(stdout=PIPE, stderr=PIPE, check=True, encoding='utf-8')
+             ) -> Union[str, Any, None]:
+        kwargs = dict(stdout=subprocess.PIPE, stderr=subprocess.PIPE, check=True, encoding='utf-8')
         if input_stream:
             kwargs.update({"input": input_stream})
         which_cmd = shutil.which(args[0])
         if which_cmd is None:
             raise RuntimeError(f'command not found: {args[0]}')
         args = (which_cmd,) + args[1:]
         if use_json:
             args += ('--format=json',)
+        # TODO(benhoyt): all the "type: ignore"s below kinda suck, but I've
+        #                been fighting with Pyright for half an hour now...
         try:
-            result = run(args, **kwargs)
-        except CalledProcessError as e:
+            result = subprocess.run(args, **kwargs)  # type: ignore
+        except subprocess.CalledProcessError as e:
             raise ModelError(e.stderr)
         if return_output:
-            if result.stdout is None:
+            if result.stdout is None:  # type: ignore
                 return ''
             else:
-                text = typing.cast(str, result.stdout)
+                text: str = result.stdout  # type: ignore
                 if use_json:
-                    return json.loads(text)
+                    return json.loads(text)  # type: ignore
                 else:
-                    return text
+                    return text  # type: ignore
 
     @staticmethod
     def _is_relation_not_found(model_error: Exception) -> bool:
         return 'relation not found' in str(model_error)
 
     def _validate_relation_access(self, relation_name: str, relations: Sequence['Relation']):
         """Checks for relation usage inconsistent with the framework/backend state.
@@ -2749,16 +2826,16 @@
         # we can cast to bool now since if we're here it means we checked.
         return typing.cast(bool, self._is_leader)
 
     def resource_get(self, resource_name: str) -> str:
         out = self._run('resource-get', resource_name, return_output=True)
         return typing.cast(str, out).strip()
 
-    def pod_spec_set(self, spec: Mapping[str, 'JsonObject'],
-                     k8s_resources: Optional[Mapping[str, 'JsonObject']] = None):
+    def pod_spec_set(self, spec: Mapping[str, Any],
+                     k8s_resources: Optional[Mapping[str, Any]] = None):
         tmpdir = Path(tempfile.mkdtemp('-pod-spec-set'))
         try:
             spec_path = tmpdir / 'spec.yaml'
             with spec_path.open("wt", encoding="utf8") as f:
                 yaml.safe_dump(spec, stream=f)
             args = ['--file', str(spec_path)]
             if k8s_resources:
@@ -2844,19 +2921,19 @@
         return typing.cast(str, out)
 
     def storage_add(self, name: str, count: int = 1) -> None:
         if not isinstance(count, int) or isinstance(count, bool):
             raise TypeError(f'storage count must be integer, got: {count} ({type(count)})')
         self._run('storage-add', f'{name}={count}')
 
-    def action_get(self) -> Dict[str, str]:  # todo: what do we know about this dict?
+    def action_get(self) -> Dict[str, Any]:
         out = self._run('action-get', return_output=True, use_json=True)
-        return typing.cast(Dict[str, str], out)
+        return typing.cast(Dict[str, Any], out)
 
-    def action_set(self, results: '_SerializedData') -> None:
+    def action_set(self, results: Dict[str, Any]) -> None:
         # The Juju action-set hook tool cannot interpret nested dicts, so we use a helper to
         # flatten out any nested dict structures into a dotted notation, and validate keys.
         flat_results = _format_action_result_dict(results)
         self._run('action-set', *[f"{k}={v}" for k, v in flat_results.items()])
 
     def action_log(self, message: str) -> None:
         self._run('action-log', message)
@@ -2901,15 +2978,15 @@
             network = self._run(*cmd, return_output=True, use_json=True)
             return typing.cast('_NetworkDict', network)
         except ModelError as e:
             if self._is_relation_not_found(e):
                 raise RelationNotFoundError() from e
             raise
 
-    def add_metrics(self, metrics: Mapping[str, 'Numerical'],
+    def add_metrics(self, metrics: Mapping[str, Union[int, float]],
                     labels: Optional[Mapping[str, str]] = None) -> None:
         cmd: List[str] = ['add-metric']
         if labels:
             label_args: List[str] = []
             for k, v in labels.items():
                 _ModelBackendValidator.validate_metric_label(k)
                 _ModelBackendValidator.validate_label_value(k, v)
@@ -2920,15 +2997,15 @@
         for k, v in metrics.items():
             _ModelBackendValidator.validate_metric_key(k)
             metric_value = _ModelBackendValidator.format_metric_value(v)
             metric_args.append(f'{k}={metric_value}')
         cmd.extend(metric_args)
         self._run(*cmd)
 
-    def get_pebble(self, socket_path: str) -> 'Client':
+    def get_pebble(self, socket_path: str) -> pebble.Client:
         """Create a pebble.Client instance from given socket path."""
         return pebble.Client(socket_path=socket_path)
 
     def planned_units(self) -> int:
         """Count of "planned" units that will run this application.
 
         This will include the current unit, any units that are alive, units that are in the process
@@ -2943,15 +3020,15 @@
 
         # Planned units can be zero. We don't need to do error checking here.
         # But we need to filter out dying units as they may be reported before being deleted
         units = app_state.get('units', {})
         num_alive = sum(1 for unit in units.values() if unit['status'] != 'dying')
         return num_alive
 
-    def update_relation_data(self, relation_id: int, _entity: 'UnitOrApplication',
+    def update_relation_data(self, relation_id: int, _entity: Union['Unit', 'Application'],
                              key: str, value: str):
         self.relation_set(relation_id, key, value, isinstance(_entity, Application))
 
     def secret_get(self, *,
                    id: Optional[str] = None,
                    label: Optional[str] = None,
                    refresh: bool = False,
@@ -2973,15 +3050,15 @@
         except ModelError as e:
             if 'not found' in str(e):
                 raise SecretNotFoundError() from e
             raise
         return typing.cast(Dict[str, str], result)
 
     def _run_for_secret(self, *args: str, return_output: bool = False,
-                        use_json: bool = False) -> Union[str, 'JsonObject', None]:
+                        use_json: bool = False) -> Union[str, Any, None]:
         try:
             return self._run(*args, return_output=return_output, use_json=use_json)
         except ModelError as e:
             if 'not found' in str(e):
                 raise SecretNotFoundError() from e
             raise
 
@@ -2990,17 +3067,17 @@
                         label: Optional[str] = None) -> SecretInfo:
         args: List[str] = []
         if id is not None:
             args.append(id)
         elif label is not None:  # elif because Juju secret-info-get doesn't allow id and label
             args.extend(['--label', label])
         result = self._run_for_secret('secret-info-get', *args, return_output=True, use_json=True)
-        info_dicts = typing.cast(Dict[str, 'JsonObject'], result)
+        info_dicts = typing.cast(Dict[str, Any], result)
         id = list(info_dicts)[0]  # Juju returns dict of {secret_id: {info}}
-        return SecretInfo.from_dict(id, typing.cast('_SerializedData', info_dicts[id]))
+        return SecretInfo.from_dict(id, typing.cast(Dict[str, Any], info_dicts[id]))
 
     def secret_set(self, id: str, *,
                    content: Optional[Dict[str, str]] = None,
                    label: Optional[str] = None,
                    description: Optional[str] = None,
                    expire: Optional[datetime.datetime] = None,
                    rotate: Optional[SecretRotate] = None):
@@ -3115,16 +3192,16 @@
     def validate_metric_label(cls, label_name: str):
         if cls.METRIC_KEY_REGEX.match(label_name) is None:
             raise ModelError(
                 'invalid metric label name {!r}: must match {}'.format(
                     label_name, cls.METRIC_KEY_REGEX.pattern))
 
     @classmethod
-    def format_metric_value(cls, value: 'Numerical'):
-        if not isinstance(value, (int, float)):  # pyright: reportUnnecessaryIsInstance=false
+    def format_metric_value(cls, value: Union[int, float]):
+        if not isinstance(value, (int, float)):  # pyright: ignore[reportUnnecessaryIsInstance]
             raise ModelError('invalid metric value {!r} provided:'
                              ' must be a positive finite float'.format(value))
 
         if math.isnan(value) or math.isinf(value) or value < 0:
             raise ModelError('invalid metric value {!r} provided:'
                              ' must be a positive finite float'.format(value))
         return str(value)
```

### Comparing `ops-2.3.0/ops/pebble.py` & `ops-2.4.0/ops/pebble.py`

 * *Files 2% similar despite different names*

```diff
@@ -38,100 +38,132 @@
 import time
 import typing
 import urllib.error
 import urllib.parse
 import urllib.request
 import warnings
 from typing import (
+    IO,
     TYPE_CHECKING,
     Any,
+    AnyStr,
     BinaryIO,
     Callable,
     Dict,
     Generator,
+    Generic,
     Iterable,
     List,
     Optional,
     Sequence,
     TextIO,
     Tuple,
     Union,
 )
 
 import websocket  # type: ignore
 
 from ops._private import timeconv, yaml
 
+# Public as these are used in the Container.add_layer signature
+ServiceDict = typing.TypedDict('ServiceDict',
+                               {'summary': str,
+                                'description': str,
+                                'startup': str,
+                                'override': str,
+                                'command': str,
+                                'after': Sequence[str],
+                                'before': Sequence[str],
+                                'requires': Sequence[str],
+                                'environment': Dict[str, str],
+                                'user': str,
+                                'user-id': Optional[int],
+                                'group': str,
+                                'group-id': Optional[int],
+                                'on-success': str,
+                                'on-failure': str,
+                                'on-check-failure': Dict[str, Any],
+                                'backoff-delay': str,
+                                'backoff-factor': Optional[int],
+                                'backoff-limit': str,
+                                },
+                               total=False)
+
+HttpDict = typing.TypedDict('HttpDict', {'url': str})
+TcpDict = typing.TypedDict('TcpDict', {'port': int})
+ExecDict = typing.TypedDict('ExecDict', {'command': str})
+
+CheckDict = typing.TypedDict('CheckDict',
+                             {'override': str,
+                              'level': Union['CheckLevel', str],
+                              'period': Optional[str],
+                              'timeout': Optional[str],
+                              'http': Optional[HttpDict],
+                              'tcp': Optional[TcpDict],
+                              'exec': Optional[ExecDict],
+                              'threshold': Optional[int]},
+                             total=False)
+
+LayerDict = typing.TypedDict('LayerDict',
+                             {'summary': str,
+                              'description': str,
+                              'services': Dict[str, ServiceDict],
+                              'checks': Dict[str, CheckDict]},
+                             total=False)
+
+PlanDict = typing.TypedDict('PlanDict',
+                            {'services': Dict[str, ServiceDict],
+                             'checks': Dict[str, CheckDict]},
+                            total=False)
+
 if TYPE_CHECKING:
     from email.message import Message
 
     from typing_extensions import Literal, Protocol, TypedDict
 
     # callback types for _MultiParser header and body handlers
     class _BodyHandler(Protocol):
         def __call__(self, data: bytes, done: bool = False) -> None: ...  # noqa
 
     _HeaderHandler = Callable[[bytes], None]
-    _StrOrBytes = Union[str, bytes]
 
     # tempfile.NamedTemporaryFile has an odd interface because of that
     # 'name' attribute, so we need to make a Protocol for it.
     class _Tempfile(Protocol):
         name = ''
         def write(self, data: bytes): ...  # noqa
         def close(self): ...  # noqa
 
     class _FileLikeIO(Protocol[typing.AnyStr]):  # That also covers TextIO and BytesIO
         def read(self, __n: int = ...) -> typing.AnyStr: ...  # for BinaryIO  # noqa
         def write(self, __s: typing.AnyStr) -> int: ...  # noqa
         def __enter__(self) -> typing.IO[typing.AnyStr]: ...  # noqa
 
-    class _Readable(Protocol):
-        def read(self, n: int = -1) -> _StrOrBytes: ...  # noqa
-
-    class _Writeable(Protocol):
-        # We'd need something like io.ReadableBuffer here,
-        # but we can't import that type
-        def write(self, buf: Union[bytes, str, bytearray]) -> int: ...  # noqa
-
     _AnyStrFileLikeIO = Union[_FileLikeIO[bytes], _FileLikeIO[str]]
     _TextOrBinaryIO = Union[TextIO, BinaryIO]
     _IOSource = Union[str, bytes, _AnyStrFileLikeIO]
 
     _SystemInfoDict = TypedDict('_SystemInfoDict', {'version': str})
-    _InfoDict = TypedDict('_InfoDict',
-                          {"name": str,
-                           "level": Optional[Union['CheckLevel', str]],
-                           "status": Union['CheckStatus', str],
-                           "failures": int,
-                           "threshold": int})
+    _CheckInfoDict = TypedDict('_CheckInfoDict',
+                               {"name": str,
+                                "level": Optional[Union['CheckLevel', str]],
+                                "status": Union['CheckStatus', str],
+                                "failures": int,
+                                "threshold": int})
     _FileInfoDict = TypedDict('_FileInfoDict',
                               {"path": str,
                                "name": str,
                                "size": Optional[int],
                                "permissions": str,
                                "last-modified": str,
                                "user-id": Optional[int],
                                "user": Optional[str],
                                "group-id": Optional[int],
                                "group": Optional[str],
                                "type": Union['FileType', str]})
-    _HttpDict = TypedDict('_HttpDict', {'url': str})
-    _TcpDict = TypedDict('_TcpDict', {'port': int})
-    _ExecDict = TypedDict('_ExecDict', {'command': str})
-    _CheckDict = TypedDict('_CheckDict',
-                           {'override': str,
-                            'level': Union['CheckLevel', str],
-                            'period': Optional[str],
-                            'timeout': Optional[str],
-                            'http': Optional[_HttpDict],
-                            'tcp': Optional[_TcpDict],
-                            'exec': Optional[_ExecDict],
-                            'threshold': Optional[int]},
-                           total=False)
 
     _AuthDict = TypedDict('_AuthDict',
                           {'permissions': Optional[str],
                            'user-id': Optional[int],
                            'user': Optional[str],
                            'group-id': Optional[int],
                            'group': Optional[str],
@@ -139,86 +171,58 @@
                            'make-dirs': Optional[bool],
                            'make-parents': Optional[bool],
                            }, total=False)
     _ServiceInfoDict = TypedDict('_ServiceInfoDict',
                                  {'startup': Union['ServiceStartup', str],
                                   'current': Union['ServiceStatus', str],
                                   'name': str})
-    _ServiceDict = TypedDict('_ServiceDict',
-                             {'summary': str,
-                              'description': str,
-                              'startup': str,
-                              'override': str,
-                              'command': str,
-                              'after': Sequence[str],
-                              'before': Sequence[str],
-                              'requires': Sequence[str],
-                              'environment': Dict[str, str],
-                              'user': str,
-                              'user-id': Optional[int],
-                              'group': str,
-                              'group-id': Optional[int],
-                              'on-success': str,
-                              'on-failure': str,
-                              'on-check-failure': Dict[str, Any],
-                              'backoff-delay': str,
-                              'backoff-factor': Optional[int],
-                              'backoff-limit': str,
-                              },
-                             total=False)
 
     _ProgressDict = TypedDict('_ProgressDict',
                               {'label': str,
                                'done': int,
                                'total': int})
-    _TaskData = Dict[str, Any]
     _TaskDict = TypedDict('_TaskDict',
                           {'id': 'TaskID',
                            'kind': str,
                            'summary': str,
                            'status': str,
                            'log': Optional[List[str]],
                            'progress': _ProgressDict,
                            'spawn-time': str,
                            'ready-time': str,
-                           'data': Optional[_TaskData]})
-    _ChangeData = TypedDict('_ChangeData', {})
+                           'data': Optional[Dict[str, Any]]})
     _ChangeDict = TypedDict('_ChangeDict',
                             {'id': str,
                              'kind': str,
                              'summary': str,
                              'status': str,
                              'ready': bool,
                              'spawn-time': str,
                              'tasks': Optional[List[_TaskDict]],
                              'err': Optional[str],
                              'ready-time': Optional[str],
-                             'data': Optional[_ChangeData]})
-
-    _PlanDict = TypedDict('_PlanDict',
-                          {'services': Dict[str, _ServiceDict],
-                           'checks': Dict[str, _CheckDict]},
-                          total=False)
-    # public as it is accessed by ops.testing
-    LayerDict = TypedDict('LayerDict',
-                          {'summary': str,
-                           'description': str,
-                           'services': Dict[str, _ServiceDict],
-                           'checks': Dict[str, _CheckDict]},
-                          total=False)
+                             'data': Optional[Dict[str, Any]]})
 
     _Error = TypedDict('_Error',
                        {'kind': str,
                         'message': str})
     _Item = TypedDict('_Item',
                       {'path': str,
                        'error': _Error})
     _FilesResponse = TypedDict('_FilesResponse',
                                {'result': List[_Item]})
 
+    _WarningDict = TypedDict('_WarningDict',
+                             {'message': str,
+                              'first-added': str,
+                              'last-added': str,
+                              'last-shown': Optional[str],
+                              'expire-after': str,
+                              'repeat-after': str})
+
     class _WebSocket(Protocol):
         def connect(self, url: str, socket: socket.socket): ...  # noqa
         def shutdown(self): ...                                  # noqa
         def send(self, payload: str): ...                        # noqa
         def send_binary(self, payload: bytes): ...               # noqa
         def recv(self) -> typing.AnyStr: ...                     # noqa
 
@@ -299,53 +303,70 @@
 
 
 class ProtocolError(Error):
     """Raised when there's a higher-level protocol error talking to Pebble."""
 
 
 class PathError(Error):
-    """Raised when there's an error with a specific path.
+    """Raised when there's an error with a specific path."""
 
-    Attributes:
-        kind: A short string representing the kind of error. Possible values
-            are "not-found", "permission-denied", and "generic-file-error".
-        message: A human-readable error message.
-    """
+    kind: typing.Literal["not-found", "permission-denied", "generic-file-error"]
+    """Short string representing the kind of error."""
+
+    message: str
+    """Human-readable error message from the API."""
 
     def __init__(self, kind: str, message: str):
         """This shouldn't be instantiated directly."""
-        self.kind = kind
+        self.kind = kind  # type: ignore
         self.message = message
 
     def __str__(self):
         return f'{self.kind} - {self.message}'
 
     def __repr__(self):
         return f'PathError({self.kind!r}, {self.message!r})'
 
 
 class APIError(Error):
     """Raised when an HTTP API error occurs talking to the Pebble server."""
 
+    body: Dict[str, Any]
+    """Body of the HTTP response, parsed as JSON."""
+
+    code: int
+    """HTTP status code."""
+
+    status: str
+    """HTTP status string (reason)."""
+
+    message: str
+    """Human-readable error message from the API."""
+
     def __init__(self, body: Dict[str, Any], code: int, status: str, message: str):
         """This shouldn't be instantiated directly."""
         super().__init__(message)  # Makes str(e) return message
         self.body = body
         self.code = code
         self.status = status
-        # FIXME: pyright rightfully complains that super().message is a method
-        self.message = message  # type: ignore
+        self.message = message
 
     def __repr__(self):
         return f'APIError({self.body!r}, {self.code!r}, {self.status!r}, {self.message!r})'
 
 
 class ChangeError(Error):
     """Raised by actions when a change is ready but has an error."""
 
+    err: str
+    """Human-readable error message."""
+
+    change: 'Change'
+    """Change object associated with this error."""
+
     def __init__(self, err: str, change: 'Change'):
         """This shouldn't be instantiated directly."""
         self.err = err
         self.change = change
 
     def __str__(self):
         parts = [self.err]
@@ -362,37 +383,49 @@
 
         return ''.join(parts)
 
     def __repr__(self):
         return f'ChangeError({self.err!r}, {self.change!r})'
 
 
-class ExecError(Error):
-    """Raised when a :meth:`Client.exec` command returns a non-zero exit code.
+class ExecError(Error, Generic[AnyStr]):
+    """Raised when a :meth:`Client.exec` command returns a non-zero exit code."""
 
-    Attributes:
-        command: Command line of command being executed.
-        exit_code: The process's exit code. This will always be non-zero.
-        stdout: If :meth:`ExecProcess.wait_output` was being called, this is
-            the captured stdout as a str (or bytes if encoding was None). If
-            :meth:`ExecProcess.wait` was being called, this is None.
-        stderr: If :meth:`ExecProcess.wait_output` was being called and
-            combine_stderr was False, this is the captured stderr as a str (or
-            bytes if encoding was None). If :meth:`ExecProcess.wait` was being
-            called or combine_stderr was True, this is None.
+    STR_MAX_OUTPUT = 1024
+    """Maximum number of characters that stdout/stderr are truncated to in ``__str__``."""
+
+    command: List[str]
+    """Command line of command being executed."""
+
+    exit_code: int
+    """The process's exit code. Because this is an error, this will always be non-zero."""
+
+    stdout: Optional[AnyStr]
+    """Standard output from the process.
+
+    If :meth:`ExecProcess.wait_output` was being called, this is the captured
+    stdout as a str (or bytes if encoding was None). If :meth:`ExecProcess.wait`
+    was being called, this is None.
     """
 
-    STR_MAX_OUTPUT = 1024
+    stderr: Optional[AnyStr]
+    """Standard error from the process.
+
+    If :meth:`ExecProcess.wait_output` was being called and ``combine_stderr``
+    was False, this is the captured stderr as a str (or bytes if encoding was
+    None). If :meth:`ExecProcess.wait` was being called or ``combine_stderr``
+    was True, this is None.
+    """
 
     def __init__(
         self,
         command: List[str],
         exit_code: int,
-        stdout: Optional['_StrOrBytes'],
-        stderr: Optional['_StrOrBytes'],
+        stdout: Optional[AnyStr],
+        stderr: Optional[AnyStr],
     ):
         self.command = command
         self.exit_code = exit_code
         self.stdout = stdout
         self.stderr = stderr
 
     def __str__(self):
@@ -436,22 +469,14 @@
 
     def __repr__(self):
         return f'SystemInfo(version={self.version!r})'
 
 
 class Warning:
     """Warning object."""
-    if typing.TYPE_CHECKING:
-        _WarningDict = TypedDict('_WarningDict',
-                                 {'message': str,
-                                  'first-added': str,
-                                  'last-added': str,
-                                  'last-shown': Optional[str],
-                                  'expire-after': str,
-                                  'repeat-after': str})
 
     def __init__(
         self,
         message: str,
         first_added: datetime.datetime,
         last_added: datetime.datetime,
         last_shown: Optional[datetime.datetime],
@@ -535,15 +560,15 @@
         kind: str,
         summary: str,
         status: str,
         log: List[str],
         progress: TaskProgress,
         spawn_time: datetime.datetime,
         ready_time: Optional[datetime.datetime],
-        data: Optional['_TaskData'] = None,
+        data: Optional[Dict[str, Any]] = None,
     ):
         self.id = id
         self.kind = kind
         self.summary = summary
         self.status = status
         self.log = log
         self.progress = progress
@@ -598,15 +623,15 @@
         summary: str,
         status: str,
         tasks: List[Task],
         ready: bool,
         err: Optional[str],
         spawn_time: datetime.datetime,
         ready_time: Optional[datetime.datetime],
-        data: Optional['_ChangeData'] = None,
+        data: Optional[Dict[str, Any]] = None,
     ):
         self.id = id
         self.kind = kind
         self.summary = summary
         self.status = status
         self.tasks = tasks
         self.ready = ready
@@ -652,15 +677,15 @@
 
     A plan is the combined layer configuration. The layer configuration is
     documented at https://github.com/canonical/pebble/#layer-specification.
     """
 
     def __init__(self, raw: str):
         d = yaml.safe_load(raw) or {}  # type: ignore
-        d = typing.cast('_PlanDict', d)
+        d = typing.cast('PlanDict', d)
 
         self._raw = raw
         self._services: Dict[str, Service] = {name: Service(name, service)
                                               for name, service in d.get('services', {}).items()}
         self._checks: Dict[str, Check] = {name: Check(name, check)
                                           for name, check in d.get('checks', {}).items()}
 
@@ -676,22 +701,22 @@
     def checks(self) -> Dict[str, 'Check']:
         """This plan's checks mapping (maps check name to :class:`Check`).
 
         This property is currently read-only.
         """
         return self._checks
 
-    def to_dict(self) -> '_PlanDict':
+    def to_dict(self) -> 'PlanDict':
         """Convert this plan to its dict representation."""
         fields = [
             ('services', {name: service.to_dict() for name, service in self._services.items()}),
             ('checks', {name: check.to_dict() for name, check in self._checks.items()}),
         ]
         dct = {name: value for name, value in fields if value}
-        return typing.cast('_PlanDict', dct)
+        return typing.cast('PlanDict', dct)
 
     def to_yaml(self) -> str:
         """Return this plan's YAML representation."""
         return yaml.safe_dump(self.to_dict())
 
     __str__ = to_yaml
 
@@ -755,17 +780,17 @@
 
     __str__ = to_yaml
 
 
 class Service:
     """Represents a service description in a Pebble configuration layer."""
 
-    def __init__(self, name: str, raw: Optional['_ServiceDict'] = None):
+    def __init__(self, name: str, raw: Optional['ServiceDict'] = None):
         self.name = name
-        dct: _ServiceDict = raw or {}
+        dct: ServiceDict = raw or {}
         self.summary = dct.get('summary', '')
         self.description = dct.get('description', '')
         self.startup = dct.get('startup', '')
         self.override = dct.get('override', '')
         self.command = dct.get('command', '')
         self.after = list(dct.get('after', []))
         self.before = list(dct.get('before', []))
@@ -778,15 +803,15 @@
         self.on_success = dct.get('on-success', '')
         self.on_failure = dct.get('on-failure', '')
         self.on_check_failure = dict(dct.get('on-check-failure', {}))
         self.backoff_delay = dct.get('backoff-delay', '')
         self.backoff_factor = dct.get('backoff-factor')
         self.backoff_limit = dct.get('backoff-limit', '')
 
-    def to_dict(self) -> '_ServiceDict':
+    def to_dict(self) -> 'ServiceDict':
         """Convert this service object to its dict representation."""
         fields = [
             ('summary', self.summary),
             ('description', self.description),
             ('startup', self.startup),
             ('override', self.override),
             ('command', self.command),
@@ -802,15 +827,15 @@
             ('on-failure', self.on_failure),
             ('on-check-failure', self.on_check_failure),
             ('backoff-delay', self.backoff_delay),
             ('backoff-factor', self.backoff_factor),
             ('backoff-limit', self.backoff_limit),
         ]
         dct = {name: value for name, value in fields if value}
-        return typing.cast('_ServiceDict', dct)
+        return typing.cast('ServiceDict', dct)
 
     def _merge(self, other: 'Service'):
         """Merges this service object with another service definition.
 
         For attributes present in both objects, the passed in service
         attributes take precedence.
         """
@@ -823,15 +848,15 @@
                 getattr(self, name).update(value)
             else:
                 setattr(self, name, value)
 
     def __repr__(self) -> str:
         return f'Service({self.to_dict()!r})'
 
-    def __eq__(self, other: Union['_ServiceDict', 'Service']) -> bool:
+    def __eq__(self, other: Union['ServiceDict', 'Service']) -> bool:
         """Reports whether this service configuration is equal to another."""
         if isinstance(other, dict):
             return self.to_dict() == other
         elif isinstance(other, Service):
             return self.to_dict() == other.to_dict()
         else:
             return NotImplemented
@@ -893,62 +918,62 @@
                 'current={self.current})'
                 ).format(self=self)
 
 
 class Check:
     """Represents a check in a Pebble configuration layer."""
 
-    def __init__(self, name: str, raw: Optional['_CheckDict'] = None):
+    def __init__(self, name: str, raw: Optional['CheckDict'] = None):
         self.name = name
-        dct: _CheckDict = raw or {}
+        dct: CheckDict = raw or {}
         self.override: str = dct.get('override', '')
         try:
             level: Union[CheckLevel, str] = CheckLevel(dct.get('level', ''))
         except ValueError:
             level = dct.get('level', '')
         self.level = level
         self.period: Optional[str] = dct.get('period', '')
         self.timeout: Optional[str] = dct.get('timeout', '')
         self.threshold: Optional[int] = dct.get('threshold')
 
         http = dct.get('http')
         if http is not None:
             http = copy.deepcopy(http)
-        self.http: Optional[_HttpDict] = http
+        self.http: Optional[HttpDict] = http
 
         tcp = dct.get('tcp')
         if tcp is not None:
             tcp = copy.deepcopy(tcp)
-        self.tcp: Optional[_TcpDict] = tcp
+        self.tcp: Optional[TcpDict] = tcp
 
         exec_ = dct.get('exec')
         if exec_ is not None:
             exec_ = copy.deepcopy(exec_)
-        self.exec: Optional[_ExecDict] = exec_
+        self.exec: Optional[ExecDict] = exec_
 
-    def to_dict(self) -> '_CheckDict':
+    def to_dict(self) -> 'CheckDict':
         """Convert this check object to its dict representation."""
         level: str = self.level.value if isinstance(self.level, CheckLevel) else self.level
         fields = [
             ('override', self.override),
             ('level', level),
             ('period', self.period),
             ('timeout', self.timeout),
             ('threshold', self.threshold),
             ('http', self.http),
             ('tcp', self.tcp),
             ('exec', self.exec),
         ]
         dct = {name: value for name, value in fields if value}
-        return typing.cast('_CheckDict', dct)
+        return typing.cast('CheckDict', dct)
 
     def __repr__(self) -> str:
         return f'Check({self.to_dict()!r})'
 
-    def __eq__(self, other: Union['_CheckDict', 'Check']) -> bool:
+    def __eq__(self, other: Union['CheckDict', 'Check']) -> bool:
         """Reports whether this check configuration is equal to another."""
         if isinstance(other, dict):
             return self.to_dict() == other
         elif isinstance(other, Check):
             return self.to_dict() == other.to_dict()
         else:
             return NotImplemented
@@ -980,14 +1005,44 @@
     DEVICE = 'device'
     UNKNOWN = 'unknown'
 
 
 class FileInfo:
     """Stat-like information about a single file or directory."""
 
+    path: str
+    """Full path of the file."""
+
+    name: str
+    """Base name of the file."""
+
+    type: Union['FileType', str]
+    """Type of the file ("file", "directory", "symlink", etc)."""
+
+    size: Optional[int]
+    """Size of the file (will be 0 if ``type`` is not "file")."""
+
+    permissions: int
+    """Unix permissions of the file."""
+
+    last_modified: datetime.datetime
+    """Time file was last modified."""
+
+    user_id: Optional[int]
+    """User ID of the file."""
+
+    user: Optional[str]
+    """Username of the file."""
+
+    group_id: Optional[int]
+    """Group ID of the file."""
+
+    group: Optional[str]
+    """Group name of the file."""
+
     def __init__(
         self,
         path: str,
         name: str,
         type: Union['FileType', str],
         size: Optional[int],
         permissions: int,
@@ -1043,27 +1098,43 @@
                 ).format(self=self)
 
 
 class CheckInfo:
     """Check status information.
 
     A list of these objects is returned from :meth:`Client.get_checks`.
+    """
+
+    name: str
+    """Name of the check."""
+
+    level: Optional[Union[CheckLevel, str]]
+    """Check level.
+
+    This can be :attr:`CheckLevel.ALIVE`, :attr:`CheckLevel.READY`, or None (level not set).
+    """
 
-    Attributes:
-        name: The name of the check.
-        level: The check level: :attr:`CheckLevel.ALIVE`,
-            :attr:`CheckLevel.READY`, or None (level not set).
-        status: The status of the check: :attr:`CheckStatus.UP` means the
-            check is healthy (the number of failures is less than the
-            threshold), :attr:`CheckStatus.DOWN` means the check is unhealthy
-            (the number of failures has reached the threshold).
-        failures: The number of failures since the check last succeeded (reset
-            to zero if the check succeeds).
-        threshold: The failure threshold, that is, how many consecutive
-            failures for the check to be considered "down".
+    status: Union[CheckStatus, str]
+    """Status of the check.
+
+    :attr:`CheckStatus.UP` means the check is healthy (the number of failures
+    is less than the threshold), :attr:`CheckStatus.DOWN` means the check is
+    unhealthy (the number of failures has reached the threshold).
+    """
+
+    failures: int
+    """Number of failures since the check last succeeded.
+
+    This is reset to zero if the check succeeds.
+    """
+
+    threshold: int
+    """Failure threshold.
+
+    This is how many consecutive failures for the check to be considered "down".
     """
 
     def __init__(
         self,
         name: str,
         level: Optional[Union[CheckLevel, str]],
         status: Union[CheckStatus, str],
@@ -1073,15 +1144,15 @@
         self.name = name
         self.level = level
         self.status = status
         self.failures = failures
         self.threshold = threshold
 
     @classmethod
-    def from_dict(cls, d: '_InfoDict') -> 'CheckInfo':
+    def from_dict(cls, d: '_CheckInfoDict') -> 'CheckInfo':
         """Create new :class:`CheckInfo` object from dict parsed from JSON."""
         try:
             level = CheckLevel(d.get('level', ''))
         except ValueError:
             level = d.get('level')
         try:
             status = CheckStatus(d['status'])
@@ -1101,46 +1172,56 @@
                 'level={self.level!r}, '
                 'status={self.status}, '
                 'failures={self.failures}, '
                 'threshold={self.threshold!r})'
                 ).format(self=self)
 
 
-class ExecProcess:
+class ExecProcess(Generic[AnyStr]):
     """Represents a process started by :meth:`Client.exec`.
 
     To avoid deadlocks, most users should use :meth:`wait_output` instead of
     reading and writing the :attr:`stdin`, :attr:`stdout`, and :attr:`stderr`
     attributes directly. Alternatively, users can pass stdin/stdout/stderr to
     :meth:`Client.exec`.
 
     This class should not be instantiated directly, only via
     :meth:`Client.exec`.
+    """
+
+    stdin: Optional[IO[AnyStr]]
+    """Standard input for the process.
+
+    If the stdin argument was not passed to :meth:`Client.exec`, this is a
+    writable file-like object the caller can use to stream input to the
+    process. It is None if stdin was passed to :meth:`Client.exec`.
+    """
+
+    stdout: Optional[IO[AnyStr]]
+    """Standard output from the process.
 
-    Attributes:
-        stdin: If the stdin argument was not passed to :meth:`Client.exec`,
-            this is a writable file-like object the caller can use to stream
-            input to the process. It is None if stdin was passed to
-            :meth:`Client.exec`.
-        stdout: If the stdout argument was not passed to :meth:`Client.exec`,
-            this is a readable file-like object the caller can use to stream
-            output from the process. It is None if stdout was passed to
-            :meth:`Client.exec`.
-        stderr: If the stderr argument was not passed to :meth:`Client.exec`
-            and combine_stderr was False, this is a readable file-like object
-            the caller can use to stream error output from the process. It is
-            None if stderr was passed to :meth:`Client.exec` or combine_stderr
-            was True.
+    If the stdout argument was not passed to :meth:`Client.exec`, this is a
+    readable file-like object the caller can use to stream output from the
+    process. It is None if stdout was passed to :meth:`Client.exec`.
+    """
+
+    stderr: Optional[IO[AnyStr]]
+    """Standard error from the process.
+
+    If the stderr argument was not passed to :meth:`Client.exec` and
+    ``combine_stderr`` was False, this is a readable file-like object the
+    caller can use to stream error output from the process. It is None if
+    stderr was passed to :meth:`Client.exec` or ``combine_stderr`` was True.
     """
 
     def __init__(
         self,
-        stdin: Optional['_Readable'],
-        stdout: Optional['_Writeable'],
-        stderr: Optional['_Writeable'],
+        stdin: Optional[IO[AnyStr]],
+        stdout: Optional[IO[AnyStr]],
+        stderr: Optional[IO[AnyStr]],
         client: 'Client',
         timeout: Optional[float],
         control_ws: '_WebSocket',
         stdio_ws: '_WebSocket',
         stderr_ws: Optional['_WebSocket'],
         command: List[str],
         encoding: Optional[str],
@@ -1215,15 +1296,15 @@
             raise ChangeError(change.err, change)
 
         exit_code = -1
         if change.tasks:
             exit_code = change.tasks[0].data.get('exit-code', -1)
         return exit_code
 
-    def wait_output(self) -> Tuple['_StrOrBytes', Optional['_StrOrBytes']]:
+    def wait_output(self) -> Tuple[AnyStr, Optional[AnyStr]]:
         """Wait for the process to finish and return tuple of (stdout, stderr).
 
         If a timeout was specified to the :meth:`Client.exec` call, this waits
         at most that duration. If combine_stderr was True, stdout will include
         the process's standard error, and stderr will be None.
 
         Raises:
@@ -1242,18 +1323,18 @@
 
         if self.stderr is not None:
             t = _start_thread(shutil.copyfileobj, self.stderr, err)
             self._threads.append(t)
 
         exit_code: int = self._wait()
 
-        out_value: '_StrOrBytes' = out.getvalue()
-        err_value: Optional['_StrOrBytes'] = err.getvalue() if err is not None else None
+        out_value = typing.cast(AnyStr, out.getvalue())
+        err_value = typing.cast(AnyStr, err.getvalue()) if err is not None else None
         if exit_code != 0:
-            raise ExecError(self._command, exit_code, out_value, err_value)
+            raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
 
         return (out_value, err_value)
 
     def send_signal(self, sig: Union[int, str]):
         """Send the given signal to the running process.
 
         Args:
@@ -1301,18 +1382,18 @@
             chunk = chunk.encode(encoding)
         ws.send_binary(chunk)
 
     ws.send('{"command":"end"}')  # type: ignore # Send "end" command as TEXT frame to signal EOF
 
 
 def _websocket_to_writer(ws: '_WebSocket', writer: '_WebsocketWriter',
-                         encoding: str):
+                         encoding: Optional[str]):
     """Receive messages from websocket (until end signal) and write to writer."""
     while True:
-        chunk: _StrOrBytes = ws.recv()
+        chunk: Union[str, bytes] = typing.cast(Union[str, bytes], ws.recv())
 
         if isinstance(chunk, str):
             try:
                 payload = json.loads(chunk)
             except ValueError:
                 # Garbage sent, try to keep going
                 logger.warning('Cannot decode I/O command (invalid JSON)')
@@ -1336,15 +1417,15 @@
     def __init__(self, ws: '_WebSocket'):
         self.ws = ws
 
     def writable(self):
         """Denote this file-like object as writable."""
         return True
 
-    def write(self, chunk: '_StrOrBytes') -> int:
+    def write(self, chunk: Union[str, bytes]) -> int:
         """Write chunk to the websocket."""
         if not isinstance(chunk, bytes):
             raise TypeError(f'value to write must be bytes, not {type(chunk).__name__}')
         self.ws.send_binary(chunk)
         return len(chunk)
 
     def close(self):
@@ -1360,22 +1441,22 @@
         self.remaining = b''
         self.eof = False
 
     def readable(self) -> bool:
         """Denote this file-like object as readable."""
         return True
 
-    def read(self, n: int = -1) -> '_StrOrBytes':
+    def read(self, n: int = -1) -> Union[str, bytes]:
         """Read up to n bytes from the websocket (or one message if n<0)."""
         if self.eof:
             # Calling read() multiple times after EOF should still return EOF
             return b''
 
         while not self.remaining:
-            chunk: _StrOrBytes = self.ws.recv()
+            chunk: Union[str, bytes] = typing.cast(Union[str, bytes], self.ws.recv())
 
             if isinstance(chunk, str):
                 try:
                     payload = json.loads(chunk)
                 except ValueError:
                     # Garbage sent, try to keep going
                     logger.warning('Cannot decode I/O command (invalid JSON)')
@@ -1389,37 +1470,36 @@
                 self.eof = True
                 return b''
 
             self.remaining = chunk
 
         if n < 0:
             n = len(self.remaining)
-        result: '_StrOrBytes' = self.remaining[:n]
+        result: Union[str, bytes] = self.remaining[:n]
         self.remaining = self.remaining[n:]
         return result
 
-    def read1(self, n: int = -1) -> '_StrOrBytes':
+    def read1(self, n: int = -1) -> Union[str, bytes]:
         """An alias for read."""
         return self.read(n)
 
 
 class Client:
-    """Pebble API client."""
+    """Pebble API client.
+
+    Defaults to using a Unix socket at socket_path (which must be specified
+    unless a custom opener is provided).
+    """
 
     _chunk_size = 8192
 
     def __init__(self, socket_path: str,
                  opener: Optional[urllib.request.OpenerDirector] = None,
                  base_url: str = 'http://localhost',
                  timeout: float = 5.0):
-        """Initialize a client instance.
-
-        Defaults to using a Unix socket at socket_path (which must be specified
-        unless a custom opener is provided).
-        """
         if not isinstance(socket_path, str):
             raise TypeError(f'`socket_path` should be a string, not: {type(socket_path)}')
         if opener is None:
             opener = self._get_default_opener(socket_path)
         self.socket_path = socket_path
         self.opener = opener
         self.base_url = base_url
@@ -1952,15 +2032,15 @@
                 b'--', boundary, b'\r\n',
                 b'Content-Type: application/octet-stream\r\n',
                 b'Content-Disposition: form-data; name="files"; filename="',
                 path_escaped, b'"\r\n',
                 b'\r\n',
             ])
 
-            content: '_StrOrBytes' = source_io.read(self._chunk_size)
+            content: Union[str, bytes] = source_io.read(self._chunk_size)
             while content:
                 if isinstance(content, str):
                     content = content.encode(encoding)
                 yield content
                 content = source_io.read(self._chunk_size)
 
             yield b''.join([
@@ -2033,46 +2113,93 @@
         """Remove a file or directory on the remote system.
 
         Args:
             path: Path of the file or directory to delete from the remote system.
             recursive: If True, and path is a directory recursively deletes it and
                        everything under it. If the path is a file, delete the file and
                        do nothing if the file is non-existent. Behaviourally similar
-                       to `rm -rf <file|dir>`
+                       to ``rm -rf <file|dir>``.
 
         """
         info: Dict[str, Any] = {'path': path}
         if recursive:
             info['recursive'] = True
         body = {
             'action': 'remove',
             'paths': [info],
         }
         resp = self._request('POST', '/v1/files', None, body)
         self._raise_on_path_error(typing.cast('_FilesResponse', resp), path)
 
+    # Exec I/O is str if encoding is provided (the default)
+    @typing.overload
+    def exec(  # noqa
+        self,
+        command: List[str],
+        *,
+        environment: Optional[Dict[str, str]] = None,
+        working_dir: Optional[str] = None,
+        timeout: Optional[float] = None,
+        user_id: Optional[int] = None,
+        user: Optional[str] = None,
+        group_id: Optional[int] = None,
+        group: Optional[str] = None,
+        stdin: Optional[Union[str, TextIO]] = None,
+        stdout: Optional[TextIO] = None,
+        stderr: Optional[TextIO] = None,
+        encoding: str = 'utf-8',
+        combine_stderr: bool = False
+    ) -> ExecProcess[str]:
+        ...
+
+    # Exec I/O is bytes if encoding is explicitly set to None
+    @typing.overload
+    def exec(  # noqa
+        self,
+        command: List[str],
+        *,
+        environment: Optional[Dict[str, str]] = None,
+        working_dir: Optional[str] = None,
+        timeout: Optional[float] = None,
+        user_id: Optional[int] = None,
+        user: Optional[str] = None,
+        group_id: Optional[int] = None,
+        group: Optional[str] = None,
+        stdin: Optional[Union[bytes, BinaryIO]] = None,
+        stdout: Optional[BinaryIO] = None,
+        stderr: Optional[BinaryIO] = None,
+        encoding: None = None,
+        combine_stderr: bool = False
+    ) -> ExecProcess[bytes]:
+        ...
+
     def exec(
         self,
         command: List[str],
         *,
         environment: Optional[Dict[str, str]] = None,
         working_dir: Optional[str] = None,
         timeout: Optional[float] = None,
         user_id: Optional[int] = None,
         user: Optional[str] = None,
         group_id: Optional[int] = None,
         group: Optional[str] = None,
-        stdin: Optional['_IOSource'] = None,
-        stdout: Optional['_TextOrBinaryIO'] = None,
-        stderr: Optional['_TextOrBinaryIO'] = None,
+        stdin: Optional[Union[str, bytes, TextIO, BinaryIO]] = None,
+        stdout: Optional[Union[TextIO, BinaryIO]] = None,
+        stderr: Optional[Union[TextIO, BinaryIO]] = None,
         encoding: Optional[str] = 'utf-8',
         combine_stderr: bool = False
-    ) -> ExecProcess:
+    ) -> ExecProcess[Any]:
         r"""Execute the given command on the remote system.
 
+        Two method signatures are shown because this method returns an
+        :class:`ExecProcess` that deals with strings if ``encoding`` is
+        specified (the default ), or one that deals with bytes if ``encoding``
+        is set to ``None``.
+
         Most of the parameters are explained in the "Parameters" section
         below, however, input/output handling is a bit more complex. Some
         examples are shown below::
 
             # Simple command with no output; just check exit code
             >>> process = client.exec(['send-emails'])
             >>> process.wait()
@@ -2268,18 +2395,18 @@
             else:
                 ws = typing.cast('_WebSocket', stderr_ws)
                 process_stderr = _WebsocketReader(ws)
                 if encoding is not None:
                     process_stderr = io.TextIOWrapper(
                         process_stderr, encoding=encoding, newline='')  # type: ignore
 
-        process = ExecProcess(
-            stdin=process_stdin,
-            stdout=process_stdout,  # type: ignore # doesn't like _Writeable
-            stderr=process_stderr,  # type: ignore # doesn't like _Writeable
+        process: ExecProcess[Any] = ExecProcess(
+            stdin=process_stdin,  # type: ignore
+            stdout=process_stdout,  # type: ignore
+            stderr=process_stderr,  # type: ignore
             client=self,
             timeout=timeout,
             stdio_ws=stdio_ws,
             stderr_ws=stderr_ws,
             control_ws=control_ws,
             command=command,
             encoding=encoding,
@@ -2303,27 +2430,27 @@
         url = f'{base_url}/v1/tasks/{task_id}/websocket/{websocket_id}'
         return url
 
     def send_signal(self, sig: Union[int, str], services: Iterable[str]):
         """Send the given signal to the list of services named.
 
         Args:
-            sig: Name or number of signal to send, e.g., "SIGHUP", 1, or
-                signal.SIGHUP.
+            sig: Name or number of signal to send, for example ``"SIGHUP"``, ``1``, or
+                ``signal.SIGHUP``.
             services: Non-empty list of service names to send the signal to.
 
         Raises:
             APIError: If any of the services are not in the plan or are not
                 currently running.
         """
         if isinstance(services, (str, bytes)) or not hasattr(services, '__iter__'):
             raise TypeError('services must be of type Iterable[str], '
                             'not {}'.format(type(services).__name__))
         for s in services:
-            if not isinstance(s, str):  # pyright: reportUnnecessaryIsInstance=false
+            if not isinstance(s, str):
                 raise TypeError(f'service names must be str, not {type(s).__name__}')
 
         if isinstance(sig, int):
             sig = signal.Signals(sig).name
         body = {
             'signal': sig,
             'services': services,
@@ -2337,15 +2464,15 @@
     ) -> List[CheckInfo]:
         """Get the check status for the configured checks.
 
         Args:
             level: Optional check level to query for (default is to fetch
                 checks with any level).
             names: Optional list of check names to query for (default is to
-                fetch checks with any name).
+                fetch all checks).
 
         Returns:
             List of :class:`CheckInfo` objects.
         """
         query = {}
         if level is not None:
             query['level'] = level.value
```

### Comparing `ops-2.3.0/ops/storage.py` & `ops-2.4.0/ops/storage.py`

 * *Files 2% similar despite different names*

```diff
@@ -20,15 +20,15 @@
 import sqlite3
 import subprocess
 import typing
 from datetime import timedelta
 from pathlib import Path
 from typing import Any, Callable, Generator, List, Optional, Tuple, Union
 
-import yaml  # pyright: reportMissingModuleSource=false
+import yaml  # pyright: ignore[reportMissingModuleSource]
 
 logger = logging.getLogger()
 
 
 if typing.TYPE_CHECKING:
     # _Notice = Tuple[event_path, observer_path, method_name]
     _Notice = Tuple[str, str, str]
@@ -82,19 +82,19 @@
                   sequence INTEGER PRIMARY KEY AUTOINCREMENT,
                   event_path TEXT,
                   observer_path TEXT,
                   method_name TEXT)
                 ''')
             self._db.commit()
 
-    def close(self):
+    def close(self) -> None:
         """Part of the Storage API, close the storage backend."""
         self._db.close()
 
-    def commit(self):
+    def commit(self) -> None:
         """Part of the Storage API, commit latest changes in the storage backend."""
         self._db.commit()
 
     # There's commit but no rollback. For abort to be supported, we'll need logic that
     # can rollback decisions made by third-party code in terms of the internal state
     # of objects that have been snapshotted, and hooks to let them know about it and
     # take the needed actions to undo their logic until the last snapshot.
@@ -199,21 +199,21 @@
     """
 
     NOTICE_KEY = "#notices#"
 
     def __init__(self, backend: Optional['_JujuStorageBackend'] = None):
         self._backend: _JujuStorageBackend = backend or _JujuStorageBackend()
 
-    def close(self):
+    def close(self) -> None:
         """Part of the Storage API, close the storage backend.
 
         Nothing to be done for Juju backend, as it's transactional.
         """
 
-    def commit(self):
+    def commit(self) -> None:
         """Part of the Storage API, commit latest changes in the storage backend.
 
         Nothing to be done for Juju backend, as it's transactional.
         """
 
     def save_snapshot(self, handle_path: str, snapshot_data: Any) -> None:
         """Part of the Storage API, persist a snapshot data under the given handle.
@@ -336,15 +336,15 @@
 def juju_backend_available() -> bool:
     """Check if Juju state storage is available."""
     p = shutil.which('state-get')
     return p is not None
 
 
 class _JujuStorageBackend:
-    """Implements the interface from the Operator framework to Juju's state-get/set/etc."""
+    """Implements the interface from the ops library to Juju's state-get/set/etc."""
 
     def set(self, key: str, value: Any) -> None:
         """Set a key to a given value.
 
         Args:
             key: The string key that will be used to find the value later
             value: Arbitrary content that will be returned by get().
```

### Comparing `ops-2.3.0/ops/testing.py` & `ops-2.4.0/ops/testing.py`

 * *Files 2% similar despite different names*

```diff
@@ -8,15 +8,15 @@
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
-"""Infrastructure to build unit tests for charms using the Operator Framework."""
+"""Infrastructure to build unit tests for charms using the ops library."""
 
 
 import dataclasses
 import datetime
 import fnmatch
 import inspect
 import ipaddress
@@ -56,38 +56,37 @@
 from ops._private import yaml
 from ops.charm import CharmBase, CharmMeta, RelationRole
 from ops.model import RelationNotFoundError
 
 if TYPE_CHECKING:
     from typing_extensions import TypedDict
 
-    from ops.model import UnitOrApplication, _NetworkDict
+    from ops.model import _NetworkDict
 
     ReadableBuffer = Union[bytes, str, StringIO, BytesIO, BinaryIO]
     _StringOrPath = Union[str, pathlib.PurePosixPath, pathlib.Path]
     _FileOrDir = Union['_File', '_Directory']
     _FileKwargs = TypedDict('_FileKwargs', {
-        'permissions': int,
+        'permissions': Optional[int],
         'last_modified': datetime.datetime,
         'user_id': Optional[int],
         'user': Optional[str],
         'group_id': Optional[int],
         'group': Optional[str],
     })
 
     _RelationEntities = TypedDict('_RelationEntities', {
         'app': str,
         'units': List[str]
     })
 
-    _ConfigValue = Union[str, int, float, bool]
     _ConfigOption = TypedDict('_ConfigOption', {
         'type': Literal['string', 'int', 'float', 'boolean'],
         'description': str,
-        'default': _ConfigValue
+        'default': Union[str, int, float, bool],
     })
     _StatusName = Literal['unknown', 'blocked', 'active', 'maintenance', 'waiting']
     _RawStatus = TypedDict('_RawStatus', {
         'status': _StatusName,
         'message': str,
     })
     RawConfig = TypedDict("RawConfig", {'options': Dict[str, _ConfigOption]})
@@ -113,34 +112,38 @@
     """This class represents a way to build up the model that will drive a test suite.
 
     The model that is created is from the viewpoint of the charm that you are testing.
 
     Example::
 
         harness = Harness(MyCharm)
+        self.addCleanup(harness.cleanup)  # always clean up after ourselves
+
         # Do initial setup here
         relation_id = harness.add_relation('db', 'postgresql')
+
         # Now instantiate the charm to see events as the model changes
         harness.begin()
         harness.add_relation_unit(relation_id, 'postgresql/0')
         harness.update_relation_data(relation_id, 'postgresql/0', {'key': 'val'})
+
         # Check that charm has properly handled the relation_joined event for postgresql/0
         self.assertEqual(harness.charm. ...)
 
     Args:
         charm_cls: The Charm class that you'll be testing.
         meta: A string or file-like object containing the contents of
-            metadata.yaml. If not supplied, we will look for a 'metadata.yaml' file in the
+            ``metadata.yaml``. If not supplied, we will look for a ``metadata.yaml`` file in the
             parent directory of the Charm, and if not found fall back to a trivial
-            'name: test-charm' metadata.
+            ``name: test-charm`` metadata.
         actions: A string or file-like object containing the contents of
-            actions.yaml. If not supplied, we will look for a 'actions.yaml' file in the
+            ``actions.yaml``. If not supplied, we will look for an ``actions.yaml`` file in the
             parent directory of the Charm.
         config: A string or file-like object containing the contents of
-            config.yaml. If not supplied, we will look for a 'config.yaml' file in the
+            ``config.yaml``. If not supplied, we will look for a ``config.yaml`` file in the
             parent directory of the Charm.
     """
 
     def __init__(
             self,
             charm_cls: Type[CharmType],
             *,
@@ -206,28 +209,28 @@
         >>>     event = MagicMock()
         >>>     event.relation = harness.charm.model.relations[0]
         >>>
         >>>     with harness._event_context('my_relation_joined'):
         >>>         harness.charm.event_handler(event)
 
         """
-        return self._framework._event_context(event_name)  # pyright: reportPrivateUsage=false
+        return self._framework._event_context(event_name)
 
     def set_can_connect(self, container: Union[str, model.Container], val: bool):
         """Change the simulated connection status of a container's underlying Pebble client.
 
-        After calling this, :meth:`ops.model.Container.can_connect` will return val.
+        After calling this, :meth:`ops.Container.can_connect` will return val.
         """
         if isinstance(container, str):
             container = self.model.unit.get_container(container)
         self._backend._set_can_connect(container._pebble, val)
 
     @property
     def charm(self) -> CharmType:
-        """Return the instance of the charm class that was passed to __init__.
+        """Return the instance of the charm class that was passed to ``__init__``.
 
         Note that the Charm is not instantiated until you have called
         :meth:`.begin()`. Until then, attempting to access this property will raise
         an exception.
         """
         if self._charm is None:
             raise RuntimeError('The charm instance is not available yet. '
@@ -265,24 +268,24 @@
 
         class TestCharm(self._charm_cls):  # type: ignore
             on = TestEvents()
 
         # Note: jam 2020-03-01 This is so that errors in testing say MyCharm has no attribute foo,
         # rather than TestCharm has no attribute foo.
         TestCharm.__name__ = self._charm_cls.__name__
-        self._charm = TestCharm(self._framework)
+        self._charm = TestCharm(self._framework)  # type: ignore
 
     def begin_with_initial_hooks(self) -> None:
         """Called when you want the Harness to fire the same hooks that Juju would fire at startup.
 
         This triggers install, relation-created, config-changed, start, pebble-ready (for any
         containers), and any relation-joined hooks based on what relations have been added before
         you called begin. Note that all of these are fired before returning control
         to the test suite, so if you want to introspect what happens at each step, you need to fire
-        them directly (e.g. Charm.on.install.emit()).
+        them directly (for example, ``Charm.on.install.emit()``).
 
         To use this with all the normal hooks, you should instantiate the harness, setup any
         relations that you want active when the charm starts, and then call this method. This
         method will automatically create and add peer relations that are specified in
         metadata.yaml.
 
         If the charm metadata specifies containers, this sets can_connect to True for all
@@ -299,15 +302,15 @@
             harness.add_relation_unit(relation_id, 'postgresql/0')
             harness.update_relation_data(relation_id, 'postgresql/0', {'key': 'val'})
             harness.set_leader(True)
             harness.update_config({'initial': 'config'})
             harness.begin_with_initial_hooks()
             # This will cause
             # install, db-relation-created('postgresql'), leader-elected, config-changed, start
-            # db-relation-joined('postrgesql/0'), db-relation-changed('postgresql/0')
+            # db-relation-joined('postgresql/0'), db-relation-changed('postgresql/0')
             # To be fired.
         """
         self.begin()
 
         charm = cast(CharmBase, self._charm)
         # Checking if disks have been added
         # storage-attached events happen before install
@@ -355,15 +358,15 @@
             self.container_pebble_ready(container_name)
 
         # If the initial hooks do not set a unit status, the Juju controller will switch
         # the unit status from "Maintenance" to "Unknown". See gh#726
         post_setup_sts = self._backend.status_get()
         if post_setup_sts.get("status") == "maintenance" and not post_setup_sts.get("message"):
             self._backend.status_set("unknown", "", is_app=False)
-        all_ids = list(self._backend._relation_names.items())  # pyright:ReportPrivateUsage=false
+        all_ids = list(self._backend._relation_names.items())
         random.shuffle(all_ids)
         for rel_id, rel_name in all_ids:
             rel_app_and_units = self._backend._relation_app_and_units[rel_id]
             app_name = rel_app_and_units["app"]
             # Note: Juju *does* fire relation events for a given relation in the sorted order of
             # the unit names. It also always fires relation-changed immediately after
             # relation-joined for the same unit.
@@ -376,18 +379,18 @@
                 remote_unit = self._model.get_unit(unit_name)
                 charm.on[rel_name].relation_joined.emit(
                     relation, remote_unit.app, remote_unit)
                 charm.on[rel_name].relation_changed.emit(
                     relation, remote_unit.app, remote_unit)
 
     def cleanup(self) -> None:
-        """Called by your test infrastructure to cleanup any temporary directories/files/etc.
+        """Called by your test infrastructure to clean up any temporary directories/files/etc.
 
-        Currently this only needs to be called if you test with resources. But it is reasonable
-        to always include a `testcase.addCleanup(harness.cleanup)` just in case.
+        You should always call ``self.addCleanup(harness.cleanup)`` after creating a
+        :class:`Harness`.
         """
         self._backend._cleanup()
 
     def _create_meta(self, charm_metadata: Optional[YAMLStringOrFile],
                      action_metadata: Optional[YAMLStringOrFile]) -> CharmMeta:
         """Create a CharmMeta object.
 
@@ -435,15 +438,15 @@
                 charm_config = '{}'
         elif isinstance(charm_config, str):
             charm_config = dedent(charm_config)
 
         assert isinstance(charm_config, str)  # type guard
         config = yaml.safe_load(charm_config)
 
-        if not isinstance(config, dict):  # pyright: reportUnnecessaryIsInstance=false
+        if not isinstance(config, dict):
             raise TypeError(config)
         return cast('RawConfig', config)
 
     def add_oci_resource(self, resource_name: str,
                          contents: Optional[Mapping[str, str]] = None) -> None:
         """Add oci resources to the backend.
 
@@ -467,15 +470,15 @@
 
         as_yaml = yaml.safe_dump(contents)
         self._backend._resources_map[resource_name] = ('contents.yaml', as_yaml)
 
     def add_resource(self, resource_name: str, content: AnyStr) -> None:
         """Add content for a resource to the backend.
 
-        This will register the content, so that a call to `Model.resources.fetch(resource_name)`
+        This will register the content, so that a call to ``model.resources.fetch(resource_name)``
         will return a path to a file containing that content.
 
         Args:
             resource_name: The name of the resource being added
             content: Either string or bytes content, which will be the content of the filename
                 returned by resource-get. If contents is a string, it will be encoded in utf-8
         """
@@ -571,37 +574,37 @@
             if attach:
                 self.attach_storage(s.full_id)
         return ids
 
     def detach_storage(self, storage_id: str) -> None:
         """Detach a storage device.
 
-        The intent of this function is to simulate a "juju detach-storage" call.
+        The intent of this function is to simulate a ``juju detach-storage`` call.
         It will trigger a storage-detaching hook if the storage unit in question exists
         and is presently marked as attached.
 
         Args:
             storage_id: The full storage ID of the storage unit being detached, including the
                 storage key, e.g. my-storage/0.
         """
         if self._charm is None:
             raise RuntimeError('cannot detach storage before Harness is initialised')
         storage_name, storage_index = storage_id.split('/', 1)
         storage_index = int(storage_index)
-        storage_attached = self._backend._storage_is_attached(  # pyright:ReportPrivateUsage=false
+        storage_attached = self._backend._storage_is_attached(
             storage_name, storage_index)
         if storage_attached and self._hooks_enabled:
             self.charm.on[storage_name].storage_detaching.emit(
                 model.Storage(storage_name, storage_index, self._backend))
-        self._backend._storage_detach(storage_id)  # pyright:ReportPrivateUsage=false
+        self._backend._storage_detach(storage_id)
 
     def attach_storage(self, storage_id: str) -> None:
         """Attach a storage device.
 
-        The intent of this function is to simulate a "juju attach-storage" call.
+        The intent of this function is to simulate a ``juju attach-storage`` call.
         It will trigger a storage-attached hook if the storage unit in question exists
         and is presently marked as detached.
 
         Args:
             storage_id: The full storage ID of the storage unit being attached, including the
                 storage key, e.g. my-storage/0.
         """
@@ -619,34 +622,34 @@
         storage_index = int(storage_index)
         self.charm.on[storage_name].storage_attached.emit(
             model.Storage(storage_name, storage_index, self._backend))
 
     def remove_storage(self, storage_id: str) -> None:
         """Detach a storage device.
 
-        The intent of this function is to simulate a "juju remove-storage" call.
+        The intent of this function is to simulate a ``juju remove-storage`` call.
         It will trigger a storage-detaching hook if the storage unit in question exists
         and is presently marked as attached.  Then it will remove the storage
         unit from the testing backend.
 
         Args:
             storage_id: The full storage ID of the storage unit being removed, including the
                 storage key, e.g. my-storage/0.
         """
         storage_name, storage_index = storage_id.split('/', 1)
         storage_index = int(storage_index)
         if storage_name not in self._meta.storages:
             raise RuntimeError(
                 f"the key '{storage_name}' is not specified as a storage key in metadata")
-        is_attached = self._backend._storage_is_attached(  # pyright:ReportPrivateUsage=false
+        is_attached = self._backend._storage_is_attached(
             storage_name, storage_index)
         if self._charm is not None and self._hooks_enabled and is_attached:
             self.charm.on[storage_name].storage_detaching.emit(
                 model.Storage(storage_name, storage_index, self._backend))
-        self._backend._storage_remove(storage_id)  # pyright:ReportPrivateUsage=false
+        self._backend._storage_remove(storage_id)
 
     def add_relation(self, relation_name: str, remote_app: str) -> int:
         """Declare that there is a new relation between this app and `remote_app`.
 
         In the case of adding peer relations, `remote_app` is *this* app.  This function creates a
         relation with an application and will trigger a relation-created hook. To relate units (and
         trigger relation-joined and relation-changed hooks), you should also call
@@ -656,61 +659,61 @@
             relation_name: The relation on Charm that is being related to
             remote_app: The name of the application that is being related to
 
         Return:
             The relation_id created by this add_relation.
         """
         relation_id = self._next_relation_id()
-        self._backend._relation_ids_map.setdefault(  # pyright:ReportPrivateUsage=false
+        self._backend._relation_ids_map.setdefault(
             relation_name, []).append(relation_id)
         self._backend._relation_names[relation_id] = relation_name
-        self._backend._relation_list_map[relation_id] = []  # pyright:ReportPrivateUsage=false
-        self._backend._relation_data_raw[relation_id] = {  # pyright:ReportPrivateUsage=false
+        self._backend._relation_list_map[relation_id] = []
+        self._backend._relation_data_raw[relation_id] = {
             remote_app: {},
             self._backend.unit_name: {},
             self._backend.app_name: {}}
 
-        self._backend._relation_app_and_units[relation_id] = {  # pyright:ReportPrivateUsage=false
+        self._backend._relation_app_and_units[relation_id] = {
             "app": remote_app,
             "units": [],
         }
         # Reload the relation_ids list
         if self._model is not None:
-            self._model.relations._invalidate(relation_name)  # pyright:ReportPrivateUsage=false
+            self._model.relations._invalidate(relation_name)
         self._emit_relation_created(relation_name, relation_id, remote_app)
         return relation_id
 
     def remove_relation(self, relation_id: int) -> None:
         """Remove a relation.
 
         Args:
             relation_id: The relation ID for the relation to be removed.
 
         Raises:
             RelationNotFoundError: if relation id is not valid
         """
-        rel_names = self._backend._relation_names   # pyright:ReportPrivateUsage=false
+        rel_names = self._backend._relation_names
         try:
             relation_name = rel_names[relation_id]
             remote_app = self._backend.relation_remote_app_name(relation_id)
         except KeyError as e:
             raise model.RelationNotFoundError from e
 
-        rel_list_map = self._backend._relation_list_map  # pyright:ReportPrivateUsage=false
+        rel_list_map = self._backend._relation_list_map
         for unit_name in rel_list_map[relation_id].copy():
             self.remove_relation_unit(relation_id, unit_name)
 
         self._emit_relation_broken(relation_name, relation_id, remote_app)
         if self._model is not None:
-            self._model.relations._invalidate(relation_name)  # pyright:ReportPrivateUsage=false
+            self._model.relations._invalidate(relation_name)
 
-        self._backend._relation_app_and_units.pop(relation_id)  # pyright:ReportPrivateUsage=false
-        self._backend._relation_data_raw.pop(relation_id)  # pyright:ReportPrivateUsage=false
+        self._backend._relation_app_and_units.pop(relation_id)
+        self._backend._relation_data_raw.pop(relation_id)
         rel_list_map.pop(relation_id)
-        ids_map = self._backend._relation_ids_map  # pyright:ReportPrivateUsage=false
+        ids_map = self._backend._relation_ids_map
         ids_map[relation_name].remove(relation_id)
         rel_names.pop(relation_id)
 
         # Remove secret grants that give access via this relation
         for secret in self._backend._secrets:
             secret.grants = {rid: names for rid, names in secret.grants.items()
                              if rid != relation_id}
@@ -745,15 +748,15 @@
         This will trigger a `relation_joined` event. This would naturally be
         followed by a `relation_changed` event, which you can trigger with
         :meth:`.update_relation_data`. This separation is artificial in the
         sense that Juju will always fire the two, but is intended to make
         testing relations and their data bags slightly more natural.
 
         Args:
-            relation_id: The integer relation identifier (as returned by add_relation).
+            relation_id: The integer relation identifier (as returned by :meth:`add_relation`).
             remote_unit_name: A string representing the remote unit that is being added.
 
         Return:
             None
         """
         self._backend._relation_list_map[relation_id].append(remote_unit_name)
         # we can write remote unit data iff we are not in a hook env
@@ -767,15 +770,15 @@
         self._backend._relation_data_raw[relation_id][remote_unit_name] = {}
         app = cast(model.Application, relation.app)  # should not be None since we're testing
         if not remote_unit_name.startswith(app.name):
             warnings.warn(
                 'Remote unit name invalid: the remote application of {} is called {!r}; '
                 'the remote unit name should be {}/<some-number>, not {!r}.'
                 ''.format(relation_name, app.name, app.name, remote_unit_name))
-        app_and_units = self._backend._relation_app_and_units  # pyright: ReportPrivateUsage=false
+        app_and_units = self._backend._relation_app_and_units
         app_and_units[relation_id]["units"].append(remote_unit_name)
         # Make sure that the Model reloads the relation_list for this relation_id, as well as
         # reloading the relation data for this unit.
         remote_unit = self._model.get_unit(remote_unit_name)
         unit_cache = relation.data.get(remote_unit, None)
         if unit_cache is not None:
             unit_cache._invalidate()
@@ -800,20 +803,16 @@
         by Juju. However, when using the test harness, a
         `relation_changed` event must be triggered using
         :meth:`.update_relation_data`. This deviation from normal Juju
         behaviour facilitates testing by making each step in the
         charm life cycle explicit.
 
         Args:
-            relation_id: The integer relation identifier (as returned by add_relation).
+            relation_id: The integer relation identifier (as returned by :meth:`add_relation`).
             remote_unit_name: A string representing the remote unit that is being removed.
-
-        Raises:
-            KeyError: if relation_id or remote_unit_name is not valid
-            ValueError: if remote_unit_name is not valid
         """
         relation_name = self._backend._relation_names[relation_id]
 
         # gather data to invalidate cache later
         remote_unit = self._model.get_unit(remote_unit_name)
         relation = self._model.get_relation(relation_name, relation_id)
 
@@ -859,116 +858,122 @@
 
         This ignores all of the safety checks of who can and can't see data in relations (eg,
         non-leaders can't read their own application's relation data because there are no events
         that keep that data up-to-date for the unit).
 
         Args:
             relation_id: The relation whose content we want to look at.
-            app_or_unit: An Application or Unit instance, or its name, whose data we want to read
+            app_or_unit: An :class:`Application <ops.Application>` or
+                :class:`Unit <ops.Unit>` instance, or its name, whose data we
+                want to read.
+
         Return:
-            A dict containing the relation data for `app_or_unit` or None.
+            A dict containing the relation data for ``app_or_unit`` or None.
 
         Raises:
-            KeyError: if relation_id doesn't exist
+            KeyError: if ``relation_id`` doesn't exist
         """
         name = _get_app_or_unit_name(app_or_unit)
 
         # bypass access control by going directly to raw
         return self._backend._relation_data_raw[relation_id].get(name, None)
 
     def get_pod_spec(self) -> Tuple[Mapping[Any, Any], Mapping[Any, Any]]:
         """Return the content of the pod spec as last set by the charm.
 
         This returns both the pod spec and any k8s_resources that were supplied.
-        See the signature of Model.pod.set_spec
+        See the signature of :meth:`Pod.set_spec <ops.Pod.set_spec>`.
         """
         return self._backend._pod_spec
 
     def get_container_pebble_plan(
             self, container_name: str
     ) -> pebble.Plan:
-        """Return the current Plan that pebble is executing for the given container.
+        """Return the current plan that Pebble is executing for the given container.
 
         Args:
             container_name: The simple name of the associated container
+
         Return:
-            The pebble.Plan for this container. You can use :meth:`ops.pebble.Plan.to_yaml` to get
-            a string form for the content. Will raise KeyError if no pebble client exists
-            for that container name. (should only happen if container is not present in
-            metadata.yaml)
+            The Pebble plan for this container. You can use
+            :meth:`Plan.to_yaml <ops.pebble.Plan.to_yaml>` to get a string
+            form for the content. Will raise ``KeyError`` if no Pebble client
+            exists for that container name (should only happen if container is
+            not present in ``metadata.yaml``).
         """
         client = self._backend._pebble_clients.get(container_name)
         if client is None:
             raise KeyError(f'no known pebble client for container "{container_name}"')
         return client.get_plan()
 
     def container_pebble_ready(self, container_name: str):
         """Fire the pebble_ready hook for the associated container.
 
-        This will switch the given container's can_connect state to True
+        This will switch the given container's ``can_connect`` state to True
         before the hook function is called.
 
-        It will do nothing if begin() has not been called.
+        It will do nothing if :meth:`begin()` has not been called.
         """
         if self._charm is None:
             return
         container = self.model.unit.get_container(container_name)
         self.set_can_connect(container, True)
         self.charm.on[container_name].pebble_ready.emit(container)
 
     def get_workload_version(self) -> str:
         """Read the workload version that was set by the unit."""
         return self._backend._workload_version
 
     def set_model_info(self, name: Optional[str] = None, uuid: Optional[str] = None) -> None:
-        """Set the name and uuid of the Model that this is representing.
+        """Set the name and UUID of the model that this is representing.
 
-        This cannot be called once begin() has been called. But it lets you set the value that
-        will be returned by Model.name and Model.uuid.
+        This cannot be called once :meth:`begin` has been called. But it lets
+        you set the value that will be returned by :attr:`Model.name <ops.Model.name>`
+        and :attr:`Model.uuid <ops.Model.uuid>`.
 
-        This is a convenience method to invoke both Harness.set_model_name
-        and Harness.set_model_uuid at once.
+        This is a convenience method to invoke both :meth:`set_model_name`
+        and :meth:`set_model_uuid` at once.
         """
         if name is not None:
             self.set_model_name(name)
         if uuid is not None:
             self.set_model_uuid(uuid)
 
     def set_model_name(self, name: str) -> None:
         """Set the name of the Model that this is representing.
 
-        This cannot be called once begin() has been called. But it lets you set the value that
-        will be returned by Model.name.
+        This cannot be called once :meth:`begin` has been called. But it lets
+        you set the value that will be returned by :attr:`Model.name <ops.Model.name>`.
         """
         if self._charm is not None:
             raise RuntimeError('cannot set the Model name after begin()')
         self._backend.model_name = name
 
     def set_model_uuid(self, uuid: str) -> None:
         """Set the uuid of the Model that this is representing.
 
-        This cannot be called once begin() has been called. But it lets you set the value that
-        will be returned by Model.uuid.
+        This cannot be called once :meth:`begin` has been called. But it lets
+        you set the value that will be returned by :attr:`Model.uuid <ops.Model.uuid>`.
         """
         if self._charm is not None:
             raise RuntimeError('cannot set the Model uuid after begin()')
         self._backend.model_uuid = uuid
 
     def update_relation_data(
             self,
             relation_id: int,
             app_or_unit: str,
             key_values: Mapping[str, str],
     ) -> None:
         """Update the relation data for a given unit or application in a given relation.
 
-        This also triggers the `relation_changed` event for this relation_id.
+        This also triggers the `relation_changed` event for the given ``relation_id``.
 
         Args:
-            relation_id: The integer relation_id representing this relation.
+            relation_id: The integer relation ID representing this relation.
             app_or_unit: The unit or application name that is being updated.
                 This can be the local or remote application.
             key_values: Each key/value will be updated in the relation data.
         """
         relation_name = self._backend._relation_names[relation_id]
         relation = self._model.get_relation(relation_name, relation_id)
         if '/' in app_or_unit:
@@ -1037,15 +1042,15 @@
             app_name = app_or_unit
             app = self.model.get_app(app_name)
             args = (relation, app)
         self._charm.on[rel_name].relation_changed.emit(*args)
 
     def _update_config(
             self,
-            key_values: Optional[Mapping[str, '_ConfigValue']] = None,
+            key_values: Optional[Mapping[str, Union[str, int, float, bool]]] = None,
             unset: Iterable[str] = (),
     ) -> None:
         """Update the config as seen by the charm.
 
         This will *not* trigger a `config_changed` event, and is intended for internal use.
 
         Note that the `key_values` mapping will only add or update configuration items.
@@ -1074,70 +1079,73 @@
             if default is not None:
                 config._config_set(key, default)
             else:
                 config.pop(key, None)
 
     def update_config(
             self,
-            key_values: Optional[Mapping[str, '_ConfigValue']] = None,
+            key_values: Optional[Mapping[str, Union[str, int, float, bool]]] = None,
             unset: Iterable[str] = (),
     ) -> None:
         """Update the config as seen by the charm.
 
         This will trigger a `config_changed` event.
 
-        Note that the `key_values` mapping will only add or update configuration items.
-        To remove existing ones, see the `unset` parameter.
+        Note that the ``key_values`` mapping will only add or update configuration items.
+        To remove existing ones, see the ``unset`` parameter.
 
         Args:
             key_values: A Mapping of key:value pairs to update in config.
-            unset: An iterable of keys to remove from Config.
+            unset: An iterable of keys to remove from config.
                 This sets the value to the default if defined,
                 otherwise removes the key altogether.
         """
         self._update_config(key_values, unset)
         if self._charm is None or not self._hooks_enabled:
             return
         self._charm.on.config_changed.emit()
 
     def set_leader(self, is_leader: bool = True) -> None:
         """Set whether this unit is the leader or not.
 
-        If this charm becomes a leader then `leader_elected` will be triggered.  If Harness.begin()
-        has already been called, then the charm's peer relation should usually be added  *prior* to
-        calling this method (i.e. with Harness.add_relation) to properly initialize and make
+        If this charm becomes a leader then `leader_elected` will be triggered.  If :meth:`begin`
+        has already been called, then the charm's peer relation should usually be added *prior* to
+        calling this method (with :meth:`add_relation`) to properly initialize and make
         available relation data that leader elected hooks may want to access.
 
         Args:
-            is_leader: True/False as to whether this unit is the leader.
+            is_leader: Whether this unit is the leader.
         """
         self._backend._is_leader = is_leader
 
         # Note: jam 2020-03-01 currently is_leader is cached at the ModelBackend level, not in
         # the Model objects, so this automatically gets noticed.
         if is_leader and self._charm is not None and self._hooks_enabled:
             self._charm.on.leader_elected.emit()
 
     def set_planned_units(self, num_units: int) -> None:
-        """Set the number of "planned" units that "Application.planned_units" should return.
+        """Set the number of "planned" units.
 
-        In real world circumstances, this number will be the number of units in the
-        application. E.g., this number will be the number of peers this unit has, plus one, as we
-        count our own unit in the total.
-
-        A change to the return from planned_units will not generate an event. Typically, a charm
-        author would check planned units during a config or install hook, or after receiving a peer
-        relation joined event.
+        This is the value that :meth:`Application.planned_units <ops.Application.planned_units>`
+        should return.
 
+        In real world circumstances, this number will be the number of units
+        in the application. That is, this number will be the number of peers
+        this unit has, plus one, as we count our own unit in the total.
+
+        A change to the return from ``planned_units`` will not generate an
+        event. Typically, a charm author would check planned units during a
+        config or install hook, or after receiving a peer relation joined
+        event.
         """
         if num_units < 0:
             raise TypeError("num_units must be 0 or a positive integer.")
         self._backend._planned_units = num_units
 
-    def reset_planned_units(self):
+    def reset_planned_units(self) -> None:
         """Reset the planned units override.
 
         This allows the harness to fall through to the built in methods that will try to
         guess at a value for planned units, based on the number of peer relations that
         have been setup in the testing harness.
 
         """
@@ -1243,16 +1251,16 @@
             self._backend._calls.clear()
         return calls
 
     def add_model_secret(self, owner: AppUnitOrName, content: Dict[str, str]) -> str:
         """Add a secret owned by the remote application or unit specified.
 
         This is named :code:`add_model_secret` instead of :code:`add_secret`
-        to avoid confusion with the :meth:`ops.model.Application.add_secret`
-        and :meth:`ops.model.Unit.add_secret` methods used by secret owner
+        to avoid confusion with the :meth:`ops.Application.add_secret`
+        and :meth:`ops.Unit.add_secret` methods used by secret owner
         charms.
 
         Args:
             owner: The name of the remote application (or specific remote
                 unit) that will own the secret.
             content: A key-value mapping containing the payload of the secret,
                 for example :code:`{"password": "foo123"}`.
@@ -1475,15 +1483,15 @@
             if source_method is not None and source_method.__doc__:
                 target_cls.__dict__[meth_name].__doc__ = source_method.__doc__
         return target_cls
     return decorator
 
 
 @_record_calls
-class _TestingConfig(Dict[str, '_ConfigValue']):
+class _TestingConfig(Dict[str, Union[str, int, float, bool]]):
     """Represents the Juju Config."""
     _supported_types = {
         'string': str,
         'boolean': bool,
         'int': int,
         'float': float
     }
@@ -1495,25 +1503,25 @@
 
         for key, value in self._defaults.items():
             if value is None:
                 continue
             self._config_set(key, value)
 
     @staticmethod
-    def _load_defaults(charm_config: 'RawConfig') -> Dict[str, '_ConfigValue']:
+    def _load_defaults(charm_config: 'RawConfig') -> Dict[str, Union[str, int, float, bool]]:
         """Load default values from config.yaml.
 
         Handle the case where a user doesn't supply explicit config snippets.
         """
         if not charm_config:
             return {}
         cfg: Dict[str, '_ConfigOption'] = charm_config.get('options', {})
         return {key: value.get('default', None) for key, value in cfg.items()}
 
-    def _config_set(self, key: str, value: '_ConfigValue'):
+    def _config_set(self, key: str, value: Union[str, int, float, bool]):
         # this is only called by the harness itself
         # we don't do real serialization/deserialization, but we do check that the value
         # has the expected type.
         option = self._spec.get('options', {}).get(key)
         if not option:
             raise RuntimeError('Unknown config option {}; '
                                'not declared in `config.yaml`.'
@@ -1572,15 +1580,15 @@
     expire_time: Optional[datetime.datetime]
     label: Optional[str] = None
     description: Optional[str] = None
     tracked: int = 1
     grants: Dict[int, Set[str]] = dataclasses.field(default_factory=dict)
 
 
-@_copy_docstrings(model._ModelBackend)  # pyright: reportPrivateUsage=false
+@_copy_docstrings(model._ModelBackend)
 @_record_calls
 class _TestingModelBackend:
     """This conforms to the interface for ModelBackend but provides canned data.
 
     DO NOT use this class directly, it is used by `Harness`_ to drive the model.
     `Harness`_ is responsible for maintaining the internal consistency of the values here,
     as the only public methods of this type are for implementing ModelBackend.
@@ -1713,15 +1721,15 @@
                 'remote-side relation data cannot be accessed during a relation-broken event')
         if is_app and '/' in member_name:
             member_name = member_name.split('/')[0]
         if relation_id not in self._relation_data_raw:
             raise model.RelationNotFoundError()
         return self._relation_data_raw[relation_id][member_name]
 
-    def update_relation_data(self, relation_id: int, _entity: 'UnitOrApplication',
+    def update_relation_data(self, relation_id: int, _entity: Union[model.Unit, model.Application],
                              key: str, value: str):
         # this is where the 'real' backend would call relation-set.
         raw_data = self._relation_data_raw[relation_id][_entity.name]
         if value == '':
             raw_data.pop(key, None)
         else:
             raw_data[key] = value
@@ -1836,15 +1844,15 @@
     def _storage_detach(self, storage_id: str):
         # NOTE: This is an extra function for _TestingModelBackend to simulate
         # detachment of a storage unit.  This is not present in ops.model._ModelBackend.
         name, index = storage_id.split('/', 1)
         index = int(index)
 
         for client in self._pebble_clients.values():
-            client._fs.remove_mount(name)  # pyright: ReportPrivateUsage=false
+            client._fs.remove_mount(name)
 
         if self._storage_is_attached(name, index):
             self._storage_attached[name].remove(index)
 
     def _storage_attach(self, storage_id: str):
         """Mark the named storage_id as attached and return True if it was previously detached."""
         # NOTE: This is an extra function for _TestingModelBackend to simulate
@@ -1853,15 +1861,15 @@
         name, index = storage_id.split('/', 1)
 
         for container, client in self._pebble_clients.items():
             for _, mount in self._meta.containers[container].mounts.items():
                 if mount.storage != name:
                     continue
                 for index, store in self._storage_list[mount.storage].items():
-                    fs = client._fs  # pyright: reportPrivateUsage=false
+                    fs = client._fs
                     fs.add_mount(mount.storage, mount.location, store['location'])
 
         index = int(index)
         if not self._storage_is_attached(name, index):
             self._storage_attached[name].add(index)
             return True
         return False
@@ -2199,15 +2207,15 @@
         self._layers: Dict[str, pebble.Layer] = {}
         # Has a service been started/stopped?
         self._service_status: Dict[str, pebble.ServiceStatus] = {}
         self._fs = _TestingFilesystem()
         self._backend = backend
 
     def _check_connection(self):
-        if not self._backend._can_connect(self):  # pyright: reportPrivateUsage=false
+        if not self._backend._can_connect(self):
             msg = ('Cannot connect to Pebble; did you forget to call '
                    'begin_with_initial_hooks() or set_can_connect()?')
             raise pebble.ConnectionError(msg)
 
     def get_system_info(self) -> pebble.SystemInfo:
         self._check_connection()
         return pebble.SystemInfo(version='1.0.0')
@@ -2473,15 +2481,15 @@
 
         return [
             pebble.FileInfo(
                 path=str(file.path),
                 name=file.name,
                 type=get_pebble_file_type(file),
                 size=file.size if isinstance(file, _File) else None,
-                permissions=file.kwargs.get('permissions'),
+                permissions=file.kwargs.get('permissions') or 0,
                 last_modified=file.last_modified,
                 user_id=file.kwargs.get('user_id'),
                 user=file.kwargs.get('user'),
                 group_id=file.kwargs.get('group_id'),
                 group=file.kwargs.get('group'),
             )
             for file in files
@@ -2824,15 +2832,15 @@
         for token in tokens:
             try:
                 current_dir = current_dir[token]
             except KeyError:
                 raise FileNotFoundError(str(current_dir.path / token))
             if isinstance(current_dir, _File):
                 raise NotADirectoryError(str(current_dir.path))
-            if not isinstance(current_dir, _Directory):
+            if not isinstance(current_dir, _Directory):  # type: ignore
                 # For now, ignoring other possible cases besides File and Directory (e.g. Symlink).
                 raise NotImplementedError()
         return list(current_dir)
 
     def open(
             self,
             path: '_StringOrPath',
```

### Comparing `ops-2.3.0/ops.egg-info/SOURCES.txt` & `ops-2.4.0/ops.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `ops-2.3.0/pyproject.toml` & `ops-2.4.0/pyproject.toml`

 * *Files 11% similar despite different names*

```diff
@@ -31,8 +31,11 @@
 include = ["ops/*.py", "ops/_private/*.py"]
 pythonVersion = "3.8" # check no python > 3.8 features are used
 pythonPlatform = "All"
 typeCheckingMode = "strict"
 reportIncompatibleMethodOverride = false
 reportImportCycles = false
 reportMissingModuleSource = false
+reportPrivateUsage = false
+reportUnnecessaryIsInstance = false
+reportUnnecessaryComparison = false
 stubPath = ""
```

### Comparing `ops-2.3.0/setup.py` & `ops-2.4.0/setup.py`

 * *Files 2% similar despite different names*

```diff
@@ -8,15 +8,15 @@
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
-"""Setup script for the Operator Framework."""
+"""Setup script for the ops library."""
 
 from importlib.util import module_from_spec, spec_from_file_location
 from pathlib import Path
 
 from setuptools import find_packages, setup
```

### Comparing `ops-2.3.0/test/test_charm.py` & `ops-2.4.0/test/test_charm.py`

 * *Files identical despite different names*

### Comparing `ops-2.3.0/test/test_framework.py` & `ops-2.4.0/test/test_framework.py`

 * *Files identical despite different names*

### Comparing `ops-2.3.0/test/test_helpers.py` & `ops-2.4.0/test/test_helpers.py`

 * *Files identical despite different names*

### Comparing `ops-2.3.0/test/test_infra.py` & `ops-2.4.0/test/test_infra.py`

 * *Files identical despite different names*

### Comparing `ops-2.3.0/test/test_jujuversion.py` & `ops-2.4.0/test/test_jujuversion.py`

 * *Files identical despite different names*

### Comparing `ops-2.3.0/test/test_lib.py` & `ops-2.4.0/test/test_lib.py`

 * *Files identical despite different names*

### Comparing `ops-2.3.0/test/test_log.py` & `ops-2.4.0/test/test_log.py`

 * *Files identical despite different names*

### Comparing `ops-2.3.0/test/test_main.py` & `ops-2.4.0/test/test_main.py`

 * *Files 1% similar despite different names*

```diff
@@ -37,15 +37,15 @@
 
 # This relies on the expected repository structure to find a path to
 # source of the charm under test.
 TEST_CHARM_DIR = Path(f"{__file__}/../charms/test_main").resolve()
 
 VERSION_LOGLINE = [
     'juju-log', '--log-level', 'DEBUG', '--',
-    f'Operator Framework {ops.__version__} up and running.',
+    f'ops {ops.__version__} up and running.',
 ]
 
 logger = logging.getLogger(__name__)
 
 
 class SymlinkTargetError(Exception):
     pass
```

### Comparing `ops-2.3.0/test/test_model.py` & `ops-2.4.0/test/test_model.py`

 * *Files 2% similar despite different names*

```diff
@@ -2862,5269 +2862,5390 @@
 0000b2d0: 7220 6670 6174 6820 696e 2063 6173 652e  r fpath in case.
 0000b2e0: 7761 6e74 3a0a 2020 2020 2020 2020 6173  want:.        as
 0000b2f0: 7365 7274 2063 2e65 7869 7374 7328 6670  sert c.exists(fp
 0000b300: 6174 6829 2c20 6627 7075 6c6c 5f70 6174  ath), f'pull_pat
 0000b310: 6820 6661 696c 6564 3a20 6669 6c65 207b  h failed: file {
 0000b320: 6670 6174 687d 206d 6973 7369 6e67 2061  fpath} missing a
 0000b330: 7420 6465 7374 696e 6174 696f 6e27 0a0a  t destination'..
-0000b340: 0a63 6c61 7373 2054 6573 7441 7070 6c69  .class TestAppli
-0000b350: 6361 7469 6f6e 2875 6e69 7474 6573 742e  cation(unittest.
-0000b360: 5465 7374 4361 7365 293a 0a0a 2020 2020  TestCase):..    
-0000b370: 6465 6620 7365 7455 7028 7365 6c66 293a  def setUp(self):
-0000b380: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
-0000b390: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
-0000b3a0: 696e 672e 4861 726e 6573 7328 6f70 732e  ing.Harness(ops.
-0000b3b0: 4368 6172 6d42 6173 652c 206d 6574 613d  CharmBase, meta=
-0000b3c0: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-0000b3d0: 6e61 6d65 3a20 6d79 6170 700a 2020 2020  name: myapp.    
-0000b3e0: 2020 2020 2020 2020 7072 6f76 6964 6573          provides
-0000b3f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000b400: 6462 303a 0a20 2020 2020 2020 2020 2020  db0:.           
-0000b410: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
-0000b420: 6462 300a 2020 2020 2020 2020 2020 2020  db0.            
-0000b430: 7265 7175 6972 6573 3a0a 2020 2020 2020  requires:.      
-0000b440: 2020 2020 2020 2020 6462 313a 0a20 2020          db1:.   
-0000b450: 2020 2020 2020 2020 2020 2020 2069 6e74               int
-0000b460: 6572 6661 6365 3a20 6462 310a 2020 2020  erface: db1.    
-0000b470: 2020 2020 2020 2020 7065 6572 733a 0a20          peers:. 
-0000b480: 2020 2020 2020 2020 2020 2020 2064 6232               db2
-0000b490: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000b4a0: 2020 696e 7465 7266 6163 653a 2064 6232    interface: db2
-0000b4b0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-0000b4c0: 6f75 7263 6573 3a0a 2020 2020 2020 2020  ources:.        
-0000b4d0: 2020 2020 2020 666f 6f3a 207b 7479 7065        foo: {type
-0000b4e0: 3a20 6669 6c65 2c20 6669 6c65 6e61 6d65  : file, filename
-0000b4f0: 3a20 666f 6f2e 7478 747d 0a20 2020 2020  : foo.txt}.     
-0000b500: 2020 2020 2020 2020 2062 6172 3a20 7b74           bar: {t
-0000b510: 7970 653a 2066 696c 652c 2066 696c 656e  ype: file, filen
-0000b520: 616d 653a 2062 6172 2e74 7874 7d0a 2020  ame: bar.txt}.  
-0000b530: 2020 2020 2020 2020 2020 636f 6e74 6169            contai
-0000b540: 6e65 7273 3a0a 2020 2020 2020 2020 2020  ners:.          
-0000b550: 2020 2020 6261 723a 0a20 2020 2020 2020      bar:.       
-0000b560: 2020 2020 2020 2020 206b 3a20 760a 2020           k: v.  
-0000b570: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-0000b580: 2020 2073 656c 662e 7065 6572 5f72 656c     self.peer_rel
-0000b590: 5f69 6420 3d20 7365 6c66 2e68 6172 6e65  _id = self.harne
-0000b5a0: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
-0000b5b0: 2764 6232 272c 2027 6462 3227 290a 2020  'db2', 'db2').  
-0000b5c0: 2020 2020 2020 7365 6c66 2e61 7070 203d        self.app =
-0000b5d0: 2073 656c 662e 6861 726e 6573 732e 6d6f   self.harness.mo
-0000b5e0: 6465 6c2e 6170 700a 2020 2020 2020 2020  del.app.        
-0000b5f0: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
-0000b600: 7365 6c66 2e68 6172 6e65 7373 2e63 6c65  self.harness.cle
-0000b610: 616e 7570 290a 0a20 2020 2023 2054 6573  anup)..    # Tes
-0000b620: 7473 2066 6978 2066 6f72 2068 7474 7073  ts fix for https
-0000b630: 3a2f 2f67 6974 6875 622e 636f 6d2f 6361  ://github.com/ca
-0000b640: 6e6f 6e69 6361 6c2f 6f70 6572 6174 6f72  nonical/operator
-0000b650: 2f69 7373 7565 732f 3639 342e 0a20 2020  /issues/694..   
-0000b660: 2064 6566 2074 6573 745f 6d6f 636b 6564   def test_mocked
-0000b670: 5f67 6574 5f73 6572 7669 6365 7328 7365  _get_services(se
-0000b680: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-0000b690: 662e 6861 726e 6573 732e 6265 6769 6e28  f.harness.begin(
-0000b6a0: 290a 2020 2020 2020 2020 7365 6c66 2e68  ).        self.h
-0000b6b0: 6172 6e65 7373 2e73 6574 5f63 616e 5f63  arness.set_can_c
-0000b6c0: 6f6e 6e65 6374 2827 6261 7227 2c20 5472  onnect('bar', Tr
-0000b6d0: 7565 290a 2020 2020 2020 2020 6320 3d20  ue).        c = 
-0000b6e0: 7365 6c66 2e68 6172 6e65 7373 2e63 6861  self.harness.cha
-0000b6f0: 726d 2e75 6e69 742e 6765 745f 636f 6e74  rm.unit.get_cont
-0000b700: 6169 6e65 7228 2762 6172 2729 0a20 2020  ainer('bar').   
-0000b710: 2020 2020 2063 2e61 6464 5f6c 6179 6572       c.add_layer
-0000b720: 2827 6c61 7965 7231 272c 207b 0a20 2020  ('layer1', {.   
-0000b730: 2020 2020 2020 2020 2027 7375 6d6d 6172           'summar
-0000b740: 7927 3a20 276c 6179 6572 272c 0a20 2020  y': 'layer',.   
-0000b750: 2020 2020 2020 2020 2027 7365 7276 6963           'servic
-0000b760: 6573 273a 207b 2262 617a 223a 207b 276f  es': {"baz": {'o
-0000b770: 7665 7272 6964 6527 3a20 2772 6570 6c61  verride': 'repla
-0000b780: 6365 272c 2027 7375 6d6d 6172 7927 3a20  ce', 'summary': 
-0000b790: 2765 6368 6f27 2c20 2763 6f6d 6d61 6e64  'echo', 'command
-0000b7a0: 273a 2027 6563 686f 2031 277d 7d2c 0a20  ': 'echo 1'}},. 
-0000b7b0: 2020 2020 2020 207d 290a 0a20 2020 2020         })..     
-0000b7c0: 2020 2073 203d 2063 2e67 6574 5f73 6572     s = c.get_ser
-0000b7d0: 7669 6365 2827 6261 7a27 2920 2023 2053  vice('baz')  # S
-0000b7e0: 6f20 6661 722c 2073 6f20 676f 6f64 0a20  o far, so good. 
-0000b7f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000b800: 7274 5472 7565 2873 290a 2020 2020 2020  rtTrue(s).      
-0000b810: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
-0000b820: 6528 2762 617a 2720 696e 2063 2e67 6574  e('baz' in c.get
-0000b830: 5f73 6572 7669 6365 7328 2929 0a0a 2020  _services())..  
-0000b840: 2020 6465 6620 7465 7374 5f70 6c61 6e6e    def test_plann
-0000b850: 6564 5f75 6e69 7473 2873 656c 6629 3a0a  ed_units(self):.
-0000b860: 2020 2020 2020 2020 7265 6c5f 6964 203d          rel_id =
-0000b870: 2073 656c 662e 7065 6572 5f72 656c 5f69   self.peer_rel_i
-0000b880: 640a 0a20 2020 2020 2020 2023 2054 6573  d..        # Tes
-0000b890: 7420 7468 6174 2077 6520 616c 7761 7973  t that we always
-0000b8a0: 2063 6f75 6e74 206f 7572 7365 6c66 2e0a   count ourself..
-0000b8b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000b8c0: 6572 7445 7175 616c 2873 656c 662e 6170  ertEqual(self.ap
-0000b8d0: 702e 706c 616e 6e65 645f 756e 6974 7328  p.planned_units(
-0000b8e0: 292c 2031 290a 0a20 2020 2020 2020 2023  ), 1)..        #
-0000b8f0: 2041 6464 2073 6f6d 6520 756e 6974 732c   Add some units,
-0000b900: 2061 6e64 2076 6572 6966 7920 636f 756e   and verify coun
-0000b910: 742e 0a20 2020 2020 2020 2073 656c 662e  t..        self.
-0000b920: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-0000b930: 7469 6f6e 5f75 6e69 7428 7265 6c5f 6964  tion_unit(rel_id
-0000b940: 2c20 276d 7961 7070 2f31 2729 0a20 2020  , 'myapp/1').   
-0000b950: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
-0000b960: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
-0000b970: 6e69 7428 7265 6c5f 6964 2c20 276d 7961  nit(rel_id, 'mya
-0000b980: 7070 2f32 2729 0a0a 2020 2020 2020 2020  pp/2')..        
-0000b990: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000b9a0: 2873 656c 662e 6170 702e 706c 616e 6e65  (self.app.planne
-0000b9b0: 645f 756e 6974 7328 292c 2033 290a 0a20  d_units(), 3).. 
-0000b9c0: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
-0000b9d0: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-0000b9e0: 5f75 6e69 7428 7265 6c5f 6964 2c20 276d  _unit(rel_id, 'm
-0000b9f0: 7961 7070 2f33 2729 0a20 2020 2020 2020  yapp/3').       
-0000ba00: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000ba10: 6c28 7365 6c66 2e61 7070 2e70 6c61 6e6e  l(self.app.plann
-0000ba20: 6564 5f75 6e69 7473 2829 2c20 3429 0a0a  ed_units(), 4)..
-0000ba30: 2020 2020 2020 2020 2320 416e 6420 7265          # And re
-0000ba40: 6d6f 7665 2061 2075 6e69 740a 2020 2020  move a unit.    
-0000ba50: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
-0000ba60: 2e72 656d 6f76 655f 7265 6c61 7469 6f6e  .remove_relation
-0000ba70: 5f75 6e69 7428 7265 6c5f 6964 2c20 276d  _unit(rel_id, 'm
-0000ba80: 7961 7070 2f32 2729 0a0a 2020 2020 2020  yapp/2')..      
-0000ba90: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000baa0: 616c 2873 656c 662e 6170 702e 706c 616e  al(self.app.plan
-0000bab0: 6e65 645f 756e 6974 7328 292c 2033 290a  ned_units(), 3).
-0000bac0: 0a20 2020 2064 6566 2074 6573 745f 706c  .    def test_pl
-0000bad0: 616e 6e65 645f 756e 6974 735f 7573 6572  anned_units_user
-0000bae0: 5f73 6574 2873 656c 6629 3a0a 0a20 2020  _set(self):..   
-0000baf0: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
-0000bb00: 732e 7365 745f 706c 616e 6e65 645f 756e  s.set_planned_un
-0000bb10: 6974 7328 3129 0a20 2020 2020 2020 2073  its(1).        s
-0000bb20: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000bb30: 7365 6c66 2e61 7070 2e70 6c61 6e6e 6564  self.app.planned
-0000bb40: 5f75 6e69 7473 2829 2c20 3129 0a0a 2020  _units(), 1)..  
-0000bb50: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-0000bb60: 7373 2e73 6574 5f70 6c61 6e6e 6564 5f75  ss.set_planned_u
-0000bb70: 6e69 7473 2832 290a 2020 2020 2020 2020  nits(2).        
-0000bb80: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000bb90: 2873 656c 662e 6170 702e 706c 616e 6e65  (self.app.planne
-0000bba0: 645f 756e 6974 7328 292c 2032 290a 0a20  d_units(), 2).. 
-0000bbb0: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
-0000bbc0: 6573 732e 7365 745f 706c 616e 6e65 645f  ess.set_planned_
-0000bbd0: 756e 6974 7328 3130 3029 0a20 2020 2020  units(100).     
-0000bbe0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000bbf0: 7561 6c28 7365 6c66 2e61 7070 2e70 6c61  ual(self.app.pla
-0000bc00: 6e6e 6564 5f75 6e69 7473 2829 2c20 3130  nned_units(), 10
-0000bc10: 3029 0a0a 2020 2020 6465 6620 7465 7374  0)..    def test
-0000bc20: 5f70 6c61 6e6e 6564 5f75 6e69 7473 5f67  _planned_units_g
-0000bc30: 6172 6261 6765 5f76 616c 7565 7328 7365  arbage_values(se
-0000bc40: 6c66 293a 0a20 2020 2020 2020 2023 2050  lf):.        # P
-0000bc50: 6c61 6e6e 6564 2075 6e69 7473 2073 686f  lanned units sho
-0000bc60: 756c 6420 6265 2061 2070 6f73 6974 6976  uld be a positiv
-0000bc70: 6520 696e 7465 6765 722c 206f 7220 7a65  e integer, or ze
-0000bc80: 726f 2e0a 2020 2020 2020 2020 7769 7468  ro..        with
-0000bc90: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0000bca0: 6573 2854 7970 6545 7272 6f72 293a 0a20  es(TypeError):. 
-0000bcb0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000bcc0: 6861 726e 6573 732e 7365 745f 706c 616e  harness.set_plan
-0000bcd0: 6e65 645f 756e 6974 7328 2d31 290a 2020  ned_units(-1).  
-0000bce0: 2020 2020 2020 2320 5665 7269 6679 2074        # Verify t
-0000bcf0: 6861 7420 7765 2064 6964 6e27 7420 7365  hat we didn't se
-0000bd00: 7420 6f75 7220 7661 6c75 6520 6265 666f  t our value befo
-0000bd10: 7265 2072 6169 7369 6e67 2074 6865 2065  re raising the e
-0000bd20: 7272 6f72 2e0a 2020 2020 2020 2020 7365  rror..        se
-0000bd30: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
-0000bd40: 6c66 2e68 6172 6e65 7373 2e5f 6261 636b  lf.harness._back
-0000bd50: 656e 642e 5f70 6c61 6e6e 6564 5f75 6e69  end._planned_uni
-0000bd60: 7473 2069 7320 4e6f 6e65 290a 2020 2020  ts is None).    
-0000bd70: 2020 2020 2320 5665 7269 6679 2074 6861      # Verify tha
-0000bd80: 7420 7765 2073 7469 6c6c 2067 6574 2074  t we still get t
-0000bd90: 6865 2064 6566 6175 6c74 2076 616c 7565  he default value
-0000bda0: 2062 6163 6b20 6672 6f6d 202e 706c 616e   back from .plan
-0000bdb0: 6e65 645f 756e 6974 732e 0a20 2020 2020  ned_units..     
-0000bdc0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000bdd0: 7561 6c28 7365 6c66 2e61 7070 2e70 6c61  ual(self.app.pla
-0000bde0: 6e6e 6564 5f75 6e69 7473 2829 2c20 3129  nned_units(), 1)
-0000bdf0: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
-0000be00: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-0000be10: 2854 7970 6545 7272 6f72 293a 0a20 2020  (TypeError):.   
-0000be20: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
-0000be30: 726e 6573 732e 7365 745f 706c 616e 6e65  rness.set_planne
-0000be40: 645f 756e 6974 7328 2266 6f6f 2229 0a0a  d_units("foo")..
-0000be50: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-0000be60: 662e 6173 7365 7274 5261 6973 6573 2854  f.assertRaises(T
-0000be70: 7970 6545 7272 6f72 293a 0a20 2020 2020  ypeError):.     
-0000be80: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
-0000be90: 6573 732e 7365 745f 706c 616e 6e65 645f  ess.set_planned_
-0000bea0: 756e 6974 7328 2d33 3432 3330 3030 3130  units(-342300010
-0000beb0: 3233 3132 3332 3130 3930 290a 0a20 2020  2312321090)..   
-0000bec0: 2064 6566 2074 6573 745f 706c 616e 6e65   def test_planne
-0000bed0: 645f 756e 6974 735f 6f76 6572 7269 6465  d_units_override
-0000bee0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000bef0: 2222 2256 6572 6966 7920 7468 6174 2077  """Verify that w
-0000bf00: 6520 6f76 6572 7269 6465 2074 6865 2063  e override the c
-0000bf10: 616c 6375 6c61 7465 6420 7661 6c75 6520  alculated value 
-0000bf20: 6f66 2070 6c61 6e6e 6564 5f75 6e69 7473  of planned_units
-0000bf30: 2077 6865 6e20 7765 2073 6574 2069 7420   when we set it 
-0000bf40: 6d61 6e75 616c 6c79 2e0a 0a20 2020 2020  manually...     
-0000bf50: 2020 2057 6865 6e20 6120 6368 6172 6d20     When a charm 
-0000bf60: 6175 7468 6f72 2077 7269 7465 7320 6120  author writes a 
-0000bf70: 7465 7374 2074 6861 7420 6578 706c 6963  test that explic
-0000bf80: 6974 6c79 2063 616c 6c73 2073 6574 5f70  itly calls set_p
-0000bf90: 6c61 6e6e 6564 5f75 6e69 7473 2c20 7765  lanned_units, we
-0000bfa0: 2061 7373 756d 6520 7468 6174 0a20 2020   assume that.   
-0000bfb0: 2020 2020 2074 6865 6972 2069 6e74 656e       their inten
-0000bfc0: 7420 6973 2074 6f20 6f76 6572 7269 6465  t is to override
-0000bfd0: 2074 6865 2063 616c 6375 6c61 7465 6420   the calculated 
-0000bfe0: 7265 7475 726e 2076 616c 7565 2e20 4f66  return value. Of
-0000bff0: 7465 6e2c 2074 6869 7320 7769 6c6c 2062  ten, this will b
-0000c000: 6520 6265 6361 7573 6520 7468 650a 2020  e because the.  
-0000c010: 2020 2020 2020 6368 6172 6d20 6175 7468        charm auth
-0000c020: 6f72 2069 7320 636f 6d70 6f73 696e 6720  or is composing 
-0000c030: 6120 6368 6172 6d20 7769 7468 6f75 7420  a charm without 
-0000c040: 7065 6572 2072 656c 6174 696f 6e73 2c20  peer relations, 
-0000c050: 616e 6420 7468 6520 6861 726e 6573 7327  and the harness'
-0000c060: 7320 636f 756e 7420 6f66 0a20 2020 2020  s count of.     
-0000c070: 2020 2070 6c61 6e6e 6564 2075 6e69 7473     planned units
-0000c080: 2c20 7768 6963 6820 6973 2062 6173 6564  , which is based
-0000c090: 206f 6e20 7468 6520 6e75 6d62 6572 206f   on the number o
-0000c0a0: 6620 7065 6572 2072 656c 6174 696f 6e73  f peer relations
-0000c0b0: 2c20 7769 6c6c 206e 6f74 2062 6520 6163  , will not be ac
-0000c0c0: 6375 7261 7465 2e0a 2020 2020 2020 2020  curate..        
-0000c0d0: 2222 220a 2020 2020 2020 2020 7065 6572  """.        peer
-0000c0e0: 5f69 6420 3d20 7365 6c66 2e70 6565 725f  _id = self.peer_
-0000c0f0: 7265 6c5f 6964 0a0a 2020 2020 2020 2020  rel_id..        
-0000c100: 7365 6c66 2e68 6172 6e65 7373 2e73 6574  self.harness.set
-0000c110: 5f70 6c61 6e6e 6564 5f75 6e69 7473 2831  _planned_units(1
-0000c120: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
-0000c130: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-0000c140: 7469 6f6e 5f75 6e69 7428 7065 6572 5f69  tion_unit(peer_i
-0000c150: 642c 2027 6d79 6170 702f 3127 290a 2020  d, 'myapp/1').  
-0000c160: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-0000c170: 7373 2e61 6464 5f72 656c 6174 696f 6e5f  ss.add_relation_
-0000c180: 756e 6974 2870 6565 725f 6964 2c20 276d  unit(peer_id, 'm
-0000c190: 7961 7070 2f32 2729 0a20 2020 2020 2020  yapp/2').       
-0000c1a0: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
-0000c1b0: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
-0000c1c0: 7065 6572 5f69 642c 2027 6d79 6170 702f  peer_id, 'myapp/
-0000c1d0: 3327 290a 0a20 2020 2020 2020 2073 656c  3')..        sel
-0000c1e0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000c1f0: 6c66 2e61 7070 2e70 6c61 6e6e 6564 5f75  lf.app.planned_u
-0000c200: 6e69 7473 2829 2c20 3130 290a 0a20 2020  nits(), 10)..   
-0000c210: 2020 2020 2023 2056 6572 6966 7920 7468       # Verify th
-0000c220: 6174 2077 6520 6361 6e20 636c 6561 7220  at we can clear 
-0000c230: 7468 6520 6f76 6572 7269 6465 2e0a 2020  the override..  
-0000c240: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-0000c250: 7373 2e72 6573 6574 5f70 6c61 6e6e 6564  ss.reset_planned
-0000c260: 5f75 6e69 7473 2829 0a20 2020 2020 2020  _units().       
-0000c270: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000c280: 6c28 7365 6c66 2e61 7070 2e70 6c61 6e6e  l(self.app.plann
-0000c290: 6564 5f75 6e69 7473 2829 2c20 3429 2020  ed_units(), 4)  
-0000c2a0: 2320 7365 6c66 202b 2033 2070 6565 7273  # self + 3 peers
-0000c2b0: 0a0a 0a63 6c61 7373 2054 6573 7443 6f6e  ...class TestCon
-0000c2c0: 7461 696e 6572 7328 756e 6974 7465 7374  tainers(unittest
-0000c2d0: 2e54 6573 7443 6173 6529 3a0a 2020 2020  .TestCase):.    
-0000c2e0: 6465 6620 7365 7455 7028 7365 6c66 293a  def setUp(self):
-0000c2f0: 0a20 2020 2020 2020 206d 6574 6120 3d20  .        meta = 
-0000c300: 6f70 732e 4368 6172 6d4d 6574 612e 6672  ops.CharmMeta.fr
-0000c310: 6f6d 5f79 616d 6c28 2222 220a 6e61 6d65  om_yaml(""".name
-0000c320: 3a20 6b38 732d 6368 6172 6d0a 636f 6e74  : k8s-charm.cont
-0000c330: 6169 6e65 7273 3a0a 2020 6331 3a0a 2020  ainers:.  c1:.  
-0000c340: 2020 6b3a 2076 0a20 2063 323a 0a20 2020    k: v.  c2:.   
-0000c350: 206b 3a20 760a 2222 2229 0a20 2020 2020   k: v.""").     
-0000c360: 2020 2062 6163 6b65 6e64 203d 205f 4d6f     backend = _Mo
-0000c370: 6465 6c42 6163 6b65 6e64 2827 6d79 6170  delBackend('myap
-0000c380: 702f 3027 290a 2020 2020 2020 2020 7365  p/0').        se
-0000c390: 6c66 2e6d 6f64 656c 203d 206f 7073 2e4d  lf.model = ops.M
-0000c3a0: 6f64 656c 286d 6574 612c 2062 6163 6b65  odel(meta, backe
-0000c3b0: 6e64 290a 0a20 2020 2064 6566 2074 6573  nd)..    def tes
-0000c3c0: 745f 756e 6974 5f63 6f6e 7461 696e 6572  t_unit_container
-0000c3d0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-0000c3e0: 2063 6f6e 7461 696e 6572 7320 3d20 7365   containers = se
-0000c3f0: 6c66 2e6d 6f64 656c 2e75 6e69 742e 636f  lf.model.unit.co
-0000c400: 6e74 6169 6e65 7273 0a20 2020 2020 2020  ntainers.       
-0000c410: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000c420: 6c28 736f 7274 6564 2863 6f6e 7461 696e  l(sorted(contain
-0000c430: 6572 7329 2c20 5b27 6331 272c 2027 6332  ers), ['c1', 'c2
-0000c440: 275d 290a 2020 2020 2020 2020 7365 6c66  ']).        self
-0000c450: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
-0000c460: 2863 6f6e 7461 696e 6572 7329 2c20 3229  (containers), 2)
-0000c470: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000c480: 7365 7274 496e 2827 6331 272c 2063 6f6e  sertIn('c1', con
-0000c490: 7461 696e 6572 7329 0a20 2020 2020 2020  tainers).       
-0000c4a0: 2073 656c 662e 6173 7365 7274 496e 2827   self.assertIn('
-0000c4b0: 6332 272c 2063 6f6e 7461 696e 6572 7329  c2', containers)
-0000c4c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000c4d0: 7365 7274 4e6f 7449 6e28 2763 3327 2c20  sertNotIn('c3', 
-0000c4e0: 636f 6e74 6169 6e65 7273 290a 2020 2020  containers).    
-0000c4f0: 2020 2020 666f 7220 6e61 6d65 2069 6e20      for name in 
-0000c500: 5b27 6331 272c 2027 6332 275d 3a0a 2020  ['c1', 'c2']:.  
-0000c510: 2020 2020 2020 2020 2020 636f 6e74 6169            contai
-0000c520: 6e65 7220 3d20 636f 6e74 6169 6e65 7273  ner = containers
-0000c530: 5b6e 616d 655d 0a20 2020 2020 2020 2020  [name].         
-0000c540: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-0000c550: 496e 7374 616e 6365 2863 6f6e 7461 696e  Instance(contain
-0000c560: 6572 2c20 6f70 732e 436f 6e74 6169 6e65  er, ops.Containe
-0000c570: 7229 0a20 2020 2020 2020 2020 2020 2073  r).            s
-0000c580: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000c590: 636f 6e74 6169 6e65 722e 6e61 6d65 2c20  container.name, 
-0000c5a0: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-0000c5b0: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-0000c5c0: 6e73 7461 6e63 6528 636f 6e74 6169 6e65  nstance(containe
-0000c5d0: 722e 7065 6262 6c65 2c20 7065 6262 6c65  r.pebble, pebble
-0000c5e0: 2e43 6c69 656e 7429 0a20 2020 2020 2020  .Client).       
-0000c5f0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-0000c600: 7452 6169 7365 7328 4b65 7945 7272 6f72  tRaises(KeyError
-0000c610: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-0000c620: 6f6e 7461 696e 6572 735b 2763 3327 5d0a  ontainers['c3'].
-0000c630: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-0000c640: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-0000c650: 5275 6e74 696d 6545 7272 6f72 293a 0a20  RuntimeError):. 
-0000c660: 2020 2020 2020 2020 2020 206f 7468 6572             other
-0000c670: 5f75 6e69 7420 3d20 7365 6c66 2e6d 6f64  _unit = self.mod
-0000c680: 656c 2e67 6574 5f75 6e69 7428 276f 7468  el.get_unit('oth
-0000c690: 6572 2729 0a20 2020 2020 2020 2020 2020  er').           
-0000c6a0: 206f 7468 6572 5f75 6e69 742e 636f 6e74   other_unit.cont
-0000c6b0: 6169 6e65 7273 0a0a 2020 2020 6465 6620  ainers..    def 
-0000c6c0: 7465 7374 5f75 6e69 745f 6765 745f 636f  test_unit_get_co
-0000c6d0: 6e74 6169 6e65 7228 7365 6c66 293a 0a20  ntainer(self):. 
-0000c6e0: 2020 2020 2020 2075 6e69 7420 3d20 7365         unit = se
-0000c6f0: 6c66 2e6d 6f64 656c 2e75 6e69 740a 2020  lf.model.unit.  
-0000c700: 2020 2020 2020 666f 7220 6e61 6d65 2069        for name i
-0000c710: 6e20 5b27 6331 272c 2027 6332 275d 3a0a  n ['c1', 'c2']:.
-0000c720: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0000c730: 6169 6e65 7220 3d20 756e 6974 2e67 6574  ainer = unit.get
-0000c740: 5f63 6f6e 7461 696e 6572 286e 616d 6529  _container(name)
-0000c750: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000c760: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
-0000c770: 6365 2863 6f6e 7461 696e 6572 2c20 6f70  ce(container, op
-0000c780: 732e 436f 6e74 6169 6e65 7229 0a20 2020  s.Container).   
-0000c790: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
-0000c7a0: 7365 7274 4571 7561 6c28 636f 6e74 6169  sertEqual(contai
-0000c7b0: 6e65 722e 6e61 6d65 2c20 6e61 6d65 290a  ner.name, name).
-0000c7c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000c7d0: 2e61 7373 6572 7449 7349 6e73 7461 6e63  .assertIsInstanc
-0000c7e0: 6528 636f 6e74 6169 6e65 722e 7065 6262  e(container.pebb
-0000c7f0: 6c65 2c20 7065 6262 6c65 2e43 6c69 656e  le, pebble.Clien
-0000c800: 7429 0a20 2020 2020 2020 2077 6974 6820  t).        with 
-0000c810: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-0000c820: 7328 6f70 732e 4d6f 6465 6c45 7272 6f72  s(ops.ModelError
-0000c830: 293a 0a20 2020 2020 2020 2020 2020 2075  ):.            u
-0000c840: 6e69 742e 6765 745f 636f 6e74 6169 6e65  nit.get_containe
-0000c850: 7228 2763 3327 290a 0a20 2020 2020 2020  r('c3')..       
-0000c860: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-0000c870: 7452 6169 7365 7328 5275 6e74 696d 6545  tRaises(RuntimeE
-0000c880: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-0000c890: 2020 206f 7468 6572 5f75 6e69 7420 3d20     other_unit = 
-0000c8a0: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f75  self.model.get_u
-0000c8b0: 6e69 7428 276f 7468 6572 2729 0a20 2020  nit('other').   
-0000c8c0: 2020 2020 2020 2020 206f 7468 6572 5f75           other_u
-0000c8d0: 6e69 742e 6765 745f 636f 6e74 6169 6e65  nit.get_containe
-0000c8e0: 7228 2766 6f6f 2729 0a0a 0a63 6c61 7373  r('foo')...class
-0000c8f0: 2054 6573 7443 6f6e 7461 696e 6572 5065   TestContainerPe
-0000c900: 6262 6c65 2875 6e69 7474 6573 742e 5465  bble(unittest.Te
-0000c910: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
-0000c920: 2073 6574 5570 2873 656c 6629 3a0a 2020   setUp(self):.  
-0000c930: 2020 2020 2020 6d65 7461 203d 206f 7073        meta = ops
-0000c940: 2e43 6861 726d 4d65 7461 2e66 726f 6d5f  .CharmMeta.from_
-0000c950: 7961 6d6c 2822 2222 0a6e 616d 653a 206b  yaml(""".name: k
-0000c960: 3873 2d63 6861 726d 0a63 6f6e 7461 696e  8s-charm.contain
-0000c970: 6572 733a 0a20 2063 313a 0a20 2020 206b  ers:.  c1:.    k
-0000c980: 3a20 760a 2222 2229 0a20 2020 2020 2020  : v.""").       
-0000c990: 2062 6163 6b65 6e64 203d 204d 6f63 6b50   backend = MockP
-0000c9a0: 6562 626c 6542 6163 6b65 6e64 2827 6d79  ebbleBackend('my
-0000c9b0: 6170 702f 3027 290a 2020 2020 2020 2020  app/0').        
-0000c9c0: 7365 6c66 2e6d 6f64 656c 203d 206f 7073  self.model = ops
-0000c9d0: 2e4d 6f64 656c 286d 6574 612c 2062 6163  .Model(meta, bac
-0000c9e0: 6b65 6e64 290a 2020 2020 2020 2020 7365  kend).        se
-0000c9f0: 6c66 2e63 6f6e 7461 696e 6572 203d 2073  lf.container = s
-0000ca00: 656c 662e 6d6f 6465 6c2e 756e 6974 2e63  elf.model.unit.c
-0000ca10: 6f6e 7461 696e 6572 735b 2763 3127 5d0a  ontainers['c1'].
-0000ca20: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
-0000ca30: 626c 6520 3d20 7365 6c66 2e63 6f6e 7461  ble = self.conta
-0000ca40: 696e 6572 2e70 6562 626c 650a 0a20 2020  iner.pebble..   
-0000ca50: 2064 6566 2074 6573 745f 736f 636b 6574   def test_socket
-0000ca60: 5f70 6174 6828 7365 6c66 293a 0a20 2020  _path(self):.   
-0000ca70: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000ca80: 4571 7561 6c28 7365 6c66 2e70 6562 626c  Equal(self.pebbl
-0000ca90: 652e 736f 636b 6574 5f70 6174 682c 2027  e.socket_path, '
-0000caa0: 2f63 6861 726d 2f63 6f6e 7461 696e 6572  /charm/container
-0000cab0: 732f 6331 2f70 6562 626c 652e 736f 636b  s/c1/pebble.sock
-0000cac0: 6574 2729 0a0a 2020 2020 6465 6620 7465  et')..    def te
-0000cad0: 7374 5f61 7574 6f73 7461 7274 2873 656c  st_autostart(sel
-0000cae0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-0000caf0: 2e63 6f6e 7461 696e 6572 2e61 7574 6f73  .container.autos
-0000cb00: 7461 7274 2829 0a20 2020 2020 2020 2073  tart().        s
-0000cb10: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000cb20: 7365 6c66 2e70 6562 626c 652e 7265 7175  self.pebble.requ
-0000cb30: 6573 7473 2c20 5b28 2761 7574 6f73 7461  ests, [('autosta
-0000cb40: 7274 272c 295d 290a 0a20 2020 2064 6566  rt',)])..    def
-0000cb50: 2074 6573 745f 7265 706c 616e 2873 656c   test_replan(sel
-0000cb60: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-0000cb70: 2e63 6f6e 7461 696e 6572 2e72 6570 6c61  .container.repla
-0000cb80: 6e28 290a 2020 2020 2020 2020 7365 6c66  n().        self
-0000cb90: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-0000cba0: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
-0000cbb0: 732c 205b 2827 7265 706c 616e 272c 295d  s, [('replan',)]
-0000cbc0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000cbd0: 6361 6e5f 636f 6e6e 6563 7428 7365 6c66  can_connect(self
-0000cbe0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000cbf0: 7065 6262 6c65 2e72 6573 706f 6e73 6573  pebble.responses
-0000cc00: 2e61 7070 656e 6428 7065 6262 6c65 2e53  .append(pebble.S
-0000cc10: 7973 7465 6d49 6e66 6f2e 6672 6f6d 5f64  ystemInfo.from_d
-0000cc20: 6963 7428 7b27 7665 7273 696f 6e27 3a20  ict({'version': 
-0000cc30: 2731 2e30 2e30 277d 2929 0a20 2020 2020  '1.0.0'})).     
-0000cc40: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-0000cc50: 7565 2873 656c 662e 636f 6e74 6169 6e65  ue(self.containe
-0000cc60: 722e 6361 6e5f 636f 6e6e 6563 7428 2929  r.can_connect())
-0000cc70: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000cc80: 7365 7274 4571 7561 6c28 7365 6c66 2e70  sertEqual(self.p
-0000cc90: 6562 626c 652e 7265 7175 6573 7473 2c20  ebble.requests, 
-0000cca0: 5b28 2767 6574 5f73 7973 7465 6d5f 696e  [('get_system_in
-0000ccb0: 666f 272c 295d 290a 0a20 2020 2064 6566  fo',)])..    def
-0000ccc0: 2074 6573 745f 7374 6172 7428 7365 6c66   test_start(self
-0000ccd0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000cce0: 636f 6e74 6169 6e65 722e 7374 6172 7428  container.start(
-0000ccf0: 2766 6f6f 2729 0a20 2020 2020 2020 2073  'foo').        s
-0000cd00: 656c 662e 636f 6e74 6169 6e65 722e 7374  elf.container.st
-0000cd10: 6172 7428 2766 6f6f 272c 2027 6261 7227  art('foo', 'bar'
-0000cd20: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000cd30: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-0000cd40: 7065 6262 6c65 2e72 6571 7565 7374 732c  pebble.requests,
-0000cd50: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
-0000cd60: 2773 7461 7274 272c 2028 2766 6f6f 272c  'start', ('foo',
-0000cd70: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-0000cd80: 2827 7374 6172 7427 2c20 2827 666f 6f27  ('start', ('foo'
-0000cd90: 2c20 2762 6172 2729 292c 0a20 2020 2020  , 'bar')),.     
-0000cda0: 2020 205d 290a 0a20 2020 2064 6566 2074     ])..    def t
-0000cdb0: 6573 745f 7374 6172 745f 6e6f 5f61 7267  est_start_no_arg
-0000cdc0: 756d 656e 7473 2873 656c 6629 3a0a 2020  uments(self):.  
-0000cdd0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-0000cde0: 6173 7365 7274 5261 6973 6573 2854 7970  assertRaises(Typ
-0000cdf0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-0000ce00: 2020 2020 2073 656c 662e 636f 6e74 6169       self.contai
-0000ce10: 6e65 722e 7374 6172 7428 290a 0a20 2020  ner.start()..   
-0000ce20: 2064 6566 2074 6573 745f 7374 6f70 2873   def test_stop(s
-0000ce30: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-0000ce40: 6c66 2e63 6f6e 7461 696e 6572 2e73 746f  lf.container.sto
-0000ce50: 7028 2766 6f6f 2729 0a20 2020 2020 2020  p('foo').       
-0000ce60: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
-0000ce70: 7374 6f70 2827 666f 6f27 2c20 2762 6172  stop('foo', 'bar
-0000ce80: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0000ce90: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0000cea0: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
-0000ceb0: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-0000cec0: 2827 7374 6f70 272c 2028 2766 6f6f 272c  ('stop', ('foo',
-0000ced0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-0000cee0: 2827 7374 6f70 272c 2028 2766 6f6f 272c  ('stop', ('foo',
-0000cef0: 2027 6261 7227 2929 2c0a 2020 2020 2020   'bar')),.      
-0000cf00: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
-0000cf10: 7374 5f73 746f 705f 6e6f 5f61 7267 756d  st_stop_no_argum
-0000cf20: 656e 7473 2873 656c 6629 3a0a 2020 2020  ents(self):.    
-0000cf30: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0000cf40: 7365 7274 5261 6973 6573 2854 7970 6545  sertRaises(TypeE
-0000cf50: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-0000cf60: 2020 2073 656c 662e 636f 6e74 6169 6e65     self.containe
-0000cf70: 722e 7374 6f70 2829 0a0a 2020 2020 6465  r.stop()..    de
-0000cf80: 6620 7465 7374 5f72 6573 7461 7274 2873  f test_restart(s
-0000cf90: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-0000cfa0: 6c66 2e63 6f6e 7461 696e 6572 2e72 6573  lf.container.res
-0000cfb0: 7461 7274 2827 666f 6f27 290a 2020 2020  tart('foo').    
-0000cfc0: 2020 2020 7365 6c66 2e63 6f6e 7461 696e      self.contain
-0000cfd0: 6572 2e72 6573 7461 7274 2827 666f 6f27  er.restart('foo'
-0000cfe0: 2c20 2762 6172 2729 0a20 2020 2020 2020  , 'bar').       
-0000cff0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000d000: 6c28 7365 6c66 2e70 6562 626c 652e 7265  l(self.pebble.re
-0000d010: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
-0000d020: 2020 2020 2020 2827 7265 7374 6172 7427        ('restart'
-0000d030: 2c20 2827 666f 6f27 2c29 292c 0a20 2020  , ('foo',)),.   
-0000d040: 2020 2020 2020 2020 2028 2772 6573 7461           ('resta
-0000d050: 7274 272c 2028 2766 6f6f 272c 2027 6261  rt', ('foo', 'ba
-0000d060: 7227 2929 2c0a 2020 2020 2020 2020 5d29  r')),.        ])
-0000d070: 0a0a 2020 2020 6465 6620 7465 7374 5f72  ..    def test_r
-0000d080: 6573 7461 7274 5f66 616c 6c62 6163 6b28  estart_fallback(
-0000d090: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
-0000d0a0: 6566 2072 6573 7461 7274 5f73 6572 7669  ef restart_servi
-0000d0b0: 6365 7328 7365 7276 6963 6573 293a 0a20  ces(services):. 
-0000d0c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000d0d0: 7065 6262 6c65 2e72 6571 7565 7374 732e  pebble.requests.
-0000d0e0: 6170 7065 6e64 2828 2772 6573 7461 7274  append(('restart
-0000d0f0: 272c 2073 6572 7669 6365 7329 290a 2020  ', services)).  
-0000d100: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000d110: 7065 6262 6c65 2e41 5049 4572 726f 7228  pebble.APIError(
-0000d120: 7b7d 2c20 3430 302c 2022 222c 2022 2229  {}, 400, "", "")
-0000d130: 0a0a 2020 2020 2020 2020 7365 6c66 2e70  ..        self.p
-0000d140: 6562 626c 652e 7265 7374 6172 745f 7365  ebble.restart_se
-0000d150: 7276 6963 6573 203d 2072 6573 7461 7274  rvices = restart
-0000d160: 5f73 6572 7669 6365 730a 2020 2020 2020  _services.      
-0000d170: 2020 2320 5365 7475 7020 7468 6520 5065    # Setup the Pe
-0000d180: 6262 6c65 2063 6c69 656e 7420 746f 2072  bble client to r
-0000d190: 6573 706f 6e64 2074 6f20 6120 6361 6c6c  espond to a call
-0000d1a0: 2074 6f20 6765 745f 7365 7276 6963 6573   to get_services
-0000d1b0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0000d1c0: 7065 6262 6c65 2e72 6573 706f 6e73 6573  pebble.responses
-0000d1d0: 2e61 7070 656e 6428 5b0a 2020 2020 2020  .append([.      
-0000d1e0: 2020 2020 2020 7065 6262 6c65 2e53 6572        pebble.Ser
-0000d1f0: 7669 6365 496e 666f 2e66 726f 6d5f 6469  viceInfo.from_di
-0000d200: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
-0000d210: 2020 2020 7b27 6e61 6d65 273a 2027 666f      {'name': 'fo
-0000d220: 6f27 2c20 2773 7461 7274 7570 273a 2027  o', 'startup': '
-0000d230: 656e 6162 6c65 6427 2c20 2763 7572 7265  enabled', 'curre
-0000d240: 6e74 273a 2027 6163 7469 7665 277d 292c  nt': 'active'}),
-0000d250: 0a20 2020 2020 2020 2020 2020 2070 6562  .            peb
-0000d260: 626c 652e 5365 7276 6963 6549 6e66 6f2e  ble.ServiceInfo.
-0000d270: 6672 6f6d 5f64 6963 7428 0a20 2020 2020  from_dict(.     
-0000d280: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
-0000d290: 6527 3a20 2762 6172 272c 2027 7374 6172  e': 'bar', 'star
-0000d2a0: 7475 7027 3a20 2765 6e61 626c 6564 272c  tup': 'enabled',
-0000d2b0: 2027 6375 7272 656e 7427 3a20 2769 6e61   'current': 'ina
-0000d2c0: 6374 6976 6527 7d29 2c0a 2020 2020 2020  ctive'}),.      
-0000d2d0: 2020 5d29 0a0a 2020 2020 2020 2020 7365    ])..        se
-0000d2e0: 6c66 2e63 6f6e 7461 696e 6572 2e72 6573  lf.container.res
-0000d2f0: 7461 7274 2827 666f 6f27 2c20 2762 6172  tart('foo', 'bar
-0000d300: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0000d310: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0000d320: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
-0000d330: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-0000d340: 2320 5468 6973 2069 7320 7468 6520 6669  # This is the fi
-0000d350: 7273 7420 7265 7175 6573 742c 2077 6869  rst request, whi
-0000d360: 6368 2069 6e20 7265 616c 206c 6966 6520  ch in real life 
-0000d370: 6661 696c 7320 7769 7468 2041 5049 4572  fails with APIEr
-0000d380: 726f 7220 6f6e 206f 6c64 6572 2076 6572  ror on older ver
-0000d390: 7369 6f6e 730a 2020 2020 2020 2020 2020  sions.          
-0000d3a0: 2020 2827 7265 7374 6172 7427 2c20 2827    ('restart', ('
-0000d3b0: 666f 6f27 2c20 2762 6172 2729 292c 0a20  foo', 'bar')),. 
-0000d3c0: 2020 2020 2020 2020 2020 2023 204e 6578             # Nex
-0000d3d0: 7420 7468 6520 636f 6465 2073 686f 756c  t the code shoul
-0000d3e0: 6420 6c6f 6f70 206f 7665 7220 7468 6520  d loop over the 
-0000d3f0: 7374 6172 7465 6420 7365 7276 6963 6573  started services
-0000d400: 2c20 616e 6420 7374 6f70 2074 6865 6d0a  , and stop them.
-0000d410: 2020 2020 2020 2020 2020 2020 2827 6765              ('ge
-0000d420: 745f 7365 7276 6963 6573 272c 2028 2766  t_services', ('f
-0000d430: 6f6f 272c 2027 6261 7227 2929 2c0a 2020  oo', 'bar')),.  
-0000d440: 2020 2020 2020 2020 2020 2827 7374 6f70            ('stop
-0000d450: 272c 2028 2766 6f6f 272c 2929 2c0a 2020  ', ('foo',)),.  
-0000d460: 2020 2020 2020 2020 2020 2320 5468 656e            # Then
-0000d470: 2073 7461 7274 2061 6c6c 2074 6865 2073   start all the s
-0000d480: 7065 6369 6669 6564 2073 6572 7669 6365  pecified service
-0000d490: 730a 2020 2020 2020 2020 2020 2020 2827  s.            ('
-0000d4a0: 7374 6172 7427 2c20 2827 666f 6f27 2c20  start', ('foo', 
-0000d4b0: 2762 6172 2729 290a 2020 2020 2020 2020  'bar')).        
-0000d4c0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0000d4d0: 5f72 6573 7461 7274 5f66 616c 6c62 6163  _restart_fallbac
-0000d4e0: 6b5f 6e6f 6e5f 3430 305f 6572 726f 7228  k_non_400_error(
-0000d4f0: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
-0000d500: 6566 2072 6573 7461 7274 5f73 6572 7669  ef restart_servi
-0000d510: 6365 7328 7365 7276 6963 6573 293a 0a20  ces(services):. 
-0000d520: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000d530: 2070 6562 626c 652e 4150 4945 7272 6f72   pebble.APIError
-0000d540: 287b 7d2c 2035 3030 2c20 2222 2c20 2222  ({}, 500, "", ""
-0000d550: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0000d560: 7065 6262 6c65 2e72 6573 7461 7274 5f73  pebble.restart_s
-0000d570: 6572 7669 6365 7320 3d20 7265 7374 6172  ervices = restar
-0000d580: 745f 7365 7276 6963 6573 0a20 2020 2020  t_services.     
-0000d590: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0000d5a0: 6572 7452 6169 7365 7328 7065 6262 6c65  ertRaises(pebble
-0000d5b0: 2e41 5049 4572 726f 7229 2061 7320 636d  .APIError) as cm
-0000d5c0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0000d5d0: 6c66 2e63 6f6e 7461 696e 6572 2e72 6573  lf.container.res
-0000d5e0: 7461 7274 2827 666f 6f27 290a 2020 2020  tart('foo').    
-0000d5f0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000d600: 7175 616c 2863 6d2e 6578 6365 7074 696f  qual(cm.exceptio
-0000d610: 6e2e 636f 6465 2c20 3530 3029 0a0a 2020  n.code, 500)..  
-0000d620: 2020 6465 6620 7465 7374 5f72 6573 7461    def test_resta
-0000d630: 7274 5f6e 6f5f 6172 6775 6d65 6e74 7328  rt_no_arguments(
-0000d640: 7365 6c66 293a 0a20 2020 2020 2020 2077  self):.        w
-0000d650: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-0000d660: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
-0000d670: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0000d680: 6c66 2e63 6f6e 7461 696e 6572 2e72 6573  lf.container.res
-0000d690: 7461 7274 2829 0a0a 2020 2020 6465 6620  tart()..    def 
-0000d6a0: 7465 7374 5f74 7970 655f 6572 726f 7273  test_type_errors
-0000d6b0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000d6c0: 6d65 7461 203d 206f 7073 2e43 6861 726d  meta = ops.Charm
-0000d6d0: 4d65 7461 2e66 726f 6d5f 7961 6d6c 2822  Meta.from_yaml("
-0000d6e0: 2222 0a6e 616d 653a 206b 3873 2d63 6861  "".name: k8s-cha
-0000d6f0: 726d 0a63 6f6e 7461 696e 6572 733a 0a20  rm.containers:. 
-0000d700: 2063 313a 0a20 2020 206b 3a20 760a 2222   c1:.    k: v.""
-0000d710: 2229 0a20 2020 2020 2020 2023 204f 6e6c  ").        # Onl
-0000d720: 7920 7468 6520 7265 616c 2070 6562 626c  y the real pebbl
-0000d730: 6520 436c 6965 6e74 2063 6865 636b 7320  e Client checks 
-0000d740: 7479 7065 732c 2073 6f20 7573 6520 6163  types, so use ac
-0000d750: 7475 616c 2062 6163 6b65 6e64 2063 6c61  tual backend cla
-0000d760: 7373 0a20 2020 2020 2020 2062 6163 6b65  ss.        backe
-0000d770: 6e64 203d 205f 4d6f 6465 6c42 6163 6b65  nd = _ModelBacke
-0000d780: 6e64 2827 6d79 6170 702f 3027 290a 2020  nd('myapp/0').  
-0000d790: 2020 2020 2020 6d6f 6465 6c20 3d20 6f70        model = op
-0000d7a0: 732e 4d6f 6465 6c28 6d65 7461 2c20 6261  s.Model(meta, ba
-0000d7b0: 636b 656e 6429 0a20 2020 2020 2020 2063  ckend).        c
-0000d7c0: 6f6e 7461 696e 6572 203d 206d 6f64 656c  ontainer = model
-0000d7d0: 2e75 6e69 742e 636f 6e74 6169 6e65 7273  .unit.containers
-0000d7e0: 5b27 6331 275d 0a0a 2020 2020 2020 2020  ['c1']..        
-0000d7f0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0000d800: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
-0000d810: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-0000d820: 6f6e 7461 696e 6572 2e73 7461 7274 285b  ontainer.start([
-0000d830: 2766 6f6f 275d 290a 0a20 2020 2020 2020  'foo'])..       
-0000d840: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-0000d850: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
-0000d860: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0000d870: 636f 6e74 6169 6e65 722e 7374 6f70 285b  container.stop([
-0000d880: 2766 6f6f 275d 290a 0a20 2020 2064 6566  'foo'])..    def
-0000d890: 2074 6573 745f 6164 645f 6c61 7965 7228   test_add_layer(
-0000d8a0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-0000d8b0: 656c 662e 636f 6e74 6169 6e65 722e 6164  elf.container.ad
-0000d8c0: 645f 6c61 7965 7228 2761 272c 2027 7375  d_layer('a', 'su
-0000d8d0: 6d6d 6172 793a 2073 7472 5c6e 2729 0a20  mmary: str\n'). 
-0000d8e0: 2020 2020 2020 2073 656c 662e 636f 6e74         self.cont
-0000d8f0: 6169 6e65 722e 6164 645f 6c61 7965 7228  ainer.add_layer(
-0000d900: 2762 272c 207b 2773 756d 6d61 7279 273a  'b', {'summary':
-0000d910: 2027 6469 6374 277d 290a 2020 2020 2020   'dict'}).      
-0000d920: 2020 7365 6c66 2e63 6f6e 7461 696e 6572    self.container
-0000d930: 2e61 6464 5f6c 6179 6572 2827 6327 2c20  .add_layer('c', 
-0000d940: 7065 6262 6c65 2e4c 6179 6572 2827 7375  pebble.Layer('su
-0000d950: 6d6d 6172 793a 204c 6179 6572 2729 290a  mmary: Layer')).
-0000d960: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0000d970: 7461 696e 6572 2e61 6464 5f6c 6179 6572  tainer.add_layer
-0000d980: 2827 6427 2c20 2773 756d 6d61 7279 3a20  ('d', 'summary: 
-0000d990: 7374 725c 6e27 2c20 636f 6d62 696e 653d  str\n', combine=
-0000d9a0: 5472 7565 290a 2020 2020 2020 2020 7365  True).        se
-0000d9b0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000d9c0: 656c 662e 7065 6262 6c65 2e72 6571 7565  elf.pebble.reque
-0000d9d0: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-0000d9e0: 2020 2028 2761 6464 5f6c 6179 6572 272c     ('add_layer',
-0000d9f0: 2027 6127 2c20 2773 756d 6d61 7279 3a20   'a', 'summary: 
-0000da00: 7374 725c 6e27 2c20 4661 6c73 6529 2c0a  str\n', False),.
-0000da10: 2020 2020 2020 2020 2020 2020 2827 6164              ('ad
-0000da20: 645f 6c61 7965 7227 2c20 2762 272c 2027  d_layer', 'b', '
-0000da30: 7375 6d6d 6172 793a 2064 6963 745c 6e27  summary: dict\n'
-0000da40: 2c20 4661 6c73 6529 2c0a 2020 2020 2020  , False),.      
-0000da50: 2020 2020 2020 2827 6164 645f 6c61 7965        ('add_laye
-0000da60: 7227 2c20 2763 272c 2027 7375 6d6d 6172  r', 'c', 'summar
-0000da70: 793a 204c 6179 6572 5c6e 272c 2046 616c  y: Layer\n', Fal
-0000da80: 7365 292c 0a20 2020 2020 2020 2020 2020  se),.           
-0000da90: 2028 2761 6464 5f6c 6179 6572 272c 2027   ('add_layer', '
-0000daa0: 6427 2c20 2773 756d 6d61 7279 3a20 7374  d', 'summary: st
-0000dab0: 725c 6e27 2c20 5472 7565 292c 0a20 2020  r\n', True),.   
-0000dac0: 2020 2020 205d 290a 0a20 2020 2020 2020       ])..       
-0000dad0: 2023 2063 6f6d 6269 6e65 2069 7320 6120   # combine is a 
-0000dae0: 6b65 7977 6f72 642d 6f6e 6c79 2061 7267  keyword-only arg
-0000daf0: 2028 7368 6f75 6c64 2062 6520 636f 6d62   (should be comb
-0000db00: 696e 653d 5472 7565 290a 2020 2020 2020  ine=True).      
-0000db10: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-0000db20: 7274 5261 6973 6573 2854 7970 6545 7272  rtRaises(TypeErr
-0000db30: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-0000db40: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
-0000db50: 6164 645f 6c61 7965 7228 2778 272c 207b  add_layer('x', {
-0000db60: 7d2c 2054 7275 6529 0a0a 2020 2020 6465  }, True)..    de
-0000db70: 6620 7465 7374 5f67 6574 5f70 6c61 6e28  f test_get_plan(
-0000db80: 7365 6c66 293a 0a20 2020 2020 2020 2070  self):.        p
-0000db90: 6c61 6e5f 7961 6d6c 203d 2027 7365 7276  lan_yaml = 'serv
-0000dba0: 6963 6573 3a5c 6e20 666f 6f3a 5c6e 2020  ices:\n foo:\n  
-0000dbb0: 6f76 6572 7269 6465 3a20 7265 706c 6163  override: replac
-0000dbc0: 655c 6e20 2063 6f6d 6d61 6e64 3a20 6261  e\n  command: ba
-0000dbd0: 7227 0a20 2020 2020 2020 2073 656c 662e  r'.        self.
-0000dbe0: 7065 6262 6c65 2e72 6573 706f 6e73 6573  pebble.responses
-0000dbf0: 2e61 7070 656e 6428 7065 6262 6c65 2e50  .append(pebble.P
-0000dc00: 6c61 6e28 706c 616e 5f79 616d 6c29 290a  lan(plan_yaml)).
-0000dc10: 2020 2020 2020 2020 706c 616e 203d 2073          plan = s
-0000dc20: 656c 662e 636f 6e74 6169 6e65 722e 6765  elf.container.ge
-0000dc30: 745f 706c 616e 2829 0a20 2020 2020 2020  t_plan().       
-0000dc40: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000dc50: 6c28 7365 6c66 2e70 6562 626c 652e 7265  l(self.pebble.re
-0000dc60: 7175 6573 7473 2c20 5b28 2767 6574 5f70  quests, [('get_p
-0000dc70: 6c61 6e27 2c29 5d29 0a20 2020 2020 2020  lan',)]).       
-0000dc80: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
-0000dc90: 7374 616e 6365 2870 6c61 6e2c 2070 6562  stance(plan, peb
-0000dca0: 626c 652e 506c 616e 290a 2020 2020 2020  ble.Plan).      
-0000dcb0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000dcc0: 616c 2870 6c61 6e2e 746f 5f79 616d 6c28  al(plan.to_yaml(
-0000dcd0: 292c 2079 616d 6c2e 7361 6665 5f64 756d  ), yaml.safe_dum
-0000dce0: 7028 7961 6d6c 2e73 6166 655f 6c6f 6164  p(yaml.safe_load
-0000dcf0: 2870 6c61 6e5f 7961 6d6c 2929 290a 0a20  (plan_yaml))).. 
-0000dd00: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
-0000dd10: 0a20 2020 2064 6566 205f 6d61 6b65 5f73  .    def _make_s
-0000dd20: 6572 7669 6365 286e 616d 652c 2073 7461  ervice(name, sta
-0000dd30: 7274 7570 2c20 6375 7272 656e 7429 3a0a  rtup, current):.
-0000dd40: 2020 2020 2020 2020 7265 7475 726e 2070          return p
-0000dd50: 6562 626c 652e 5365 7276 6963 6549 6e66  ebble.ServiceInf
-0000dd60: 6f2e 6672 6f6d 5f64 6963 7428 0a20 2020  o.from_dict(.   
-0000dd70: 2020 2020 2020 2020 207b 276e 616d 6527           {'name'
-0000dd80: 3a20 6e61 6d65 2c20 2773 7461 7274 7570  : name, 'startup
-0000dd90: 273a 2073 7461 7274 7570 2c20 2763 7572  ': startup, 'cur
-0000dda0: 7265 6e74 273a 2063 7572 7265 6e74 7d29  rent': current})
-0000ddb0: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
-0000ddc0: 6574 5f73 6572 7669 6365 7328 7365 6c66  et_services(self
-0000ddd0: 293a 0a20 2020 2020 2020 2074 776f 5f73  ):.        two_s
-0000dde0: 6572 7669 6365 7320 3d20 5b0a 2020 2020  ervices = [.    
-0000ddf0: 2020 2020 2020 2020 7365 6c66 2e5f 6d61          self._ma
-0000de00: 6b65 5f73 6572 7669 6365 2827 7331 272c  ke_service('s1',
-0000de10: 2027 656e 6162 6c65 6427 2c20 2761 6374   'enabled', 'act
-0000de20: 6976 6527 292c 0a20 2020 2020 2020 2020  ive'),.         
-0000de30: 2020 2073 656c 662e 5f6d 616b 655f 7365     self._make_se
-0000de40: 7276 6963 6528 2773 3227 2c20 2764 6973  rvice('s2', 'dis
-0000de50: 6162 6c65 6427 2c20 2769 6e61 6374 6976  abled', 'inactiv
-0000de60: 6527 292c 0a20 2020 2020 2020 205d 0a20  e'),.        ]. 
-0000de70: 2020 2020 2020 2073 656c 662e 7065 6262         self.pebb
-0000de80: 6c65 2e72 6573 706f 6e73 6573 2e61 7070  le.responses.app
-0000de90: 656e 6428 7477 6f5f 7365 7276 6963 6573  end(two_services
-0000dea0: 290a 2020 2020 2020 2020 7365 7276 6963  ).        servic
-0000deb0: 6573 203d 2073 656c 662e 636f 6e74 6169  es = self.contai
-0000dec0: 6e65 722e 6765 745f 7365 7276 6963 6573  ner.get_services
-0000ded0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0000dee0: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
-0000def0: 7365 7276 6963 6573 292c 2032 290a 2020  services), 2).  
-0000df00: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000df10: 7445 7175 616c 2873 6574 2873 6572 7669  tEqual(set(servi
-0000df20: 6365 7329 2c20 7b27 7331 272c 2027 7332  ces), {'s1', 's2
-0000df30: 277d 290a 2020 2020 2020 2020 7365 6c66  '}).        self
-0000df40: 2e61 7373 6572 7445 7175 616c 2873 6572  .assertEqual(ser
-0000df50: 7669 6365 735b 2773 3127 5d2e 6e61 6d65  vices['s1'].name
-0000df60: 2c20 2773 3127 290a 2020 2020 2020 2020  , 's1').        
-0000df70: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000df80: 2873 6572 7669 6365 735b 2773 3127 5d2e  (services['s1'].
-0000df90: 7374 6172 7475 702c 2070 6562 626c 652e  startup, pebble.
-0000dfa0: 5365 7276 6963 6553 7461 7274 7570 2e45  ServiceStartup.E
-0000dfb0: 4e41 424c 4544 290a 2020 2020 2020 2020  NABLED).        
-0000dfc0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000dfd0: 2873 6572 7669 6365 735b 2773 3127 5d2e  (services['s1'].
-0000dfe0: 6375 7272 656e 742c 2070 6562 626c 652e  current, pebble.
-0000dff0: 5365 7276 6963 6553 7461 7475 732e 4143  ServiceStatus.AC
-0000e000: 5449 5645 290a 2020 2020 2020 2020 7365  TIVE).        se
-0000e010: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000e020: 6572 7669 6365 735b 2773 3227 5d2e 6e61  ervices['s2'].na
-0000e030: 6d65 2c20 2773 3227 290a 2020 2020 2020  me, 's2').      
-0000e040: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000e050: 616c 2873 6572 7669 6365 735b 2773 3227  al(services['s2'
-0000e060: 5d2e 7374 6172 7475 702c 2070 6562 626c  ].startup, pebbl
-0000e070: 652e 5365 7276 6963 6553 7461 7274 7570  e.ServiceStartup
-0000e080: 2e44 4953 4142 4c45 4429 0a20 2020 2020  .DISABLED).     
-0000e090: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000e0a0: 7561 6c28 7365 7276 6963 6573 5b27 7332  ual(services['s2
-0000e0b0: 275d 2e63 7572 7265 6e74 2c20 7065 6262  '].current, pebb
-0000e0c0: 6c65 2e53 6572 7669 6365 5374 6174 7573  le.ServiceStatus
-0000e0d0: 2e49 4e41 4354 4956 4529 0a0a 2020 2020  .INACTIVE)..    
-0000e0e0: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
-0000e0f0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-0000e100: 2874 776f 5f73 6572 7669 6365 7329 0a20  (two_services). 
-0000e110: 2020 2020 2020 2073 6572 7669 6365 7320         services 
-0000e120: 3d20 7365 6c66 2e63 6f6e 7461 696e 6572  = self.container
-0000e130: 2e67 6574 5f73 6572 7669 6365 7328 2773  .get_services('s
-0000e140: 3127 2c20 2773 3227 290a 2020 2020 2020  1', 's2').      
-0000e150: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000e160: 616c 286c 656e 2873 6572 7669 6365 7329  al(len(services)
-0000e170: 2c20 3229 0a20 2020 2020 2020 2073 656c  , 2).        sel
-0000e180: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000e190: 7428 7365 7276 6963 6573 292c 207b 2773  t(services), {'s
-0000e1a0: 3127 2c20 2773 3227 7d29 0a20 2020 2020  1', 's2'}).     
-0000e1b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000e1c0: 7561 6c28 7365 7276 6963 6573 5b27 7331  ual(services['s1
-0000e1d0: 275d 2e6e 616d 652c 2027 7331 2729 0a20  '].name, 's1'). 
-0000e1e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000e1f0: 7274 4571 7561 6c28 7365 7276 6963 6573  rtEqual(services
-0000e200: 5b27 7331 275d 2e73 7461 7274 7570 2c20  ['s1'].startup, 
-0000e210: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
-0000e220: 6172 7475 702e 454e 4142 4c45 4429 0a20  artup.ENABLED). 
-0000e230: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000e240: 7274 4571 7561 6c28 7365 7276 6963 6573  rtEqual(services
-0000e250: 5b27 7331 275d 2e63 7572 7265 6e74 2c20  ['s1'].current, 
-0000e260: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
-0000e270: 6174 7573 2e41 4354 4956 4529 0a20 2020  atus.ACTIVE).   
-0000e280: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000e290: 4571 7561 6c28 7365 7276 6963 6573 5b27  Equal(services['
-0000e2a0: 7332 275d 2e6e 616d 652c 2027 7332 2729  s2'].name, 's2')
-0000e2b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000e2c0: 7365 7274 4571 7561 6c28 7365 7276 6963  sertEqual(servic
-0000e2d0: 6573 5b27 7332 275d 2e73 7461 7274 7570  es['s2'].startup
-0000e2e0: 2c20 7065 6262 6c65 2e53 6572 7669 6365  , pebble.Service
-0000e2f0: 5374 6172 7475 702e 4449 5341 424c 4544  Startup.DISABLED
-0000e300: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000e310: 7373 6572 7445 7175 616c 2873 6572 7669  ssertEqual(servi
-0000e320: 6365 735b 2773 3227 5d2e 6375 7272 656e  ces['s2'].curren
-0000e330: 742c 2070 6562 626c 652e 5365 7276 6963  t, pebble.Servic
-0000e340: 6553 7461 7475 732e 494e 4143 5449 5645  eStatus.INACTIVE
-0000e350: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0000e360: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0000e370: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
-0000e380: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-0000e390: 2827 6765 745f 7365 7276 6963 6573 272c  ('get_services',
-0000e3a0: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
-0000e3b0: 2020 2020 2827 6765 745f 7365 7276 6963      ('get_servic
-0000e3c0: 6573 272c 2028 2773 3127 2c20 2773 3227  es', ('s1', 's2'
-0000e3d0: 2929 2c0a 2020 2020 2020 2020 5d29 0a0a  )),.        ])..
-0000e3e0: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
-0000e3f0: 5f73 6572 7669 6365 2873 656c 6629 3a0a  _service(self):.
-0000e400: 2020 2020 2020 2020 2320 5369 6e67 6c65          # Single
-0000e410: 2073 6572 7669 6365 2072 6574 7572 6e65   service returne
-0000e420: 6420 7375 6363 6573 7366 756c 6c79 0a20  d successfully. 
-0000e430: 2020 2020 2020 2073 656c 662e 7065 6262         self.pebb
-0000e440: 6c65 2e72 6573 706f 6e73 6573 2e61 7070  le.responses.app
-0000e450: 656e 6428 5b73 656c 662e 5f6d 616b 655f  end([self._make_
-0000e460: 7365 7276 6963 6528 2773 3127 2c20 2765  service('s1', 'e
-0000e470: 6e61 626c 6564 272c 2027 6163 7469 7665  nabled', 'active
-0000e480: 2729 5d29 0a20 2020 2020 2020 2073 203d  ')]).        s =
-0000e490: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
-0000e4a0: 6765 745f 7365 7276 6963 6528 2773 3127  get_service('s1'
-0000e4b0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000e4c0: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-0000e4d0: 7065 6262 6c65 2e72 6571 7565 7374 732c  pebble.requests,
-0000e4e0: 205b 2827 6765 745f 7365 7276 6963 6573   [('get_services
-0000e4f0: 272c 2028 2773 3127 2c20 2929 5d29 0a20  ', ('s1', ))]). 
-0000e500: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000e510: 7274 4571 7561 6c28 732e 6e61 6d65 2c20  rtEqual(s.name, 
-0000e520: 2773 3127 290a 2020 2020 2020 2020 7365  's1').        se
-0000e530: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000e540: 2e73 7461 7274 7570 2c20 7065 6262 6c65  .startup, pebble
-0000e550: 2e53 6572 7669 6365 5374 6172 7475 702e  .ServiceStartup.
-0000e560: 454e 4142 4c45 4429 0a20 2020 2020 2020  ENABLED).       
-0000e570: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000e580: 6c28 732e 6375 7272 656e 742c 2070 6562  l(s.current, peb
-0000e590: 626c 652e 5365 7276 6963 6553 7461 7475  ble.ServiceStatu
-0000e5a0: 732e 4143 5449 5645 290a 0a20 2020 2020  s.ACTIVE)..     
-0000e5b0: 2020 2023 2049 6620 5065 6262 6c65 2072     # If Pebble r
-0000e5c0: 6574 7572 6e73 206e 6f20 7365 7276 6963  eturns no servic
-0000e5d0: 6573 2c20 7368 6f75 6c64 2062 6520 6120  es, should be a 
-0000e5e0: 6f70 732e 4d6f 6465 6c45 7272 6f72 0a20  ops.ModelError. 
-0000e5f0: 2020 2020 2020 2073 656c 662e 7065 6262         self.pebb
-0000e600: 6c65 2e72 6573 706f 6e73 6573 2e61 7070  le.responses.app
-0000e610: 656e 6428 5b5d 290a 2020 2020 2020 2020  end([]).        
-0000e620: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0000e630: 5261 6973 6573 286f 7073 2e4d 6f64 656c  Raises(ops.Model
-0000e640: 4572 726f 7229 2061 7320 636d 3a0a 2020  Error) as cm:.  
-0000e650: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-0000e660: 6f6e 7461 696e 6572 2e67 6574 5f73 6572  ontainer.get_ser
-0000e670: 7669 6365 2827 7332 2729 0a20 2020 2020  vice('s2').     
-0000e680: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000e690: 7561 6c28 7374 7228 636d 2e65 7863 6570  ual(str(cm.excep
-0000e6a0: 7469 6f6e 292c 2022 7365 7276 6963 6520  tion), "service 
-0000e6b0: 2773 3227 206e 6f74 2066 6f75 6e64 2229  's2' not found")
-0000e6c0: 0a0a 2020 2020 2020 2020 2320 4966 2050  ..        # If P
-0000e6d0: 6562 626c 6520 7265 7475 726e 7320 6d6f  ebble returns mo
-0000e6e0: 7265 2074 6861 6e20 6f6e 6520 7365 7276  re than one serv
-0000e6f0: 6963 652c 2052 756e 7469 6d65 4572 726f  ice, RuntimeErro
-0000e700: 7220 6973 2072 6169 7365 640a 2020 2020  r is raised.    
-0000e710: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
-0000e720: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-0000e730: 285b 0a20 2020 2020 2020 2020 2020 2073  ([.            s
-0000e740: 656c 662e 5f6d 616b 655f 7365 7276 6963  elf._make_servic
-0000e750: 6528 2773 3127 2c20 2765 6e61 626c 6564  e('s1', 'enabled
-0000e760: 272c 2027 6163 7469 7665 2729 2c0a 2020  ', 'active'),.  
-0000e770: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0000e780: 6d61 6b65 5f73 6572 7669 6365 2827 7332  make_service('s2
-0000e790: 272c 2027 6469 7361 626c 6564 272c 2027  ', 'disabled', '
-0000e7a0: 696e 6163 7469 7665 2729 2c0a 2020 2020  inactive'),.    
-0000e7b0: 2020 2020 5d29 0a20 2020 2020 2020 2077      ]).        w
-0000e7c0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-0000e7d0: 6169 7365 7328 5275 6e74 696d 6545 7272  aises(RuntimeErr
-0000e7e0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-0000e7f0: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
-0000e800: 6765 745f 7365 7276 6963 6528 2773 3127  get_service('s1'
-0000e810: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000e820: 6765 745f 6368 6563 6b73 2873 656c 6629  get_checks(self)
-0000e830: 3a0a 2020 2020 2020 2020 7265 7370 6f6e  :.        respon
-0000e840: 7365 5f63 6865 636b 7320 3d20 5b0a 2020  se_checks = [.  
-0000e850: 2020 2020 2020 2020 2020 7065 6262 6c65            pebble
-0000e860: 2e43 6865 636b 496e 666f 2e66 726f 6d5f  .CheckInfo.from_
-0000e870: 6469 6374 287b 0a20 2020 2020 2020 2020  dict({.         
-0000e880: 2020 2020 2020 2027 6e61 6d65 273a 2027         'name': '
-0000e890: 6331 272c 0a20 2020 2020 2020 2020 2020  c1',.           
-0000e8a0: 2020 2020 2027 7374 6174 7573 273a 2027       'status': '
-0000e8b0: 7570 272c 0a20 2020 2020 2020 2020 2020  up',.           
-0000e8c0: 2020 2020 2027 6661 696c 7572 6573 273a       'failures':
-0000e8d0: 2030 2c0a 2020 2020 2020 2020 2020 2020   0,.            
-0000e8e0: 2020 2020 2774 6872 6573 686f 6c64 273a      'threshold':
-0000e8f0: 2033 2c0a 2020 2020 2020 2020 2020 2020   3,.            
-0000e900: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
-0000e910: 7065 6262 6c65 2e43 6865 636b 496e 666f  pebble.CheckInfo
-0000e920: 2e66 726f 6d5f 6469 6374 287b 0a20 2020  .from_dict({.   
-0000e930: 2020 2020 2020 2020 2020 2020 2027 6e61               'na
-0000e940: 6d65 273a 2027 6332 272c 0a20 2020 2020  me': 'c2',.     
-0000e950: 2020 2020 2020 2020 2020 2027 6c65 7665             'leve
-0000e960: 6c27 3a20 2761 6c69 7665 272c 0a20 2020  l': 'alive',.   
-0000e970: 2020 2020 2020 2020 2020 2020 2027 7374               'st
-0000e980: 6174 7573 273a 2027 646f 776e 272c 0a20  atus': 'down',. 
-0000e990: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000e9a0: 6661 696c 7572 6573 273a 2032 2c0a 2020  failures': 2,.  
-0000e9b0: 2020 2020 2020 2020 2020 2020 2020 2774                't
-0000e9c0: 6872 6573 686f 6c64 273a 2032 2c0a 2020  hreshold': 2,.  
-0000e9d0: 2020 2020 2020 2020 2020 7d29 2c0a 2020            }),.  
-0000e9e0: 2020 2020 2020 5d0a 0a20 2020 2020 2020        ]..       
-0000e9f0: 2073 656c 662e 7065 6262 6c65 2e72 6573   self.pebble.res
-0000ea00: 706f 6e73 6573 2e61 7070 656e 6428 7265  ponses.append(re
-0000ea10: 7370 6f6e 7365 5f63 6865 636b 7329 0a20  sponse_checks). 
-0000ea20: 2020 2020 2020 2063 6865 636b 7320 3d20         checks = 
-0000ea30: 7365 6c66 2e63 6f6e 7461 696e 6572 2e67  self.container.g
-0000ea40: 6574 5f63 6865 636b 7328 290a 2020 2020  et_checks().    
-0000ea50: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000ea60: 7175 616c 286c 656e 2863 6865 636b 7329  qual(len(checks)
-0000ea70: 2c20 3229 0a20 2020 2020 2020 2073 656c  , 2).        sel
-0000ea80: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-0000ea90: 6563 6b73 5b27 6331 275d 2e6e 616d 652c  ecks['c1'].name,
-0000eaa0: 2027 6331 2729 0a20 2020 2020 2020 2073   'c1').        s
-0000eab0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000eac0: 6368 6563 6b73 5b27 6331 275d 2e6c 6576  checks['c1'].lev
-0000ead0: 656c 2c20 7065 6262 6c65 2e43 6865 636b  el, pebble.Check
-0000eae0: 4c65 7665 6c2e 554e 5345 5429 0a20 2020  Level.UNSET).   
-0000eaf0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000eb00: 4571 7561 6c28 6368 6563 6b73 5b27 6331  Equal(checks['c1
-0000eb10: 275d 2e73 7461 7475 732c 2070 6562 626c  '].status, pebbl
-0000eb20: 652e 4368 6563 6b53 7461 7475 732e 5550  e.CheckStatus.UP
-0000eb30: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000eb40: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
-0000eb50: 735b 2763 3127 5d2e 6661 696c 7572 6573  s['c1'].failures
-0000eb60: 2c20 3029 0a20 2020 2020 2020 2073 656c  , 0).        sel
-0000eb70: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-0000eb80: 6563 6b73 5b27 6331 275d 2e74 6872 6573  ecks['c1'].thres
-0000eb90: 686f 6c64 2c20 3329 0a20 2020 2020 2020  hold, 3).       
-0000eba0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000ebb0: 6c28 6368 6563 6b73 5b27 6332 275d 2e6e  l(checks['c2'].n
-0000ebc0: 616d 652c 2027 6332 2729 0a20 2020 2020  ame, 'c2').     
-0000ebd0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000ebe0: 7561 6c28 6368 6563 6b73 5b27 6332 275d  ual(checks['c2']
-0000ebf0: 2e6c 6576 656c 2c20 7065 6262 6c65 2e43  .level, pebble.C
-0000ec00: 6865 636b 4c65 7665 6c2e 414c 4956 4529  heckLevel.ALIVE)
-0000ec10: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000ec20: 7365 7274 4571 7561 6c28 6368 6563 6b73  sertEqual(checks
-0000ec30: 5b27 6332 275d 2e73 7461 7475 732c 2070  ['c2'].status, p
-0000ec40: 6562 626c 652e 4368 6563 6b53 7461 7475  ebble.CheckStatu
-0000ec50: 732e 444f 574e 290a 2020 2020 2020 2020  s.DOWN).        
-0000ec60: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000ec70: 2863 6865 636b 735b 2763 3227 5d2e 6661  (checks['c2'].fa
-0000ec80: 696c 7572 6573 2c20 3229 0a20 2020 2020  ilures, 2).     
-0000ec90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000eca0: 7561 6c28 6368 6563 6b73 5b27 6332 275d  ual(checks['c2']
-0000ecb0: 2e74 6872 6573 686f 6c64 2c20 3229 0a0a  .threshold, 2)..
-0000ecc0: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
-0000ecd0: 626c 652e 7265 7370 6f6e 7365 732e 6170  ble.responses.ap
-0000ece0: 7065 6e64 2872 6573 706f 6e73 655f 6368  pend(response_ch
-0000ecf0: 6563 6b73 5b31 3a32 5d29 0a20 2020 2020  ecks[1:2]).     
-0000ed00: 2020 2063 6865 636b 7320 3d20 7365 6c66     checks = self
-0000ed10: 2e63 6f6e 7461 696e 6572 2e67 6574 5f63  .container.get_c
-0000ed20: 6865 636b 7328 2763 3127 2c20 2763 3227  hecks('c1', 'c2'
-0000ed30: 2c20 6c65 7665 6c3d 7065 6262 6c65 2e43  , level=pebble.C
-0000ed40: 6865 636b 4c65 7665 6c2e 414c 4956 4529  heckLevel.ALIVE)
-0000ed50: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000ed60: 7365 7274 4571 7561 6c28 6c65 6e28 6368  sertEqual(len(ch
-0000ed70: 6563 6b73 292c 2031 290a 2020 2020 2020  ecks), 1).      
-0000ed80: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000ed90: 616c 2863 6865 636b 735b 2763 3227 5d2e  al(checks['c2'].
-0000eda0: 6e61 6d65 2c20 2763 3227 290a 2020 2020  name, 'c2').    
-0000edb0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000edc0: 7175 616c 2863 6865 636b 735b 2763 3227  qual(checks['c2'
-0000edd0: 5d2e 6c65 7665 6c2c 2070 6562 626c 652e  ].level, pebble.
-0000ede0: 4368 6563 6b4c 6576 656c 2e41 4c49 5645  CheckLevel.ALIVE
-0000edf0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000ee00: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
-0000ee10: 735b 2763 3227 5d2e 7374 6174 7573 2c20  s['c2'].status, 
-0000ee20: 7065 6262 6c65 2e43 6865 636b 5374 6174  pebble.CheckStat
-0000ee30: 7573 2e44 4f57 4e29 0a20 2020 2020 2020  us.DOWN).       
-0000ee40: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000ee50: 6c28 6368 6563 6b73 5b27 6332 275d 2e66  l(checks['c2'].f
-0000ee60: 6169 6c75 7265 732c 2032 290a 2020 2020  ailures, 2).    
-0000ee70: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000ee80: 7175 616c 2863 6865 636b 735b 2763 3227  qual(checks['c2'
-0000ee90: 5d2e 7468 7265 7368 6f6c 642c 2032 290a  ].threshold, 2).
-0000eea0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000eeb0: 7365 7274 4571 7561 6c28 7365 6c66 2e70  sertEqual(self.p
-0000eec0: 6562 626c 652e 7265 7175 6573 7473 2c20  ebble.requests, 
-0000eed0: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
-0000eee0: 6765 745f 6368 6563 6b73 272c 204e 6f6e  get_checks', Non
-0000eef0: 652c 204e 6f6e 6529 2c0a 2020 2020 2020  e, None),.      
-0000ef00: 2020 2020 2020 2827 6765 745f 6368 6563        ('get_chec
-0000ef10: 6b73 272c 2070 6562 626c 652e 4368 6563  ks', pebble.Chec
-0000ef20: 6b4c 6576 656c 2e41 4c49 5645 2c20 2827  kLevel.ALIVE, ('
-0000ef30: 6331 272c 2027 6332 2729 292c 0a20 2020  c1', 'c2')),.   
-0000ef40: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
-0000ef50: 2074 6573 745f 6765 745f 6368 6563 6b28   test_get_check(
-0000ef60: 7365 6c66 293a 0a20 2020 2020 2020 2023  self):.        #
-0000ef70: 2053 696e 676c 6520 6368 6563 6b20 7265   Single check re
-0000ef80: 7475 726e 6564 2073 7563 6365 7373 6675  turned successfu
-0000ef90: 6c6c 790a 2020 2020 2020 2020 7365 6c66  lly.        self
-0000efa0: 2e70 6562 626c 652e 7265 7370 6f6e 7365  .pebble.response
-0000efb0: 732e 6170 7065 6e64 285b 0a20 2020 2020  s.append([.     
-0000efc0: 2020 2020 2020 2070 6562 626c 652e 4368         pebble.Ch
-0000efd0: 6563 6b49 6e66 6f2e 6672 6f6d 5f64 6963  eckInfo.from_dic
-0000efe0: 7428 7b0a 2020 2020 2020 2020 2020 2020  t({.            
-0000eff0: 2020 2020 276e 616d 6527 3a20 2763 3127      'name': 'c1'
-0000f000: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f010: 2020 2773 7461 7475 7327 3a20 2775 7027    'status': 'up'
+0000b340: 0a40 7079 7465 7374 2e6d 6172 6b2e 7061  .@pytest.mark.pa
+0000b350: 7261 6d65 7472 697a 6528 2763 6173 6527  rametrize('case'
+0000b360: 2c20 5b0a 2020 2020 5075 7368 5075 6c6c  , [.    PushPull
+0000b370: 4361 7365 280a 2020 2020 2020 2020 6e61  Case(.        na
+0000b380: 6d65 3d27 7075 7368 2064 6972 6563 746f  me='push directo
+0000b390: 7279 2077 6974 686f 7574 2074 7261 696c  ry without trail
+0000b3a0: 696e 6720 736c 6173 6827 2c0a 2020 2020  ing slash',.    
+0000b3b0: 2020 2020 7061 7468 3d27 666f 6f27 2c0a      path='foo',.
+0000b3c0: 2020 2020 2020 2020 6473 743d 272f 6261          dst='/ba
+0000b3d0: 7a27 2c0a 2020 2020 2020 2020 6669 6c65  z',.        file
+0000b3e0: 733d 5b27 666f 6f2f 6261 722f 6261 7a2e  s=['foo/bar/baz.
+0000b3f0: 7478 7427 2c20 2766 6f6f 2f66 6f6f 6261  txt', 'foo/fooba
+0000b400: 722e 7478 7427 5d2c 0a20 2020 2020 2020  r.txt'],.       
+0000b410: 2077 616e 743d 7b27 2f62 617a 2f66 6f6f   want={'/baz/foo
+0000b420: 2f66 6f6f 6261 722e 7478 7427 2c20 272f  /foobar.txt', '/
+0000b430: 6261 7a2f 666f 6f2f 6261 722f 6261 7a2e  baz/foo/bar/baz.
+0000b440: 7478 7427 7d2c 0a20 2020 2029 2c0a 2020  txt'},.    ),.  
+0000b450: 2020 5075 7368 5075 6c6c 4361 7365 280a    PushPullCase(.
+0000b460: 2020 2020 2020 2020 6e61 6d65 3d27 7075          name='pu
+0000b470: 7368 2064 6972 6563 746f 7279 2077 6974  sh directory wit
+0000b480: 6820 7472 6169 6c69 6e67 2073 6c61 7368  h trailing slash
+0000b490: 272c 0a20 2020 2020 2020 2070 6174 683d  ',.        path=
+0000b4a0: 2766 6f6f 2f27 2c0a 2020 2020 2020 2020  'foo/',.        
+0000b4b0: 6473 743d 272f 6261 7a27 2c0a 2020 2020  dst='/baz',.    
+0000b4c0: 2020 2020 6669 6c65 733d 5b27 666f 6f2f      files=['foo/
+0000b4d0: 6261 722f 6261 7a2e 7478 7427 2c20 2766  bar/baz.txt', 'f
+0000b4e0: 6f6f 2f66 6f6f 6261 722e 7478 7427 5d2c  oo/foobar.txt'],
+0000b4f0: 0a20 2020 2020 2020 2077 616e 743d 7b27  .        want={'
+0000b500: 2f62 617a 2f66 6f6f 2f66 6f6f 6261 722e  /baz/foo/foobar.
+0000b510: 7478 7427 2c20 272f 6261 7a2f 666f 6f2f  txt', '/baz/foo/
+0000b520: 6261 722f 6261 7a2e 7478 7427 7d2c 0a20  bar/baz.txt'},. 
+0000b530: 2020 2029 2c0a 2020 2020 5075 7368 5075     ),.    PushPu
+0000b540: 6c6c 4361 7365 280a 2020 2020 2020 2020  llCase(.        
+0000b550: 6e61 6d65 3d27 7075 7368 2064 6972 6563  name='push direc
+0000b560: 746f 7279 2072 656c 6174 6976 6520 7061  tory relative pa
+0000b570: 7468 696e 6727 2c0a 2020 2020 2020 2020  thing',.        
+0000b580: 7061 7468 3d27 2e2f 666f 6f27 2c0a 2020  path='./foo',.  
+0000b590: 2020 2020 2020 6473 743d 272f 6261 7a27        dst='/baz'
+0000b5a0: 2c0a 2020 2020 2020 2020 6669 6c65 733d  ,.        files=
+0000b5b0: 5b27 666f 6f2f 6261 722f 6261 7a2e 7478  ['foo/bar/baz.tx
+0000b5c0: 7427 2c20 2766 6f6f 2f66 6f6f 6261 722e  t', 'foo/foobar.
+0000b5d0: 7478 7427 5d2c 0a20 2020 2020 2020 2077  txt'],.        w
+0000b5e0: 616e 743d 7b27 2f62 617a 2f66 6f6f 2f66  ant={'/baz/foo/f
+0000b5f0: 6f6f 6261 722e 7478 7427 2c20 272f 6261  oobar.txt', '/ba
+0000b600: 7a2f 666f 6f2f 6261 722f 6261 7a2e 7478  z/foo/bar/baz.tx
+0000b610: 7427 7d2c 0a20 2020 2029 2c0a 5d29 0a64  t'},.    ),.]).d
+0000b620: 6566 2074 6573 745f 7075 7368 5f70 6174  ef test_push_pat
+0000b630: 685f 7265 6c61 7469 7665 2863 6173 6529  h_relative(case)
+0000b640: 3a0a 2020 2020 6861 726e 6573 7320 3d20  :.    harness = 
+0000b650: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
+0000b660: 6573 7328 6f70 732e 4368 6172 6d42 6173  ess(ops.CharmBas
+0000b670: 652c 206d 6574 613d 2727 270a 2020 2020  e, meta='''.    
+0000b680: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
+0000b690: 7070 0a20 2020 2020 2020 2063 6f6e 7461  pp.        conta
+0000b6a0: 696e 6572 733a 0a20 2020 2020 2020 2020  iners:.         
+0000b6b0: 2066 6f6f 3a0a 2020 2020 2020 2020 2020   foo:.          
+0000b6c0: 2020 7265 736f 7572 6365 3a20 666f 6f2d    resource: foo-
+0000b6d0: 696d 6167 650a 2020 2020 2020 2020 2727  image.        ''
+0000b6e0: 2729 0a20 2020 2068 6172 6e65 7373 2e62  ').    harness.b
+0000b6f0: 6567 696e 2829 0a20 2020 2068 6172 6e65  egin().    harne
+0000b700: 7373 2e73 6574 5f63 616e 5f63 6f6e 6e65  ss.set_can_conne
+0000b710: 6374 2827 666f 6f27 2c20 5472 7565 290a  ct('foo', True).
+0000b720: 2020 2020 636f 6e74 6169 6e65 7220 3d20      container = 
+0000b730: 6861 726e 6573 732e 6d6f 6465 6c2e 756e  harness.model.un
+0000b740: 6974 2e63 6f6e 7461 696e 6572 735b 2766  it.containers['f
+0000b750: 6f6f 275d 0a0a 2020 2020 7769 7468 2074  oo']..    with t
+0000b760: 656d 7066 696c 652e 5465 6d70 6f72 6172  empfile.Temporar
+0000b770: 7944 6972 6563 746f 7279 2829 2061 7320  yDirectory() as 
+0000b780: 746d 7064 6972 3a0a 2020 2020 2020 2020  tmpdir:.        
+0000b790: 6377 6420 3d20 6f73 2e67 6574 6377 6428  cwd = os.getcwd(
+0000b7a0: 290a 2020 2020 2020 2020 2320 6368 616e  ).        # chan
+0000b7b0: 6765 2077 6f72 6b69 6e67 2064 6972 6563  ge working direc
+0000b7c0: 746f 7279 2074 6f20 656e 6162 6c65 2072  tory to enable r
+0000b7d0: 656c 6174 6976 6520 7061 7468 696e 6720  elative pathing 
+0000b7e0: 666f 7220 7465 7374 696e 670a 2020 2020  for testing.    
+0000b7f0: 2020 2020 6f73 2e63 6864 6972 2874 6d70      os.chdir(tmp
+0000b800: 6469 7229 0a20 2020 2020 2020 2074 7279  dir).        try
+0000b810: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0000b820: 6372 6561 7465 2074 6573 7420 6669 6c65  create test file
+0000b830: 7320 756e 6465 7220 7465 6d70 6f72 6172  s under temporar
+0000b840: 7920 7465 7374 2064 6972 6563 746f 7279  y test directory
+0000b850: 0a20 2020 2020 2020 2020 2020 2074 6d70  .            tmp
+0000b860: 203d 2070 6174 686c 6962 2e50 6174 6828   = pathlib.Path(
+0000b870: 746d 7064 6972 290a 2020 2020 2020 2020  tmpdir).        
+0000b880: 2020 2020 666f 7220 7465 7374 6669 6c65      for testfile
+0000b890: 2069 6e20 6361 7365 2e66 696c 6573 3a0a   in case.files:.
+0000b8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b8b0: 7465 7374 6669 6c65 5f70 6174 6820 3d20  testfile_path = 
+0000b8c0: 7061 7468 6c69 622e 5061 7468 2874 6d70  pathlib.Path(tmp
+0000b8d0: 202f 2074 6573 7466 696c 6529 0a20 2020   / testfile).   
+0000b8e0: 2020 2020 2020 2020 2020 2020 2074 6573               tes
+0000b8f0: 7466 696c 655f 7061 7468 2e70 6172 656e  tfile_path.paren
+0000b900: 742e 6d6b 6469 7228 7061 7265 6e74 733d  t.mkdir(parents=
+0000b910: 5472 7565 2c20 6578 6973 745f 6f6b 3d54  True, exist_ok=T
+0000b920: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+0000b930: 2020 2020 2074 6573 7466 696c 655f 7061       testfile_pa
+0000b940: 7468 2e74 6f75 6368 2865 7869 7374 5f6f  th.touch(exist_o
+0000b950: 6b3d 5472 7565 290a 2020 2020 2020 2020  k=True).        
+0000b960: 2020 2020 2020 2020 7465 7374 6669 6c65          testfile
+0000b970: 5f70 6174 682e 7772 6974 655f 7465 7874  _path.write_text
+0000b980: 2822 7465 7374 222c 2065 6e63 6f64 696e  ("test", encodin
+0000b990: 673d 2275 7466 2d38 2229 0a0a 2020 2020  g="utf-8")..    
+0000b9a0: 2020 2020 2020 2020 2320 7075 7368 2070          # push p
+0000b9b0: 6174 6820 756e 6465 7220 7465 7374 2074  ath under test t
+0000b9c0: 6f20 636f 6e74 6169 6e65 720a 2020 2020  o container.    
+0000b9d0: 2020 2020 2020 2020 636f 6e74 6169 6e65          containe
+0000b9e0: 722e 7075 7368 5f70 6174 6828 6361 7365  r.push_path(case
+0000b9f0: 2e70 6174 682c 2063 6173 652e 6473 7429  .path, case.dst)
+0000ba00: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000ba10: 7465 7374 0a20 2020 2020 2020 2020 2020  test.           
+0000ba20: 2066 6f72 2077 616e 745f 7061 7468 2069   for want_path i
+0000ba30: 6e20 6361 7365 2e77 616e 743a 0a20 2020  n case.want:.   
+0000ba40: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0000ba50: 7465 6e74 203d 2063 6f6e 7461 696e 6572  tent = container
+0000ba60: 2e70 756c 6c28 7761 6e74 5f70 6174 6829  .pull(want_path)
+0000ba70: 2e72 6561 6428 290a 2020 2020 2020 2020  .read().        
+0000ba80: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
+0000ba90: 6f6e 7465 6e74 203d 3d20 2774 6573 7427  ontent == 'test'
+0000baa0: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
+0000bab0: 3a0a 2020 2020 2020 2020 2020 2020 6f73  :.            os
+0000bac0: 2e63 6864 6972 2863 7764 290a 0a0a 636c  .chdir(cwd)...cl
+0000bad0: 6173 7320 5465 7374 4170 706c 6963 6174  ass TestApplicat
+0000bae0: 696f 6e28 756e 6974 7465 7374 2e54 6573  ion(unittest.Tes
+0000baf0: 7443 6173 6529 3a0a 0a20 2020 2064 6566  tCase):..    def
+0000bb00: 2073 6574 5570 2873 656c 6629 3a0a 2020   setUp(self):.  
+0000bb10: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
+0000bb20: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+0000bb30: 2e48 6172 6e65 7373 286f 7073 2e43 6861  .Harness(ops.Cha
+0000bb40: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
+0000bb50: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+0000bb60: 653a 206d 7961 7070 0a20 2020 2020 2020  e: myapp.       
+0000bb70: 2020 2020 2070 726f 7669 6465 733a 0a20       provides:. 
+0000bb80: 2020 2020 2020 2020 2020 2020 2064 6230               db0
+0000bb90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000bba0: 2020 696e 7465 7266 6163 653a 2064 6230    interface: db0
+0000bbb0: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
+0000bbc0: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
+0000bbd0: 2020 2020 2064 6231 3a0a 2020 2020 2020       db1:.      
+0000bbe0: 2020 2020 2020 2020 2020 696e 7465 7266            interf
+0000bbf0: 6163 653a 2064 6231 0a20 2020 2020 2020  ace: db1.       
+0000bc00: 2020 2020 2070 6565 7273 3a0a 2020 2020       peers:.    
+0000bc10: 2020 2020 2020 2020 2020 6462 323a 0a20            db2:. 
+0000bc20: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000bc30: 6e74 6572 6661 6365 3a20 6462 320a 2020  nterface: db2.  
+0000bc40: 2020 2020 2020 2020 2020 7265 736f 7572            resour
+0000bc50: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
+0000bc60: 2020 2066 6f6f 3a20 7b74 7970 653a 2066     foo: {type: f
+0000bc70: 696c 652c 2066 696c 656e 616d 653a 2066  ile, filename: f
+0000bc80: 6f6f 2e74 7874 7d0a 2020 2020 2020 2020  oo.txt}.        
+0000bc90: 2020 2020 2020 6261 723a 207b 7479 7065        bar: {type
+0000bca0: 3a20 6669 6c65 2c20 6669 6c65 6e61 6d65  : file, filename
+0000bcb0: 3a20 6261 722e 7478 747d 0a20 2020 2020  : bar.txt}.     
+0000bcc0: 2020 2020 2020 2063 6f6e 7461 696e 6572         container
+0000bcd0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000bce0: 2062 6172 3a0a 2020 2020 2020 2020 2020   bar:.          
+0000bcf0: 2020 2020 2020 6b3a 2076 0a20 2020 2020        k: v.     
+0000bd00: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
+0000bd10: 7365 6c66 2e70 6565 725f 7265 6c5f 6964  self.peer_rel_id
+0000bd20: 203d 2073 656c 662e 6861 726e 6573 732e   = self.harness.
+0000bd30: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
+0000bd40: 3227 2c20 2764 6232 2729 0a20 2020 2020  2', 'db2').     
+0000bd50: 2020 2073 656c 662e 6170 7020 3d20 7365     self.app = se
+0000bd60: 6c66 2e68 6172 6e65 7373 2e6d 6f64 656c  lf.harness.model
+0000bd70: 2e61 7070 0a20 2020 2020 2020 2073 656c  .app.        sel
+0000bd80: 662e 6164 6443 6c65 616e 7570 2873 656c  f.addCleanup(sel
+0000bd90: 662e 6861 726e 6573 732e 636c 6561 6e75  f.harness.cleanu
+0000bda0: 7029 0a0a 2020 2020 2320 5465 7374 7320  p)..    # Tests 
+0000bdb0: 6669 7820 666f 7220 6874 7470 733a 2f2f  fix for https://
+0000bdc0: 6769 7468 7562 2e63 6f6d 2f63 616e 6f6e  github.com/canon
+0000bdd0: 6963 616c 2f6f 7065 7261 746f 722f 6973  ical/operator/is
+0000bde0: 7375 6573 2f36 3934 2e0a 2020 2020 6465  sues/694..    de
+0000bdf0: 6620 7465 7374 5f6d 6f63 6b65 645f 6765  f test_mocked_ge
+0000be00: 745f 7365 7276 6963 6573 2873 656c 6629  t_services(self)
+0000be10: 3a0a 2020 2020 2020 2020 7365 6c66 2e68  :.        self.h
+0000be20: 6172 6e65 7373 2e62 6567 696e 2829 0a20  arness.begin(). 
+0000be30: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
+0000be40: 6573 732e 7365 745f 6361 6e5f 636f 6e6e  ess.set_can_conn
+0000be50: 6563 7428 2762 6172 272c 2054 7275 6529  ect('bar', True)
+0000be60: 0a20 2020 2020 2020 2063 203d 2073 656c  .        c = sel
+0000be70: 662e 6861 726e 6573 732e 6368 6172 6d2e  f.harness.charm.
+0000be80: 756e 6974 2e67 6574 5f63 6f6e 7461 696e  unit.get_contain
+0000be90: 6572 2827 6261 7227 290a 2020 2020 2020  er('bar').      
+0000bea0: 2020 632e 6164 645f 6c61 7965 7228 276c    c.add_layer('l
+0000beb0: 6179 6572 3127 2c20 7b0a 2020 2020 2020  ayer1', {.      
+0000bec0: 2020 2020 2020 2773 756d 6d61 7279 273a        'summary':
+0000bed0: 2027 6c61 7965 7227 2c0a 2020 2020 2020   'layer',.      
+0000bee0: 2020 2020 2020 2773 6572 7669 6365 7327        'services'
+0000bef0: 3a20 7b22 6261 7a22 3a20 7b27 6f76 6572  : {"baz": {'over
+0000bf00: 7269 6465 273a 2027 7265 706c 6163 6527  ride': 'replace'
+0000bf10: 2c20 2773 756d 6d61 7279 273a 2027 6563  , 'summary': 'ec
+0000bf20: 686f 272c 2027 636f 6d6d 616e 6427 3a20  ho', 'command': 
+0000bf30: 2765 6368 6f20 3127 7d7d 2c0a 2020 2020  'echo 1'}},.    
+0000bf40: 2020 2020 7d29 0a0a 2020 2020 2020 2020      })..        
+0000bf50: 7320 3d20 632e 6765 745f 7365 7276 6963  s = c.get_servic
+0000bf60: 6528 2762 617a 2729 2020 2320 536f 2066  e('baz')  # So f
+0000bf70: 6172 2c20 736f 2067 6f6f 640a 2020 2020  ar, so good.    
+0000bf80: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+0000bf90: 7275 6528 7329 0a20 2020 2020 2020 2073  rue(s).        s
+0000bfa0: 656c 662e 6173 7365 7274 5472 7565 2827  elf.assertTrue('
+0000bfb0: 6261 7a27 2069 6e20 632e 6765 745f 7365  baz' in c.get_se
+0000bfc0: 7276 6963 6573 2829 290a 0a20 2020 2064  rvices())..    d
+0000bfd0: 6566 2074 6573 745f 706c 616e 6e65 645f  ef test_planned_
+0000bfe0: 756e 6974 7328 7365 6c66 293a 0a20 2020  units(self):.   
+0000bff0: 2020 2020 2072 656c 5f69 6420 3d20 7365       rel_id = se
+0000c000: 6c66 2e70 6565 725f 7265 6c5f 6964 0a0a  lf.peer_rel_id..
+0000c010: 2020 2020 2020 2020 2320 5465 7374 2074          # Test t
+0000c020: 6861 7420 7765 2061 6c77 6179 7320 636f  hat we always co
+0000c030: 756e 7420 6f75 7273 656c 662e 0a20 2020  unt ourself..   
+0000c040: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000c050: 4571 7561 6c28 7365 6c66 2e61 7070 2e70  Equal(self.app.p
+0000c060: 6c61 6e6e 6564 5f75 6e69 7473 2829 2c20  lanned_units(), 
+0000c070: 3129 0a0a 2020 2020 2020 2020 2320 4164  1)..        # Ad
+0000c080: 6420 736f 6d65 2075 6e69 7473 2c20 616e  d some units, an
+0000c090: 6420 7665 7269 6679 2063 6f75 6e74 2e0a  d verify count..
+0000c0a0: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
+0000c0b0: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+0000c0c0: 6e5f 756e 6974 2872 656c 5f69 642c 2027  n_unit(rel_id, '
+0000c0d0: 6d79 6170 702f 3127 290a 2020 2020 2020  myapp/1').      
+0000c0e0: 2020 7365 6c66 2e68 6172 6e65 7373 2e61    self.harness.a
+0000c0f0: 6464 5f72 656c 6174 696f 6e5f 756e 6974  dd_relation_unit
+0000c100: 2872 656c 5f69 642c 2027 6d79 6170 702f  (rel_id, 'myapp/
+0000c110: 3227 290a 0a20 2020 2020 2020 2073 656c  2')..        sel
+0000c120: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0000c130: 6c66 2e61 7070 2e70 6c61 6e6e 6564 5f75  lf.app.planned_u
+0000c140: 6e69 7473 2829 2c20 3329 0a0a 2020 2020  nits(), 3)..    
+0000c150: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+0000c160: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
+0000c170: 6974 2872 656c 5f69 642c 2027 6d79 6170  it(rel_id, 'myap
+0000c180: 702f 3327 290a 2020 2020 2020 2020 7365  p/3').        se
+0000c190: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000c1a0: 656c 662e 6170 702e 706c 616e 6e65 645f  elf.app.planned_
+0000c1b0: 756e 6974 7328 292c 2034 290a 0a20 2020  units(), 4)..   
+0000c1c0: 2020 2020 2023 2041 6e64 2072 656d 6f76       # And remov
+0000c1d0: 6520 6120 756e 6974 0a20 2020 2020 2020  e a unit.       
+0000c1e0: 2073 656c 662e 6861 726e 6573 732e 7265   self.harness.re
+0000c1f0: 6d6f 7665 5f72 656c 6174 696f 6e5f 756e  move_relation_un
+0000c200: 6974 2872 656c 5f69 642c 2027 6d79 6170  it(rel_id, 'myap
+0000c210: 702f 3227 290a 0a20 2020 2020 2020 2073  p/2')..        s
+0000c220: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000c230: 7365 6c66 2e61 7070 2e70 6c61 6e6e 6564  self.app.planned
+0000c240: 5f75 6e69 7473 2829 2c20 3329 0a0a 2020  _units(), 3)..  
+0000c250: 2020 6465 6620 7465 7374 5f70 6c61 6e6e    def test_plann
+0000c260: 6564 5f75 6e69 7473 5f75 7365 725f 7365  ed_units_user_se
+0000c270: 7428 7365 6c66 293a 0a0a 2020 2020 2020  t(self):..      
+0000c280: 2020 7365 6c66 2e68 6172 6e65 7373 2e73    self.harness.s
+0000c290: 6574 5f70 6c61 6e6e 6564 5f75 6e69 7473  et_planned_units
+0000c2a0: 2831 290a 2020 2020 2020 2020 7365 6c66  (1).        self
+0000c2b0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
+0000c2c0: 662e 6170 702e 706c 616e 6e65 645f 756e  f.app.planned_un
+0000c2d0: 6974 7328 292c 2031 290a 0a20 2020 2020  its(), 1)..     
+0000c2e0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+0000c2f0: 7365 745f 706c 616e 6e65 645f 756e 6974  set_planned_unit
+0000c300: 7328 3229 0a20 2020 2020 2020 2073 656c  s(2).        sel
+0000c310: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0000c320: 6c66 2e61 7070 2e70 6c61 6e6e 6564 5f75  lf.app.planned_u
+0000c330: 6e69 7473 2829 2c20 3229 0a0a 2020 2020  nits(), 2)..    
+0000c340: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+0000c350: 2e73 6574 5f70 6c61 6e6e 6564 5f75 6e69  .set_planned_uni
+0000c360: 7473 2831 3030 290a 2020 2020 2020 2020  ts(100).        
+0000c370: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000c380: 2873 656c 662e 6170 702e 706c 616e 6e65  (self.app.planne
+0000c390: 645f 756e 6974 7328 292c 2031 3030 290a  d_units(), 100).
+0000c3a0: 0a20 2020 2064 6566 2074 6573 745f 706c  .    def test_pl
+0000c3b0: 616e 6e65 645f 756e 6974 735f 6761 7262  anned_units_garb
+0000c3c0: 6167 655f 7661 6c75 6573 2873 656c 6629  age_values(self)
+0000c3d0: 3a0a 2020 2020 2020 2020 2320 506c 616e  :.        # Plan
+0000c3e0: 6e65 6420 756e 6974 7320 7368 6f75 6c64  ned units should
+0000c3f0: 2062 6520 6120 706f 7369 7469 7665 2069   be a positive i
+0000c400: 6e74 6567 6572 2c20 6f72 207a 6572 6f2e  nteger, or zero.
+0000c410: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+0000c420: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+0000c430: 5479 7065 4572 726f 7229 3a0a 2020 2020  TypeError):.    
+0000c440: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
+0000c450: 6e65 7373 2e73 6574 5f70 6c61 6e6e 6564  ness.set_planned
+0000c460: 5f75 6e69 7473 282d 3129 0a20 2020 2020  _units(-1).     
+0000c470: 2020 2023 2056 6572 6966 7920 7468 6174     # Verify that
+0000c480: 2077 6520 6469 646e 2774 2073 6574 206f   we didn't set o
+0000c490: 7572 2076 616c 7565 2062 6566 6f72 6520  ur value before 
+0000c4a0: 7261 6973 696e 6720 7468 6520 6572 726f  raising the erro
+0000c4b0: 722e 0a20 2020 2020 2020 2073 656c 662e  r..        self.
+0000c4c0: 6173 7365 7274 5472 7565 2873 656c 662e  assertTrue(self.
+0000c4d0: 6861 726e 6573 732e 5f62 6163 6b65 6e64  harness._backend
+0000c4e0: 2e5f 706c 616e 6e65 645f 756e 6974 7320  ._planned_units 
+0000c4f0: 6973 204e 6f6e 6529 0a20 2020 2020 2020  is None).       
+0000c500: 2023 2056 6572 6966 7920 7468 6174 2077   # Verify that w
+0000c510: 6520 7374 696c 6c20 6765 7420 7468 6520  e still get the 
+0000c520: 6465 6661 756c 7420 7661 6c75 6520 6261  default value ba
+0000c530: 636b 2066 726f 6d20 2e70 6c61 6e6e 6564  ck from .planned
+0000c540: 5f75 6e69 7473 2e0a 2020 2020 2020 2020  _units..        
+0000c550: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000c560: 2873 656c 662e 6170 702e 706c 616e 6e65  (self.app.planne
+0000c570: 645f 756e 6974 7328 292c 2031 290a 0a20  d_units(), 1).. 
+0000c580: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+0000c590: 2e61 7373 6572 7452 6169 7365 7328 5479  .assertRaises(Ty
+0000c5a0: 7065 4572 726f 7229 3a0a 2020 2020 2020  peError):.      
+0000c5b0: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
+0000c5c0: 7373 2e73 6574 5f70 6c61 6e6e 6564 5f75  ss.set_planned_u
+0000c5d0: 6e69 7473 2822 666f 6f22 290a 0a20 2020  nits("foo")..   
+0000c5e0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0000c5f0: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
+0000c600: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+0000c610: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+0000c620: 2e73 6574 5f70 6c61 6e6e 6564 5f75 6e69  .set_planned_uni
+0000c630: 7473 282d 3334 3233 3030 3031 3032 3331  ts(-342300010231
+0000c640: 3233 3231 3039 3029 0a0a 2020 2020 6465  2321090)..    de
+0000c650: 6620 7465 7374 5f70 6c61 6e6e 6564 5f75  f test_planned_u
+0000c660: 6e69 7473 5f6f 7665 7272 6964 6528 7365  nits_override(se
+0000c670: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
+0000c680: 5665 7269 6679 2074 6861 7420 7765 206f  Verify that we o
+0000c690: 7665 7272 6964 6520 7468 6520 6361 6c63  verride the calc
+0000c6a0: 756c 6174 6564 2076 616c 7565 206f 6620  ulated value of 
+0000c6b0: 706c 616e 6e65 645f 756e 6974 7320 7768  planned_units wh
+0000c6c0: 656e 2077 6520 7365 7420 6974 206d 616e  en we set it man
+0000c6d0: 7561 6c6c 792e 0a0a 2020 2020 2020 2020  ually...        
+0000c6e0: 5768 656e 2061 2063 6861 726d 2061 7574  When a charm aut
+0000c6f0: 686f 7220 7772 6974 6573 2061 2074 6573  hor writes a tes
+0000c700: 7420 7468 6174 2065 7870 6c69 6369 746c  t that explicitl
+0000c710: 7920 6361 6c6c 7320 7365 745f 706c 616e  y calls set_plan
+0000c720: 6e65 645f 756e 6974 732c 2077 6520 6173  ned_units, we as
+0000c730: 7375 6d65 2074 6861 740a 2020 2020 2020  sume that.      
+0000c740: 2020 7468 6569 7220 696e 7465 6e74 2069    their intent i
+0000c750: 7320 746f 206f 7665 7272 6964 6520 7468  s to override th
+0000c760: 6520 6361 6c63 756c 6174 6564 2072 6574  e calculated ret
+0000c770: 7572 6e20 7661 6c75 652e 204f 6674 656e  urn value. Often
+0000c780: 2c20 7468 6973 2077 696c 6c20 6265 2062  , this will be b
+0000c790: 6563 6175 7365 2074 6865 0a20 2020 2020  ecause the.     
+0000c7a0: 2020 2063 6861 726d 2061 7574 686f 7220     charm author 
+0000c7b0: 6973 2063 6f6d 706f 7369 6e67 2061 2063  is composing a c
+0000c7c0: 6861 726d 2077 6974 686f 7574 2070 6565  harm without pee
+0000c7d0: 7220 7265 6c61 7469 6f6e 732c 2061 6e64  r relations, and
+0000c7e0: 2074 6865 2068 6172 6e65 7373 2773 2063   the harness's c
+0000c7f0: 6f75 6e74 206f 660a 2020 2020 2020 2020  ount of.        
+0000c800: 706c 616e 6e65 6420 756e 6974 732c 2077  planned units, w
+0000c810: 6869 6368 2069 7320 6261 7365 6420 6f6e  hich is based on
+0000c820: 2074 6865 206e 756d 6265 7220 6f66 2070   the number of p
+0000c830: 6565 7220 7265 6c61 7469 6f6e 732c 2077  eer relations, w
+0000c840: 696c 6c20 6e6f 7420 6265 2061 6363 7572  ill not be accur
+0000c850: 6174 652e 0a20 2020 2020 2020 2022 2222  ate..        """
+0000c860: 0a20 2020 2020 2020 2070 6565 725f 6964  .        peer_id
+0000c870: 203d 2073 656c 662e 7065 6572 5f72 656c   = self.peer_rel
+0000c880: 5f69 640a 0a20 2020 2020 2020 2073 656c  _id..        sel
+0000c890: 662e 6861 726e 6573 732e 7365 745f 706c  f.harness.set_pl
+0000c8a0: 616e 6e65 645f 756e 6974 7328 3130 290a  anned_units(10).
+0000c8b0: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
+0000c8c0: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+0000c8d0: 6e5f 756e 6974 2870 6565 725f 6964 2c20  n_unit(peer_id, 
+0000c8e0: 276d 7961 7070 2f31 2729 0a20 2020 2020  'myapp/1').     
+0000c8f0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+0000c900: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
+0000c910: 7428 7065 6572 5f69 642c 2027 6d79 6170  t(peer_id, 'myap
+0000c920: 702f 3227 290a 2020 2020 2020 2020 7365  p/2').        se
+0000c930: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
+0000c940: 656c 6174 696f 6e5f 756e 6974 2870 6565  elation_unit(pee
+0000c950: 725f 6964 2c20 276d 7961 7070 2f33 2729  r_id, 'myapp/3')
+0000c960: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+0000c970: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+0000c980: 6170 702e 706c 616e 6e65 645f 756e 6974  app.planned_unit
+0000c990: 7328 292c 2031 3029 0a0a 2020 2020 2020  s(), 10)..      
+0000c9a0: 2020 2320 5665 7269 6679 2074 6861 7420    # Verify that 
+0000c9b0: 7765 2063 616e 2063 6c65 6172 2074 6865  we can clear the
+0000c9c0: 206f 7665 7272 6964 652e 0a20 2020 2020   override..     
+0000c9d0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+0000c9e0: 7265 7365 745f 706c 616e 6e65 645f 756e  reset_planned_un
+0000c9f0: 6974 7328 290a 2020 2020 2020 2020 7365  its().        se
+0000ca00: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000ca10: 656c 662e 6170 702e 706c 616e 6e65 645f  elf.app.planned_
+0000ca20: 756e 6974 7328 292c 2034 2920 2023 2073  units(), 4)  # s
+0000ca30: 656c 6620 2b20 3320 7065 6572 730a 0a0a  elf + 3 peers...
+0000ca40: 636c 6173 7320 5465 7374 436f 6e74 6169  class TestContai
+0000ca50: 6e65 7273 2875 6e69 7474 6573 742e 5465  ners(unittest.Te
+0000ca60: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
+0000ca70: 2073 6574 5570 2873 656c 6629 3a0a 2020   setUp(self):.  
+0000ca80: 2020 2020 2020 6d65 7461 203d 206f 7073        meta = ops
+0000ca90: 2e43 6861 726d 4d65 7461 2e66 726f 6d5f  .CharmMeta.from_
+0000caa0: 7961 6d6c 2822 2222 0a6e 616d 653a 206b  yaml(""".name: k
+0000cab0: 3873 2d63 6861 726d 0a63 6f6e 7461 696e  8s-charm.contain
+0000cac0: 6572 733a 0a20 2063 313a 0a20 2020 206b  ers:.  c1:.    k
+0000cad0: 3a20 760a 2020 6332 3a0a 2020 2020 6b3a  : v.  c2:.    k:
+0000cae0: 2076 0a22 2222 290a 2020 2020 2020 2020   v.""").        
+0000caf0: 6261 636b 656e 6420 3d20 5f4d 6f64 656c  backend = _Model
+0000cb00: 4261 636b 656e 6428 276d 7961 7070 2f30  Backend('myapp/0
+0000cb10: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0000cb20: 6d6f 6465 6c20 3d20 6f70 732e 4d6f 6465  model = ops.Mode
+0000cb30: 6c28 6d65 7461 2c20 6261 636b 656e 6429  l(meta, backend)
+0000cb40: 0a0a 2020 2020 6465 6620 7465 7374 5f75  ..    def test_u
+0000cb50: 6e69 745f 636f 6e74 6169 6e65 7273 2873  nit_containers(s
+0000cb60: 656c 6629 3a0a 2020 2020 2020 2020 636f  elf):.        co
+0000cb70: 6e74 6169 6e65 7273 203d 2073 656c 662e  ntainers = self.
+0000cb80: 6d6f 6465 6c2e 756e 6974 2e63 6f6e 7461  model.unit.conta
+0000cb90: 696e 6572 730a 2020 2020 2020 2020 7365  iners.        se
+0000cba0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000cbb0: 6f72 7465 6428 636f 6e74 6169 6e65 7273  orted(containers
+0000cbc0: 292c 205b 2763 3127 2c20 2763 3227 5d29  ), ['c1', 'c2'])
+0000cbd0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000cbe0: 7365 7274 4571 7561 6c28 6c65 6e28 636f  sertEqual(len(co
+0000cbf0: 6e74 6169 6e65 7273 292c 2032 290a 2020  ntainers), 2).  
+0000cc00: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000cc10: 7449 6e28 2763 3127 2c20 636f 6e74 6169  tIn('c1', contai
+0000cc20: 6e65 7273 290a 2020 2020 2020 2020 7365  ners).        se
+0000cc30: 6c66 2e61 7373 6572 7449 6e28 2763 3227  lf.assertIn('c2'
+0000cc40: 2c20 636f 6e74 6169 6e65 7273 290a 2020  , containers).  
+0000cc50: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000cc60: 744e 6f74 496e 2827 6333 272c 2063 6f6e  tNotIn('c3', con
+0000cc70: 7461 696e 6572 7329 0a20 2020 2020 2020  tainers).       
+0000cc80: 2066 6f72 206e 616d 6520 696e 205b 2763   for name in ['c
+0000cc90: 3127 2c20 2763 3227 5d3a 0a20 2020 2020  1', 'c2']:.     
+0000cca0: 2020 2020 2020 2063 6f6e 7461 696e 6572         container
+0000ccb0: 203d 2063 6f6e 7461 696e 6572 735b 6e61   = containers[na
+0000ccc0: 6d65 5d0a 2020 2020 2020 2020 2020 2020  me].            
+0000ccd0: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
+0000cce0: 7461 6e63 6528 636f 6e74 6169 6e65 722c  tance(container,
+0000ccf0: 206f 7073 2e43 6f6e 7461 696e 6572 290a   ops.Container).
+0000cd00: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000cd10: 2e61 7373 6572 7445 7175 616c 2863 6f6e  .assertEqual(con
+0000cd20: 7461 696e 6572 2e6e 616d 652c 206e 616d  tainer.name, nam
+0000cd30: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
+0000cd40: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
+0000cd50: 616e 6365 2863 6f6e 7461 696e 6572 2e70  ance(container.p
+0000cd60: 6562 626c 652c 2070 6562 626c 652e 436c  ebble, pebble.Cl
+0000cd70: 6965 6e74 290a 2020 2020 2020 2020 7769  ient).        wi
+0000cd80: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0000cd90: 6973 6573 284b 6579 4572 726f 7229 3a0a  ises(KeyError):.
+0000cda0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0000cdb0: 6169 6e65 7273 5b27 6333 275d 0a0a 2020  ainers['c3']..  
+0000cdc0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+0000cdd0: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
+0000cde0: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
+0000cdf0: 2020 2020 2020 2020 6f74 6865 725f 756e          other_un
+0000ce00: 6974 203d 2073 656c 662e 6d6f 6465 6c2e  it = self.model.
+0000ce10: 6765 745f 756e 6974 2827 6f74 6865 7227  get_unit('other'
+0000ce20: 290a 2020 2020 2020 2020 2020 2020 6f74  ).            ot
+0000ce30: 6865 725f 756e 6974 2e63 6f6e 7461 696e  her_unit.contain
+0000ce40: 6572 730a 0a20 2020 2064 6566 2074 6573  ers..    def tes
+0000ce50: 745f 756e 6974 5f67 6574 5f63 6f6e 7461  t_unit_get_conta
+0000ce60: 696e 6572 2873 656c 6629 3a0a 2020 2020  iner(self):.    
+0000ce70: 2020 2020 756e 6974 203d 2073 656c 662e      unit = self.
+0000ce80: 6d6f 6465 6c2e 756e 6974 0a20 2020 2020  model.unit.     
+0000ce90: 2020 2066 6f72 206e 616d 6520 696e 205b     for name in [
+0000cea0: 2763 3127 2c20 2763 3227 5d3a 0a20 2020  'c1', 'c2']:.   
+0000ceb0: 2020 2020 2020 2020 2063 6f6e 7461 696e           contain
+0000cec0: 6572 203d 2075 6e69 742e 6765 745f 636f  er = unit.get_co
+0000ced0: 6e74 6169 6e65 7228 6e61 6d65 290a 2020  ntainer(name).  
+0000cee0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+0000cef0: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
+0000cf00: 636f 6e74 6169 6e65 722c 206f 7073 2e43  container, ops.C
+0000cf10: 6f6e 7461 696e 6572 290a 2020 2020 2020  ontainer).      
+0000cf20: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000cf30: 7445 7175 616c 2863 6f6e 7461 696e 6572  tEqual(container
+0000cf40: 2e6e 616d 652c 206e 616d 6529 0a20 2020  .name, name).   
+0000cf50: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+0000cf60: 7365 7274 4973 496e 7374 616e 6365 2863  sertIsInstance(c
+0000cf70: 6f6e 7461 696e 6572 2e70 6562 626c 652c  ontainer.pebble,
+0000cf80: 2070 6562 626c 652e 436c 6965 6e74 290a   pebble.Client).
+0000cf90: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+0000cfa0: 662e 6173 7365 7274 5261 6973 6573 286f  f.assertRaises(o
+0000cfb0: 7073 2e4d 6f64 656c 4572 726f 7229 3a0a  ps.ModelError):.
+0000cfc0: 2020 2020 2020 2020 2020 2020 756e 6974              unit
+0000cfd0: 2e67 6574 5f63 6f6e 7461 696e 6572 2827  .get_container('
+0000cfe0: 6333 2729 0a0a 2020 2020 2020 2020 7769  c3')..        wi
+0000cff0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0000d000: 6973 6573 2852 756e 7469 6d65 4572 726f  ises(RuntimeErro
+0000d010: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0000d020: 6f74 6865 725f 756e 6974 203d 2073 656c  other_unit = sel
+0000d030: 662e 6d6f 6465 6c2e 6765 745f 756e 6974  f.model.get_unit
+0000d040: 2827 6f74 6865 7227 290a 2020 2020 2020  ('other').      
+0000d050: 2020 2020 2020 6f74 6865 725f 756e 6974        other_unit
+0000d060: 2e67 6574 5f63 6f6e 7461 696e 6572 2827  .get_container('
+0000d070: 666f 6f27 290a 0a0a 636c 6173 7320 5465  foo')...class Te
+0000d080: 7374 436f 6e74 6169 6e65 7250 6562 626c  stContainerPebbl
+0000d090: 6528 756e 6974 7465 7374 2e54 6573 7443  e(unittest.TestC
+0000d0a0: 6173 6529 3a0a 2020 2020 6465 6620 7365  ase):.    def se
+0000d0b0: 7455 7028 7365 6c66 293a 0a20 2020 2020  tUp(self):.     
+0000d0c0: 2020 206d 6574 6120 3d20 6f70 732e 4368     meta = ops.Ch
+0000d0d0: 6172 6d4d 6574 612e 6672 6f6d 5f79 616d  armMeta.from_yam
+0000d0e0: 6c28 2222 220a 6e61 6d65 3a20 6b38 732d  l(""".name: k8s-
+0000d0f0: 6368 6172 6d0a 636f 6e74 6169 6e65 7273  charm.containers
+0000d100: 3a0a 2020 6331 3a0a 2020 2020 6b3a 2076  :.  c1:.    k: v
+0000d110: 0a22 2222 290a 2020 2020 2020 2020 6261  .""").        ba
+0000d120: 636b 656e 6420 3d20 4d6f 636b 5065 6262  ckend = MockPebb
+0000d130: 6c65 4261 636b 656e 6428 276d 7961 7070  leBackend('myapp
+0000d140: 2f30 2729 0a20 2020 2020 2020 2073 656c  /0').        sel
+0000d150: 662e 6d6f 6465 6c20 3d20 6f70 732e 4d6f  f.model = ops.Mo
+0000d160: 6465 6c28 6d65 7461 2c20 6261 636b 656e  del(meta, backen
+0000d170: 6429 0a20 2020 2020 2020 2073 656c 662e  d).        self.
+0000d180: 636f 6e74 6169 6e65 7220 3d20 7365 6c66  container = self
+0000d190: 2e6d 6f64 656c 2e75 6e69 742e 636f 6e74  .model.unit.cont
+0000d1a0: 6169 6e65 7273 5b27 6331 275d 0a20 2020  ainers['c1'].   
+0000d1b0: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
+0000d1c0: 203d 2073 656c 662e 636f 6e74 6169 6e65   = self.containe
+0000d1d0: 722e 7065 6262 6c65 0a0a 2020 2020 6465  r.pebble..    de
+0000d1e0: 6620 7465 7374 5f73 6f63 6b65 745f 7061  f test_socket_pa
+0000d1f0: 7468 2873 656c 6629 3a0a 2020 2020 2020  th(self):.      
+0000d200: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000d210: 616c 2873 656c 662e 7065 6262 6c65 2e73  al(self.pebble.s
+0000d220: 6f63 6b65 745f 7061 7468 2c20 272f 6368  ocket_path, '/ch
+0000d230: 6172 6d2f 636f 6e74 6169 6e65 7273 2f63  arm/containers/c
+0000d240: 312f 7065 6262 6c65 2e73 6f63 6b65 7427  1/pebble.socket'
+0000d250: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000d260: 6175 746f 7374 6172 7428 7365 6c66 293a  autostart(self):
+0000d270: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+0000d280: 6e74 6169 6e65 722e 6175 746f 7374 6172  ntainer.autostar
+0000d290: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+0000d2a0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
+0000d2b0: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
+0000d2c0: 732c 205b 2827 6175 746f 7374 6172 7427  s, [('autostart'
+0000d2d0: 2c29 5d29 0a0a 2020 2020 6465 6620 7465  ,)])..    def te
+0000d2e0: 7374 5f72 6570 6c61 6e28 7365 6c66 293a  st_replan(self):
+0000d2f0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+0000d300: 6e74 6169 6e65 722e 7265 706c 616e 2829  ntainer.replan()
+0000d310: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000d320: 7365 7274 4571 7561 6c28 7365 6c66 2e70  sertEqual(self.p
+0000d330: 6562 626c 652e 7265 7175 6573 7473 2c20  ebble.requests, 
+0000d340: 5b28 2772 6570 6c61 6e27 2c29 5d29 0a0a  [('replan',)])..
+0000d350: 2020 2020 6465 6620 7465 7374 5f63 616e      def test_can
+0000d360: 5f63 6f6e 6e65 6374 2873 656c 6629 3a0a  _connect(self):.
+0000d370: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+0000d380: 626c 652e 7265 7370 6f6e 7365 732e 6170  ble.responses.ap
+0000d390: 7065 6e64 2870 6562 626c 652e 5379 7374  pend(pebble.Syst
+0000d3a0: 656d 496e 666f 2e66 726f 6d5f 6469 6374  emInfo.from_dict
+0000d3b0: 287b 2776 6572 7369 6f6e 273a 2027 312e  ({'version': '1.
+0000d3c0: 302e 3027 7d29 290a 2020 2020 2020 2020  0.0'})).        
+0000d3d0: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+0000d3e0: 7365 6c66 2e63 6f6e 7461 696e 6572 2e63  self.container.c
+0000d3f0: 616e 5f63 6f6e 6e65 6374 2829 290a 2020  an_connect()).  
+0000d400: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000d410: 7445 7175 616c 2873 656c 662e 7065 6262  tEqual(self.pebb
+0000d420: 6c65 2e72 6571 7565 7374 732c 205b 2827  le.requests, [('
+0000d430: 6765 745f 7379 7374 656d 5f69 6e66 6f27  get_system_info'
+0000d440: 2c29 5d29 0a0a 2020 2020 6465 6620 7465  ,)])..    def te
+0000d450: 7374 5f73 7461 7274 2873 656c 6629 3a0a  st_start(self):.
+0000d460: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+0000d470: 7461 696e 6572 2e73 7461 7274 2827 666f  tainer.start('fo
+0000d480: 6f27 290a 2020 2020 2020 2020 7365 6c66  o').        self
+0000d490: 2e63 6f6e 7461 696e 6572 2e73 7461 7274  .container.start
+0000d4a0: 2827 666f 6f27 2c20 2762 6172 2729 0a20  ('foo', 'bar'). 
+0000d4b0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000d4c0: 7274 4571 7561 6c28 7365 6c66 2e70 6562  rtEqual(self.peb
+0000d4d0: 626c 652e 7265 7175 6573 7473 2c20 5b0a  ble.requests, [.
+0000d4e0: 2020 2020 2020 2020 2020 2020 2827 7374              ('st
+0000d4f0: 6172 7427 2c20 2827 666f 6f27 2c29 292c  art', ('foo',)),
+0000d500: 0a20 2020 2020 2020 2020 2020 2028 2773  .            ('s
+0000d510: 7461 7274 272c 2028 2766 6f6f 272c 2027  tart', ('foo', '
+0000d520: 6261 7227 2929 2c0a 2020 2020 2020 2020  bar')),.        
+0000d530: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
+0000d540: 5f73 7461 7274 5f6e 6f5f 6172 6775 6d65  _start_no_argume
+0000d550: 6e74 7328 7365 6c66 293a 0a20 2020 2020  nts(self):.     
+0000d560: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+0000d570: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
+0000d580: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+0000d590: 2020 7365 6c66 2e63 6f6e 7461 696e 6572    self.container
+0000d5a0: 2e73 7461 7274 2829 0a0a 2020 2020 6465  .start()..    de
+0000d5b0: 6620 7465 7374 5f73 746f 7028 7365 6c66  f test_stop(self
+0000d5c0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0000d5d0: 636f 6e74 6169 6e65 722e 7374 6f70 2827  container.stop('
+0000d5e0: 666f 6f27 290a 2020 2020 2020 2020 7365  foo').        se
+0000d5f0: 6c66 2e63 6f6e 7461 696e 6572 2e73 746f  lf.container.sto
+0000d600: 7028 2766 6f6f 272c 2027 6261 7227 290a  p('foo', 'bar').
+0000d610: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000d620: 6572 7445 7175 616c 2873 656c 662e 7065  ertEqual(self.pe
+0000d630: 6262 6c65 2e72 6571 7565 7374 732c 205b  bble.requests, [
+0000d640: 0a20 2020 2020 2020 2020 2020 2028 2773  .            ('s
+0000d650: 746f 7027 2c20 2827 666f 6f27 2c29 292c  top', ('foo',)),
+0000d660: 0a20 2020 2020 2020 2020 2020 2028 2773  .            ('s
+0000d670: 746f 7027 2c20 2827 666f 6f27 2c20 2762  top', ('foo', 'b
+0000d680: 6172 2729 292c 0a20 2020 2020 2020 205d  ar')),.        ]
+0000d690: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000d6a0: 7374 6f70 5f6e 6f5f 6172 6775 6d65 6e74  stop_no_argument
+0000d6b0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0000d6c0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+0000d6d0: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
+0000d6e0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0000d6f0: 7365 6c66 2e63 6f6e 7461 696e 6572 2e73  self.container.s
+0000d700: 746f 7028 290a 0a20 2020 2064 6566 2074  top()..    def t
+0000d710: 6573 745f 7265 7374 6172 7428 7365 6c66  est_restart(self
+0000d720: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0000d730: 636f 6e74 6169 6e65 722e 7265 7374 6172  container.restar
+0000d740: 7428 2766 6f6f 2729 0a20 2020 2020 2020  t('foo').       
+0000d750: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
+0000d760: 7265 7374 6172 7428 2766 6f6f 272c 2027  restart('foo', '
+0000d770: 6261 7227 290a 2020 2020 2020 2020 7365  bar').        se
+0000d780: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000d790: 656c 662e 7065 6262 6c65 2e72 6571 7565  elf.pebble.reque
+0000d7a0: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+0000d7b0: 2020 2028 2772 6573 7461 7274 272c 2028     ('restart', (
+0000d7c0: 2766 6f6f 272c 2929 2c0a 2020 2020 2020  'foo',)),.      
+0000d7d0: 2020 2020 2020 2827 7265 7374 6172 7427        ('restart'
+0000d7e0: 2c20 2827 666f 6f27 2c20 2762 6172 2729  , ('foo', 'bar')
+0000d7f0: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
+0000d800: 2020 2064 6566 2074 6573 745f 7265 7374     def test_rest
+0000d810: 6172 745f 6661 6c6c 6261 636b 2873 656c  art_fallback(sel
+0000d820: 6629 3a0a 2020 2020 2020 2020 6465 6620  f):.        def 
+0000d830: 7265 7374 6172 745f 7365 7276 6963 6573  restart_services
+0000d840: 2873 6572 7669 6365 7329 3a0a 2020 2020  (services):.    
+0000d850: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+0000d860: 626c 652e 7265 7175 6573 7473 2e61 7070  ble.requests.app
+0000d870: 656e 6428 2827 7265 7374 6172 7427 2c20  end(('restart', 
+0000d880: 7365 7276 6963 6573 2929 0a20 2020 2020  services)).     
+0000d890: 2020 2020 2020 2072 6169 7365 2070 6562         raise peb
+0000d8a0: 626c 652e 4150 4945 7272 6f72 287b 7d2c  ble.APIError({},
+0000d8b0: 2034 3030 2c20 2222 2c20 2222 290a 0a20   400, "", "").. 
+0000d8c0: 2020 2020 2020 2073 656c 662e 7065 6262         self.pebb
+0000d8d0: 6c65 2e72 6573 7461 7274 5f73 6572 7669  le.restart_servi
+0000d8e0: 6365 7320 3d20 7265 7374 6172 745f 7365  ces = restart_se
+0000d8f0: 7276 6963 6573 0a20 2020 2020 2020 2023  rvices.        #
+0000d900: 2053 6574 7570 2074 6865 2050 6562 626c   Setup the Pebbl
+0000d910: 6520 636c 6965 6e74 2074 6f20 7265 7370  e client to resp
+0000d920: 6f6e 6420 746f 2061 2063 616c 6c20 746f  ond to a call to
+0000d930: 2067 6574 5f73 6572 7669 6365 7328 290a   get_services().
+0000d940: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+0000d950: 626c 652e 7265 7370 6f6e 7365 732e 6170  ble.responses.ap
+0000d960: 7065 6e64 285b 0a20 2020 2020 2020 2020  pend([.         
+0000d970: 2020 2070 6562 626c 652e 5365 7276 6963     pebble.Servic
+0000d980: 6549 6e66 6f2e 6672 6f6d 5f64 6963 7428  eInfo.from_dict(
+0000d990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d9a0: 207b 276e 616d 6527 3a20 2766 6f6f 272c   {'name': 'foo',
+0000d9b0: 2027 7374 6172 7475 7027 3a20 2765 6e61   'startup': 'ena
+0000d9c0: 626c 6564 272c 2027 6375 7272 656e 7427  bled', 'current'
+0000d9d0: 3a20 2761 6374 6976 6527 7d29 2c0a 2020  : 'active'}),.  
+0000d9e0: 2020 2020 2020 2020 2020 7065 6262 6c65            pebble
+0000d9f0: 2e53 6572 7669 6365 496e 666f 2e66 726f  .ServiceInfo.fro
+0000da00: 6d5f 6469 6374 280a 2020 2020 2020 2020  m_dict(.        
+0000da10: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
+0000da20: 2027 6261 7227 2c20 2773 7461 7274 7570   'bar', 'startup
+0000da30: 273a 2027 656e 6162 6c65 6427 2c20 2763  ': 'enabled', 'c
+0000da40: 7572 7265 6e74 273a 2027 696e 6163 7469  urrent': 'inacti
+0000da50: 7665 277d 292c 0a20 2020 2020 2020 205d  ve'}),.        ]
+0000da60: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0000da70: 636f 6e74 6169 6e65 722e 7265 7374 6172  container.restar
+0000da80: 7428 2766 6f6f 272c 2027 6261 7227 290a  t('foo', 'bar').
+0000da90: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000daa0: 6572 7445 7175 616c 2873 656c 662e 7065  ertEqual(self.pe
+0000dab0: 6262 6c65 2e72 6571 7565 7374 732c 205b  bble.requests, [
+0000dac0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+0000dad0: 6869 7320 6973 2074 6865 2066 6972 7374  his is the first
+0000dae0: 2072 6571 7565 7374 2c20 7768 6963 6820   request, which 
+0000daf0: 696e 2072 6561 6c20 6c69 6665 2066 6169  in real life fai
+0000db00: 6c73 2077 6974 6820 4150 4945 7272 6f72  ls with APIError
+0000db10: 206f 6e20 6f6c 6465 7220 7665 7273 696f   on older versio
+0000db20: 6e73 0a20 2020 2020 2020 2020 2020 2028  ns.            (
+0000db30: 2772 6573 7461 7274 272c 2028 2766 6f6f  'restart', ('foo
+0000db40: 272c 2027 6261 7227 2929 2c0a 2020 2020  ', 'bar')),.    
+0000db50: 2020 2020 2020 2020 2320 4e65 7874 2074          # Next t
+0000db60: 6865 2063 6f64 6520 7368 6f75 6c64 206c  he code should l
+0000db70: 6f6f 7020 6f76 6572 2074 6865 2073 7461  oop over the sta
+0000db80: 7274 6564 2073 6572 7669 6365 732c 2061  rted services, a
+0000db90: 6e64 2073 746f 7020 7468 656d 0a20 2020  nd stop them.   
+0000dba0: 2020 2020 2020 2020 2028 2767 6574 5f73           ('get_s
+0000dbb0: 6572 7669 6365 7327 2c20 2827 666f 6f27  ervices', ('foo'
+0000dbc0: 2c20 2762 6172 2729 292c 0a20 2020 2020  , 'bar')),.     
+0000dbd0: 2020 2020 2020 2028 2773 746f 7027 2c20         ('stop', 
+0000dbe0: 2827 666f 6f27 2c29 292c 0a20 2020 2020  ('foo',)),.     
+0000dbf0: 2020 2020 2020 2023 2054 6865 6e20 7374         # Then st
+0000dc00: 6172 7420 616c 6c20 7468 6520 7370 6563  art all the spec
+0000dc10: 6966 6965 6420 7365 7276 6963 6573 0a20  ified services. 
+0000dc20: 2020 2020 2020 2020 2020 2028 2773 7461             ('sta
+0000dc30: 7274 272c 2028 2766 6f6f 272c 2027 6261  rt', ('foo', 'ba
+0000dc40: 7227 2929 0a20 2020 2020 2020 205d 290a  r')).        ]).
+0000dc50: 0a20 2020 2064 6566 2074 6573 745f 7265  .    def test_re
+0000dc60: 7374 6172 745f 6661 6c6c 6261 636b 5f6e  start_fallback_n
+0000dc70: 6f6e 5f34 3030 5f65 7272 6f72 2873 656c  on_400_error(sel
+0000dc80: 6629 3a0a 2020 2020 2020 2020 6465 6620  f):.        def 
+0000dc90: 7265 7374 6172 745f 7365 7276 6963 6573  restart_services
+0000dca0: 2873 6572 7669 6365 7329 3a0a 2020 2020  (services):.    
+0000dcb0: 2020 2020 2020 2020 7261 6973 6520 7065          raise pe
+0000dcc0: 6262 6c65 2e41 5049 4572 726f 7228 7b7d  bble.APIError({}
+0000dcd0: 2c20 3530 302c 2022 222c 2022 2229 0a0a  , 500, "", "")..
+0000dce0: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+0000dcf0: 626c 652e 7265 7374 6172 745f 7365 7276  ble.restart_serv
+0000dd00: 6963 6573 203d 2072 6573 7461 7274 5f73  ices = restart_s
+0000dd10: 6572 7669 6365 730a 2020 2020 2020 2020  ervices.        
+0000dd20: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0000dd30: 5261 6973 6573 2870 6562 626c 652e 4150  Raises(pebble.AP
+0000dd40: 4945 7272 6f72 2920 6173 2063 6d3a 0a20  IError) as cm:. 
+0000dd50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000dd60: 636f 6e74 6169 6e65 722e 7265 7374 6172  container.restar
+0000dd70: 7428 2766 6f6f 2729 0a20 2020 2020 2020  t('foo').       
+0000dd80: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000dd90: 6c28 636d 2e65 7863 6570 7469 6f6e 2e63  l(cm.exception.c
+0000dda0: 6f64 652c 2035 3030 290a 0a20 2020 2064  ode, 500)..    d
+0000ddb0: 6566 2074 6573 745f 7265 7374 6172 745f  ef test_restart_
+0000ddc0: 6e6f 5f61 7267 756d 656e 7473 2873 656c  no_arguments(sel
+0000ddd0: 6629 3a0a 2020 2020 2020 2020 7769 7468  f):.        with
+0000dde0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+0000ddf0: 6573 2854 7970 6545 7272 6f72 293a 0a20  es(TypeError):. 
+0000de00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000de10: 636f 6e74 6169 6e65 722e 7265 7374 6172  container.restar
+0000de20: 7428 290a 0a20 2020 2064 6566 2074 6573  t()..    def tes
+0000de30: 745f 7479 7065 5f65 7272 6f72 7328 7365  t_type_errors(se
+0000de40: 6c66 293a 0a20 2020 2020 2020 206d 6574  lf):.        met
+0000de50: 6120 3d20 6f70 732e 4368 6172 6d4d 6574  a = ops.CharmMet
+0000de60: 612e 6672 6f6d 5f79 616d 6c28 2222 220a  a.from_yaml(""".
+0000de70: 6e61 6d65 3a20 6b38 732d 6368 6172 6d0a  name: k8s-charm.
+0000de80: 636f 6e74 6169 6e65 7273 3a0a 2020 6331  containers:.  c1
+0000de90: 3a0a 2020 2020 6b3a 2076 0a22 2222 290a  :.    k: v.""").
+0000dea0: 2020 2020 2020 2020 2320 4f6e 6c79 2074          # Only t
+0000deb0: 6865 2072 6561 6c20 7065 6262 6c65 2043  he real pebble C
+0000dec0: 6c69 656e 7420 6368 6563 6b73 2074 7970  lient checks typ
+0000ded0: 6573 2c20 736f 2075 7365 2061 6374 7561  es, so use actua
+0000dee0: 6c20 6261 636b 656e 6420 636c 6173 730a  l backend class.
+0000def0: 2020 2020 2020 2020 6261 636b 656e 6420          backend 
+0000df00: 3d20 5f4d 6f64 656c 4261 636b 656e 6428  = _ModelBackend(
+0000df10: 276d 7961 7070 2f30 2729 0a20 2020 2020  'myapp/0').     
+0000df20: 2020 206d 6f64 656c 203d 206f 7073 2e4d     model = ops.M
+0000df30: 6f64 656c 286d 6574 612c 2062 6163 6b65  odel(meta, backe
+0000df40: 6e64 290a 2020 2020 2020 2020 636f 6e74  nd).        cont
+0000df50: 6169 6e65 7220 3d20 6d6f 6465 6c2e 756e  ainer = model.un
+0000df60: 6974 2e63 6f6e 7461 696e 6572 735b 2763  it.containers['c
+0000df70: 3127 5d0a 0a20 2020 2020 2020 2077 6974  1']..        wit
+0000df80: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+0000df90: 7365 7328 5479 7065 4572 726f 7229 3a0a  ses(TypeError):.
+0000dfa0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0000dfb0: 6169 6e65 722e 7374 6172 7428 5b27 666f  ainer.start(['fo
+0000dfc0: 6f27 5d29 0a0a 2020 2020 2020 2020 7769  o'])..        wi
+0000dfd0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0000dfe0: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
+0000dff0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0000e000: 7461 696e 6572 2e73 746f 7028 5b27 666f  tainer.stop(['fo
+0000e010: 6f27 5d29 0a0a 2020 2020 6465 6620 7465  o'])..    def te
+0000e020: 7374 5f61 6464 5f6c 6179 6572 2873 656c  st_add_layer(sel
+0000e030: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+0000e040: 2e63 6f6e 7461 696e 6572 2e61 6464 5f6c  .container.add_l
+0000e050: 6179 6572 2827 6127 2c20 2773 756d 6d61  ayer('a', 'summa
+0000e060: 7279 3a20 7374 725c 6e27 290a 2020 2020  ry: str\n').    
+0000e070: 2020 2020 7365 6c66 2e63 6f6e 7461 696e      self.contain
+0000e080: 6572 2e61 6464 5f6c 6179 6572 2827 6227  er.add_layer('b'
+0000e090: 2c20 7b27 7375 6d6d 6172 7927 3a20 2764  , {'summary': 'd
+0000e0a0: 6963 7427 7d29 0a20 2020 2020 2020 2073  ict'}).        s
+0000e0b0: 656c 662e 636f 6e74 6169 6e65 722e 6164  elf.container.ad
+0000e0c0: 645f 6c61 7965 7228 2763 272c 2070 6562  d_layer('c', peb
+0000e0d0: 626c 652e 4c61 7965 7228 2773 756d 6d61  ble.Layer('summa
+0000e0e0: 7279 3a20 4c61 7965 7227 2929 0a20 2020  ry: Layer')).   
+0000e0f0: 2020 2020 2073 656c 662e 636f 6e74 6169       self.contai
+0000e100: 6e65 722e 6164 645f 6c61 7965 7228 2764  ner.add_layer('d
+0000e110: 272c 2027 7375 6d6d 6172 793a 2073 7472  ', 'summary: str
+0000e120: 5c6e 272c 2063 6f6d 6269 6e65 3d54 7275  \n', combine=Tru
+0000e130: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
+0000e140: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+0000e150: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
+0000e160: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+0000e170: 2827 6164 645f 6c61 7965 7227 2c20 2761  ('add_layer', 'a
+0000e180: 272c 2027 7375 6d6d 6172 793a 2073 7472  ', 'summary: str
+0000e190: 5c6e 272c 2046 616c 7365 292c 0a20 2020  \n', False),.   
+0000e1a0: 2020 2020 2020 2020 2028 2761 6464 5f6c           ('add_l
+0000e1b0: 6179 6572 272c 2027 6227 2c20 2773 756d  ayer', 'b', 'sum
+0000e1c0: 6d61 7279 3a20 6469 6374 5c6e 272c 2046  mary: dict\n', F
+0000e1d0: 616c 7365 292c 0a20 2020 2020 2020 2020  alse),.         
+0000e1e0: 2020 2028 2761 6464 5f6c 6179 6572 272c     ('add_layer',
+0000e1f0: 2027 6327 2c20 2773 756d 6d61 7279 3a20   'c', 'summary: 
+0000e200: 4c61 7965 725c 6e27 2c20 4661 6c73 6529  Layer\n', False)
+0000e210: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
+0000e220: 6164 645f 6c61 7965 7227 2c20 2764 272c  add_layer', 'd',
+0000e230: 2027 7375 6d6d 6172 793a 2073 7472 5c6e   'summary: str\n
+0000e240: 272c 2054 7275 6529 2c0a 2020 2020 2020  ', True),.      
+0000e250: 2020 5d29 0a0a 2020 2020 2020 2020 2320    ])..        # 
+0000e260: 636f 6d62 696e 6520 6973 2061 206b 6579  combine is a key
+0000e270: 776f 7264 2d6f 6e6c 7920 6172 6720 2873  word-only arg (s
+0000e280: 686f 756c 6420 6265 2063 6f6d 6269 6e65  hould be combine
+0000e290: 3d54 7275 6529 0a20 2020 2020 2020 2077  =True).        w
+0000e2a0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+0000e2b0: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
+0000e2c0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0000e2d0: 6c66 2e63 6f6e 7461 696e 6572 2e61 6464  lf.container.add
+0000e2e0: 5f6c 6179 6572 2827 7827 2c20 7b7d 2c20  _layer('x', {}, 
+0000e2f0: 5472 7565 290a 0a20 2020 2064 6566 2074  True)..    def t
+0000e300: 6573 745f 6765 745f 706c 616e 2873 656c  est_get_plan(sel
+0000e310: 6629 3a0a 2020 2020 2020 2020 706c 616e  f):.        plan
+0000e320: 5f79 616d 6c20 3d20 2773 6572 7669 6365  _yaml = 'service
+0000e330: 733a 5c6e 2066 6f6f 3a5c 6e20 206f 7665  s:\n foo:\n  ove
+0000e340: 7272 6964 653a 2072 6570 6c61 6365 5c6e  rride: replace\n
+0000e350: 2020 636f 6d6d 616e 643a 2062 6172 270a    command: bar'.
+0000e360: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+0000e370: 626c 652e 7265 7370 6f6e 7365 732e 6170  ble.responses.ap
+0000e380: 7065 6e64 2870 6562 626c 652e 506c 616e  pend(pebble.Plan
+0000e390: 2870 6c61 6e5f 7961 6d6c 2929 0a20 2020  (plan_yaml)).   
+0000e3a0: 2020 2020 2070 6c61 6e20 3d20 7365 6c66       plan = self
+0000e3b0: 2e63 6f6e 7461 696e 6572 2e67 6574 5f70  .container.get_p
+0000e3c0: 6c61 6e28 290a 2020 2020 2020 2020 7365  lan().        se
+0000e3d0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000e3e0: 656c 662e 7065 6262 6c65 2e72 6571 7565  elf.pebble.reque
+0000e3f0: 7374 732c 205b 2827 6765 745f 706c 616e  sts, [('get_plan
+0000e400: 272c 295d 290a 2020 2020 2020 2020 7365  ',)]).        se
+0000e410: 6c66 2e61 7373 6572 7449 7349 6e73 7461  lf.assertIsInsta
+0000e420: 6e63 6528 706c 616e 2c20 7065 6262 6c65  nce(plan, pebble
+0000e430: 2e50 6c61 6e29 0a20 2020 2020 2020 2073  .Plan).        s
+0000e440: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000e450: 706c 616e 2e74 6f5f 7961 6d6c 2829 2c20  plan.to_yaml(), 
+0000e460: 7961 6d6c 2e73 6166 655f 6475 6d70 2879  yaml.safe_dump(y
+0000e470: 616d 6c2e 7361 6665 5f6c 6f61 6428 706c  aml.safe_load(pl
+0000e480: 616e 5f79 616d 6c29 2929 0a0a 2020 2020  an_yaml)))..    
+0000e490: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+0000e4a0: 2020 6465 6620 5f6d 616b 655f 7365 7276    def _make_serv
+0000e4b0: 6963 6528 6e61 6d65 2c20 7374 6172 7475  ice(name, startu
+0000e4c0: 702c 2063 7572 7265 6e74 293a 0a20 2020  p, current):.   
+0000e4d0: 2020 2020 2072 6574 7572 6e20 7065 6262       return pebb
+0000e4e0: 6c65 2e53 6572 7669 6365 496e 666f 2e66  le.ServiceInfo.f
+0000e4f0: 726f 6d5f 6469 6374 280a 2020 2020 2020  rom_dict(.      
+0000e500: 2020 2020 2020 7b27 6e61 6d65 273a 206e        {'name': n
+0000e510: 616d 652c 2027 7374 6172 7475 7027 3a20  ame, 'startup': 
+0000e520: 7374 6172 7475 702c 2027 6375 7272 656e  startup, 'curren
+0000e530: 7427 3a20 6375 7272 656e 747d 290a 0a20  t': current}).. 
+0000e540: 2020 2064 6566 2074 6573 745f 6765 745f     def test_get_
+0000e550: 7365 7276 6963 6573 2873 656c 6629 3a0a  services(self):.
+0000e560: 2020 2020 2020 2020 7477 6f5f 7365 7276          two_serv
+0000e570: 6963 6573 203d 205b 0a20 2020 2020 2020  ices = [.       
+0000e580: 2020 2020 2073 656c 662e 5f6d 616b 655f       self._make_
+0000e590: 7365 7276 6963 6528 2773 3127 2c20 2765  service('s1', 'e
+0000e5a0: 6e61 626c 6564 272c 2027 6163 7469 7665  nabled', 'active
+0000e5b0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+0000e5c0: 7365 6c66 2e5f 6d61 6b65 5f73 6572 7669  self._make_servi
+0000e5d0: 6365 2827 7332 272c 2027 6469 7361 626c  ce('s2', 'disabl
+0000e5e0: 6564 272c 2027 696e 6163 7469 7665 2729  ed', 'inactive')
+0000e5f0: 2c0a 2020 2020 2020 2020 5d0a 2020 2020  ,.        ].    
+0000e600: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
+0000e610: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+0000e620: 2874 776f 5f73 6572 7669 6365 7329 0a20  (two_services). 
+0000e630: 2020 2020 2020 2073 6572 7669 6365 7320         services 
+0000e640: 3d20 7365 6c66 2e63 6f6e 7461 696e 6572  = self.container
+0000e650: 2e67 6574 5f73 6572 7669 6365 7328 290a  .get_services().
+0000e660: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000e670: 6572 7445 7175 616c 286c 656e 2873 6572  ertEqual(len(ser
+0000e680: 7669 6365 7329 2c20 3229 0a20 2020 2020  vices), 2).     
+0000e690: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000e6a0: 7561 6c28 7365 7428 7365 7276 6963 6573  ual(set(services
+0000e6b0: 292c 207b 2773 3127 2c20 2773 3227 7d29  ), {'s1', 's2'})
+0000e6c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000e6d0: 7365 7274 4571 7561 6c28 7365 7276 6963  sertEqual(servic
+0000e6e0: 6573 5b27 7331 275d 2e6e 616d 652c 2027  es['s1'].name, '
+0000e6f0: 7331 2729 0a20 2020 2020 2020 2073 656c  s1').        sel
+0000e700: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0000e710: 7276 6963 6573 5b27 7331 275d 2e73 7461  rvices['s1'].sta
+0000e720: 7274 7570 2c20 7065 6262 6c65 2e53 6572  rtup, pebble.Ser
+0000e730: 7669 6365 5374 6172 7475 702e 454e 4142  viceStartup.ENAB
+0000e740: 4c45 4429 0a20 2020 2020 2020 2073 656c  LED).        sel
+0000e750: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0000e760: 7276 6963 6573 5b27 7331 275d 2e63 7572  rvices['s1'].cur
+0000e770: 7265 6e74 2c20 7065 6262 6c65 2e53 6572  rent, pebble.Ser
+0000e780: 7669 6365 5374 6174 7573 2e41 4354 4956  viceStatus.ACTIV
+0000e790: 4529 0a20 2020 2020 2020 2073 656c 662e  E).        self.
+0000e7a0: 6173 7365 7274 4571 7561 6c28 7365 7276  assertEqual(serv
+0000e7b0: 6963 6573 5b27 7332 275d 2e6e 616d 652c  ices['s2'].name,
+0000e7c0: 2027 7332 2729 0a20 2020 2020 2020 2073   's2').        s
+0000e7d0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000e7e0: 7365 7276 6963 6573 5b27 7332 275d 2e73  services['s2'].s
+0000e7f0: 7461 7274 7570 2c20 7065 6262 6c65 2e53  tartup, pebble.S
+0000e800: 6572 7669 6365 5374 6172 7475 702e 4449  erviceStartup.DI
+0000e810: 5341 424c 4544 290a 2020 2020 2020 2020  SABLED).        
+0000e820: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000e830: 2873 6572 7669 6365 735b 2773 3227 5d2e  (services['s2'].
+0000e840: 6375 7272 656e 742c 2070 6562 626c 652e  current, pebble.
+0000e850: 5365 7276 6963 6553 7461 7475 732e 494e  ServiceStatus.IN
+0000e860: 4143 5449 5645 290a 0a20 2020 2020 2020  ACTIVE)..       
+0000e870: 2073 656c 662e 7065 6262 6c65 2e72 6573   self.pebble.res
+0000e880: 706f 6e73 6573 2e61 7070 656e 6428 7477  ponses.append(tw
+0000e890: 6f5f 7365 7276 6963 6573 290a 2020 2020  o_services).    
+0000e8a0: 2020 2020 7365 7276 6963 6573 203d 2073      services = s
+0000e8b0: 656c 662e 636f 6e74 6169 6e65 722e 6765  elf.container.ge
+0000e8c0: 745f 7365 7276 6963 6573 2827 7331 272c  t_services('s1',
+0000e8d0: 2027 7332 2729 0a20 2020 2020 2020 2073   's2').        s
+0000e8e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000e8f0: 6c65 6e28 7365 7276 6963 6573 292c 2032  len(services), 2
+0000e900: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000e910: 7373 6572 7445 7175 616c 2873 6574 2873  ssertEqual(set(s
+0000e920: 6572 7669 6365 7329 2c20 7b27 7331 272c  ervices), {'s1',
+0000e930: 2027 7332 277d 290a 2020 2020 2020 2020   's2'}).        
+0000e940: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000e950: 2873 6572 7669 6365 735b 2773 3127 5d2e  (services['s1'].
+0000e960: 6e61 6d65 2c20 2773 3127 290a 2020 2020  name, 's1').    
+0000e970: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000e980: 7175 616c 2873 6572 7669 6365 735b 2773  qual(services['s
+0000e990: 3127 5d2e 7374 6172 7475 702c 2070 6562  1'].startup, peb
+0000e9a0: 626c 652e 5365 7276 6963 6553 7461 7274  ble.ServiceStart
+0000e9b0: 7570 2e45 4e41 424c 4544 290a 2020 2020  up.ENABLED).    
+0000e9c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000e9d0: 7175 616c 2873 6572 7669 6365 735b 2773  qual(services['s
+0000e9e0: 3127 5d2e 6375 7272 656e 742c 2070 6562  1'].current, peb
+0000e9f0: 626c 652e 5365 7276 6963 6553 7461 7475  ble.ServiceStatu
+0000ea00: 732e 4143 5449 5645 290a 2020 2020 2020  s.ACTIVE).      
+0000ea10: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000ea20: 616c 2873 6572 7669 6365 735b 2773 3227  al(services['s2'
+0000ea30: 5d2e 6e61 6d65 2c20 2773 3227 290a 2020  ].name, 's2').  
+0000ea40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000ea50: 7445 7175 616c 2873 6572 7669 6365 735b  tEqual(services[
+0000ea60: 2773 3227 5d2e 7374 6172 7475 702c 2070  's2'].startup, p
+0000ea70: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
+0000ea80: 7274 7570 2e44 4953 4142 4c45 4429 0a20  rtup.DISABLED). 
+0000ea90: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000eaa0: 7274 4571 7561 6c28 7365 7276 6963 6573  rtEqual(services
+0000eab0: 5b27 7332 275d 2e63 7572 7265 6e74 2c20  ['s2'].current, 
+0000eac0: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
+0000ead0: 6174 7573 2e49 4e41 4354 4956 4529 0a0a  atus.INACTIVE)..
+0000eae0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000eaf0: 6572 7445 7175 616c 2873 656c 662e 7065  ertEqual(self.pe
+0000eb00: 6262 6c65 2e72 6571 7565 7374 732c 205b  bble.requests, [
+0000eb10: 0a20 2020 2020 2020 2020 2020 2028 2767  .            ('g
+0000eb20: 6574 5f73 6572 7669 6365 7327 2c20 4e6f  et_services', No
+0000eb30: 6e65 292c 0a20 2020 2020 2020 2020 2020  ne),.           
+0000eb40: 2028 2767 6574 5f73 6572 7669 6365 7327   ('get_services'
+0000eb50: 2c20 2827 7331 272c 2027 7332 2729 292c  , ('s1', 's2')),
+0000eb60: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
+0000eb70: 2064 6566 2074 6573 745f 6765 745f 7365   def test_get_se
+0000eb80: 7276 6963 6528 7365 6c66 293a 0a20 2020  rvice(self):.   
+0000eb90: 2020 2020 2023 2053 696e 676c 6520 7365       # Single se
+0000eba0: 7276 6963 6520 7265 7475 726e 6564 2073  rvice returned s
+0000ebb0: 7563 6365 7373 6675 6c6c 790a 2020 2020  uccessfully.    
+0000ebc0: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
+0000ebd0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+0000ebe0: 285b 7365 6c66 2e5f 6d61 6b65 5f73 6572  ([self._make_ser
+0000ebf0: 7669 6365 2827 7331 272c 2027 656e 6162  vice('s1', 'enab
+0000ec00: 6c65 6427 2c20 2761 6374 6976 6527 295d  led', 'active')]
+0000ec10: 290a 2020 2020 2020 2020 7320 3d20 7365  ).        s = se
+0000ec20: 6c66 2e63 6f6e 7461 696e 6572 2e67 6574  lf.container.get
+0000ec30: 5f73 6572 7669 6365 2827 7331 2729 0a20  _service('s1'). 
+0000ec40: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000ec50: 7274 4571 7561 6c28 7365 6c66 2e70 6562  rtEqual(self.peb
+0000ec60: 626c 652e 7265 7175 6573 7473 2c20 5b28  ble.requests, [(
+0000ec70: 2767 6574 5f73 6572 7669 6365 7327 2c20  'get_services', 
+0000ec80: 2827 7331 272c 2029 295d 290a 2020 2020  ('s1', ))]).    
+0000ec90: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000eca0: 7175 616c 2873 2e6e 616d 652c 2027 7331  qual(s.name, 's1
+0000ecb0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0000ecc0: 6173 7365 7274 4571 7561 6c28 732e 7374  assertEqual(s.st
+0000ecd0: 6172 7475 702c 2070 6562 626c 652e 5365  artup, pebble.Se
+0000ece0: 7276 6963 6553 7461 7274 7570 2e45 4e41  rviceStartup.ENA
+0000ecf0: 424c 4544 290a 2020 2020 2020 2020 7365  BLED).        se
+0000ed00: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000ed10: 2e63 7572 7265 6e74 2c20 7065 6262 6c65  .current, pebble
+0000ed20: 2e53 6572 7669 6365 5374 6174 7573 2e41  .ServiceStatus.A
+0000ed30: 4354 4956 4529 0a0a 2020 2020 2020 2020  CTIVE)..        
+0000ed40: 2320 4966 2050 6562 626c 6520 7265 7475  # If Pebble retu
+0000ed50: 726e 7320 6e6f 2073 6572 7669 6365 732c  rns no services,
+0000ed60: 2073 686f 756c 6420 6265 2061 206f 7073   should be a ops
+0000ed70: 2e4d 6f64 656c 4572 726f 720a 2020 2020  .ModelError.    
+0000ed80: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
+0000ed90: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+0000eda0: 285b 5d29 0a20 2020 2020 2020 2077 6974  ([]).        wit
+0000edb0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+0000edc0: 7365 7328 6f70 732e 4d6f 6465 6c45 7272  ses(ops.ModelErr
+0000edd0: 6f72 2920 6173 2063 6d3a 0a20 2020 2020  or) as cm:.     
+0000ede0: 2020 2020 2020 2073 656c 662e 636f 6e74         self.cont
+0000edf0: 6169 6e65 722e 6765 745f 7365 7276 6963  ainer.get_servic
+0000ee00: 6528 2773 3227 290a 2020 2020 2020 2020  e('s2').        
+0000ee10: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000ee20: 2873 7472 2863 6d2e 6578 6365 7074 696f  (str(cm.exceptio
+0000ee30: 6e29 2c20 2273 6572 7669 6365 2027 7332  n), "service 's2
+0000ee40: 2720 6e6f 7420 666f 756e 6422 290a 0a20  ' not found").. 
+0000ee50: 2020 2020 2020 2023 2049 6620 5065 6262         # If Pebb
+0000ee60: 6c65 2072 6574 7572 6e73 206d 6f72 6520  le returns more 
+0000ee70: 7468 616e 206f 6e65 2073 6572 7669 6365  than one service
+0000ee80: 2c20 5275 6e74 696d 6545 7272 6f72 2069  , RuntimeError i
+0000ee90: 7320 7261 6973 6564 0a20 2020 2020 2020  s raised.       
+0000eea0: 2073 656c 662e 7065 6262 6c65 2e72 6573   self.pebble.res
+0000eeb0: 706f 6e73 6573 2e61 7070 656e 6428 5b0a  ponses.append([.
+0000eec0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000eed0: 2e5f 6d61 6b65 5f73 6572 7669 6365 2827  ._make_service('
+0000eee0: 7331 272c 2027 656e 6162 6c65 6427 2c20  s1', 'enabled', 
+0000eef0: 2761 6374 6976 6527 292c 0a20 2020 2020  'active'),.     
+0000ef00: 2020 2020 2020 2073 656c 662e 5f6d 616b         self._mak
+0000ef10: 655f 7365 7276 6963 6528 2773 3227 2c20  e_service('s2', 
+0000ef20: 2764 6973 6162 6c65 6427 2c20 2769 6e61  'disabled', 'ina
+0000ef30: 6374 6976 6527 292c 0a20 2020 2020 2020  ctive'),.       
+0000ef40: 205d 290a 2020 2020 2020 2020 7769 7468   ]).        with
+0000ef50: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+0000ef60: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
+0000ef70: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0000ef80: 6c66 2e63 6f6e 7461 696e 6572 2e67 6574  lf.container.get
+0000ef90: 5f73 6572 7669 6365 2827 7331 2729 0a0a  _service('s1')..
+0000efa0: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
+0000efb0: 5f63 6865 636b 7328 7365 6c66 293a 0a20  _checks(self):. 
+0000efc0: 2020 2020 2020 2072 6573 706f 6e73 655f         response_
+0000efd0: 6368 6563 6b73 203d 205b 0a20 2020 2020  checks = [.     
+0000efe0: 2020 2020 2020 2070 6562 626c 652e 4368         pebble.Ch
+0000eff0: 6563 6b49 6e66 6f2e 6672 6f6d 5f64 6963  eckInfo.from_dic
+0000f000: 7428 7b0a 2020 2020 2020 2020 2020 2020  t({.            
+0000f010: 2020 2020 276e 616d 6527 3a20 2763 3127      'name': 'c1'
 0000f020: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f030: 2020 2766 6169 6c75 7265 7327 3a20 302c    'failures': 0,
-0000f040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f050: 2027 7468 7265 7368 6f6c 6427 3a20 332c   'threshold': 3,
-0000f060: 0a20 2020 2020 2020 2020 2020 207d 290a  .            }).
-0000f070: 2020 2020 2020 2020 5d29 0a20 2020 2020          ]).     
-0000f080: 2020 2063 203d 2073 656c 662e 636f 6e74     c = self.cont
-0000f090: 6169 6e65 722e 6765 745f 6368 6563 6b28  ainer.get_check(
-0000f0a0: 2763 3127 290a 2020 2020 2020 2020 7365  'c1').        se
-0000f0b0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000f0c0: 656c 662e 7065 6262 6c65 2e72 6571 7565  elf.pebble.reque
-0000f0d0: 7374 732c 205b 2827 6765 745f 6368 6563  sts, [('get_chec
-0000f0e0: 6b73 272c 204e 6f6e 652c 2028 2763 3127  ks', None, ('c1'
-0000f0f0: 2c20 2929 5d29 0a20 2020 2020 2020 2073  , ))]).        s
-0000f100: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000f110: 632e 6e61 6d65 2c20 2763 3127 290a 2020  c.name, 'c1').  
-0000f120: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000f130: 7445 7175 616c 2863 2e6c 6576 656c 2c20  tEqual(c.level, 
-0000f140: 7065 6262 6c65 2e43 6865 636b 4c65 7665  pebble.CheckLeve
-0000f150: 6c2e 554e 5345 5429 0a20 2020 2020 2020  l.UNSET).       
-0000f160: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000f170: 6c28 632e 7374 6174 7573 2c20 7065 6262  l(c.status, pebb
-0000f180: 6c65 2e43 6865 636b 5374 6174 7573 2e55  le.CheckStatus.U
-0000f190: 5029 0a20 2020 2020 2020 2073 656c 662e  P).        self.
-0000f1a0: 6173 7365 7274 4571 7561 6c28 632e 6661  assertEqual(c.fa
-0000f1b0: 696c 7572 6573 2c20 3029 0a20 2020 2020  ilures, 0).     
-0000f1c0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000f1d0: 7561 6c28 632e 7468 7265 7368 6f6c 642c  ual(c.threshold,
-0000f1e0: 2033 290a 0a20 2020 2020 2020 2023 2049   3)..        # I
-0000f1f0: 6620 5065 6262 6c65 2072 6574 7572 6e73  f Pebble returns
-0000f200: 206e 6f20 6368 6563 6b73 2c20 7368 6f75   no checks, shou
-0000f210: 6c64 2062 6520 6120 6f70 732e 4d6f 6465  ld be a ops.Mode
-0000f220: 6c45 7272 6f72 0a20 2020 2020 2020 2073  lError.        s
-0000f230: 656c 662e 7065 6262 6c65 2e72 6573 706f  elf.pebble.respo
-0000f240: 6e73 6573 2e61 7070 656e 6428 5b5d 290a  nses.append([]).
-0000f250: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-0000f260: 662e 6173 7365 7274 5261 6973 6573 286f  f.assertRaises(o
-0000f270: 7073 2e4d 6f64 656c 4572 726f 7229 2061  ps.ModelError) a
-0000f280: 7320 636d 3a0a 2020 2020 2020 2020 2020  s cm:.          
-0000f290: 2020 7365 6c66 2e63 6f6e 7461 696e 6572    self.container
-0000f2a0: 2e67 6574 5f63 6865 636b 2827 6332 2729  .get_check('c2')
-0000f2b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000f2c0: 7365 7274 4571 7561 6c28 7374 7228 636d  sertEqual(str(cm
-0000f2d0: 2e65 7863 6570 7469 6f6e 292c 2022 6368  .exception), "ch
-0000f2e0: 6563 6b20 2763 3227 206e 6f74 2066 6f75  eck 'c2' not fou
-0000f2f0: 6e64 2229 0a0a 2020 2020 2020 2020 2320  nd")..        # 
-0000f300: 4966 2050 6562 626c 6520 7265 7475 726e  If Pebble return
-0000f310: 7320 6d6f 7265 2074 6861 6e20 6f6e 6520  s more than one 
-0000f320: 6368 6563 6b2c 2052 756e 7469 6d65 4572  check, RuntimeEr
-0000f330: 726f 7220 6973 2072 6169 7365 640a 2020  ror is raised.  
-0000f340: 2020 2020 2020 7365 6c66 2e70 6562 626c        self.pebbl
-0000f350: 652e 7265 7370 6f6e 7365 732e 6170 7065  e.responses.appe
-0000f360: 6e64 285b 0a20 2020 2020 2020 2020 2020  nd([.           
-0000f370: 2070 6562 626c 652e 4368 6563 6b49 6e66   pebble.CheckInf
-0000f380: 6f2e 6672 6f6d 5f64 6963 7428 7b0a 2020  o.from_dict({.  
-0000f390: 2020 2020 2020 2020 2020 2020 2020 276e                'n
-0000f3a0: 616d 6527 3a20 2763 3127 2c0a 2020 2020  ame': 'c1',.    
-0000f3b0: 2020 2020 2020 2020 2020 2020 2773 7461              'sta
-0000f3c0: 7475 7327 3a20 2775 7027 2c0a 2020 2020  tus': 'up',.    
-0000f3d0: 2020 2020 2020 2020 2020 2020 2766 6169              'fai
-0000f3e0: 6c75 7265 7327 3a20 302c 0a20 2020 2020  lures': 0,.     
-0000f3f0: 2020 2020 2020 2020 2020 2027 7468 7265             'thre
-0000f400: 7368 6f6c 6427 3a20 332c 0a20 2020 2020  shold': 3,.     
-0000f410: 2020 2020 2020 207d 292c 0a20 2020 2020         }),.     
-0000f420: 2020 2020 2020 2070 6562 626c 652e 4368         pebble.Ch
-0000f430: 6563 6b49 6e66 6f2e 6672 6f6d 5f64 6963  eckInfo.from_dic
-0000f440: 7428 7b0a 2020 2020 2020 2020 2020 2020  t({.            
-0000f450: 2020 2020 276e 616d 6527 3a20 2763 3227      'name': 'c2'
-0000f460: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f470: 2020 276c 6576 656c 273a 2027 616c 6976    'level': 'aliv
-0000f480: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-0000f490: 2020 2020 2773 7461 7475 7327 3a20 2764      'status': 'd
-0000f4a0: 6f77 6e27 2c0a 2020 2020 2020 2020 2020  own',.          
-0000f4b0: 2020 2020 2020 2766 6169 6c75 7265 7327        'failures'
-0000f4c0: 3a20 322c 0a20 2020 2020 2020 2020 2020  : 2,.           
-0000f4d0: 2020 2020 2027 7468 7265 7368 6f6c 6427       'threshold'
-0000f4e0: 3a20 322c 0a20 2020 2020 2020 2020 2020  : 2,.           
-0000f4f0: 207d 292c 0a20 2020 2020 2020 205d 290a   }),.        ]).
-0000f500: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-0000f510: 662e 6173 7365 7274 5261 6973 6573 2852  f.assertRaises(R
-0000f520: 756e 7469 6d65 4572 726f 7229 3a0a 2020  untimeError):.  
-0000f530: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-0000f540: 6f6e 7461 696e 6572 2e67 6574 5f63 6865  ontainer.get_che
-0000f550: 636b 2827 6331 2729 0a0a 2020 2020 6465  ck('c1')..    de
-0000f560: 6620 7465 7374 5f70 756c 6c28 7365 6c66  f test_pull(self
-0000f570: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000f580: 7065 6262 6c65 2e72 6573 706f 6e73 6573  pebble.responses
-0000f590: 2e61 7070 656e 6428 2764 756d 6d79 3127  .append('dummy1'
-0000f5a0: 290a 2020 2020 2020 2020 676f 7420 3d20  ).        got = 
-0000f5b0: 7365 6c66 2e63 6f6e 7461 696e 6572 2e70  self.container.p
-0000f5c0: 756c 6c28 272f 7061 7468 2f31 2729 0a20  ull('/path/1'). 
-0000f5d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000f5e0: 7274 4571 7561 6c28 676f 742c 2027 6475  rtEqual(got, 'du
-0000f5f0: 6d6d 7931 2729 0a20 2020 2020 2020 2073  mmy1').        s
-0000f600: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000f610: 7365 6c66 2e70 6562 626c 652e 7265 7175  self.pebble.requ
-0000f620: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
-0000f630: 2020 2020 2827 7075 6c6c 272c 2027 2f70      ('pull', '/p
-0000f640: 6174 682f 3127 2c20 2775 7466 2d38 2729  ath/1', 'utf-8')
-0000f650: 2c0a 2020 2020 2020 2020 5d29 0a20 2020  ,.        ]).   
-0000f660: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
-0000f670: 2e72 6571 7565 7374 7320 3d20 5b5d 0a0a  .requests = []..
-0000f680: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
-0000f690: 626c 652e 7265 7370 6f6e 7365 732e 6170  ble.responses.ap
-0000f6a0: 7065 6e64 2862 2764 756d 6d79 3227 290a  pend(b'dummy2').
-0000f6b0: 2020 2020 2020 2020 676f 7420 3d20 7365          got = se
-0000f6c0: 6c66 2e63 6f6e 7461 696e 6572 2e70 756c  lf.container.pul
-0000f6d0: 6c28 272f 7061 7468 2f32 272c 2065 6e63  l('/path/2', enc
-0000f6e0: 6f64 696e 673d 4e6f 6e65 290a 2020 2020  oding=None).    
-0000f6f0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000f700: 7175 616c 2867 6f74 2c20 6227 6475 6d6d  qual(got, b'dumm
-0000f710: 7932 2729 0a20 2020 2020 2020 2073 656c  y2').        sel
-0000f720: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000f730: 6c66 2e70 6562 626c 652e 7265 7175 6573  lf.pebble.reques
-0000f740: 7473 2c20 5b0a 2020 2020 2020 2020 2020  ts, [.          
-0000f750: 2020 2827 7075 6c6c 272c 2027 2f70 6174    ('pull', '/pat
-0000f760: 682f 3227 2c20 4e6f 6e65 292c 0a20 2020  h/2', None),.   
-0000f770: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
-0000f780: 2074 6573 745f 7075 7368 2873 656c 6629   test_push(self)
-0000f790: 3a0a 2020 2020 2020 2020 7365 6c66 2e63  :.        self.c
-0000f7a0: 6f6e 7461 696e 6572 2e70 7573 6828 272f  ontainer.push('/
-0000f7b0: 7061 7468 2f31 272c 2027 636f 6e74 656e  path/1', 'conten
-0000f7c0: 7431 2729 0a20 2020 2020 2020 2073 656c  t1').        sel
-0000f7d0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000f7e0: 6c66 2e70 6562 626c 652e 7265 7175 6573  lf.pebble.reques
-0000f7f0: 7473 2c20 5b0a 2020 2020 2020 2020 2020  ts, [.          
-0000f800: 2020 2827 7075 7368 272c 2027 2f70 6174    ('push', '/pat
-0000f810: 682f 3127 2c20 2763 6f6e 7465 6e74 3127  h/1', 'content1'
-0000f820: 2c20 2775 7466 2d38 272c 2046 616c 7365  , 'utf-8', False
-0000f830: 2c20 4e6f 6e65 2c0a 2020 2020 2020 2020  , None,.        
-0000f840: 2020 2020 204e 6f6e 652c 204e 6f6e 652c       None, None,
-0000f850: 204e 6f6e 652c 204e 6f6e 6529 2c0a 2020   None, None),.  
-0000f860: 2020 2020 2020 5d29 0a20 2020 2020 2020        ]).       
-0000f870: 2073 656c 662e 7065 6262 6c65 2e72 6571   self.pebble.req
-0000f880: 7565 7374 7320 3d20 5b5d 0a0a 2020 2020  uests = []..    
-0000f890: 2020 2020 7365 6c66 2e63 6f6e 7461 696e      self.contain
-0000f8a0: 6572 2e70 7573 6828 272f 7061 7468 2f32  er.push('/path/2
-0000f8b0: 272c 2062 2763 6f6e 7465 6e74 3227 2c20  ', b'content2', 
-0000f8c0: 656e 636f 6469 6e67 3d4e 6f6e 652c 206d  encoding=None, m
-0000f8d0: 616b 655f 6469 7273 3d54 7275 652c 0a20  ake_dirs=True,. 
-0000f8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f8f0: 2020 2020 2020 2020 2020 2070 6572 6d69             permi
-0000f900: 7373 696f 6e73 3d30 6f36 3030 2c20 7573  ssions=0o600, us
-0000f910: 6572 5f69 643d 3132 2c20 7573 6572 3d27  er_id=12, user='
-0000f920: 626f 6227 2c20 6772 6f75 705f 6964 3d33  bob', group_id=3
-0000f930: 342c 2067 726f 7570 3d27 7374 6166 6627  4, group='staff'
-0000f940: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000f950: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-0000f960: 7065 6262 6c65 2e72 6571 7565 7374 732c  pebble.requests,
-0000f970: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
-0000f980: 2770 7573 6827 2c20 272f 7061 7468 2f32  'push', '/path/2
-0000f990: 272c 2062 2763 6f6e 7465 6e74 3227 2c20  ', b'content2', 
-0000f9a0: 4e6f 6e65 2c20 5472 7565 2c20 306f 3630  None, True, 0o60
-0000f9b0: 302c 2031 322c 2027 626f 6227 2c20 3334  0, 12, 'bob', 34
-0000f9c0: 2c20 2773 7461 6666 2729 2c0a 2020 2020  , 'staff'),.    
-0000f9d0: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
-0000f9e0: 7465 7374 5f6c 6973 745f 6669 6c65 7328  test_list_files(
-0000f9f0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-0000fa00: 656c 662e 7065 6262 6c65 2e72 6573 706f  elf.pebble.respo
-0000fa10: 6e73 6573 2e61 7070 656e 6428 2764 756d  nses.append('dum
-0000fa20: 6d79 3127 290a 2020 2020 2020 2020 7265  my1').        re
-0000fa30: 7420 3d20 7365 6c66 2e63 6f6e 7461 696e  t = self.contain
-0000fa40: 6572 2e6c 6973 745f 6669 6c65 7328 272f  er.list_files('/
-0000fa50: 7061 7468 2f31 2729 0a20 2020 2020 2020  path/1').       
-0000fa60: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000fa70: 6c28 7265 742c 2027 6475 6d6d 7931 2729  l(ret, 'dummy1')
-0000fa80: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000fa90: 7365 7274 4571 7561 6c28 7365 6c66 2e70  sertEqual(self.p
-0000faa0: 6562 626c 652e 7265 7175 6573 7473 2c20  ebble.requests, 
-0000fab0: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
-0000fac0: 6c69 7374 5f66 696c 6573 272c 2027 2f70  list_files', '/p
-0000fad0: 6174 682f 3127 2c20 4e6f 6e65 2c20 4661  ath/1', None, Fa
-0000fae0: 6c73 6529 2c0a 2020 2020 2020 2020 5d29  lse),.        ])
-0000faf0: 0a20 2020 2020 2020 2073 656c 662e 7065  .        self.pe
-0000fb00: 6262 6c65 2e72 6571 7565 7374 7320 3d20  bble.requests = 
-0000fb10: 5b5d 0a0a 2020 2020 2020 2020 7365 6c66  []..        self
-0000fb20: 2e70 6562 626c 652e 7265 7370 6f6e 7365  .pebble.response
-0000fb30: 732e 6170 7065 6e64 2827 6475 6d6d 7932  s.append('dummy2
-0000fb40: 2729 0a20 2020 2020 2020 2072 6574 203d  ').        ret =
-0000fb50: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
-0000fb60: 6c69 7374 5f66 696c 6573 2827 2f70 6174  list_files('/pat
-0000fb70: 682f 3227 2c20 7061 7474 6572 6e3d 272a  h/2', pattern='*
-0000fb80: 2e74 7874 272c 2069 7473 656c 663d 5472  .txt', itself=Tr
-0000fb90: 7565 290a 2020 2020 2020 2020 7365 6c66  ue).        self
-0000fba0: 2e61 7373 6572 7445 7175 616c 2872 6574  .assertEqual(ret
-0000fbb0: 2c20 2764 756d 6d79 3227 290a 2020 2020  , 'dummy2').    
-0000fbc0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000fbd0: 7175 616c 2873 656c 662e 7065 6262 6c65  qual(self.pebble
-0000fbe0: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
-0000fbf0: 2020 2020 2020 2020 2028 276c 6973 745f           ('list_
-0000fc00: 6669 6c65 7327 2c20 272f 7061 7468 2f32  files', '/path/2
-0000fc10: 272c 2027 2a2e 7478 7427 2c20 5472 7565  ', '*.txt', True
-0000fc20: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
-0000fc30: 2020 2064 6566 2074 6573 745f 6d61 6b65     def test_make
-0000fc40: 5f64 6972 2873 656c 6629 3a0a 2020 2020  _dir(self):.    
-0000fc50: 2020 2020 7365 6c66 2e63 6f6e 7461 696e      self.contain
-0000fc60: 6572 2e6d 616b 655f 6469 7228 272f 7061  er.make_dir('/pa
-0000fc70: 7468 2f31 2729 0a20 2020 2020 2020 2073  th/1').        s
-0000fc80: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000fc90: 7365 6c66 2e70 6562 626c 652e 7265 7175  self.pebble.requ
-0000fca0: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
-0000fcb0: 2020 2020 2827 6d61 6b65 5f64 6972 272c      ('make_dir',
-0000fcc0: 2027 2f70 6174 682f 3127 2c20 4661 6c73   '/path/1', Fals
-0000fcd0: 652c 204e 6f6e 652c 204e 6f6e 652c 204e  e, None, None, N
-0000fce0: 6f6e 652c 204e 6f6e 652c 204e 6f6e 6529  one, None, None)
-0000fcf0: 2c0a 2020 2020 2020 2020 5d29 0a20 2020  ,.        ]).   
-0000fd00: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
-0000fd10: 2e72 6571 7565 7374 7320 3d20 5b5d 0a0a  .requests = []..
-0000fd20: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0000fd30: 7461 696e 6572 2e6d 616b 655f 6469 7228  tainer.make_dir(
-0000fd40: 272f 7061 7468 2f32 272c 206d 616b 655f  '/path/2', make_
-0000fd50: 7061 7265 6e74 733d 5472 7565 2c20 7065  parents=True, pe
-0000fd60: 726d 6973 7369 6f6e 733d 306f 3730 302c  rmissions=0o700,
-0000fd70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd90: 2075 7365 725f 6964 3d31 322c 2075 7365   user_id=12, use
-0000fda0: 723d 2762 6f62 272c 2067 726f 7570 5f69  r='bob', group_i
-0000fdb0: 643d 3334 2c20 6772 6f75 703d 2773 7461  d=34, group='sta
-0000fdc0: 6666 2729 0a20 2020 2020 2020 2073 656c  ff').        sel
-0000fdd0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000fde0: 6c66 2e70 6562 626c 652e 7265 7175 6573  lf.pebble.reques
-0000fdf0: 7473 2c20 5b0a 2020 2020 2020 2020 2020  ts, [.          
-0000fe00: 2020 2827 6d61 6b65 5f64 6972 272c 2027    ('make_dir', '
-0000fe10: 2f70 6174 682f 3227 2c20 5472 7565 2c20  /path/2', True, 
-0000fe20: 306f 3730 302c 2031 322c 2027 626f 6227  0o700, 12, 'bob'
-0000fe30: 2c20 3334 2c20 2773 7461 6666 2729 2c0a  , 34, 'staff'),.
-0000fe40: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
-0000fe50: 6465 6620 7465 7374 5f72 656d 6f76 655f  def test_remove_
-0000fe60: 7061 7468 2873 656c 6629 3a0a 2020 2020  path(self):.    
-0000fe70: 2020 2020 7365 6c66 2e63 6f6e 7461 696e      self.contain
-0000fe80: 6572 2e72 656d 6f76 655f 7061 7468 2827  er.remove_path('
-0000fe90: 2f70 6174 682f 3127 290a 2020 2020 2020  /path/1').      
-0000fea0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000feb0: 616c 2873 656c 662e 7065 6262 6c65 2e72  al(self.pebble.r
-0000fec0: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
-0000fed0: 2020 2020 2020 2028 2772 656d 6f76 655f         ('remove_
-0000fee0: 7061 7468 272c 2027 2f70 6174 682f 3127  path', '/path/1'
-0000fef0: 2c20 4661 6c73 6529 2c0a 2020 2020 2020  , False),.      
-0000ff00: 2020 5d29 0a20 2020 2020 2020 2073 656c    ]).        sel
-0000ff10: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
-0000ff20: 7320 3d20 5b5d 0a0a 2020 2020 2020 2020  s = []..        
-0000ff30: 7365 6c66 2e63 6f6e 7461 696e 6572 2e72  self.container.r
-0000ff40: 656d 6f76 655f 7061 7468 2827 2f70 6174  emove_path('/pat
-0000ff50: 682f 3227 2c20 7265 6375 7273 6976 653d  h/2', recursive=
-0000ff60: 5472 7565 290a 2020 2020 2020 2020 7365  True).        se
-0000ff70: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000ff80: 656c 662e 7065 6262 6c65 2e72 6571 7565  elf.pebble.reque
-0000ff90: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-0000ffa0: 2020 2028 2772 656d 6f76 655f 7061 7468     ('remove_path
-0000ffb0: 272c 2027 2f70 6174 682f 3227 2c20 5472  ', '/path/2', Tr
-0000ffc0: 7565 292c 0a20 2020 2020 2020 205d 290a  ue),.        ]).
-0000ffd0: 0a20 2020 2064 6566 2074 6573 745f 6361  .    def test_ca
-0000ffe0: 6e5f 636f 6e6e 6563 745f 7369 6d70 6c65  n_connect_simple
-0000fff0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00010000: 7365 6c66 2e70 6562 626c 652e 7265 7370  self.pebble.resp
-00010010: 6f6e 7365 732e 6170 7065 6e64 2870 6562  onses.append(peb
-00010020: 626c 652e 5379 7374 656d 496e 666f 2e66  ble.SystemInfo.f
-00010030: 726f 6d5f 6469 6374 287b 2776 6572 7369  rom_dict({'versi
-00010040: 6f6e 273a 2027 312e 302e 3027 7d29 290a  on': '1.0.0'})).
-00010050: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00010060: 6572 7454 7275 6528 7365 6c66 2e63 6f6e  ertTrue(self.con
-00010070: 7461 696e 6572 2e63 616e 5f63 6f6e 6e65  tainer.can_conne
-00010080: 6374 2829 290a 0a20 2020 2064 6566 2074  ct())..    def t
-00010090: 6573 745f 6361 6e5f 636f 6e6e 6563 745f  est_can_connect_
-000100a0: 636f 6e6e 6563 7469 6f6e 5f65 7272 6f72  connection_error
-000100b0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000100c0: 6465 6620 7261 6973 655f 6572 726f 7228  def raise_error(
-000100d0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-000100e0: 6169 7365 2070 6562 626c 652e 436f 6e6e  aise pebble.Conn
-000100f0: 6563 7469 6f6e 4572 726f 7228 2763 6f6e  ectionError('con
-00010100: 6e65 6374 696f 6e20 6572 726f 7221 2729  nection error!')
-00010110: 0a20 2020 2020 2020 2073 656c 662e 7065  .        self.pe
-00010120: 6262 6c65 2e67 6574 5f73 7973 7465 6d5f  bble.get_system_
-00010130: 696e 666f 203d 2072 6169 7365 5f65 7272  info = raise_err
-00010140: 6f72 0a20 2020 2020 2020 2077 6974 6820  or.        with 
-00010150: 7365 6c66 2e61 7373 6572 744c 6f67 7328  self.assertLogs(
-00010160: 276f 7073 272c 206c 6576 656c 3d27 4445  'ops', level='DE
-00010170: 4255 4727 2920 6173 2063 6d3a 0a20 2020  BUG') as cm:.   
-00010180: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
-00010190: 7365 7274 4661 6c73 6528 7365 6c66 2e63  sertFalse(self.c
-000101a0: 6f6e 7461 696e 6572 2e63 616e 5f63 6f6e  ontainer.can_con
-000101b0: 6e65 6374 2829 290a 2020 2020 2020 2020  nect()).        
-000101c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000101d0: 286c 656e 2863 6d2e 6f75 7470 7574 292c  (len(cm.output),
-000101e0: 2031 290a 2020 2020 2020 2020 7365 6c66   1).        self
-000101f0: 2e61 7373 6572 7452 6567 6578 2863 6d2e  .assertRegex(cm.
-00010200: 6f75 7470 7574 5b30 5d2c 2072 2744 4542  output[0], r'DEB
-00010210: 5547 3a6f 7073 2e6d 6f64 656c 3a2e 2a3a  UG:ops.model:.*:
-00010220: 2063 6f6e 6e65 6374 696f 6e20 6572 726f   connection erro
-00010230: 7221 2729 0a0a 2020 2020 6465 6620 7465  r!')..    def te
-00010240: 7374 5f63 616e 5f63 6f6e 6e65 6374 5f66  st_can_connect_f
-00010250: 696c 655f 6e6f 745f 666f 756e 645f 6572  ile_not_found_er
-00010260: 726f 7228 7365 6c66 293a 0a20 2020 2020  ror(self):.     
-00010270: 2020 2064 6566 2072 6169 7365 5f65 7272     def raise_err
-00010280: 6f72 2829 3a0a 2020 2020 2020 2020 2020  or():.          
-00010290: 2020 7261 6973 6520 4669 6c65 4e6f 7446    raise FileNotF
-000102a0: 6f75 6e64 4572 726f 7228 2766 696c 6520  oundError('file 
-000102b0: 6e6f 7420 666f 756e 6421 2729 0a20 2020  not found!').   
-000102c0: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
-000102d0: 2e67 6574 5f73 7973 7465 6d5f 696e 666f  .get_system_info
-000102e0: 203d 2072 6169 7365 5f65 7272 6f72 0a20   = raise_error. 
-000102f0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00010300: 2e61 7373 6572 744c 6f67 7328 276f 7073  .assertLogs('ops
-00010310: 272c 206c 6576 656c 3d27 4445 4255 4727  ', level='DEBUG'
-00010320: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
-00010330: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00010340: 4661 6c73 6528 7365 6c66 2e63 6f6e 7461  False(self.conta
-00010350: 696e 6572 2e63 616e 5f63 6f6e 6e65 6374  iner.can_connect
-00010360: 2829 290a 2020 2020 2020 2020 7365 6c66  ()).        self
-00010370: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
-00010380: 2863 6d2e 6f75 7470 7574 292c 2031 290a  (cm.output), 1).
-00010390: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000103a0: 6572 7452 6567 6578 2863 6d2e 6f75 7470  ertRegex(cm.outp
-000103b0: 7574 5b30 5d2c 2072 2744 4542 5547 3a6f  ut[0], r'DEBUG:o
-000103c0: 7073 2e6d 6f64 656c 3a2e 2a3a 2066 696c  ps.model:.*: fil
-000103d0: 6520 6e6f 7420 666f 756e 6421 2729 0a0a  e not found!')..
-000103e0: 2020 2020 6465 6620 7465 7374 5f63 616e      def test_can
-000103f0: 5f63 6f6e 6e65 6374 5f61 7069 5f65 7272  _connect_api_err
-00010400: 6f72 2873 656c 6629 3a0a 2020 2020 2020  or(self):.      
-00010410: 2020 6465 6620 7261 6973 655f 6572 726f    def raise_erro
-00010420: 7228 293a 0a20 2020 2020 2020 2020 2020  r():.           
-00010430: 2072 6169 7365 2070 6562 626c 652e 4150   raise pebble.AP
-00010440: 4945 7272 6f72 2827 626f 6479 272c 2034  IError('body', 4
-00010450: 3034 2c20 2773 7461 7475 7327 2c20 2761  04, 'status', 'a
-00010460: 7069 2065 7272 6f72 2127 290a 2020 2020  pi error!').    
-00010470: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
-00010480: 6765 745f 7379 7374 656d 5f69 6e66 6f20  get_system_info 
-00010490: 3d20 7261 6973 655f 6572 726f 720a 2020  = raise_error.  
-000104a0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-000104b0: 6173 7365 7274 4c6f 6773 2827 6f70 7327  assertLogs('ops'
-000104c0: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
-000104d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000104e0: 4661 6c73 6528 7365 6c66 2e63 6f6e 7461  False(self.conta
-000104f0: 696e 6572 2e63 616e 5f63 6f6e 6e65 6374  iner.can_connect
-00010500: 2829 290a 2020 2020 2020 2020 7365 6c66  ()).        self
-00010510: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
-00010520: 2863 6d2e 6f75 7470 7574 292c 2031 290a  (cm.output), 1).
-00010530: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00010540: 6572 7452 6567 6578 2863 6d2e 6f75 7470  ertRegex(cm.outp
-00010550: 7574 5b30 5d2c 2072 2757 4152 4e49 4e47  ut[0], r'WARNING
-00010560: 3a6f 7073 2e6d 6f64 656c 3a2e 2a3a 2061  :ops.model:.*: a
-00010570: 7069 2065 7272 6f72 2127 290a 0a20 2020  pi error!')..   
-00010580: 2064 6566 2074 6573 745f 6578 6563 2873   def test_exec(s
-00010590: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-000105a0: 6c66 2e70 6562 626c 652e 7265 7370 6f6e  lf.pebble.respon
-000105b0: 7365 732e 6170 7065 6e64 2827 6661 6b65  ses.append('fake
-000105c0: 5f65 7865 635f 7072 6f63 6573 7327 290a  _exec_process').
-000105d0: 2020 2020 2020 2020 7020 3d20 7365 6c66          p = self
-000105e0: 2e63 6f6e 7461 696e 6572 2e65 7865 6328  .container.exec(
-000105f0: 0a20 2020 2020 2020 2020 2020 205b 2765  .            ['e
-00010600: 6368 6f27 2c20 2766 6f6f 275d 2c0a 2020  cho', 'foo'],.  
-00010610: 2020 2020 2020 2020 2020 656e 7669 726f            enviro
-00010620: 6e6d 656e 743d 7b27 4b31 273a 2027 5631  nment={'K1': 'V1
-00010630: 272c 2027 4b32 273a 2027 5632 277d 2c0a  ', 'K2': 'V2'},.
-00010640: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00010650: 696e 675f 6469 723d 2757 4427 2c0a 2020  ing_dir='WD',.  
-00010660: 2020 2020 2020 2020 2020 7469 6d65 6f75            timeou
-00010670: 743d 3130 2e35 2c0a 2020 2020 2020 2020  t=10.5,.        
-00010680: 2020 2020 7573 6572 5f69 643d 3130 3030      user_id=1000
-00010690: 2c0a 2020 2020 2020 2020 2020 2020 7573  ,.            us
-000106a0: 6572 3d27 626f 6227 2c0a 2020 2020 2020  er='bob',.      
-000106b0: 2020 2020 2020 6772 6f75 705f 6964 3d31        group_id=1
-000106c0: 3030 302c 0a20 2020 2020 2020 2020 2020  000,.           
-000106d0: 2067 726f 7570 3d27 7374 6166 6627 2c0a   group='staff',.
-000106e0: 2020 2020 2020 2020 2020 2020 7374 6469              stdi
-000106f0: 6e3d 2753 5444 494e 272c 0a20 2020 2020  n='STDIN',.     
-00010700: 2020 2020 2020 2073 7464 6f75 743d 2753         stdout='S
-00010710: 5444 4f55 5427 2c0a 2020 2020 2020 2020  TDOUT',.        
-00010720: 2020 2020 7374 6465 7272 3d27 5354 4445      stderr='STDE
-00010730: 5252 272c 0a20 2020 2020 2020 2020 2020  RR',.           
-00010740: 2065 6e63 6f64 696e 673d 4e6f 6e65 2c0a   encoding=None,.
-00010750: 2020 2020 2020 2020 2020 2020 636f 6d62              comb
-00010760: 696e 655f 7374 6465 7272 3d54 7275 652c  ine_stderr=True,
-00010770: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00010780: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00010790: 7561 6c28 7365 6c66 2e70 6562 626c 652e  ual(self.pebble.
-000107a0: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
-000107b0: 2020 2020 2020 2020 2827 6578 6563 272c          ('exec',
-000107c0: 205b 2765 6368 6f27 2c20 2766 6f6f 275d   ['echo', 'foo']
-000107d0: 2c20 6469 6374 280a 2020 2020 2020 2020  , dict(.        
-000107e0: 2020 2020 2020 2020 656e 7669 726f 6e6d          environm
-000107f0: 656e 743d 7b27 4b31 273a 2027 5631 272c  ent={'K1': 'V1',
-00010800: 2027 4b32 273a 2027 5632 277d 2c0a 2020   'K2': 'V2'},.  
-00010810: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-00010820: 726b 696e 675f 6469 723d 2757 4427 2c0a  rking_dir='WD',.
-00010830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010840: 7469 6d65 6f75 743d 3130 2e35 2c0a 2020  timeout=10.5,.  
-00010850: 2020 2020 2020 2020 2020 2020 2020 7573                us
-00010860: 6572 5f69 643d 3130 3030 2c0a 2020 2020  er_id=1000,.    
-00010870: 2020 2020 2020 2020 2020 2020 7573 6572              user
-00010880: 3d27 626f 6227 2c0a 2020 2020 2020 2020  ='bob',.        
-00010890: 2020 2020 2020 2020 6772 6f75 705f 6964          group_id
-000108a0: 3d31 3030 302c 0a20 2020 2020 2020 2020  =1000,.         
-000108b0: 2020 2020 2020 2067 726f 7570 3d27 7374         group='st
-000108c0: 6166 6627 2c0a 2020 2020 2020 2020 2020  aff',.          
-000108d0: 2020 2020 2020 7374 6469 6e3d 2753 5444        stdin='STD
-000108e0: 494e 272c 0a20 2020 2020 2020 2020 2020  IN',.           
-000108f0: 2020 2020 2073 7464 6f75 743d 2753 5444       stdout='STD
-00010900: 4f55 5427 2c0a 2020 2020 2020 2020 2020  OUT',.          
-00010910: 2020 2020 2020 7374 6465 7272 3d27 5354        stderr='ST
-00010920: 4445 5252 272c 0a20 2020 2020 2020 2020  DERR',.         
-00010930: 2020 2020 2020 2065 6e63 6f64 696e 673d         encoding=
-00010940: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00010950: 2020 2020 2020 636f 6d62 696e 655f 7374        combine_st
-00010960: 6465 7272 3d54 7275 652c 0a20 2020 2020  derr=True,.     
-00010970: 2020 2020 2020 2029 290a 2020 2020 2020         )).      
-00010980: 2020 5d29 0a20 2020 2020 2020 2073 656c    ]).        sel
-00010990: 662e 6173 7365 7274 4571 7561 6c28 702c  f.assertEqual(p,
-000109a0: 2027 6661 6b65 5f65 7865 635f 7072 6f63   'fake_exec_proc
-000109b0: 6573 7327 290a 0a20 2020 2064 6566 2074  ess')..    def t
-000109c0: 6573 745f 7365 6e64 5f73 6967 6e61 6c28  est_send_signal(
-000109d0: 7365 6c66 293a 0a20 2020 2020 2020 2077  self):.        w
-000109e0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-000109f0: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
-00010a00: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00010a10: 6c66 2e63 6f6e 7461 696e 6572 2e73 656e  lf.container.sen
-00010a20: 645f 7369 676e 616c 2827 5349 4748 5550  d_signal('SIGHUP
-00010a30: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
-00010a40: 2e63 6f6e 7461 696e 6572 2e73 656e 645f  .container.send_
-00010a50: 7369 676e 616c 2827 5349 4748 5550 272c  signal('SIGHUP',
-00010a60: 2027 7331 2729 0a20 2020 2020 2020 2073   's1').        s
-00010a70: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00010a80: 7365 6c66 2e70 6562 626c 652e 7265 7175  self.pebble.requ
-00010a90: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
-00010aa0: 2020 2020 2827 7365 6e64 5f73 6967 6e61      ('send_signa
-00010ab0: 6c27 2c20 2753 4947 4855 5027 2c20 2827  l', 'SIGHUP', ('
-00010ac0: 7331 272c 2929 2c0a 2020 2020 2020 2020  s1',)),.        
-00010ad0: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
-00010ae0: 7065 6262 6c65 2e72 6571 7565 7374 7320  pebble.requests 
-00010af0: 3d20 5b5d 0a0a 2020 2020 2020 2020 7365  = []..        se
-00010b00: 6c66 2e63 6f6e 7461 696e 6572 2e73 656e  lf.container.sen
-00010b10: 645f 7369 676e 616c 2827 5349 4748 5550  d_signal('SIGHUP
-00010b20: 272c 2027 7331 272c 2027 7332 2729 0a20  ', 's1', 's2'). 
-00010b30: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00010b40: 7274 4571 7561 6c28 7365 6c66 2e70 6562  rtEqual(self.peb
-00010b50: 626c 652e 7265 7175 6573 7473 2c20 5b0a  ble.requests, [.
-00010b60: 2020 2020 2020 2020 2020 2020 2827 7365              ('se
-00010b70: 6e64 5f73 6967 6e61 6c27 2c20 2753 4947  nd_signal', 'SIG
-00010b80: 4855 5027 2c20 2827 7331 272c 2027 7332  HUP', ('s1', 's2
-00010b90: 2729 292c 0a20 2020 2020 2020 205d 290a  ')),.        ]).
-00010ba0: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
-00010bb0: 626c 652e 7265 7175 6573 7473 203d 205b  ble.requests = [
-00010bc0: 5d0a 0a0a 636c 6173 7320 4d6f 636b 5065  ]...class MockPe
-00010bd0: 6262 6c65 4261 636b 656e 6428 5f4d 6f64  bbleBackend(_Mod
-00010be0: 656c 4261 636b 656e 6429 3a0a 2020 2020  elBackend):.    
-00010bf0: 6465 6620 6765 745f 7065 6262 6c65 2873  def get_pebble(s
-00010c00: 656c 662c 2073 6f63 6b65 745f 7061 7468  elf, socket_path
-00010c10: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00010c20: 6e20 4d6f 636b 5065 6262 6c65 436c 6965  n MockPebbleClie
-00010c30: 6e74 2873 6f63 6b65 745f 7061 7468 290a  nt(socket_path).
-00010c40: 0a0a 636c 6173 7320 4d6f 636b 5065 6262  ..class MockPebb
-00010c50: 6c65 436c 6965 6e74 3a0a 2020 2020 6465  leClient:.    de
-00010c60: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-00010c70: 2073 6f63 6b65 745f 7061 7468 293a 0a20   socket_path):. 
-00010c80: 2020 2020 2020 2073 656c 662e 736f 636b         self.sock
-00010c90: 6574 5f70 6174 6820 3d20 736f 636b 6574  et_path = socket
-00010ca0: 5f70 6174 680a 2020 2020 2020 2020 7365  _path.        se
-00010cb0: 6c66 2e72 6571 7565 7374 7320 3d20 5b5d  lf.requests = []
-00010cc0: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
-00010cd0: 7370 6f6e 7365 7320 3d20 5b5d 0a0a 2020  sponses = []..  
-00010ce0: 2020 6465 6620 6175 746f 7374 6172 745f    def autostart_
-00010cf0: 7365 7276 6963 6573 2873 656c 6629 3a0a  services(self):.
-00010d00: 2020 2020 2020 2020 7365 6c66 2e72 6571          self.req
-00010d10: 7565 7374 732e 6170 7065 6e64 2828 2761  uests.append(('a
-00010d20: 7574 6f73 7461 7274 272c 2929 0a0a 2020  utostart',))..  
-00010d30: 2020 6465 6620 6765 745f 7379 7374 656d    def get_system
-00010d40: 5f69 6e66 6f28 7365 6c66 293a 0a20 2020  _info(self):.   
-00010d50: 2020 2020 2073 656c 662e 7265 7175 6573       self.reques
-00010d60: 7473 2e61 7070 656e 6428 2827 6765 745f  ts.append(('get_
-00010d70: 7379 7374 656d 5f69 6e66 6f27 2c29 290a  system_info',)).
-00010d80: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00010d90: 656c 662e 7265 7370 6f6e 7365 732e 706f  elf.responses.po
-00010da0: 7028 3029 0a0a 2020 2020 6465 6620 7265  p(0)..    def re
-00010db0: 706c 616e 5f73 6572 7669 6365 7328 7365  plan_services(se
-00010dc0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-00010dd0: 662e 7265 7175 6573 7473 2e61 7070 656e  f.requests.appen
-00010de0: 6428 2827 7265 706c 616e 272c 2929 0a0a  d(('replan',))..
-00010df0: 2020 2020 6465 6620 7374 6172 745f 7365      def start_se
-00010e00: 7276 6963 6573 2873 656c 662c 2073 6572  rvices(self, ser
-00010e10: 7669 6365 5f6e 616d 6573 293a 0a20 2020  vice_names):.   
-00010e20: 2020 2020 2073 656c 662e 7265 7175 6573       self.reques
-00010e30: 7473 2e61 7070 656e 6428 2827 7374 6172  ts.append(('star
-00010e40: 7427 2c20 7365 7276 6963 655f 6e61 6d65  t', service_name
-00010e50: 7329 290a 0a20 2020 2064 6566 2073 746f  s))..    def sto
-00010e60: 705f 7365 7276 6963 6573 2873 656c 662c  p_services(self,
-00010e70: 2073 6572 7669 6365 5f6e 616d 6573 293a   service_names):
-00010e80: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
-00010e90: 7175 6573 7473 2e61 7070 656e 6428 2827  quests.append(('
-00010ea0: 7374 6f70 272c 2073 6572 7669 6365 5f6e  stop', service_n
-00010eb0: 616d 6573 2929 0a0a 2020 2020 6465 6620  ames))..    def 
-00010ec0: 7265 7374 6172 745f 7365 7276 6963 6573  restart_services
-00010ed0: 2873 656c 662c 2073 6572 7669 6365 5f6e  (self, service_n
-00010ee0: 616d 6573 293a 0a20 2020 2020 2020 2073  ames):.        s
-00010ef0: 656c 662e 7265 7175 6573 7473 2e61 7070  elf.requests.app
-00010f00: 656e 6428 2827 7265 7374 6172 7427 2c20  end(('restart', 
-00010f10: 7365 7276 6963 655f 6e61 6d65 7329 290a  service_names)).
-00010f20: 0a20 2020 2064 6566 2061 6464 5f6c 6179  .    def add_lay
-00010f30: 6572 2873 656c 662c 206c 6162 656c 2c20  er(self, label, 
-00010f40: 6c61 7965 722c 2063 6f6d 6269 6e65 3d46  layer, combine=F
-00010f50: 616c 7365 293a 0a20 2020 2020 2020 2069  alse):.        i
-00010f60: 6620 6973 696e 7374 616e 6365 286c 6179  f isinstance(lay
-00010f70: 6572 2c20 6469 6374 293a 0a20 2020 2020  er, dict):.     
-00010f80: 2020 2020 2020 206c 6179 6572 203d 2070         layer = p
-00010f90: 6562 626c 652e 4c61 7965 7228 6c61 7965  ebble.Layer(laye
-00010fa0: 7229 2e74 6f5f 7961 6d6c 2829 0a20 2020  r).to_yaml().   
-00010fb0: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-00010fc0: 616e 6365 286c 6179 6572 2c20 7065 6262  ance(layer, pebb
-00010fd0: 6c65 2e4c 6179 6572 293a 0a20 2020 2020  le.Layer):.     
-00010fe0: 2020 2020 2020 206c 6179 6572 203d 206c         layer = l
-00010ff0: 6179 6572 2e74 6f5f 7961 6d6c 2829 0a20  ayer.to_yaml(). 
-00011000: 2020 2020 2020 2073 656c 662e 7265 7175         self.requ
-00011010: 6573 7473 2e61 7070 656e 6428 2827 6164  ests.append(('ad
-00011020: 645f 6c61 7965 7227 2c20 6c61 6265 6c2c  d_layer', label,
-00011030: 206c 6179 6572 2c20 636f 6d62 696e 6529   layer, combine)
-00011040: 290a 0a20 2020 2064 6566 2067 6574 5f70  )..    def get_p
-00011050: 6c61 6e28 7365 6c66 293a 0a20 2020 2020  lan(self):.     
-00011060: 2020 2073 656c 662e 7265 7175 6573 7473     self.requests
-00011070: 2e61 7070 656e 6428 2827 6765 745f 706c  .append(('get_pl
-00011080: 616e 272c 2929 0a20 2020 2020 2020 2072  an',)).        r
-00011090: 6574 7572 6e20 7365 6c66 2e72 6573 706f  eturn self.respo
-000110a0: 6e73 6573 2e70 6f70 2830 290a 0a20 2020  nses.pop(0)..   
-000110b0: 2064 6566 2067 6574 5f73 6572 7669 6365   def get_service
-000110c0: 7328 7365 6c66 2c20 6e61 6d65 733d 4e6f  s(self, names=No
-000110d0: 6e65 293a 0a20 2020 2020 2020 2073 656c  ne):.        sel
-000110e0: 662e 7265 7175 6573 7473 2e61 7070 656e  f.requests.appen
-000110f0: 6428 2827 6765 745f 7365 7276 6963 6573  d(('get_services
-00011100: 272c 206e 616d 6573 2929 0a20 2020 2020  ', names)).     
-00011110: 2020 2072 6574 7572 6e20 7365 6c66 2e72     return self.r
-00011120: 6573 706f 6e73 6573 2e70 6f70 2830 290a  esponses.pop(0).
-00011130: 0a20 2020 2064 6566 2067 6574 5f63 6865  .    def get_che
-00011140: 636b 7328 7365 6c66 2c20 6c65 7665 6c3d  cks(self, level=
-00011150: 4e6f 6e65 2c20 6e61 6d65 733d 4e6f 6e65  None, names=None
-00011160: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00011170: 7265 7175 6573 7473 2e61 7070 656e 6428  requests.append(
-00011180: 2827 6765 745f 6368 6563 6b73 272c 206c  ('get_checks', l
-00011190: 6576 656c 2c20 6e61 6d65 7329 290a 2020  evel, names)).  
-000111a0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-000111b0: 662e 7265 7370 6f6e 7365 732e 706f 7028  f.responses.pop(
-000111c0: 3029 0a0a 2020 2020 6465 6620 7075 6c6c  0)..    def pull
-000111d0: 2873 656c 662c 2070 6174 682c 202a 2c20  (self, path, *, 
-000111e0: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
-000111f0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00011200: 7265 7175 6573 7473 2e61 7070 656e 6428  requests.append(
-00011210: 2827 7075 6c6c 272c 2070 6174 682c 2065  ('pull', path, e
-00011220: 6e63 6f64 696e 6729 290a 2020 2020 2020  ncoding)).      
-00011230: 2020 7265 7475 726e 2073 656c 662e 7265    return self.re
-00011240: 7370 6f6e 7365 732e 706f 7028 3029 0a0a  sponses.pop(0)..
-00011250: 2020 2020 6465 6620 7075 7368 2873 656c      def push(sel
-00011260: 662c 2070 6174 682c 2073 6f75 7263 652c  f, path, source,
-00011270: 202a 2c20 656e 636f 6469 6e67 3d27 7574   *, encoding='ut
-00011280: 662d 3827 2c20 6d61 6b65 5f64 6972 733d  f-8', make_dirs=
-00011290: 4661 6c73 652c 2070 6572 6d69 7373 696f  False, permissio
-000112a0: 6e73 3d4e 6f6e 652c 0a20 2020 2020 2020  ns=None,.       
-000112b0: 2020 2020 2020 7573 6572 5f69 643d 4e6f        user_id=No
-000112c0: 6e65 2c20 7573 6572 3d4e 6f6e 652c 2067  ne, user=None, g
-000112d0: 726f 7570 5f69 643d 4e6f 6e65 2c20 6772  roup_id=None, gr
-000112e0: 6f75 703d 4e6f 6e65 293a 0a20 2020 2020  oup=None):.     
-000112f0: 2020 2073 656c 662e 7265 7175 6573 7473     self.requests
-00011300: 2e61 7070 656e 6428 2827 7075 7368 272c  .append(('push',
-00011310: 2070 6174 682c 2073 6f75 7263 652c 2065   path, source, e
-00011320: 6e63 6f64 696e 672c 206d 616b 655f 6469  ncoding, make_di
-00011330: 7273 2c20 7065 726d 6973 7369 6f6e 732c  rs, permissions,
-00011340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011350: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00011360: 7365 725f 6964 2c20 7573 6572 2c20 6772  ser_id, user, gr
-00011370: 6f75 705f 6964 2c20 6772 6f75 7029 290a  oup_id, group)).
-00011380: 0a20 2020 2064 6566 206c 6973 745f 6669  .    def list_fi
-00011390: 6c65 7328 7365 6c66 2c20 7061 7468 2c20  les(self, path, 
-000113a0: 2a2c 2070 6174 7465 726e 3d4e 6f6e 652c  *, pattern=None,
-000113b0: 2069 7473 656c 663d 4661 6c73 6529 3a0a   itself=False):.
-000113c0: 2020 2020 2020 2020 7365 6c66 2e72 6571          self.req
-000113d0: 7565 7374 732e 6170 7065 6e64 2828 276c  uests.append(('l
-000113e0: 6973 745f 6669 6c65 7327 2c20 7061 7468  ist_files', path
-000113f0: 2c20 7061 7474 6572 6e2c 2069 7473 656c  , pattern, itsel
-00011400: 6629 290a 2020 2020 2020 2020 7265 7475  f)).        retu
-00011410: 726e 2073 656c 662e 7265 7370 6f6e 7365  rn self.response
-00011420: 732e 706f 7028 3029 0a0a 2020 2020 6465  s.pop(0)..    de
-00011430: 6620 6d61 6b65 5f64 6972 2873 656c 662c  f make_dir(self,
-00011440: 2070 6174 682c 202a 2c20 6d61 6b65 5f70   path, *, make_p
-00011450: 6172 656e 7473 3d46 616c 7365 2c20 7065  arents=False, pe
-00011460: 726d 6973 7369 6f6e 733d 4e6f 6e65 2c20  rmissions=None, 
-00011470: 7573 6572 5f69 643d 4e6f 6e65 2c20 7573  user_id=None, us
-00011480: 6572 3d4e 6f6e 652c 0a20 2020 2020 2020  er=None,.       
-00011490: 2020 2020 2020 2020 2020 6772 6f75 705f            group_
-000114a0: 6964 3d4e 6f6e 652c 2067 726f 7570 3d4e  id=None, group=N
-000114b0: 6f6e 6529 3a0a 2020 2020 2020 2020 7365  one):.        se
-000114c0: 6c66 2e72 6571 7565 7374 732e 6170 7065  lf.requests.appe
-000114d0: 6e64 2828 276d 616b 655f 6469 7227 2c20  nd(('make_dir', 
-000114e0: 7061 7468 2c20 6d61 6b65 5f70 6172 656e  path, make_paren
-000114f0: 7473 2c20 7065 726d 6973 7369 6f6e 732c  ts, permissions,
-00011500: 2075 7365 725f 6964 2c20 7573 6572 2c0a   user_id, user,.
-00011510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011520: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-00011530: 6f75 705f 6964 2c20 6772 6f75 7029 290a  oup_id, group)).
-00011540: 0a20 2020 2064 6566 2072 656d 6f76 655f  .    def remove_
-00011550: 7061 7468 2873 656c 662c 2070 6174 682c  path(self, path,
-00011560: 202a 2c20 7265 6375 7273 6976 653d 4661   *, recursive=Fa
-00011570: 6c73 6529 3a0a 2020 2020 2020 2020 7365  lse):.        se
-00011580: 6c66 2e72 6571 7565 7374 732e 6170 7065  lf.requests.appe
-00011590: 6e64 2828 2772 656d 6f76 655f 7061 7468  nd(('remove_path
-000115a0: 272c 2070 6174 682c 2072 6563 7572 7369  ', path, recursi
-000115b0: 7665 2929 0a0a 2020 2020 6465 6620 6578  ve))..    def ex
-000115c0: 6563 2873 656c 662c 2063 6f6d 6d61 6e64  ec(self, command
-000115d0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-000115e0: 2020 2020 2073 656c 662e 7265 7175 6573       self.reques
-000115f0: 7473 2e61 7070 656e 6428 2827 6578 6563  ts.append(('exec
-00011600: 272c 2063 6f6d 6d61 6e64 2c20 6b77 6172  ', command, kwar
-00011610: 6773 2929 0a20 2020 2020 2020 2072 6574  gs)).        ret
-00011620: 7572 6e20 7365 6c66 2e72 6573 706f 6e73  urn self.respons
-00011630: 6573 2e70 6f70 2830 290a 0a20 2020 2064  es.pop(0)..    d
-00011640: 6566 2073 656e 645f 7369 676e 616c 2873  ef send_signal(s
-00011650: 656c 662c 2073 6967 6e61 6c2c 2073 6572  elf, signal, ser
-00011660: 7669 6365 5f6e 616d 6573 293a 0a20 2020  vice_names):.   
-00011670: 2020 2020 2073 656c 662e 7265 7175 6573       self.reques
-00011680: 7473 2e61 7070 656e 6428 2827 7365 6e64  ts.append(('send
-00011690: 5f73 6967 6e61 6c27 2c20 7369 676e 616c  _signal', signal
-000116a0: 2c20 7365 7276 6963 655f 6e61 6d65 7329  , service_names)
-000116b0: 290a 0a0a 636c 6173 7320 5465 7374 4d6f  )...class TestMo
-000116c0: 6465 6c42 696e 6469 6e67 7328 756e 6974  delBindings(unit
-000116d0: 7465 7374 2e54 6573 7443 6173 6529 3a0a  test.TestCase):.
-000116e0: 0a20 2020 2064 6566 2073 6574 5570 2873  .    def setUp(s
-000116f0: 656c 6629 3a0a 2020 2020 2020 2020 6d65  elf):.        me
-00011700: 7461 203d 206f 7073 2e43 6861 726d 4d65  ta = ops.CharmMe
-00011710: 7461 2829 0a20 2020 2020 2020 206d 6574  ta().        met
-00011720: 612e 7265 6c61 7469 6f6e 7320 3d20 7b0a  a.relations = {.
-00011730: 2020 2020 2020 2020 2020 2020 2764 6230              'db0
-00011740: 273a 206f 7073 2e52 656c 6174 696f 6e4d  ': ops.RelationM
-00011750: 6574 6128 0a20 2020 2020 2020 2020 2020  eta(.           
-00011760: 2020 2020 206f 7073 2e52 656c 6174 696f       ops.Relatio
-00011770: 6e52 6f6c 652e 7072 6f76 6964 6573 2c20  nRole.provides, 
-00011780: 2764 6230 272c 207b 2769 6e74 6572 6661  'db0', {'interfa
-00011790: 6365 273a 2027 6462 3027 2c20 2773 636f  ce': 'db0', 'sco
-000117a0: 7065 273a 2027 676c 6f62 616c 277d 292c  pe': 'global'}),
-000117b0: 0a20 2020 2020 2020 2020 2020 2027 6462  .            'db
-000117c0: 3127 3a20 6f70 732e 5265 6c61 7469 6f6e  1': ops.Relation
-000117d0: 4d65 7461 280a 2020 2020 2020 2020 2020  Meta(.          
-000117e0: 2020 2020 2020 6f70 732e 5265 6c61 7469        ops.Relati
-000117f0: 6f6e 526f 6c65 2e72 6571 7569 7265 732c  onRole.requires,
-00011800: 2027 6462 3127 2c20 7b27 696e 7465 7266   'db1', {'interf
-00011810: 6163 6527 3a20 2764 6231 272c 2027 7363  ace': 'db1', 'sc
-00011820: 6f70 6527 3a20 2767 6c6f 6261 6c27 7d29  ope': 'global'})
-00011830: 2c0a 2020 2020 2020 2020 2020 2020 2764  ,.            'd
-00011840: 6232 273a 206f 7073 2e52 656c 6174 696f  b2': ops.Relatio
-00011850: 6e4d 6574 6128 0a20 2020 2020 2020 2020  nMeta(.         
-00011860: 2020 2020 2020 206f 7073 2e52 656c 6174         ops.Relat
-00011870: 696f 6e52 6f6c 652e 7065 6572 2c20 2764  ionRole.peer, 'd
-00011880: 6232 272c 207b 2769 6e74 6572 6661 6365  b2', {'interface
-00011890: 273a 2027 6462 3227 2c20 2773 636f 7065  ': 'db2', 'scope
-000118a0: 273a 2027 676c 6f62 616c 277d 292c 0a20  ': 'global'}),. 
-000118b0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-000118c0: 2073 656c 662e 6261 636b 656e 6420 3d20   self.backend = 
-000118d0: 5f4d 6f64 656c 4261 636b 656e 6428 276d  _ModelBackend('m
-000118e0: 7961 7070 2f30 2729 0a20 2020 2020 2020  yapp/0').       
-000118f0: 2073 656c 662e 6d6f 6465 6c20 3d20 6f70   self.model = op
-00011900: 732e 4d6f 6465 6c28 6d65 7461 2c20 7365  s.Model(meta, se
-00011910: 6c66 2e62 6163 6b65 6e64 290a 0a20 2020  lf.backend)..   
-00011920: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-00011930: 2873 656c 662c 2027 7265 6c61 7469 6f6e  (self, 'relation
-00011940: 2d69 6473 272c 0a20 2020 2020 2020 2020  -ids',.         
-00011950: 2020 2020 2020 2020 2020 2022 2222 285b             """([
-00011960: 2022 2431 2220 3d20 6462 3020 5d20 2626   "$1" = db0 ] &&
-00011970: 2065 6368 6f20 275b 2264 6230 3a34 225d   echo '["db0:4"]
-00011980: 2729 207c 7c20 6563 686f 2027 5b5d 2722  ') || echo '[]'"
-00011990: 2222 290a 2020 2020 2020 2020 6661 6b65  "").        fake
-000119a0: 5f73 6372 6970 7428 7365 6c66 2c20 2772  _script(self, 'r
-000119b0: 656c 6174 696f 6e2d 6c69 7374 272c 2022  elation-list', "
-000119c0: 2222 5b20 2224 3222 203d 2034 205d 2026  ""[ "$2" = 4 ] &
-000119d0: 2620 6563 686f 2027 5b22 7265 6d6f 7465  & echo '["remote
-000119e0: 6170 7031 2f30 225d 2720 7c7c 2065 7869  app1/0"]' || exi
-000119f0: 7420 3222 2222 290a 2020 2020 2020 2020  t 2""").        
-00011a00: 7365 6c66 2e6e 6574 776f 726b 5f67 6574  self.network_get
-00011a10: 5f6f 7574 203d 2027 2727 7b0a 2020 2262  _out = '''{.  "b
-00011a20: 696e 642d 6164 6472 6573 7365 7322 3a20  ind-addresses": 
-00011a30: 5b0a 2020 2020 7b0a 2020 2020 2020 226d  [.    {.      "m
-00011a40: 6163 2d61 6464 7265 7373 223a 2022 6465  ac-address": "de
-00011a50: 3a61 643a 6265 3a65 663a 6361 3a66 6522  :ad:be:ef:ca:fe"
-00011a60: 2c0a 2020 2020 2020 2269 6e74 6572 6661  ,.      "interfa
-00011a70: 6365 2d6e 616d 6522 3a20 226c 6f22 2c0a  ce-name": "lo",.
-00011a80: 2020 2020 2020 2261 6464 7265 7373 6573        "addresses
-00011a90: 223a 205b 0a20 2020 2020 2020 207b 0a20  ": [.        {. 
-00011aa0: 2020 2020 2020 2020 2022 686f 7374 6e61           "hostna
-00011ab0: 6d65 223a 2022 222c 0a20 2020 2020 2020  me": "",.       
-00011ac0: 2020 2022 7661 6c75 6522 3a20 2231 3932     "value": "192
-00011ad0: 2e30 2e32 2e32 222c 0a20 2020 2020 2020  .0.2.2",.       
-00011ae0: 2020 2022 6369 6472 223a 2022 3139 322e     "cidr": "192.
-00011af0: 302e 322e 302f 3234 220a 2020 2020 2020  0.2.0/24".      
-00011b00: 2020 7d2c 0a20 2020 2020 2020 207b 0a20    },.        {. 
-00011b10: 2020 2020 2020 2020 2022 686f 7374 6e61           "hostna
-00011b20: 6d65 223a 2022 6465 6164 6265 6566 2e65  me": "deadbeef.e
-00011b30: 7861 6d70 6c65 222c 0a20 2020 2020 2020  xample",.       
-00011b40: 2020 2022 7661 6c75 6522 3a20 2264 6561     "value": "dea
-00011b50: 643a 6265 6566 3a3a 3122 2c0a 2020 2020  d:beef::1",.    
-00011b60: 2020 2020 2020 2263 6964 7222 3a20 2264        "cidr": "d
-00011b70: 6561 643a 6265 6566 3a3a 2f36 3422 0a20  ead:beef::/64". 
-00011b80: 2020 2020 2020 207d 0a20 2020 2020 205d         }.      ]
-00011b90: 0a20 2020 207d 2c0a 2020 2020 7b0a 2020  .    },.    {.  
-00011ba0: 2020 2020 226d 6163 2d61 6464 7265 7373      "mac-address
-00011bb0: 223a 2022 222c 0a20 2020 2020 2022 696e  ": "",.      "in
-00011bc0: 7465 7266 6163 652d 6e61 6d65 223a 2022  terface-name": "
-00011bd0: 7475 6e22 2c0a 2020 2020 2020 2261 6464  tun",.      "add
-00011be0: 7265 7373 6573 223a 205b 0a20 2020 2020  resses": [.     
-00011bf0: 2020 207b 0a20 2020 2020 2020 2020 2022     {.          "
-00011c00: 686f 7374 6e61 6d65 223a 2022 222c 0a20  hostname": "",. 
-00011c10: 2020 2020 2020 2020 2022 7661 6c75 6522           "value"
-00011c20: 3a20 2231 3932 2e30 2e33 2e33 222c 0a20  : "192.0.3.3",. 
-00011c30: 2020 2020 2020 2020 2022 6369 6472 223a           "cidr":
-00011c40: 2022 220a 2020 2020 2020 2020 7d2c 0a20   "".        },. 
-00011c50: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00011c60: 2020 2022 686f 7374 6e61 6d65 223a 2022     "hostname": "
-00011c70: 222c 0a20 2020 2020 2020 2020 2022 7661  ",.          "va
-00011c80: 6c75 6522 3a20 2232 3030 313a 6462 383a  lue": "2001:db8:
-00011c90: 3a33 222c 0a20 2020 2020 2020 2020 2022  :3",.          "
-00011ca0: 6369 6472 223a 2022 220a 2020 2020 2020  cidr": "".      
-00011cb0: 2020 7d2c 0a20 2020 2020 2020 207b 0a20    },.        {. 
-00011cc0: 2020 2020 2020 2020 2022 686f 7374 6e61           "hostna
-00011cd0: 6d65 223a 2022 6465 6164 6265 6566 2e6c  me": "deadbeef.l
-00011ce0: 6f63 616c 222c 0a20 2020 2020 2020 2020  ocal",.         
-00011cf0: 2022 7661 6c75 6522 3a20 2266 6538 303a   "value": "fe80:
-00011d00: 3a31 3a31 222c 0a20 2020 2020 2020 2020  :1:1",.         
-00011d10: 2022 6369 6472 223a 2022 6665 3830 3a3a   "cidr": "fe80::
-00011d20: 2f36 3422 0a20 2020 2020 2020 207d 0a20  /64".        }. 
-00011d30: 2020 2020 205d 0a20 2020 207d 0a20 205d       ].    }.  ]
-00011d40: 2c0a 2020 2265 6772 6573 732d 7375 626e  ,.  "egress-subn
-00011d50: 6574 7322 3a20 5b0a 2020 2020 2231 3932  ets": [.    "192
-00011d60: 2e30 2e32 2e32 2f33 3222 2c0a 2020 2020  .0.2.2/32",.    
-00011d70: 2231 3932 2e30 2e33 2e30 2f32 3422 2c0a  "192.0.3.0/24",.
-00011d80: 2020 2020 2264 6561 643a 6265 6566 3a3a      "dead:beef::
-00011d90: 2f36 3422 2c0a 2020 2020 2232 3030 313a  /64",.    "2001:
-00011da0: 6462 383a 3a33 2f31 3238 220a 2020 5d2c  db8::3/128".  ],
-00011db0: 0a20 2022 696e 6772 6573 732d 6164 6472  .  "ingress-addr
-00011dc0: 6573 7365 7322 3a20 5b0a 2020 2020 2231  esses": [.    "1
-00011dd0: 3932 2e30 2e32 2e32 222c 0a20 2020 2022  92.0.2.2",.    "
-00011de0: 3139 322e 302e 332e 3322 2c0a 2020 2020  192.0.3.3",.    
-00011df0: 2264 6561 643a 6265 6566 3a3a 3122 2c0a  "dead:beef::1",.
-00011e00: 2020 2020 2232 3030 313a 6462 383a 3a33      "2001:db8::3
-00011e10: 220a 2020 5d0a 7d27 2727 0a0a 2020 2020  ".  ].}'''..    
-00011e20: 6465 6620 5f63 6865 636b 5f62 696e 6469  def _check_bindi
-00011e30: 6e67 5f64 6174 6128 7365 6c66 2c20 6269  ng_data(self, bi
-00011e40: 6e64 696e 675f 6e61 6d65 2c20 6269 6e64  nding_name, bind
-00011e50: 696e 6729 3a0a 2020 2020 2020 2020 7365  ing):.        se
-00011e60: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
-00011e70: 696e 6469 6e67 2e6e 616d 652c 2062 696e  inding.name, bin
-00011e80: 6469 6e67 5f6e 616d 6529 0a20 2020 2020  ding_name).     
-00011e90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00011ea0: 7561 6c28 6269 6e64 696e 672e 6e65 7477  ual(binding.netw
-00011eb0: 6f72 6b2e 6269 6e64 5f61 6464 7265 7373  ork.bind_address
-00011ec0: 2c20 6970 6164 6472 6573 732e 6970 5f61  , ipaddress.ip_a
-00011ed0: 6464 7265 7373 2827 3139 322e 302e 322e  ddress('192.0.2.
-00011ee0: 3227 2929 0a20 2020 2020 2020 2073 656c  2')).        sel
-00011ef0: 662e 6173 7365 7274 4571 7561 6c28 6269  f.assertEqual(bi
-00011f00: 6e64 696e 672e 6e65 7477 6f72 6b2e 696e  nding.network.in
-00011f10: 6772 6573 735f 6164 6472 6573 732c 2069  gress_address, i
-00011f20: 7061 6464 7265 7373 2e69 705f 6164 6472  paddress.ip_addr
-00011f30: 6573 7328 2731 3932 2e30 2e32 2e32 2729  ess('192.0.2.2')
-00011f40: 290a 2020 2020 2020 2020 2320 2f33 3220  ).        # /32 
-00011f50: 616e 6420 2f31 3238 2043 4944 5273 2061  and /128 CIDRs a
-00011f60: 7265 2076 616c 6964 206f 6e65 2d61 6464  re valid one-add
-00011f70: 7265 7373 206e 6574 776f 726b 7320 666f  ress networks fo
-00011f80: 7220 4950 767b 342c 367d 4e65 7477 6f72  r IPv{4,6}Networ
-00011f90: 6b20 7479 7065 7320 7265 7370 6563 7469  k types respecti
-00011fa0: 7665 6c79 2e0a 2020 2020 2020 2020 7365  vely..        se
-00011fb0: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
-00011fc0: 696e 6469 6e67 2e6e 6574 776f 726b 2e65  inding.network.e
-00011fd0: 6772 6573 735f 7375 626e 6574 732c 205b  gress_subnets, [
-00011fe0: 6970 6164 6472 6573 732e 6970 5f6e 6574  ipaddress.ip_net
-00011ff0: 776f 726b 2827 3139 322e 302e 322e 322f  work('192.0.2.2/
-00012000: 3332 2729 2c0a 2020 2020 2020 2020 2020  32'),.          
-00012010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012040: 6970 6164 6472 6573 732e 6970 5f6e 6574  ipaddress.ip_net
-00012050: 776f 726b 2827 3139 322e 302e 332e 302f  work('192.0.3.0/
-00012060: 3234 2729 2c0a 2020 2020 2020 2020 2020  24'),.          
-00012070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000120a0: 6970 6164 6472 6573 732e 6970 5f6e 6574  ipaddress.ip_net
-000120b0: 776f 726b 2827 6465 6164 3a62 6565 663a  work('dead:beef:
-000120c0: 3a2f 3634 2729 2c0a 2020 2020 2020 2020  :/64'),.        
-000120d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000120e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000120f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012100: 2020 6970 6164 6472 6573 732e 6970 5f6e    ipaddress.ip_n
-00012110: 6574 776f 726b 2827 3230 3031 3a64 6238  etwork('2001:db8
-00012120: 3a3a 332f 3132 3827 295d 290a 0a20 2020  ::3/128')])..   
-00012130: 2020 2020 2066 6f72 2028 692c 2028 6e61       for (i, (na
-00012140: 6d65 2c20 6164 6472 6573 732c 2073 7562  me, address, sub
-00012150: 6e65 7429 2920 696e 2065 6e75 6d65 7261  net)) in enumera
-00012160: 7465 285b 0a20 2020 2020 2020 2020 2020  te([.           
-00012170: 2020 2020 2028 276c 6f27 2c20 2731 3932       ('lo', '192
-00012180: 2e30 2e32 2e32 272c 2027 3139 322e 302e  .0.2.2', '192.0.
-00012190: 322e 302f 3234 2729 2c0a 2020 2020 2020  2.0/24'),.      
-000121a0: 2020 2020 2020 2020 2020 2827 6c6f 272c            ('lo',
-000121b0: 2027 6465 6164 3a62 6565 663a 3a31 272c   'dead:beef::1',
-000121c0: 2027 6465 6164 3a62 6565 663a 3a2f 3634   'dead:beef::/64
-000121d0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-000121e0: 2020 2020 2827 7475 6e27 2c20 2731 3932      ('tun', '192
-000121f0: 2e30 2e33 2e33 272c 2027 3139 322e 302e  .0.3.3', '192.0.
-00012200: 332e 332f 3332 2729 2c0a 2020 2020 2020  3.3/32'),.      
-00012210: 2020 2020 2020 2020 2020 2827 7475 6e27            ('tun'
-00012220: 2c20 2732 3030 313a 6462 383a 3a33 272c  , '2001:db8::3',
-00012230: 2027 3230 3031 3a64 6238 3a3a 332f 3132   '2001:db8::3/12
-00012240: 3827 292c 0a20 2020 2020 2020 2020 2020  8'),.           
-00012250: 2020 2020 2028 2774 756e 272c 2027 6665       ('tun', 'fe
-00012260: 3830 3a3a 313a 3127 2c20 2766 6538 303a  80::1:1', 'fe80:
-00012270: 3a2f 3634 2729 5d29 3a0a 2020 2020 2020  :/64')]):.      
-00012280: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00012290: 7445 7175 616c 2862 696e 6469 6e67 2e6e  tEqual(binding.n
-000122a0: 6574 776f 726b 2e69 6e74 6572 6661 6365  etwork.interface
-000122b0: 735b 695d 2e6e 616d 652c 206e 616d 6529  s[i].name, name)
-000122c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000122d0: 662e 6173 7365 7274 4571 7561 6c28 6269  f.assertEqual(bi
-000122e0: 6e64 696e 672e 6e65 7477 6f72 6b2e 696e  nding.network.in
-000122f0: 7465 7266 6163 6573 5b69 5d2e 6164 6472  terfaces[i].addr
-00012300: 6573 732c 2069 7061 6464 7265 7373 2e69  ess, ipaddress.i
-00012310: 705f 6164 6472 6573 7328 6164 6472 6573  p_address(addres
-00012320: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-00012330: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00012340: 2862 696e 6469 6e67 2e6e 6574 776f 726b  (binding.network
-00012350: 2e69 6e74 6572 6661 6365 735b 695d 2e73  .interfaces[i].s
-00012360: 7562 6e65 742c 2069 7061 6464 7265 7373  ubnet, ipaddress
-00012370: 2e69 705f 6e65 7477 6f72 6b28 7375 626e  .ip_network(subn
-00012380: 6574 2929 0a0a 2020 2020 2020 2020 666f  et))..        fo
-00012390: 7220 2869 2c20 286e 616d 652c 2061 6464  r (i, (name, add
-000123a0: 7265 7373 2c20 7375 626e 6574 2929 2069  ress, subnet)) i
-000123b0: 6e20 656e 756d 6572 6174 6528 5b0a 2020  n enumerate([.  
-000123c0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-000123d0: 6c6f 272c 2027 3139 322e 302e 322e 3227  lo', '192.0.2.2'
-000123e0: 2c20 2731 3932 2e30 2e32 2e30 2f32 3427  , '192.0.2.0/24'
-000123f0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00012400: 2020 2028 276c 6f27 2c20 2764 6561 643a     ('lo', 'dead:
-00012410: 6265 6566 3a3a 3127 2c20 2764 6561 643a  beef::1', 'dead:
-00012420: 6265 6566 3a3a 2f36 3427 292c 0a20 2020  beef::/64'),.   
-00012430: 2020 2020 2020 2020 2020 2020 2028 2774               ('t
-00012440: 756e 272c 2027 3139 322e 302e 332e 3327  un', '192.0.3.3'
-00012450: 2c20 2731 3932 2e30 2e33 2e33 2f33 3227  , '192.0.3.3/32'
-00012460: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00012470: 2020 2028 2774 756e 272c 2027 3230 3031     ('tun', '2001
-00012480: 3a64 6238 3a3a 3327 2c20 2732 3030 313a  :db8::3', '2001:
-00012490: 6462 383a 3a33 2f31 3238 2729 2c0a 2020  db8::3/128'),.  
-000124a0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-000124b0: 7475 6e27 2c20 2766 6538 303a 3a31 3a31  tun', 'fe80::1:1
-000124c0: 272c 2027 6665 3830 3a3a 2f36 3427 295d  ', 'fe80::/64')]
-000124d0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-000124e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000124f0: 6269 6e64 696e 672e 6e65 7477 6f72 6b2e  binding.network.
-00012500: 696e 7465 7266 6163 6573 5b69 5d2e 6e61  interfaces[i].na
-00012510: 6d65 2c20 6e61 6d65 290a 2020 2020 2020  me, name).      
-00012520: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00012530: 7445 7175 616c 2862 696e 6469 6e67 2e6e  tEqual(binding.n
-00012540: 6574 776f 726b 2e69 6e74 6572 6661 6365  etwork.interface
-00012550: 735b 695d 2e61 6464 7265 7373 2c20 6970  s[i].address, ip
-00012560: 6164 6472 6573 732e 6970 5f61 6464 7265  address.ip_addre
-00012570: 7373 2861 6464 7265 7373 2929 0a20 2020  ss(address)).   
-00012580: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
-00012590: 7365 7274 4571 7561 6c28 6269 6e64 696e  sertEqual(bindin
-000125a0: 672e 6e65 7477 6f72 6b2e 696e 7465 7266  g.network.interf
-000125b0: 6163 6573 5b69 5d2e 7375 626e 6574 2c20  aces[i].subnet, 
-000125c0: 6970 6164 6472 6573 732e 6970 5f6e 6574  ipaddress.ip_net
-000125d0: 776f 726b 2873 7562 6e65 7429 290a 0a20  work(subnet)).. 
-000125e0: 2020 2064 6566 2074 6573 745f 696e 7661     def test_inva
-000125f0: 6c69 645f 6b65 7973 2873 656c 6629 3a0a  lid_keys(self):.
-00012600: 2020 2020 2020 2020 2320 4261 7369 6320          # Basic 
-00012610: 7661 6c69 6461 7469 6f6e 2066 6f72 2070  validation for p
-00012620: 6173 7369 6e67 2069 6e76 616c 6964 206b  assing invalid k
-00012630: 6579 732e 0a20 2020 2020 2020 2066 6f72  eys..        for
-00012640: 206e 616d 6520 696e 2028 6f62 6a65 6374   name in (object
-00012650: 2c20 3029 3a0a 2020 2020 2020 2020 2020  , 0):.          
-00012660: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00012670: 7274 5261 6973 6573 286f 7073 2e4d 6f64  rtRaises(ops.Mod
-00012680: 656c 4572 726f 7229 3a0a 2020 2020 2020  elError):.      
-00012690: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
-000126a0: 6f64 656c 2e67 6574 5f62 696e 6469 6e67  odel.get_binding
-000126b0: 286e 616d 6529 0a0a 2020 2020 6465 6620  (name)..    def 
-000126c0: 7465 7374 5f64 6561 645f 7265 6c61 7469  test_dead_relati
-000126d0: 6f6e 7328 7365 6c66 293a 0a20 2020 2020  ons(self):.     
-000126e0: 2020 2066 616b 655f 7363 7269 7074 280a     fake_script(.
-000126f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00012700: 2c0a 2020 2020 2020 2020 2020 2020 276e  ,.            'n
-00012710: 6574 776f 726b 2d67 6574 272c 0a20 2020  etwork-get',.   
-00012720: 2020 2020 2020 2020 2066 2727 270a 2020           f'''.  
-00012730: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00012740: 205b 2022 2431 2220 3d20 6462 3020 5d20   [ "$1" = db0 ] 
-00012750: 2626 205b 2022 2432 2220 3d20 2d2d 666f  && [ "$2" = --fo
-00012760: 726d 6174 3d6a 736f 6e20 5d3b 2074 6865  rmat=json ]; the
-00012770: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-00012780: 2020 2020 2020 6563 686f 2027 7b73 656c        echo '{sel
-00012790: 662e 6e65 7477 6f72 6b5f 6765 745f 6f75  f.network_get_ou
-000127a0: 747d 270a 2020 2020 2020 2020 2020 2020  t}'.            
-000127b0: 2020 2020 656c 7365 0a20 2020 2020 2020      else.       
-000127c0: 2020 2020 2020 2020 2020 2020 2065 6368               ech
-000127d0: 6f20 4552 524f 5220 696e 7661 6c69 6420  o ERROR invalid 
-000127e0: 7661 6c75 6520 2224 3222 2066 6f72 206f  value "$2" for o
-000127f0: 7074 696f 6e20 2d72 3a20 7265 6c61 7469  ption -r: relati
-00012800: 6f6e 206e 6f74 2066 6f75 6e64 203e 2632  on not found >&2
-00012810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012820: 2020 2020 2065 7869 7420 320a 2020 2020       exit 2.    
-00012830: 2020 2020 2020 2020 2020 2020 6669 0a20              fi. 
-00012840: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
-00012850: 2020 2020 2020 2020 2320 5661 6c69 6461          # Valida
-00012860: 7465 2074 6865 2062 6568 6176 696f 7220  te the behavior 
-00012870: 666f 7220 6465 6164 2072 656c 6174 696f  for dead relatio
-00012880: 6e73 2e0a 2020 2020 2020 2020 6269 6e64  ns..        bind
-00012890: 696e 6720 3d20 6f70 732e 4269 6e64 696e  ing = ops.Bindin
-000128a0: 6728 2764 6230 272c 2034 322c 2073 656c  g('db0', 42, sel
-000128b0: 662e 6d6f 6465 6c2e 5f62 6163 6b65 6e64  f.model._backend
-000128c0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000128d0: 7373 6572 7445 7175 616c 2862 696e 6469  ssertEqual(bindi
-000128e0: 6e67 2e6e 6574 776f 726b 2e62 696e 645f  ng.network.bind_
-000128f0: 6164 6472 6573 732c 2069 7061 6464 7265  address, ipaddre
-00012900: 7373 2e69 705f 6164 6472 6573 7328 2731  ss.ip_address('1
-00012910: 3932 2e30 2e32 2e32 2729 290a 2020 2020  92.0.2.2')).    
-00012920: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00012930: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
-00012940: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
-00012950: 6172 3d54 7275 6529 2c20 5b0a 2020 2020  ar=True), [.    
-00012960: 2020 2020 2020 2020 5b27 6e65 7477 6f72          ['networ
-00012970: 6b2d 6765 7427 2c20 2764 6230 272c 2027  k-get', 'db0', '
-00012980: 2d72 272c 2027 3432 272c 2027 2d2d 666f  -r', '42', '--fo
-00012990: 726d 6174 3d6a 736f 6e27 5d2c 0a20 2020  rmat=json'],.   
-000129a0: 2020 2020 2020 2020 205b 276e 6574 776f           ['netwo
-000129b0: 726b 2d67 6574 272c 2027 6462 3027 2c20  rk-get', 'db0', 
-000129c0: 272d 2d66 6f72 6d61 743d 6a73 6f6e 275d  '--format=json']
-000129d0: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
-000129e0: 2020 6465 6620 7465 7374 5f62 696e 6469    def test_bindi
-000129f0: 6e67 5f62 795f 7265 6c61 7469 6f6e 5f6e  ng_by_relation_n
-00012a00: 616d 6528 7365 6c66 293a 0a20 2020 2020  ame(self):.     
-00012a10: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-00012a20: 656c 662c 2027 6e65 7477 6f72 6b2d 6765  elf, 'network-ge
-00012a30: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
-00012a40: 2020 2020 2020 2020 6627 2727 5b20 2224          f'''[ "$
-00012a50: 3122 203d 2064 6230 205d 2026 2620 6563  1" = db0 ] && ec
-00012a60: 686f 2027 7b73 656c 662e 6e65 7477 6f72  ho '{self.networ
-00012a70: 6b5f 6765 745f 6f75 747d 2720 7c7c 2065  k_get_out}' || e
-00012a80: 7869 7420 3127 2727 290a 2020 2020 2020  xit 1''').      
-00012a90: 2020 6269 6e64 696e 675f 6e61 6d65 203d    binding_name =
-00012aa0: 2027 6462 3027 0a20 2020 2020 2020 2065   'db0'.        e
-00012ab0: 7870 6563 7465 645f 6361 6c6c 7320 3d20  xpected_calls = 
-00012ac0: 5b5b 276e 6574 776f 726b 2d67 6574 272c  [['network-get',
-00012ad0: 2027 6462 3027 2c20 272d 2d66 6f72 6d61   'db0', '--forma
-00012ae0: 743d 6a73 6f6e 275d 5d0a 0a20 2020 2020  t=json']]..     
-00012af0: 2020 2062 696e 6469 6e67 203d 2073 656c     binding = sel
-00012b00: 662e 6d6f 6465 6c2e 6765 745f 6269 6e64  f.model.get_bind
-00012b10: 696e 6728 6269 6e64 696e 675f 6e61 6d65  ing(binding_name
-00012b20: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
-00012b30: 6368 6563 6b5f 6269 6e64 696e 675f 6461  check_binding_da
-00012b40: 7461 2862 696e 6469 6e67 5f6e 616d 652c  ta(binding_name,
-00012b50: 2062 696e 6469 6e67 290a 2020 2020 2020   binding).      
-00012b60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00012b70: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
-00012b80: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
-00012b90: 3d54 7275 6529 2c20 6578 7065 6374 6564  =True), expected
-00012ba0: 5f63 616c 6c73 290a 0a20 2020 2064 6566  _calls)..    def
-00012bb0: 2074 6573 745f 6269 6e64 696e 675f 6279   test_binding_by
-00012bc0: 5f72 656c 6174 696f 6e28 7365 6c66 293a  _relation(self):
-00012bd0: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
-00012be0: 7269 7074 2873 656c 662c 2027 6e65 7477  ript(self, 'netw
-00012bf0: 6f72 6b2d 6765 7427 2c0a 2020 2020 2020  ork-get',.      
-00012c00: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00012c10: 2727 5b20 2224 3122 203d 2064 6230 205d  ''[ "$1" = db0 ]
-00012c20: 2026 2620 6563 686f 2027 7b73 656c 662e   && echo '{self.
-00012c30: 6e65 7477 6f72 6b5f 6765 745f 6f75 747d  network_get_out}
-00012c40: 2720 7c7c 2065 7869 7420 3127 2727 290a  ' || exit 1''').
-00012c50: 2020 2020 2020 2020 6269 6e64 696e 675f          binding_
-00012c60: 6e61 6d65 203d 2027 6462 3027 0a20 2020  name = 'db0'.   
-00012c70: 2020 2020 2065 7870 6563 7465 645f 6361       expected_ca
-00012c80: 6c6c 7320 3d20 5b0a 2020 2020 2020 2020  lls = [.        
-00012c90: 2020 2020 5b27 7265 6c61 7469 6f6e 2d69      ['relation-i
-00012ca0: 6473 272c 2027 6462 3027 2c20 272d 2d66  ds', 'db0', '--f
-00012cb0: 6f72 6d61 743d 6a73 6f6e 275d 2c0a 2020  ormat=json'],.  
-00012cc0: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
-00012cd0: 7477 6f20 696e 766f 6361 7469 6f6e 7320  two invocations 
-00012ce0: 6265 6c6f 7720 6172 6520 6475 6520 746f  below are due to
-00012cf0: 2074 6865 2067 6574 5f72 656c 6174 696f   the get_relatio
-00012d00: 6e20 6361 6c6c 2e0a 2020 2020 2020 2020  n call..        
-00012d10: 2020 2020 5b27 7265 6c61 7469 6f6e 2d6c      ['relation-l
-00012d20: 6973 7427 2c20 272d 7227 2c20 2734 272c  ist', '-r', '4',
-00012d30: 2027 2d2d 666f 726d 6174 3d6a 736f 6e27   '--format=json'
-00012d40: 5d2c 0a20 2020 2020 2020 2020 2020 205b  ],.            [
-00012d50: 276e 6574 776f 726b 2d67 6574 272c 2027  'network-get', '
-00012d60: 6462 3027 2c20 272d 7227 2c20 2734 272c  db0', '-r', '4',
-00012d70: 2027 2d2d 666f 726d 6174 3d6a 736f 6e27   '--format=json'
-00012d80: 5d2c 0a20 2020 2020 2020 205d 0a20 2020  ],.        ].   
-00012d90: 2020 2020 2062 696e 6469 6e67 203d 2073       binding = s
-00012da0: 656c 662e 6d6f 6465 6c2e 6765 745f 6269  elf.model.get_bi
-00012db0: 6e64 696e 6728 7365 6c66 2e6d 6f64 656c  nding(self.model
-00012dc0: 2e67 6574 5f72 656c 6174 696f 6e28 6269  .get_relation(bi
-00012dd0: 6e64 696e 675f 6e61 6d65 2929 0a20 2020  nding_name)).   
-00012de0: 2020 2020 2073 656c 662e 5f63 6865 636b       self._check
-00012df0: 5f62 696e 6469 6e67 5f64 6174 6128 6269  _binding_data(bi
-00012e00: 6e64 696e 675f 6e61 6d65 2c20 6269 6e64  nding_name, bind
-00012e10: 696e 6729 0a20 2020 2020 2020 2073 656c  ing).        sel
-00012e20: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-00012e30: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-00012e40: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
-00012e50: 292c 2065 7870 6563 7465 645f 6361 6c6c  ), expected_call
-00012e60: 7329 0a0a 2020 2020 6465 6620 7465 7374  s)..    def test
-00012e70: 5f62 696e 6469 6e67 5f6e 6f5f 6966 6163  _binding_no_ifac
-00012e80: 655f 6e61 6d65 2873 656c 6629 3a0a 2020  e_name(self):.  
-00012e90: 2020 2020 2020 6e65 7477 6f72 6b5f 6765        network_ge
-00012ea0: 745f 6f75 745f 6f62 6a20 3d20 7b0a 2020  t_out_obj = {.  
-00012eb0: 2020 2020 2020 2020 2020 2762 696e 642d            'bind-
-00012ec0: 6164 6472 6573 7365 7327 3a20 5b0a 2020  addresses': [.  
-00012ed0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-00012ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ef0: 2020 2020 276d 6163 2d61 6464 7265 7373      'mac-address
-00012f00: 273a 2027 272c 0a20 2020 2020 2020 2020  ': '',.         
-00012f10: 2020 2020 2020 2020 2020 2027 696e 7465             'inte
-00012f20: 7266 6163 652d 6e61 6d65 273a 2027 272c  rface-name': '',
+0000f030: 2020 2773 7461 7475 7327 3a20 2775 7027    'status': 'up'
+0000f040: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f050: 2020 2766 6169 6c75 7265 7327 3a20 302c    'failures': 0,
+0000f060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f070: 2027 7468 7265 7368 6f6c 6427 3a20 332c   'threshold': 3,
+0000f080: 0a20 2020 2020 2020 2020 2020 207d 292c  .            }),
+0000f090: 0a20 2020 2020 2020 2020 2020 2070 6562  .            peb
+0000f0a0: 626c 652e 4368 6563 6b49 6e66 6f2e 6672  ble.CheckInfo.fr
+0000f0b0: 6f6d 5f64 6963 7428 7b0a 2020 2020 2020  om_dict({.      
+0000f0c0: 2020 2020 2020 2020 2020 276e 616d 6527            'name'
+0000f0d0: 3a20 2763 3227 2c0a 2020 2020 2020 2020  : 'c2',.        
+0000f0e0: 2020 2020 2020 2020 276c 6576 656c 273a          'level':
+0000f0f0: 2027 616c 6976 6527 2c0a 2020 2020 2020   'alive',.      
+0000f100: 2020 2020 2020 2020 2020 2773 7461 7475            'statu
+0000f110: 7327 3a20 2764 6f77 6e27 2c0a 2020 2020  s': 'down',.    
+0000f120: 2020 2020 2020 2020 2020 2020 2766 6169              'fai
+0000f130: 6c75 7265 7327 3a20 322c 0a20 2020 2020  lures': 2,.     
+0000f140: 2020 2020 2020 2020 2020 2027 7468 7265             'thre
+0000f150: 7368 6f6c 6427 3a20 322c 0a20 2020 2020  shold': 2,.     
+0000f160: 2020 2020 2020 207d 292c 0a20 2020 2020         }),.     
+0000f170: 2020 205d 0a0a 2020 2020 2020 2020 7365     ]..        se
+0000f180: 6c66 2e70 6562 626c 652e 7265 7370 6f6e  lf.pebble.respon
+0000f190: 7365 732e 6170 7065 6e64 2872 6573 706f  ses.append(respo
+0000f1a0: 6e73 655f 6368 6563 6b73 290a 2020 2020  nse_checks).    
+0000f1b0: 2020 2020 6368 6563 6b73 203d 2073 656c      checks = sel
+0000f1c0: 662e 636f 6e74 6169 6e65 722e 6765 745f  f.container.get_
+0000f1d0: 6368 6563 6b73 2829 0a20 2020 2020 2020  checks().       
+0000f1e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000f1f0: 6c28 6c65 6e28 6368 6563 6b73 292c 2032  l(len(checks), 2
+0000f200: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000f210: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
+0000f220: 735b 2763 3127 5d2e 6e61 6d65 2c20 2763  s['c1'].name, 'c
+0000f230: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
+0000f240: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
+0000f250: 636b 735b 2763 3127 5d2e 6c65 7665 6c2c  cks['c1'].level,
+0000f260: 2070 6562 626c 652e 4368 6563 6b4c 6576   pebble.CheckLev
+0000f270: 656c 2e55 4e53 4554 290a 2020 2020 2020  el.UNSET).      
+0000f280: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000f290: 616c 2863 6865 636b 735b 2763 3127 5d2e  al(checks['c1'].
+0000f2a0: 7374 6174 7573 2c20 7065 6262 6c65 2e43  status, pebble.C
+0000f2b0: 6865 636b 5374 6174 7573 2e55 5029 0a20  heckStatus.UP). 
+0000f2c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000f2d0: 7274 4571 7561 6c28 6368 6563 6b73 5b27  rtEqual(checks['
+0000f2e0: 6331 275d 2e66 6169 6c75 7265 732c 2030  c1'].failures, 0
+0000f2f0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000f300: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
+0000f310: 735b 2763 3127 5d2e 7468 7265 7368 6f6c  s['c1'].threshol
+0000f320: 642c 2033 290a 2020 2020 2020 2020 7365  d, 3).        se
+0000f330: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+0000f340: 6865 636b 735b 2763 3227 5d2e 6e61 6d65  hecks['c2'].name
+0000f350: 2c20 2763 3227 290a 2020 2020 2020 2020  , 'c2').        
+0000f360: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000f370: 2863 6865 636b 735b 2763 3227 5d2e 6c65  (checks['c2'].le
+0000f380: 7665 6c2c 2070 6562 626c 652e 4368 6563  vel, pebble.Chec
+0000f390: 6b4c 6576 656c 2e41 4c49 5645 290a 2020  kLevel.ALIVE).  
+0000f3a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000f3b0: 7445 7175 616c 2863 6865 636b 735b 2763  tEqual(checks['c
+0000f3c0: 3227 5d2e 7374 6174 7573 2c20 7065 6262  2'].status, pebb
+0000f3d0: 6c65 2e43 6865 636b 5374 6174 7573 2e44  le.CheckStatus.D
+0000f3e0: 4f57 4e29 0a20 2020 2020 2020 2073 656c  OWN).        sel
+0000f3f0: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+0000f400: 6563 6b73 5b27 6332 275d 2e66 6169 6c75  ecks['c2'].failu
+0000f410: 7265 732c 2032 290a 2020 2020 2020 2020  res, 2).        
+0000f420: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000f430: 2863 6865 636b 735b 2763 3227 5d2e 7468  (checks['c2'].th
+0000f440: 7265 7368 6f6c 642c 2032 290a 0a20 2020  reshold, 2)..   
+0000f450: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
+0000f460: 2e72 6573 706f 6e73 6573 2e61 7070 656e  .responses.appen
+0000f470: 6428 7265 7370 6f6e 7365 5f63 6865 636b  d(response_check
+0000f480: 735b 313a 325d 290a 2020 2020 2020 2020  s[1:2]).        
+0000f490: 6368 6563 6b73 203d 2073 656c 662e 636f  checks = self.co
+0000f4a0: 6e74 6169 6e65 722e 6765 745f 6368 6563  ntainer.get_chec
+0000f4b0: 6b73 2827 6331 272c 2027 6332 272c 206c  ks('c1', 'c2', l
+0000f4c0: 6576 656c 3d70 6562 626c 652e 4368 6563  evel=pebble.Chec
+0000f4d0: 6b4c 6576 656c 2e41 4c49 5645 290a 2020  kLevel.ALIVE).  
+0000f4e0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000f4f0: 7445 7175 616c 286c 656e 2863 6865 636b  tEqual(len(check
+0000f500: 7329 2c20 3129 0a20 2020 2020 2020 2073  s), 1).        s
+0000f510: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000f520: 6368 6563 6b73 5b27 6332 275d 2e6e 616d  checks['c2'].nam
+0000f530: 652c 2027 6332 2729 0a20 2020 2020 2020  e, 'c2').       
+0000f540: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000f550: 6c28 6368 6563 6b73 5b27 6332 275d 2e6c  l(checks['c2'].l
+0000f560: 6576 656c 2c20 7065 6262 6c65 2e43 6865  evel, pebble.Che
+0000f570: 636b 4c65 7665 6c2e 414c 4956 4529 0a20  ckLevel.ALIVE). 
+0000f580: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000f590: 7274 4571 7561 6c28 6368 6563 6b73 5b27  rtEqual(checks['
+0000f5a0: 6332 275d 2e73 7461 7475 732c 2070 6562  c2'].status, peb
+0000f5b0: 626c 652e 4368 6563 6b53 7461 7475 732e  ble.CheckStatus.
+0000f5c0: 444f 574e 290a 2020 2020 2020 2020 7365  DOWN).        se
+0000f5d0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+0000f5e0: 6865 636b 735b 2763 3227 5d2e 6661 696c  hecks['c2'].fail
+0000f5f0: 7572 6573 2c20 3229 0a20 2020 2020 2020  ures, 2).       
+0000f600: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000f610: 6c28 6368 6563 6b73 5b27 6332 275d 2e74  l(checks['c2'].t
+0000f620: 6872 6573 686f 6c64 2c20 3229 0a0a 2020  hreshold, 2)..  
+0000f630: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000f640: 7445 7175 616c 2873 656c 662e 7065 6262  tEqual(self.pebb
+0000f650: 6c65 2e72 6571 7565 7374 732c 205b 0a20  le.requests, [. 
+0000f660: 2020 2020 2020 2020 2020 2028 2767 6574             ('get
+0000f670: 5f63 6865 636b 7327 2c20 4e6f 6e65 2c20  _checks', None, 
+0000f680: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
+0000f690: 2020 2028 2767 6574 5f63 6865 636b 7327     ('get_checks'
+0000f6a0: 2c20 7065 6262 6c65 2e43 6865 636b 4c65  , pebble.CheckLe
+0000f6b0: 7665 6c2e 414c 4956 452c 2028 2763 3127  vel.ALIVE, ('c1'
+0000f6c0: 2c20 2763 3227 2929 2c0a 2020 2020 2020  , 'c2')),.      
+0000f6d0: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
+0000f6e0: 7374 5f67 6574 5f63 6865 636b 2873 656c  st_get_check(sel
+0000f6f0: 6629 3a0a 2020 2020 2020 2020 2320 5369  f):.        # Si
+0000f700: 6e67 6c65 2063 6865 636b 2072 6574 7572  ngle check retur
+0000f710: 6e65 6420 7375 6363 6573 7366 756c 6c79  ned successfully
+0000f720: 0a20 2020 2020 2020 2073 656c 662e 7065  .        self.pe
+0000f730: 6262 6c65 2e72 6573 706f 6e73 6573 2e61  bble.responses.a
+0000f740: 7070 656e 6428 5b0a 2020 2020 2020 2020  ppend([.        
+0000f750: 2020 2020 7065 6262 6c65 2e43 6865 636b      pebble.Check
+0000f760: 496e 666f 2e66 726f 6d5f 6469 6374 287b  Info.from_dict({
+0000f770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f780: 2027 6e61 6d65 273a 2027 6331 272c 0a20   'name': 'c1',. 
+0000f790: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000f7a0: 7374 6174 7573 273a 2027 7570 272c 0a20  status': 'up',. 
+0000f7b0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000f7c0: 6661 696c 7572 6573 273a 2030 2c0a 2020  failures': 0,.  
+0000f7d0: 2020 2020 2020 2020 2020 2020 2020 2774                't
+0000f7e0: 6872 6573 686f 6c64 273a 2033 2c0a 2020  hreshold': 3,.  
+0000f7f0: 2020 2020 2020 2020 2020 7d29 0a20 2020            }).   
+0000f800: 2020 2020 205d 290a 2020 2020 2020 2020       ]).        
+0000f810: 6320 3d20 7365 6c66 2e63 6f6e 7461 696e  c = self.contain
+0000f820: 6572 2e67 6574 5f63 6865 636b 2827 6331  er.get_check('c1
+0000f830: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0000f840: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+0000f850: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
+0000f860: 2c20 5b28 2767 6574 5f63 6865 636b 7327  , [('get_checks'
+0000f870: 2c20 4e6f 6e65 2c20 2827 6331 272c 2029  , None, ('c1', )
+0000f880: 295d 290a 2020 2020 2020 2020 7365 6c66  )]).        self
+0000f890: 2e61 7373 6572 7445 7175 616c 2863 2e6e  .assertEqual(c.n
+0000f8a0: 616d 652c 2027 6331 2729 0a20 2020 2020  ame, 'c1').     
+0000f8b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000f8c0: 7561 6c28 632e 6c65 7665 6c2c 2070 6562  ual(c.level, peb
+0000f8d0: 626c 652e 4368 6563 6b4c 6576 656c 2e55  ble.CheckLevel.U
+0000f8e0: 4e53 4554 290a 2020 2020 2020 2020 7365  NSET).        se
+0000f8f0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+0000f900: 2e73 7461 7475 732c 2070 6562 626c 652e  .status, pebble.
+0000f910: 4368 6563 6b53 7461 7475 732e 5550 290a  CheckStatus.UP).
+0000f920: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000f930: 6572 7445 7175 616c 2863 2e66 6169 6c75  ertEqual(c.failu
+0000f940: 7265 732c 2030 290a 2020 2020 2020 2020  res, 0).        
+0000f950: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000f960: 2863 2e74 6872 6573 686f 6c64 2c20 3329  (c.threshold, 3)
+0000f970: 0a0a 2020 2020 2020 2020 2320 4966 2050  ..        # If P
+0000f980: 6562 626c 6520 7265 7475 726e 7320 6e6f  ebble returns no
+0000f990: 2063 6865 636b 732c 2073 686f 756c 6420   checks, should 
+0000f9a0: 6265 2061 206f 7073 2e4d 6f64 656c 4572  be a ops.ModelEr
+0000f9b0: 726f 720a 2020 2020 2020 2020 7365 6c66  ror.        self
+0000f9c0: 2e70 6562 626c 652e 7265 7370 6f6e 7365  .pebble.response
+0000f9d0: 732e 6170 7065 6e64 285b 5d29 0a20 2020  s.append([]).   
+0000f9e0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0000f9f0: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
+0000fa00: 4d6f 6465 6c45 7272 6f72 2920 6173 2063  ModelError) as c
+0000fa10: 6d3a 0a20 2020 2020 2020 2020 2020 2073  m:.            s
+0000fa20: 656c 662e 636f 6e74 6169 6e65 722e 6765  elf.container.ge
+0000fa30: 745f 6368 6563 6b28 2763 3227 290a 2020  t_check('c2').  
+0000fa40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000fa50: 7445 7175 616c 2873 7472 2863 6d2e 6578  tEqual(str(cm.ex
+0000fa60: 6365 7074 696f 6e29 2c20 2263 6865 636b  ception), "check
+0000fa70: 2027 6332 2720 6e6f 7420 666f 756e 6422   'c2' not found"
+0000fa80: 290a 0a20 2020 2020 2020 2023 2049 6620  )..        # If 
+0000fa90: 5065 6262 6c65 2072 6574 7572 6e73 206d  Pebble returns m
+0000faa0: 6f72 6520 7468 616e 206f 6e65 2063 6865  ore than one che
+0000fab0: 636b 2c20 5275 6e74 696d 6545 7272 6f72  ck, RuntimeError
+0000fac0: 2069 7320 7261 6973 6564 0a20 2020 2020   is raised.     
+0000fad0: 2020 2073 656c 662e 7065 6262 6c65 2e72     self.pebble.r
+0000fae0: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
+0000faf0: 5b0a 2020 2020 2020 2020 2020 2020 7065  [.            pe
+0000fb00: 6262 6c65 2e43 6865 636b 496e 666f 2e66  bble.CheckInfo.f
+0000fb10: 726f 6d5f 6469 6374 287b 0a20 2020 2020  rom_dict({.     
+0000fb20: 2020 2020 2020 2020 2020 2027 6e61 6d65             'name
+0000fb30: 273a 2027 6331 272c 0a20 2020 2020 2020  ': 'c1',.       
+0000fb40: 2020 2020 2020 2020 2027 7374 6174 7573           'status
+0000fb50: 273a 2027 7570 272c 0a20 2020 2020 2020  ': 'up',.       
+0000fb60: 2020 2020 2020 2020 2027 6661 696c 7572           'failur
+0000fb70: 6573 273a 2030 2c0a 2020 2020 2020 2020  es': 0,.        
+0000fb80: 2020 2020 2020 2020 2774 6872 6573 686f          'thresho
+0000fb90: 6c64 273a 2033 2c0a 2020 2020 2020 2020  ld': 3,.        
+0000fba0: 2020 2020 7d29 2c0a 2020 2020 2020 2020      }),.        
+0000fbb0: 2020 2020 7065 6262 6c65 2e43 6865 636b      pebble.Check
+0000fbc0: 496e 666f 2e66 726f 6d5f 6469 6374 287b  Info.from_dict({
+0000fbd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fbe0: 2027 6e61 6d65 273a 2027 6332 272c 0a20   'name': 'c2',. 
+0000fbf0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000fc00: 6c65 7665 6c27 3a20 2761 6c69 7665 272c  level': 'alive',
+0000fc10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fc20: 2027 7374 6174 7573 273a 2027 646f 776e   'status': 'down
+0000fc30: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0000fc40: 2020 2027 6661 696c 7572 6573 273a 2032     'failures': 2
+0000fc50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000fc60: 2020 2774 6872 6573 686f 6c64 273a 2032    'threshold': 2
+0000fc70: 2c0a 2020 2020 2020 2020 2020 2020 7d29  ,.            })
+0000fc80: 2c0a 2020 2020 2020 2020 5d29 0a20 2020  ,.        ]).   
+0000fc90: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0000fca0: 7373 6572 7452 6169 7365 7328 5275 6e74  ssertRaises(Runt
+0000fcb0: 696d 6545 7272 6f72 293a 0a20 2020 2020  imeError):.     
+0000fcc0: 2020 2020 2020 2073 656c 662e 636f 6e74         self.cont
+0000fcd0: 6169 6e65 722e 6765 745f 6368 6563 6b28  ainer.get_check(
+0000fce0: 2763 3127 290a 0a20 2020 2064 6566 2074  'c1')..    def t
+0000fcf0: 6573 745f 7075 6c6c 2873 656c 6629 3a0a  est_pull(self):.
+0000fd00: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+0000fd10: 626c 652e 7265 7370 6f6e 7365 732e 6170  ble.responses.ap
+0000fd20: 7065 6e64 2827 6475 6d6d 7931 2729 0a20  pend('dummy1'). 
+0000fd30: 2020 2020 2020 2067 6f74 203d 2073 656c         got = sel
+0000fd40: 662e 636f 6e74 6169 6e65 722e 7075 6c6c  f.container.pull
+0000fd50: 2827 2f70 6174 682f 3127 290a 2020 2020  ('/path/1').    
+0000fd60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000fd70: 7175 616c 2867 6f74 2c20 2764 756d 6d79  qual(got, 'dummy
+0000fd80: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
+0000fd90: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
+0000fda0: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
+0000fdb0: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
+0000fdc0: 2028 2770 756c 6c27 2c20 272f 7061 7468   ('pull', '/path
+0000fdd0: 2f31 272c 2027 7574 662d 3827 292c 0a20  /1', 'utf-8'),. 
+0000fde0: 2020 2020 2020 205d 290a 2020 2020 2020         ]).      
+0000fdf0: 2020 7365 6c66 2e70 6562 626c 652e 7265    self.pebble.re
+0000fe00: 7175 6573 7473 203d 205b 5d0a 0a20 2020  quests = []..   
+0000fe10: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
+0000fe20: 2e72 6573 706f 6e73 6573 2e61 7070 656e  .responses.appen
+0000fe30: 6428 6227 6475 6d6d 7932 2729 0a20 2020  d(b'dummy2').   
+0000fe40: 2020 2020 2067 6f74 203d 2073 656c 662e       got = self.
+0000fe50: 636f 6e74 6169 6e65 722e 7075 6c6c 2827  container.pull('
+0000fe60: 2f70 6174 682f 3227 2c20 656e 636f 6469  /path/2', encodi
+0000fe70: 6e67 3d4e 6f6e 6529 0a20 2020 2020 2020  ng=None).       
+0000fe80: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000fe90: 6c28 676f 742c 2062 2764 756d 6d79 3227  l(got, b'dummy2'
+0000fea0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000feb0: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+0000fec0: 7065 6262 6c65 2e72 6571 7565 7374 732c  pebble.requests,
+0000fed0: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+0000fee0: 2770 756c 6c27 2c20 272f 7061 7468 2f32  'pull', '/path/2
+0000fef0: 272c 204e 6f6e 6529 2c0a 2020 2020 2020  ', None),.      
+0000ff00: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
+0000ff10: 7374 5f70 7573 6828 7365 6c66 293a 0a20  st_push(self):. 
+0000ff20: 2020 2020 2020 2073 656c 662e 636f 6e74         self.cont
+0000ff30: 6169 6e65 722e 7075 7368 2827 2f70 6174  ainer.push('/pat
+0000ff40: 682f 3127 2c20 2763 6f6e 7465 6e74 3127  h/1', 'content1'
+0000ff50: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000ff60: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+0000ff70: 7065 6262 6c65 2e72 6571 7565 7374 732c  pebble.requests,
+0000ff80: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+0000ff90: 2770 7573 6827 2c20 272f 7061 7468 2f31  'push', '/path/1
+0000ffa0: 272c 2027 636f 6e74 656e 7431 272c 2027  ', 'content1', '
+0000ffb0: 7574 662d 3827 2c20 4661 6c73 652c 204e  utf-8', False, N
+0000ffc0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+0000ffd0: 2020 4e6f 6e65 2c20 4e6f 6e65 2c20 4e6f    None, None, No
+0000ffe0: 6e65 2c20 4e6f 6e65 292c 0a20 2020 2020  ne, None),.     
+0000fff0: 2020 205d 290a 2020 2020 2020 2020 7365     ]).        se
+00010000: 6c66 2e70 6562 626c 652e 7265 7175 6573  lf.pebble.reques
+00010010: 7473 203d 205b 5d0a 0a20 2020 2020 2020  ts = []..       
+00010020: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
+00010030: 7075 7368 2827 2f70 6174 682f 3227 2c20  push('/path/2', 
+00010040: 6227 636f 6e74 656e 7432 272c 2065 6e63  b'content2', enc
+00010050: 6f64 696e 673d 4e6f 6e65 2c20 6d61 6b65  oding=None, make
+00010060: 5f64 6972 733d 5472 7565 2c0a 2020 2020  _dirs=True,.    
+00010070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010080: 2020 2020 2020 2020 7065 726d 6973 7369          permissi
+00010090: 6f6e 733d 306f 3630 302c 2075 7365 725f  ons=0o600, user_
+000100a0: 6964 3d31 322c 2075 7365 723d 2762 6f62  id=12, user='bob
+000100b0: 272c 2067 726f 7570 5f69 643d 3334 2c20  ', group_id=34, 
+000100c0: 6772 6f75 703d 2773 7461 6666 2729 0a20  group='staff'). 
+000100d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000100e0: 7274 4571 7561 6c28 7365 6c66 2e70 6562  rtEqual(self.peb
+000100f0: 626c 652e 7265 7175 6573 7473 2c20 5b0a  ble.requests, [.
+00010100: 2020 2020 2020 2020 2020 2020 2827 7075              ('pu
+00010110: 7368 272c 2027 2f70 6174 682f 3227 2c20  sh', '/path/2', 
+00010120: 6227 636f 6e74 656e 7432 272c 204e 6f6e  b'content2', Non
+00010130: 652c 2054 7275 652c 2030 6f36 3030 2c20  e, True, 0o600, 
+00010140: 3132 2c20 2762 6f62 272c 2033 342c 2027  12, 'bob', 34, '
+00010150: 7374 6166 6627 292c 0a20 2020 2020 2020  staff'),.       
+00010160: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
+00010170: 745f 6c69 7374 5f66 696c 6573 2873 656c  t_list_files(sel
+00010180: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+00010190: 2e70 6562 626c 652e 7265 7370 6f6e 7365  .pebble.response
+000101a0: 732e 6170 7065 6e64 2827 6475 6d6d 7931  s.append('dummy1
+000101b0: 2729 0a20 2020 2020 2020 2072 6574 203d  ').        ret =
+000101c0: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
+000101d0: 6c69 7374 5f66 696c 6573 2827 2f70 6174  list_files('/pat
+000101e0: 682f 3127 290a 2020 2020 2020 2020 7365  h/1').        se
+000101f0: 6c66 2e61 7373 6572 7445 7175 616c 2872  lf.assertEqual(r
+00010200: 6574 2c20 2764 756d 6d79 3127 290a 2020  et, 'dummy1').  
+00010210: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00010220: 7445 7175 616c 2873 656c 662e 7065 6262  tEqual(self.pebb
+00010230: 6c65 2e72 6571 7565 7374 732c 205b 0a20  le.requests, [. 
+00010240: 2020 2020 2020 2020 2020 2028 276c 6973             ('lis
+00010250: 745f 6669 6c65 7327 2c20 272f 7061 7468  t_files', '/path
+00010260: 2f31 272c 204e 6f6e 652c 2046 616c 7365  /1', None, False
+00010270: 292c 0a20 2020 2020 2020 205d 290a 2020  ),.        ]).  
+00010280: 2020 2020 2020 7365 6c66 2e70 6562 626c        self.pebbl
+00010290: 652e 7265 7175 6573 7473 203d 205b 5d0a  e.requests = [].
+000102a0: 0a20 2020 2020 2020 2073 656c 662e 7065  .        self.pe
+000102b0: 6262 6c65 2e72 6573 706f 6e73 6573 2e61  bble.responses.a
+000102c0: 7070 656e 6428 2764 756d 6d79 3227 290a  ppend('dummy2').
+000102d0: 2020 2020 2020 2020 7265 7420 3d20 7365          ret = se
+000102e0: 6c66 2e63 6f6e 7461 696e 6572 2e6c 6973  lf.container.lis
+000102f0: 745f 6669 6c65 7328 272f 7061 7468 2f32  t_files('/path/2
+00010300: 272c 2070 6174 7465 726e 3d27 2a2e 7478  ', pattern='*.tx
+00010310: 7427 2c20 6974 7365 6c66 3d54 7275 6529  t', itself=True)
+00010320: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00010330: 7365 7274 4571 7561 6c28 7265 742c 2027  sertEqual(ret, '
+00010340: 6475 6d6d 7932 2729 0a20 2020 2020 2020  dummy2').       
+00010350: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00010360: 6c28 7365 6c66 2e70 6562 626c 652e 7265  l(self.pebble.re
+00010370: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
+00010380: 2020 2020 2020 2827 6c69 7374 5f66 696c        ('list_fil
+00010390: 6573 272c 2027 2f70 6174 682f 3227 2c20  es', '/path/2', 
+000103a0: 272a 2e74 7874 272c 2054 7275 6529 2c0a  '*.txt', True),.
+000103b0: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
+000103c0: 6465 6620 7465 7374 5f6d 616b 655f 6469  def test_make_di
+000103d0: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
+000103e0: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
+000103f0: 6d61 6b65 5f64 6972 2827 2f70 6174 682f  make_dir('/path/
+00010400: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
+00010410: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
+00010420: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
+00010430: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
+00010440: 2028 276d 616b 655f 6469 7227 2c20 272f   ('make_dir', '/
+00010450: 7061 7468 2f31 272c 2046 616c 7365 2c20  path/1', False, 
+00010460: 4e6f 6e65 2c20 4e6f 6e65 2c20 4e6f 6e65  None, None, None
+00010470: 2c20 4e6f 6e65 2c20 4e6f 6e65 292c 0a20  , None, None),. 
+00010480: 2020 2020 2020 205d 290a 2020 2020 2020         ]).      
+00010490: 2020 7365 6c66 2e70 6562 626c 652e 7265    self.pebble.re
+000104a0: 7175 6573 7473 203d 205b 5d0a 0a20 2020  quests = []..   
+000104b0: 2020 2020 2073 656c 662e 636f 6e74 6169       self.contai
+000104c0: 6e65 722e 6d61 6b65 5f64 6972 2827 2f70  ner.make_dir('/p
+000104d0: 6174 682f 3227 2c20 6d61 6b65 5f70 6172  ath/2', make_par
+000104e0: 656e 7473 3d54 7275 652c 2070 6572 6d69  ents=True, permi
+000104f0: 7373 696f 6e73 3d30 6f37 3030 2c0a 2020  ssions=0o700,.  
+00010500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010510: 2020 2020 2020 2020 2020 2020 2020 7573                us
+00010520: 6572 5f69 643d 3132 2c20 7573 6572 3d27  er_id=12, user='
+00010530: 626f 6227 2c20 6772 6f75 705f 6964 3d33  bob', group_id=3
+00010540: 342c 2067 726f 7570 3d27 7374 6166 6627  4, group='staff'
+00010550: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00010560: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+00010570: 7065 6262 6c65 2e72 6571 7565 7374 732c  pebble.requests,
+00010580: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+00010590: 276d 616b 655f 6469 7227 2c20 272f 7061  'make_dir', '/pa
+000105a0: 7468 2f32 272c 2054 7275 652c 2030 6f37  th/2', True, 0o7
+000105b0: 3030 2c20 3132 2c20 2762 6f62 272c 2033  00, 12, 'bob', 3
+000105c0: 342c 2027 7374 6166 6627 292c 0a20 2020  4, 'staff'),.   
+000105d0: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
+000105e0: 2074 6573 745f 7265 6d6f 7665 5f70 6174   test_remove_pat
+000105f0: 6828 7365 6c66 293a 0a20 2020 2020 2020  h(self):.       
+00010600: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
+00010610: 7265 6d6f 7665 5f70 6174 6828 272f 7061  remove_path('/pa
+00010620: 7468 2f31 2729 0a20 2020 2020 2020 2073  th/1').        s
+00010630: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00010640: 7365 6c66 2e70 6562 626c 652e 7265 7175  self.pebble.requ
+00010650: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
+00010660: 2020 2020 2827 7265 6d6f 7665 5f70 6174      ('remove_pat
+00010670: 6827 2c20 272f 7061 7468 2f31 272c 2046  h', '/path/1', F
+00010680: 616c 7365 292c 0a20 2020 2020 2020 205d  alse),.        ]
+00010690: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
+000106a0: 6562 626c 652e 7265 7175 6573 7473 203d  ebble.requests =
+000106b0: 205b 5d0a 0a20 2020 2020 2020 2073 656c   []..        sel
+000106c0: 662e 636f 6e74 6169 6e65 722e 7265 6d6f  f.container.remo
+000106d0: 7665 5f70 6174 6828 272f 7061 7468 2f32  ve_path('/path/2
+000106e0: 272c 2072 6563 7572 7369 7665 3d54 7275  ', recursive=Tru
+000106f0: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
+00010700: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+00010710: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
+00010720: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+00010730: 2827 7265 6d6f 7665 5f70 6174 6827 2c20  ('remove_path', 
+00010740: 272f 7061 7468 2f32 272c 2054 7275 6529  '/path/2', True)
+00010750: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
+00010760: 2020 6465 6620 7465 7374 5f63 616e 5f63    def test_can_c
+00010770: 6f6e 6e65 6374 5f73 696d 706c 6528 7365  onnect_simple(se
+00010780: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00010790: 662e 7065 6262 6c65 2e72 6573 706f 6e73  f.pebble.respons
+000107a0: 6573 2e61 7070 656e 6428 7065 6262 6c65  es.append(pebble
+000107b0: 2e53 7973 7465 6d49 6e66 6f2e 6672 6f6d  .SystemInfo.from
+000107c0: 5f64 6963 7428 7b27 7665 7273 696f 6e27  _dict({'version'
+000107d0: 3a20 2731 2e30 2e30 277d 2929 0a20 2020  : '1.0.0'})).   
+000107e0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000107f0: 5472 7565 2873 656c 662e 636f 6e74 6169  True(self.contai
+00010800: 6e65 722e 6361 6e5f 636f 6e6e 6563 7428  ner.can_connect(
+00010810: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
+00010820: 5f63 616e 5f63 6f6e 6e65 6374 5f63 6f6e  _can_connect_con
+00010830: 6e65 6374 696f 6e5f 6572 726f 7228 7365  nection_error(se
+00010840: 6c66 293a 0a20 2020 2020 2020 2064 6566  lf):.        def
+00010850: 2072 6169 7365 5f65 7272 6f72 2829 3a0a   raise_error():.
+00010860: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00010870: 6520 7065 6262 6c65 2e43 6f6e 6e65 6374  e pebble.Connect
+00010880: 696f 6e45 7272 6f72 2827 636f 6e6e 6563  ionError('connec
+00010890: 7469 6f6e 2065 7272 6f72 2127 290a 2020  tion error!').  
+000108a0: 2020 2020 2020 7365 6c66 2e70 6562 626c        self.pebbl
+000108b0: 652e 6765 745f 7379 7374 656d 5f69 6e66  e.get_system_inf
+000108c0: 6f20 3d20 7261 6973 655f 6572 726f 720a  o = raise_error.
+000108d0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+000108e0: 662e 6173 7365 7274 4c6f 6773 2827 6f70  f.assertLogs('op
+000108f0: 7327 2c20 6c65 7665 6c3d 2744 4542 5547  s', level='DEBUG
+00010900: 2729 2061 7320 636d 3a0a 2020 2020 2020  ') as cm:.      
+00010910: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00010920: 7446 616c 7365 2873 656c 662e 636f 6e74  tFalse(self.cont
+00010930: 6169 6e65 722e 6361 6e5f 636f 6e6e 6563  ainer.can_connec
+00010940: 7428 2929 0a20 2020 2020 2020 2073 656c  t()).        sel
+00010950: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
+00010960: 6e28 636d 2e6f 7574 7075 7429 2c20 3129  n(cm.output), 1)
+00010970: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00010980: 7365 7274 5265 6765 7828 636d 2e6f 7574  sertRegex(cm.out
+00010990: 7075 745b 305d 2c20 7227 4445 4255 473a  put[0], r'DEBUG:
+000109a0: 6f70 732e 6d6f 6465 6c3a 2e2a 3a20 636f  ops.model:.*: co
+000109b0: 6e6e 6563 7469 6f6e 2065 7272 6f72 2127  nnection error!'
+000109c0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+000109d0: 6361 6e5f 636f 6e6e 6563 745f 6669 6c65  can_connect_file
+000109e0: 5f6e 6f74 5f66 6f75 6e64 5f65 7272 6f72  _not_found_error
+000109f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00010a00: 6465 6620 7261 6973 655f 6572 726f 7228  def raise_error(
+00010a10: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00010a20: 6169 7365 2046 696c 654e 6f74 466f 756e  aise FileNotFoun
+00010a30: 6445 7272 6f72 2827 6669 6c65 206e 6f74  dError('file not
+00010a40: 2066 6f75 6e64 2127 290a 2020 2020 2020   found!').      
+00010a50: 2020 7365 6c66 2e70 6562 626c 652e 6765    self.pebble.ge
+00010a60: 745f 7379 7374 656d 5f69 6e66 6f20 3d20  t_system_info = 
+00010a70: 7261 6973 655f 6572 726f 720a 2020 2020  raise_error.    
+00010a80: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00010a90: 7365 7274 4c6f 6773 2827 6f70 7327 2c20  sertLogs('ops', 
+00010aa0: 6c65 7665 6c3d 2744 4542 5547 2729 2061  level='DEBUG') a
+00010ab0: 7320 636d 3a0a 2020 2020 2020 2020 2020  s cm:.          
+00010ac0: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
+00010ad0: 7365 2873 656c 662e 636f 6e74 6169 6e65  se(self.containe
+00010ae0: 722e 6361 6e5f 636f 6e6e 6563 7428 2929  r.can_connect())
+00010af0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00010b00: 7365 7274 4571 7561 6c28 6c65 6e28 636d  sertEqual(len(cm
+00010b10: 2e6f 7574 7075 7429 2c20 3129 0a20 2020  .output), 1).   
+00010b20: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00010b30: 5265 6765 7828 636d 2e6f 7574 7075 745b  Regex(cm.output[
+00010b40: 305d 2c20 7227 4445 4255 473a 6f70 732e  0], r'DEBUG:ops.
+00010b50: 6d6f 6465 6c3a 2e2a 3a20 6669 6c65 206e  model:.*: file n
+00010b60: 6f74 2066 6f75 6e64 2127 290a 0a20 2020  ot found!')..   
+00010b70: 2064 6566 2074 6573 745f 6361 6e5f 636f   def test_can_co
+00010b80: 6e6e 6563 745f 6170 695f 6572 726f 7228  nnect_api_error(
+00010b90: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
+00010ba0: 6566 2072 6169 7365 5f65 7272 6f72 2829  ef raise_error()
+00010bb0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00010bc0: 6973 6520 7065 6262 6c65 2e41 5049 4572  ise pebble.APIEr
+00010bd0: 726f 7228 2762 6f64 7927 2c20 3430 342c  ror('body', 404,
+00010be0: 2027 7374 6174 7573 272c 2027 6170 6920   'status', 'api 
+00010bf0: 6572 726f 7221 2729 0a20 2020 2020 2020  error!').       
+00010c00: 2073 656c 662e 7065 6262 6c65 2e67 6574   self.pebble.get
+00010c10: 5f73 7973 7465 6d5f 696e 666f 203d 2072  _system_info = r
+00010c20: 6169 7365 5f65 7272 6f72 0a20 2020 2020  aise_error.     
+00010c30: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00010c40: 6572 744c 6f67 7328 276f 7073 2729 2061  ertLogs('ops') a
+00010c50: 7320 636d 3a0a 2020 2020 2020 2020 2020  s cm:.          
+00010c60: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
+00010c70: 7365 2873 656c 662e 636f 6e74 6169 6e65  se(self.containe
+00010c80: 722e 6361 6e5f 636f 6e6e 6563 7428 2929  r.can_connect())
+00010c90: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00010ca0: 7365 7274 4571 7561 6c28 6c65 6e28 636d  sertEqual(len(cm
+00010cb0: 2e6f 7574 7075 7429 2c20 3129 0a20 2020  .output), 1).   
+00010cc0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00010cd0: 5265 6765 7828 636d 2e6f 7574 7075 745b  Regex(cm.output[
+00010ce0: 305d 2c20 7227 5741 524e 494e 473a 6f70  0], r'WARNING:op
+00010cf0: 732e 6d6f 6465 6c3a 2e2a 3a20 6170 6920  s.model:.*: api 
+00010d00: 6572 726f 7221 2729 0a0a 2020 2020 6465  error!')..    de
+00010d10: 6620 7465 7374 5f65 7865 6328 7365 6c66  f test_exec(self
+00010d20: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00010d30: 7065 6262 6c65 2e72 6573 706f 6e73 6573  pebble.responses
+00010d40: 2e61 7070 656e 6428 2766 616b 655f 6578  .append('fake_ex
+00010d50: 6563 5f70 726f 6365 7373 2729 0a20 2020  ec_process').   
+00010d60: 2020 2020 2070 203d 2073 656c 662e 636f       p = self.co
+00010d70: 6e74 6169 6e65 722e 6578 6563 280a 2020  ntainer.exec(.  
+00010d80: 2020 2020 2020 2020 2020 5b27 6563 686f            ['echo
+00010d90: 272c 2027 666f 6f27 5d2c 0a20 2020 2020  ', 'foo'],.     
+00010da0: 2020 2020 2020 2065 6e76 6972 6f6e 6d65         environme
+00010db0: 6e74 3d7b 274b 3127 3a20 2756 3127 2c20  nt={'K1': 'V1', 
+00010dc0: 274b 3227 3a20 2756 3227 7d2c 0a20 2020  'K2': 'V2'},.   
+00010dd0: 2020 2020 2020 2020 2077 6f72 6b69 6e67           working
+00010de0: 5f64 6972 3d27 5744 272c 0a20 2020 2020  _dir='WD',.     
+00010df0: 2020 2020 2020 2074 696d 656f 7574 3d31         timeout=1
+00010e00: 302e 352c 0a20 2020 2020 2020 2020 2020  0.5,.           
+00010e10: 2075 7365 725f 6964 3d31 3030 302c 0a20   user_id=1000,. 
+00010e20: 2020 2020 2020 2020 2020 2075 7365 723d             user=
+00010e30: 2762 6f62 272c 0a20 2020 2020 2020 2020  'bob',.         
+00010e40: 2020 2067 726f 7570 5f69 643d 3130 3030     group_id=1000
+00010e50: 2c0a 2020 2020 2020 2020 2020 2020 6772  ,.            gr
+00010e60: 6f75 703d 2773 7461 6666 272c 0a20 2020  oup='staff',.   
+00010e70: 2020 2020 2020 2020 2073 7464 696e 3d27           stdin='
+00010e80: 5354 4449 4e27 2c0a 2020 2020 2020 2020  STDIN',.        
+00010e90: 2020 2020 7374 646f 7574 3d27 5354 444f      stdout='STDO
+00010ea0: 5554 272c 0a20 2020 2020 2020 2020 2020  UT',.           
+00010eb0: 2073 7464 6572 723d 2753 5444 4552 5227   stderr='STDERR'
+00010ec0: 2c0a 2020 2020 2020 2020 2020 2020 656e  ,.            en
+00010ed0: 636f 6469 6e67 3d4e 6f6e 652c 0a20 2020  coding=None,.   
+00010ee0: 2020 2020 2020 2020 2063 6f6d 6269 6e65           combine
+00010ef0: 5f73 7464 6572 723d 5472 7565 2c0a 2020  _stderr=True,.  
+00010f00: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00010f10: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00010f20: 2873 656c 662e 7065 6262 6c65 2e72 6571  (self.pebble.req
+00010f30: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
+00010f40: 2020 2020 2028 2765 7865 6327 2c20 5b27       ('exec', ['
+00010f50: 6563 686f 272c 2027 666f 6f27 5d2c 2064  echo', 'foo'], d
+00010f60: 6963 7428 0a20 2020 2020 2020 2020 2020  ict(.           
+00010f70: 2020 2020 2065 6e76 6972 6f6e 6d65 6e74       environment
+00010f80: 3d7b 274b 3127 3a20 2756 3127 2c20 274b  ={'K1': 'V1', 'K
+00010f90: 3227 3a20 2756 3227 7d2c 0a20 2020 2020  2': 'V2'},.     
+00010fa0: 2020 2020 2020 2020 2020 2077 6f72 6b69             worki
+00010fb0: 6e67 5f64 6972 3d27 5744 272c 0a20 2020  ng_dir='WD',.   
+00010fc0: 2020 2020 2020 2020 2020 2020 2074 696d               tim
+00010fd0: 656f 7574 3d31 302e 352c 0a20 2020 2020  eout=10.5,.     
+00010fe0: 2020 2020 2020 2020 2020 2075 7365 725f             user_
+00010ff0: 6964 3d31 3030 302c 0a20 2020 2020 2020  id=1000,.       
+00011000: 2020 2020 2020 2020 2075 7365 723d 2762           user='b
+00011010: 6f62 272c 0a20 2020 2020 2020 2020 2020  ob',.           
+00011020: 2020 2020 2067 726f 7570 5f69 643d 3130       group_id=10
+00011030: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
+00011040: 2020 2020 6772 6f75 703d 2773 7461 6666      group='staff
+00011050: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00011060: 2020 2073 7464 696e 3d27 5354 4449 4e27     stdin='STDIN'
+00011070: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00011080: 2020 7374 646f 7574 3d27 5354 444f 5554    stdout='STDOUT
+00011090: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000110a0: 2020 2073 7464 6572 723d 2753 5444 4552     stderr='STDER
+000110b0: 5227 2c0a 2020 2020 2020 2020 2020 2020  R',.            
+000110c0: 2020 2020 656e 636f 6469 6e67 3d4e 6f6e      encoding=Non
+000110d0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+000110e0: 2020 2063 6f6d 6269 6e65 5f73 7464 6572     combine_stder
+000110f0: 723d 5472 7565 2c0a 2020 2020 2020 2020  r=True,.        
+00011100: 2020 2020 2929 0a20 2020 2020 2020 205d      )).        ]
+00011110: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00011120: 7373 6572 7445 7175 616c 2870 2c20 2766  ssertEqual(p, 'f
+00011130: 616b 655f 6578 6563 5f70 726f 6365 7373  ake_exec_process
+00011140: 2729 0a0a 2020 2020 6465 6620 7465 7374  ')..    def test
+00011150: 5f73 656e 645f 7369 676e 616c 2873 656c  _send_signal(sel
+00011160: 6629 3a0a 2020 2020 2020 2020 7769 7468  f):.        with
+00011170: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+00011180: 6573 2854 7970 6545 7272 6f72 293a 0a20  es(TypeError):. 
+00011190: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000111a0: 636f 6e74 6169 6e65 722e 7365 6e64 5f73  container.send_s
+000111b0: 6967 6e61 6c28 2753 4947 4855 5027 290a  ignal('SIGHUP').
+000111c0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+000111d0: 6e74 6169 6e65 722e 7365 6e64 5f73 6967  ntainer.send_sig
+000111e0: 6e61 6c28 2753 4947 4855 5027 2c20 2773  nal('SIGHUP', 's
+000111f0: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
+00011200: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
+00011210: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
+00011220: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
+00011230: 2028 2773 656e 645f 7369 676e 616c 272c   ('send_signal',
+00011240: 2027 5349 4748 5550 272c 2028 2773 3127   'SIGHUP', ('s1'
+00011250: 2c29 292c 0a20 2020 2020 2020 205d 290a  ,)),.        ]).
+00011260: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+00011270: 626c 652e 7265 7175 6573 7473 203d 205b  ble.requests = [
+00011280: 5d0a 0a20 2020 2020 2020 2073 656c 662e  ]..        self.
+00011290: 636f 6e74 6169 6e65 722e 7365 6e64 5f73  container.send_s
+000112a0: 6967 6e61 6c28 2753 4947 4855 5027 2c20  ignal('SIGHUP', 
+000112b0: 2773 3127 2c20 2773 3227 290a 2020 2020  's1', 's2').    
+000112c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000112d0: 7175 616c 2873 656c 662e 7065 6262 6c65  qual(self.pebble
+000112e0: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
+000112f0: 2020 2020 2020 2020 2028 2773 656e 645f           ('send_
+00011300: 7369 676e 616c 272c 2027 5349 4748 5550  signal', 'SIGHUP
+00011310: 272c 2028 2773 3127 2c20 2773 3227 2929  ', ('s1', 's2'))
+00011320: 2c0a 2020 2020 2020 2020 5d29 0a20 2020  ,.        ]).   
+00011330: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
+00011340: 2e72 6571 7565 7374 7320 3d20 5b5d 0a0a  .requests = []..
+00011350: 0a63 6c61 7373 204d 6f63 6b50 6562 626c  .class MockPebbl
+00011360: 6542 6163 6b65 6e64 285f 4d6f 6465 6c42  eBackend(_ModelB
+00011370: 6163 6b65 6e64 293a 0a20 2020 2064 6566  ackend):.    def
+00011380: 2067 6574 5f70 6562 626c 6528 7365 6c66   get_pebble(self
+00011390: 2c20 736f 636b 6574 5f70 6174 6829 3a0a  , socket_path):.
+000113a0: 2020 2020 2020 2020 7265 7475 726e 204d          return M
+000113b0: 6f63 6b50 6562 626c 6543 6c69 656e 7428  ockPebbleClient(
+000113c0: 736f 636b 6574 5f70 6174 6829 0a0a 0a63  socket_path)...c
+000113d0: 6c61 7373 204d 6f63 6b50 6562 626c 6543  lass MockPebbleC
+000113e0: 6c69 656e 743a 0a20 2020 2064 6566 205f  lient:.    def _
+000113f0: 5f69 6e69 745f 5f28 7365 6c66 2c20 736f  _init__(self, so
+00011400: 636b 6574 5f70 6174 6829 3a0a 2020 2020  cket_path):.    
+00011410: 2020 2020 7365 6c66 2e73 6f63 6b65 745f      self.socket_
+00011420: 7061 7468 203d 2073 6f63 6b65 745f 7061  path = socket_pa
+00011430: 7468 0a20 2020 2020 2020 2073 656c 662e  th.        self.
+00011440: 7265 7175 6573 7473 203d 205b 5d0a 2020  requests = [].  
+00011450: 2020 2020 2020 7365 6c66 2e72 6573 706f        self.respo
+00011460: 6e73 6573 203d 205b 5d0a 0a20 2020 2064  nses = []..    d
+00011470: 6566 2061 7574 6f73 7461 7274 5f73 6572  ef autostart_ser
+00011480: 7669 6365 7328 7365 6c66 293a 0a20 2020  vices(self):.   
+00011490: 2020 2020 2073 656c 662e 7265 7175 6573       self.reques
+000114a0: 7473 2e61 7070 656e 6428 2827 6175 746f  ts.append(('auto
+000114b0: 7374 6172 7427 2c29 290a 0a20 2020 2064  start',))..    d
+000114c0: 6566 2067 6574 5f73 7973 7465 6d5f 696e  ef get_system_in
+000114d0: 666f 2873 656c 6629 3a0a 2020 2020 2020  fo(self):.      
+000114e0: 2020 7365 6c66 2e72 6571 7565 7374 732e    self.requests.
+000114f0: 6170 7065 6e64 2828 2767 6574 5f73 7973  append(('get_sys
+00011500: 7465 6d5f 696e 666f 272c 2929 0a20 2020  tem_info',)).   
+00011510: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00011520: 2e72 6573 706f 6e73 6573 2e70 6f70 2830  .responses.pop(0
+00011530: 290a 0a20 2020 2064 6566 2072 6570 6c61  )..    def repla
+00011540: 6e5f 7365 7276 6963 6573 2873 656c 6629  n_services(self)
+00011550: 3a0a 2020 2020 2020 2020 7365 6c66 2e72  :.        self.r
+00011560: 6571 7565 7374 732e 6170 7065 6e64 2828  equests.append((
+00011570: 2772 6570 6c61 6e27 2c29 290a 0a20 2020  'replan',))..   
+00011580: 2064 6566 2073 7461 7274 5f73 6572 7669   def start_servi
+00011590: 6365 7328 7365 6c66 2c20 7365 7276 6963  ces(self, servic
+000115a0: 655f 6e61 6d65 7329 3a0a 2020 2020 2020  e_names):.      
+000115b0: 2020 7365 6c66 2e72 6571 7565 7374 732e    self.requests.
+000115c0: 6170 7065 6e64 2828 2773 7461 7274 272c  append(('start',
+000115d0: 2073 6572 7669 6365 5f6e 616d 6573 2929   service_names))
+000115e0: 0a0a 2020 2020 6465 6620 7374 6f70 5f73  ..    def stop_s
+000115f0: 6572 7669 6365 7328 7365 6c66 2c20 7365  ervices(self, se
+00011600: 7276 6963 655f 6e61 6d65 7329 3a0a 2020  rvice_names):.  
+00011610: 2020 2020 2020 7365 6c66 2e72 6571 7565        self.reque
+00011620: 7374 732e 6170 7065 6e64 2828 2773 746f  sts.append(('sto
+00011630: 7027 2c20 7365 7276 6963 655f 6e61 6d65  p', service_name
+00011640: 7329 290a 0a20 2020 2064 6566 2072 6573  s))..    def res
+00011650: 7461 7274 5f73 6572 7669 6365 7328 7365  tart_services(se
+00011660: 6c66 2c20 7365 7276 6963 655f 6e61 6d65  lf, service_name
+00011670: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
+00011680: 2e72 6571 7565 7374 732e 6170 7065 6e64  .requests.append
+00011690: 2828 2772 6573 7461 7274 272c 2073 6572  (('restart', ser
+000116a0: 7669 6365 5f6e 616d 6573 2929 0a0a 2020  vice_names))..  
+000116b0: 2020 6465 6620 6164 645f 6c61 7965 7228    def add_layer(
+000116c0: 7365 6c66 2c20 6c61 6265 6c2c 206c 6179  self, label, lay
+000116d0: 6572 2c20 636f 6d62 696e 653d 4661 6c73  er, combine=Fals
+000116e0: 6529 3a0a 2020 2020 2020 2020 6966 2069  e):.        if i
+000116f0: 7369 6e73 7461 6e63 6528 6c61 7965 722c  sinstance(layer,
+00011700: 2064 6963 7429 3a0a 2020 2020 2020 2020   dict):.        
+00011710: 2020 2020 6c61 7965 7220 3d20 7065 6262      layer = pebb
+00011720: 6c65 2e4c 6179 6572 286c 6179 6572 292e  le.Layer(layer).
+00011730: 746f 5f79 616d 6c28 290a 2020 2020 2020  to_yaml().      
+00011740: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+00011750: 6528 6c61 7965 722c 2070 6562 626c 652e  e(layer, pebble.
+00011760: 4c61 7965 7229 3a0a 2020 2020 2020 2020  Layer):.        
+00011770: 2020 2020 6c61 7965 7220 3d20 6c61 7965      layer = laye
+00011780: 722e 746f 5f79 616d 6c28 290a 2020 2020  r.to_yaml().    
+00011790: 2020 2020 7365 6c66 2e72 6571 7565 7374      self.request
+000117a0: 732e 6170 7065 6e64 2828 2761 6464 5f6c  s.append(('add_l
+000117b0: 6179 6572 272c 206c 6162 656c 2c20 6c61  ayer', label, la
+000117c0: 7965 722c 2063 6f6d 6269 6e65 2929 0a0a  yer, combine))..
+000117d0: 2020 2020 6465 6620 6765 745f 706c 616e      def get_plan
+000117e0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000117f0: 7365 6c66 2e72 6571 7565 7374 732e 6170  self.requests.ap
+00011800: 7065 6e64 2828 2767 6574 5f70 6c61 6e27  pend(('get_plan'
+00011810: 2c29 290a 2020 2020 2020 2020 7265 7475  ,)).        retu
+00011820: 726e 2073 656c 662e 7265 7370 6f6e 7365  rn self.response
+00011830: 732e 706f 7028 3029 0a0a 2020 2020 6465  s.pop(0)..    de
+00011840: 6620 6765 745f 7365 7276 6963 6573 2873  f get_services(s
+00011850: 656c 662c 206e 616d 6573 3d4e 6f6e 6529  elf, names=None)
+00011860: 3a0a 2020 2020 2020 2020 7365 6c66 2e72  :.        self.r
+00011870: 6571 7565 7374 732e 6170 7065 6e64 2828  equests.append((
+00011880: 2767 6574 5f73 6572 7669 6365 7327 2c20  'get_services', 
+00011890: 6e61 6d65 7329 290a 2020 2020 2020 2020  names)).        
+000118a0: 7265 7475 726e 2073 656c 662e 7265 7370  return self.resp
+000118b0: 6f6e 7365 732e 706f 7028 3029 0a0a 2020  onses.pop(0)..  
+000118c0: 2020 6465 6620 6765 745f 6368 6563 6b73    def get_checks
+000118d0: 2873 656c 662c 206c 6576 656c 3d4e 6f6e  (self, level=Non
+000118e0: 652c 206e 616d 6573 3d4e 6f6e 6529 3a0a  e, names=None):.
+000118f0: 2020 2020 2020 2020 7365 6c66 2e72 6571          self.req
+00011900: 7565 7374 732e 6170 7065 6e64 2828 2767  uests.append(('g
+00011910: 6574 5f63 6865 636b 7327 2c20 6c65 7665  et_checks', leve
+00011920: 6c2c 206e 616d 6573 2929 0a20 2020 2020  l, names)).     
+00011930: 2020 2072 6574 7572 6e20 7365 6c66 2e72     return self.r
+00011940: 6573 706f 6e73 6573 2e70 6f70 2830 290a  esponses.pop(0).
+00011950: 0a20 2020 2064 6566 2070 756c 6c28 7365  .    def pull(se
+00011960: 6c66 2c20 7061 7468 2c20 2a2c 2065 6e63  lf, path, *, enc
+00011970: 6f64 696e 673d 2775 7466 2d38 2729 3a0a  oding='utf-8'):.
+00011980: 2020 2020 2020 2020 7365 6c66 2e72 6571          self.req
+00011990: 7565 7374 732e 6170 7065 6e64 2828 2770  uests.append(('p
+000119a0: 756c 6c27 2c20 7061 7468 2c20 656e 636f  ull', path, enco
+000119b0: 6469 6e67 2929 0a20 2020 2020 2020 2072  ding)).        r
+000119c0: 6574 7572 6e20 7365 6c66 2e72 6573 706f  eturn self.respo
+000119d0: 6e73 6573 2e70 6f70 2830 290a 0a20 2020  nses.pop(0)..   
+000119e0: 2064 6566 2070 7573 6828 7365 6c66 2c20   def push(self, 
+000119f0: 7061 7468 2c20 736f 7572 6365 2c20 2a2c  path, source, *,
+00011a00: 2065 6e63 6f64 696e 673d 2775 7466 2d38   encoding='utf-8
+00011a10: 272c 206d 616b 655f 6469 7273 3d46 616c  ', make_dirs=Fal
+00011a20: 7365 2c20 7065 726d 6973 7369 6f6e 733d  se, permissions=
+00011a30: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00011a40: 2020 2075 7365 725f 6964 3d4e 6f6e 652c     user_id=None,
+00011a50: 2075 7365 723d 4e6f 6e65 2c20 6772 6f75   user=None, grou
+00011a60: 705f 6964 3d4e 6f6e 652c 2067 726f 7570  p_id=None, group
+00011a70: 3d4e 6f6e 6529 3a0a 2020 2020 2020 2020  =None):.        
+00011a80: 7365 6c66 2e72 6571 7565 7374 732e 6170  self.requests.ap
+00011a90: 7065 6e64 2828 2770 7573 6827 2c20 7061  pend(('push', pa
+00011aa0: 7468 2c20 736f 7572 6365 2c20 656e 636f  th, source, enco
+00011ab0: 6469 6e67 2c20 6d61 6b65 5f64 6972 732c  ding, make_dirs,
+00011ac0: 2070 6572 6d69 7373 696f 6e73 2c0a 2020   permissions,.  
+00011ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ae0: 2020 2020 2020 2020 2020 2020 7573 6572              user
+00011af0: 5f69 642c 2075 7365 722c 2067 726f 7570  _id, user, group
+00011b00: 5f69 642c 2067 726f 7570 2929 0a0a 2020  _id, group))..  
+00011b10: 2020 6465 6620 6c69 7374 5f66 696c 6573    def list_files
+00011b20: 2873 656c 662c 2070 6174 682c 202a 2c20  (self, path, *, 
+00011b30: 7061 7474 6572 6e3d 4e6f 6e65 2c20 6974  pattern=None, it
+00011b40: 7365 6c66 3d46 616c 7365 293a 0a20 2020  self=False):.   
+00011b50: 2020 2020 2073 656c 662e 7265 7175 6573       self.reques
+00011b60: 7473 2e61 7070 656e 6428 2827 6c69 7374  ts.append(('list
+00011b70: 5f66 696c 6573 272c 2070 6174 682c 2070  _files', path, p
+00011b80: 6174 7465 726e 2c20 6974 7365 6c66 2929  attern, itself))
+00011b90: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00011ba0: 7365 6c66 2e72 6573 706f 6e73 6573 2e70  self.responses.p
+00011bb0: 6f70 2830 290a 0a20 2020 2064 6566 206d  op(0)..    def m
+00011bc0: 616b 655f 6469 7228 7365 6c66 2c20 7061  ake_dir(self, pa
+00011bd0: 7468 2c20 2a2c 206d 616b 655f 7061 7265  th, *, make_pare
+00011be0: 6e74 733d 4661 6c73 652c 2070 6572 6d69  nts=False, permi
+00011bf0: 7373 696f 6e73 3d4e 6f6e 652c 2075 7365  ssions=None, use
+00011c00: 725f 6964 3d4e 6f6e 652c 2075 7365 723d  r_id=None, user=
+00011c10: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00011c20: 2020 2020 2020 2067 726f 7570 5f69 643d         group_id=
+00011c30: 4e6f 6e65 2c20 6772 6f75 703d 4e6f 6e65  None, group=None
+00011c40: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00011c50: 7265 7175 6573 7473 2e61 7070 656e 6428  requests.append(
+00011c60: 2827 6d61 6b65 5f64 6972 272c 2070 6174  ('make_dir', pat
+00011c70: 682c 206d 616b 655f 7061 7265 6e74 732c  h, make_parents,
+00011c80: 2070 6572 6d69 7373 696f 6e73 2c20 7573   permissions, us
+00011c90: 6572 5f69 642c 2075 7365 722c 0a20 2020  er_id, user,.   
+00011ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011cb0: 2020 2020 2020 2020 2020 2067 726f 7570             group
+00011cc0: 5f69 642c 2067 726f 7570 2929 0a0a 2020  _id, group))..  
+00011cd0: 2020 6465 6620 7265 6d6f 7665 5f70 6174    def remove_pat
+00011ce0: 6828 7365 6c66 2c20 7061 7468 2c20 2a2c  h(self, path, *,
+00011cf0: 2072 6563 7572 7369 7665 3d46 616c 7365   recursive=False
+00011d00: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00011d10: 7265 7175 6573 7473 2e61 7070 656e 6428  requests.append(
+00011d20: 2827 7265 6d6f 7665 5f70 6174 6827 2c20  ('remove_path', 
+00011d30: 7061 7468 2c20 7265 6375 7273 6976 6529  path, recursive)
+00011d40: 290a 0a20 2020 2064 6566 2065 7865 6328  )..    def exec(
+00011d50: 7365 6c66 2c20 636f 6d6d 616e 642c 202a  self, command, *
+00011d60: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+00011d70: 2020 7365 6c66 2e72 6571 7565 7374 732e    self.requests.
+00011d80: 6170 7065 6e64 2828 2765 7865 6327 2c20  append(('exec', 
+00011d90: 636f 6d6d 616e 642c 206b 7761 7267 7329  command, kwargs)
+00011da0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00011db0: 2073 656c 662e 7265 7370 6f6e 7365 732e   self.responses.
+00011dc0: 706f 7028 3029 0a0a 2020 2020 6465 6620  pop(0)..    def 
+00011dd0: 7365 6e64 5f73 6967 6e61 6c28 7365 6c66  send_signal(self
+00011de0: 2c20 7369 676e 616c 2c20 7365 7276 6963  , signal, servic
+00011df0: 655f 6e61 6d65 7329 3a0a 2020 2020 2020  e_names):.      
+00011e00: 2020 7365 6c66 2e72 6571 7565 7374 732e    self.requests.
+00011e10: 6170 7065 6e64 2828 2773 656e 645f 7369  append(('send_si
+00011e20: 676e 616c 272c 2073 6967 6e61 6c2c 2073  gnal', signal, s
+00011e30: 6572 7669 6365 5f6e 616d 6573 2929 0a0a  ervice_names))..
+00011e40: 0a63 6c61 7373 2054 6573 744d 6f64 656c  .class TestModel
+00011e50: 4269 6e64 696e 6773 2875 6e69 7474 6573  Bindings(unittes
+00011e60: 742e 5465 7374 4361 7365 293a 0a0a 2020  t.TestCase):..  
+00011e70: 2020 6465 6620 7365 7455 7028 7365 6c66    def setUp(self
+00011e80: 293a 0a20 2020 2020 2020 206d 6574 6120  ):.        meta 
+00011e90: 3d20 6f70 732e 4368 6172 6d4d 6574 6128  = ops.CharmMeta(
+00011ea0: 290a 2020 2020 2020 2020 6d65 7461 2e72  ).        meta.r
+00011eb0: 656c 6174 696f 6e73 203d 207b 0a20 2020  elations = {.   
+00011ec0: 2020 2020 2020 2020 2027 6462 3027 3a20           'db0': 
+00011ed0: 6f70 732e 5265 6c61 7469 6f6e 4d65 7461  ops.RelationMeta
+00011ee0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00011ef0: 2020 6f70 732e 5265 6c61 7469 6f6e 526f    ops.RelationRo
+00011f00: 6c65 2e70 726f 7669 6465 732c 2027 6462  le.provides, 'db
+00011f10: 3027 2c20 7b27 696e 7465 7266 6163 6527  0', {'interface'
+00011f20: 3a20 2764 6230 272c 2027 7363 6f70 6527  : 'db0', 'scope'
+00011f30: 3a20 2767 6c6f 6261 6c27 7d29 2c0a 2020  : 'global'}),.  
+00011f40: 2020 2020 2020 2020 2020 2764 6231 273a            'db1':
+00011f50: 206f 7073 2e52 656c 6174 696f 6e4d 6574   ops.RelationMet
+00011f60: 6128 0a20 2020 2020 2020 2020 2020 2020  a(.             
+00011f70: 2020 206f 7073 2e52 656c 6174 696f 6e52     ops.RelationR
+00011f80: 6f6c 652e 7265 7175 6972 6573 2c20 2764  ole.requires, 'd
+00011f90: 6231 272c 207b 2769 6e74 6572 6661 6365  b1', {'interface
+00011fa0: 273a 2027 6462 3127 2c20 2773 636f 7065  ': 'db1', 'scope
+00011fb0: 273a 2027 676c 6f62 616c 277d 292c 0a20  ': 'global'}),. 
+00011fc0: 2020 2020 2020 2020 2020 2027 6462 3227             'db2'
+00011fd0: 3a20 6f70 732e 5265 6c61 7469 6f6e 4d65  : ops.RelationMe
+00011fe0: 7461 280a 2020 2020 2020 2020 2020 2020  ta(.            
+00011ff0: 2020 2020 6f70 732e 5265 6c61 7469 6f6e      ops.Relation
+00012000: 526f 6c65 2e70 6565 722c 2027 6462 3227  Role.peer, 'db2'
+00012010: 2c20 7b27 696e 7465 7266 6163 6527 3a20  , {'interface': 
+00012020: 2764 6232 272c 2027 7363 6f70 6527 3a20  'db2', 'scope': 
+00012030: 2767 6c6f 6261 6c27 7d29 2c0a 2020 2020  'global'}),.    
+00012040: 2020 2020 7d0a 2020 2020 2020 2020 7365      }.        se
+00012050: 6c66 2e62 6163 6b65 6e64 203d 205f 4d6f  lf.backend = _Mo
+00012060: 6465 6c42 6163 6b65 6e64 2827 6d79 6170  delBackend('myap
+00012070: 702f 3027 290a 2020 2020 2020 2020 7365  p/0').        se
+00012080: 6c66 2e6d 6f64 656c 203d 206f 7073 2e4d  lf.model = ops.M
+00012090: 6f64 656c 286d 6574 612c 2073 656c 662e  odel(meta, self.
+000120a0: 6261 636b 656e 6429 0a0a 2020 2020 2020  backend)..      
+000120b0: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+000120c0: 6c66 2c20 2772 656c 6174 696f 6e2d 6964  lf, 'relation-id
+000120d0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+000120e0: 2020 2020 2020 2020 2222 2228 5b20 2224          """([ "$
+000120f0: 3122 203d 2064 6230 205d 2026 2620 6563  1" = db0 ] && ec
+00012100: 686f 2027 5b22 6462 303a 3422 5d27 2920  ho '["db0:4"]') 
+00012110: 7c7c 2065 6368 6f20 275b 5d27 2222 2229  || echo '[]'""")
+00012120: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+00012130: 7269 7074 2873 656c 662c 2027 7265 6c61  ript(self, 'rela
+00012140: 7469 6f6e 2d6c 6973 7427 2c20 2222 225b  tion-list', """[
+00012150: 2022 2432 2220 3d20 3420 5d20 2626 2065   "$2" = 4 ] && e
+00012160: 6368 6f20 275b 2272 656d 6f74 6561 7070  cho '["remoteapp
+00012170: 312f 3022 5d27 207c 7c20 6578 6974 2032  1/0"]' || exit 2
+00012180: 2222 2229 0a20 2020 2020 2020 2073 656c  """).        sel
+00012190: 662e 6e65 7477 6f72 6b5f 6765 745f 6f75  f.network_get_ou
+000121a0: 7420 3d20 2727 277b 0a20 2022 6269 6e64  t = '''{.  "bind
+000121b0: 2d61 6464 7265 7373 6573 223a 205b 0a20  -addresses": [. 
+000121c0: 2020 207b 0a20 2020 2020 2022 6d61 632d     {.      "mac-
+000121d0: 6164 6472 6573 7322 3a20 2264 653a 6164  address": "de:ad
+000121e0: 3a62 653a 6566 3a63 613a 6665 222c 0a20  :be:ef:ca:fe",. 
+000121f0: 2020 2020 2022 696e 7465 7266 6163 652d       "interface-
+00012200: 6e61 6d65 223a 2022 6c6f 222c 0a20 2020  name": "lo",.   
+00012210: 2020 2022 6164 6472 6573 7365 7322 3a20     "addresses": 
+00012220: 5b0a 2020 2020 2020 2020 7b0a 2020 2020  [.        {.    
+00012230: 2020 2020 2020 2268 6f73 746e 616d 6522        "hostname"
+00012240: 3a20 2222 2c0a 2020 2020 2020 2020 2020  : "",.          
+00012250: 2276 616c 7565 223a 2022 3139 322e 302e  "value": "192.0.
+00012260: 322e 3222 2c0a 2020 2020 2020 2020 2020  2.2",.          
+00012270: 2263 6964 7222 3a20 2231 3932 2e30 2e32  "cidr": "192.0.2
+00012280: 2e30 2f32 3422 0a20 2020 2020 2020 207d  .0/24".        }
+00012290: 2c0a 2020 2020 2020 2020 7b0a 2020 2020  ,.        {.    
+000122a0: 2020 2020 2020 2268 6f73 746e 616d 6522        "hostname"
+000122b0: 3a20 2264 6561 6462 6565 662e 6578 616d  : "deadbeef.exam
+000122c0: 706c 6522 2c0a 2020 2020 2020 2020 2020  ple",.          
+000122d0: 2276 616c 7565 223a 2022 6465 6164 3a62  "value": "dead:b
+000122e0: 6565 663a 3a31 222c 0a20 2020 2020 2020  eef::1",.       
+000122f0: 2020 2022 6369 6472 223a 2022 6465 6164     "cidr": "dead
+00012300: 3a62 6565 663a 3a2f 3634 220a 2020 2020  :beef::/64".    
+00012310: 2020 2020 7d0a 2020 2020 2020 5d0a 2020      }.      ].  
+00012320: 2020 7d2c 0a20 2020 207b 0a20 2020 2020    },.    {.     
+00012330: 2022 6d61 632d 6164 6472 6573 7322 3a20   "mac-address": 
+00012340: 2222 2c0a 2020 2020 2020 2269 6e74 6572  "",.      "inter
+00012350: 6661 6365 2d6e 616d 6522 3a20 2274 756e  face-name": "tun
+00012360: 222c 0a20 2020 2020 2022 6164 6472 6573  ",.      "addres
+00012370: 7365 7322 3a20 5b0a 2020 2020 2020 2020  ses": [.        
+00012380: 7b0a 2020 2020 2020 2020 2020 2268 6f73  {.          "hos
+00012390: 746e 616d 6522 3a20 2222 2c0a 2020 2020  tname": "",.    
+000123a0: 2020 2020 2020 2276 616c 7565 223a 2022        "value": "
+000123b0: 3139 322e 302e 332e 3322 2c0a 2020 2020  192.0.3.3",.    
+000123c0: 2020 2020 2020 2263 6964 7222 3a20 2222        "cidr": ""
+000123d0: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
+000123e0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+000123f0: 2268 6f73 746e 616d 6522 3a20 2222 2c0a  "hostname": "",.
+00012400: 2020 2020 2020 2020 2020 2276 616c 7565            "value
+00012410: 223a 2022 3230 3031 3a64 6238 3a3a 3322  ": "2001:db8::3"
+00012420: 2c0a 2020 2020 2020 2020 2020 2263 6964  ,.          "cid
+00012430: 7222 3a20 2222 0a20 2020 2020 2020 207d  r": "".        }
+00012440: 2c0a 2020 2020 2020 2020 7b0a 2020 2020  ,.        {.    
+00012450: 2020 2020 2020 2268 6f73 746e 616d 6522        "hostname"
+00012460: 3a20 2264 6561 6462 6565 662e 6c6f 6361  : "deadbeef.loca
+00012470: 6c22 2c0a 2020 2020 2020 2020 2020 2276  l",.          "v
+00012480: 616c 7565 223a 2022 6665 3830 3a3a 313a  alue": "fe80::1:
+00012490: 3122 2c0a 2020 2020 2020 2020 2020 2263  1",.          "c
+000124a0: 6964 7222 3a20 2266 6538 303a 3a2f 3634  idr": "fe80::/64
+000124b0: 220a 2020 2020 2020 2020 7d0a 2020 2020  ".        }.    
+000124c0: 2020 5d0a 2020 2020 7d0a 2020 5d2c 0a20    ].    }.  ],. 
+000124d0: 2022 6567 7265 7373 2d73 7562 6e65 7473   "egress-subnets
+000124e0: 223a 205b 0a20 2020 2022 3139 322e 302e  ": [.    "192.0.
+000124f0: 322e 322f 3332 222c 0a20 2020 2022 3139  2.2/32",.    "19
+00012500: 322e 302e 332e 302f 3234 222c 0a20 2020  2.0.3.0/24",.   
+00012510: 2022 6465 6164 3a62 6565 663a 3a2f 3634   "dead:beef::/64
+00012520: 222c 0a20 2020 2022 3230 3031 3a64 6238  ",.    "2001:db8
+00012530: 3a3a 332f 3132 3822 0a20 205d 2c0a 2020  ::3/128".  ],.  
+00012540: 2269 6e67 7265 7373 2d61 6464 7265 7373  "ingress-address
+00012550: 6573 223a 205b 0a20 2020 2022 3139 322e  es": [.    "192.
+00012560: 302e 322e 3222 2c0a 2020 2020 2231 3932  0.2.2",.    "192
+00012570: 2e30 2e33 2e33 222c 0a20 2020 2022 6465  .0.3.3",.    "de
+00012580: 6164 3a62 6565 663a 3a31 222c 0a20 2020  ad:beef::1",.   
+00012590: 2022 3230 3031 3a64 6238 3a3a 3322 0a20   "2001:db8::3". 
+000125a0: 205d 0a7d 2727 270a 0a20 2020 2064 6566   ].}'''..    def
+000125b0: 205f 6368 6563 6b5f 6269 6e64 696e 675f   _check_binding_
+000125c0: 6461 7461 2873 656c 662c 2062 696e 6469  data(self, bindi
+000125d0: 6e67 5f6e 616d 652c 2062 696e 6469 6e67  ng_name, binding
+000125e0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+000125f0: 6173 7365 7274 4571 7561 6c28 6269 6e64  assertEqual(bind
+00012600: 696e 672e 6e61 6d65 2c20 6269 6e64 696e  ing.name, bindin
+00012610: 675f 6e61 6d65 290a 2020 2020 2020 2020  g_name).        
+00012620: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00012630: 2862 696e 6469 6e67 2e6e 6574 776f 726b  (binding.network
+00012640: 2e62 696e 645f 6164 6472 6573 732c 2069  .bind_address, i
+00012650: 7061 6464 7265 7373 2e69 705f 6164 6472  paddress.ip_addr
+00012660: 6573 7328 2731 3932 2e30 2e32 2e32 2729  ess('192.0.2.2')
+00012670: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00012680: 7373 6572 7445 7175 616c 2862 696e 6469  ssertEqual(bindi
+00012690: 6e67 2e6e 6574 776f 726b 2e69 6e67 7265  ng.network.ingre
+000126a0: 7373 5f61 6464 7265 7373 2c20 6970 6164  ss_address, ipad
+000126b0: 6472 6573 732e 6970 5f61 6464 7265 7373  dress.ip_address
+000126c0: 2827 3139 322e 302e 322e 3227 2929 0a20  ('192.0.2.2')). 
+000126d0: 2020 2020 2020 2023 202f 3332 2061 6e64         # /32 and
+000126e0: 202f 3132 3820 4349 4452 7320 6172 6520   /128 CIDRs are 
+000126f0: 7661 6c69 6420 6f6e 652d 6164 6472 6573  valid one-addres
+00012700: 7320 6e65 7477 6f72 6b73 2066 6f72 2049  s networks for I
+00012710: 5076 7b34 2c36 7d4e 6574 776f 726b 2074  Pv{4,6}Network t
+00012720: 7970 6573 2072 6573 7065 6374 6976 656c  ypes respectivel
+00012730: 792e 0a20 2020 2020 2020 2073 656c 662e  y..        self.
+00012740: 6173 7365 7274 4571 7561 6c28 6269 6e64  assertEqual(bind
+00012750: 696e 672e 6e65 7477 6f72 6b2e 6567 7265  ing.network.egre
+00012760: 7373 5f73 7562 6e65 7473 2c20 5b69 7061  ss_subnets, [ipa
+00012770: 6464 7265 7373 2e69 705f 6e65 7477 6f72  ddress.ip_networ
+00012780: 6b28 2731 3932 2e30 2e32 2e32 2f33 3227  k('192.0.2.2/32'
+00012790: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000127a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127c0: 2020 2020 2020 2020 2020 2020 2069 7061               ipa
+000127d0: 6464 7265 7373 2e69 705f 6e65 7477 6f72  ddress.ip_networ
+000127e0: 6b28 2731 3932 2e30 2e33 2e30 2f32 3427  k('192.0.3.0/24'
+000127f0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00012800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012820: 2020 2020 2020 2020 2020 2020 2069 7061               ipa
+00012830: 6464 7265 7373 2e69 705f 6e65 7477 6f72  ddress.ip_networ
+00012840: 6b28 2764 6561 643a 6265 6566 3a3a 2f36  k('dead:beef::/6
+00012850: 3427 292c 0a20 2020 2020 2020 2020 2020  4'),.           
+00012860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012880: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00012890: 7061 6464 7265 7373 2e69 705f 6e65 7477  paddress.ip_netw
+000128a0: 6f72 6b28 2732 3030 313a 6462 383a 3a33  ork('2001:db8::3
+000128b0: 2f31 3238 2729 5d29 0a0a 2020 2020 2020  /128')])..      
+000128c0: 2020 666f 7220 2869 2c20 286e 616d 652c    for (i, (name,
+000128d0: 2061 6464 7265 7373 2c20 7375 626e 6574   address, subnet
+000128e0: 2929 2069 6e20 656e 756d 6572 6174 6528  )) in enumerate(
+000128f0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00012900: 2020 2827 6c6f 272c 2027 3139 322e 302e    ('lo', '192.0.
+00012910: 322e 3227 2c20 2731 3932 2e30 2e32 2e30  2.2', '192.0.2.0
+00012920: 2f32 3427 292c 0a20 2020 2020 2020 2020  /24'),.         
+00012930: 2020 2020 2020 2028 276c 6f27 2c20 2764         ('lo', 'd
+00012940: 6561 643a 6265 6566 3a3a 3127 2c20 2764  ead:beef::1', 'd
+00012950: 6561 643a 6265 6566 3a3a 2f36 3427 292c  ead:beef::/64'),
+00012960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012970: 2028 2774 756e 272c 2027 3139 322e 302e   ('tun', '192.0.
+00012980: 332e 3327 2c20 2731 3932 2e30 2e33 2e33  3.3', '192.0.3.3
+00012990: 2f33 3227 292c 0a20 2020 2020 2020 2020  /32'),.         
+000129a0: 2020 2020 2020 2028 2774 756e 272c 2027         ('tun', '
+000129b0: 3230 3031 3a64 6238 3a3a 3327 2c20 2732  2001:db8::3', '2
+000129c0: 3030 313a 6462 383a 3a33 2f31 3238 2729  001:db8::3/128')
+000129d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000129e0: 2020 2827 7475 6e27 2c20 2766 6538 303a    ('tun', 'fe80:
+000129f0: 3a31 3a31 272c 2027 6665 3830 3a3a 2f36  :1:1', 'fe80::/6
+00012a00: 3427 295d 293a 0a20 2020 2020 2020 2020  4')]):.         
+00012a10: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00012a20: 7561 6c28 6269 6e64 696e 672e 6e65 7477  ual(binding.netw
+00012a30: 6f72 6b2e 696e 7465 7266 6163 6573 5b69  ork.interfaces[i
+00012a40: 5d2e 6e61 6d65 2c20 6e61 6d65 290a 2020  ].name, name).  
+00012a50: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00012a60: 7373 6572 7445 7175 616c 2862 696e 6469  ssertEqual(bindi
+00012a70: 6e67 2e6e 6574 776f 726b 2e69 6e74 6572  ng.network.inter
+00012a80: 6661 6365 735b 695d 2e61 6464 7265 7373  faces[i].address
+00012a90: 2c20 6970 6164 6472 6573 732e 6970 5f61  , ipaddress.ip_a
+00012aa0: 6464 7265 7373 2861 6464 7265 7373 2929  ddress(address))
+00012ab0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00012ac0: 662e 6173 7365 7274 4571 7561 6c28 6269  f.assertEqual(bi
+00012ad0: 6e64 696e 672e 6e65 7477 6f72 6b2e 696e  nding.network.in
+00012ae0: 7465 7266 6163 6573 5b69 5d2e 7375 626e  terfaces[i].subn
+00012af0: 6574 2c20 6970 6164 6472 6573 732e 6970  et, ipaddress.ip
+00012b00: 5f6e 6574 776f 726b 2873 7562 6e65 7429  _network(subnet)
+00012b10: 290a 0a20 2020 2020 2020 2066 6f72 2028  )..        for (
+00012b20: 692c 2028 6e61 6d65 2c20 6164 6472 6573  i, (name, addres
+00012b30: 732c 2073 7562 6e65 7429 2920 696e 2065  s, subnet)) in e
+00012b40: 6e75 6d65 7261 7465 285b 0a20 2020 2020  numerate([.     
+00012b50: 2020 2020 2020 2020 2020 2028 276c 6f27             ('lo'
+00012b60: 2c20 2731 3932 2e30 2e32 2e32 272c 2027  , '192.0.2.2', '
+00012b70: 3139 322e 302e 322e 302f 3234 2729 2c0a  192.0.2.0/24'),.
+00012b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b90: 2827 6c6f 272c 2027 6465 6164 3a62 6565  ('lo', 'dead:bee
+00012ba0: 663a 3a31 272c 2027 6465 6164 3a62 6565  f::1', 'dead:bee
+00012bb0: 663a 3a2f 3634 2729 2c0a 2020 2020 2020  f::/64'),.      
+00012bc0: 2020 2020 2020 2020 2020 2827 7475 6e27            ('tun'
+00012bd0: 2c20 2731 3932 2e30 2e33 2e33 272c 2027  , '192.0.3.3', '
+00012be0: 3139 322e 302e 332e 332f 3332 2729 2c0a  192.0.3.3/32'),.
+00012bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c00: 2827 7475 6e27 2c20 2732 3030 313a 6462  ('tun', '2001:db
+00012c10: 383a 3a33 272c 2027 3230 3031 3a64 6238  8::3', '2001:db8
+00012c20: 3a3a 332f 3132 3827 292c 0a20 2020 2020  ::3/128'),.     
+00012c30: 2020 2020 2020 2020 2020 2028 2774 756e             ('tun
+00012c40: 272c 2027 6665 3830 3a3a 313a 3127 2c20  ', 'fe80::1:1', 
+00012c50: 2766 6538 303a 3a2f 3634 2729 5d29 3a0a  'fe80::/64')]):.
+00012c60: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00012c70: 2e61 7373 6572 7445 7175 616c 2862 696e  .assertEqual(bin
+00012c80: 6469 6e67 2e6e 6574 776f 726b 2e69 6e74  ding.network.int
+00012c90: 6572 6661 6365 735b 695d 2e6e 616d 652c  erfaces[i].name,
+00012ca0: 206e 616d 6529 0a20 2020 2020 2020 2020   name).         
+00012cb0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00012cc0: 7561 6c28 6269 6e64 696e 672e 6e65 7477  ual(binding.netw
+00012cd0: 6f72 6b2e 696e 7465 7266 6163 6573 5b69  ork.interfaces[i
+00012ce0: 5d2e 6164 6472 6573 732c 2069 7061 6464  ].address, ipadd
+00012cf0: 7265 7373 2e69 705f 6164 6472 6573 7328  ress.ip_address(
+00012d00: 6164 6472 6573 7329 290a 2020 2020 2020  address)).      
+00012d10: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00012d20: 7445 7175 616c 2862 696e 6469 6e67 2e6e  tEqual(binding.n
+00012d30: 6574 776f 726b 2e69 6e74 6572 6661 6365  etwork.interface
+00012d40: 735b 695d 2e73 7562 6e65 742c 2069 7061  s[i].subnet, ipa
+00012d50: 6464 7265 7373 2e69 705f 6e65 7477 6f72  ddress.ip_networ
+00012d60: 6b28 7375 626e 6574 2929 0a0a 2020 2020  k(subnet))..    
+00012d70: 6465 6620 7465 7374 5f69 6e76 616c 6964  def test_invalid
+00012d80: 5f6b 6579 7328 7365 6c66 293a 0a20 2020  _keys(self):.   
+00012d90: 2020 2020 2023 2042 6173 6963 2076 616c       # Basic val
+00012da0: 6964 6174 696f 6e20 666f 7220 7061 7373  idation for pass
+00012db0: 696e 6720 696e 7661 6c69 6420 6b65 7973  ing invalid keys
+00012dc0: 2e0a 2020 2020 2020 2020 666f 7220 6e61  ..        for na
+00012dd0: 6d65 2069 6e20 286f 626a 6563 742c 2030  me in (object, 0
+00012de0: 293a 0a20 2020 2020 2020 2020 2020 2077  ):.            w
+00012df0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+00012e00: 6169 7365 7328 6f70 732e 4d6f 6465 6c45  aises(ops.ModelE
+00012e10: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+00012e20: 2020 2020 2020 2073 656c 662e 6d6f 6465         self.mode
+00012e30: 6c2e 6765 745f 6269 6e64 696e 6728 6e61  l.get_binding(na
+00012e40: 6d65 290a 0a20 2020 2064 6566 2074 6573  me)..    def tes
+00012e50: 745f 6465 6164 5f72 656c 6174 696f 6e73  t_dead_relations
+00012e60: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00012e70: 6661 6b65 5f73 6372 6970 7428 0a20 2020  fake_script(.   
+00012e80: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
+00012e90: 2020 2020 2020 2020 2020 2027 6e65 7477             'netw
+00012ea0: 6f72 6b2d 6765 7427 2c0a 2020 2020 2020  ork-get',.      
+00012eb0: 2020 2020 2020 6627 2727 0a20 2020 2020        f'''.     
+00012ec0: 2020 2020 2020 2020 2020 2069 6620 5b20             if [ 
+00012ed0: 2224 3122 203d 2064 6230 205d 2026 2620  "$1" = db0 ] && 
+00012ee0: 5b20 2224 3222 203d 202d 2d66 6f72 6d61  [ "$2" = --forma
+00012ef0: 743d 6a73 6f6e 205d 3b20 7468 656e 0a20  t=json ]; then. 
+00012f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f10: 2020 2065 6368 6f20 277b 7365 6c66 2e6e     echo '{self.n
+00012f20: 6574 776f 726b 5f67 6574 5f6f 7574 7d27  etwork_get_out}'
 00012f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012f40: 2020 2020 2027 6164 6472 6573 7365 7327       'addresses'
-00012f50: 3a20 5b0a 2020 2020 2020 2020 2020 2020  : [.            
-00012f60: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00012f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f80: 2020 2020 2020 2020 2020 2768 6f73 746e            'hostn
-00012f90: 616d 6527 3a20 2727 2c0a 2020 2020 2020  ame': '',.      
+00012f40: 2065 6c73 650a 2020 2020 2020 2020 2020   else.          
+00012f50: 2020 2020 2020 2020 2020 6563 686f 2045            echo E
+00012f60: 5252 4f52 2069 6e76 616c 6964 2076 616c  RROR invalid val
+00012f70: 7565 2022 2432 2220 666f 7220 6f70 7469  ue "$2" for opti
+00012f80: 6f6e 202d 723a 2072 656c 6174 696f 6e20  on -r: relation 
+00012f90: 6e6f 7420 666f 756e 6420 3e26 320a 2020  not found >&2.  
 00012fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012fb0: 2020 2020 2020 2776 616c 7565 273a 2027        'value': '
-00012fc0: 3130 2e31 2e38 392e 3335 272c 0a20 2020  10.1.89.35',.   
-00012fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012fe0: 2020 2020 2020 2020 2027 6369 6472 273a           'cidr':
-00012ff0: 2027 270a 2020 2020 2020 2020 2020 2020   ''.            
-00013000: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00013010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013020: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
-00013030: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00013040: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
-00013050: 2027 6567 7265 7373 2d73 7562 6e65 7473   'egress-subnets
-00013060: 273a 205b 0a20 2020 2020 2020 2020 2020  ': [.           
-00013070: 2020 2020 2027 3130 2e31 3532 2e31 3833       '10.152.183
-00013080: 2e31 3538 2f33 3227 0a20 2020 2020 2020  .158/32'.       
-00013090: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-000130a0: 2020 2020 2769 6e67 7265 7373 2d61 6464      'ingress-add
-000130b0: 7265 7373 6573 273a 205b 0a20 2020 2020  resses': [.     
-000130c0: 2020 2020 2020 2020 2020 2027 3130 2e31             '10.1
-000130d0: 3532 2e31 3833 2e31 3538 270a 2020 2020  52.183.158'.    
-000130e0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-000130f0: 2020 7d0a 2020 2020 2020 2020 6e65 7477    }.        netw
-00013100: 6f72 6b5f 6765 745f 6f75 7420 3d20 6a73  ork_get_out = js
-00013110: 6f6e 2e64 756d 7073 286e 6574 776f 726b  on.dumps(network
-00013120: 5f67 6574 5f6f 7574 5f6f 626a 290a 2020  _get_out_obj).  
-00013130: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
-00013140: 7428 7365 6c66 2c20 276e 6574 776f 726b  t(self, 'network
-00013150: 2d67 6574 272c 0a20 2020 2020 2020 2020  -get',.         
-00013160: 2020 2020 2020 2020 2020 2066 2727 275b             f'''[
-00013170: 2022 2431 2220 3d20 6462 3020 5d20 2626   "$1" = db0 ] &&
-00013180: 2065 6368 6f20 277b 6e65 7477 6f72 6b5f   echo '{network_
-00013190: 6765 745f 6f75 747d 2720 7c7c 2065 7869  get_out}' || exi
-000131a0: 7420 3127 2727 290a 2020 2020 2020 2020  t 1''').        
-000131b0: 6269 6e64 696e 675f 6e61 6d65 203d 2027  binding_name = '
-000131c0: 6462 3027 0a20 2020 2020 2020 2065 7870  db0'.        exp
-000131d0: 6563 7465 645f 6361 6c6c 7320 3d20 5b5b  ected_calls = [[
-000131e0: 276e 6574 776f 726b 2d67 6574 272c 2027  'network-get', '
-000131f0: 6462 3027 2c20 272d 2d66 6f72 6d61 743d  db0', '--format=
-00013200: 6a73 6f6e 275d 5d0a 0a20 2020 2020 2020  json']]..       
-00013210: 2062 696e 6469 6e67 203d 2073 656c 662e   binding = self.
-00013220: 6d6f 6465 6c2e 6765 745f 6269 6e64 696e  model.get_bindin
-00013230: 6728 6269 6e64 696e 675f 6e61 6d65 290a  g(binding_name).
-00013240: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00013250: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
-00013260: 2e6e 616d 652c 2027 6462 3027 290a 2020  .name, 'db0').  
-00013270: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00013280: 7445 7175 616c 2862 696e 6469 6e67 2e6e  tEqual(binding.n
-00013290: 6574 776f 726b 2e62 696e 645f 6164 6472  etwork.bind_addr
-000132a0: 6573 732c 2069 7061 6464 7265 7373 2e69  ess, ipaddress.i
-000132b0: 705f 6164 6472 6573 7328 2731 302e 312e  p_address('10.1.
-000132c0: 3839 2e33 3527 2929 0a20 2020 2020 2020  89.35')).       
-000132d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000132e0: 6c28 6269 6e64 696e 672e 6e65 7477 6f72  l(binding.networ
-000132f0: 6b2e 696e 6772 6573 735f 6164 6472 6573  k.ingress_addres
-00013300: 732c 2069 7061 6464 7265 7373 2e69 705f  s, ipaddress.ip_
-00013310: 6164 6472 6573 7328 2731 302e 3135 322e  address('10.152.
-00013320: 3138 332e 3135 3827 2929 0a20 2020 2020  183.158')).     
-00013330: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00013340: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
-00013350: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
-00013360: 723d 5472 7565 292c 2065 7870 6563 7465  r=True), expecte
-00013370: 645f 6361 6c6c 7329 0a0a 2020 2020 6465  d_calls)..    de
-00013380: 6620 7465 7374 5f6d 6973 7369 6e67 5f62  f test_missing_b
-00013390: 696e 645f 6164 6472 6573 7365 7328 7365  ind_addresses(se
-000133a0: 6c66 293a 0a20 2020 2020 2020 206e 6574  lf):.        net
-000133b0: 776f 726b 5f64 6174 6120 3d20 6a73 6f6e  work_data = json
-000133c0: 2e64 756d 7073 287b 7d29 0a20 2020 2020  .dumps({}).     
-000133d0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-000133e0: 656c 662c 2027 6e65 7477 6f72 6b2d 6765  elf, 'network-ge
-000133f0: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
-00013400: 2020 2020 2020 2020 6627 2727 5b20 2224          f'''[ "$
-00013410: 3122 203d 2064 6230 205d 2026 2620 6563  1" = db0 ] && ec
-00013420: 686f 2027 7b6e 6574 776f 726b 5f64 6174  ho '{network_dat
-00013430: 617d 2720 7c7c 2065 7869 7420 3127 2727  a}' || exit 1'''
-00013440: 290a 2020 2020 2020 2020 6269 6e64 696e  ).        bindin
-00013450: 675f 6e61 6d65 203d 2027 6462 3027 0a20  g_name = 'db0'. 
-00013460: 2020 2020 2020 2062 696e 6469 6e67 203d         binding =
-00013470: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
-00013480: 6269 6e64 696e 6728 7365 6c66 2e6d 6f64  binding(self.mod
-00013490: 656c 2e67 6574 5f72 656c 6174 696f 6e28  el.get_relation(
-000134a0: 6269 6e64 696e 675f 6e61 6d65 2929 0a20  binding_name)). 
-000134b0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000134c0: 7274 4571 7561 6c28 6269 6e64 696e 672e  rtEqual(binding.
-000134d0: 6e65 7477 6f72 6b2e 696e 7465 7266 6163  network.interfac
-000134e0: 6573 2c20 5b5d 290a 0a20 2020 2064 6566  es, [])..    def
-000134f0: 2074 6573 745f 656d 7074 795f 6269 6e64   test_empty_bind
-00013500: 5f61 6464 7265 7373 6573 2873 656c 6629  _addresses(self)
-00013510: 3a0a 2020 2020 2020 2020 6e65 7477 6f72  :.        networ
-00013520: 6b5f 6461 7461 203d 206a 736f 6e2e 6475  k_data = json.du
-00013530: 6d70 7328 7b27 6269 6e64 2d61 6464 7265  mps({'bind-addre
-00013540: 7373 6573 273a 205b 7b7d 5d7d 290a 2020  sses': [{}]}).  
-00013550: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
-00013560: 7428 7365 6c66 2c20 276e 6574 776f 726b  t(self, 'network
-00013570: 2d67 6574 272c 0a20 2020 2020 2020 2020  -get',.         
-00013580: 2020 2020 2020 2020 2020 2066 2727 275b             f'''[
-00013590: 2022 2431 2220 3d20 6462 3020 5d20 2626   "$1" = db0 ] &&
-000135a0: 2065 6368 6f20 277b 6e65 7477 6f72 6b5f   echo '{network_
-000135b0: 6461 7461 7d27 207c 7c20 6578 6974 2031  data}' || exit 1
-000135c0: 2727 2729 0a20 2020 2020 2020 2062 696e  ''').        bin
-000135d0: 6469 6e67 5f6e 616d 6520 3d20 2764 6230  ding_name = 'db0
-000135e0: 270a 2020 2020 2020 2020 6269 6e64 696e  '.        bindin
-000135f0: 6720 3d20 7365 6c66 2e6d 6f64 656c 2e67  g = self.model.g
-00013600: 6574 5f62 696e 6469 6e67 2873 656c 662e  et_binding(self.
-00013610: 6d6f 6465 6c2e 6765 745f 7265 6c61 7469  model.get_relati
-00013620: 6f6e 2862 696e 6469 6e67 5f6e 616d 6529  on(binding_name)
-00013630: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00013640: 7373 6572 7445 7175 616c 2862 696e 6469  ssertEqual(bindi
-00013650: 6e67 2e6e 6574 776f 726b 2e69 6e74 6572  ng.network.inter
-00013660: 6661 6365 732c 205b 5d29 0a0a 2020 2020  faces, [])..    
-00013670: 6465 6620 7465 7374 5f6e 6f5f 6269 6e64  def test_no_bind
-00013680: 5f61 6464 7265 7373 6573 2873 656c 6629  _addresses(self)
-00013690: 3a0a 2020 2020 2020 2020 6e65 7477 6f72  :.        networ
-000136a0: 6b5f 6461 7461 203d 206a 736f 6e2e 6475  k_data = json.du
-000136b0: 6d70 7328 7b27 6269 6e64 2d61 6464 7265  mps({'bind-addre
-000136c0: 7373 6573 273a 205b 7b27 6164 6472 6573  sses': [{'addres
-000136d0: 7365 7327 3a20 4e6f 6e65 7d5d 7d29 0a20  ses': None}]}). 
-000136e0: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-000136f0: 7074 2873 656c 662c 2027 6e65 7477 6f72  pt(self, 'networ
-00013700: 6b2d 6765 7427 2c0a 2020 2020 2020 2020  k-get',.        
-00013710: 2020 2020 2020 2020 2020 2020 6627 2727              f'''
-00013720: 5b20 2224 3122 203d 2064 6230 205d 2026  [ "$1" = db0 ] &
-00013730: 2620 6563 686f 2027 7b6e 6574 776f 726b  & echo '{network
-00013740: 5f64 6174 617d 2720 7c7c 2065 7869 7420  _data}' || exit 
-00013750: 3127 2727 290a 2020 2020 2020 2020 6269  1''').        bi
-00013760: 6e64 696e 675f 6e61 6d65 203d 2027 6462  nding_name = 'db
-00013770: 3027 0a20 2020 2020 2020 2062 696e 6469  0'.        bindi
-00013780: 6e67 203d 2073 656c 662e 6d6f 6465 6c2e  ng = self.model.
-00013790: 6765 745f 6269 6e64 696e 6728 7365 6c66  get_binding(self
-000137a0: 2e6d 6f64 656c 2e67 6574 5f72 656c 6174  .model.get_relat
-000137b0: 696f 6e28 6269 6e64 696e 675f 6e61 6d65  ion(binding_name
-000137c0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-000137d0: 6173 7365 7274 4571 7561 6c28 6269 6e64  assertEqual(bind
-000137e0: 696e 672e 6e65 7477 6f72 6b2e 696e 7465  ing.network.inte
-000137f0: 7266 6163 6573 2c20 5b5d 290a 0a20 2020  rfaces, [])..   
-00013800: 2064 6566 2074 6573 745f 656d 7074 795f   def test_empty_
-00013810: 696e 7465 7266 6163 655f 696e 666f 2873  interface_info(s
-00013820: 656c 6629 3a0a 2020 2020 2020 2020 6e65  elf):.        ne
-00013830: 7477 6f72 6b5f 6461 7461 203d 206a 736f  twork_data = jso
-00013840: 6e2e 6475 6d70 7328 7b0a 2020 2020 2020  n.dumps({.      
-00013850: 2020 2020 2020 2762 696e 642d 6164 6472        'bind-addr
-00013860: 6573 7365 7327 3a20 5b7b 0a20 2020 2020  esses': [{.     
-00013870: 2020 2020 2020 2020 2020 2027 696e 7465             'inte
-00013880: 7266 6163 652d 6e61 6d65 273a 2027 6574  rface-name': 'et
-00013890: 6830 272c 0a20 2020 2020 2020 2020 2020  h0',.           
-000138a0: 2020 2020 2027 6164 6472 6573 7365 7327       'addresses'
-000138b0: 3a20 5b7b 7d5d 2c0a 2020 2020 2020 2020  : [{}],.        
-000138c0: 2020 2020 7d5d 2c0a 2020 2020 2020 2020      }],.        
-000138d0: 7d29 0a20 2020 2020 2020 2066 616b 655f  }).        fake_
-000138e0: 7363 7269 7074 2873 656c 662c 2027 6e65  script(self, 'ne
-000138f0: 7477 6f72 6b2d 6765 7427 2c0a 2020 2020  twork-get',.    
-00013900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013910: 6627 2727 5b20 2224 3122 203d 2064 6230  f'''[ "$1" = db0
-00013920: 205d 2026 2620 6563 686f 2027 7b6e 6574   ] && echo '{net
-00013930: 776f 726b 5f64 6174 617d 2720 7c7c 2065  work_data}' || e
-00013940: 7869 7420 3127 2727 290a 2020 2020 2020  xit 1''').      
-00013950: 2020 6269 6e64 696e 675f 6e61 6d65 203d    binding_name =
-00013960: 2027 6462 3027 0a20 2020 2020 2020 2062   'db0'.        b
-00013970: 696e 6469 6e67 203d 2073 656c 662e 6d6f  inding = self.mo
-00013980: 6465 6c2e 6765 745f 6269 6e64 696e 6728  del.get_binding(
-00013990: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
-000139a0: 656c 6174 696f 6e28 6269 6e64 696e 675f  elation(binding_
-000139b0: 6e61 6d65 2929 0a20 2020 2020 2020 2073  name)).        s
-000139c0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000139d0: 6c65 6e28 6269 6e64 696e 672e 6e65 7477  len(binding.netw
-000139e0: 6f72 6b2e 696e 7465 7266 6163 6573 292c  ork.interfaces),
-000139f0: 2031 290a 2020 2020 2020 2020 696e 7465   1).        inte
-00013a00: 7266 6163 6520 3d20 6269 6e64 696e 672e  rface = binding.
-00013a10: 6e65 7477 6f72 6b2e 696e 7465 7266 6163  network.interfac
-00013a20: 6573 5b30 5d0a 2020 2020 2020 2020 7365  es[0].        se
-00013a30: 6c66 2e61 7373 6572 7449 734e 6f6e 6528  lf.assertIsNone(
-00013a40: 696e 7465 7266 6163 652e 6164 6472 6573  interface.addres
-00013a50: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
-00013a60: 6173 7365 7274 4973 4e6f 6e65 2869 6e74  assertIsNone(int
-00013a70: 6572 6661 6365 2e73 7562 6e65 7429 0a0a  erface.subnet)..
-00013a80: 2020 2020 6465 6620 7465 7374 5f6d 6973      def test_mis
-00013a90: 7369 6e67 5f69 6e67 7265 7373 5f61 6464  sing_ingress_add
-00013aa0: 7265 7373 6573 2873 656c 6629 3a0a 2020  resses(self):.  
-00013ab0: 2020 2020 2020 6e65 7477 6f72 6b5f 6461        network_da
-00013ac0: 7461 203d 206a 736f 6e2e 6475 6d70 7328  ta = json.dumps(
-00013ad0: 7b0a 2020 2020 2020 2020 2020 2020 2762  {.            'b
-00013ae0: 696e 642d 6164 6472 6573 7365 7327 3a20  ind-addresses': 
-00013af0: 5b5d 2c0a 2020 2020 2020 2020 7d29 0a20  [],.        }). 
-00013b00: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-00013b10: 7074 2873 656c 662c 2027 6e65 7477 6f72  pt(self, 'networ
-00013b20: 6b2d 6765 7427 2c0a 2020 2020 2020 2020  k-get',.        
-00013b30: 2020 2020 2020 2020 2020 2020 6627 2727              f'''
-00013b40: 5b20 2224 3122 203d 2064 6230 205d 2026  [ "$1" = db0 ] &
-00013b50: 2620 6563 686f 2027 7b6e 6574 776f 726b  & echo '{network
-00013b60: 5f64 6174 617d 2720 7c7c 2065 7869 7420  _data}' || exit 
-00013b70: 3127 2727 290a 2020 2020 2020 2020 6269  1''').        bi
-00013b80: 6e64 696e 675f 6e61 6d65 203d 2027 6462  nding_name = 'db
-00013b90: 3027 0a20 2020 2020 2020 2062 696e 6469  0'.        bindi
-00013ba0: 6e67 203d 2073 656c 662e 6d6f 6465 6c2e  ng = self.model.
-00013bb0: 6765 745f 6269 6e64 696e 6728 7365 6c66  get_binding(self
-00013bc0: 2e6d 6f64 656c 2e67 6574 5f72 656c 6174  .model.get_relat
-00013bd0: 696f 6e28 6269 6e64 696e 675f 6e61 6d65  ion(binding_name
-00013be0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-00013bf0: 6173 7365 7274 4571 7561 6c28 6269 6e64  assertEqual(bind
-00013c00: 696e 672e 6e65 7477 6f72 6b2e 696e 6772  ing.network.ingr
-00013c10: 6573 735f 6164 6472 6573 7365 732c 205b  ess_addresses, [
-00013c20: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
-00013c30: 6173 7365 7274 4571 7561 6c28 6269 6e64  assertEqual(bind
-00013c40: 696e 672e 6e65 7477 6f72 6b2e 696e 6772  ing.network.ingr
-00013c50: 6573 735f 6164 6472 6573 732c 204e 6f6e  ess_address, Non
-00013c60: 6529 0a0a 2020 2020 6465 6620 7465 7374  e)..    def test
-00013c70: 5f6d 6973 7369 6e67 5f65 6772 6573 735f  _missing_egress_
-00013c80: 7375 626e 6574 7328 7365 6c66 293a 0a20  subnets(self):. 
-00013c90: 2020 2020 2020 206e 6574 776f 726b 5f64         network_d
-00013ca0: 6174 6120 3d20 6a73 6f6e 2e64 756d 7073  ata = json.dumps
-00013cb0: 287b 0a20 2020 2020 2020 2020 2020 2027  ({.            '
-00013cc0: 6269 6e64 2d61 6464 7265 7373 6573 273a  bind-addresses':
-00013cd0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00013ce0: 2027 696e 6772 6573 732d 6164 6472 6573   'ingress-addres
-00013cf0: 7365 7327 3a20 5b5d 2c0a 2020 2020 2020  ses': [],.      
-00013d00: 2020 7d29 0a20 2020 2020 2020 2066 616b    }).        fak
-00013d10: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-00013d20: 6e65 7477 6f72 6b2d 6765 7427 2c0a 2020  network-get',.  
-00013d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d40: 2020 6627 2727 5b20 2224 3122 203d 2064    f'''[ "$1" = d
-00013d50: 6230 205d 2026 2620 6563 686f 2027 7b6e  b0 ] && echo '{n
-00013d60: 6574 776f 726b 5f64 6174 617d 2720 7c7c  etwork_data}' ||
-00013d70: 2065 7869 7420 3127 2727 290a 2020 2020   exit 1''').    
-00013d80: 2020 2020 6269 6e64 696e 675f 6e61 6d65      binding_name
-00013d90: 203d 2027 6462 3027 0a20 2020 2020 2020   = 'db0'.       
-00013da0: 2062 696e 6469 6e67 203d 2073 656c 662e   binding = self.
-00013db0: 6d6f 6465 6c2e 6765 745f 6269 6e64 696e  model.get_bindin
-00013dc0: 6728 7365 6c66 2e6d 6f64 656c 2e67 6574  g(self.model.get
-00013dd0: 5f72 656c 6174 696f 6e28 6269 6e64 696e  _relation(bindin
-00013de0: 675f 6e61 6d65 2929 0a20 2020 2020 2020  g_name)).       
-00013df0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00013e00: 6c28 6269 6e64 696e 672e 6e65 7477 6f72  l(binding.networ
-00013e10: 6b2e 6567 7265 7373 5f73 7562 6e65 7473  k.egress_subnets
-00013e20: 2c20 5b5d 290a 0a20 2020 2064 6566 2074  , [])..    def t
-00013e30: 6573 745f 756e 7265 736f 6c76 6564 5f69  est_unresolved_i
-00013e40: 6e67 7265 7373 5f61 6464 7265 7373 6573  ngress_addresses
-00013e50: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00013e60: 2320 736f 6d65 7469 6d65 7320 6a75 6a75  # sometimes juju
-00013e70: 2066 6169 6c73 2074 6f20 7265 736f 6c76   fails to resolv
-00013e80: 6520 616e 2075 726c 2074 6f20 616e 2049  e an url to an I
-00013e90: 502c 2069 6e20 7768 6963 6820 6361 7365  P, in which case
-00013ea0: 0a20 2020 2020 2020 2023 2069 6e67 7265  .        # ingre
-00013eb0: 7373 2d61 6464 7265 7373 6573 2077 696c  ss-addresses wil
-00013ec0: 6c20 6265 2074 6865 2027 7261 7727 2075  l be the 'raw' u
-00013ed0: 726c 2069 6e73 7465 6164 206f 6620 616e  rl instead of an
-00013ee0: 2049 502e 0a20 2020 2020 2020 206e 6574   IP..        net
-00013ef0: 776f 726b 5f64 6174 6120 3d20 6a73 6f6e  work_data = json
-00013f00: 2e64 756d 7073 287b 0a20 2020 2020 2020  .dumps({.       
-00013f10: 2020 2020 2027 696e 6772 6573 732d 6164       'ingress-ad
-00013f20: 6472 6573 7365 7327 3a20 5b0a 2020 2020  dresses': [.    
-00013f30: 2020 2020 2020 2020 2020 2020 2766 6f6f              'foo
-00013f40: 2e62 6172 2e62 617a 2e63 6f6d 270a 2020  .bar.baz.com'.  
-00013f50: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
-00013f60: 2020 2020 207d 290a 2020 2020 2020 2020       }).        
-00013f70: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-00013f80: 2c20 276e 6574 776f 726b 2d67 6574 272c  , 'network-get',
-00013f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013fa0: 2020 2020 2066 2727 275b 2022 2431 2220       f'''[ "$1" 
-00013fb0: 3d20 6462 3020 5d20 2626 2065 6368 6f20  = db0 ] && echo 
-00013fc0: 277b 6e65 7477 6f72 6b5f 6461 7461 7d27  '{network_data}'
-00013fd0: 207c 7c20 6578 6974 2031 2727 2729 0a20   || exit 1'''). 
-00013fe0: 2020 2020 2020 2062 696e 6469 6e67 5f6e         binding_n
-00013ff0: 616d 6520 3d20 2764 6230 270a 2020 2020  ame = 'db0'.    
-00014000: 2020 2020 6269 6e64 696e 6720 3d20 7365      binding = se
-00014010: 6c66 2e6d 6f64 656c 2e67 6574 5f62 696e  lf.model.get_bin
-00014020: 6469 6e67 2873 656c 662e 6d6f 6465 6c2e  ding(self.model.
-00014030: 6765 745f 7265 6c61 7469 6f6e 2862 696e  get_relation(bin
-00014040: 6469 6e67 5f6e 616d 6529 290a 2020 2020  ding_name)).    
-00014050: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00014060: 7175 616c 2862 696e 6469 6e67 2e6e 6574  qual(binding.net
-00014070: 776f 726b 2e69 6e67 7265 7373 5f61 6464  work.ingress_add
-00014080: 7265 7373 6573 2c20 5b27 666f 6f2e 6261  resses, ['foo.ba
-00014090: 722e 6261 7a2e 636f 6d27 5d29 0a0a 0a63  r.baz.com'])...c
-000140a0: 6c61 7373 2054 6573 744d 6f64 656c 4261  lass TestModelBa
-000140b0: 636b 656e 6428 756e 6974 7465 7374 2e54  ckend(unittest.T
-000140c0: 6573 7443 6173 6529 3a0a 0a20 2020 2064  estCase):..    d
-000140d0: 6566 2073 6574 5570 2873 656c 6629 3a0a  ef setUp(self):.
-000140e0: 2020 2020 2020 2020 7365 6c66 2e5f 6261          self._ba
-000140f0: 636b 656e 6420 3d20 4e6f 6e65 0a0a 2020  ckend = None..  
-00014100: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00014110: 6465 6620 6261 636b 656e 6428 7365 6c66  def backend(self
-00014120: 293a 0a20 2020 2020 2020 2069 6620 7365  ):.        if se
-00014130: 6c66 2e5f 6261 636b 656e 6420 6973 204e  lf._backend is N
-00014140: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00014150: 2073 656c 662e 5f62 6163 6b65 6e64 203d   self._backend =
-00014160: 205f 4d6f 6465 6c42 6163 6b65 6e64 2827   _ModelBackend('
-00014170: 6d79 6170 702f 3027 290a 2020 2020 2020  myapp/0').      
-00014180: 2020 7265 7475 726e 2073 656c 662e 5f62    return self._b
-00014190: 6163 6b65 6e64 0a0a 2020 2020 6465 6620  ackend..    def 
-000141a0: 7465 7374 5f72 656c 6174 696f 6e5f 6765  test_relation_ge
-000141b0: 745f 7365 745f 6973 5f61 7070 5f61 7267  t_set_is_app_arg
-000141c0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000141d0: 2320 4e6f 2069 735f 6170 7020 7072 6f76  # No is_app prov
-000141e0: 6964 6564 2e0a 2020 2020 2020 2020 7769  ided..        wi
-000141f0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00014200: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
-00014210: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00014220: 662e 6261 636b 656e 642e 7265 6c61 7469  f.backend.relati
-00014230: 6f6e 5f73 6574 2831 2c20 2766 6f6f 6b65  on_set(1, 'fooke
-00014240: 7927 2c20 2762 6172 7661 6c27 290a 0a20  y', 'barval').. 
-00014250: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00014260: 2e61 7373 6572 7452 6169 7365 7328 5479  .assertRaises(Ty
-00014270: 7065 4572 726f 7229 3a0a 2020 2020 2020  peError):.      
-00014280: 2020 2020 2020 7365 6c66 2e62 6163 6b65        self.backe
-00014290: 6e64 2e72 656c 6174 696f 6e5f 6765 7428  nd.relation_get(
-000142a0: 312c 2027 666f 6f65 6e74 6974 7927 290a  1, 'fooentity').
-000142b0: 0a20 2020 2020 2020 2023 2049 6e76 616c  .        # Inval
-000142c0: 6964 2074 7970 6573 2066 6f72 2069 735f  id types for is_
-000142d0: 6170 702e 0a20 2020 2020 2020 2066 6f72  app..        for
-000142e0: 2069 735f 6170 705f 7620 696e 205b 4e6f   is_app_v in [No
-000142f0: 6e65 2c20 312c 2032 2e30 2c20 2761 272c  ne, 1, 2.0, 'a',
-00014300: 2062 2762 6565 6627 5d3a 0a20 2020 2020   b'beef']:.     
-00014310: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00014320: 2e61 7373 6572 7452 6169 7365 7328 5479  .assertRaises(Ty
-00014330: 7065 4572 726f 7229 3a0a 2020 2020 2020  peError):.      
-00014340: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
-00014350: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-00014360: 7365 7428 312c 2027 666f 6f6b 6579 272c  set(1, 'fookey',
-00014370: 2027 6261 7276 616c 272c 2069 735f 6170   'barval', is_ap
-00014380: 703d 6973 5f61 7070 5f76 290a 0a20 2020  p=is_app_v)..   
-00014390: 2020 2020 2020 2020 2077 6974 6820 7365           with se
-000143a0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-000143b0: 5479 7065 4572 726f 7229 3a0a 2020 2020  TypeError):.    
-000143c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000143d0: 2e62 6163 6b65 6e64 2e72 656c 6174 696f  .backend.relatio
-000143e0: 6e5f 6765 7428 312c 2027 666f 6f65 6e74  n_get(1, 'fooent
-000143f0: 6974 7927 2c20 6973 5f61 7070 3d69 735f  ity', is_app=is_
-00014400: 6170 705f 7629 0a0a 2020 2020 6465 6620  app_v)..    def 
-00014410: 7465 7374 5f69 735f 6c65 6164 6572 5f72  test_is_leader_r
-00014420: 6566 7265 7368 2873 656c 6629 3a0a 2020  efresh(self):.  
-00014430: 2020 2020 2020 6d65 7461 203d 206f 7073        meta = ops
-00014440: 2e43 6861 726d 4d65 7461 2e66 726f 6d5f  .CharmMeta.from_
-00014450: 7961 6d6c 2827 2727 0a20 2020 2020 2020  yaml('''.       
-00014460: 2020 2020 206e 616d 653a 206d 7961 7070       name: myapp
-00014470: 0a20 2020 2020 2020 2027 2727 290a 2020  .        ''').  
-00014480: 2020 2020 2020 6d6f 6465 6c20 3d20 6f70        model = op
-00014490: 732e 4d6f 6465 6c28 6d65 7461 2c20 7365  s.Model(meta, se
-000144a0: 6c66 2e62 6163 6b65 6e64 290a 2020 2020  lf.backend).    
-000144b0: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-000144c0: 7365 6c66 2c20 2769 732d 6c65 6164 6572  self, 'is-leader
-000144d0: 272c 2027 6563 686f 2066 616c 7365 2729  ', 'echo false')
-000144e0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000144f0: 7365 7274 4661 6c73 6528 6d6f 6465 6c2e  sertFalse(model.
-00014500: 756e 6974 2e69 735f 6c65 6164 6572 2829  unit.is_leader()
-00014510: 290a 0a20 2020 2020 2020 2023 2043 6861  )..        # Cha
-00014520: 6e67 6520 7468 6520 6c65 6164 6572 7368  nge the leadersh
-00014530: 6970 2073 7461 7475 730a 2020 2020 2020  ip status.      
-00014540: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-00014550: 6c66 2c20 2769 732d 6c65 6164 6572 272c  lf, 'is-leader',
-00014560: 2027 6563 686f 2074 7275 6527 290a 2020   'echo true').  
-00014570: 2020 2020 2020 2320 4966 2079 6f75 2064        # If you d
-00014580: 6f6e 2774 2066 6f72 6365 2069 742c 2077  on't force it, w
-00014590: 6520 646f 6e27 7420 6368 6563 6b2c 2073  e don't check, s
-000145a0: 6f20 7765 2077 6f6e 2774 2073 6565 2074  o we won't see t
-000145b0: 6865 2063 6861 6e67 650a 2020 2020 2020  he change.      
-000145c0: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
-000145d0: 7365 286d 6f64 656c 2e75 6e69 742e 6973  se(model.unit.is
-000145e0: 5f6c 6561 6465 7228 2929 0a20 2020 2020  _leader()).     
-000145f0: 2020 2023 2049 6620 7765 2066 6f72 6365     # If we force
-00014600: 2061 2072 6563 6865 636b 2c20 7468 656e   a recheck, then
-00014610: 2077 6520 6e6f 7469 6365 0a20 2020 2020   we notice.     
-00014620: 2020 2073 656c 662e 6261 636b 656e 642e     self.backend.
-00014630: 5f6c 6561 6465 725f 6368 6563 6b5f 7469  _leader_check_ti
-00014640: 6d65 203d 204e 6f6e 650a 2020 2020 2020  me = None.      
-00014650: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
-00014660: 6528 6d6f 6465 6c2e 756e 6974 2e69 735f  e(model.unit.is_
-00014670: 6c65 6164 6572 2829 290a 0a20 2020 2020  leader())..     
-00014680: 2020 2023 2046 6f72 6365 2061 2072 6563     # Force a rec
-00014690: 6865 636b 2077 6974 686f 7574 2063 6861  heck without cha
-000146a0: 6e67 696e 6720 7468 6520 6c65 6164 6572  nging the leader
-000146b0: 7368 6970 2073 7461 7475 732e 0a20 2020  ship status..   
-000146c0: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-000146d0: 2873 656c 662c 2027 6973 2d6c 6561 6465  (self, 'is-leade
-000146e0: 7227 2c20 2765 6368 6f20 7472 7565 2729  r', 'echo true')
-000146f0: 0a20 2020 2020 2020 2073 656c 662e 6261  .        self.ba
-00014700: 636b 656e 642e 5f6c 6561 6465 725f 6368  ckend._leader_ch
-00014710: 6563 6b5f 7469 6d65 203d 204e 6f6e 650a  eck_time = None.
-00014720: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00014730: 6572 7454 7275 6528 6d6f 6465 6c2e 756e  ertTrue(model.un
-00014740: 6974 2e69 735f 6c65 6164 6572 2829 290a  it.is_leader()).
-00014750: 0a20 2020 2064 6566 2074 6573 745f 7265  .    def test_re
-00014760: 6c61 7469 6f6e 5f74 6f6f 6c5f 6572 726f  lation_tool_erro
-00014770: 7273 2873 656c 6629 3a0a 2020 2020 2020  rs(self):.      
-00014780: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-00014790: 7028 6f73 2e65 6e76 6972 6f6e 2e70 6f70  p(os.environ.pop
-000147a0: 2c20 274a 554a 555f 5645 5253 494f 4e27  , 'JUJU_VERSION'
-000147b0: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
-000147c0: 6f73 2e65 6e76 6972 6f6e 5b27 4a55 4a55  os.environ['JUJU
-000147d0: 5f56 4552 5349 4f4e 275d 203d 2027 322e  _VERSION'] = '2.
-000147e0: 382e 3027 0a20 2020 2020 2020 2065 7272  8.0'.        err
-000147f0: 5f6d 7367 203d 2027 4552 524f 5220 696e  _msg = 'ERROR in
-00014800: 7661 6c69 6420 7661 6c75 6520 2224 3222  valid value "$2"
-00014810: 2066 6f72 206f 7074 696f 6e20 2d72 3a20   for option -r: 
-00014820: 7265 6c61 7469 6f6e 206e 6f74 2066 6f75  relation not fou
-00014830: 6e64 270a 0a20 2020 2020 2020 2074 6573  nd'..        tes
-00014840: 745f 6361 7365 7320 3d20 5b28 0a20 2020  t_cases = [(.   
-00014850: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
-00014860: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-00014870: 662c 2027 7265 6c61 7469 6f6e 2d6c 6973  f, 'relation-lis
-00014880: 7427 2c20 2765 6368 6f20 666f 6f65 7272  t', 'echo fooerr
-00014890: 6f72 203e 2632 203b 2065 7869 7420 3127  or >&2 ; exit 1'
-000148a0: 292c 0a20 2020 2020 2020 2020 2020 206c  ),.            l
-000148b0: 616d 6264 613a 2073 656c 662e 6261 636b  ambda: self.back
-000148c0: 656e 642e 7265 6c61 7469 6f6e 5f6c 6973  end.relation_lis
-000148d0: 7428 3329 2c0a 2020 2020 2020 2020 2020  t(3),.          
-000148e0: 2020 6f70 732e 4d6f 6465 6c45 7272 6f72    ops.ModelError
-000148f0: 2c0a 2020 2020 2020 2020 2020 2020 5b5b  ,.            [[
-00014900: 2772 656c 6174 696f 6e2d 6c69 7374 272c  'relation-list',
-00014910: 2027 2d72 272c 2027 3327 2c20 272d 2d66   '-r', '3', '--f
-00014920: 6f72 6d61 743d 6a73 6f6e 275d 5d2c 0a20  ormat=json']],. 
-00014930: 2020 2020 2020 2029 2c20 280a 2020 2020         ), (.    
-00014940: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
-00014950: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-00014960: 2c20 2772 656c 6174 696f 6e2d 6c69 7374  , 'relation-list
-00014970: 272c 2066 2765 6368 6f20 7b65 7272 5f6d  ', f'echo {err_m
-00014980: 7367 7d20 3e26 3220 3b20 6578 6974 2032  sg} >&2 ; exit 2
-00014990: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-000149a0: 6c61 6d62 6461 3a20 7365 6c66 2e62 6163  lambda: self.bac
-000149b0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6c69  kend.relation_li
-000149c0: 7374 2833 292c 0a20 2020 2020 2020 2020  st(3),.         
-000149d0: 2020 206f 7073 2e52 656c 6174 696f 6e4e     ops.RelationN
-000149e0: 6f74 466f 756e 6445 7272 6f72 2c0a 2020  otFoundError,.  
-000149f0: 2020 2020 2020 2020 2020 5b5b 2772 656c            [['rel
-00014a00: 6174 696f 6e2d 6c69 7374 272c 2027 2d72  ation-list', '-r
-00014a10: 272c 2027 3327 2c20 272d 2d66 6f72 6d61  ', '3', '--forma
-00014a20: 743d 6a73 6f6e 275d 5d2c 0a20 2020 2020  t=json']],.     
-00014a30: 2020 2029 2c20 280a 2020 2020 2020 2020     ), (.        
-00014a40: 2020 2020 6c61 6d62 6461 3a20 6661 6b65      lambda: fake
-00014a50: 5f73 6372 6970 7428 7365 6c66 2c20 2772  _script(self, 'r
-00014a60: 656c 6174 696f 6e2d 7365 7427 2c20 2765  elation-set', 'e
-00014a70: 6368 6f20 666f 6f65 7272 6f72 203e 2632  cho fooerror >&2
-00014a80: 203b 2065 7869 7420 3127 292c 0a20 2020   ; exit 1'),.   
-00014a90: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
-00014aa0: 2073 656c 662e 6261 636b 656e 642e 7265   self.backend.re
-00014ab0: 6c61 7469 6f6e 5f73 6574 2833 2c20 2766  lation_set(3, 'f
-00014ac0: 6f6f 272c 2027 6261 7227 2c20 6973 5f61  oo', 'bar', is_a
-00014ad0: 7070 3d46 616c 7365 292c 0a20 2020 2020  pp=False),.     
-00014ae0: 2020 2020 2020 206f 7073 2e4d 6f64 656c         ops.Model
-00014af0: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
-00014b00: 2020 205b 5b27 7265 6c61 7469 6f6e 2d73     [['relation-s
-00014b10: 6574 272c 2027 2d72 272c 2027 3327 2c20  et', '-r', '3', 
-00014b20: 272d 2d66 696c 6527 2c20 272d 275d 5d2c  '--file', '-']],
-00014b30: 0a20 2020 2020 2020 2029 2c20 280a 2020  .        ), (.  
-00014b40: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
-00014b50: 3a20 6661 6b65 5f73 6372 6970 7428 7365  : fake_script(se
-00014b60: 6c66 2c20 2772 656c 6174 696f 6e2d 7365  lf, 'relation-se
-00014b70: 7427 2c20 6627 6563 686f 207b 6572 725f  t', f'echo {err_
-00014b80: 6d73 677d 203e 2632 203b 2065 7869 7420  msg} >&2 ; exit 
-00014b90: 3227 292c 0a20 2020 2020 2020 2020 2020  2'),.           
-00014ba0: 206c 616d 6264 613a 2073 656c 662e 6261   lambda: self.ba
-00014bb0: 636b 656e 642e 7265 6c61 7469 6f6e 5f73  ckend.relation_s
-00014bc0: 6574 2833 2c20 2766 6f6f 272c 2027 6261  et(3, 'foo', 'ba
-00014bd0: 7227 2c20 6973 5f61 7070 3d46 616c 7365  r', is_app=False
-00014be0: 292c 0a20 2020 2020 2020 2020 2020 206f  ),.            o
-00014bf0: 7073 2e52 656c 6174 696f 6e4e 6f74 466f  ps.RelationNotFo
-00014c00: 756e 6445 7272 6f72 2c0a 2020 2020 2020  undError,.      
-00014c10: 2020 2020 2020 5b5b 2772 656c 6174 696f        [['relatio
-00014c20: 6e2d 7365 7427 2c20 272d 7227 2c20 2733  n-set', '-r', '3
-00014c30: 272c 2027 2d2d 6669 6c65 272c 2027 2d27  ', '--file', '-'
-00014c40: 5d5d 2c0a 2020 2020 2020 2020 292c 2028  ]],.        ), (
-00014c50: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
-00014c60: 6264 613a 204e 6f6e 652c 0a20 2020 2020  bda: None,.     
-00014c70: 2020 2020 2020 206c 616d 6264 613a 2073         lambda: s
-00014c80: 656c 662e 6261 636b 656e 642e 7265 6c61  elf.backend.rela
-00014c90: 7469 6f6e 5f73 6574 2833 2c20 2766 6f6f  tion_set(3, 'foo
-00014ca0: 272c 2027 6261 7227 2c20 6973 5f61 7070  ', 'bar', is_app
-00014cb0: 3d54 7275 6529 2c0a 2020 2020 2020 2020  =True),.        
-00014cc0: 2020 2020 6f70 732e 5265 6c61 7469 6f6e      ops.Relation
-00014cd0: 4e6f 7446 6f75 6e64 4572 726f 722c 0a20  NotFoundError,. 
-00014ce0: 2020 2020 2020 2020 2020 205b 5b27 7265             [['re
-00014cf0: 6c61 7469 6f6e 2d73 6574 272c 2027 2d72  lation-set', '-r
-00014d00: 272c 2027 3327 2c20 272d 2d61 7070 272c  ', '3', '--app',
-00014d10: 2027 2d2d 6669 6c65 272c 2027 2d27 5d5d   '--file', '-']]
-00014d20: 2c0a 2020 2020 2020 2020 292c 2028 0a20  ,.        ), (. 
-00014d30: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
-00014d40: 613a 2066 616b 655f 7363 7269 7074 2873  a: fake_script(s
-00014d50: 656c 662c 2027 7265 6c61 7469 6f6e 2d67  elf, 'relation-g
-00014d60: 6574 272c 2027 6563 686f 2066 6f6f 6572  et', 'echo fooer
-00014d70: 726f 7220 3e26 3220 3b20 6578 6974 2031  ror >&2 ; exit 1
-00014d80: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-00014d90: 6c61 6d62 6461 3a20 7365 6c66 2e62 6163  lambda: self.bac
-00014da0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
-00014db0: 7428 332c 2027 7265 6d6f 7465 2f30 272c  t(3, 'remote/0',
-00014dc0: 2069 735f 6170 703d 4661 6c73 6529 2c0a   is_app=False),.
-00014dd0: 2020 2020 2020 2020 2020 2020 6f70 732e              ops.
-00014de0: 4d6f 6465 6c45 7272 6f72 2c0a 2020 2020  ModelError,.    
-00014df0: 2020 2020 2020 2020 5b5b 2772 656c 6174          [['relat
-00014e00: 696f 6e2d 6765 7427 2c20 272d 7227 2c20  ion-get', '-r', 
-00014e10: 2733 272c 2027 2d27 2c20 2772 656d 6f74  '3', '-', 'remot
-00014e20: 652f 3027 2c20 272d 2d66 6f72 6d61 743d  e/0', '--format=
-00014e30: 6a73 6f6e 275d 5d2c 0a20 2020 2020 2020  json']],.       
-00014e40: 2029 2c20 280a 2020 2020 2020 2020 2020   ), (.          
-00014e50: 2020 6c61 6d62 6461 3a20 6661 6b65 5f73    lambda: fake_s
-00014e60: 6372 6970 7428 7365 6c66 2c20 2772 656c  cript(self, 'rel
-00014e70: 6174 696f 6e2d 6765 7427 2c20 6627 6563  ation-get', f'ec
-00014e80: 686f 207b 6572 725f 6d73 677d 203e 2632  ho {err_msg} >&2
-00014e90: 203b 2065 7869 7420 3227 292c 0a20 2020   ; exit 2'),.   
-00014ea0: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
-00014eb0: 2073 656c 662e 6261 636b 656e 642e 7265   self.backend.re
-00014ec0: 6c61 7469 6f6e 5f67 6574 2833 2c20 2772  lation_get(3, 'r
-00014ed0: 656d 6f74 652f 3027 2c20 6973 5f61 7070  emote/0', is_app
-00014ee0: 3d46 616c 7365 292c 0a20 2020 2020 2020  =False),.       
-00014ef0: 2020 2020 206f 7073 2e52 656c 6174 696f       ops.Relatio
-00014f00: 6e4e 6f74 466f 756e 6445 7272 6f72 2c0a  nNotFoundError,.
-00014f10: 2020 2020 2020 2020 2020 2020 5b5b 2772              [['r
-00014f20: 656c 6174 696f 6e2d 6765 7427 2c20 272d  elation-get', '-
-00014f30: 7227 2c20 2733 272c 2027 2d27 2c20 2772  r', '3', '-', 'r
-00014f40: 656d 6f74 652f 3027 2c20 272d 2d66 6f72  emote/0', '--for
-00014f50: 6d61 743d 6a73 6f6e 275d 5d2c 0a20 2020  mat=json']],.   
-00014f60: 2020 2020 2029 2c20 280a 2020 2020 2020       ), (.      
-00014f70: 2020 2020 2020 6c61 6d62 6461 3a20 4e6f        lambda: No
-00014f80: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00014f90: 6c61 6d62 6461 3a20 7365 6c66 2e62 6163  lambda: self.bac
-00014fa0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
-00014fb0: 7428 332c 2027 7265 6d6f 7465 2f30 272c  t(3, 'remote/0',
-00014fc0: 2069 735f 6170 703d 5472 7565 292c 0a20   is_app=True),. 
-00014fd0: 2020 2020 2020 2020 2020 206f 7073 2e52             ops.R
-00014fe0: 656c 6174 696f 6e4e 6f74 466f 756e 6445  elationNotFoundE
-00014ff0: 7272 6f72 2c0a 2020 2020 2020 2020 2020  rror,.          
-00015000: 2020 5b5b 2772 656c 6174 696f 6e2d 6765    [['relation-ge
-00015010: 7427 2c20 272d 7227 2c20 2733 272c 2027  t', '-r', '3', '
-00015020: 2d27 2c20 2772 656d 6f74 652f 3027 2c20  -', 'remote/0', 
-00015030: 272d 2d61 7070 272c 2027 2d2d 666f 726d  '--app', '--form
-00015040: 6174 3d6a 736f 6e27 5d5d 2c0a 2020 2020  at=json']],.    
-00015050: 2020 2020 295d 0a0a 2020 2020 2020 2020      )]..        
-00015060: 666f 7220 692c 2028 646f 5f66 616b 652c  for i, (do_fake,
-00015070: 2072 756e 2c20 6578 6365 7074 696f 6e2c   run, exception,
-00015080: 2063 616c 6c73 2920 696e 2065 6e75 6d65   calls) in enume
-00015090: 7261 7465 2874 6573 745f 6361 7365 7329  rate(test_cases)
-000150a0: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
-000150b0: 7468 2073 656c 662e 7375 6254 6573 7428  th self.subTest(
-000150c0: 6929 3a0a 2020 2020 2020 2020 2020 2020  i):.            
-000150d0: 2020 2020 646f 5f66 616b 6528 290a 2020      do_fake().  
-000150e0: 2020 2020 2020 2020 2020 2020 2020 7769                wi
-000150f0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00015100: 6973 6573 2865 7863 6570 7469 6f6e 293a  ises(exception):
-00015110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015120: 2020 2020 2072 756e 2829 0a20 2020 2020       run().     
-00015130: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00015140: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
-00015150: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
-00015160: 6c66 2c20 636c 6561 723d 5472 7565 292c  lf, clear=True),
-00015170: 2063 616c 6c73 290a 0a20 2020 2064 6566   calls)..    def
-00015180: 2074 6573 745f 7265 6c61 7469 6f6e 5f67   test_relation_g
-00015190: 6574 5f6a 756a 755f 7665 7273 696f 6e5f  et_juju_version_
-000151a0: 7175 6972 6b73 2873 656c 6629 3a0a 2020  quirks(self):.  
-000151b0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
-000151c0: 6561 6e75 7028 6f73 2e65 6e76 6972 6f6e  eanup(os.environ
-000151d0: 2e70 6f70 2c20 274a 554a 555f 5645 5253  .pop, 'JUJU_VERS
-000151e0: 494f 4e27 2c20 4e6f 6e65 290a 0a20 2020  ION', None)..   
-000151f0: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-00015200: 2873 656c 662c 2027 7265 6c61 7469 6f6e  (self, 'relation
-00015210: 2d67 6574 272c 2027 2727 6563 686f 2027  -get', '''echo '
-00015220: 7b22 666f 6f22 3a20 2262 6172 227d 2720  {"foo": "bar"}' 
-00015230: 2727 2729 0a0a 2020 2020 2020 2020 2320  ''')..        # 
-00015240: 6f6e 2032 2e37 2e30 2b2c 2074 6869 6e67  on 2.7.0+, thing
-00015250: 7320 7072 6f63 6565 6420 6173 2065 7870  s proceed as exp
-00015260: 6563 7465 640a 2020 2020 2020 2020 666f  ected.        fo
-00015270: 7220 7620 696e 205b 2732 2e38 2e30 272c  r v in ['2.8.0',
-00015280: 2027 322e 372e 3027 5d3a 0a20 2020 2020   '2.7.0']:.     
-00015290: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-000152a0: 2e73 7562 5465 7374 2876 293a 0a20 2020  .subTest(v):.   
-000152b0: 2020 2020 2020 2020 2020 2020 206f 732e               os.
-000152c0: 656e 7669 726f 6e5b 274a 554a 555f 5645  environ['JUJU_VE
-000152d0: 5253 494f 4e27 5d20 3d20 760a 2020 2020  RSION'] = v.    
-000152e0: 2020 2020 2020 2020 2020 2020 7265 6c5f              rel_
-000152f0: 6461 7461 203d 2073 656c 662e 6261 636b  data = self.back
-00015300: 656e 642e 7265 6c61 7469 6f6e 5f67 6574  end.relation_get
-00015310: 2831 2c20 2766 6f6f 2f30 272c 2069 735f  (1, 'foo/0', is_
-00015320: 6170 703d 5472 7565 290a 2020 2020 2020  app=True).      
-00015330: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00015340: 7373 6572 7445 7175 616c 2872 656c 5f64  ssertEqual(rel_d
-00015350: 6174 612c 207b 2266 6f6f 223a 2022 6261  ata, {"foo": "ba
-00015360: 7222 7d29 0a20 2020 2020 2020 2020 2020  r"}).           
-00015370: 2020 2020 2063 616c 6c73 203d 205b 2720       calls = [' 
-00015380: 272e 6a6f 696e 2869 2920 666f 7220 6920  '.join(i) for i 
-00015390: 696e 2066 616b 655f 7363 7269 7074 5f63  in fake_script_c
-000153a0: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
-000153b0: 3d54 7275 6529 5d0a 2020 2020 2020 2020  =True)].        
-000153c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000153d0: 6572 7445 7175 616c 2863 616c 6c73 2c20  ertEqual(calls, 
-000153e0: 5b27 7265 6c61 7469 6f6e 2d67 6574 202d  ['relation-get -
-000153f0: 7220 3120 2d20 666f 6f2f 3020 2d2d 6170  r 1 - foo/0 --ap
-00015400: 7020 2d2d 666f 726d 6174 3d6a 736f 6e27  p --format=json'
-00015410: 5d29 0a0a 2020 2020 2020 2020 2320 6265  ])..        # be
-00015420: 666f 7265 2032 2e37 2e30 2c20 6974 206a  fore 2.7.0, it j
-00015430: 7573 7420 6661 696c 7320 286e 6f20 2d2d  ust fails (no --
-00015440: 6170 7020 7375 7070 6f72 7429 0a20 2020  app support).   
-00015450: 2020 2020 206f 732e 656e 7669 726f 6e5b       os.environ[
-00015460: 274a 554a 555f 5645 5253 494f 4e27 5d20  'JUJU_VERSION'] 
-00015470: 3d20 2732 2e36 2e39 270a 2020 2020 2020  = '2.6.9'.      
-00015480: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00015490: 7274 5261 6973 6573 5265 6765 7828 5275  rtRaisesRegex(Ru
-000154a0: 6e74 696d 6545 7272 6f72 2c20 276e 6f74  ntimeError, 'not
-000154b0: 2073 7570 706f 7274 6564 206f 6e20 4a75   supported on Ju
-000154c0: 6a75 2076 6572 7369 6f6e 2032 2e36 2e39  ju version 2.6.9
-000154d0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-000154e0: 7365 6c66 2e62 6163 6b65 6e64 2e72 656c  self.backend.rel
-000154f0: 6174 696f 6e5f 6765 7428 312c 2027 666f  ation_get(1, 'fo
-00015500: 6f2f 3027 2c20 6973 5f61 7070 3d54 7275  o/0', is_app=Tru
-00015510: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
-00015520: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
-00015530: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
-00015540: 6c66 292c 205b 5d29 0a0a 2020 2020 6465  lf), [])..    de
-00015550: 6620 7465 7374 5f72 656c 6174 696f 6e5f  f test_relation_
-00015560: 7365 745f 6a75 6a75 5f76 6572 7369 6f6e  set_juju_version
-00015570: 5f71 7569 726b 7328 7365 6c66 293a 0a20  _quirks(self):. 
-00015580: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-00015590: 6c65 616e 7570 286f 732e 656e 7669 726f  leanup(os.enviro
-000155a0: 6e2e 706f 702c 2027 4a55 4a55 5f56 4552  n.pop, 'JUJU_VER
-000155b0: 5349 4f4e 272c 204e 6f6e 6529 0a0a 2020  SION', None)..  
-000155c0: 2020 2020 2020 2320 6f6e 2032 2e37 2e30        # on 2.7.0
-000155d0: 2b2c 2074 6869 6e67 7320 7072 6f63 6565  +, things procee
-000155e0: 6420 6173 2065 7870 6563 7465 640a 2020  d as expected.  
-000155f0: 2020 2020 2020 666f 7220 7620 696e 205b        for v in [
-00015600: 2732 2e38 2e30 272c 2027 322e 372e 3027  '2.8.0', '2.7.0'
-00015610: 5d3a 0a20 2020 2020 2020 2020 2020 2077  ]:.            w
-00015620: 6974 6820 7365 6c66 2e73 7562 5465 7374  ith self.subTest
-00015630: 2876 293a 0a20 2020 2020 2020 2020 2020  (v):.           
-00015640: 2020 2020 2074 203d 2074 656d 7066 696c       t = tempfil
-00015650: 652e 4e61 6d65 6454 656d 706f 7261 7279  e.NamedTemporary
-00015660: 4669 6c65 2829 0a20 2020 2020 2020 2020  File().         
-00015670: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00015680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015690: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-000156a0: 2c20 2772 656c 6174 696f 6e2d 7365 7427  , 'relation-set'
-000156b0: 2c20 6465 6465 6e74 2822 2222 0a20 2020  , dedent(""".   
-000156c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000156d0: 2020 2020 2063 6174 203e 3e20 7b7d 0a20       cat >> {}. 
-000156e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000156f0: 2020 2020 2020 2022 2222 292e 666f 726d         """).form
-00015700: 6174 2870 6174 686c 6962 2e50 6174 6828  at(pathlib.Path(
-00015710: 742e 6e61 6d65 292e 6173 5f70 6f73 6978  t.name).as_posix
-00015720: 2829 2929 0a20 2020 2020 2020 2020 2020  ())).           
-00015730: 2020 2020 2020 2020 206f 732e 656e 7669           os.envi
-00015740: 726f 6e5b 274a 554a 555f 5645 5253 494f  ron['JUJU_VERSIO
-00015750: 4e27 5d20 3d20 760a 2020 2020 2020 2020  N'] = v.        
-00015760: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00015770: 2e62 6163 6b65 6e64 2e72 656c 6174 696f  .backend.relatio
-00015780: 6e5f 7365 7428 312c 2027 666f 6f27 2c20  n_set(1, 'foo', 
-00015790: 2762 6172 272c 2069 735f 6170 703d 5472  'bar', is_app=Tr
-000157a0: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-000157b0: 2020 2020 2020 2020 6361 6c6c 7320 3d20          calls = 
-000157c0: 5b27 2027 2e6a 6f69 6e28 6929 2066 6f72  [' '.join(i) for
-000157d0: 2069 2069 6e20 6661 6b65 5f73 6372 6970   i in fake_scrip
-000157e0: 745f 6361 6c6c 7328 7365 6c66 2c20 636c  t_calls(self, cl
-000157f0: 6561 723d 5472 7565 295d 0a20 2020 2020  ear=True)].     
-00015800: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00015810: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00015820: 6361 6c6c 732c 205b 2772 656c 6174 696f  calls, ['relatio
-00015830: 6e2d 7365 7420 2d72 2031 202d 2d61 7070  n-set -r 1 --app
-00015840: 202d 2d66 696c 6520 2d27 5d29 0a20 2020   --file -']).   
-00015850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015860: 2074 2e73 6565 6b28 3029 0a20 2020 2020   t.seek(0).     
-00015870: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00015880: 6f6e 7465 6e74 203d 2074 2e72 6561 6428  ontent = t.read(
-00015890: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000158a0: 2020 6669 6e61 6c6c 793a 0a20 2020 2020    finally:.     
-000158b0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000158c0: 2e63 6c6f 7365 2829 0a20 2020 2020 2020  .close().       
-000158d0: 2020 2020 2020 2020 2064 6563 6f64 6564           decoded
-000158e0: 203d 2063 6f6e 7465 6e74 2e64 6563 6f64   = content.decod
-000158f0: 6528 2775 7466 2d38 2729 2e72 6570 6c61  e('utf-8').repla
-00015900: 6365 2827 5c72 5c6e 272c 2027 5c6e 2729  ce('\r\n', '\n')
-00015910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015920: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00015930: 6c28 6465 636f 6465 642c 2027 666f 6f3a  l(decoded, 'foo:
-00015940: 2062 6172 5c6e 2729 0a0a 2020 2020 2020   bar\n')..      
-00015950: 2020 2320 6265 666f 7265 2032 2e37 2e30    # before 2.7.0
-00015960: 2c20 6974 206a 7573 7420 6661 696c 7320  , it just fails 
-00015970: 616c 7761 7973 2028 6e6f 202d 2d61 7070  always (no --app
-00015980: 2073 7570 706f 7274 290a 2020 2020 2020   support).      
-00015990: 2020 6f73 2e65 6e76 6972 6f6e 5b27 4a55    os.environ['JU
-000159a0: 4a55 5f56 4552 5349 4f4e 275d 203d 2027  JU_VERSION'] = '
-000159b0: 322e 362e 3927 0a20 2020 2020 2020 2077  2.6.9'.        w
-000159c0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-000159d0: 6169 7365 7352 6567 6578 2852 756e 7469  aisesRegex(Runti
-000159e0: 6d65 4572 726f 722c 2027 6e6f 7420 7375  meError, 'not su
-000159f0: 7070 6f72 7465 6420 6f6e 204a 756a 7520  pported on Juju 
-00015a00: 7665 7273 696f 6e20 322e 362e 3927 293a  version 2.6.9'):
-00015a10: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00015a20: 662e 6261 636b 656e 642e 7265 6c61 7469  f.backend.relati
-00015a30: 6f6e 5f73 6574 2831 2c20 2766 6f6f 272c  on_set(1, 'foo',
-00015a40: 2027 6261 7227 2c20 6973 5f61 7070 3d54   'bar', is_app=T
-00015a50: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
-00015a60: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-00015a70: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-00015a80: 7365 6c66 292c 205b 5d29 0a0a 2020 2020  self), [])..    
-00015a90: 6465 6620 7465 7374 5f73 7461 7475 735f  def test_status_
-00015aa0: 6765 7428 7365 6c66 293a 0a20 2020 2020  get(self):.     
-00015ab0: 2020 2023 2074 616b 656e 2066 726f 6d20     # taken from 
-00015ac0: 6163 7475 616c 204a 756a 7520 6f75 7470  actual Juju outp
-00015ad0: 7574 0a20 2020 2020 2020 2063 6f6e 7465  ut.        conte
-00015ae0: 6e74 203d 2027 7b22 6d65 7373 6167 6522  nt = '{"message"
-00015af0: 3a20 2222 2c20 2273 7461 7475 7322 3a20  : "", "status": 
-00015b00: 2275 6e6b 6e6f 776e 222c 2022 7374 6174  "unknown", "stat
-00015b10: 7573 2d64 6174 6122 3a20 7b7d 7d27 0a20  us-data": {}}'. 
-00015b20: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-00015b30: 7074 2873 656c 662c 2027 7374 6174 7573  pt(self, 'status
-00015b40: 2d67 6574 272c 2066 2265 6368 6f20 277b  -get', f"echo '{
-00015b50: 636f 6e74 656e 747d 2722 290a 2020 2020  content}'").    
-00015b60: 2020 2020 7320 3d20 7365 6c66 2e62 6163      s = self.bac
-00015b70: 6b65 6e64 2e73 7461 7475 735f 6765 7428  kend.status_get(
-00015b80: 6973 5f61 7070 3d46 616c 7365 290a 2020  is_app=False).  
-00015b90: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00015ba0: 7445 7175 616c 2873 5b27 7374 6174 7573  tEqual(s['status
-00015bb0: 275d 2c20 2275 6e6b 6e6f 776e 2229 0a20  '], "unknown"). 
-00015bc0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00015bd0: 7274 4571 7561 6c28 735b 276d 6573 7361  rtEqual(s['messa
-00015be0: 6765 275d 2c20 2222 290a 2020 2020 2020  ge'], "").      
-00015bf0: 2020 2320 7461 6b65 6e20 6672 6f6d 2061    # taken from a
-00015c00: 6374 7561 6c20 4a75 6a75 206f 7574 7075  ctual Juju outpu
-00015c10: 740a 2020 2020 2020 2020 636f 6e74 656e  t.        conten
-00015c20: 7420 3d20 6465 6465 6e74 2822 2222 0a20  t = dedent(""". 
-00015c30: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00015c40: 2020 2020 2020 2020 2020 2020 2022 6170               "ap
-00015c50: 706c 6963 6174 696f 6e2d 7374 6174 7573  plication-status
-00015c60: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
-00015c70: 2020 2020 2020 2020 2022 6d65 7373 6167           "messag
-00015c80: 6522 3a20 2269 6e73 7461 6c6c 696e 6722  e": "installing"
-00015c90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00015ca0: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
-00015cb0: 226d 6169 6e74 656e 616e 6365 222c 0a20  "maintenance",. 
-00015cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015cd0: 2020 2022 7374 6174 7573 2d64 6174 6122     "status-data"
-00015ce0: 3a20 7b7d 2c0a 2020 2020 2020 2020 2020  : {},.          
-00015cf0: 2020 2020 2020 2020 2020 2275 6e69 7473            "units
-00015d00: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
-00015d10: 2020 2020 2020 2020 2020 2020 2022 756f               "uo
-00015d20: 2f30 223a 207b 0a20 2020 2020 2020 2020  /0": {.         
-00015d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d40: 2020 2022 6d65 7373 6167 6522 3a20 2222     "message": ""
-00015d50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00015d60: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-00015d70: 7461 7475 7322 3a20 2261 6374 6976 6522  tatus": "active"
-00015d80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00015d90: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-00015da0: 7461 7475 732d 6461 7461 223a 207b 7d0a  tatus-data": {}.
-00015db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015dc0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00015dd0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00015de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015df0: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
-00015e00: 2020 2020 2020 2020 2020 2020 2222 2229              """)
-00015e10: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
-00015e20: 7269 7074 2873 656c 662c 2027 7374 6174  ript(self, 'stat
-00015e30: 7573 2d67 6574 272c 2066 2265 6368 6f20  us-get', f"echo 
-00015e40: 277b 636f 6e74 656e 747d 2722 290a 2020  '{content}'").  
-00015e50: 2020 2020 2020 7320 3d20 7365 6c66 2e62        s = self.b
-00015e60: 6163 6b65 6e64 2e73 7461 7475 735f 6765  ackend.status_ge
-00015e70: 7428 6973 5f61 7070 3d54 7275 6529 0a20  t(is_app=True). 
-00015e80: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00015e90: 7274 4571 7561 6c28 735b 2773 7461 7475  rtEqual(s['statu
-00015ea0: 7327 5d2c 2022 6d61 696e 7465 6e61 6e63  s'], "maintenanc
-00015eb0: 6522 290a 2020 2020 2020 2020 7365 6c66  e").        self
-00015ec0: 2e61 7373 6572 7445 7175 616c 2873 5b27  .assertEqual(s['
-00015ed0: 6d65 7373 6167 6527 5d2c 2022 696e 7374  message'], "inst
-00015ee0: 616c 6c69 6e67 2229 0a20 2020 2020 2020  alling").       
-00015ef0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00015f00: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
-00015f10: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
-00015f20: 5472 7565 292c 205b 0a20 2020 2020 2020  True), [.       
-00015f30: 2020 2020 205b 2773 7461 7475 732d 6765       ['status-ge
-00015f40: 7427 2c20 272d 2d69 6e63 6c75 6465 2d64  t', '--include-d
-00015f50: 6174 6127 2c20 272d 2d61 7070 6c69 6361  ata', '--applica
-00015f60: 7469 6f6e 3d46 616c 7365 272c 2027 2d2d  tion=False', '--
-00015f70: 666f 726d 6174 3d6a 736f 6e27 5d2c 0a20  format=json'],. 
-00015f80: 2020 2020 2020 2020 2020 205b 2773 7461             ['sta
-00015f90: 7475 732d 6765 7427 2c20 272d 2d69 6e63  tus-get', '--inc
-00015fa0: 6c75 6465 2d64 6174 6127 2c20 272d 2d61  lude-data', '--a
-00015fb0: 7070 6c69 6361 7469 6f6e 3d54 7275 6527  pplication=True'
-00015fc0: 2c20 272d 2d66 6f72 6d61 743d 6a73 6f6e  , '--format=json
-00015fd0: 275d 2c0a 2020 2020 2020 2020 5d29 0a0a  '],.        ])..
-00015fe0: 2020 2020 6465 6620 7465 7374 5f73 7461      def test_sta
-00015ff0: 7475 735f 6973 5f61 7070 5f66 6f72 6365  tus_is_app_force
-00016000: 645f 6b77 6172 6773 2873 656c 6629 3a0a  d_kwargs(self):.
-00016010: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-00016020: 6970 7428 7365 6c66 2c20 2773 7461 7475  ipt(self, 'statu
-00016030: 732d 6765 7427 2c20 2765 7869 7420 3127  s-get', 'exit 1'
-00016040: 290a 2020 2020 2020 2020 6661 6b65 5f73  ).        fake_s
-00016050: 6372 6970 7428 7365 6c66 2c20 2773 7461  cript(self, 'sta
-00016060: 7475 732d 7365 7427 2c20 2765 7869 7420  tus-set', 'exit 
-00016070: 3127 290a 0a20 2020 2020 2020 2074 6573  1')..        tes
-00016080: 745f 6361 7365 7320 3d20 280a 2020 2020  t_cases = (.    
-00016090: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
-000160a0: 7365 6c66 2e62 6163 6b65 6e64 2e73 7461  self.backend.sta
-000160b0: 7475 735f 6765 7428 4661 6c73 6529 2c0a  tus_get(False),.
-000160c0: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
-000160d0: 6461 3a20 7365 6c66 2e62 6163 6b65 6e64  da: self.backend
-000160e0: 2e73 7461 7475 735f 6765 7428 5472 7565  .status_get(True
-000160f0: 292c 0a20 2020 2020 2020 2020 2020 206c  ),.            l
-00016100: 616d 6264 613a 2073 656c 662e 6261 636b  ambda: self.back
-00016110: 656e 642e 7374 6174 7573 5f73 6574 2827  end.status_set('
-00016120: 6163 7469 7665 272c 2027 272c 2046 616c  active', '', Fal
-00016130: 7365 292c 0a20 2020 2020 2020 2020 2020  se),.           
-00016140: 206c 616d 6264 613a 2073 656c 662e 6261   lambda: self.ba
-00016150: 636b 656e 642e 7374 6174 7573 5f73 6574  ckend.status_set
-00016160: 2827 6163 7469 7665 272c 2027 272c 2054  ('active', '', T
-00016170: 7275 6529 2c0a 2020 2020 2020 2020 290a  rue),.        ).
-00016180: 0a20 2020 2020 2020 2066 6f72 2063 6173  .        for cas
-00016190: 6520 696e 2074 6573 745f 6361 7365 733a  e in test_cases:
-000161a0: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-000161b0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-000161c0: 7365 7328 5479 7065 4572 726f 7229 3a0a  ses(TypeError):.
-000161d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000161e0: 6361 7365 2829 0a0a 2020 2020 6465 6620  case()..    def 
-000161f0: 7465 7374 5f6c 6f63 616c 5f73 6574 5f69  test_local_set_i
-00016200: 6e76 616c 6964 5f73 7461 7475 7328 7365  nvalid_status(se
-00016210: 6c66 293a 0a20 2020 2020 2020 2023 206a  lf):.        # j
-00016220: 756a 7520 7265 7475 726e 7320 6578 6974  uju returns exit
-00016230: 2063 6f64 6520 3120 6966 2079 6f75 2061   code 1 if you a
-00016240: 736b 2074 6f20 7365 7420 7374 6174 7573  sk to set status
-00016250: 2074 6f20 2775 6e6b 6e6f 776e 2720 6f72   to 'unknown' or
-00016260: 2027 6572 726f 7227 0a20 2020 2020 2020   'error'.       
-00016270: 206d 6574 6120 3d20 6f70 732e 4368 6172   meta = ops.Char
-00016280: 6d4d 6574 612e 6672 6f6d 5f79 616d 6c28  mMeta.from_yaml(
-00016290: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-000162a0: 6e61 6d65 3a20 6d79 6170 700a 2020 2020  name: myapp.    
-000162b0: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
-000162c0: 206d 6f64 656c 203d 206f 7073 2e4d 6f64   model = ops.Mod
-000162d0: 656c 286d 6574 612c 2073 656c 662e 6261  el(meta, self.ba
-000162e0: 636b 656e 6429 0a20 2020 2020 2020 2066  ckend).        f
-000162f0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-00016300: 2027 7374 6174 7573 2d73 6574 272c 2027   'status-set', '
-00016310: 6578 6974 2031 2729 0a20 2020 2020 2020  exit 1').       
-00016320: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-00016330: 662c 2027 6973 2d6c 6561 6465 7227 2c20  f, 'is-leader', 
-00016340: 2765 6368 6f20 7472 7565 2729 0a0a 2020  'echo true')..  
-00016350: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00016360: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
-00016370: 2e4d 6f64 656c 4572 726f 7229 3a0a 2020  .ModelError):.  
-00016380: 2020 2020 2020 2020 2020 6d6f 6465 6c2e            model.
-00016390: 756e 6974 2e73 7461 7475 7320 3d20 6f70  unit.status = op
-000163a0: 732e 556e 6b6e 6f77 6e53 7461 7475 7328  s.UnknownStatus(
-000163b0: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
-000163c0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-000163d0: 286f 7073 2e4d 6f64 656c 4572 726f 7229  (ops.ModelError)
-000163e0: 3a0a 2020 2020 2020 2020 2020 2020 6d6f  :.            mo
-000163f0: 6465 6c2e 756e 6974 2e73 7461 7475 7320  del.unit.status 
-00016400: 3d20 6f70 732e 4572 726f 7253 7461 7475  = ops.ErrorStatu
-00016410: 7328 290a 0a20 2020 2020 2020 2073 656c  s()..        sel
-00016420: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-00016430: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-00016440: 7365 6c66 2c20 5472 7565 292c 205b 0a20  self, True), [. 
-00016450: 2020 2020 2020 2020 2020 205b 2773 7461             ['sta
-00016460: 7475 732d 7365 7427 2c20 272d 2d61 7070  tus-set', '--app
-00016470: 6c69 6361 7469 6f6e 3d46 616c 7365 272c  lication=False',
-00016480: 2027 756e 6b6e 6f77 6e27 2c20 2727 5d2c   'unknown', ''],
-00016490: 0a20 2020 2020 2020 2020 2020 205b 2773  .            ['s
-000164a0: 7461 7475 732d 7365 7427 2c20 272d 2d61  tatus-set', '--a
-000164b0: 7070 6c69 6361 7469 6f6e 3d46 616c 7365  pplication=False
-000164c0: 272c 2027 6572 726f 7227 2c20 2727 5d2c  ', 'error', ''],
-000164d0: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
-000164e0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-000164f0: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
-00016500: 4d6f 6465 6c45 7272 6f72 293a 0a20 2020  ModelError):.   
-00016510: 2020 2020 2020 2020 206d 6f64 656c 2e61           model.a
-00016520: 7070 2e73 7461 7475 7320 3d20 6f70 732e  pp.status = ops.
-00016530: 556e 6b6e 6f77 6e53 7461 7475 7328 290a  UnknownStatus().
-00016540: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-00016550: 662e 6173 7365 7274 5261 6973 6573 286f  f.assertRaises(o
-00016560: 7073 2e4d 6f64 656c 4572 726f 7229 3a0a  ps.ModelError):.
-00016570: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-00016580: 6c2e 6170 702e 7374 6174 7573 203d 206f  l.app.status = o
-00016590: 7073 2e45 7272 6f72 5374 6174 7573 2829  ps.ErrorStatus()
-000165a0: 0a0a 2020 2020 2020 2020 2320 4120 6c65  ..        # A le
-000165b0: 6164 6572 7368 6970 2063 6865 636b 2069  adership check i
-000165c0: 7320 6e65 6564 6564 2066 6f72 2061 7070  s needed for app
-000165d0: 6c69 6361 7469 6f6e 2073 7461 7475 732e  lication status.
-000165e0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000165f0: 7365 7274 4571 7561 6c28 6661 6b65 5f73  sertEqual(fake_s
-00016600: 6372 6970 745f 6361 6c6c 7328 7365 6c66  cript_calls(self
-00016610: 2c20 5472 7565 292c 205b 0a20 2020 2020  , True), [.     
-00016620: 2020 2020 2020 205b 2769 732d 6c65 6164         ['is-lead
-00016630: 6572 272c 2027 2d2d 666f 726d 6174 3d6a  er', '--format=j
-00016640: 736f 6e27 5d2c 0a20 2020 2020 2020 2020  son'],.         
-00016650: 2020 205b 2773 7461 7475 732d 7365 7427     ['status-set'
-00016660: 2c20 272d 2d61 7070 6c69 6361 7469 6f6e  , '--application
-00016670: 3d54 7275 6527 2c20 2775 6e6b 6e6f 776e  =True', 'unknown
-00016680: 272c 2027 275d 2c0a 2020 2020 2020 2020  ', ''],.        
-00016690: 2020 2020 5b27 7374 6174 7573 2d73 6574      ['status-set
-000166a0: 272c 2027 2d2d 6170 706c 6963 6174 696f  ', '--applicatio
-000166b0: 6e3d 5472 7565 272c 2027 6572 726f 7227  n=True', 'error'
-000166c0: 2c20 2727 5d2c 0a20 2020 2020 2020 205d  , ''],.        ]
-000166d0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-000166e0: 6c6f 6361 6c5f 6765 745f 7374 6174 7573  local_get_status
-000166f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00016700: 666f 7220 6e61 6d65 2c20 6578 7065 6374  for name, expect
-00016710: 6564 5f63 6c73 2069 6e20 280a 2020 2020  ed_cls in (.    
-00016720: 2020 2020 2020 2020 2822 6163 7469 7665          ("active
-00016730: 222c 206f 7073 2e41 6374 6976 6553 7461  ", ops.ActiveSta
-00016740: 7475 7329 2c0a 2020 2020 2020 2020 2020  tus),.          
-00016750: 2020 2822 7761 6974 696e 6722 2c20 6f70    ("waiting", op
-00016760: 732e 5761 6974 696e 6753 7461 7475 7329  s.WaitingStatus)
-00016770: 2c0a 2020 2020 2020 2020 2020 2020 2822  ,.            ("
-00016780: 626c 6f63 6b65 6422 2c20 6f70 732e 426c  blocked", ops.Bl
-00016790: 6f63 6b65 6453 7461 7475 7329 2c0a 2020  ockedStatus),.  
-000167a0: 2020 2020 2020 2020 2020 2822 6d61 696e            ("main
-000167b0: 7465 6e61 6e63 6522 2c20 6f70 732e 4d61  tenance", ops.Ma
-000167c0: 696e 7465 6e61 6e63 6553 7461 7475 7329  intenanceStatus)
-000167d0: 2c0a 2020 2020 2020 2020 2020 2020 2822  ,.            ("
-000167e0: 6572 726f 7222 2c20 6f70 732e 4572 726f  error", ops.Erro
-000167f0: 7253 7461 7475 7329 2c0a 2020 2020 2020  rStatus),.      
-00016800: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-00016810: 206d 6574 6120 3d20 6f70 732e 4368 6172   meta = ops.Char
-00016820: 6d4d 6574 612e 6672 6f6d 5f79 616d 6c28  mMeta.from_yaml(
-00016830: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-00016840: 2020 2020 6e61 6d65 3a20 6d79 6170 700a      name: myapp.
-00016850: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-00016860: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
-00016870: 656c 203d 206f 7073 2e4d 6f64 656c 286d  el = ops.Model(m
-00016880: 6574 612c 2073 656c 662e 6261 636b 656e  eta, self.backen
-00016890: 6429 0a0a 2020 2020 2020 2020 2020 2020  d)..            
-000168a0: 7769 7468 2073 656c 662e 7375 6254 6573  with self.subTes
-000168b0: 7428 6e61 6d65 293a 0a20 2020 2020 2020  t(name):.       
-000168c0: 2020 2020 2020 2020 2063 6f6e 7465 6e74           content
-000168d0: 203d 206a 736f 6e2e 6475 6d70 7328 7b0a   = json.dumps({.
-000168e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168f0: 2020 2020 226d 6573 7361 6765 223a 2022      "message": "
-00016900: 666f 6f22 2c0a 2020 2020 2020 2020 2020  foo",.          
-00016910: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
-00016920: 7322 3a20 6e61 6d65 2c0a 2020 2020 2020  s": name,.      
-00016930: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-00016940: 7461 7475 732d 6461 7461 223a 207b 7d2c  tatus-data": {},
-00016950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016960: 207d 290a 2020 2020 2020 2020 2020 2020   }).            
-00016970: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-00016980: 7365 6c66 2c20 2773 7461 7475 732d 6765  self, 'status-ge
-00016990: 7427 2c20 6622 6563 686f 2027 7b63 6f6e  t', f"echo '{con
-000169a0: 7465 6e74 7d27 2229 0a0a 2020 2020 2020  tent}'")..      
-000169b0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-000169c0: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
-000169d0: 6d6f 6465 6c2e 756e 6974 2e73 7461 7475  model.unit.statu
-000169e0: 732c 2065 7870 6563 7465 645f 636c 7329  s, expected_cls)
-000169f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016a00: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00016a10: 6c28 6d6f 6465 6c2e 756e 6974 2e73 7461  l(model.unit.sta
-00016a20: 7475 732e 6e61 6d65 2c20 6e61 6d65 290a  tus.name, name).
-00016a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a40: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00016a50: 286d 6f64 656c 2e75 6e69 742e 7374 6174  (model.unit.stat
-00016a60: 7573 2e6d 6573 7361 6765 2c20 2266 6f6f  us.message, "foo
-00016a70: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
-00016a80: 2020 2020 636f 6e74 656e 7420 3d20 6a73      content = js
-00016a90: 6f6e 2e64 756d 7073 287b 0a20 2020 2020  on.dumps({.     
-00016aa0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00016ab0: 6170 706c 6963 6174 696f 6e2d 7374 6174  application-stat
-00016ac0: 7573 223a 207b 0a20 2020 2020 2020 2020  us": {.         
-00016ad0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00016ae0: 6d65 7373 6167 6522 3a20 2262 6172 222c  message": "bar",
-00016af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016b00: 2020 2020 2020 2020 2022 7374 6174 7573           "status
-00016b10: 223a 206e 616d 652c 0a20 2020 2020 2020  ": name,.       
-00016b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b30: 2022 7374 6174 7573 2d64 6174 6122 3a20   "status-data": 
-00016b40: 7b7d 2c0a 2020 2020 2020 2020 2020 2020  {},.            
-00016b50: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00016b60: 2020 2020 2020 2020 2020 7d29 0a20 2020            }).   
-00016b70: 2020 2020 2020 2020 2020 2020 2066 616b               fak
-00016b80: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-00016b90: 7374 6174 7573 2d67 6574 272c 2066 2265  status-get', f"e
-00016ba0: 6368 6f20 277b 636f 6e74 656e 747d 2722  cho '{content}'"
-00016bb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00016bc0: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-00016bd0: 6c66 2c20 2769 732d 6c65 6164 6572 272c  lf, 'is-leader',
-00016be0: 2027 6563 686f 2074 7275 6527 290a 0a20   'echo true').. 
-00016bf0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00016c00: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
-00016c10: 616e 6365 286d 6f64 656c 2e61 7070 2e73  ance(model.app.s
-00016c20: 7461 7475 732c 2065 7870 6563 7465 645f  tatus, expected_
-00016c30: 636c 7329 0a20 2020 2020 2020 2020 2020  cls).           
-00016c40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00016c50: 4571 7561 6c28 6d6f 6465 6c2e 6170 702e  Equal(model.app.
-00016c60: 7374 6174 7573 2e6e 616d 652c 206e 616d  status.name, nam
-00016c70: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00016c80: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00016c90: 7561 6c28 6d6f 6465 6c2e 6170 702e 7374  ual(model.app.st
-00016ca0: 6174 7573 2e6d 6573 7361 6765 2c20 2262  atus.message, "b
-00016cb0: 6172 2229 0a0a 2020 2020 6465 6620 7465  ar")..    def te
-00016cc0: 7374 5f73 7461 7475 735f 7365 745f 6973  st_status_set_is
-00016cd0: 5f61 7070 5f6e 6f74 5f62 6f6f 6c5f 7261  _app_not_bool_ra
-00016ce0: 6973 6573 2873 656c 6629 3a0a 2020 2020  ises(self):.    
-00016cf0: 2020 2020 666f 7220 6973 5f61 7070 5f76      for is_app_v
-00016d00: 2069 6e20 5b4e 6f6e 652c 2031 2c20 322e   in [None, 1, 2.
-00016d10: 302c 2027 6127 2c20 6227 6265 6566 272c  0, 'a', b'beef',
-00016d20: 206f 626a 6563 745d 3a0a 2020 2020 2020   object]:.      
-00016d30: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00016d40: 6173 7365 7274 5261 6973 6573 2854 7970  assertRaises(Typ
-00016d50: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-00016d60: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
-00016d70: 636b 656e 642e 7374 6174 7573 5f73 6574  ckend.status_set
-00016d80: 286f 7073 2e41 6374 6976 6553 7461 7475  (ops.ActiveStatu
-00016d90: 732c 2069 735f 6170 703d 6973 5f61 7070  s, is_app=is_app
-00016da0: 5f76 290a 0a20 2020 2064 6566 2074 6573  _v)..    def tes
-00016db0: 745f 7374 6f72 6167 655f 746f 6f6c 5f65  t_storage_tool_e
-00016dc0: 7272 6f72 7328 7365 6c66 293a 0a20 2020  rrors(self):.   
-00016dd0: 2020 2020 2074 6573 745f 6361 7365 7320       test_cases 
-00016de0: 3d20 5b28 0a20 2020 2020 2020 2020 2020  = [(.           
-00016df0: 206c 616d 6264 613a 2066 616b 655f 7363   lambda: fake_sc
-00016e00: 7269 7074 2873 656c 662c 2027 7374 6f72  ript(self, 'stor
-00016e10: 6167 652d 6c69 7374 272c 2027 6563 686f  age-list', 'echo
-00016e20: 2066 6f6f 6572 726f 7220 3e26 3220 3b20   fooerror >&2 ; 
-00016e30: 6578 6974 2031 2729 2c0a 2020 2020 2020  exit 1'),.      
-00016e40: 2020 2020 2020 6c61 6d62 6461 3a20 7365        lambda: se
-00016e50: 6c66 2e62 6163 6b65 6e64 2e73 746f 7261  lf.backend.stora
-00016e60: 6765 5f6c 6973 7428 2766 6f6f 6261 7227  ge_list('foobar'
-00016e70: 292c 0a20 2020 2020 2020 2020 2020 206f  ),.            o
-00016e80: 7073 2e4d 6f64 656c 4572 726f 722c 0a20  ps.ModelError,. 
-00016e90: 2020 2020 2020 2020 2020 205b 5b27 7374             [['st
-00016ea0: 6f72 6167 652d 6c69 7374 272c 2027 666f  orage-list', 'fo
-00016eb0: 6f62 6172 272c 2027 2d2d 666f 726d 6174  obar', '--format
-00016ec0: 3d6a 736f 6e27 5d5d 2c0a 2020 2020 2020  =json']],.      
-00016ed0: 2020 292c 2028 0a20 2020 2020 2020 2020    ), (.         
-00016ee0: 2020 206c 616d 6264 613a 2066 616b 655f     lambda: fake_
-00016ef0: 7363 7269 7074 2873 656c 662c 2027 7374  script(self, 'st
-00016f00: 6f72 6167 652d 6765 7427 2c20 2765 6368  orage-get', 'ech
-00016f10: 6f20 666f 6f65 7272 6f72 203e 2632 203b  o fooerror >&2 ;
-00016f20: 2065 7869 7420 3127 292c 0a20 2020 2020   exit 1'),.     
-00016f30: 2020 2020 2020 206c 616d 6264 613a 2073         lambda: s
-00016f40: 656c 662e 6261 636b 656e 642e 7374 6f72  elf.backend.stor
-00016f50: 6167 655f 6765 7428 2766 6f6f 6261 7227  age_get('foobar'
-00016f60: 2c20 2773 6f6d 6561 7474 7227 292c 0a20  , 'someattr'),. 
-00016f70: 2020 2020 2020 2020 2020 206f 7073 2e4d             ops.M
-00016f80: 6f64 656c 4572 726f 722c 0a20 2020 2020  odelError,.     
-00016f90: 2020 2020 2020 205b 5b27 7374 6f72 6167         [['storag
-00016fa0: 652d 6765 7427 2c20 272d 7327 2c20 2766  e-get', '-s', 'f
-00016fb0: 6f6f 6261 7227 2c20 2773 6f6d 6561 7474  oobar', 'someatt
-00016fc0: 7227 2c20 272d 2d66 6f72 6d61 743d 6a73  r', '--format=js
-00016fd0: 6f6e 275d 5d2c 0a20 2020 2020 2020 2029  on']],.        )
-00016fe0: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-00016ff0: 6c61 6d62 6461 3a20 6661 6b65 5f73 6372  lambda: fake_scr
-00017000: 6970 7428 7365 6c66 2c20 2773 746f 7261  ipt(self, 'stora
-00017010: 6765 2d61 6464 272c 2027 6563 686f 2066  ge-add', 'echo f
-00017020: 6f6f 6572 726f 7220 3e26 3220 3b20 6578  ooerror >&2 ; ex
-00017030: 6974 2031 2729 2c0a 2020 2020 2020 2020  it 1'),.        
-00017040: 2020 2020 6c61 6d62 6461 3a20 7365 6c66      lambda: self
-00017050: 2e62 6163 6b65 6e64 2e73 746f 7261 6765  .backend.storage
-00017060: 5f61 6464 2827 666f 6f62 6172 272c 2063  _add('foobar', c
-00017070: 6f75 6e74 3d32 292c 0a20 2020 2020 2020  ount=2),.       
-00017080: 2020 2020 206f 7073 2e4d 6f64 656c 4572       ops.ModelEr
-00017090: 726f 722c 0a20 2020 2020 2020 2020 2020  ror,.           
-000170a0: 205b 5b27 7374 6f72 6167 652d 6164 6427   [['storage-add'
-000170b0: 2c20 2766 6f6f 6261 723d 3227 5d5d 2c0a  , 'foobar=2']],.
-000170c0: 2020 2020 2020 2020 292c 2028 0a20 2020          ), (.   
-000170d0: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
-000170e0: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-000170f0: 662c 2027 7374 6f72 6167 652d 6164 6427  f, 'storage-add'
-00017100: 2c20 2765 6368 6f20 666f 6f65 7272 6f72  , 'echo fooerror
-00017110: 203e 2632 203b 2065 7869 7420 3127 292c   >&2 ; exit 1'),
-00017120: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
-00017130: 6264 613a 2073 656c 662e 6261 636b 656e  bda: self.backen
-00017140: 642e 7374 6f72 6167 655f 6164 6428 2766  d.storage_add('f
-00017150: 6f6f 6261 7227 2c20 636f 756e 743d 6f62  oobar', count=ob
-00017160: 6a65 6374 292c 0a20 2020 2020 2020 2020  ject),.         
-00017170: 2020 2054 7970 6545 7272 6f72 2c0a 2020     TypeError,.  
-00017180: 2020 2020 2020 2020 2020 5b5d 2c0a 2020            [],.  
-00017190: 2020 2020 2020 292c 2028 0a20 2020 2020        ), (.     
-000171a0: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
-000171b0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-000171c0: 2027 7374 6f72 6167 652d 6164 6427 2c20   'storage-add', 
-000171d0: 2765 6368 6f20 666f 6f65 7272 6f72 203e  'echo fooerror >
-000171e0: 2632 203b 2065 7869 7420 3127 292c 0a20  &2 ; exit 1'),. 
-000171f0: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
-00017200: 613a 2073 656c 662e 6261 636b 656e 642e  a: self.backend.
-00017210: 7374 6f72 6167 655f 6164 6428 2766 6f6f  storage_add('foo
-00017220: 6261 7227 2c20 636f 756e 743d 5472 7565  bar', count=True
-00017230: 292c 0a20 2020 2020 2020 2020 2020 2054  ),.            T
-00017240: 7970 6545 7272 6f72 2c0a 2020 2020 2020  ypeError,.      
-00017250: 2020 2020 2020 5b5d 2c0a 2020 2020 2020        [],.      
-00017260: 2020 295d 0a20 2020 2020 2020 2066 6f72    )].        for
-00017270: 2064 6f5f 6661 6b65 2c20 7275 6e2c 2065   do_fake, run, e
-00017280: 7863 6570 7469 6f6e 2c20 6361 6c6c 7320  xception, calls 
-00017290: 696e 2074 6573 745f 6361 7365 733a 0a20  in test_cases:. 
-000172a0: 2020 2020 2020 2020 2020 2064 6f5f 6661             do_fa
-000172b0: 6b65 2829 0a20 2020 2020 2020 2020 2020  ke().           
-000172c0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-000172d0: 7452 6169 7365 7328 6578 6365 7074 696f  tRaises(exceptio
-000172e0: 6e29 3a0a 2020 2020 2020 2020 2020 2020  n):.            
-000172f0: 2020 2020 7275 6e28 290a 2020 2020 2020      run().      
-00017300: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00017310: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
-00017320: 7074 5f63 616c 6c73 2873 656c 662c 2063  pt_calls(self, c
-00017330: 6c65 6172 3d54 7275 6529 2c20 6361 6c6c  lear=True), call
-00017340: 7329 0a0a 2020 2020 6465 6620 7465 7374  s)..    def test
-00017350: 5f6e 6574 776f 726b 5f67 6574 2873 656c  _network_get(sel
-00017360: 6629 3a0a 2020 2020 2020 2020 6e65 7477  f):.        netw
-00017370: 6f72 6b5f 6765 745f 6f75 7420 3d20 2727  ork_get_out = ''
-00017380: 277b 0a20 2022 6269 6e64 2d61 6464 7265  '{.  "bind-addre
-00017390: 7373 6573 223a 205b 0a20 2020 207b 0a20  sses": [.    {. 
-000173a0: 2020 2020 2022 6d61 632d 6164 6472 6573       "mac-addres
-000173b0: 7322 3a20 2222 2c0a 2020 2020 2020 2269  s": "",.      "i
-000173c0: 6e74 6572 6661 6365 2d6e 616d 6522 3a20  nterface-name": 
-000173d0: 2222 2c0a 2020 2020 2020 2261 6464 7265  "",.      "addre
-000173e0: 7373 6573 223a 205b 0a20 2020 2020 2020  sses": [.       
-000173f0: 207b 0a20 2020 2020 2020 2020 2022 686f   {.          "ho
-00017400: 7374 6e61 6d65 223a 2022 222c 0a20 2020  stname": "",.   
-00017410: 2020 2020 2020 2022 7661 6c75 6522 3a20         "value": 
-00017420: 2231 3932 2e30 2e32 2e32 222c 0a20 2020  "192.0.2.2",.   
-00017430: 2020 2020 2020 2022 6369 6472 223a 2022         "cidr": "
-00017440: 220a 2020 2020 2020 2020 7d0a 2020 2020  ".        }.    
-00017450: 2020 5d0a 2020 2020 7d0a 2020 5d2c 0a20    ].    }.  ],. 
-00017460: 2022 6567 7265 7373 2d73 7562 6e65 7473   "egress-subnets
-00017470: 223a 205b 0a20 2020 2022 3139 322e 302e  ": [.    "192.0.
-00017480: 322e 322f 3332 220a 2020 5d2c 0a20 2022  2.2/32".  ],.  "
-00017490: 696e 6772 6573 732d 6164 6472 6573 7365  ingress-addresse
-000174a0: 7322 3a20 5b0a 2020 2020 2231 3932 2e30  s": [.    "192.0
-000174b0: 2e32 2e32 220a 2020 5d0a 7d27 2727 0a20  .2.2".  ].}'''. 
-000174c0: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-000174d0: 7074 2873 656c 662c 2027 6e65 7477 6f72  pt(self, 'networ
-000174e0: 6b2d 6765 7427 2c0a 2020 2020 2020 2020  k-get',.        
-000174f0: 2020 2020 2020 2020 2020 2020 6627 2727              f'''
-00017500: 5b20 2224 3122 203d 2064 6561 6462 6565  [ "$1" = deadbee
-00017510: 6620 5d20 2626 2065 6368 6f20 277b 6e65  f ] && echo '{ne
-00017520: 7477 6f72 6b5f 6765 745f 6f75 747d 2720  twork_get_out}' 
-00017530: 7c7c 2065 7869 7420 3127 2727 290a 2020  || exit 1''').  
-00017540: 2020 2020 2020 6e65 7477 6f72 6b5f 696e        network_in
-00017550: 666f 203d 2073 656c 662e 6261 636b 656e  fo = self.backen
-00017560: 642e 6e65 7477 6f72 6b5f 6765 7428 2764  d.network_get('d
-00017570: 6561 6462 6565 6627 290a 2020 2020 2020  eadbeef').      
-00017580: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00017590: 616c 286e 6574 776f 726b 5f69 6e66 6f2c  al(network_info,
-000175a0: 206a 736f 6e2e 6c6f 6164 7328 6e65 7477   json.loads(netw
-000175b0: 6f72 6b5f 6765 745f 6f75 7429 290a 2020  ork_get_out)).  
-000175c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000175d0: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
-000175e0: 7074 5f63 616c 6c73 2873 656c 662c 2063  pt_calls(self, c
-000175f0: 6c65 6172 3d54 7275 6529 2c0a 2020 2020  lear=True),.    
-00017600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017610: 2020 2020 205b 5b27 6e65 7477 6f72 6b2d       [['network-
-00017620: 6765 7427 2c20 2764 6561 6462 6565 6627  get', 'deadbeef'
-00017630: 2c20 272d 2d66 6f72 6d61 743d 6a73 6f6e  , '--format=json
-00017640: 275d 5d29 0a0a 2020 2020 2020 2020 6e65  ']])..        ne
-00017650: 7477 6f72 6b5f 696e 666f 203d 2073 656c  twork_info = sel
-00017660: 662e 6261 636b 656e 642e 6e65 7477 6f72  f.backend.networ
-00017670: 6b5f 6765 7428 2764 6561 6462 6565 6627  k_get('deadbeef'
-00017680: 2c20 3129 0a20 2020 2020 2020 2073 656c  , 1).        sel
-00017690: 662e 6173 7365 7274 4571 7561 6c28 6e65  f.assertEqual(ne
-000176a0: 7477 6f72 6b5f 696e 666f 2c20 6a73 6f6e  twork_info, json
-000176b0: 2e6c 6f61 6473 286e 6574 776f 726b 5f67  .loads(network_g
-000176c0: 6574 5f6f 7574 2929 0a20 2020 2020 2020  et_out)).       
-000176d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000176e0: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
-000176f0: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
-00017700: 5472 7565 292c 0a20 2020 2020 2020 2020  True),.         
-00017710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017720: 5b5b 276e 6574 776f 726b 2d67 6574 272c  [['network-get',
-00017730: 2027 6465 6164 6265 6566 272c 2027 2d72   'deadbeef', '-r
-00017740: 272c 2027 3127 2c20 272d 2d66 6f72 6d61  ', '1', '--forma
-00017750: 743d 6a73 6f6e 275d 5d29 0a0a 2020 2020  t=json']])..    
-00017760: 6465 6620 7465 7374 5f6e 6574 776f 726b  def test_network
-00017770: 5f67 6574 5f65 7272 6f72 7328 7365 6c66  _get_errors(self
-00017780: 293a 0a20 2020 2020 2020 2065 7272 5f6e  ):.        err_n
-00017790: 6f5f 656e 6470 6f69 6e74 203d 2027 4552  o_endpoint = 'ER
-000177a0: 524f 5220 6e6f 206e 6574 776f 726b 2063  ROR no network c
-000177b0: 6f6e 6669 6720 666f 756e 6420 666f 7220  onfig found for 
-000177c0: 6269 6e64 696e 6720 2224 3222 270a 2020  binding "$2"'.  
-000177d0: 2020 2020 2020 6572 725f 6e6f 5f72 656c        err_no_rel
-000177e0: 203d 2027 4552 524f 5220 696e 7661 6c69   = 'ERROR invali
-000177f0: 6420 7661 6c75 6520 2224 3322 2066 6f72  d value "$3" for
-00017800: 206f 7074 696f 6e20 2d72 3a20 7265 6c61   option -r: rela
-00017810: 7469 6f6e 206e 6f74 2066 6f75 6e64 270a  tion not found'.
-00017820: 0a20 2020 2020 2020 2074 6573 745f 6361  .        test_ca
-00017830: 7365 7320 3d20 5b28 0a20 2020 2020 2020  ses = [(.       
-00017840: 2020 2020 206c 616d 6264 613a 2066 616b       lambda: fak
-00017850: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-00017860: 6e65 7477 6f72 6b2d 6765 7427 2c0a 2020  network-get',.  
-00017870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017880: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00017890: 6563 686f 207b 6572 725f 6e6f 5f65 6e64  echo {err_no_end
-000178a0: 706f 696e 747d 203e 2632 203b 2065 7869  point} >&2 ; exi
-000178b0: 7420 3127 292c 0a20 2020 2020 2020 2020  t 1'),.         
-000178c0: 2020 206c 616d 6264 613a 2073 656c 662e     lambda: self.
-000178d0: 6261 636b 656e 642e 6e65 7477 6f72 6b5f  backend.network_
-000178e0: 6765 7428 2264 6561 6462 6565 6622 292c  get("deadbeef"),
-000178f0: 0a20 2020 2020 2020 2020 2020 206f 7073  .            ops
-00017900: 2e4d 6f64 656c 4572 726f 722c 0a20 2020  .ModelError,.   
-00017910: 2020 2020 2020 2020 205b 5b27 6e65 7477           [['netw
-00017920: 6f72 6b2d 6765 7427 2c20 2764 6561 6462  ork-get', 'deadb
-00017930: 6565 6627 2c20 272d 2d66 6f72 6d61 743d  eef', '--format=
-00017940: 6a73 6f6e 275d 5d2c 0a20 2020 2020 2020  json']],.       
-00017950: 2029 2c20 280a 2020 2020 2020 2020 2020   ), (.          
-00017960: 2020 6c61 6d62 6461 3a20 6661 6b65 5f73    lambda: fake_s
-00017970: 6372 6970 7428 7365 6c66 2c20 276e 6574  cript(self, 'net
-00017980: 776f 726b 2d67 6574 272c 2066 2765 6368  work-get', f'ech
-00017990: 6f20 7b65 7272 5f6e 6f5f 7265 6c7d 203e  o {err_no_rel} >
-000179a0: 2632 203b 2065 7869 7420 3227 292c 0a20  &2 ; exit 2'),. 
-000179b0: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
-000179c0: 613a 2073 656c 662e 6261 636b 656e 642e  a: self.backend.
-000179d0: 6e65 7477 6f72 6b5f 6765 7428 2264 6561  network_get("dea
-000179e0: 6462 6565 6622 2c20 3329 2c0a 2020 2020  dbeef", 3),.    
-000179f0: 2020 2020 2020 2020 6f70 732e 5265 6c61          ops.Rela
-00017a00: 7469 6f6e 4e6f 7446 6f75 6e64 4572 726f  tionNotFoundErro
-00017a10: 722c 0a20 2020 2020 2020 2020 2020 205b  r,.            [
-00017a20: 5b27 6e65 7477 6f72 6b2d 6765 7427 2c20  ['network-get', 
-00017a30: 2764 6561 6462 6565 6627 2c20 272d 7227  'deadbeef', '-r'
-00017a40: 2c20 2733 272c 2027 2d2d 666f 726d 6174  , '3', '--format
-00017a50: 3d6a 736f 6e27 5d5d 2c0a 2020 2020 2020  =json']],.      
-00017a60: 2020 295d 0a20 2020 2020 2020 2066 6f72    )].        for
-00017a70: 2064 6f5f 6661 6b65 2c20 7275 6e2c 2065   do_fake, run, e
-00017a80: 7863 6570 7469 6f6e 2c20 6361 6c6c 7320  xception, calls 
-00017a90: 696e 2074 6573 745f 6361 7365 733a 0a20  in test_cases:. 
-00017aa0: 2020 2020 2020 2020 2020 2064 6f5f 6661             do_fa
-00017ab0: 6b65 2829 0a20 2020 2020 2020 2020 2020  ke().           
-00017ac0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00017ad0: 7452 6169 7365 7328 6578 6365 7074 696f  tRaises(exceptio
-00017ae0: 6e29 3a0a 2020 2020 2020 2020 2020 2020  n):.            
-00017af0: 2020 2020 7275 6e28 290a 2020 2020 2020      run().      
-00017b00: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00017b10: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
-00017b20: 7074 5f63 616c 6c73 2873 656c 662c 2063  pt_calls(self, c
-00017b30: 6c65 6172 3d54 7275 6529 2c20 6361 6c6c  lear=True), call
-00017b40: 7329 0a0a 2020 2020 6465 6620 7465 7374  s)..    def test
-00017b50: 5f61 6374 696f 6e5f 6765 745f 6572 726f  _action_get_erro
-00017b60: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
-00017b70: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-00017b80: 662c 2027 6163 7469 6f6e 2d67 6574 272c  f, 'action-get',
-00017b90: 2027 2729 0a20 2020 2020 2020 2066 616b   '').        fak
-00017ba0: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-00017bb0: 6163 7469 6f6e 2d67 6574 272c 2027 6563  action-get', 'ec
-00017bc0: 686f 2066 6f6f 6572 726f 7220 3e26 3220  ho fooerror >&2 
-00017bd0: 3b20 6578 6974 2031 2729 0a20 2020 2020  ; exit 1').     
-00017be0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-00017bf0: 6572 7452 6169 7365 7328 6f70 732e 4d6f  ertRaises(ops.Mo
-00017c00: 6465 6c45 7272 6f72 293a 0a20 2020 2020  delError):.     
-00017c10: 2020 2020 2020 2073 656c 662e 6261 636b         self.back
-00017c20: 656e 642e 6163 7469 6f6e 5f67 6574 2829  end.action_get()
-00017c30: 0a20 2020 2020 2020 2063 616c 6c73 203d  .        calls =
-00017c40: 205b 5b27 6163 7469 6f6e 2d67 6574 272c   [['action-get',
-00017c50: 2027 2d2d 666f 726d 6174 3d6a 736f 6e27   '--format=json'
-00017c60: 5d5d 0a20 2020 2020 2020 2073 656c 662e  ]].        self.
-00017c70: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
-00017c80: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
-00017c90: 6c66 2c20 636c 6561 723d 5472 7565 292c  lf, clear=True),
-00017ca0: 2063 616c 6c73 290a 0a20 2020 2064 6566   calls)..    def
-00017cb0: 2074 6573 745f 6163 7469 6f6e 5f73 6574   test_action_set
-00017cc0: 5f65 7272 6f72 2873 656c 6629 3a0a 2020  _error(self):.  
-00017cd0: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
-00017ce0: 7428 7365 6c66 2c20 2761 6374 696f 6e2d  t(self, 'action-
-00017cf0: 6765 7427 2c20 2727 290a 2020 2020 2020  get', '').      
-00017d00: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-00017d10: 6c66 2c20 2761 6374 696f 6e2d 7365 7427  lf, 'action-set'
-00017d20: 2c20 2765 6368 6f20 666f 6f65 7272 6f72  , 'echo fooerror
-00017d30: 203e 2632 203b 2065 7869 7420 3127 290a   >&2 ; exit 1').
-00017d40: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-00017d50: 662e 6173 7365 7274 5261 6973 6573 286f  f.assertRaises(o
-00017d60: 7073 2e4d 6f64 656c 4572 726f 7229 3a0a  ps.ModelError):.
-00017d70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00017d80: 2e62 6163 6b65 6e64 2e61 6374 696f 6e5f  .backend.action_
-00017d90: 7365 7428 4f72 6465 7265 6444 6963 7428  set(OrderedDict(
-00017da0: 5b28 2766 6f6f 272c 2027 6261 7227 292c  [('foo', 'bar'),
-00017db0: 2028 2764 6561 6427 2c20 2762 6565 6620   ('dead', 'beef 
-00017dc0: 6361 6665 2729 5d29 290a 2020 2020 2020  cafe')])).      
-00017dd0: 2020 7365 6c66 2e61 7373 6572 7443 6f75    self.assertCou
-00017de0: 6e74 4571 7561 6c28 0a20 2020 2020 2020  ntEqual(.       
-00017df0: 2020 2020 205b 2261 6374 696f 6e2d 7365       ["action-se
-00017e00: 7422 2c20 2264 6561 643d 6265 6566 2063  t", "dead=beef c
-00017e10: 6166 6522 2c20 2266 6f6f 3d62 6172 225d  afe", "foo=bar"]
-00017e20: 2c20 6661 6b65 5f73 6372 6970 745f 6361  , fake_script_ca
-00017e30: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
-00017e40: 5472 7565 295b 305d 290a 0a20 2020 2064  True)[0])..    d
-00017e50: 6566 2074 6573 745f 6163 7469 6f6e 5f6c  ef test_action_l
-00017e60: 6f67 5f65 7272 6f72 2873 656c 6629 3a0a  og_error(self):.
-00017e70: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-00017e80: 6970 7428 7365 6c66 2c20 2761 6374 696f  ipt(self, 'actio
-00017e90: 6e2d 6765 7427 2c20 2727 290a 2020 2020  n-get', '').    
-00017ea0: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-00017eb0: 7365 6c66 2c20 2761 6374 696f 6e2d 6c6f  self, 'action-lo
-00017ec0: 6727 2c20 2765 6368 6f20 666f 6f65 7272  g', 'echo fooerr
-00017ed0: 6f72 203e 2632 203b 2065 7869 7420 3127  or >&2 ; exit 1'
-00017ee0: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
-00017ef0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-00017f00: 286f 7073 2e4d 6f64 656c 4572 726f 7229  (ops.ModelError)
-00017f10: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00017f20: 6c66 2e62 6163 6b65 6e64 2e61 6374 696f  lf.backend.actio
-00017f30: 6e5f 6c6f 6728 276c 6f67 2d6d 6573 7361  n_log('log-messa
-00017f40: 6765 2729 0a20 2020 2020 2020 2063 616c  ge').        cal
-00017f50: 6c73 203d 205b 5b22 6163 7469 6f6e 2d6c  ls = [["action-l
-00017f60: 6f67 222c 2022 6c6f 672d 6d65 7373 6167  og", "log-messag
-00017f70: 6522 5d5d 0a20 2020 2020 2020 2073 656c  e"]].        sel
-00017f80: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-00017f90: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-00017fa0: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
-00017fb0: 292c 2063 616c 6c73 290a 0a20 2020 2064  ), calls)..    d
-00017fc0: 6566 2074 6573 745f 6163 7469 6f6e 5f67  ef test_action_g
-00017fd0: 6574 2873 656c 6629 3a0a 2020 2020 2020  et(self):.      
-00017fe0: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-00017ff0: 6c66 2c20 2761 6374 696f 6e2d 6765 7427  lf, 'action-get'
-00018000: 2c20 2222 2265 6368 6f20 277b 2266 6f6f  , """echo '{"foo
-00018010: 2d6e 616d 6522 3a20 2262 6172 222c 2022  -name": "bar", "
-00018020: 7369 6c65 6e74 223a 2066 616c 7365 7d27  silent": false}'
-00018030: 2222 2229 0a20 2020 2020 2020 2070 6172  """).        par
-00018040: 616d 7320 3d20 7365 6c66 2e62 6163 6b65  ams = self.backe
-00018050: 6e64 2e61 6374 696f 6e5f 6765 7428 290a  nd.action_get().
-00018060: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00018070: 6572 7445 7175 616c 2870 6172 616d 735b  ertEqual(params[
-00018080: 2766 6f6f 2d6e 616d 6527 5d2c 2027 6261  'foo-name'], 'ba
-00018090: 7227 290a 2020 2020 2020 2020 7365 6c66  r').        self
-000180a0: 2e61 7373 6572 7445 7175 616c 2870 6172  .assertEqual(par
-000180b0: 616d 735b 2773 696c 656e 7427 5d2c 2046  ams['silent'], F
-000180c0: 616c 7365 290a 2020 2020 2020 2020 7365  alse).        se
-000180d0: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
-000180e0: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-000180f0: 2873 656c 6629 2c20 5b5b 2761 6374 696f  (self), [['actio
-00018100: 6e2d 6765 7427 2c20 272d 2d66 6f72 6d61  n-get', '--forma
-00018110: 743d 6a73 6f6e 275d 5d29 0a0a 2020 2020  t=json']])..    
-00018120: 6465 6620 7465 7374 5f61 6374 696f 6e5f  def test_action_
-00018130: 7365 7428 7365 6c66 293a 0a20 2020 2020  set(self):.     
-00018140: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-00018150: 656c 662c 2027 6163 7469 6f6e 2d67 6574  elf, 'action-get
-00018160: 272c 2027 6578 6974 2031 2729 0a20 2020  ', 'exit 1').   
-00018170: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-00018180: 2873 656c 662c 2027 6163 7469 6f6e 2d73  (self, 'action-s
-00018190: 6574 272c 2027 6578 6974 2030 2729 0a20  et', 'exit 0'). 
-000181a0: 2020 2020 2020 2073 656c 662e 6261 636b         self.back
-000181b0: 656e 642e 6163 7469 6f6e 5f73 6574 287b  end.action_set({
-000181c0: 2778 273a 2027 6465 6164 2062 6565 6627  'x': 'dead beef'
-000181d0: 2c20 2779 273a 2031 7d29 0a20 2020 2020  , 'y': 1}).     
-000181e0: 2020 2073 656c 662e 6173 7365 7274 436f     self.assertCo
-000181f0: 756e 7445 7175 616c 285b 2761 6374 696f  untEqual(['actio
-00018200: 6e2d 7365 7427 2c20 2778 3d64 6561 6420  n-set', 'x=dead 
-00018210: 6265 6566 272c 2027 793d 3127 5d2c 2066  beef', 'y=1'], f
-00018220: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-00018230: 2873 656c 6629 5b30 5d29 0a0a 2020 2020  (self)[0])..    
-00018240: 6465 6620 7465 7374 5f61 6374 696f 6e5f  def test_action_
-00018250: 7365 745f 6b65 795f 7661 6c69 6461 7469  set_key_validati
-00018260: 6f6e 2873 656c 6629 3a0a 2020 2020 2020  on(self):.      
-00018270: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00018280: 7274 5261 6973 6573 2856 616c 7565 4572  rtRaises(ValueEr
-00018290: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-000182a0: 2020 7365 6c66 2e62 6163 6b65 6e64 2e61    self.backend.a
-000182b0: 6374 696f 6e5f 7365 7428 7b27 5827 3a20  ction_set({'X': 
-000182c0: 2764 6561 6420 6265 6566 272c 2027 7927  'dead beef', 'y'
-000182d0: 3a20 317d 290a 2020 2020 2020 2020 7769  : 1}).        wi
-000182e0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-000182f0: 6973 6573 2856 616c 7565 4572 726f 7229  ises(ValueError)
-00018300: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00018310: 6c66 2e62 6163 6b65 6e64 2e61 6374 696f  lf.backend.actio
-00018320: 6e5f 7365 7428 7b27 736f 6d65 266b 6579  n_set({'some&key
-00018330: 273a 2027 6465 6164 2062 6565 6627 2c20  ': 'dead beef', 
-00018340: 2779 273a 2031 7d29 0a20 2020 2020 2020  'y': 1}).       
-00018350: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00018360: 7452 6169 7365 7328 5661 6c75 6545 7272  tRaises(ValueErr
-00018370: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00018380: 2073 656c 662e 6261 636b 656e 642e 6163   self.backend.ac
-00018390: 7469 6f6e 5f73 6574 287b 2773 6f6d 654b  tion_set({'someK
-000183a0: 6579 273a 2027 6465 6164 2062 6565 6627  ey': 'dead beef'
-000183b0: 2c20 2779 273a 2031 7d29 0a20 2020 2020  , 'y': 1}).     
-000183c0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-000183d0: 6572 7452 6169 7365 7328 5661 6c75 6545  ertRaises(ValueE
-000183e0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-000183f0: 2020 2073 656c 662e 6261 636b 656e 642e     self.backend.
-00018400: 6163 7469 6f6e 5f73 6574 287b 2773 6f6d  action_set({'som
-00018410: 655f 6b65 7927 3a20 2764 6561 6420 6265  e_key': 'dead be
-00018420: 6566 272c 2027 7927 3a20 317d 290a 0a20  ef', 'y': 1}).. 
-00018430: 2020 2064 6566 2074 6573 745f 6163 7469     def test_acti
-00018440: 6f6e 5f73 6574 5f6e 6573 7465 6428 7365  on_set_nested(se
-00018450: 6c66 293a 0a20 2020 2020 2020 2066 616b  lf):.        fak
-00018460: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-00018470: 6163 7469 6f6e 2d67 6574 272c 2027 6578  action-get', 'ex
-00018480: 6974 2031 2729 0a20 2020 2020 2020 2066  it 1').        f
+00012fb0: 2020 6578 6974 2032 0a20 2020 2020 2020    exit 2.       
+00012fc0: 2020 2020 2020 2020 2066 690a 2020 2020           fi.    
+00012fd0: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
+00012fe0: 2020 2020 2023 2056 616c 6964 6174 6520       # Validate 
+00012ff0: 7468 6520 6265 6861 7669 6f72 2066 6f72  the behavior for
+00013000: 2064 6561 6420 7265 6c61 7469 6f6e 732e   dead relations.
+00013010: 0a20 2020 2020 2020 2062 696e 6469 6e67  .        binding
+00013020: 203d 206f 7073 2e42 696e 6469 6e67 2827   = ops.Binding('
+00013030: 6462 3027 2c20 3432 2c20 7365 6c66 2e6d  db0', 42, self.m
+00013040: 6f64 656c 2e5f 6261 636b 656e 6429 0a20  odel._backend). 
+00013050: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00013060: 7274 4571 7561 6c28 6269 6e64 696e 672e  rtEqual(binding.
+00013070: 6e65 7477 6f72 6b2e 6269 6e64 5f61 6464  network.bind_add
+00013080: 7265 7373 2c20 6970 6164 6472 6573 732e  ress, ipaddress.
+00013090: 6970 5f61 6464 7265 7373 2827 3139 322e  ip_address('192.
+000130a0: 302e 322e 3227 2929 0a20 2020 2020 2020  0.2.2')).       
+000130b0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000130c0: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
+000130d0: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
+000130e0: 5472 7565 292c 205b 0a20 2020 2020 2020  True), [.       
+000130f0: 2020 2020 205b 276e 6574 776f 726b 2d67       ['network-g
+00013100: 6574 272c 2027 6462 3027 2c20 272d 7227  et', 'db0', '-r'
+00013110: 2c20 2734 3227 2c20 272d 2d66 6f72 6d61  , '42', '--forma
+00013120: 743d 6a73 6f6e 275d 2c0a 2020 2020 2020  t=json'],.      
+00013130: 2020 2020 2020 5b27 6e65 7477 6f72 6b2d        ['network-
+00013140: 6765 7427 2c20 2764 6230 272c 2027 2d2d  get', 'db0', '--
+00013150: 666f 726d 6174 3d6a 736f 6e27 5d2c 0a20  format=json'],. 
+00013160: 2020 2020 2020 205d 290a 0a20 2020 2064         ])..    d
+00013170: 6566 2074 6573 745f 6269 6e64 696e 675f  ef test_binding_
+00013180: 6279 5f72 656c 6174 696f 6e5f 6e61 6d65  by_relation_name
+00013190: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000131a0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+000131b0: 2c20 276e 6574 776f 726b 2d67 6574 272c  , 'network-get',
+000131c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000131d0: 2020 2020 2066 2727 275b 2022 2431 2220       f'''[ "$1" 
+000131e0: 3d20 6462 3020 5d20 2626 2065 6368 6f20  = db0 ] && echo 
+000131f0: 277b 7365 6c66 2e6e 6574 776f 726b 5f67  '{self.network_g
+00013200: 6574 5f6f 7574 7d27 207c 7c20 6578 6974  et_out}' || exit
+00013210: 2031 2727 2729 0a20 2020 2020 2020 2062   1''').        b
+00013220: 696e 6469 6e67 5f6e 616d 6520 3d20 2764  inding_name = 'd
+00013230: 6230 270a 2020 2020 2020 2020 6578 7065  b0'.        expe
+00013240: 6374 6564 5f63 616c 6c73 203d 205b 5b27  cted_calls = [['
+00013250: 6e65 7477 6f72 6b2d 6765 7427 2c20 2764  network-get', 'd
+00013260: 6230 272c 2027 2d2d 666f 726d 6174 3d6a  b0', '--format=j
+00013270: 736f 6e27 5d5d 0a0a 2020 2020 2020 2020  son']]..        
+00013280: 6269 6e64 696e 6720 3d20 7365 6c66 2e6d  binding = self.m
+00013290: 6f64 656c 2e67 6574 5f62 696e 6469 6e67  odel.get_binding
+000132a0: 2862 696e 6469 6e67 5f6e 616d 6529 0a20  (binding_name). 
+000132b0: 2020 2020 2020 2073 656c 662e 5f63 6865         self._che
+000132c0: 636b 5f62 696e 6469 6e67 5f64 6174 6128  ck_binding_data(
+000132d0: 6269 6e64 696e 675f 6e61 6d65 2c20 6269  binding_name, bi
+000132e0: 6e64 696e 6729 0a20 2020 2020 2020 2073  nding).        s
+000132f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00013300: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
+00013310: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
+00013320: 7565 292c 2065 7870 6563 7465 645f 6361  ue), expected_ca
+00013330: 6c6c 7329 0a0a 2020 2020 6465 6620 7465  lls)..    def te
+00013340: 7374 5f62 696e 6469 6e67 5f62 795f 7265  st_binding_by_re
+00013350: 6c61 7469 6f6e 2873 656c 6629 3a0a 2020  lation(self):.  
+00013360: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
+00013370: 7428 7365 6c66 2c20 276e 6574 776f 726b  t(self, 'network
+00013380: 2d67 6574 272c 0a20 2020 2020 2020 2020  -get',.         
+00013390: 2020 2020 2020 2020 2020 2066 2727 275b             f'''[
+000133a0: 2022 2431 2220 3d20 6462 3020 5d20 2626   "$1" = db0 ] &&
+000133b0: 2065 6368 6f20 277b 7365 6c66 2e6e 6574   echo '{self.net
+000133c0: 776f 726b 5f67 6574 5f6f 7574 7d27 207c  work_get_out}' |
+000133d0: 7c20 6578 6974 2031 2727 2729 0a20 2020  | exit 1''').   
+000133e0: 2020 2020 2062 696e 6469 6e67 5f6e 616d       binding_nam
+000133f0: 6520 3d20 2764 6230 270a 2020 2020 2020  e = 'db0'.      
+00013400: 2020 6578 7065 6374 6564 5f63 616c 6c73    expected_calls
+00013410: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+00013420: 205b 2772 656c 6174 696f 6e2d 6964 7327   ['relation-ids'
+00013430: 2c20 2764 6230 272c 2027 2d2d 666f 726d  , 'db0', '--form
+00013440: 6174 3d6a 736f 6e27 5d2c 0a20 2020 2020  at=json'],.     
+00013450: 2020 2020 2020 2023 2054 6865 2074 776f         # The two
+00013460: 2069 6e76 6f63 6174 696f 6e73 2062 656c   invocations bel
+00013470: 6f77 2061 7265 2064 7565 2074 6f20 7468  ow are due to th
+00013480: 6520 6765 745f 7265 6c61 7469 6f6e 2063  e get_relation c
+00013490: 616c 6c2e 0a20 2020 2020 2020 2020 2020  all..           
+000134a0: 205b 2772 656c 6174 696f 6e2d 6c69 7374   ['relation-list
+000134b0: 272c 2027 2d72 272c 2027 3427 2c20 272d  ', '-r', '4', '-
+000134c0: 2d66 6f72 6d61 743d 6a73 6f6e 275d 2c0a  -format=json'],.
+000134d0: 2020 2020 2020 2020 2020 2020 5b27 6e65              ['ne
+000134e0: 7477 6f72 6b2d 6765 7427 2c20 2764 6230  twork-get', 'db0
+000134f0: 272c 2027 2d72 272c 2027 3427 2c20 272d  ', '-r', '4', '-
+00013500: 2d66 6f72 6d61 743d 6a73 6f6e 275d 2c0a  -format=json'],.
+00013510: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+00013520: 2020 6269 6e64 696e 6720 3d20 7365 6c66    binding = self
+00013530: 2e6d 6f64 656c 2e67 6574 5f62 696e 6469  .model.get_bindi
+00013540: 6e67 2873 656c 662e 6d6f 6465 6c2e 6765  ng(self.model.ge
+00013550: 745f 7265 6c61 7469 6f6e 2862 696e 6469  t_relation(bindi
+00013560: 6e67 5f6e 616d 6529 290a 2020 2020 2020  ng_name)).      
+00013570: 2020 7365 6c66 2e5f 6368 6563 6b5f 6269    self._check_bi
+00013580: 6e64 696e 675f 6461 7461 2862 696e 6469  nding_data(bindi
+00013590: 6e67 5f6e 616d 652c 2062 696e 6469 6e67  ng_name, binding
+000135a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000135b0: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
+000135c0: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
+000135d0: 662c 2063 6c65 6172 3d54 7275 6529 2c20  f, clear=True), 
+000135e0: 6578 7065 6374 6564 5f63 616c 6c73 290a  expected_calls).
+000135f0: 0a20 2020 2064 6566 2074 6573 745f 6269  .    def test_bi
+00013600: 6e64 696e 675f 6e6f 5f69 6661 6365 5f6e  nding_no_iface_n
+00013610: 616d 6528 7365 6c66 293a 0a20 2020 2020  ame(self):.     
+00013620: 2020 206e 6574 776f 726b 5f67 6574 5f6f     network_get_o
+00013630: 7574 5f6f 626a 203d 207b 0a20 2020 2020  ut_obj = {.     
+00013640: 2020 2020 2020 2027 6269 6e64 2d61 6464         'bind-add
+00013650: 7265 7373 6573 273a 205b 0a20 2020 2020  resses': [.     
+00013660: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00013670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013680: 2027 6d61 632d 6164 6472 6573 7327 3a20   'mac-address': 
+00013690: 2727 2c0a 2020 2020 2020 2020 2020 2020  '',.            
+000136a0: 2020 2020 2020 2020 2769 6e74 6572 6661          'interfa
+000136b0: 6365 2d6e 616d 6527 3a20 2727 2c0a 2020  ce-name': '',.  
+000136c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000136d0: 2020 2761 6464 7265 7373 6573 273a 205b    'addresses': [
+000136e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000136f0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00013700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013710: 2020 2020 2020 2027 686f 7374 6e61 6d65         'hostname
+00013720: 273a 2027 272c 0a20 2020 2020 2020 2020  ': '',.         
+00013730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013740: 2020 2027 7661 6c75 6527 3a20 2731 302e     'value': '10.
+00013750: 312e 3839 2e33 3527 2c0a 2020 2020 2020  1.89.35',.      
+00013760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013770: 2020 2020 2020 2763 6964 7227 3a20 2727        'cidr': ''
+00013780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013790: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000137a0: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
+000137b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000137c0: 207d 0a20 2020 2020 2020 2020 2020 205d   }.            ]
+000137d0: 2c0a 2020 2020 2020 2020 2020 2020 2765  ,.            'e
+000137e0: 6772 6573 732d 7375 626e 6574 7327 3a20  gress-subnets': 
+000137f0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00013800: 2020 2731 302e 3135 322e 3138 332e 3135    '10.152.183.15
+00013810: 382f 3332 270a 2020 2020 2020 2020 2020  8/32'.          
+00013820: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
+00013830: 2027 696e 6772 6573 732d 6164 6472 6573   'ingress-addres
+00013840: 7365 7327 3a20 5b0a 2020 2020 2020 2020  ses': [.        
+00013850: 2020 2020 2020 2020 2731 302e 3135 322e          '10.152.
+00013860: 3138 332e 3135 3827 0a20 2020 2020 2020  183.158'.       
+00013870: 2020 2020 205d 0a20 2020 2020 2020 207d       ].        }
+00013880: 0a20 2020 2020 2020 206e 6574 776f 726b  .        network
+00013890: 5f67 6574 5f6f 7574 203d 206a 736f 6e2e  _get_out = json.
+000138a0: 6475 6d70 7328 6e65 7477 6f72 6b5f 6765  dumps(network_ge
+000138b0: 745f 6f75 745f 6f62 6a29 0a20 2020 2020  t_out_obj).     
+000138c0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+000138d0: 656c 662c 2027 6e65 7477 6f72 6b2d 6765  elf, 'network-ge
+000138e0: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
+000138f0: 2020 2020 2020 2020 6627 2727 5b20 2224          f'''[ "$
+00013900: 3122 203d 2064 6230 205d 2026 2620 6563  1" = db0 ] && ec
+00013910: 686f 2027 7b6e 6574 776f 726b 5f67 6574  ho '{network_get
+00013920: 5f6f 7574 7d27 207c 7c20 6578 6974 2031  _out}' || exit 1
+00013930: 2727 2729 0a20 2020 2020 2020 2062 696e  ''').        bin
+00013940: 6469 6e67 5f6e 616d 6520 3d20 2764 6230  ding_name = 'db0
+00013950: 270a 2020 2020 2020 2020 6578 7065 6374  '.        expect
+00013960: 6564 5f63 616c 6c73 203d 205b 5b27 6e65  ed_calls = [['ne
+00013970: 7477 6f72 6b2d 6765 7427 2c20 2764 6230  twork-get', 'db0
+00013980: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
+00013990: 6e27 5d5d 0a0a 2020 2020 2020 2020 6269  n']]..        bi
+000139a0: 6e64 696e 6720 3d20 7365 6c66 2e6d 6f64  nding = self.mod
+000139b0: 656c 2e67 6574 5f62 696e 6469 6e67 2862  el.get_binding(b
+000139c0: 696e 6469 6e67 5f6e 616d 6529 0a20 2020  inding_name).   
+000139d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000139e0: 4571 7561 6c28 6269 6e64 696e 672e 6e61  Equal(binding.na
+000139f0: 6d65 2c20 2764 6230 2729 0a20 2020 2020  me, 'db0').     
+00013a00: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00013a10: 7561 6c28 6269 6e64 696e 672e 6e65 7477  ual(binding.netw
+00013a20: 6f72 6b2e 6269 6e64 5f61 6464 7265 7373  ork.bind_address
+00013a30: 2c20 6970 6164 6472 6573 732e 6970 5f61  , ipaddress.ip_a
+00013a40: 6464 7265 7373 2827 3130 2e31 2e38 392e  ddress('10.1.89.
+00013a50: 3335 2729 290a 2020 2020 2020 2020 7365  35')).        se
+00013a60: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
+00013a70: 696e 6469 6e67 2e6e 6574 776f 726b 2e69  inding.network.i
+00013a80: 6e67 7265 7373 5f61 6464 7265 7373 2c20  ngress_address, 
+00013a90: 6970 6164 6472 6573 732e 6970 5f61 6464  ipaddress.ip_add
+00013aa0: 7265 7373 2827 3130 2e31 3532 2e31 3833  ress('10.152.183
+00013ab0: 2e31 3538 2729 290a 2020 2020 2020 2020  .158')).        
+00013ac0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00013ad0: 2866 616b 655f 7363 7269 7074 5f63 616c  (fake_script_cal
+00013ae0: 6c73 2873 656c 662c 2063 6c65 6172 3d54  ls(self, clear=T
+00013af0: 7275 6529 2c20 6578 7065 6374 6564 5f63  rue), expected_c
+00013b00: 616c 6c73 290a 0a20 2020 2064 6566 2074  alls)..    def t
+00013b10: 6573 745f 6d69 7373 696e 675f 6269 6e64  est_missing_bind
+00013b20: 5f61 6464 7265 7373 6573 2873 656c 6629  _addresses(self)
+00013b30: 3a0a 2020 2020 2020 2020 6e65 7477 6f72  :.        networ
+00013b40: 6b5f 6461 7461 203d 206a 736f 6e2e 6475  k_data = json.du
+00013b50: 6d70 7328 7b7d 290a 2020 2020 2020 2020  mps({}).        
+00013b60: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+00013b70: 2c20 276e 6574 776f 726b 2d67 6574 272c  , 'network-get',
+00013b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013b90: 2020 2020 2066 2727 275b 2022 2431 2220       f'''[ "$1" 
+00013ba0: 3d20 6462 3020 5d20 2626 2065 6368 6f20  = db0 ] && echo 
+00013bb0: 277b 6e65 7477 6f72 6b5f 6461 7461 7d27  '{network_data}'
+00013bc0: 207c 7c20 6578 6974 2031 2727 2729 0a20   || exit 1'''). 
+00013bd0: 2020 2020 2020 2062 696e 6469 6e67 5f6e         binding_n
+00013be0: 616d 6520 3d20 2764 6230 270a 2020 2020  ame = 'db0'.    
+00013bf0: 2020 2020 6269 6e64 696e 6720 3d20 7365      binding = se
+00013c00: 6c66 2e6d 6f64 656c 2e67 6574 5f62 696e  lf.model.get_bin
+00013c10: 6469 6e67 2873 656c 662e 6d6f 6465 6c2e  ding(self.model.
+00013c20: 6765 745f 7265 6c61 7469 6f6e 2862 696e  get_relation(bin
+00013c30: 6469 6e67 5f6e 616d 6529 290a 2020 2020  ding_name)).    
+00013c40: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00013c50: 7175 616c 2862 696e 6469 6e67 2e6e 6574  qual(binding.net
+00013c60: 776f 726b 2e69 6e74 6572 6661 6365 732c  work.interfaces,
+00013c70: 205b 5d29 0a0a 2020 2020 6465 6620 7465   [])..    def te
+00013c80: 7374 5f65 6d70 7479 5f62 696e 645f 6164  st_empty_bind_ad
+00013c90: 6472 6573 7365 7328 7365 6c66 293a 0a20  dresses(self):. 
+00013ca0: 2020 2020 2020 206e 6574 776f 726b 5f64         network_d
+00013cb0: 6174 6120 3d20 6a73 6f6e 2e64 756d 7073  ata = json.dumps
+00013cc0: 287b 2762 696e 642d 6164 6472 6573 7365  ({'bind-addresse
+00013cd0: 7327 3a20 5b7b 7d5d 7d29 0a20 2020 2020  s': [{}]}).     
+00013ce0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+00013cf0: 656c 662c 2027 6e65 7477 6f72 6b2d 6765  elf, 'network-ge
+00013d00: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
+00013d10: 2020 2020 2020 2020 6627 2727 5b20 2224          f'''[ "$
+00013d20: 3122 203d 2064 6230 205d 2026 2620 6563  1" = db0 ] && ec
+00013d30: 686f 2027 7b6e 6574 776f 726b 5f64 6174  ho '{network_dat
+00013d40: 617d 2720 7c7c 2065 7869 7420 3127 2727  a}' || exit 1'''
+00013d50: 290a 2020 2020 2020 2020 6269 6e64 696e  ).        bindin
+00013d60: 675f 6e61 6d65 203d 2027 6462 3027 0a20  g_name = 'db0'. 
+00013d70: 2020 2020 2020 2062 696e 6469 6e67 203d         binding =
+00013d80: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
+00013d90: 6269 6e64 696e 6728 7365 6c66 2e6d 6f64  binding(self.mod
+00013da0: 656c 2e67 6574 5f72 656c 6174 696f 6e28  el.get_relation(
+00013db0: 6269 6e64 696e 675f 6e61 6d65 2929 0a20  binding_name)). 
+00013dc0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00013dd0: 7274 4571 7561 6c28 6269 6e64 696e 672e  rtEqual(binding.
+00013de0: 6e65 7477 6f72 6b2e 696e 7465 7266 6163  network.interfac
+00013df0: 6573 2c20 5b5d 290a 0a20 2020 2064 6566  es, [])..    def
+00013e00: 2074 6573 745f 6e6f 5f62 696e 645f 6164   test_no_bind_ad
+00013e10: 6472 6573 7365 7328 7365 6c66 293a 0a20  dresses(self):. 
+00013e20: 2020 2020 2020 206e 6574 776f 726b 5f64         network_d
+00013e30: 6174 6120 3d20 6a73 6f6e 2e64 756d 7073  ata = json.dumps
+00013e40: 287b 2762 696e 642d 6164 6472 6573 7365  ({'bind-addresse
+00013e50: 7327 3a20 5b7b 2761 6464 7265 7373 6573  s': [{'addresses
+00013e60: 273a 204e 6f6e 657d 5d7d 290a 2020 2020  ': None}]}).    
+00013e70: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+00013e80: 7365 6c66 2c20 276e 6574 776f 726b 2d67  self, 'network-g
+00013e90: 6574 272c 0a20 2020 2020 2020 2020 2020  et',.           
+00013ea0: 2020 2020 2020 2020 2066 2727 275b 2022           f'''[ "
+00013eb0: 2431 2220 3d20 6462 3020 5d20 2626 2065  $1" = db0 ] && e
+00013ec0: 6368 6f20 277b 6e65 7477 6f72 6b5f 6461  cho '{network_da
+00013ed0: 7461 7d27 207c 7c20 6578 6974 2031 2727  ta}' || exit 1''
+00013ee0: 2729 0a20 2020 2020 2020 2062 696e 6469  ').        bindi
+00013ef0: 6e67 5f6e 616d 6520 3d20 2764 6230 270a  ng_name = 'db0'.
+00013f00: 2020 2020 2020 2020 6269 6e64 696e 6720          binding 
+00013f10: 3d20 7365 6c66 2e6d 6f64 656c 2e67 6574  = self.model.get
+00013f20: 5f62 696e 6469 6e67 2873 656c 662e 6d6f  _binding(self.mo
+00013f30: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
+00013f40: 2862 696e 6469 6e67 5f6e 616d 6529 290a  (binding_name)).
+00013f50: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00013f60: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
+00013f70: 2e6e 6574 776f 726b 2e69 6e74 6572 6661  .network.interfa
+00013f80: 6365 732c 205b 5d29 0a0a 2020 2020 6465  ces, [])..    de
+00013f90: 6620 7465 7374 5f65 6d70 7479 5f69 6e74  f test_empty_int
+00013fa0: 6572 6661 6365 5f69 6e66 6f28 7365 6c66  erface_info(self
+00013fb0: 293a 0a20 2020 2020 2020 206e 6574 776f  ):.        netwo
+00013fc0: 726b 5f64 6174 6120 3d20 6a73 6f6e 2e64  rk_data = json.d
+00013fd0: 756d 7073 287b 0a20 2020 2020 2020 2020  umps({.         
+00013fe0: 2020 2027 6269 6e64 2d61 6464 7265 7373     'bind-address
+00013ff0: 6573 273a 205b 7b0a 2020 2020 2020 2020  es': [{.        
+00014000: 2020 2020 2020 2020 2769 6e74 6572 6661          'interfa
+00014010: 6365 2d6e 616d 6527 3a20 2765 7468 3027  ce-name': 'eth0'
+00014020: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014030: 2020 2761 6464 7265 7373 6573 273a 205b    'addresses': [
+00014040: 7b7d 5d2c 0a20 2020 2020 2020 2020 2020  {}],.           
+00014050: 207d 5d2c 0a20 2020 2020 2020 207d 290a   }],.        }).
+00014060: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
+00014070: 6970 7428 7365 6c66 2c20 276e 6574 776f  ipt(self, 'netwo
+00014080: 726b 2d67 6574 272c 0a20 2020 2020 2020  rk-get',.       
+00014090: 2020 2020 2020 2020 2020 2020 2066 2727               f''
+000140a0: 275b 2022 2431 2220 3d20 6462 3020 5d20  '[ "$1" = db0 ] 
+000140b0: 2626 2065 6368 6f20 277b 6e65 7477 6f72  && echo '{networ
+000140c0: 6b5f 6461 7461 7d27 207c 7c20 6578 6974  k_data}' || exit
+000140d0: 2031 2727 2729 0a20 2020 2020 2020 2062   1''').        b
+000140e0: 696e 6469 6e67 5f6e 616d 6520 3d20 2764  inding_name = 'd
+000140f0: 6230 270a 2020 2020 2020 2020 6269 6e64  b0'.        bind
+00014100: 696e 6720 3d20 7365 6c66 2e6d 6f64 656c  ing = self.model
+00014110: 2e67 6574 5f62 696e 6469 6e67 2873 656c  .get_binding(sel
+00014120: 662e 6d6f 6465 6c2e 6765 745f 7265 6c61  f.model.get_rela
+00014130: 7469 6f6e 2862 696e 6469 6e67 5f6e 616d  tion(binding_nam
+00014140: 6529 290a 2020 2020 2020 2020 7365 6c66  e)).        self
+00014150: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
+00014160: 2862 696e 6469 6e67 2e6e 6574 776f 726b  (binding.network
+00014170: 2e69 6e74 6572 6661 6365 7329 2c20 3129  .interfaces), 1)
+00014180: 0a20 2020 2020 2020 2069 6e74 6572 6661  .        interfa
+00014190: 6365 203d 2062 696e 6469 6e67 2e6e 6574  ce = binding.net
+000141a0: 776f 726b 2e69 6e74 6572 6661 6365 735b  work.interfaces[
+000141b0: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
+000141c0: 6173 7365 7274 4973 4e6f 6e65 2869 6e74  assertIsNone(int
+000141d0: 6572 6661 6365 2e61 6464 7265 7373 290a  erface.address).
+000141e0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000141f0: 6572 7449 734e 6f6e 6528 696e 7465 7266  ertIsNone(interf
+00014200: 6163 652e 7375 626e 6574 290a 0a20 2020  ace.subnet)..   
+00014210: 2064 6566 2074 6573 745f 6d69 7373 696e   def test_missin
+00014220: 675f 696e 6772 6573 735f 6164 6472 6573  g_ingress_addres
+00014230: 7365 7328 7365 6c66 293a 0a20 2020 2020  ses(self):.     
+00014240: 2020 206e 6574 776f 726b 5f64 6174 6120     network_data 
+00014250: 3d20 6a73 6f6e 2e64 756d 7073 287b 0a20  = json.dumps({. 
+00014260: 2020 2020 2020 2020 2020 2027 6269 6e64             'bind
+00014270: 2d61 6464 7265 7373 6573 273a 205b 5d2c  -addresses': [],
+00014280: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
+00014290: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+000142a0: 7365 6c66 2c20 276e 6574 776f 726b 2d67  self, 'network-g
+000142b0: 6574 272c 0a20 2020 2020 2020 2020 2020  et',.           
+000142c0: 2020 2020 2020 2020 2066 2727 275b 2022           f'''[ "
+000142d0: 2431 2220 3d20 6462 3020 5d20 2626 2065  $1" = db0 ] && e
+000142e0: 6368 6f20 277b 6e65 7477 6f72 6b5f 6461  cho '{network_da
+000142f0: 7461 7d27 207c 7c20 6578 6974 2031 2727  ta}' || exit 1''
+00014300: 2729 0a20 2020 2020 2020 2062 696e 6469  ').        bindi
+00014310: 6e67 5f6e 616d 6520 3d20 2764 6230 270a  ng_name = 'db0'.
+00014320: 2020 2020 2020 2020 6269 6e64 696e 6720          binding 
+00014330: 3d20 7365 6c66 2e6d 6f64 656c 2e67 6574  = self.model.get
+00014340: 5f62 696e 6469 6e67 2873 656c 662e 6d6f  _binding(self.mo
+00014350: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
+00014360: 2862 696e 6469 6e67 5f6e 616d 6529 290a  (binding_name)).
+00014370: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00014380: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
+00014390: 2e6e 6574 776f 726b 2e69 6e67 7265 7373  .network.ingress
+000143a0: 5f61 6464 7265 7373 6573 2c20 5b5d 290a  _addresses, []).
+000143b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000143c0: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
+000143d0: 2e6e 6574 776f 726b 2e69 6e67 7265 7373  .network.ingress
+000143e0: 5f61 6464 7265 7373 2c20 4e6f 6e65 290a  _address, None).
+000143f0: 0a20 2020 2064 6566 2074 6573 745f 6d69  .    def test_mi
+00014400: 7373 696e 675f 6567 7265 7373 5f73 7562  ssing_egress_sub
+00014410: 6e65 7473 2873 656c 6629 3a0a 2020 2020  nets(self):.    
+00014420: 2020 2020 6e65 7477 6f72 6b5f 6461 7461      network_data
+00014430: 203d 206a 736f 6e2e 6475 6d70 7328 7b0a   = json.dumps({.
+00014440: 2020 2020 2020 2020 2020 2020 2762 696e              'bin
+00014450: 642d 6164 6472 6573 7365 7327 3a20 5b5d  d-addresses': []
+00014460: 2c0a 2020 2020 2020 2020 2020 2020 2769  ,.            'i
+00014470: 6e67 7265 7373 2d61 6464 7265 7373 6573  ngress-addresses
+00014480: 273a 205b 5d2c 0a20 2020 2020 2020 207d  ': [],.        }
+00014490: 290a 2020 2020 2020 2020 6661 6b65 5f73  ).        fake_s
+000144a0: 6372 6970 7428 7365 6c66 2c20 276e 6574  cript(self, 'net
+000144b0: 776f 726b 2d67 6574 272c 0a20 2020 2020  work-get',.     
+000144c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000144d0: 2727 275b 2022 2431 2220 3d20 6462 3020  '''[ "$1" = db0 
+000144e0: 5d20 2626 2065 6368 6f20 277b 6e65 7477  ] && echo '{netw
+000144f0: 6f72 6b5f 6461 7461 7d27 207c 7c20 6578  ork_data}' || ex
+00014500: 6974 2031 2727 2729 0a20 2020 2020 2020  it 1''').       
+00014510: 2062 696e 6469 6e67 5f6e 616d 6520 3d20   binding_name = 
+00014520: 2764 6230 270a 2020 2020 2020 2020 6269  'db0'.        bi
+00014530: 6e64 696e 6720 3d20 7365 6c66 2e6d 6f64  nding = self.mod
+00014540: 656c 2e67 6574 5f62 696e 6469 6e67 2873  el.get_binding(s
+00014550: 656c 662e 6d6f 6465 6c2e 6765 745f 7265  elf.model.get_re
+00014560: 6c61 7469 6f6e 2862 696e 6469 6e67 5f6e  lation(binding_n
+00014570: 616d 6529 290a 2020 2020 2020 2020 7365  ame)).        se
+00014580: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
+00014590: 696e 6469 6e67 2e6e 6574 776f 726b 2e65  inding.network.e
+000145a0: 6772 6573 735f 7375 626e 6574 732c 205b  gress_subnets, [
+000145b0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
+000145c0: 5f75 6e72 6573 6f6c 7665 645f 696e 6772  _unresolved_ingr
+000145d0: 6573 735f 6164 6472 6573 7365 7328 7365  ess_addresses(se
+000145e0: 6c66 293a 0a20 2020 2020 2020 2023 2073  lf):.        # s
+000145f0: 6f6d 6574 696d 6573 206a 756a 7520 6661  ometimes juju fa
+00014600: 696c 7320 746f 2072 6573 6f6c 7665 2061  ils to resolve a
+00014610: 6e20 7572 6c20 746f 2061 6e20 4950 2c20  n url to an IP, 
+00014620: 696e 2077 6869 6368 2063 6173 650a 2020  in which case.  
+00014630: 2020 2020 2020 2320 696e 6772 6573 732d        # ingress-
+00014640: 6164 6472 6573 7365 7320 7769 6c6c 2062  addresses will b
+00014650: 6520 7468 6520 2772 6177 2720 7572 6c20  e the 'raw' url 
+00014660: 696e 7374 6561 6420 6f66 2061 6e20 4950  instead of an IP
+00014670: 2e0a 2020 2020 2020 2020 6e65 7477 6f72  ..        networ
+00014680: 6b5f 6461 7461 203d 206a 736f 6e2e 6475  k_data = json.du
+00014690: 6d70 7328 7b0a 2020 2020 2020 2020 2020  mps({.          
+000146a0: 2020 2769 6e67 7265 7373 2d61 6464 7265    'ingress-addre
+000146b0: 7373 6573 273a 205b 0a20 2020 2020 2020  sses': [.       
+000146c0: 2020 2020 2020 2020 2027 666f 6f2e 6261           'foo.ba
+000146d0: 722e 6261 7a2e 636f 6d27 0a20 2020 2020  r.baz.com'.     
+000146e0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+000146f0: 2020 7d29 0a20 2020 2020 2020 2066 616b    }).        fak
+00014700: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
+00014710: 6e65 7477 6f72 6b2d 6765 7427 2c0a 2020  network-get',.  
+00014720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014730: 2020 6627 2727 5b20 2224 3122 203d 2064    f'''[ "$1" = d
+00014740: 6230 205d 2026 2620 6563 686f 2027 7b6e  b0 ] && echo '{n
+00014750: 6574 776f 726b 5f64 6174 617d 2720 7c7c  etwork_data}' ||
+00014760: 2065 7869 7420 3127 2727 290a 2020 2020   exit 1''').    
+00014770: 2020 2020 6269 6e64 696e 675f 6e61 6d65      binding_name
+00014780: 203d 2027 6462 3027 0a20 2020 2020 2020   = 'db0'.       
+00014790: 2062 696e 6469 6e67 203d 2073 656c 662e   binding = self.
+000147a0: 6d6f 6465 6c2e 6765 745f 6269 6e64 696e  model.get_bindin
+000147b0: 6728 7365 6c66 2e6d 6f64 656c 2e67 6574  g(self.model.get
+000147c0: 5f72 656c 6174 696f 6e28 6269 6e64 696e  _relation(bindin
+000147d0: 675f 6e61 6d65 2929 0a20 2020 2020 2020  g_name)).       
+000147e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000147f0: 6c28 6269 6e64 696e 672e 6e65 7477 6f72  l(binding.networ
+00014800: 6b2e 696e 6772 6573 735f 6164 6472 6573  k.ingress_addres
+00014810: 7365 732c 205b 2766 6f6f 2e62 6172 2e62  ses, ['foo.bar.b
+00014820: 617a 2e63 6f6d 275d 290a 0a0a 636c 6173  az.com'])...clas
+00014830: 7320 5465 7374 4d6f 6465 6c42 6163 6b65  s TestModelBacke
+00014840: 6e64 2875 6e69 7474 6573 742e 5465 7374  nd(unittest.Test
+00014850: 4361 7365 293a 0a0a 2020 2020 6465 6620  Case):..    def 
+00014860: 7365 7455 7028 7365 6c66 293a 0a20 2020  setUp(self):.   
+00014870: 2020 2020 2073 656c 662e 5f62 6163 6b65       self._backe
+00014880: 6e64 203d 204e 6f6e 650a 0a20 2020 2040  nd = None..    @
+00014890: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+000148a0: 2062 6163 6b65 6e64 2873 656c 6629 3a0a   backend(self):.
+000148b0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000148c0: 5f62 6163 6b65 6e64 2069 7320 4e6f 6e65  _backend is None
+000148d0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000148e0: 6c66 2e5f 6261 636b 656e 6420 3d20 5f4d  lf._backend = _M
+000148f0: 6f64 656c 4261 636b 656e 6428 276d 7961  odelBackend('mya
+00014900: 7070 2f30 2729 0a20 2020 2020 2020 2072  pp/0').        r
+00014910: 6574 7572 6e20 7365 6c66 2e5f 6261 636b  eturn self._back
+00014920: 656e 640a 0a20 2020 2064 6566 2074 6573  end..    def tes
+00014930: 745f 7265 6c61 7469 6f6e 5f67 6574 5f73  t_relation_get_s
+00014940: 6574 5f69 735f 6170 705f 6172 6728 7365  et_is_app_arg(se
+00014950: 6c66 293a 0a20 2020 2020 2020 2023 204e  lf):.        # N
+00014960: 6f20 6973 5f61 7070 2070 726f 7669 6465  o is_app provide
+00014970: 642e 0a20 2020 2020 2020 2077 6974 6820  d..        with 
+00014980: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+00014990: 7328 5479 7065 4572 726f 7229 3a0a 2020  s(TypeError):.  
+000149a0: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
+000149b0: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
+000149c0: 7365 7428 312c 2027 666f 6f6b 6579 272c  set(1, 'fookey',
+000149d0: 2027 6261 7276 616c 2729 0a0a 2020 2020   'barval')..    
+000149e0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+000149f0: 7365 7274 5261 6973 6573 2854 7970 6545  sertRaises(TypeE
+00014a00: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+00014a10: 2020 2073 656c 662e 6261 636b 656e 642e     self.backend.
+00014a20: 7265 6c61 7469 6f6e 5f67 6574 2831 2c20  relation_get(1, 
+00014a30: 2766 6f6f 656e 7469 7479 2729 0a0a 2020  'fooentity')..  
+00014a40: 2020 2020 2020 2320 496e 7661 6c69 6420        # Invalid 
+00014a50: 7479 7065 7320 666f 7220 6973 5f61 7070  types for is_app
+00014a60: 2e0a 2020 2020 2020 2020 666f 7220 6973  ..        for is
+00014a70: 5f61 7070 5f76 2069 6e20 5b4e 6f6e 652c  _app_v in [None,
+00014a80: 2031 2c20 322e 302c 2027 6127 2c20 6227   1, 2.0, 'a', b'
+00014a90: 6265 6566 275d 3a0a 2020 2020 2020 2020  beef']:.        
+00014aa0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00014ab0: 7365 7274 5261 6973 6573 2854 7970 6545  sertRaises(TypeE
+00014ac0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+00014ad0: 2020 2020 2020 2073 656c 662e 6261 636b         self.back
+00014ae0: 656e 642e 7265 6c61 7469 6f6e 5f73 6574  end.relation_set
+00014af0: 2831 2c20 2766 6f6f 6b65 7927 2c20 2762  (1, 'fookey', 'b
+00014b00: 6172 7661 6c27 2c20 6973 5f61 7070 3d69  arval', is_app=i
+00014b10: 735f 6170 705f 7629 0a0a 2020 2020 2020  s_app_v)..      
+00014b20: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00014b30: 6173 7365 7274 5261 6973 6573 2854 7970  assertRaises(Typ
+00014b40: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+00014b50: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
+00014b60: 636b 656e 642e 7265 6c61 7469 6f6e 5f67  ckend.relation_g
+00014b70: 6574 2831 2c20 2766 6f6f 656e 7469 7479  et(1, 'fooentity
+00014b80: 272c 2069 735f 6170 703d 6973 5f61 7070  ', is_app=is_app
+00014b90: 5f76 290a 0a20 2020 2064 6566 2074 6573  _v)..    def tes
+00014ba0: 745f 6973 5f6c 6561 6465 725f 7265 6672  t_is_leader_refr
+00014bb0: 6573 6828 7365 6c66 293a 0a20 2020 2020  esh(self):.     
+00014bc0: 2020 206d 6574 6120 3d20 6f70 732e 4368     meta = ops.Ch
+00014bd0: 6172 6d4d 6574 612e 6672 6f6d 5f79 616d  armMeta.from_yam
+00014be0: 6c28 2727 270a 2020 2020 2020 2020 2020  l('''.          
+00014bf0: 2020 6e61 6d65 3a20 6d79 6170 700a 2020    name: myapp.  
+00014c00: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+00014c10: 2020 206d 6f64 656c 203d 206f 7073 2e4d     model = ops.M
+00014c20: 6f64 656c 286d 6574 612c 2073 656c 662e  odel(meta, self.
+00014c30: 6261 636b 656e 6429 0a20 2020 2020 2020  backend).       
+00014c40: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+00014c50: 662c 2027 6973 2d6c 6561 6465 7227 2c20  f, 'is-leader', 
+00014c60: 2765 6368 6f20 6661 6c73 6527 290a 2020  'echo false').  
+00014c70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00014c80: 7446 616c 7365 286d 6f64 656c 2e75 6e69  tFalse(model.uni
+00014c90: 742e 6973 5f6c 6561 6465 7228 2929 0a0a  t.is_leader())..
+00014ca0: 2020 2020 2020 2020 2320 4368 616e 6765          # Change
+00014cb0: 2074 6865 206c 6561 6465 7273 6869 7020   the leadership 
+00014cc0: 7374 6174 7573 0a20 2020 2020 2020 2066  status.        f
+00014cd0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+00014ce0: 2027 6973 2d6c 6561 6465 7227 2c20 2765   'is-leader', 'e
+00014cf0: 6368 6f20 7472 7565 2729 0a20 2020 2020  cho true').     
+00014d00: 2020 2023 2049 6620 796f 7520 646f 6e27     # If you don'
+00014d10: 7420 666f 7263 6520 6974 2c20 7765 2064  t force it, we d
+00014d20: 6f6e 2774 2063 6865 636b 2c20 736f 2077  on't check, so w
+00014d30: 6520 776f 6e27 7420 7365 6520 7468 6520  e won't see the 
+00014d40: 6368 616e 6765 0a20 2020 2020 2020 2073  change.        s
+00014d50: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
+00014d60: 6d6f 6465 6c2e 756e 6974 2e69 735f 6c65  model.unit.is_le
+00014d70: 6164 6572 2829 290a 2020 2020 2020 2020  ader()).        
+00014d80: 2320 4966 2077 6520 666f 7263 6520 6120  # If we force a 
+00014d90: 7265 6368 6563 6b2c 2074 6865 6e20 7765  recheck, then we
+00014da0: 206e 6f74 6963 650a 2020 2020 2020 2020   notice.        
+00014db0: 7365 6c66 2e62 6163 6b65 6e64 2e5f 6c65  self.backend._le
+00014dc0: 6164 6572 5f63 6865 636b 5f74 696d 6520  ader_check_time 
+00014dd0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
+00014de0: 656c 662e 6173 7365 7274 5472 7565 286d  elf.assertTrue(m
+00014df0: 6f64 656c 2e75 6e69 742e 6973 5f6c 6561  odel.unit.is_lea
+00014e00: 6465 7228 2929 0a0a 2020 2020 2020 2020  der())..        
+00014e10: 2320 466f 7263 6520 6120 7265 6368 6563  # Force a rechec
+00014e20: 6b20 7769 7468 6f75 7420 6368 616e 6769  k without changi
+00014e30: 6e67 2074 6865 206c 6561 6465 7273 6869  ng the leadershi
+00014e40: 7020 7374 6174 7573 2e0a 2020 2020 2020  p status..      
+00014e50: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+00014e60: 6c66 2c20 2769 732d 6c65 6164 6572 272c  lf, 'is-leader',
+00014e70: 2027 6563 686f 2074 7275 6527 290a 2020   'echo true').  
+00014e80: 2020 2020 2020 7365 6c66 2e62 6163 6b65        self.backe
+00014e90: 6e64 2e5f 6c65 6164 6572 5f63 6865 636b  nd._leader_check
+00014ea0: 5f74 696d 6520 3d20 4e6f 6e65 0a20 2020  _time = None.   
+00014eb0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00014ec0: 5472 7565 286d 6f64 656c 2e75 6e69 742e  True(model.unit.
+00014ed0: 6973 5f6c 6561 6465 7228 2929 0a0a 2020  is_leader())..  
+00014ee0: 2020 6465 6620 7465 7374 5f72 656c 6174    def test_relat
+00014ef0: 696f 6e5f 746f 6f6c 5f65 7272 6f72 7328  ion_tool_errors(
+00014f00: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+00014f10: 656c 662e 6164 6443 6c65 616e 7570 286f  elf.addCleanup(o
+00014f20: 732e 656e 7669 726f 6e2e 706f 702c 2027  s.environ.pop, '
+00014f30: 4a55 4a55 5f56 4552 5349 4f4e 272c 204e  JUJU_VERSION', N
+00014f40: 6f6e 6529 0a20 2020 2020 2020 206f 732e  one).        os.
+00014f50: 656e 7669 726f 6e5b 274a 554a 555f 5645  environ['JUJU_VE
+00014f60: 5253 494f 4e27 5d20 3d20 2732 2e38 2e30  RSION'] = '2.8.0
+00014f70: 270a 2020 2020 2020 2020 6572 725f 6d73  '.        err_ms
+00014f80: 6720 3d20 2745 5252 4f52 2069 6e76 616c  g = 'ERROR inval
+00014f90: 6964 2076 616c 7565 2022 2432 2220 666f  id value "$2" fo
+00014fa0: 7220 6f70 7469 6f6e 202d 723a 2072 656c  r option -r: rel
+00014fb0: 6174 696f 6e20 6e6f 7420 666f 756e 6427  ation not found'
+00014fc0: 0a0a 2020 2020 2020 2020 7465 7374 5f63  ..        test_c
+00014fd0: 6173 6573 203d 205b 280a 2020 2020 2020  ases = [(.      
+00014fe0: 2020 2020 2020 6c61 6d62 6461 3a20 6661        lambda: fa
+00014ff0: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+00015000: 2772 656c 6174 696f 6e2d 6c69 7374 272c  'relation-list',
+00015010: 2027 6563 686f 2066 6f6f 6572 726f 7220   'echo fooerror 
+00015020: 3e26 3220 3b20 6578 6974 2031 2729 2c0a  >&2 ; exit 1'),.
+00015030: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
+00015040: 6461 3a20 7365 6c66 2e62 6163 6b65 6e64  da: self.backend
+00015050: 2e72 656c 6174 696f 6e5f 6c69 7374 2833  .relation_list(3
+00015060: 292c 0a20 2020 2020 2020 2020 2020 206f  ),.            o
+00015070: 7073 2e4d 6f64 656c 4572 726f 722c 0a20  ps.ModelError,. 
+00015080: 2020 2020 2020 2020 2020 205b 5b27 7265             [['re
+00015090: 6c61 7469 6f6e 2d6c 6973 7427 2c20 272d  lation-list', '-
+000150a0: 7227 2c20 2733 272c 2027 2d2d 666f 726d  r', '3', '--form
+000150b0: 6174 3d6a 736f 6e27 5d5d 2c0a 2020 2020  at=json']],.    
+000150c0: 2020 2020 292c 2028 0a20 2020 2020 2020      ), (.       
+000150d0: 2020 2020 206c 616d 6264 613a 2066 616b       lambda: fak
+000150e0: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
+000150f0: 7265 6c61 7469 6f6e 2d6c 6973 7427 2c20  relation-list', 
+00015100: 6627 6563 686f 207b 6572 725f 6d73 677d  f'echo {err_msg}
+00015110: 203e 2632 203b 2065 7869 7420 3227 292c   >&2 ; exit 2'),
+00015120: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
+00015130: 6264 613a 2073 656c 662e 6261 636b 656e  bda: self.backen
+00015140: 642e 7265 6c61 7469 6f6e 5f6c 6973 7428  d.relation_list(
+00015150: 3329 2c0a 2020 2020 2020 2020 2020 2020  3),.            
+00015160: 6f70 732e 5265 6c61 7469 6f6e 4e6f 7446  ops.RelationNotF
+00015170: 6f75 6e64 4572 726f 722c 0a20 2020 2020  oundError,.     
+00015180: 2020 2020 2020 205b 5b27 7265 6c61 7469         [['relati
+00015190: 6f6e 2d6c 6973 7427 2c20 272d 7227 2c20  on-list', '-r', 
+000151a0: 2733 272c 2027 2d2d 666f 726d 6174 3d6a  '3', '--format=j
+000151b0: 736f 6e27 5d5d 2c0a 2020 2020 2020 2020  son']],.        
+000151c0: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
+000151d0: 206c 616d 6264 613a 2066 616b 655f 7363   lambda: fake_sc
+000151e0: 7269 7074 2873 656c 662c 2027 7265 6c61  ript(self, 'rela
+000151f0: 7469 6f6e 2d73 6574 272c 2027 6563 686f  tion-set', 'echo
+00015200: 2066 6f6f 6572 726f 7220 3e26 3220 3b20   fooerror >&2 ; 
+00015210: 6578 6974 2031 2729 2c0a 2020 2020 2020  exit 1'),.      
+00015220: 2020 2020 2020 6c61 6d62 6461 3a20 7365        lambda: se
+00015230: 6c66 2e62 6163 6b65 6e64 2e72 656c 6174  lf.backend.relat
+00015240: 696f 6e5f 7365 7428 332c 2027 666f 6f27  ion_set(3, 'foo'
+00015250: 2c20 2762 6172 272c 2069 735f 6170 703d  , 'bar', is_app=
+00015260: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
+00015270: 2020 2020 6f70 732e 4d6f 6465 6c45 7272      ops.ModelErr
+00015280: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
+00015290: 5b5b 2772 656c 6174 696f 6e2d 7365 7427  [['relation-set'
+000152a0: 2c20 272d 7227 2c20 2733 272c 2027 2d2d  , '-r', '3', '--
+000152b0: 6669 6c65 272c 2027 2d27 5d5d 2c0a 2020  file', '-']],.  
+000152c0: 2020 2020 2020 292c 2028 0a20 2020 2020        ), (.     
+000152d0: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
+000152e0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+000152f0: 2027 7265 6c61 7469 6f6e 2d73 6574 272c   'relation-set',
+00015300: 2066 2765 6368 6f20 7b65 7272 5f6d 7367   f'echo {err_msg
+00015310: 7d20 3e26 3220 3b20 6578 6974 2032 2729  } >&2 ; exit 2')
+00015320: 2c0a 2020 2020 2020 2020 2020 2020 6c61  ,.            la
+00015330: 6d62 6461 3a20 7365 6c66 2e62 6163 6b65  mbda: self.backe
+00015340: 6e64 2e72 656c 6174 696f 6e5f 7365 7428  nd.relation_set(
+00015350: 332c 2027 666f 6f27 2c20 2762 6172 272c  3, 'foo', 'bar',
+00015360: 2069 735f 6170 703d 4661 6c73 6529 2c0a   is_app=False),.
+00015370: 2020 2020 2020 2020 2020 2020 6f70 732e              ops.
+00015380: 5265 6c61 7469 6f6e 4e6f 7446 6f75 6e64  RelationNotFound
+00015390: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
+000153a0: 2020 205b 5b27 7265 6c61 7469 6f6e 2d73     [['relation-s
+000153b0: 6574 272c 2027 2d72 272c 2027 3327 2c20  et', '-r', '3', 
+000153c0: 272d 2d66 696c 6527 2c20 272d 275d 5d2c  '--file', '-']],
+000153d0: 0a20 2020 2020 2020 2029 2c20 280a 2020  .        ), (.  
+000153e0: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
+000153f0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+00015400: 2020 2020 6c61 6d62 6461 3a20 7365 6c66      lambda: self
+00015410: 2e62 6163 6b65 6e64 2e72 656c 6174 696f  .backend.relatio
+00015420: 6e5f 7365 7428 332c 2027 666f 6f27 2c20  n_set(3, 'foo', 
+00015430: 2762 6172 272c 2069 735f 6170 703d 5472  'bar', is_app=Tr
+00015440: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
+00015450: 206f 7073 2e52 656c 6174 696f 6e4e 6f74   ops.RelationNot
+00015460: 466f 756e 6445 7272 6f72 2c0a 2020 2020  FoundError,.    
+00015470: 2020 2020 2020 2020 5b5b 2772 656c 6174          [['relat
+00015480: 696f 6e2d 7365 7427 2c20 272d 7227 2c20  ion-set', '-r', 
+00015490: 2733 272c 2027 2d2d 6170 7027 2c20 272d  '3', '--app', '-
+000154a0: 2d66 696c 6527 2c20 272d 275d 5d2c 0a20  -file', '-']],. 
+000154b0: 2020 2020 2020 2029 2c20 280a 2020 2020         ), (.    
+000154c0: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
+000154d0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+000154e0: 2c20 2772 656c 6174 696f 6e2d 6765 7427  , 'relation-get'
+000154f0: 2c20 2765 6368 6f20 666f 6f65 7272 6f72  , 'echo fooerror
+00015500: 203e 2632 203b 2065 7869 7420 3127 292c   >&2 ; exit 1'),
+00015510: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
+00015520: 6264 613a 2073 656c 662e 6261 636b 656e  bda: self.backen
+00015530: 642e 7265 6c61 7469 6f6e 5f67 6574 2833  d.relation_get(3
+00015540: 2c20 2772 656d 6f74 652f 3027 2c20 6973  , 'remote/0', is
+00015550: 5f61 7070 3d46 616c 7365 292c 0a20 2020  _app=False),.   
+00015560: 2020 2020 2020 2020 206f 7073 2e4d 6f64           ops.Mod
+00015570: 656c 4572 726f 722c 0a20 2020 2020 2020  elError,.       
+00015580: 2020 2020 205b 5b27 7265 6c61 7469 6f6e       [['relation
+00015590: 2d67 6574 272c 2027 2d72 272c 2027 3327  -get', '-r', '3'
+000155a0: 2c20 272d 272c 2027 7265 6d6f 7465 2f30  , '-', 'remote/0
+000155b0: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
+000155c0: 6e27 5d5d 2c0a 2020 2020 2020 2020 292c  n']],.        ),
+000155d0: 2028 0a20 2020 2020 2020 2020 2020 206c   (.            l
+000155e0: 616d 6264 613a 2066 616b 655f 7363 7269  ambda: fake_scri
+000155f0: 7074 2873 656c 662c 2027 7265 6c61 7469  pt(self, 'relati
+00015600: 6f6e 2d67 6574 272c 2066 2765 6368 6f20  on-get', f'echo 
+00015610: 7b65 7272 5f6d 7367 7d20 3e26 3220 3b20  {err_msg} >&2 ; 
+00015620: 6578 6974 2032 2729 2c0a 2020 2020 2020  exit 2'),.      
+00015630: 2020 2020 2020 6c61 6d62 6461 3a20 7365        lambda: se
+00015640: 6c66 2e62 6163 6b65 6e64 2e72 656c 6174  lf.backend.relat
+00015650: 696f 6e5f 6765 7428 332c 2027 7265 6d6f  ion_get(3, 'remo
+00015660: 7465 2f30 272c 2069 735f 6170 703d 4661  te/0', is_app=Fa
+00015670: 6c73 6529 2c0a 2020 2020 2020 2020 2020  lse),.          
+00015680: 2020 6f70 732e 5265 6c61 7469 6f6e 4e6f    ops.RelationNo
+00015690: 7446 6f75 6e64 4572 726f 722c 0a20 2020  tFoundError,.   
+000156a0: 2020 2020 2020 2020 205b 5b27 7265 6c61           [['rela
+000156b0: 7469 6f6e 2d67 6574 272c 2027 2d72 272c  tion-get', '-r',
+000156c0: 2027 3327 2c20 272d 272c 2027 7265 6d6f   '3', '-', 'remo
+000156d0: 7465 2f30 272c 2027 2d2d 666f 726d 6174  te/0', '--format
+000156e0: 3d6a 736f 6e27 5d5d 2c0a 2020 2020 2020  =json']],.      
+000156f0: 2020 292c 2028 0a20 2020 2020 2020 2020    ), (.         
+00015700: 2020 206c 616d 6264 613a 204e 6f6e 652c     lambda: None,
+00015710: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
+00015720: 6264 613a 2073 656c 662e 6261 636b 656e  bda: self.backen
+00015730: 642e 7265 6c61 7469 6f6e 5f67 6574 2833  d.relation_get(3
+00015740: 2c20 2772 656d 6f74 652f 3027 2c20 6973  , 'remote/0', is
+00015750: 5f61 7070 3d54 7275 6529 2c0a 2020 2020  _app=True),.    
+00015760: 2020 2020 2020 2020 6f70 732e 5265 6c61          ops.Rela
+00015770: 7469 6f6e 4e6f 7446 6f75 6e64 4572 726f  tionNotFoundErro
+00015780: 722c 0a20 2020 2020 2020 2020 2020 205b  r,.            [
+00015790: 5b27 7265 6c61 7469 6f6e 2d67 6574 272c  ['relation-get',
+000157a0: 2027 2d72 272c 2027 3327 2c20 272d 272c   '-r', '3', '-',
+000157b0: 2027 7265 6d6f 7465 2f30 272c 2027 2d2d   'remote/0', '--
+000157c0: 6170 7027 2c20 272d 2d66 6f72 6d61 743d  app', '--format=
+000157d0: 6a73 6f6e 275d 5d2c 0a20 2020 2020 2020  json']],.       
+000157e0: 2029 5d0a 0a20 2020 2020 2020 2066 6f72   )]..        for
+000157f0: 2069 2c20 2864 6f5f 6661 6b65 2c20 7275   i, (do_fake, ru
+00015800: 6e2c 2065 7863 6570 7469 6f6e 2c20 6361  n, exception, ca
+00015810: 6c6c 7329 2069 6e20 656e 756d 6572 6174  lls) in enumerat
+00015820: 6528 7465 7374 5f63 6173 6573 293a 0a20  e(test_cases):. 
+00015830: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+00015840: 7365 6c66 2e73 7562 5465 7374 2869 293a  self.subTest(i):
+00015850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015860: 2064 6f5f 6661 6b65 2829 0a20 2020 2020   do_fake().     
+00015870: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+00015880: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+00015890: 7328 6578 6365 7074 696f 6e29 3a0a 2020  s(exception):.  
+000158a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000158b0: 2020 7275 6e28 290a 2020 2020 2020 2020    run().        
+000158c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000158d0: 6572 7445 7175 616c 2866 616b 655f 7363  ertEqual(fake_sc
+000158e0: 7269 7074 5f63 616c 6c73 2873 656c 662c  ript_calls(self,
+000158f0: 2063 6c65 6172 3d54 7275 6529 2c20 6361   clear=True), ca
+00015900: 6c6c 7329 0a0a 2020 2020 6465 6620 7465  lls)..    def te
+00015910: 7374 5f72 656c 6174 696f 6e5f 6765 745f  st_relation_get_
+00015920: 6a75 6a75 5f76 6572 7369 6f6e 5f71 7569  juju_version_qui
+00015930: 726b 7328 7365 6c66 293a 0a20 2020 2020  rks(self):.     
+00015940: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+00015950: 7570 286f 732e 656e 7669 726f 6e2e 706f  up(os.environ.po
+00015960: 702c 2027 4a55 4a55 5f56 4552 5349 4f4e  p, 'JUJU_VERSION
+00015970: 272c 204e 6f6e 6529 0a0a 2020 2020 2020  ', None)..      
+00015980: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+00015990: 6c66 2c20 2772 656c 6174 696f 6e2d 6765  lf, 'relation-ge
+000159a0: 7427 2c20 2727 2765 6368 6f20 277b 2266  t', '''echo '{"f
+000159b0: 6f6f 223a 2022 6261 7222 7d27 2027 2727  oo": "bar"}' '''
+000159c0: 290a 0a20 2020 2020 2020 2023 206f 6e20  )..        # on 
+000159d0: 322e 372e 302b 2c20 7468 696e 6773 2070  2.7.0+, things p
+000159e0: 726f 6365 6564 2061 7320 6578 7065 6374  roceed as expect
+000159f0: 6564 0a20 2020 2020 2020 2066 6f72 2076  ed.        for v
+00015a00: 2069 6e20 5b27 322e 382e 3027 2c20 2732   in ['2.8.0', '2
+00015a10: 2e37 2e30 275d 3a0a 2020 2020 2020 2020  .7.0']:.        
+00015a20: 2020 2020 7769 7468 2073 656c 662e 7375      with self.su
+00015a30: 6254 6573 7428 7629 3a0a 2020 2020 2020  bTest(v):.      
+00015a40: 2020 2020 2020 2020 2020 6f73 2e65 6e76            os.env
+00015a50: 6972 6f6e 5b27 4a55 4a55 5f56 4552 5349  iron['JUJU_VERSI
+00015a60: 4f4e 275d 203d 2076 0a20 2020 2020 2020  ON'] = v.       
+00015a70: 2020 2020 2020 2020 2072 656c 5f64 6174           rel_dat
+00015a80: 6120 3d20 7365 6c66 2e62 6163 6b65 6e64  a = self.backend
+00015a90: 2e72 656c 6174 696f 6e5f 6765 7428 312c  .relation_get(1,
+00015aa0: 2027 666f 6f2f 3027 2c20 6973 5f61 7070   'foo/0', is_app
+00015ab0: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
+00015ac0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00015ad0: 7274 4571 7561 6c28 7265 6c5f 6461 7461  rtEqual(rel_data
+00015ae0: 2c20 7b22 666f 6f22 3a20 2262 6172 227d  , {"foo": "bar"}
+00015af0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00015b00: 2020 6361 6c6c 7320 3d20 5b27 2027 2e6a    calls = [' '.j
+00015b10: 6f69 6e28 6929 2066 6f72 2069 2069 6e20  oin(i) for i in 
+00015b20: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
+00015b30: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
+00015b40: 7565 295d 0a20 2020 2020 2020 2020 2020  ue)].           
+00015b50: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00015b60: 4571 7561 6c28 6361 6c6c 732c 205b 2772  Equal(calls, ['r
+00015b70: 656c 6174 696f 6e2d 6765 7420 2d72 2031  elation-get -r 1
+00015b80: 202d 2066 6f6f 2f30 202d 2d61 7070 202d   - foo/0 --app -
+00015b90: 2d66 6f72 6d61 743d 6a73 6f6e 275d 290a  -format=json']).
+00015ba0: 0a20 2020 2020 2020 2023 2062 6566 6f72  .        # befor
+00015bb0: 6520 322e 372e 302c 2069 7420 6a75 7374  e 2.7.0, it just
+00015bc0: 2066 6169 6c73 2028 6e6f 202d 2d61 7070   fails (no --app
+00015bd0: 2073 7570 706f 7274 290a 2020 2020 2020   support).      
+00015be0: 2020 6f73 2e65 6e76 6972 6f6e 5b27 4a55    os.environ['JU
+00015bf0: 4a55 5f56 4552 5349 4f4e 275d 203d 2027  JU_VERSION'] = '
+00015c00: 322e 362e 3927 0a20 2020 2020 2020 2077  2.6.9'.        w
+00015c10: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+00015c20: 6169 7365 7352 6567 6578 2852 756e 7469  aisesRegex(Runti
+00015c30: 6d65 4572 726f 722c 2027 6e6f 7420 7375  meError, 'not su
+00015c40: 7070 6f72 7465 6420 6f6e 204a 756a 7520  pported on Juju 
+00015c50: 7665 7273 696f 6e20 322e 362e 3927 293a  version 2.6.9'):
+00015c60: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00015c70: 662e 6261 636b 656e 642e 7265 6c61 7469  f.backend.relati
+00015c80: 6f6e 5f67 6574 2831 2c20 2766 6f6f 2f30  on_get(1, 'foo/0
+00015c90: 272c 2069 735f 6170 703d 5472 7565 290a  ', is_app=True).
+00015ca0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00015cb0: 6572 7445 7175 616c 2866 616b 655f 7363  ertEqual(fake_sc
+00015cc0: 7269 7074 5f63 616c 6c73 2873 656c 6629  ript_calls(self)
+00015cd0: 2c20 5b5d 290a 0a20 2020 2064 6566 2074  , [])..    def t
+00015ce0: 6573 745f 7265 6c61 7469 6f6e 5f73 6574  est_relation_set
+00015cf0: 5f6a 756a 755f 7665 7273 696f 6e5f 7175  _juju_version_qu
+00015d00: 6972 6b73 2873 656c 6629 3a0a 2020 2020  irks(self):.    
+00015d10: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+00015d20: 6e75 7028 6f73 2e65 6e76 6972 6f6e 2e70  nup(os.environ.p
+00015d30: 6f70 2c20 274a 554a 555f 5645 5253 494f  op, 'JUJU_VERSIO
+00015d40: 4e27 2c20 4e6f 6e65 290a 0a20 2020 2020  N', None)..     
+00015d50: 2020 2023 206f 6e20 322e 372e 302b 2c20     # on 2.7.0+, 
+00015d60: 7468 696e 6773 2070 726f 6365 6564 2061  things proceed a
+00015d70: 7320 6578 7065 6374 6564 0a20 2020 2020  s expected.     
+00015d80: 2020 2066 6f72 2076 2069 6e20 5b27 322e     for v in ['2.
+00015d90: 382e 3027 2c20 2732 2e37 2e30 275d 3a0a  8.0', '2.7.0']:.
+00015da0: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00015db0: 2073 656c 662e 7375 6254 6573 7428 7629   self.subTest(v)
+00015dc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015dd0: 2020 7420 3d20 7465 6d70 6669 6c65 2e4e    t = tempfile.N
+00015de0: 616d 6564 5465 6d70 6f72 6172 7946 696c  amedTemporaryFil
+00015df0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+00015e00: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00015e10: 2020 2020 2020 2020 2020 2020 2066 616b               fak
+00015e20: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
+00015e30: 7265 6c61 7469 6f6e 2d73 6574 272c 2064  relation-set', d
+00015e40: 6564 656e 7428 2222 220a 2020 2020 2020  edent(""".      
+00015e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015e60: 2020 6361 7420 3e3e 207b 7d0a 2020 2020    cat >> {}.    
+00015e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015e80: 2020 2020 2222 2229 2e66 6f72 6d61 7428      """).format(
+00015e90: 7061 7468 6c69 622e 5061 7468 2874 2e6e  pathlib.Path(t.n
+00015ea0: 616d 6529 2e61 735f 706f 7369 7828 2929  ame).as_posix())
+00015eb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00015ec0: 2020 2020 2020 6f73 2e65 6e76 6972 6f6e        os.environ
+00015ed0: 5b27 4a55 4a55 5f56 4552 5349 4f4e 275d  ['JUJU_VERSION']
+00015ee0: 203d 2076 0a20 2020 2020 2020 2020 2020   = v.           
+00015ef0: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
+00015f00: 636b 656e 642e 7265 6c61 7469 6f6e 5f73  ckend.relation_s
+00015f10: 6574 2831 2c20 2766 6f6f 272c 2027 6261  et(1, 'foo', 'ba
+00015f20: 7227 2c20 6973 5f61 7070 3d54 7275 6529  r', is_app=True)
+00015f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015f40: 2020 2020 2063 616c 6c73 203d 205b 2720       calls = [' 
+00015f50: 272e 6a6f 696e 2869 2920 666f 7220 6920  '.join(i) for i 
+00015f60: 696e 2066 616b 655f 7363 7269 7074 5f63  in fake_script_c
+00015f70: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
+00015f80: 3d54 7275 6529 5d0a 2020 2020 2020 2020  =True)].        
+00015f90: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00015fa0: 2e61 7373 6572 7445 7175 616c 2863 616c  .assertEqual(cal
+00015fb0: 6c73 2c20 5b27 7265 6c61 7469 6f6e 2d73  ls, ['relation-s
+00015fc0: 6574 202d 7220 3120 2d2d 6170 7020 2d2d  et -r 1 --app --
+00015fd0: 6669 6c65 202d 275d 290a 2020 2020 2020  file -']).      
+00015fe0: 2020 2020 2020 2020 2020 2020 2020 742e                t.
+00015ff0: 7365 656b 2830 290a 2020 2020 2020 2020  seek(0).        
+00016000: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00016010: 656e 7420 3d20 742e 7265 6164 2829 0a20  ent = t.read(). 
+00016020: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00016030: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
+00016040: 2020 2020 2020 2020 2020 2020 742e 636c              t.cl
+00016050: 6f73 6528 290a 2020 2020 2020 2020 2020  ose().          
+00016060: 2020 2020 2020 6465 636f 6465 6420 3d20        decoded = 
+00016070: 636f 6e74 656e 742e 6465 636f 6465 2827  content.decode('
+00016080: 7574 662d 3827 292e 7265 706c 6163 6528  utf-8').replace(
+00016090: 275c 725c 6e27 2c20 275c 6e27 290a 2020  '\r\n', '\n').  
+000160a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000160b0: 6c66 2e61 7373 6572 7445 7175 616c 2864  lf.assertEqual(d
+000160c0: 6563 6f64 6564 2c20 2766 6f6f 3a20 6261  ecoded, 'foo: ba
+000160d0: 725c 6e27 290a 0a20 2020 2020 2020 2023  r\n')..        #
+000160e0: 2062 6566 6f72 6520 322e 372e 302c 2069   before 2.7.0, i
+000160f0: 7420 6a75 7374 2066 6169 6c73 2061 6c77  t just fails alw
+00016100: 6179 7320 286e 6f20 2d2d 6170 7020 7375  ays (no --app su
+00016110: 7070 6f72 7429 0a20 2020 2020 2020 206f  pport).        o
+00016120: 732e 656e 7669 726f 6e5b 274a 554a 555f  s.environ['JUJU_
+00016130: 5645 5253 494f 4e27 5d20 3d20 2732 2e36  VERSION'] = '2.6
+00016140: 2e39 270a 2020 2020 2020 2020 7769 7468  .9'.        with
+00016150: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+00016160: 6573 5265 6765 7828 5275 6e74 696d 6545  esRegex(RuntimeE
+00016170: 7272 6f72 2c20 276e 6f74 2073 7570 706f  rror, 'not suppo
+00016180: 7274 6564 206f 6e20 4a75 6a75 2076 6572  rted on Juju ver
+00016190: 7369 6f6e 2032 2e36 2e39 2729 3a0a 2020  sion 2.6.9'):.  
+000161a0: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
+000161b0: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
+000161c0: 7365 7428 312c 2027 666f 6f27 2c20 2762  set(1, 'foo', 'b
+000161d0: 6172 272c 2069 735f 6170 703d 5472 7565  ar', is_app=True
+000161e0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000161f0: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
+00016200: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
+00016210: 6629 2c20 5b5d 290a 0a20 2020 2064 6566  f), [])..    def
+00016220: 2074 6573 745f 7374 6174 7573 5f67 6574   test_status_get
+00016230: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00016240: 2320 7461 6b65 6e20 6672 6f6d 2061 6374  # taken from act
+00016250: 7561 6c20 4a75 6a75 206f 7574 7075 740a  ual Juju output.
+00016260: 2020 2020 2020 2020 636f 6e74 656e 7420          content 
+00016270: 3d20 277b 226d 6573 7361 6765 223a 2022  = '{"message": "
+00016280: 222c 2022 7374 6174 7573 223a 2022 756e  ", "status": "un
+00016290: 6b6e 6f77 6e22 2c20 2273 7461 7475 732d  known", "status-
+000162a0: 6461 7461 223a 207b 7d7d 270a 2020 2020  data": {}}'.    
+000162b0: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+000162c0: 7365 6c66 2c20 2773 7461 7475 732d 6765  self, 'status-ge
+000162d0: 7427 2c20 6622 6563 686f 2027 7b63 6f6e  t', f"echo '{con
+000162e0: 7465 6e74 7d27 2229 0a20 2020 2020 2020  tent}'").       
+000162f0: 2073 203d 2073 656c 662e 6261 636b 656e   s = self.backen
+00016300: 642e 7374 6174 7573 5f67 6574 2869 735f  d.status_get(is_
+00016310: 6170 703d 4661 6c73 6529 0a20 2020 2020  app=False).     
+00016320: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00016330: 7561 6c28 735b 2773 7461 7475 7327 5d2c  ual(s['status'],
+00016340: 2022 756e 6b6e 6f77 6e22 290a 2020 2020   "unknown").    
+00016350: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00016360: 7175 616c 2873 5b27 6d65 7373 6167 6527  qual(s['message'
+00016370: 5d2c 2022 2229 0a20 2020 2020 2020 2023  ], "").        #
+00016380: 2074 616b 656e 2066 726f 6d20 6163 7475   taken from actu
+00016390: 616c 204a 756a 7520 6f75 7470 7574 0a20  al Juju output. 
+000163a0: 2020 2020 2020 2063 6f6e 7465 6e74 203d         content =
+000163b0: 2064 6564 656e 7428 2222 220a 2020 2020   dedent(""".    
+000163c0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000163d0: 2020 2020 2020 2020 2020 2261 7070 6c69            "appli
+000163e0: 6361 7469 6f6e 2d73 7461 7475 7322 3a20  cation-status": 
+000163f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00016400: 2020 2020 2020 226d 6573 7361 6765 223a        "message":
+00016410: 2022 696e 7374 616c 6c69 6e67 222c 0a20   "installing",. 
+00016420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016430: 2020 2022 7374 6174 7573 223a 2022 6d61     "status": "ma
+00016440: 696e 7465 6e61 6e63 6522 2c0a 2020 2020  intenance",.    
+00016450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016460: 2273 7461 7475 732d 6461 7461 223a 207b  "status-data": {
+00016470: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00016480: 2020 2020 2020 2022 756e 6974 7322 3a20         "units": 
+00016490: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000164a0: 2020 2020 2020 2020 2020 2275 6f2f 3022            "uo/0"
+000164b0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+000164c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000164d0: 226d 6573 7361 6765 223a 2022 222c 0a20  "message": "",. 
+000164e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000164f0: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
+00016500: 7573 223a 2022 6163 7469 7665 222c 0a20  us": "active",. 
+00016510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016520: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
+00016530: 7573 2d64 6174 6122 3a20 7b7d 0a20 2020  us-data": {}.   
+00016540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016550: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00016560: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00016570: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+00016580: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00016590: 2020 2020 2020 2020 2022 2222 290a 2020           """).  
+000165a0: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
+000165b0: 7428 7365 6c66 2c20 2773 7461 7475 732d  t(self, 'status-
+000165c0: 6765 7427 2c20 6622 6563 686f 2027 7b63  get', f"echo '{c
+000165d0: 6f6e 7465 6e74 7d27 2229 0a20 2020 2020  ontent}'").     
+000165e0: 2020 2073 203d 2073 656c 662e 6261 636b     s = self.back
+000165f0: 656e 642e 7374 6174 7573 5f67 6574 2869  end.status_get(i
+00016600: 735f 6170 703d 5472 7565 290a 2020 2020  s_app=True).    
+00016610: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00016620: 7175 616c 2873 5b27 7374 6174 7573 275d  qual(s['status']
+00016630: 2c20 226d 6169 6e74 656e 616e 6365 2229  , "maintenance")
+00016640: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00016650: 7365 7274 4571 7561 6c28 735b 276d 6573  sertEqual(s['mes
+00016660: 7361 6765 275d 2c20 2269 6e73 7461 6c6c  sage'], "install
+00016670: 696e 6722 290a 2020 2020 2020 2020 7365  ing").        se
+00016680: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
+00016690: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
+000166a0: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
+000166b0: 6529 2c20 5b0a 2020 2020 2020 2020 2020  e), [.          
+000166c0: 2020 5b27 7374 6174 7573 2d67 6574 272c    ['status-get',
+000166d0: 2027 2d2d 696e 636c 7564 652d 6461 7461   '--include-data
+000166e0: 272c 2027 2d2d 6170 706c 6963 6174 696f  ', '--applicatio
+000166f0: 6e3d 4661 6c73 6527 2c20 272d 2d66 6f72  n=False', '--for
+00016700: 6d61 743d 6a73 6f6e 275d 2c0a 2020 2020  mat=json'],.    
+00016710: 2020 2020 2020 2020 5b27 7374 6174 7573          ['status
+00016720: 2d67 6574 272c 2027 2d2d 696e 636c 7564  -get', '--includ
+00016730: 652d 6461 7461 272c 2027 2d2d 6170 706c  e-data', '--appl
+00016740: 6963 6174 696f 6e3d 5472 7565 272c 2027  ication=True', '
+00016750: 2d2d 666f 726d 6174 3d6a 736f 6e27 5d2c  --format=json'],
+00016760: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
+00016770: 2064 6566 2074 6573 745f 7374 6174 7573   def test_status
+00016780: 5f69 735f 6170 705f 666f 7263 6564 5f6b  _is_app_forced_k
+00016790: 7761 7267 7328 7365 6c66 293a 0a20 2020  wargs(self):.   
+000167a0: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+000167b0: 2873 656c 662c 2027 7374 6174 7573 2d67  (self, 'status-g
+000167c0: 6574 272c 2027 6578 6974 2031 2729 0a20  et', 'exit 1'). 
+000167d0: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+000167e0: 7074 2873 656c 662c 2027 7374 6174 7573  pt(self, 'status
+000167f0: 2d73 6574 272c 2027 6578 6974 2031 2729  -set', 'exit 1')
+00016800: 0a0a 2020 2020 2020 2020 7465 7374 5f63  ..        test_c
+00016810: 6173 6573 203d 2028 0a20 2020 2020 2020  ases = (.       
+00016820: 2020 2020 206c 616d 6264 613a 2073 656c       lambda: sel
+00016830: 662e 6261 636b 656e 642e 7374 6174 7573  f.backend.status
+00016840: 5f67 6574 2846 616c 7365 292c 0a20 2020  _get(False),.   
+00016850: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
+00016860: 2073 656c 662e 6261 636b 656e 642e 7374   self.backend.st
+00016870: 6174 7573 5f67 6574 2854 7275 6529 2c0a  atus_get(True),.
+00016880: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
+00016890: 6461 3a20 7365 6c66 2e62 6163 6b65 6e64  da: self.backend
+000168a0: 2e73 7461 7475 735f 7365 7428 2761 6374  .status_set('act
+000168b0: 6976 6527 2c20 2727 2c20 4661 6c73 6529  ive', '', False)
+000168c0: 2c0a 2020 2020 2020 2020 2020 2020 6c61  ,.            la
+000168d0: 6d62 6461 3a20 7365 6c66 2e62 6163 6b65  mbda: self.backe
+000168e0: 6e64 2e73 7461 7475 735f 7365 7428 2761  nd.status_set('a
+000168f0: 6374 6976 6527 2c20 2727 2c20 5472 7565  ctive', '', True
+00016900: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
+00016910: 2020 2020 2020 666f 7220 6361 7365 2069        for case i
+00016920: 6e20 7465 7374 5f63 6173 6573 3a0a 2020  n test_cases:.  
+00016930: 2020 2020 2020 2020 2020 7769 7468 2073            with s
+00016940: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+00016950: 2854 7970 6545 7272 6f72 293a 0a20 2020  (TypeError):.   
+00016960: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+00016970: 6528 290a 0a20 2020 2064 6566 2074 6573  e()..    def tes
+00016980: 745f 6c6f 6361 6c5f 7365 745f 696e 7661  t_local_set_inva
+00016990: 6c69 645f 7374 6174 7573 2873 656c 6629  lid_status(self)
+000169a0: 3a0a 2020 2020 2020 2020 2320 6a75 6a75  :.        # juju
+000169b0: 2072 6574 7572 6e73 2065 7869 7420 636f   returns exit co
+000169c0: 6465 2031 2069 6620 796f 7520 6173 6b20  de 1 if you ask 
+000169d0: 746f 2073 6574 2073 7461 7475 7320 746f  to set status to
+000169e0: 2027 756e 6b6e 6f77 6e27 206f 7220 2765   'unknown' or 'e
+000169f0: 7272 6f72 270a 2020 2020 2020 2020 6d65  rror'.        me
+00016a00: 7461 203d 206f 7073 2e43 6861 726d 4d65  ta = ops.CharmMe
+00016a10: 7461 2e66 726f 6d5f 7961 6d6c 2827 2727  ta.from_yaml('''
+00016a20: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+00016a30: 653a 206d 7961 7070 0a20 2020 2020 2020  e: myapp.       
+00016a40: 2027 2727 290a 2020 2020 2020 2020 6d6f   ''').        mo
+00016a50: 6465 6c20 3d20 6f70 732e 4d6f 6465 6c28  del = ops.Model(
+00016a60: 6d65 7461 2c20 7365 6c66 2e62 6163 6b65  meta, self.backe
+00016a70: 6e64 290a 2020 2020 2020 2020 6661 6b65  nd).        fake
+00016a80: 5f73 6372 6970 7428 7365 6c66 2c20 2773  _script(self, 's
+00016a90: 7461 7475 732d 7365 7427 2c20 2765 7869  tatus-set', 'exi
+00016aa0: 7420 3127 290a 2020 2020 2020 2020 6661  t 1').        fa
+00016ab0: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+00016ac0: 2769 732d 6c65 6164 6572 272c 2027 6563  'is-leader', 'ec
+00016ad0: 686f 2074 7275 6527 290a 0a20 2020 2020  ho true')..     
+00016ae0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00016af0: 6572 7452 6169 7365 7328 6f70 732e 4d6f  ertRaises(ops.Mo
+00016b00: 6465 6c45 7272 6f72 293a 0a20 2020 2020  delError):.     
+00016b10: 2020 2020 2020 206d 6f64 656c 2e75 6e69         model.uni
+00016b20: 742e 7374 6174 7573 203d 206f 7073 2e55  t.status = ops.U
+00016b30: 6e6b 6e6f 776e 5374 6174 7573 2829 0a20  nknownStatus(). 
+00016b40: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00016b50: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
+00016b60: 732e 4d6f 6465 6c45 7272 6f72 293a 0a20  s.ModelError):. 
+00016b70: 2020 2020 2020 2020 2020 206d 6f64 656c             model
+00016b80: 2e75 6e69 742e 7374 6174 7573 203d 206f  .unit.status = o
+00016b90: 7073 2e45 7272 6f72 5374 6174 7573 2829  ps.ErrorStatus()
+00016ba0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+00016bb0: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
+00016bc0: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
+00016bd0: 662c 2054 7275 6529 2c20 5b0a 2020 2020  f, True), [.    
+00016be0: 2020 2020 2020 2020 5b27 7374 6174 7573          ['status
+00016bf0: 2d73 6574 272c 2027 2d2d 6170 706c 6963  -set', '--applic
+00016c00: 6174 696f 6e3d 4661 6c73 6527 2c20 2775  ation=False', 'u
+00016c10: 6e6b 6e6f 776e 272c 2027 275d 2c0a 2020  nknown', ''],.  
+00016c20: 2020 2020 2020 2020 2020 5b27 7374 6174            ['stat
+00016c30: 7573 2d73 6574 272c 2027 2d2d 6170 706c  us-set', '--appl
+00016c40: 6963 6174 696f 6e3d 4661 6c73 6527 2c20  ication=False', 
+00016c50: 2765 7272 6f72 272c 2027 275d 2c0a 2020  'error', ''],.  
+00016c60: 2020 2020 2020 5d29 0a0a 2020 2020 2020        ])..      
+00016c70: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+00016c80: 7274 5261 6973 6573 286f 7073 2e4d 6f64  rtRaises(ops.Mod
+00016c90: 656c 4572 726f 7229 3a0a 2020 2020 2020  elError):.      
+00016ca0: 2020 2020 2020 6d6f 6465 6c2e 6170 702e        model.app.
+00016cb0: 7374 6174 7573 203d 206f 7073 2e55 6e6b  status = ops.Unk
+00016cc0: 6e6f 776e 5374 6174 7573 2829 0a20 2020  nownStatus().   
+00016cd0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+00016ce0: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
+00016cf0: 4d6f 6465 6c45 7272 6f72 293a 0a20 2020  ModelError):.   
+00016d00: 2020 2020 2020 2020 206d 6f64 656c 2e61           model.a
+00016d10: 7070 2e73 7461 7475 7320 3d20 6f70 732e  pp.status = ops.
+00016d20: 4572 726f 7253 7461 7475 7328 290a 0a20  ErrorStatus().. 
+00016d30: 2020 2020 2020 2023 2041 206c 6561 6465         # A leade
+00016d40: 7273 6869 7020 6368 6563 6b20 6973 206e  rship check is n
+00016d50: 6565 6465 6420 666f 7220 6170 706c 6963  eeded for applic
+00016d60: 6174 696f 6e20 7374 6174 7573 2e0a 2020  ation status..  
+00016d70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00016d80: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
+00016d90: 7074 5f63 616c 6c73 2873 656c 662c 2054  pt_calls(self, T
+00016da0: 7275 6529 2c20 5b0a 2020 2020 2020 2020  rue), [.        
+00016db0: 2020 2020 5b27 6973 2d6c 6561 6465 7227      ['is-leader'
+00016dc0: 2c20 272d 2d66 6f72 6d61 743d 6a73 6f6e  , '--format=json
+00016dd0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+00016de0: 5b27 7374 6174 7573 2d73 6574 272c 2027  ['status-set', '
+00016df0: 2d2d 6170 706c 6963 6174 696f 6e3d 5472  --application=Tr
+00016e00: 7565 272c 2027 756e 6b6e 6f77 6e27 2c20  ue', 'unknown', 
+00016e10: 2727 5d2c 0a20 2020 2020 2020 2020 2020  ''],.           
+00016e20: 205b 2773 7461 7475 732d 7365 7427 2c20   ['status-set', 
+00016e30: 272d 2d61 7070 6c69 6361 7469 6f6e 3d54  '--application=T
+00016e40: 7275 6527 2c20 2765 7272 6f72 272c 2027  rue', 'error', '
+00016e50: 275d 2c0a 2020 2020 2020 2020 5d29 0a0a  '],.        ])..
+00016e60: 2020 2020 6465 6620 7465 7374 5f6c 6f63      def test_loc
+00016e70: 616c 5f67 6574 5f73 7461 7475 7328 7365  al_get_status(se
+00016e80: 6c66 293a 0a20 2020 2020 2020 2066 6f72  lf):.        for
+00016e90: 206e 616d 652c 2065 7870 6563 7465 645f   name, expected_
+00016ea0: 636c 7320 696e 2028 0a20 2020 2020 2020  cls in (.       
+00016eb0: 2020 2020 2028 2261 6374 6976 6522 2c20       ("active", 
+00016ec0: 6f70 732e 4163 7469 7665 5374 6174 7573  ops.ActiveStatus
+00016ed0: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+00016ee0: 2277 6169 7469 6e67 222c 206f 7073 2e57  "waiting", ops.W
+00016ef0: 6169 7469 6e67 5374 6174 7573 292c 0a20  aitingStatus),. 
+00016f00: 2020 2020 2020 2020 2020 2028 2262 6c6f             ("blo
+00016f10: 636b 6564 222c 206f 7073 2e42 6c6f 636b  cked", ops.Block
+00016f20: 6564 5374 6174 7573 292c 0a20 2020 2020  edStatus),.     
+00016f30: 2020 2020 2020 2028 226d 6169 6e74 656e         ("mainten
+00016f40: 616e 6365 222c 206f 7073 2e4d 6169 6e74  ance", ops.Maint
+00016f50: 656e 616e 6365 5374 6174 7573 292c 0a20  enanceStatus),. 
+00016f60: 2020 2020 2020 2020 2020 2028 2265 7272             ("err
+00016f70: 6f72 222c 206f 7073 2e45 7272 6f72 5374  or", ops.ErrorSt
+00016f80: 6174 7573 292c 0a20 2020 2020 2020 2029  atus),.        )
+00016f90: 3a0a 2020 2020 2020 2020 2020 2020 6d65  :.            me
+00016fa0: 7461 203d 206f 7073 2e43 6861 726d 4d65  ta = ops.CharmMe
+00016fb0: 7461 2e66 726f 6d5f 7961 6d6c 2827 2727  ta.from_yaml('''
+00016fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016fd0: 206e 616d 653a 206d 7961 7070 0a20 2020   name: myapp.   
+00016fe0: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
+00016ff0: 2020 2020 2020 2020 2020 6d6f 6465 6c20            model 
+00017000: 3d20 6f70 732e 4d6f 6465 6c28 6d65 7461  = ops.Model(meta
+00017010: 2c20 7365 6c66 2e62 6163 6b65 6e64 290a  , self.backend).
+00017020: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
+00017030: 6820 7365 6c66 2e73 7562 5465 7374 286e  h self.subTest(n
+00017040: 616d 6529 3a0a 2020 2020 2020 2020 2020  ame):.          
+00017050: 2020 2020 2020 636f 6e74 656e 7420 3d20        content = 
+00017060: 6a73 6f6e 2e64 756d 7073 287b 0a20 2020  json.dumps({.   
+00017070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017080: 2022 6d65 7373 6167 6522 3a20 2266 6f6f   "message": "foo
+00017090: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+000170a0: 2020 2020 2020 2022 7374 6174 7573 223a         "status":
+000170b0: 206e 616d 652c 0a20 2020 2020 2020 2020   name,.         
+000170c0: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
+000170d0: 7573 2d64 6174 6122 3a20 7b7d 2c0a 2020  us-data": {},.  
+000170e0: 2020 2020 2020 2020 2020 2020 2020 7d29                })
+000170f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017100: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+00017110: 662c 2027 7374 6174 7573 2d67 6574 272c  f, 'status-get',
+00017120: 2066 2265 6368 6f20 277b 636f 6e74 656e   f"echo '{conten
+00017130: 747d 2722 290a 0a20 2020 2020 2020 2020  t}'")..         
+00017140: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00017150: 7274 4973 496e 7374 616e 6365 286d 6f64  rtIsInstance(mod
+00017160: 656c 2e75 6e69 742e 7374 6174 7573 2c20  el.unit.status, 
+00017170: 6578 7065 6374 6564 5f63 6c73 290a 2020  expected_cls).  
+00017180: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00017190: 6c66 2e61 7373 6572 7445 7175 616c 286d  lf.assertEqual(m
+000171a0: 6f64 656c 2e75 6e69 742e 7374 6174 7573  odel.unit.status
+000171b0: 2e6e 616d 652c 206e 616d 6529 0a20 2020  .name, name).   
+000171c0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+000171d0: 662e 6173 7365 7274 4571 7561 6c28 6d6f  f.assertEqual(mo
+000171e0: 6465 6c2e 756e 6974 2e73 7461 7475 732e  del.unit.status.
+000171f0: 6d65 7373 6167 652c 2022 666f 6f22 290a  message, "foo").
+00017200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017210: 2063 6f6e 7465 6e74 203d 206a 736f 6e2e   content = json.
+00017220: 6475 6d70 7328 7b0a 2020 2020 2020 2020  dumps({.        
+00017230: 2020 2020 2020 2020 2020 2020 2261 7070              "app
+00017240: 6c69 6361 7469 6f6e 2d73 7461 7475 7322  lication-status"
+00017250: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+00017260: 2020 2020 2020 2020 2020 2020 226d 6573              "mes
+00017270: 7361 6765 223a 2022 6261 7222 2c0a 2020  sage": "bar",.  
+00017280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017290: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
+000172a0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+000172b0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+000172c0: 7461 7475 732d 6461 7461 223a 207b 7d2c  tatus-data": {},
+000172d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000172e0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+000172f0: 2020 2020 2020 207d 290a 2020 2020 2020         }).      
+00017300: 2020 2020 2020 2020 2020 6661 6b65 5f73            fake_s
+00017310: 6372 6970 7428 7365 6c66 2c20 2773 7461  cript(self, 'sta
+00017320: 7475 732d 6765 7427 2c20 6622 6563 686f  tus-get', f"echo
+00017330: 2027 7b63 6f6e 7465 6e74 7d27 2229 0a20   '{content}'"). 
+00017340: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00017350: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+00017360: 2027 6973 2d6c 6561 6465 7227 2c20 2765   'is-leader', 'e
+00017370: 6368 6f20 7472 7565 2729 0a0a 2020 2020  cho true')..    
+00017380: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00017390: 2e61 7373 6572 7449 7349 6e73 7461 6e63  .assertIsInstanc
+000173a0: 6528 6d6f 6465 6c2e 6170 702e 7374 6174  e(model.app.stat
+000173b0: 7573 2c20 6578 7065 6374 6564 5f63 6c73  us, expected_cls
+000173c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000173d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000173e0: 616c 286d 6f64 656c 2e61 7070 2e73 7461  al(model.app.sta
+000173f0: 7475 732e 6e61 6d65 2c20 6e61 6d65 290a  tus.name, name).
+00017400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017410: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00017420: 286d 6f64 656c 2e61 7070 2e73 7461 7475  (model.app.statu
+00017430: 732e 6d65 7373 6167 652c 2022 6261 7222  s.message, "bar"
+00017440: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00017450: 7374 6174 7573 5f73 6574 5f69 735f 6170  status_set_is_ap
+00017460: 705f 6e6f 745f 626f 6f6c 5f72 6169 7365  p_not_bool_raise
+00017470: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+00017480: 2066 6f72 2069 735f 6170 705f 7620 696e   for is_app_v in
+00017490: 205b 4e6f 6e65 2c20 312c 2032 2e30 2c20   [None, 1, 2.0, 
+000174a0: 2761 272c 2062 2762 6565 6627 2c20 6f62  'a', b'beef', ob
+000174b0: 6a65 6374 5d3a 0a20 2020 2020 2020 2020  ject]:.         
+000174c0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+000174d0: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
+000174e0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+000174f0: 2020 2020 2020 7365 6c66 2e62 6163 6b65        self.backe
+00017500: 6e64 2e73 7461 7475 735f 7365 7428 6f70  nd.status_set(op
+00017510: 732e 4163 7469 7665 5374 6174 7573 2c20  s.ActiveStatus, 
+00017520: 6973 5f61 7070 3d69 735f 6170 705f 7629  is_app=is_app_v)
+00017530: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
+00017540: 746f 7261 6765 5f74 6f6f 6c5f 6572 726f  torage_tool_erro
+00017550: 7273 2873 656c 6629 3a0a 2020 2020 2020  rs(self):.      
+00017560: 2020 7465 7374 5f63 6173 6573 203d 205b    test_cases = [
+00017570: 280a 2020 2020 2020 2020 2020 2020 6c61  (.            la
+00017580: 6d62 6461 3a20 6661 6b65 5f73 6372 6970  mbda: fake_scrip
+00017590: 7428 7365 6c66 2c20 2773 746f 7261 6765  t(self, 'storage
+000175a0: 2d6c 6973 7427 2c20 2765 6368 6f20 666f  -list', 'echo fo
+000175b0: 6f65 7272 6f72 203e 2632 203b 2065 7869  oerror >&2 ; exi
+000175c0: 7420 3127 292c 0a20 2020 2020 2020 2020  t 1'),.         
+000175d0: 2020 206c 616d 6264 613a 2073 656c 662e     lambda: self.
+000175e0: 6261 636b 656e 642e 7374 6f72 6167 655f  backend.storage_
+000175f0: 6c69 7374 2827 666f 6f62 6172 2729 2c0a  list('foobar'),.
+00017600: 2020 2020 2020 2020 2020 2020 6f70 732e              ops.
+00017610: 4d6f 6465 6c45 7272 6f72 2c0a 2020 2020  ModelError,.    
+00017620: 2020 2020 2020 2020 5b5b 2773 746f 7261          [['stora
+00017630: 6765 2d6c 6973 7427 2c20 2766 6f6f 6261  ge-list', 'fooba
+00017640: 7227 2c20 272d 2d66 6f72 6d61 743d 6a73  r', '--format=js
+00017650: 6f6e 275d 5d2c 0a20 2020 2020 2020 2029  on']],.        )
+00017660: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+00017670: 6c61 6d62 6461 3a20 6661 6b65 5f73 6372  lambda: fake_scr
+00017680: 6970 7428 7365 6c66 2c20 2773 746f 7261  ipt(self, 'stora
+00017690: 6765 2d67 6574 272c 2027 6563 686f 2066  ge-get', 'echo f
+000176a0: 6f6f 6572 726f 7220 3e26 3220 3b20 6578  ooerror >&2 ; ex
+000176b0: 6974 2031 2729 2c0a 2020 2020 2020 2020  it 1'),.        
+000176c0: 2020 2020 6c61 6d62 6461 3a20 7365 6c66      lambda: self
+000176d0: 2e62 6163 6b65 6e64 2e73 746f 7261 6765  .backend.storage
+000176e0: 5f67 6574 2827 666f 6f62 6172 272c 2027  _get('foobar', '
+000176f0: 736f 6d65 6174 7472 2729 2c0a 2020 2020  someattr'),.    
+00017700: 2020 2020 2020 2020 6f70 732e 4d6f 6465          ops.Mode
+00017710: 6c45 7272 6f72 2c0a 2020 2020 2020 2020  lError,.        
+00017720: 2020 2020 5b5b 2773 746f 7261 6765 2d67      [['storage-g
+00017730: 6574 272c 2027 2d73 272c 2027 666f 6f62  et', '-s', 'foob
+00017740: 6172 272c 2027 736f 6d65 6174 7472 272c  ar', 'someattr',
+00017750: 2027 2d2d 666f 726d 6174 3d6a 736f 6e27   '--format=json'
+00017760: 5d5d 2c0a 2020 2020 2020 2020 292c 2028  ]],.        ), (
+00017770: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
+00017780: 6264 613a 2066 616b 655f 7363 7269 7074  bda: fake_script
+00017790: 2873 656c 662c 2027 7374 6f72 6167 652d  (self, 'storage-
+000177a0: 6164 6427 2c20 2765 6368 6f20 666f 6f65  add', 'echo fooe
+000177b0: 7272 6f72 203e 2632 203b 2065 7869 7420  rror >&2 ; exit 
+000177c0: 3127 292c 0a20 2020 2020 2020 2020 2020  1'),.           
+000177d0: 206c 616d 6264 613a 2073 656c 662e 6261   lambda: self.ba
+000177e0: 636b 656e 642e 7374 6f72 6167 655f 6164  ckend.storage_ad
+000177f0: 6428 2766 6f6f 6261 7227 2c20 636f 756e  d('foobar', coun
+00017800: 743d 3229 2c0a 2020 2020 2020 2020 2020  t=2),.          
+00017810: 2020 6f70 732e 4d6f 6465 6c45 7272 6f72    ops.ModelError
+00017820: 2c0a 2020 2020 2020 2020 2020 2020 5b5b  ,.            [[
+00017830: 2773 746f 7261 6765 2d61 6464 272c 2027  'storage-add', '
+00017840: 666f 6f62 6172 3d32 275d 5d2c 0a20 2020  foobar=2']],.   
+00017850: 2020 2020 2029 2c20 280a 2020 2020 2020       ), (.      
+00017860: 2020 2020 2020 6c61 6d62 6461 3a20 6661        lambda: fa
+00017870: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+00017880: 2773 746f 7261 6765 2d61 6464 272c 2027  'storage-add', '
+00017890: 6563 686f 2066 6f6f 6572 726f 7220 3e26  echo fooerror >&
+000178a0: 3220 3b20 6578 6974 2031 2729 2c0a 2020  2 ; exit 1'),.  
+000178b0: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
+000178c0: 3a20 7365 6c66 2e62 6163 6b65 6e64 2e73  : self.backend.s
+000178d0: 746f 7261 6765 5f61 6464 2827 666f 6f62  torage_add('foob
+000178e0: 6172 272c 2063 6f75 6e74 3d6f 626a 6563  ar', count=objec
+000178f0: 7429 2c0a 2020 2020 2020 2020 2020 2020  t),.            
+00017900: 5479 7065 4572 726f 722c 0a20 2020 2020  TypeError,.     
+00017910: 2020 2020 2020 205b 5d2c 0a20 2020 2020         [],.     
+00017920: 2020 2029 2c20 280a 2020 2020 2020 2020     ), (.        
+00017930: 2020 2020 6c61 6d62 6461 3a20 6661 6b65      lambda: fake
+00017940: 5f73 6372 6970 7428 7365 6c66 2c20 2773  _script(self, 's
+00017950: 746f 7261 6765 2d61 6464 272c 2027 6563  torage-add', 'ec
+00017960: 686f 2066 6f6f 6572 726f 7220 3e26 3220  ho fooerror >&2 
+00017970: 3b20 6578 6974 2031 2729 2c0a 2020 2020  ; exit 1'),.    
+00017980: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
+00017990: 7365 6c66 2e62 6163 6b65 6e64 2e73 746f  self.backend.sto
+000179a0: 7261 6765 5f61 6464 2827 666f 6f62 6172  rage_add('foobar
+000179b0: 272c 2063 6f75 6e74 3d54 7275 6529 2c0a  ', count=True),.
+000179c0: 2020 2020 2020 2020 2020 2020 5479 7065              Type
+000179d0: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
+000179e0: 2020 205b 5d2c 0a20 2020 2020 2020 2029     [],.        )
+000179f0: 5d0a 2020 2020 2020 2020 666f 7220 646f  ].        for do
+00017a00: 5f66 616b 652c 2072 756e 2c20 6578 6365  _fake, run, exce
+00017a10: 7074 696f 6e2c 2063 616c 6c73 2069 6e20  ption, calls in 
+00017a20: 7465 7374 5f63 6173 6573 3a0a 2020 2020  test_cases:.    
+00017a30: 2020 2020 2020 2020 646f 5f66 616b 6528          do_fake(
+00017a40: 290a 2020 2020 2020 2020 2020 2020 7769  ).            wi
+00017a50: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+00017a60: 6973 6573 2865 7863 6570 7469 6f6e 293a  ises(exception):
+00017a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017a80: 2072 756e 2829 0a20 2020 2020 2020 2020   run().         
+00017a90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00017aa0: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
+00017ab0: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
+00017ac0: 723d 5472 7565 292c 2063 616c 6c73 290a  r=True), calls).
+00017ad0: 0a20 2020 2064 6566 2074 6573 745f 6e65  .    def test_ne
+00017ae0: 7477 6f72 6b5f 6765 7428 7365 6c66 293a  twork_get(self):
+00017af0: 0a20 2020 2020 2020 206e 6574 776f 726b  .        network
+00017b00: 5f67 6574 5f6f 7574 203d 2027 2727 7b0a  _get_out = '''{.
+00017b10: 2020 2262 696e 642d 6164 6472 6573 7365    "bind-addresse
+00017b20: 7322 3a20 5b0a 2020 2020 7b0a 2020 2020  s": [.    {.    
+00017b30: 2020 226d 6163 2d61 6464 7265 7373 223a    "mac-address":
+00017b40: 2022 222c 0a20 2020 2020 2022 696e 7465   "",.      "inte
+00017b50: 7266 6163 652d 6e61 6d65 223a 2022 222c  rface-name": "",
+00017b60: 0a20 2020 2020 2022 6164 6472 6573 7365  .      "addresse
+00017b70: 7322 3a20 5b0a 2020 2020 2020 2020 7b0a  s": [.        {.
+00017b80: 2020 2020 2020 2020 2020 2268 6f73 746e            "hostn
+00017b90: 616d 6522 3a20 2222 2c0a 2020 2020 2020  ame": "",.      
+00017ba0: 2020 2020 2276 616c 7565 223a 2022 3139      "value": "19
+00017bb0: 322e 302e 322e 3222 2c0a 2020 2020 2020  2.0.2.2",.      
+00017bc0: 2020 2020 2263 6964 7222 3a20 2222 0a20      "cidr": "". 
+00017bd0: 2020 2020 2020 207d 0a20 2020 2020 205d         }.      ]
+00017be0: 0a20 2020 207d 0a20 205d 2c0a 2020 2265  .    }.  ],.  "e
+00017bf0: 6772 6573 732d 7375 626e 6574 7322 3a20  gress-subnets": 
+00017c00: 5b0a 2020 2020 2231 3932 2e30 2e32 2e32  [.    "192.0.2.2
+00017c10: 2f33 3222 0a20 205d 2c0a 2020 2269 6e67  /32".  ],.  "ing
+00017c20: 7265 7373 2d61 6464 7265 7373 6573 223a  ress-addresses":
+00017c30: 205b 0a20 2020 2022 3139 322e 302e 322e   [.    "192.0.2.
+00017c40: 3222 0a20 205d 0a7d 2727 270a 2020 2020  2".  ].}'''.    
+00017c50: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+00017c60: 7365 6c66 2c20 276e 6574 776f 726b 2d67  self, 'network-g
+00017c70: 6574 272c 0a20 2020 2020 2020 2020 2020  et',.           
+00017c80: 2020 2020 2020 2020 2066 2727 275b 2022           f'''[ "
+00017c90: 2431 2220 3d20 6465 6164 6265 6566 205d  $1" = deadbeef ]
+00017ca0: 2026 2620 6563 686f 2027 7b6e 6574 776f   && echo '{netwo
+00017cb0: 726b 5f67 6574 5f6f 7574 7d27 207c 7c20  rk_get_out}' || 
+00017cc0: 6578 6974 2031 2727 2729 0a20 2020 2020  exit 1''').     
+00017cd0: 2020 206e 6574 776f 726b 5f69 6e66 6f20     network_info 
+00017ce0: 3d20 7365 6c66 2e62 6163 6b65 6e64 2e6e  = self.backend.n
+00017cf0: 6574 776f 726b 5f67 6574 2827 6465 6164  etwork_get('dead
+00017d00: 6265 6566 2729 0a20 2020 2020 2020 2073  beef').        s
+00017d10: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00017d20: 6e65 7477 6f72 6b5f 696e 666f 2c20 6a73  network_info, js
+00017d30: 6f6e 2e6c 6f61 6473 286e 6574 776f 726b  on.loads(network
+00017d40: 5f67 6574 5f6f 7574 2929 0a20 2020 2020  _get_out)).     
+00017d50: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00017d60: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
+00017d70: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
+00017d80: 723d 5472 7565 292c 0a20 2020 2020 2020  r=True),.       
+00017d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017da0: 2020 5b5b 276e 6574 776f 726b 2d67 6574    [['network-get
+00017db0: 272c 2027 6465 6164 6265 6566 272c 2027  ', 'deadbeef', '
+00017dc0: 2d2d 666f 726d 6174 3d6a 736f 6e27 5d5d  --format=json']]
+00017dd0: 290a 0a20 2020 2020 2020 206e 6574 776f  )..        netwo
+00017de0: 726b 5f69 6e66 6f20 3d20 7365 6c66 2e62  rk_info = self.b
+00017df0: 6163 6b65 6e64 2e6e 6574 776f 726b 5f67  ackend.network_g
+00017e00: 6574 2827 6465 6164 6265 6566 272c 2031  et('deadbeef', 1
+00017e10: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00017e20: 7373 6572 7445 7175 616c 286e 6574 776f  ssertEqual(netwo
+00017e30: 726b 5f69 6e66 6f2c 206a 736f 6e2e 6c6f  rk_info, json.lo
+00017e40: 6164 7328 6e65 7477 6f72 6b5f 6765 745f  ads(network_get_
+00017e50: 6f75 7429 290a 2020 2020 2020 2020 7365  out)).        se
+00017e60: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
+00017e70: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
+00017e80: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
+00017e90: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00017ea0: 2020 2020 2020 2020 2020 2020 205b 5b27               [['
+00017eb0: 6e65 7477 6f72 6b2d 6765 7427 2c20 2764  network-get', 'd
+00017ec0: 6561 6462 6565 6627 2c20 272d 7227 2c20  eadbeef', '-r', 
+00017ed0: 2731 272c 2027 2d2d 666f 726d 6174 3d6a  '1', '--format=j
+00017ee0: 736f 6e27 5d5d 290a 0a20 2020 2064 6566  son']])..    def
+00017ef0: 2074 6573 745f 6e65 7477 6f72 6b5f 6765   test_network_ge
+00017f00: 745f 6572 726f 7273 2873 656c 6629 3a0a  t_errors(self):.
+00017f10: 2020 2020 2020 2020 6572 725f 6e6f 5f65          err_no_e
+00017f20: 6e64 706f 696e 7420 3d20 2745 5252 4f52  ndpoint = 'ERROR
+00017f30: 206e 6f20 6e65 7477 6f72 6b20 636f 6e66   no network conf
+00017f40: 6967 2066 6f75 6e64 2066 6f72 2062 696e  ig found for bin
+00017f50: 6469 6e67 2022 2432 2227 0a20 2020 2020  ding "$2"'.     
+00017f60: 2020 2065 7272 5f6e 6f5f 7265 6c20 3d20     err_no_rel = 
+00017f70: 2745 5252 4f52 2069 6e76 616c 6964 2076  'ERROR invalid v
+00017f80: 616c 7565 2022 2433 2220 666f 7220 6f70  alue "$3" for op
+00017f90: 7469 6f6e 202d 723a 2072 656c 6174 696f  tion -r: relatio
+00017fa0: 6e20 6e6f 7420 666f 756e 6427 0a0a 2020  n not found'..  
+00017fb0: 2020 2020 2020 7465 7374 5f63 6173 6573        test_cases
+00017fc0: 203d 205b 280a 2020 2020 2020 2020 2020   = [(.          
+00017fd0: 2020 6c61 6d62 6461 3a20 6661 6b65 5f73    lambda: fake_s
+00017fe0: 6372 6970 7428 7365 6c66 2c20 276e 6574  cript(self, 'net
+00017ff0: 776f 726b 2d67 6574 272c 0a20 2020 2020  work-get',.     
+00018000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018010: 2020 2020 2020 2020 2020 2066 2765 6368             f'ech
+00018020: 6f20 7b65 7272 5f6e 6f5f 656e 6470 6f69  o {err_no_endpoi
+00018030: 6e74 7d20 3e26 3220 3b20 6578 6974 2031  nt} >&2 ; exit 1
+00018040: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00018050: 6c61 6d62 6461 3a20 7365 6c66 2e62 6163  lambda: self.bac
+00018060: 6b65 6e64 2e6e 6574 776f 726b 5f67 6574  kend.network_get
+00018070: 2822 6465 6164 6265 6566 2229 2c0a 2020  ("deadbeef"),.  
+00018080: 2020 2020 2020 2020 2020 6f70 732e 4d6f            ops.Mo
+00018090: 6465 6c45 7272 6f72 2c0a 2020 2020 2020  delError,.      
+000180a0: 2020 2020 2020 5b5b 276e 6574 776f 726b        [['network
+000180b0: 2d67 6574 272c 2027 6465 6164 6265 6566  -get', 'deadbeef
+000180c0: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
+000180d0: 6e27 5d5d 2c0a 2020 2020 2020 2020 292c  n']],.        ),
+000180e0: 2028 0a20 2020 2020 2020 2020 2020 206c   (.            l
+000180f0: 616d 6264 613a 2066 616b 655f 7363 7269  ambda: fake_scri
+00018100: 7074 2873 656c 662c 2027 6e65 7477 6f72  pt(self, 'networ
+00018110: 6b2d 6765 7427 2c20 6627 6563 686f 207b  k-get', f'echo {
+00018120: 6572 725f 6e6f 5f72 656c 7d20 3e26 3220  err_no_rel} >&2 
+00018130: 3b20 6578 6974 2032 2729 2c0a 2020 2020  ; exit 2'),.    
+00018140: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
+00018150: 7365 6c66 2e62 6163 6b65 6e64 2e6e 6574  self.backend.net
+00018160: 776f 726b 5f67 6574 2822 6465 6164 6265  work_get("deadbe
+00018170: 6566 222c 2033 292c 0a20 2020 2020 2020  ef", 3),.       
+00018180: 2020 2020 206f 7073 2e52 656c 6174 696f       ops.Relatio
+00018190: 6e4e 6f74 466f 756e 6445 7272 6f72 2c0a  nNotFoundError,.
+000181a0: 2020 2020 2020 2020 2020 2020 5b5b 276e              [['n
+000181b0: 6574 776f 726b 2d67 6574 272c 2027 6465  etwork-get', 'de
+000181c0: 6164 6265 6566 272c 2027 2d72 272c 2027  adbeef', '-r', '
+000181d0: 3327 2c20 272d 2d66 6f72 6d61 743d 6a73  3', '--format=js
+000181e0: 6f6e 275d 5d2c 0a20 2020 2020 2020 2029  on']],.        )
+000181f0: 5d0a 2020 2020 2020 2020 666f 7220 646f  ].        for do
+00018200: 5f66 616b 652c 2072 756e 2c20 6578 6365  _fake, run, exce
+00018210: 7074 696f 6e2c 2063 616c 6c73 2069 6e20  ption, calls in 
+00018220: 7465 7374 5f63 6173 6573 3a0a 2020 2020  test_cases:.    
+00018230: 2020 2020 2020 2020 646f 5f66 616b 6528          do_fake(
+00018240: 290a 2020 2020 2020 2020 2020 2020 7769  ).            wi
+00018250: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+00018260: 6973 6573 2865 7863 6570 7469 6f6e 293a  ises(exception):
+00018270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018280: 2072 756e 2829 0a20 2020 2020 2020 2020   run().         
+00018290: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000182a0: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
+000182b0: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
+000182c0: 723d 5472 7565 292c 2063 616c 6c73 290a  r=True), calls).
+000182d0: 0a20 2020 2064 6566 2074 6573 745f 6163  .    def test_ac
+000182e0: 7469 6f6e 5f67 6574 5f65 7272 6f72 2873  tion_get_error(s
+000182f0: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
+00018300: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+00018310: 2761 6374 696f 6e2d 6765 7427 2c20 2727  'action-get', ''
+00018320: 290a 2020 2020 2020 2020 6661 6b65 5f73  ).        fake_s
+00018330: 6372 6970 7428 7365 6c66 2c20 2761 6374  cript(self, 'act
+00018340: 696f 6e2d 6765 7427 2c20 2765 6368 6f20  ion-get', 'echo 
+00018350: 666f 6f65 7272 6f72 203e 2632 203b 2065  fooerror >&2 ; e
+00018360: 7869 7420 3127 290a 2020 2020 2020 2020  xit 1').        
+00018370: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00018380: 5261 6973 6573 286f 7073 2e4d 6f64 656c  Raises(ops.Model
+00018390: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+000183a0: 2020 2020 7365 6c66 2e62 6163 6b65 6e64      self.backend
+000183b0: 2e61 6374 696f 6e5f 6765 7428 290a 2020  .action_get().  
+000183c0: 2020 2020 2020 6361 6c6c 7320 3d20 5b5b        calls = [[
+000183d0: 2761 6374 696f 6e2d 6765 7427 2c20 272d  'action-get', '-
+000183e0: 2d66 6f72 6d61 743d 6a73 6f6e 275d 5d0a  -format=json']].
+000183f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00018400: 6572 7445 7175 616c 2866 616b 655f 7363  ertEqual(fake_sc
+00018410: 7269 7074 5f63 616c 6c73 2873 656c 662c  ript_calls(self,
+00018420: 2063 6c65 6172 3d54 7275 6529 2c20 6361   clear=True), ca
+00018430: 6c6c 7329 0a0a 2020 2020 6465 6620 7465  lls)..    def te
+00018440: 7374 5f61 6374 696f 6e5f 7365 745f 6572  st_action_set_er
+00018450: 726f 7228 7365 6c66 293a 0a20 2020 2020  ror(self):.     
+00018460: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+00018470: 656c 662c 2027 6163 7469 6f6e 2d67 6574  elf, 'action-get
+00018480: 272c 2027 2729 0a20 2020 2020 2020 2066  ', '').        f
 00018490: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
 000184a0: 2027 6163 7469 6f6e 2d73 6574 272c 2027   'action-set', '
-000184b0: 6578 6974 2030 2729 0a20 2020 2020 2020  exit 0').       
-000184c0: 2073 656c 662e 6261 636b 656e 642e 6163   self.backend.ac
-000184d0: 7469 6f6e 5f73 6574 287b 2761 273a 207b  tion_set({'a': {
-000184e0: 2762 273a 2031 2c20 2763 273a 2032 7d2c  'b': 1, 'c': 2},
-000184f0: 2027 6427 3a20 337d 290a 2020 2020 2020   'd': 3}).      
-00018500: 2020 7365 6c66 2e61 7373 6572 7443 6f75    self.assertCou
-00018510: 6e74 4571 7561 6c28 5b27 6163 7469 6f6e  ntEqual(['action
-00018520: 2d73 6574 272c 2027 612e 623d 3127 2c20  -set', 'a.b=1', 
-00018530: 2761 2e63 3d32 272c 2027 643d 3327 5d2c  'a.c=2', 'd=3'],
-00018540: 2066 616b 655f 7363 7269 7074 5f63 616c   fake_script_cal
-00018550: 6c73 2873 656c 6629 5b30 5d29 0a0a 2020  ls(self)[0])..  
-00018560: 2020 6465 6620 7465 7374 5f61 6374 696f    def test_actio
-00018570: 6e5f 7365 745f 6d6f 7265 5f6e 6573 7465  n_set_more_neste
-00018580: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
-00018590: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-000185a0: 662c 2027 6163 7469 6f6e 2d67 6574 272c  f, 'action-get',
-000185b0: 2027 6578 6974 2031 2729 0a20 2020 2020   'exit 1').     
-000185c0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-000185d0: 656c 662c 2027 6163 7469 6f6e 2d73 6574  elf, 'action-set
-000185e0: 272c 2027 6578 6974 2030 2729 0a20 2020  ', 'exit 0').   
-000185f0: 2020 2020 2073 656c 662e 6261 636b 656e       self.backen
-00018600: 642e 6163 7469 6f6e 5f73 6574 287b 2761  d.action_set({'a
-00018610: 273a 207b 2762 273a 2031 2c20 2763 273a  ': {'b': 1, 'c':
-00018620: 2032 2c20 2764 273a 207b 2765 273a 2033   2, 'd': {'e': 3
-00018630: 7d7d 2c20 2766 273a 2034 7d29 0a20 2020  }}, 'f': 4}).   
-00018640: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00018650: 436f 756e 7445 7175 616c 280a 2020 2020  CountEqual(.    
-00018660: 2020 2020 2020 2020 5b27 6163 7469 6f6e          ['action
-00018670: 2d73 6574 272c 2027 612e 623d 3127 2c20  -set', 'a.b=1', 
-00018680: 2761 2e63 3d32 272c 2027 612e 642e 653d  'a.c=2', 'a.d.e=
-00018690: 3327 2c20 2766 3d34 275d 2c20 6661 6b65  3', 'f=4'], fake
-000186a0: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
-000186b0: 6c66 295b 305d 290a 0a20 2020 2064 6566  lf)[0])..    def
-000186c0: 2074 6573 745f 6163 7469 6f6e 5f73 6574   test_action_set
-000186d0: 5f64 6f74 7465 645f 6469 6374 2873 656c  _dotted_dict(sel
-000186e0: 6629 3a0a 2020 2020 2020 2020 6661 6b65  f):.        fake
-000186f0: 5f73 6372 6970 7428 7365 6c66 2c20 2761  _script(self, 'a
-00018700: 6374 696f 6e2d 6765 7427 2c20 2765 7869  ction-get', 'exi
-00018710: 7420 3127 290a 2020 2020 2020 2020 6661  t 1').        fa
-00018720: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-00018730: 2761 6374 696f 6e2d 7365 7427 2c20 2765  'action-set', 'e
-00018740: 7869 7420 3027 290a 2020 2020 2020 2020  xit 0').        
-00018750: 7365 6c66 2e62 6163 6b65 6e64 2e61 6374  self.backend.act
-00018760: 696f 6e5f 7365 7428 7b27 612e 6227 3a20  ion_set({'a.b': 
-00018770: 312c 2027 6127 3a20 7b27 6327 3a20 327d  1, 'a': {'c': 2}
-00018780: 2c20 2764 273a 2033 7d29 0a20 2020 2020  , 'd': 3}).     
-00018790: 2020 2073 656c 662e 6173 7365 7274 436f     self.assertCo
-000187a0: 756e 7445 7175 616c 285b 2761 6374 696f  untEqual(['actio
-000187b0: 6e2d 7365 7427 2c20 2761 2e62 3d31 272c  n-set', 'a.b=1',
-000187c0: 2027 612e 633d 3227 2c20 2764 3d33 275d   'a.c=2', 'd=3']
-000187d0: 2c20 6661 6b65 5f73 6372 6970 745f 6361  , fake_script_ca
-000187e0: 6c6c 7328 7365 6c66 295b 305d 290a 0a20  lls(self)[0]).. 
-000187f0: 2020 2064 6566 2074 6573 745f 6163 7469     def test_acti
-00018800: 6f6e 5f73 6574 5f64 7570 6c69 6361 7465  on_set_duplicate
-00018810: 645f 6b65 7973 2873 656c 6629 3a0a 2020  d_keys(self):.  
-00018820: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
-00018830: 7428 7365 6c66 2c20 2761 6374 696f 6e2d  t(self, 'action-
-00018840: 6765 7427 2c20 2765 7869 7420 3127 290a  get', 'exit 1').
-00018850: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-00018860: 6970 7428 7365 6c66 2c20 2761 6374 696f  ipt(self, 'actio
-00018870: 6e2d 7365 7427 2c20 2765 7869 7420 3027  n-set', 'exit 0'
-00018880: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
-00018890: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-000188a0: 2856 616c 7565 4572 726f 7229 3a0a 2020  (ValueError):.  
-000188b0: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
-000188c0: 6163 6b65 6e64 2e61 6374 696f 6e5f 7365  ackend.action_se
-000188d0: 7428 7b27 612e 6227 3a20 312c 2027 6127  t({'a.b': 1, 'a'
-000188e0: 3a20 7b27 6227 3a20 327d 2c20 2764 273a  : {'b': 2}, 'd':
-000188f0: 2033 7d29 0a20 2020 2020 2020 2077 6974   3}).        wit
-00018900: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-00018910: 7365 7328 5661 6c75 6545 7272 6f72 293a  ses(ValueError):
-00018920: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00018930: 662e 6261 636b 656e 642e 6163 7469 6f6e  f.backend.action
-00018940: 5f73 6574 287b 2761 273a 207b 2762 273a  _set({'a': {'b':
-00018950: 2031 2c20 2763 273a 2032 2c20 2764 273a   1, 'c': 2, 'd':
-00018960: 207b 2765 273a 2033 7d7d 2c20 2766 273a   {'e': 3}}, 'f':
-00018970: 2034 2c20 2761 2e64 2e65 273a 2027 666f   4, 'a.d.e': 'fo
-00018980: 6f27 7d29 0a0a 2020 2020 6465 6620 7465  o'})..    def te
-00018990: 7374 5f61 6374 696f 6e5f 6661 696c 2873  st_action_fail(s
-000189a0: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
-000189b0: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-000189c0: 2761 6374 696f 6e2d 6765 7427 2c20 2765  'action-get', 'e
-000189d0: 7869 7420 3127 290a 2020 2020 2020 2020  xit 1').        
-000189e0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-000189f0: 2c20 2761 6374 696f 6e2d 6661 696c 272c  , 'action-fail',
-00018a00: 2027 6578 6974 2030 2729 0a20 2020 2020   'exit 0').     
-00018a10: 2020 2073 656c 662e 6261 636b 656e 642e     self.backend.
-00018a20: 6163 7469 6f6e 5f66 6169 6c28 2765 7272  action_fail('err
-00018a30: 6f72 2034 3227 290a 2020 2020 2020 2020  or 42').        
-00018a40: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00018a50: 2866 616b 655f 7363 7269 7074 5f63 616c  (fake_script_cal
-00018a60: 6c73 2873 656c 6629 2c20 5b5b 2761 6374  ls(self), [['act
-00018a70: 696f 6e2d 6661 696c 272c 2027 6572 726f  ion-fail', 'erro
-00018a80: 7220 3432 275d 5d29 0a0a 2020 2020 6465  r 42']])..    de
-00018a90: 6620 7465 7374 5f61 6374 696f 6e5f 6c6f  f test_action_lo
-00018aa0: 6728 7365 6c66 293a 0a20 2020 2020 2020  g(self):.       
-00018ab0: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-00018ac0: 662c 2027 6163 7469 6f6e 2d67 6574 272c  f, 'action-get',
-00018ad0: 2027 6578 6974 2031 2729 0a20 2020 2020   'exit 1').     
-00018ae0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-00018af0: 656c 662c 2027 6163 7469 6f6e 2d6c 6f67  elf, 'action-log
-00018b00: 272c 2027 6578 6974 2030 2729 0a20 2020  ', 'exit 0').   
-00018b10: 2020 2020 2073 656c 662e 6261 636b 656e       self.backen
-00018b20: 642e 6163 7469 6f6e 5f6c 6f67 2827 7072  d.action_log('pr
-00018b30: 6f67 7265 7373 3a20 3432 2527 290a 2020  ogress: 42%').  
-00018b40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00018b50: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
-00018b60: 7074 5f63 616c 6c73 2873 656c 6629 2c20  pt_calls(self), 
-00018b70: 5b5b 2761 6374 696f 6e2d 6c6f 6727 2c20  [['action-log', 
-00018b80: 2770 726f 6772 6573 733a 2034 3225 275d  'progress: 42%']
-00018b90: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-00018ba0: 5f61 7070 6c69 6361 7469 6f6e 5f76 6572  _application_ver
-00018bb0: 7369 6f6e 5f73 6574 2873 656c 6629 3a0a  sion_set(self):.
-00018bc0: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-00018bd0: 6970 7428 7365 6c66 2c20 2761 7070 6c69  ipt(self, 'appli
-00018be0: 6361 7469 6f6e 2d76 6572 7369 6f6e 2d73  cation-version-s
-00018bf0: 6574 272c 2027 6578 6974 2030 2729 0a20  et', 'exit 0'). 
-00018c00: 2020 2020 2020 2073 656c 662e 6261 636b         self.back
-00018c10: 656e 642e 6170 706c 6963 6174 696f 6e5f  end.application_
-00018c20: 7665 7273 696f 6e5f 7365 7428 2731 2e32  version_set('1.2
-00018c30: 6233 2729 0a20 2020 2020 2020 2073 656c  b3').        sel
-00018c40: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-00018c50: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-00018c60: 7365 6c66 292c 205b 5b27 6170 706c 6963  self), [['applic
-00018c70: 6174 696f 6e2d 7665 7273 696f 6e2d 7365  ation-version-se
-00018c80: 7427 2c20 272d 2d27 2c20 2731 2e32 6233  t', '--', '1.2b3
-00018c90: 275d 5d29 0a0a 2020 2020 6465 6620 7465  ']])..    def te
-00018ca0: 7374 5f61 7070 6c69 6361 7469 6f6e 5f76  st_application_v
-00018cb0: 6572 7369 6f6e 5f73 6574 5f69 6e76 616c  ersion_set_inval
-00018cc0: 6964 2873 656c 6629 3a0a 2020 2020 2020  id(self):.      
-00018cd0: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-00018ce0: 6c66 2c20 2761 7070 6c69 6361 7469 6f6e  lf, 'application
-00018cf0: 2d76 6572 7369 6f6e 2d73 6574 272c 2027  -version-set', '
-00018d00: 6578 6974 2030 2729 0a20 2020 2020 2020  exit 0').       
-00018d10: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00018d20: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
-00018d30: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00018d40: 7365 6c66 2e62 6163 6b65 6e64 2e61 7070  self.backend.app
-00018d50: 6c69 6361 7469 6f6e 5f76 6572 7369 6f6e  lication_version
-00018d60: 5f73 6574 2832 290a 2020 2020 2020 2020  _set(2).        
-00018d70: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00018d80: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
-00018d90: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-00018da0: 656c 662e 6261 636b 656e 642e 6170 706c  elf.backend.appl
-00018db0: 6963 6174 696f 6e5f 7665 7273 696f 6e5f  ication_version_
-00018dc0: 7365 7428 290a 2020 2020 2020 2020 7365  set().        se
-00018dd0: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
-00018de0: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-00018df0: 2873 656c 6629 2c20 5b5d 290a 0a20 2020  (self), [])..   
-00018e00: 2064 6566 2074 6573 745f 6a75 6a75 5f6c   def test_juju_l
-00018e10: 6f67 2873 656c 6629 3a0a 2020 2020 2020  og(self):.      
-00018e20: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-00018e30: 6c66 2c20 276a 756a 752d 6c6f 6727 2c20  lf, 'juju-log', 
-00018e40: 2765 7869 7420 3027 290a 2020 2020 2020  'exit 0').      
-00018e50: 2020 7365 6c66 2e62 6163 6b65 6e64 2e6a    self.backend.j
-00018e60: 756a 755f 6c6f 6728 2757 4152 4e49 4e47  uju_log('WARNING
-00018e70: 272c 2027 666f 6f27 290a 2020 2020 2020  ', 'foo').      
-00018e80: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00018e90: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
-00018ea0: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
-00018eb0: 3d54 7275 6529 2c0a 2020 2020 2020 2020  =True),.        
-00018ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ed0: 205b 5b27 6a75 6a75 2d6c 6f67 272c 2027   [['juju-log', '
-00018ee0: 2d2d 6c6f 672d 6c65 7665 6c27 2c20 2757  --log-level', 'W
-00018ef0: 4152 4e49 4e47 272c 2027 2d2d 272c 2027  ARNING', '--', '
-00018f00: 666f 6f27 5d5d 290a 0a20 2020 2020 2020  foo']])..       
-00018f10: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00018f20: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
-00018f30: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00018f40: 7365 6c66 2e62 6163 6b65 6e64 2e6a 756a  self.backend.juj
-00018f50: 755f 6c6f 6728 2744 4542 5547 2729 0a20  u_log('DEBUG'). 
-00018f60: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00018f70: 7274 4571 7561 6c28 6661 6b65 5f73 6372  rtEqual(fake_scr
-00018f80: 6970 745f 6361 6c6c 7328 7365 6c66 2c20  ipt_calls(self, 
-00018f90: 636c 6561 723d 5472 7565 292c 205b 5d29  clear=True), [])
-00018fa0: 0a0a 2020 2020 2020 2020 6661 6b65 5f73  ..        fake_s
-00018fb0: 6372 6970 7428 7365 6c66 2c20 276a 756a  cript(self, 'juj
-00018fc0: 752d 6c6f 6727 2c20 2765 7869 7420 3127  u-log', 'exit 1'
-00018fd0: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
-00018fe0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-00018ff0: 286f 7073 2e4d 6f64 656c 4572 726f 7229  (ops.ModelError)
-00019000: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00019010: 6c66 2e62 6163 6b65 6e64 2e6a 756a 755f  lf.backend.juju_
-00019020: 6c6f 6728 2742 4152 272c 2027 666f 6f27  log('BAR', 'foo'
-00019030: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00019040: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
-00019050: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
-00019060: 662c 2063 6c65 6172 3d54 7275 6529 2c0a  f, clear=True),.
-00019070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019080: 2020 2020 2020 2020 205b 5b27 6a75 6a75           [['juju
-00019090: 2d6c 6f67 272c 2027 2d2d 6c6f 672d 6c65  -log', '--log-le
-000190a0: 7665 6c27 2c20 2742 4152 272c 2027 2d2d  vel', 'BAR', '--
-000190b0: 272c 2027 666f 6f27 5d5d 290a 0a20 2020  ', 'foo']])..   
-000190c0: 2064 6566 2074 6573 745f 7661 6c69 645f   def test_valid_
-000190d0: 6d65 7472 6963 7328 7365 6c66 293a 0a20  metrics(self):. 
-000190e0: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-000190f0: 7074 2873 656c 662c 2027 6164 642d 6d65  pt(self, 'add-me
-00019100: 7472 6963 272c 2027 6578 6974 2030 2729  tric', 'exit 0')
-00019110: 0a20 2020 2020 2020 2074 6573 745f 6361  .        test_ca
-00019120: 7365 7320 3d20 5b28 0a20 2020 2020 2020  ses = [(.       
-00019130: 2020 2020 204f 7264 6572 6564 4469 6374       OrderedDict
-00019140: 285b 2827 666f 6f27 2c20 3432 292c 2028  ([('foo', 42), (
-00019150: 2762 2d61 7227 2c20 342e 3529 2c20 2827  'b-ar', 4.5), ('
-00019160: 6261 5f2d 7a27 2c20 342e 3529 2c20 2827  ba_-z', 4.5), ('
-00019170: 6127 2c20 3129 5d29 2c0a 2020 2020 2020  a', 1)]),.      
-00019180: 2020 2020 2020 4f72 6465 7265 6444 6963        OrderedDic
-00019190: 7428 5b28 2764 6527 2c20 2761 6427 292c  t([('de', 'ad'),
-000191a0: 2028 2762 6527 2c20 2765 665f 202d 2729   ('be', 'ef_ -')
-000191b0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-000191c0: 5b5b 2761 6464 2d6d 6574 7269 6327 2c20  [['add-metric', 
-000191d0: 272d 2d6c 6162 656c 7327 2c20 2764 653d  '--labels', 'de=
-000191e0: 6164 2c62 653d 6566 5f20 2d27 2c0a 2020  ad,be=ef_ -',.  
-000191f0: 2020 2020 2020 2020 2020 2020 2766 6f6f              'foo
-00019200: 3d34 3227 2c20 2762 2d61 723d 342e 3527  =42', 'b-ar=4.5'
-00019210: 2c20 2762 615f 2d7a 3d34 2e35 272c 2027  , 'ba_-z=4.5', '
-00019220: 613d 3127 5d5d 0a20 2020 2020 2020 2029  a=1']].        )
-00019230: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-00019240: 4f72 6465 7265 6444 6963 7428 5b28 2766  OrderedDict([('f
-00019250: 6f6f 3127 2c20 3029 2c20 2827 6232 7227  oo1', 0), ('b2r'
-00019260: 2c20 342e 3529 5d29 2c0a 2020 2020 2020  , 4.5)]),.      
-00019270: 2020 2020 2020 4f72 6465 7265 6444 6963        OrderedDic
-00019280: 7428 5b28 2764 3327 2c20 2761 d0b4 2729  t([('d3', 'a..')
-00019290: 2c20 2827 6233 3366 272c 2027 335f 202d  , ('b33f', '3_ -
-000192a0: 2729 5d29 2c0a 2020 2020 2020 2020 2020  ')]),.          
-000192b0: 2020 5b5b 2761 6464 2d6d 6574 7269 6327    [['add-metric'
-000192c0: 2c20 272d 2d6c 6162 656c 7327 2c20 2764  , '--labels', 'd
-000192d0: 333d 61d0 b42c 6233 3366 3d33 5f20 2d27  3=a..,b33f=3_ -'
-000192e0: 2c20 2766 6f6f 313d 3027 2c20 2762 3272  , 'foo1=0', 'b2r
-000192f0: 3d34 2e35 275d 5d2c 0a20 2020 2020 2020  =4.5']],.       
-00019300: 2029 5d0a 2020 2020 2020 2020 666f 7220   )].        for 
-00019310: 6d65 7472 6963 732c 206c 6162 656c 732c  metrics, labels,
-00019320: 2065 7870 6563 7465 645f 6361 6c6c 7320   expected_calls 
-00019330: 696e 2074 6573 745f 6361 7365 733a 0a20  in test_cases:. 
-00019340: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019350: 6261 636b 656e 642e 6164 645f 6d65 7472  backend.add_metr
-00019360: 6963 7328 6d65 7472 6963 732c 206c 6162  ics(metrics, lab
-00019370: 656c 7329 0a20 2020 2020 2020 2020 2020  els).           
-00019380: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00019390: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
-000193a0: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
-000193b0: 5472 7565 292c 2065 7870 6563 7465 645f  True), expected_
-000193c0: 6361 6c6c 7329 0a0a 2020 2020 6465 6620  calls)..    def 
-000193d0: 7465 7374 5f69 6e76 616c 6964 5f6d 6574  test_invalid_met
-000193e0: 7269 635f 6e61 6d65 7328 7365 6c66 293a  ric_names(self):
-000193f0: 0a20 2020 2020 2020 2069 6e76 616c 6964  .        invalid
-00019400: 5f69 6e70 7574 7320 3d20 5b0a 2020 2020  _inputs = [.    
-00019410: 2020 2020 2020 2020 287b 2727 3a20 342e          ({'': 4.
-00019420: 327d 2c20 7b7d 292c 0a20 2020 2020 2020  2}, {}),.       
-00019430: 2020 2020 2028 7b27 3127 3a20 342e 327d       ({'1': 4.2}
-00019440: 2c20 7b7d 292c 0a20 2020 2020 2020 2020  , {}),.         
-00019450: 2020 2028 7b27 3127 3a20 2d34 2e32 7d2c     ({'1': -4.2},
-00019460: 207b 7d29 2c0a 2020 2020 2020 2020 2020   {}),.          
-00019470: 2020 287b 2731 3233 273a 2034 2e32 7d2c    ({'123': 4.2},
-00019480: 207b 7d29 2c0a 2020 2020 2020 2020 2020   {}),.          
-00019490: 2020 287b 2731 666f 6f27 3a20 342e 327d    ({'1foo': 4.2}
-000194a0: 2c20 7b7d 292c 0a20 2020 2020 2020 2020  , {}),.         
-000194b0: 2020 2028 7b27 2d66 6f6f 273a 2034 2e32     ({'-foo': 4.2
-000194c0: 7d2c 207b 7d29 2c0a 2020 2020 2020 2020  }, {}),.        
-000194d0: 2020 2020 287b 275f 666f 6f27 3a20 342e      ({'_foo': 4.
-000194e0: 327d 2c20 7b7d 292c 0a20 2020 2020 2020  2}, {}),.       
-000194f0: 2020 2020 2028 7b27 666f 6f2d 273a 2034       ({'foo-': 4
-00019500: 2e32 7d2c 207b 7d29 2c0a 2020 2020 2020  .2}, {}),.      
-00019510: 2020 2020 2020 287b 2766 6f6f 5f27 3a20        ({'foo_': 
-00019520: 342e 327d 2c20 7b7d 292c 0a20 2020 2020  4.2}, {}),.     
-00019530: 2020 2020 2020 2028 7b27 612d 273a 2034         ({'a-': 4
-00019540: 2e32 7d2c 207b 7d29 2c0a 2020 2020 2020  .2}, {}),.      
-00019550: 2020 2020 2020 287b 2761 5f27 3a20 342e        ({'a_': 4.
-00019560: 327d 2c20 7b7d 292c 0a20 2020 2020 2020  2}, {}),.       
-00019570: 2020 2020 2028 7b27 4241 d0af 273a 2034       ({'BA..': 4
-00019580: 2e32 7d2c 207b 7d29 2c0a 2020 2020 2020  .2}, {}),.      
-00019590: 2020 5d0a 2020 2020 2020 2020 666f 7220    ].        for 
-000195a0: 6d65 7472 6963 732c 206c 6162 656c 7320  metrics, labels 
-000195b0: 696e 2069 6e76 616c 6964 5f69 6e70 7574  in invalid_input
-000195c0: 733a 0a20 2020 2020 2020 2020 2020 2077  s:.            w
-000195d0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-000195e0: 6169 7365 7328 6f70 732e 4d6f 6465 6c45  aises(ops.ModelE
-000195f0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-00019600: 2020 2020 2020 2073 656c 662e 6261 636b         self.back
-00019610: 656e 642e 6164 645f 6d65 7472 6963 7328  end.add_metrics(
-00019620: 6d65 7472 6963 732c 206c 6162 656c 7329  metrics, labels)
-00019630: 0a0a 2020 2020 6465 6620 7465 7374 5f69  ..    def test_i
-00019640: 6e76 616c 6964 5f6d 6574 7269 635f 7661  nvalid_metric_va
-00019650: 6c75 6573 2873 656c 6629 3a0a 2020 2020  lues(self):.    
-00019660: 2020 2020 696e 7661 6c69 645f 696e 7075      invalid_inpu
-00019670: 7473 203d 205b 0a20 2020 2020 2020 2020  ts = [.         
-00019680: 2020 2028 7b27 6127 3a20 666c 6f61 7428     ({'a': float(
-00019690: 272b 696e 6627 297d 2c20 7b7d 292c 0a20  '+inf')}, {}),. 
-000196a0: 2020 2020 2020 2020 2020 2028 7b27 6127             ({'a'
-000196b0: 3a20 666c 6f61 7428 272d 696e 6627 297d  : float('-inf')}
-000196c0: 2c20 7b7d 292c 0a20 2020 2020 2020 2020  , {}),.         
-000196d0: 2020 2028 7b27 6127 3a20 666c 6f61 7428     ({'a': float(
-000196e0: 276e 616e 2729 7d2c 207b 7d29 2c0a 2020  'nan')}, {}),.  
-000196f0: 2020 2020 2020 2020 2020 287b 2766 6f6f            ({'foo
-00019700: 273a 2027 6261 7227 7d2c 207b 7d29 2c0a  ': 'bar'}, {}),.
-00019710: 2020 2020 2020 2020 2020 2020 287b 2766              ({'f
-00019720: 6f6f 273a 2027 314f 277d 2c20 7b7d 292c  oo': '1O'}, {}),
-00019730: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
-00019740: 2020 2066 6f72 206d 6574 7269 6373 2c20     for metrics, 
-00019750: 6c61 6265 6c73 2069 6e20 696e 7661 6c69  labels in invali
-00019760: 645f 696e 7075 7473 3a0a 2020 2020 2020  d_inputs:.      
-00019770: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00019780: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
-00019790: 2e4d 6f64 656c 4572 726f 7229 3a0a 2020  .ModelError):.  
-000197a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000197b0: 6c66 2e62 6163 6b65 6e64 2e61 6464 5f6d  lf.backend.add_m
-000197c0: 6574 7269 6373 286d 6574 7269 6373 2c20  etrics(metrics, 
-000197d0: 6c61 6265 6c73 290a 0a20 2020 2064 6566  labels)..    def
-000197e0: 2074 6573 745f 696e 7661 6c69 645f 6d65   test_invalid_me
-000197f0: 7472 6963 5f6c 6162 656c 7328 7365 6c66  tric_labels(self
-00019800: 293a 0a20 2020 2020 2020 2069 6e76 616c  ):.        inval
-00019810: 6964 5f69 6e70 7574 7320 3d20 5b0a 2020  id_inputs = [.  
-00019820: 2020 2020 2020 2020 2020 287b 2766 6f6f            ({'foo
-00019830: 273a 2034 2e32 7d2c 207b 2727 3a20 2762  ': 4.2}, {'': 'b
-00019840: 617a 277d 292c 0a20 2020 2020 2020 2020  az'}),.         
-00019850: 2020 2028 7b27 666f 6f27 3a20 342e 327d     ({'foo': 4.2}
-00019860: 2c20 7b27 2c62 6172 273a 2027 6261 7a27  , {',bar': 'baz'
-00019870: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
-00019880: 287b 2766 6f6f 273a 2034 2e32 7d2c 207b  ({'foo': 4.2}, {
-00019890: 2762 3d61 3d72 273a 2027 6261 7a27 7d29  'b=a=r': 'baz'})
-000198a0: 2c0a 2020 2020 2020 2020 2020 2020 287b  ,.            ({
-000198b0: 2766 6f6f 273a 2034 2e32 7d2c 207b 2742  'foo': 4.2}, {'B
-000198c0: 41d0 af27 3a20 2762 617a 277d 292c 0a20  A..': 'baz'}),. 
-000198d0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-000198e0: 2066 6f72 206d 6574 7269 6373 2c20 6c61   for metrics, la
-000198f0: 6265 6c73 2069 6e20 696e 7661 6c69 645f  bels in invalid_
-00019900: 696e 7075 7473 3a0a 2020 2020 2020 2020  inputs:.        
-00019910: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00019920: 7365 7274 5261 6973 6573 286f 7073 2e4d  sertRaises(ops.M
-00019930: 6f64 656c 4572 726f 7229 3a0a 2020 2020  odelError):.    
-00019940: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00019950: 2e62 6163 6b65 6e64 2e61 6464 5f6d 6574  .backend.add_met
-00019960: 7269 6373 286d 6574 7269 6373 2c20 6c61  rics(metrics, la
-00019970: 6265 6c73 290a 0a20 2020 2064 6566 2074  bels)..    def t
-00019980: 6573 745f 696e 7661 6c69 645f 6d65 7472  est_invalid_metr
-00019990: 6963 5f6c 6162 656c 5f76 616c 7565 7328  ic_label_values(
-000199a0: 7365 6c66 293a 0a20 2020 2020 2020 2069  self):.        i
-000199b0: 6e76 616c 6964 5f69 6e70 7574 7320 3d20  nvalid_inputs = 
-000199c0: 5b0a 2020 2020 2020 2020 2020 2020 287b  [.            ({
-000199d0: 2766 6f6f 273a 2034 2e32 7d2c 207b 2762  'foo': 4.2}, {'b
-000199e0: 6172 273a 2027 277d 292c 0a20 2020 2020  ar': ''}),.     
-000199f0: 2020 2020 2020 2028 7b27 666f 6f27 3a20         ({'foo': 
-00019a00: 342e 327d 2c20 7b27 6261 7227 3a20 2762  4.2}, {'bar': 'b
-00019a10: 2c61 7a27 7d29 2c0a 2020 2020 2020 2020  ,az'}),.        
-00019a20: 2020 2020 287b 2766 6f6f 273a 2034 2e32      ({'foo': 4.2
-00019a30: 7d2c 207b 2762 6172 273a 2027 623d 617a  }, {'bar': 'b=az
-00019a40: 277d 292c 0a20 2020 2020 2020 205d 0a20  '}),.        ]. 
-00019a50: 2020 2020 2020 2066 6f72 206d 6574 7269         for metri
-00019a60: 6373 2c20 6c61 6265 6c73 2069 6e20 696e  cs, labels in in
-00019a70: 7661 6c69 645f 696e 7075 7473 3a0a 2020  valid_inputs:.  
-00019a80: 2020 2020 2020 2020 2020 7769 7468 2073            with s
-00019a90: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-00019aa0: 286f 7073 2e4d 6f64 656c 4572 726f 7229  (ops.ModelError)
-00019ab0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00019ac0: 2020 7365 6c66 2e62 6163 6b65 6e64 2e61    self.backend.a
-00019ad0: 6464 5f6d 6574 7269 6373 286d 6574 7269  dd_metrics(metri
-00019ae0: 6373 2c20 6c61 6265 6c73 290a 0a20 2020  cs, labels)..   
-00019af0: 2064 6566 2074 6573 745f 7265 6c61 7469   def test_relati
-00019b00: 6f6e 5f72 656d 6f74 655f 6170 705f 6e61  on_remote_app_na
-00019b10: 6d65 5f65 6e76 2873 656c 6629 3a0a 2020  me_env(self):.  
-00019b20: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
-00019b30: 6561 6e75 7028 6f73 2e65 6e76 6972 6f6e  eanup(os.environ
-00019b40: 2e70 6f70 2c20 274a 554a 555f 5245 4c41  .pop, 'JUJU_RELA
-00019b50: 5449 4f4e 5f49 4427 2c20 4e6f 6e65 290a  TION_ID', None).
-00019b60: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-00019b70: 436c 6561 6e75 7028 6f73 2e65 6e76 6972  Cleanup(os.envir
-00019b80: 6f6e 2e70 6f70 2c20 274a 554a 555f 5245  on.pop, 'JUJU_RE
-00019b90: 4d4f 5445 5f41 5050 272c 204e 6f6e 6529  MOTE_APP', None)
-00019ba0: 0a0a 2020 2020 2020 2020 6f73 2e65 6e76  ..        os.env
-00019bb0: 6972 6f6e 5b27 4a55 4a55 5f52 454c 4154  iron['JUJU_RELAT
-00019bc0: 494f 4e5f 4944 275d 203d 2027 783a 3527  ION_ID'] = 'x:5'
-00019bd0: 0a20 2020 2020 2020 206f 732e 656e 7669  .        os.envi
-00019be0: 726f 6e5b 274a 554a 555f 5245 4d4f 5445  ron['JUJU_REMOTE
-00019bf0: 5f41 5050 275d 203d 2027 7265 6d6f 7465  _APP'] = 'remote
-00019c00: 6170 7031 270a 2020 2020 2020 2020 7365  app1'.        se
-00019c10: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00019c20: 656c 662e 6261 636b 656e 642e 7265 6c61  elf.backend.rela
-00019c30: 7469 6f6e 5f72 656d 6f74 655f 6170 705f  tion_remote_app_
-00019c40: 6e61 6d65 2835 292c 2027 7265 6d6f 7465  name(5), 'remote
-00019c50: 6170 7031 2729 0a20 2020 2020 2020 206f  app1').        o
-00019c60: 732e 656e 7669 726f 6e5b 274a 554a 555f  s.environ['JUJU_
-00019c70: 5245 4c41 5449 4f4e 5f49 4427 5d20 3d20  RELATION_ID'] = 
-00019c80: 2735 270a 2020 2020 2020 2020 7365 6c66  '5'.        self
-00019c90: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-00019ca0: 662e 6261 636b 656e 642e 7265 6c61 7469  f.backend.relati
-00019cb0: 6f6e 5f72 656d 6f74 655f 6170 705f 6e61  on_remote_app_na
-00019cc0: 6d65 2835 292c 2027 7265 6d6f 7465 6170  me(5), 'remoteap
-00019cd0: 7031 2729 0a0a 2020 2020 6465 6620 7465  p1')..    def te
-00019ce0: 7374 5f72 656c 6174 696f 6e5f 7265 6d6f  st_relation_remo
-00019cf0: 7465 5f61 7070 5f6e 616d 655f 7363 7269  te_app_name_scri
-00019d00: 7074 5f73 7563 6365 7373 2873 656c 6629  pt_success(self)
-00019d10: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
-00019d20: 6464 436c 6561 6e75 7028 6f73 2e65 6e76  ddCleanup(os.env
-00019d30: 6972 6f6e 2e70 6f70 2c20 274a 554a 555f  iron.pop, 'JUJU_
-00019d40: 5245 4c41 5449 4f4e 5f49 4427 2c20 4e6f  RELATION_ID', No
-00019d50: 6e65 290a 2020 2020 2020 2020 7365 6c66  ne).        self
-00019d60: 2e61 6464 436c 6561 6e75 7028 6f73 2e65  .addCleanup(os.e
-00019d70: 6e76 6972 6f6e 2e70 6f70 2c20 274a 554a  nviron.pop, 'JUJ
-00019d80: 555f 5245 4d4f 5445 5f41 5050 272c 204e  U_REMOTE_APP', N
-00019d90: 6f6e 6529 0a0a 2020 2020 2020 2020 2320  one)..        # 
-00019da0: 4a55 4a55 5f52 454c 4154 494f 4e5f 4944  JUJU_RELATION_ID
-00019db0: 2061 6e64 204a 554a 555f 5245 4d4f 5445   and JUJU_REMOTE
-00019dc0: 5f41 5050 2062 6f74 6820 756e 7365 740a  _APP both unset.
-00019dd0: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-00019de0: 6970 7428 7365 6c66 2c20 2772 656c 6174  ipt(self, 'relat
-00019df0: 696f 6e2d 6c69 7374 272c 2072 2222 220a  ion-list', r""".
-00019e00: 6563 686f 2027 2272 656d 6f74 6561 7070  echo '"remoteapp
-00019e10: 3222 270a 2222 2229 0a20 2020 2020 2020  2"'.""").       
-00019e20: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00019e30: 6c28 7365 6c66 2e62 6163 6b65 6e64 2e72  l(self.backend.r
-00019e40: 656c 6174 696f 6e5f 7265 6d6f 7465 5f61  elation_remote_a
-00019e50: 7070 5f6e 616d 6528 3129 2c20 2772 656d  pp_name(1), 'rem
-00019e60: 6f74 6561 7070 3227 290a 2020 2020 2020  oteapp2').      
-00019e70: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00019e80: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
-00019e90: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
-00019ea0: 3d54 7275 6529 2c20 5b0a 2020 2020 2020  =True), [.      
-00019eb0: 2020 2020 2020 5b27 7265 6c61 7469 6f6e        ['relation
-00019ec0: 2d6c 6973 7427 2c20 272d 7227 2c20 2731  -list', '-r', '1
-00019ed0: 272c 2027 2d2d 6170 7027 2c20 272d 2d66  ', '--app', '--f
-00019ee0: 6f72 6d61 743d 6a73 6f6e 275d 2c0a 2020  ormat=json'],.  
-00019ef0: 2020 2020 2020 5d29 0a0a 2020 2020 2020        ])..      
-00019f00: 2020 2320 4a55 4a55 5f52 454c 4154 494f    # JUJU_RELATIO
-00019f10: 4e5f 4944 2073 6574 2062 7574 204a 554a  N_ID set but JUJ
-00019f20: 555f 5245 4d4f 5445 5f41 5050 2075 6e73  U_REMOTE_APP uns
-00019f30: 6574 0a20 2020 2020 2020 206f 732e 656e  et.        os.en
-00019f40: 7669 726f 6e5b 274a 554a 555f 5245 4c41  viron['JUJU_RELA
-00019f50: 5449 4f4e 5f49 4427 5d20 3d20 2778 3a35  TION_ID'] = 'x:5
-00019f60: 270a 2020 2020 2020 2020 7365 6c66 2e61  '.        self.a
-00019f70: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-00019f80: 6261 636b 656e 642e 7265 6c61 7469 6f6e  backend.relation
-00019f90: 5f72 656d 6f74 655f 6170 705f 6e61 6d65  _remote_app_name
-00019fa0: 2835 292c 2027 7265 6d6f 7465 6170 7032  (5), 'remoteapp2
-00019fb0: 2729 0a0a 2020 2020 2020 2020 2320 4a55  ')..        # JU
-00019fc0: 4a55 5f52 454c 4154 494f 4e5f 4944 2075  JU_RELATION_ID u
-00019fd0: 6e73 6574 2062 7574 204a 554a 555f 5245  nset but JUJU_RE
-00019fe0: 4d4f 5445 5f41 5050 2073 6574 0a20 2020  MOTE_APP set.   
-00019ff0: 2020 2020 2064 656c 206f 732e 656e 7669       del os.envi
-0001a000: 726f 6e5b 274a 554a 555f 5245 4c41 5449  ron['JUJU_RELATI
-0001a010: 4f4e 5f49 4427 5d0a 2020 2020 2020 2020  ON_ID'].        
-0001a020: 6f73 2e65 6e76 6972 6f6e 5b27 4a55 4a55  os.environ['JUJU
-0001a030: 5f52 454d 4f54 455f 4150 5027 5d20 3d20  _REMOTE_APP'] = 
-0001a040: 2772 656d 6f74 6561 7070 3127 0a20 2020  'remoteapp1'.   
-0001a050: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001a060: 4571 7561 6c28 7365 6c66 2e62 6163 6b65  Equal(self.backe
-0001a070: 6e64 2e72 656c 6174 696f 6e5f 7265 6d6f  nd.relation_remo
-0001a080: 7465 5f61 7070 5f6e 616d 6528 3529 2c20  te_app_name(5), 
-0001a090: 2772 656d 6f74 6561 7070 3227 290a 0a20  'remoteapp2').. 
-0001a0a0: 2020 2020 2020 2023 2042 6f74 6820 7365         # Both se
-0001a0b0: 742c 2062 7574 204a 554a 555f 5245 4c41  t, but JUJU_RELA
-0001a0c0: 5449 4f4e 5f49 4420 6120 6469 6666 6572  TION_ID a differ
-0001a0d0: 656e 7420 7265 6c61 7469 6f6e 0a20 2020  ent relation.   
-0001a0e0: 2020 2020 206f 732e 656e 7669 726f 6e5b       os.environ[
-0001a0f0: 274a 554a 555f 5245 4c41 5449 4f4e 5f49  'JUJU_RELATION_I
-0001a100: 4427 5d20 3d20 2778 3a36 270a 2020 2020  D'] = 'x:6'.    
-0001a110: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001a120: 7175 616c 2873 656c 662e 6261 636b 656e  qual(self.backen
-0001a130: 642e 7265 6c61 7469 6f6e 5f72 656d 6f74  d.relation_remot
-0001a140: 655f 6170 705f 6e61 6d65 2835 292c 2027  e_app_name(5), '
-0001a150: 7265 6d6f 7465 6170 7032 2729 0a0a 2020  remoteapp2')..  
-0001a160: 2020 6465 6620 7465 7374 5f72 656c 6174    def test_relat
-0001a170: 696f 6e5f 7265 6d6f 7465 5f61 7070 5f6e  ion_remote_app_n
-0001a180: 616d 655f 7363 7269 7074 5f65 7272 6f72  ame_script_error
-0001a190: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-0001a1a0: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-0001a1b0: 662c 2027 7265 6c61 7469 6f6e 2d6c 6973  f, 'relation-lis
-0001a1c0: 7427 2c20 7222 2222 0a65 6368 6f20 2245  t', r""".echo "E
-0001a1d0: 5252 4f52 2069 6e76 616c 6964 2076 616c  RROR invalid val
-0001a1e0: 7565 205c 2236 5c22 2066 6f72 206f 7074  ue \"6\" for opt
-0001a1f0: 696f 6e20 2d72 3a20 7265 6c61 7469 6f6e  ion -r: relation
-0001a200: 206e 6f74 2066 6f75 6e64 2220 3e26 3220   not found" >&2 
-0001a210: 2023 204e 4f51 410a 6578 6974 2032 0a22   # NOQA.exit 2."
-0001a220: 2222 290a 2020 2020 2020 2020 7365 6c66  "").        self
-0001a230: 2e61 7373 6572 7449 7328 7365 6c66 2e62  .assertIs(self.b
-0001a240: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-0001a250: 7265 6d6f 7465 5f61 7070 5f6e 616d 6528  remote_app_name(
-0001a260: 3629 2c20 4e6f 6e65 290a 2020 2020 2020  6), None).      
-0001a270: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001a280: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
-0001a290: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
-0001a2a0: 3d54 7275 6529 2c20 5b0a 2020 2020 2020  =True), [.      
-0001a2b0: 2020 2020 2020 5b27 7265 6c61 7469 6f6e        ['relation
-0001a2c0: 2d6c 6973 7427 2c20 272d 7227 2c20 2736  -list', '-r', '6
-0001a2d0: 272c 2027 2d2d 6170 7027 2c20 272d 2d66  ', '--app', '--f
-0001a2e0: 6f72 6d61 743d 6a73 6f6e 275d 2c0a 2020  ormat=json'],.  
-0001a2f0: 2020 2020 2020 5d29 0a0a 2020 2020 2020        ])..      
-0001a300: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-0001a310: 6c66 2c20 2772 656c 6174 696f 6e2d 6c69  lf, 'relation-li
-0001a320: 7374 272c 2072 2222 220a 6563 686f 2022  st', r""".echo "
-0001a330: 4552 524f 5220 6f70 7469 6f6e 2070 726f  ERROR option pro
-0001a340: 7669 6465 6420 6275 7420 6e6f 7420 6465  vided but not de
-0001a350: 6669 6e65 643a 202d 2d61 7070 2220 3e26  fined: --app" >&
-0001a360: 320a 6578 6974 2032 0a22 2222 290a 2020  2.exit 2.""").  
-0001a370: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001a380: 7449 7328 7365 6c66 2e62 6163 6b65 6e64  tIs(self.backend
-0001a390: 2e72 656c 6174 696f 6e5f 7265 6d6f 7465  .relation_remote
-0001a3a0: 5f61 7070 5f6e 616d 6528 3629 2c20 4e6f  _app_name(6), No
-0001a3b0: 6e65 290a 2020 2020 2020 2020 7365 6c66  ne).        self
-0001a3c0: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
-0001a3d0: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
-0001a3e0: 656c 662c 2063 6c65 6172 3d54 7275 6529  elf, clear=True)
-0001a3f0: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-0001a400: 5b27 7265 6c61 7469 6f6e 2d6c 6973 7427  ['relation-list'
-0001a410: 2c20 272d 7227 2c20 2736 272c 2027 2d2d  , '-r', '6', '--
-0001a420: 6170 7027 2c20 272d 2d66 6f72 6d61 743d  app', '--format=
-0001a430: 6a73 6f6e 275d 2c0a 2020 2020 2020 2020  json'],.        
-0001a440: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0001a450: 5f70 6c61 6e6e 6564 5f75 6e69 7473 2873  _planned_units(s
-0001a460: 656c 6629 3a0a 2020 2020 2020 2020 2320  elf):.        # 
-0001a470: 6e6f 2075 6e69 7473 0a20 2020 2020 2020  no units.       
-0001a480: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-0001a490: 662c 2027 676f 616c 2d73 7461 7465 272c  f, 'goal-state',
-0001a4a0: 2022 2222 0a65 6368 6f20 277b 2275 6e69   """.echo '{"uni
-0001a4b0: 7473 223a 7b7d 2c20 2272 656c 6174 696f  ts":{}, "relatio
-0001a4c0: 6e73 223a 7b7d 7d27 0a22 2222 290a 2020  ns":{}}'.""").  
-0001a4d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001a4e0: 7445 7175 616c 2873 656c 662e 6261 636b  tEqual(self.back
-0001a4f0: 656e 642e 706c 616e 6e65 645f 756e 6974  end.planned_unit
-0001a500: 7328 292c 2030 290a 0a20 2020 2020 2020  s(), 0)..       
-0001a510: 2023 206f 6e6c 7920 6163 7469 7665 2075   # only active u
-0001a520: 6e69 7473 0a20 2020 2020 2020 2066 616b  nits.        fak
-0001a530: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-0001a540: 676f 616c 2d73 7461 7465 272c 2022 2222  goal-state', """
-0001a550: 0a65 6368 6f20 277b 0a20 2020 2022 756e  .echo '{.    "un
-0001a560: 6974 7322 3a7b 0a20 2020 2020 2020 2022  its":{.        "
-0001a570: 6170 702f 3022 3a20 7b22 7374 6174 7573  app/0": {"status
-0001a580: 223a 2261 6374 6976 6522 2c22 7369 6e63  ":"active","sinc
-0001a590: 6522 3a22 3230 3233 2d30 352d 3233 2031  e":"2023-05-23 1
-0001a5a0: 373a 3035 3a30 355a 227d 2c0a 2020 2020  7:05:05Z"},.    
-0001a5b0: 2020 2020 2261 7070 2f31 223a 207b 2273      "app/1": {"s
-0001a5c0: 7461 7475 7322 3a22 6163 7469 7665 222c  tatus":"active",
-0001a5d0: 2273 696e 6365 223a 2232 3032 332d 3035  "since":"2023-05
-0001a5e0: 2d32 3320 3137 3a35 373a 3035 5a22 7d0a  -23 17:57:05Z"}.
-0001a5f0: 2020 2020 7d2c 0a20 2020 2022 7265 6c61      },.    "rela
-0001a600: 7469 6f6e 7322 3a20 7b7d 0a7d 2722 2222  tions": {}.}'"""
-0001a610: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001a620: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-0001a630: 6261 636b 656e 642e 706c 616e 6e65 645f  backend.planned_
-0001a640: 756e 6974 7328 292c 2032 290a 0a20 2020  units(), 2)..   
-0001a650: 2020 2020 2023 2061 6374 6976 6520 616e       # active an
-0001a660: 6420 6479 696e 6720 756e 6974 730a 2020  d dying units.  
-0001a670: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
-0001a680: 7428 7365 6c66 2c20 2767 6f61 6c2d 7374  t(self, 'goal-st
-0001a690: 6174 6527 2c20 2222 220a 6563 686f 2027  ate', """.echo '
-0001a6a0: 7b0a 2020 2020 2275 6e69 7473 223a 7b0a  {.    "units":{.
-0001a6b0: 2020 2020 2020 2020 2261 7070 2f30 223a          "app/0":
-0001a6c0: 207b 2273 7461 7475 7322 3a22 6163 7469   {"status":"acti
-0001a6d0: 7665 222c 2273 696e 6365 223a 2232 3032  ve","since":"202
-0001a6e0: 332d 3035 2d32 3320 3137 3a30 353a 3035  3-05-23 17:05:05
-0001a6f0: 5a22 7d2c 0a20 2020 2020 2020 2022 6170  Z"},.        "ap
-0001a700: 702f 3122 3a20 7b22 7374 6174 7573 223a  p/1": {"status":
-0001a710: 2264 7969 6e67 222c 2273 696e 6365 223a  "dying","since":
-0001a720: 2232 3032 332d 3035 2d32 3320 3137 3a35  "2023-05-23 17:5
-0001a730: 373a 3035 5a22 7d0a 2020 2020 7d2c 0a20  7:05Z"}.    },. 
-0001a740: 2020 2022 7265 6c61 7469 6f6e 7322 3a20     "relations": 
-0001a750: 7b7d 0a7d 2722 2222 290a 2020 2020 2020  {}.}'""").      
-0001a760: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001a770: 616c 2873 656c 662e 6261 636b 656e 642e  al(self.backend.
-0001a780: 706c 616e 6e65 645f 756e 6974 7328 292c  planned_units(),
-0001a790: 2031 290a 0a0a 636c 6173 7320 5465 7374   1)...class Test
-0001a7a0: 4c61 7a79 4d61 7070 696e 6728 756e 6974  LazyMapping(unit
-0001a7b0: 7465 7374 2e54 6573 7443 6173 6529 3a0a  test.TestCase):.
-0001a7c0: 0a20 2020 2064 6566 2074 6573 745f 696e  .    def test_in
-0001a7d0: 7661 6c69 6461 7465 2873 656c 6629 3a0a  validate(self):.
-0001a7e0: 2020 2020 2020 2020 6c6f 6164 6564 203d          loaded =
-0001a7f0: 205b 5d0a 0a20 2020 2020 2020 2063 6c61   []..        cla
-0001a800: 7373 204d 794c 617a 794d 6170 286f 7073  ss MyLazyMap(ops
-0001a810: 2e4c 617a 794d 6170 7069 6e67 293a 0a20  .LazyMapping):. 
-0001a820: 2020 2020 2020 2020 2020 2064 6566 205f             def _
-0001a830: 6c6f 6164 2873 656c 6629 3a0a 2020 2020  load(self):.    
-0001a840: 2020 2020 2020 2020 2020 2020 6c6f 6164              load
-0001a850: 6564 2e61 7070 656e 6428 3129 0a20 2020  ed.append(1).   
-0001a860: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0001a870: 7572 6e20 7b27 666f 6f27 3a20 2762 6172  urn {'foo': 'bar
-0001a880: 277d 0a0a 2020 2020 2020 2020 6d61 7020  '}..        map 
-0001a890: 3d20 4d79 4c61 7a79 4d61 7028 290a 2020  = MyLazyMap().  
-0001a8a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001a8b0: 7445 7175 616c 286d 6170 5b27 666f 6f27  tEqual(map['foo'
-0001a8c0: 5d2c 2027 6261 7227 290a 2020 2020 2020  ], 'bar').      
-0001a8d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001a8e0: 616c 286c 6f61 6465 642c 205b 315d 290a  al(loaded, [1]).
-0001a8f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001a900: 6572 7445 7175 616c 286d 6170 5b27 666f  ertEqual(map['fo
-0001a910: 6f27 5d2c 2027 6261 7227 290a 2020 2020  o'], 'bar').    
-0001a920: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001a930: 7175 616c 286c 6f61 6465 642c 205b 315d  qual(loaded, [1]
-0001a940: 290a 2020 2020 2020 2020 6d61 702e 5f69  ).        map._i
-0001a950: 6e76 616c 6964 6174 6528 290a 2020 2020  nvalidate().    
-0001a960: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001a970: 7175 616c 286d 6170 5b27 666f 6f27 5d2c  qual(map['foo'],
-0001a980: 2027 6261 7227 290a 2020 2020 2020 2020   'bar').        
-0001a990: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001a9a0: 286c 6f61 6465 642c 205b 312c 2031 5d29  (loaded, [1, 1])
-0001a9b0: 0a0a 0a63 6c61 7373 2054 6573 7453 6563  ...class TestSec
-0001a9c0: 7265 7473 2875 6e69 7474 6573 742e 5465  rets(unittest.Te
-0001a9d0: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
-0001a9e0: 2073 6574 5570 2873 656c 6629 3a0a 2020   setUp(self):.  
-0001a9f0: 2020 2020 2020 7365 6c66 2e6d 6f64 656c        self.model
-0001aa00: 203d 206f 7073 2e4d 6f64 656c 286f 7073   = ops.Model(ops
-0001aa10: 2e43 6861 726d 4d65 7461 2829 2c20 5f4d  .CharmMeta(), _M
-0001aa20: 6f64 656c 4261 636b 656e 6428 276d 7961  odelBackend('mya
-0001aa30: 7070 2f30 2729 290a 2020 2020 2020 2020  pp/0')).        
-0001aa40: 7365 6c66 2e61 7070 203d 2073 656c 662e  self.app = self.
-0001aa50: 6d6f 6465 6c2e 6170 700a 2020 2020 2020  model.app.      
-0001aa60: 2020 7365 6c66 2e75 6e69 7420 3d20 7365    self.unit = se
-0001aa70: 6c66 2e6d 6f64 656c 2e75 6e69 740a 0a20  lf.model.unit.. 
-0001aa80: 2020 2064 6566 2074 6573 745f 6170 705f     def test_app_
-0001aa90: 6164 645f 7365 6372 6574 5f73 696d 706c  add_secret_simpl
-0001aaa0: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-0001aab0: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-0001aac0: 662c 2027 7365 6372 6574 2d61 6464 272c  f, 'secret-add',
-0001aad0: 2027 6563 686f 2073 6563 7265 743a 3132   'echo secret:12
-0001aae0: 3327 290a 0a20 2020 2020 2020 2073 6563  3')..        sec
-0001aaf0: 7265 7420 3d20 7365 6c66 2e61 7070 2e61  ret = self.app.a
-0001ab00: 6464 5f73 6563 7265 7428 7b27 666f 6f27  dd_secret({'foo'
-0001ab10: 3a20 2778 277d 290a 2020 2020 2020 2020  : 'x'}).        
-0001ab20: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
-0001ab30: 7461 6e63 6528 7365 6372 6574 2c20 6f70  tance(secret, op
-0001ab40: 732e 5365 6372 6574 290a 2020 2020 2020  s.Secret).      
-0001ab50: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001ab60: 616c 2873 6563 7265 742e 6964 2c20 2773  al(secret.id, 's
-0001ab70: 6563 7265 743a 3132 3327 290a 2020 2020  ecret:123').    
-0001ab80: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
-0001ab90: 734e 6f6e 6528 7365 6372 6574 2e6c 6162  sNone(secret.lab
-0001aba0: 656c 290a 0a20 2020 2020 2020 2073 656c  el)..        sel
-0001abb0: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-0001abc0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-0001abd0: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
-0001abe0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0001abf0: 2020 2020 2020 2020 2020 2020 5b5b 2773              [['s
-0001ac00: 6563 7265 742d 6164 6427 2c20 272d 2d6f  ecret-add', '--o
-0001ac10: 776e 6572 272c 2027 6170 706c 6963 6174  wner', 'applicat
-0001ac20: 696f 6e27 2c20 2766 6f6f 3d78 275d 5d29  ion', 'foo=x']])
-0001ac30: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
-0001ac40: 7070 5f61 6464 5f73 6563 7265 745f 6172  pp_add_secret_ar
-0001ac50: 6773 2873 656c 6629 3a0a 2020 2020 2020  gs(self):.      
-0001ac60: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-0001ac70: 6c66 2c20 2773 6563 7265 742d 6164 6427  lf, 'secret-add'
-0001ac80: 2c20 2765 6368 6f20 7365 6372 6574 3a32  , 'echo secret:2
-0001ac90: 3334 2729 0a0a 2020 2020 2020 2020 6578  34')..        ex
-0001aca0: 7069 7265 203d 2064 6174 6574 696d 652e  pire = datetime.
-0001acb0: 6461 7465 7469 6d65 2832 3032 322c 2031  datetime(2022, 1
-0001acc0: 322c 2039 2c20 3136 2c20 3137 2c20 3029  2, 9, 16, 17, 0)
-0001acd0: 0a20 2020 2020 2020 2073 6563 7265 7420  .        secret 
-0001ace0: 3d20 7365 6c66 2e61 7070 2e61 6464 5f73  = self.app.add_s
-0001acf0: 6563 7265 7428 7b27 666f 6f27 3a20 2778  ecret({'foo': 'x
-0001ad00: 272c 2027 6261 7227 3a20 2779 277d 2c20  ', 'bar': 'y'}, 
-0001ad10: 6c61 6265 6c3d 276c 626c 272c 2064 6573  label='lbl', des
-0001ad20: 6372 6970 7469 6f6e 3d27 6465 7363 272c  cription='desc',
-0001ad30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ad40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad50: 2020 2020 2020 6578 7069 7265 3d65 7870        expire=exp
-0001ad60: 6972 652c 2072 6f74 6174 653d 6f70 732e  ire, rotate=ops.
-0001ad70: 5365 6372 6574 526f 7461 7465 2e48 4f55  SecretRotate.HOU
-0001ad80: 524c 5929 0a20 2020 2020 2020 2073 656c  RLY).        sel
-0001ad90: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0001ada0: 6372 6574 2e69 642c 2027 7365 6372 6574  cret.id, 'secret
-0001adb0: 3a32 3334 2729 0a20 2020 2020 2020 2073  :234').        s
-0001adc0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001add0: 7365 6372 6574 2e6c 6162 656c 2c20 276c  secret.label, 'l
-0001ade0: 626c 2729 0a20 2020 2020 2020 2073 656c  bl').        sel
-0001adf0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0001ae00: 6372 6574 2e67 6574 5f63 6f6e 7465 6e74  cret.get_content
-0001ae10: 2829 2c20 7b27 666f 6f27 3a20 2778 272c  (), {'foo': 'x',
-0001ae20: 2027 6261 7227 3a20 2779 277d 290a 0a20   'bar': 'y'}).. 
-0001ae30: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001ae40: 7274 4571 7561 6c28 6661 6b65 5f73 6372  rtEqual(fake_scr
-0001ae50: 6970 745f 6361 6c6c 7328 7365 6c66 2c20  ipt_calls(self, 
-0001ae60: 636c 6561 723d 5472 7565 292c 0a20 2020  clear=True),.   
-0001ae70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ae80: 2020 2020 2020 5b5b 2773 6563 7265 742d        [['secret-
-0001ae90: 6164 6427 2c20 272d 2d6c 6162 656c 272c  add', '--label',
-0001aea0: 2027 6c62 6c27 2c20 272d 2d64 6573 6372   'lbl', '--descr
-0001aeb0: 6970 7469 6f6e 272c 2027 6465 7363 272c  iption', 'desc',
-0001aec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001aed0: 2020 2020 2020 2020 2020 2020 272d 2d65              '--e
-0001aee0: 7870 6972 6527 2c20 2732 3032 322d 3132  xpire', '2022-12
-0001aef0: 2d30 3954 3136 3a31 373a 3030 272c 2027  -09T16:17:00', '
-0001af00: 2d2d 726f 7461 7465 272c 2027 686f 7572  --rotate', 'hour
-0001af10: 6c79 272c 0a20 2020 2020 2020 2020 2020  ly',.           
-0001af20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001af30: 272d 2d6f 776e 6572 272c 2027 6170 706c  '--owner', 'appl
-0001af40: 6963 6174 696f 6e27 2c20 2766 6f6f 3d78  ication', 'foo=x
-0001af50: 272c 2027 6261 723d 7927 5d5d 290a 0a20  ', 'bar=y']]).. 
-0001af60: 2020 2064 6566 2074 6573 745f 756e 6974     def test_unit
-0001af70: 5f61 6464 5f73 6563 7265 745f 7369 6d70  _add_secret_simp
-0001af80: 6c65 2873 656c 6629 3a0a 2020 2020 2020  le(self):.      
-0001af90: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-0001afa0: 6c66 2c20 2773 6563 7265 742d 6164 6427  lf, 'secret-add'
-0001afb0: 2c20 2765 6368 6f20 7365 6372 6574 3a33  , 'echo secret:3
-0001afc0: 3435 2729 0a0a 2020 2020 2020 2020 7365  45')..        se
-0001afd0: 6372 6574 203d 2073 656c 662e 756e 6974  cret = self.unit
-0001afe0: 2e61 6464 5f73 6563 7265 7428 7b27 666f  .add_secret({'fo
-0001aff0: 6f27 3a20 2778 277d 290a 2020 2020 2020  o': 'x'}).      
-0001b000: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-0001b010: 6e73 7461 6e63 6528 7365 6372 6574 2c20  nstance(secret, 
-0001b020: 6f70 732e 5365 6372 6574 290a 2020 2020  ops.Secret).    
-0001b030: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001b040: 7175 616c 2873 6563 7265 742e 6964 2c20  qual(secret.id, 
-0001b050: 2773 6563 7265 743a 3334 3527 290a 2020  'secret:345').  
-0001b060: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001b070: 7449 734e 6f6e 6528 7365 6372 6574 2e6c  tIsNone(secret.l
-0001b080: 6162 656c 290a 0a20 2020 2020 2020 2073  abel)..        s
-0001b090: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001b0a0: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
-0001b0b0: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
-0001b0c0: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
-0001b0d0: 2020 2020 2020 2020 2020 2020 2020 5b5b                [[
-0001b0e0: 2773 6563 7265 742d 6164 6427 2c20 272d  'secret-add', '-
-0001b0f0: 2d6f 776e 6572 272c 2027 756e 6974 272c  -owner', 'unit',
-0001b100: 2027 666f 6f3d 7827 5d5d 290a 0a20 2020   'foo=x']])..   
-0001b110: 2064 6566 2074 6573 745f 756e 6974 5f61   def test_unit_a
-0001b120: 6464 5f73 6563 7265 745f 6172 6773 2873  dd_secret_args(s
-0001b130: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
-0001b140: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-0001b150: 2773 6563 7265 742d 6164 6427 2c20 2765  'secret-add', 'e
-0001b160: 6368 6f20 7365 6372 6574 3a34 3536 2729  cho secret:456')
-0001b170: 0a0a 2020 2020 2020 2020 6578 7069 7265  ..        expire
-0001b180: 203d 2064 6174 6574 696d 652e 6461 7465   = datetime.date
-0001b190: 7469 6d65 2832 3032 322c 2031 322c 2039  time(2022, 12, 9
-0001b1a0: 2c20 3136 2c20 3232 2c20 3029 0a20 2020  , 16, 22, 0).   
-0001b1b0: 2020 2020 2073 6563 7265 7420 3d20 7365       secret = se
-0001b1c0: 6c66 2e75 6e69 742e 6164 645f 7365 6372  lf.unit.add_secr
-0001b1d0: 6574 287b 2766 6f6f 273a 2027 7727 2c20  et({'foo': 'w', 
-0001b1e0: 2762 6172 273a 2027 7a27 7d2c 206c 6162  'bar': 'z'}, lab
-0001b1f0: 656c 3d27 6c32 272c 2064 6573 6372 6970  el='l2', descrip
-0001b200: 7469 6f6e 3d27 7879 7a27 2c0a 2020 2020  tion='xyz',.    
-0001b210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b230: 2020 6578 7069 7265 3d65 7870 6972 652c    expire=expire,
-0001b240: 2072 6f74 6174 653d 6f70 732e 5365 6372   rotate=ops.Secr
-0001b250: 6574 526f 7461 7465 2e59 4541 524c 5929  etRotate.YEARLY)
-0001b260: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001b270: 7365 7274 4571 7561 6c28 7365 6372 6574  sertEqual(secret
-0001b280: 2e69 642c 2027 7365 6372 6574 3a34 3536  .id, 'secret:456
-0001b290: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001b2a0: 6173 7365 7274 4571 7561 6c28 7365 6372  assertEqual(secr
-0001b2b0: 6574 2e6c 6162 656c 2c20 276c 3227 290a  et.label, 'l2').
-0001b2c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001b2d0: 6572 7445 7175 616c 2873 6563 7265 742e  ertEqual(secret.
-0001b2e0: 6765 745f 636f 6e74 656e 7428 292c 207b  get_content(), {
-0001b2f0: 2766 6f6f 273a 2027 7727 2c20 2762 6172  'foo': 'w', 'bar
-0001b300: 273a 2027 7a27 7d29 0a0a 2020 2020 2020  ': 'z'})..      
-0001b310: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001b320: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
-0001b330: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
-0001b340: 3d54 7275 6529 2c0a 2020 2020 2020 2020  =True),.        
-0001b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b360: 205b 5b27 7365 6372 6574 2d61 6464 272c   [['secret-add',
-0001b370: 2027 2d2d 6c61 6265 6c27 2c20 276c 3227   '--label', 'l2'
-0001b380: 2c20 272d 2d64 6573 6372 6970 7469 6f6e  , '--description
-0001b390: 272c 2027 7879 7a27 2c0a 2020 2020 2020  ', 'xyz',.      
-0001b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b3b0: 2020 2020 2027 2d2d 6578 7069 7265 272c       '--expire',
-0001b3c0: 2027 3230 3232 2d31 322d 3039 5431 363a   '2022-12-09T16:
-0001b3d0: 3232 3a30 3027 2c20 272d 2d72 6f74 6174  22:00', '--rotat
-0001b3e0: 6527 2c20 2779 6561 726c 7927 2c0a 2020  e', 'yearly',.  
-0001b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b400: 2020 2020 2020 2020 2027 2d2d 6f77 6e65           '--owne
-0001b410: 7227 2c20 2775 6e69 7427 2c20 2766 6f6f  r', 'unit', 'foo
-0001b420: 3d77 272c 2027 6261 723d 7a27 5d5d 290a  =w', 'bar=z']]).
-0001b430: 0a20 2020 2064 6566 2074 6573 745f 756e  .    def test_un
-0001b440: 6974 5f61 6464 5f73 6563 7265 745f 6572  it_add_secret_er
-0001b450: 726f 7273 2873 656c 6629 3a0a 2020 2020  rors(self):.    
-0001b460: 2020 2020 2320 4164 6469 7469 6f6e 616c      # Additional
-0001b470: 2061 6464 5f73 6563 7265 7420 7465 7374   add_secret test
-0001b480: 7320 6172 6520 646f 6e65 2069 6e20 5465  s are done in Te
-0001b490: 7374 4170 706c 6963 6174 696f 6e0a 2020  stApplication.  
-0001b4a0: 2020 2020 2020 6572 726f 7273 203d 205b        errors = [
-0001b4b0: 0a20 2020 2020 2020 2020 2020 2028 7b27  .            ({'
-0001b4c0: 7879 273a 2027 6261 7227 7d2c 207b 7d2c  xy': 'bar'}, {},
-0001b4d0: 2056 616c 7565 4572 726f 7229 2c0a 2020   ValueError),.  
-0001b4e0: 2020 2020 2020 2020 2020 287b 2766 6f6f            ({'foo
-0001b4f0: 273a 2027 7827 7d2c 207b 2765 7870 6972  ': 'x'}, {'expir
-0001b500: 6527 3a20 377d 2c20 5479 7065 4572 726f  e': 7}, TypeErro
-0001b510: 7229 2c0a 2020 2020 2020 2020 5d0a 2020  r),.        ].  
-0001b520: 2020 2020 2020 666f 7220 636f 6e74 656e        for conten
-0001b530: 742c 206b 7761 7267 732c 2065 7863 5f74  t, kwargs, exc_t
-0001b540: 7970 6520 696e 2065 7272 6f72 733a 0a20  ype in errors:. 
-0001b550: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
-0001b560: 2066 2765 7870 6563 7465 6420 7b65 7863   f'expected {exc
-0001b570: 5f74 7970 652e 5f5f 6e61 6d65 5f5f 7d20  _type.__name__} 
-0001b580: 7768 656e 2061 6464 696e 6720 7365 6372  when adding secr
-0001b590: 6574 2063 6f6e 7465 6e74 207b 636f 6e74  et content {cont
-0001b5a0: 656e 747d 270a 2020 2020 2020 2020 2020  ent}'.          
-0001b5b0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-0001b5c0: 7274 5261 6973 6573 2865 7863 5f74 7970  rtRaises(exc_typ
-0001b5d0: 652c 206d 7367 3d6d 7367 293a 0a20 2020  e, msg=msg):.   
-0001b5e0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0001b5f0: 662e 756e 6974 2e61 6464 5f73 6563 7265  f.unit.add_secre
-0001b600: 7428 636f 6e74 656e 742c 202a 2a6b 7761  t(content, **kwa
-0001b610: 7267 7329 0a0a 2020 2020 6465 6620 7465  rgs)..    def te
-0001b620: 7374 5f61 6464 5f73 6563 7265 745f 6572  st_add_secret_er
-0001b630: 726f 7273 2873 656c 6629 3a0a 2020 2020  rors(self):.    
-0001b640: 2020 2020 6572 726f 7273 203d 205b 0a20      errors = [. 
-0001b650: 2020 2020 2020 2020 2020 2023 2049 6e76             # Inv
-0001b660: 616c 6964 2063 6f6e 7465 6e74 2064 6963  alid content dic
-0001b670: 7420 6f72 2074 7970 6573 0a20 2020 2020  t or types.     
-0001b680: 2020 2020 2020 2028 4e6f 6e65 2c20 7b7d         (None, {}
-0001b690: 2c20 5479 7065 4572 726f 7229 2c0a 2020  , TypeError),.  
-0001b6a0: 2020 2020 2020 2020 2020 287b 7d2c 207b            ({}, {
-0001b6b0: 7d2c 2056 616c 7565 4572 726f 7229 2c0a  }, ValueError),.
-0001b6c0: 2020 2020 2020 2020 2020 2020 287b 6227              ({b'
-0001b6d0: 666f 6f27 2c20 2762 6172 277d 2c20 7b7d  foo', 'bar'}, {}
-0001b6e0: 2c20 5479 7065 4572 726f 7229 2c0a 2020  , TypeError),.  
-0001b6f0: 2020 2020 2020 2020 2020 287b 333a 2027            ({3: '
-0001b700: 6261 7227 7d2c 207b 7d2c 2054 7970 6545  bar'}, {}, TypeE
-0001b710: 7272 6f72 292c 0a20 2020 2020 2020 2020  rror),.         
-0001b720: 2020 2028 7b27 666f 6f27 3a20 312c 2027     ({'foo': 1, '
-0001b730: 6261 7227 3a20 327d 2c20 7b7d 2c20 5479  bar': 2}, {}, Ty
-0001b740: 7065 4572 726f 7229 2c0a 2020 2020 2020  peError),.      
-0001b750: 2020 2020 2020 2320 496e 7661 6c69 6420        # Invalid 
-0001b760: 636f 6e74 656e 7420 6b65 7973 0a20 2020  content keys.   
-0001b770: 2020 2020 2020 2020 2028 7b27 7879 273a           ({'xy':
-0001b780: 2027 6261 7227 7d2c 207b 7d2c 2056 616c   'bar'}, {}, Val
-0001b790: 7565 4572 726f 7229 2c0a 2020 2020 2020  ueError),.      
-0001b7a0: 2020 2020 2020 287b 2746 4f4f 273a 2027        ({'FOO': '
-0001b7b0: 6261 7227 7d2c 207b 7d2c 2056 616c 7565  bar'}, {}, Value
-0001b7c0: 4572 726f 7229 2c0a 2020 2020 2020 2020  Error),.        
-0001b7d0: 2020 2020 287b 2766 6f6f 2d27 3a20 2762      ({'foo-': 'b
-0001b7e0: 6172 277d 2c20 7b7d 2c20 5661 6c75 6545  ar'}, {}, ValueE
-0001b7f0: 7272 6f72 292c 0a20 2020 2020 2020 2020  rror),.         
-0001b800: 2020 2028 7b27 2d66 6f6f 273a 2027 6261     ({'-foo': 'ba
-0001b810: 7227 7d2c 207b 7d2c 2056 616c 7565 4572  r'}, {}, ValueEr
-0001b820: 726f 7229 2c0a 2020 2020 2020 2020 2020  ror),.          
-0001b830: 2020 2320 496e 7661 6c69 6420 2265 7870    # Invalid "exp
-0001b840: 6972 6522 2074 7970 650a 2020 2020 2020  ire" type.      
-0001b850: 2020 2020 2020 287b 2766 6f6f 273a 2027        ({'foo': '
-0001b860: 7827 7d2c 207b 2765 7870 6972 6527 3a20  x'}, {'expire': 
-0001b870: 377d 2c20 5479 7065 4572 726f 7229 2c0a  7}, TypeError),.
-0001b880: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-0001b890: 2020 666f 7220 636f 6e74 656e 742c 206b    for content, k
-0001b8a0: 7761 7267 732c 2065 7863 5f74 7970 6520  wargs, exc_type 
-0001b8b0: 696e 2065 7272 6f72 733a 0a20 2020 2020  in errors:.     
-0001b8c0: 2020 2020 2020 206d 7367 203d 2066 2765         msg = f'e
-0001b8d0: 7870 6563 7465 6420 7b65 7863 5f74 7970  xpected {exc_typ
-0001b8e0: 652e 5f5f 6e61 6d65 5f5f 7d20 7768 656e  e.__name__} when
-0001b8f0: 2061 6464 696e 6720 7365 6372 6574 2063   adding secret c
-0001b900: 6f6e 7465 6e74 207b 636f 6e74 656e 747d  ontent {content}
-0001b910: 270a 2020 2020 2020 2020 2020 2020 7769  '.            wi
-0001b920: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-0001b930: 6973 6573 2865 7863 5f74 7970 652c 206d  ises(exc_type, m
-0001b940: 7367 3d6d 7367 293a 0a20 2020 2020 2020  sg=msg):.       
-0001b950: 2020 2020 2020 2020 2073 656c 662e 6170           self.ap
-0001b960: 702e 6164 645f 7365 6372 6574 2863 6f6e  p.add_secret(con
-0001b970: 7465 6e74 2c20 2a2a 6b77 6172 6773 290a  tent, **kwargs).
-0001b980: 2020 2020 2020 2020 2020 2020 7769 7468              with
-0001b990: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0001b9a0: 6573 2865 7863 5f74 7970 652c 206d 7367  es(exc_type, msg
-0001b9b0: 3d6d 7367 293a 0a20 2020 2020 2020 2020  =msg):.         
-0001b9c0: 2020 2020 2020 2073 656c 662e 756e 6974         self.unit
-0001b9d0: 2e61 6464 5f73 6563 7265 7428 636f 6e74  .add_secret(cont
-0001b9e0: 656e 742c 202a 2a6b 7761 7267 7329 0a0a  ent, **kwargs)..
-0001b9f0: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
-0001ba00: 5f73 6563 7265 745f 6964 2873 656c 6629  _secret_id(self)
-0001ba10: 3a0a 2020 2020 2020 2020 6661 6b65 5f73  :.        fake_s
-0001ba20: 6372 6970 7428 7365 6c66 2c20 2773 6563  cript(self, 'sec
-0001ba30: 7265 742d 6765 7427 2c20 2222 2265 6368  ret-get', """ech
-0001ba40: 6f20 277b 2266 6f6f 223a 2022 6722 7d27  o '{"foo": "g"}'
-0001ba50: 2222 2229 0a0a 2020 2020 2020 2020 7365  """)..        se
-0001ba60: 6372 6574 203d 2073 656c 662e 6d6f 6465  cret = self.mode
-0001ba70: 6c2e 6765 745f 7365 6372 6574 2869 643d  l.get_secret(id=
-0001ba80: 2731 3233 2729 0a20 2020 2020 2020 2073  '123').        s
-0001ba90: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001baa0: 7365 6372 6574 2e69 642c 2027 7365 6372  secret.id, 'secr
-0001bab0: 6574 3a31 3233 2729 0a20 2020 2020 2020  et:123').       
-0001bac0: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
-0001bad0: 6e65 2873 6563 7265 742e 6c61 6265 6c29  ne(secret.label)
-0001bae0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001baf0: 7365 7274 4571 7561 6c28 7365 6372 6574  sertEqual(secret
-0001bb00: 2e67 6574 5f63 6f6e 7465 6e74 2829 2c20  .get_content(), 
-0001bb10: 7b27 666f 6f27 3a20 2767 277d 290a 0a20  {'foo': 'g'}).. 
-0001bb20: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001bb30: 7274 4571 7561 6c28 6661 6b65 5f73 6372  rtEqual(fake_scr
-0001bb40: 6970 745f 6361 6c6c 7328 7365 6c66 2c20  ipt_calls(self, 
-0001bb50: 636c 6561 723d 5472 7565 292c 0a20 2020  clear=True),.   
-0001bb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb70: 2020 2020 2020 5b5b 2773 6563 7265 742d        [['secret-
-0001bb80: 6765 7427 2c20 2773 6563 7265 743a 3132  get', 'secret:12
-0001bb90: 3327 2c20 272d 2d66 6f72 6d61 743d 6a73  3', '--format=js
-0001bba0: 6f6e 275d 5d29 0a0a 2020 2020 6465 6620  on']])..    def 
-0001bbb0: 7465 7374 5f67 6574 5f73 6563 7265 745f  test_get_secret_
-0001bbc0: 6c61 6265 6c28 7365 6c66 293a 0a20 2020  label(self):.   
-0001bbd0: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-0001bbe0: 2873 656c 662c 2027 7365 6372 6574 2d67  (self, 'secret-g
-0001bbf0: 6574 272c 2022 2222 6563 686f 2027 7b22  et', """echo '{"
-0001bc00: 666f 6f22 3a20 2267 227d 2722 2222 290a  foo": "g"}'""").
-0001bc10: 0a20 2020 2020 2020 2073 6563 7265 7420  .        secret 
-0001bc20: 3d20 7365 6c66 2e6d 6f64 656c 2e67 6574  = self.model.get
-0001bc30: 5f73 6563 7265 7428 6c61 6265 6c3d 276c  _secret(label='l
-0001bc40: 626c 2729 0a20 2020 2020 2020 2073 656c  bl').        sel
-0001bc50: 662e 6173 7365 7274 4973 4e6f 6e65 2873  f.assertIsNone(s
-0001bc60: 6563 7265 742e 6964 290a 2020 2020 2020  ecret.id).      
-0001bc70: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001bc80: 616c 2873 6563 7265 742e 6c61 6265 6c2c  al(secret.label,
-0001bc90: 2027 6c62 6c27 290a 2020 2020 2020 2020   'lbl').        
-0001bca0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001bcb0: 2873 6563 7265 742e 6765 745f 636f 6e74  (secret.get_cont
-0001bcc0: 656e 7428 292c 207b 2766 6f6f 273a 2027  ent(), {'foo': '
-0001bcd0: 6727 7d29 0a0a 2020 2020 2020 2020 7365  g'})..        se
-0001bce0: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
-0001bcf0: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-0001bd00: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
-0001bd10: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-0001bd20: 2020 2020 2020 2020 2020 2020 205b 5b27               [['
-0001bd30: 7365 6372 6574 2d67 6574 272c 2027 2d2d  secret-get', '--
-0001bd40: 6c61 6265 6c27 2c20 276c 626c 272c 2027  label', 'lbl', '
-0001bd50: 2d2d 666f 726d 6174 3d6a 736f 6e27 5d5d  --format=json']]
-0001bd60: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0001bd70: 6765 745f 7365 6372 6574 5f69 645f 616e  get_secret_id_an
-0001bd80: 645f 6c61 6265 6c28 7365 6c66 293a 0a20  d_label(self):. 
-0001bd90: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-0001bda0: 7074 2873 656c 662c 2027 7365 6372 6574  pt(self, 'secret
-0001bdb0: 2d67 6574 272c 2022 2222 6563 686f 2027  -get', """echo '
-0001bdc0: 7b22 666f 6f22 3a20 2268 227d 2722 2222  {"foo": "h"}'"""
-0001bdd0: 290a 0a20 2020 2020 2020 2073 6563 7265  )..        secre
-0001bde0: 7420 3d20 7365 6c66 2e6d 6f64 656c 2e67  t = self.model.g
-0001bdf0: 6574 5f73 6563 7265 7428 6964 3d27 3132  et_secret(id='12
-0001be00: 3327 2c20 6c61 6265 6c3d 276c 2729 0a20  3', label='l'). 
-0001be10: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001be20: 7274 4571 7561 6c28 7365 6372 6574 2e69  rtEqual(secret.i
-0001be30: 642c 2027 7365 6372 6574 3a31 3233 2729  d, 'secret:123')
-0001be40: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001be50: 7365 7274 4571 7561 6c28 7365 6372 6574  sertEqual(secret
-0001be60: 2e6c 6162 656c 2c20 276c 2729 0a20 2020  .label, 'l').   
-0001be70: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001be80: 4571 7561 6c28 7365 6372 6574 2e67 6574  Equal(secret.get
-0001be90: 5f63 6f6e 7465 6e74 2829 2c20 7b27 666f  _content(), {'fo
-0001bea0: 6f27 3a20 2768 277d 290a 0a20 2020 2020  o': 'h'})..     
-0001beb0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001bec0: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
-0001bed0: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
-0001bee0: 723d 5472 7565 292c 0a20 2020 2020 2020  r=True),.       
-0001bef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bf00: 2020 5b5b 2773 6563 7265 742d 6765 7427    [['secret-get'
-0001bf10: 2c20 2773 6563 7265 743a 3132 3327 2c20  , 'secret:123', 
-0001bf20: 272d 2d6c 6162 656c 272c 2027 6c27 2c20  '--label', 'l', 
-0001bf30: 272d 2d66 6f72 6d61 743d 6a73 6f6e 275d  '--format=json']
-0001bf40: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0001bf50: 5f67 6574 5f73 6563 7265 745f 6e6f 5f61  _get_secret_no_a
-0001bf60: 7267 7328 7365 6c66 293a 0a20 2020 2020  rgs(self):.     
-0001bf70: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0001bf80: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
-0001bf90: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0001bfa0: 2020 7365 6c66 2e6d 6f64 656c 2e67 6574    self.model.get
-0001bfb0: 5f73 6563 7265 7428 290a 0a20 2020 2064  _secret()..    d
-0001bfc0: 6566 2074 6573 745f 6765 745f 7365 6372  ef test_get_secr
-0001bfd0: 6574 5f6e 6f74 5f66 6f75 6e64 2873 656c  et_not_found(sel
-0001bfe0: 6629 3a0a 2020 2020 2020 2020 7363 7269  f):.        scri
-0001bff0: 7074 203d 2022 2222 6563 686f 2027 4552  pt = """echo 'ER
-0001c000: 524f 5220 7365 6372 6574 2022 3132 3322  ROR secret "123"
-0001c010: 206e 6f74 2066 6f75 6e64 2720 3e26 323b   not found' >&2;
-0001c020: 2065 7869 7420 3122 2222 0a20 2020 2020   exit 1""".     
-0001c030: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-0001c040: 656c 662c 2027 7365 6372 6574 2d67 6574  elf, 'secret-get
-0001c050: 272c 2073 6372 6970 7429 0a20 2020 2020  ', script).     
-0001c060: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-0001c070: 656c 662c 2027 7365 6372 6574 2d69 6e66  elf, 'secret-inf
-0001c080: 6f2d 6765 7427 2c20 7363 7269 7074 290a  o-get', script).
-0001c090: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-0001c0a0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-0001c0b0: 6f70 732e 5365 6372 6574 4e6f 7446 6f75  ops.SecretNotFou
-0001c0c0: 6e64 4572 726f 7229 3a0a 2020 2020 2020  ndError):.      
-0001c0d0: 2020 2020 2020 7365 6c66 2e6d 6f64 656c        self.model
-0001c0e0: 2e67 6574 5f73 6563 7265 7428 6964 3d27  .get_secret(id='
-0001c0f0: 3132 3327 290a 0a20 2020 2064 6566 2074  123')..    def t
-0001c100: 6573 745f 6765 745f 7365 6372 6574 5f6f  est_get_secret_o
-0001c110: 7468 6572 5f65 7272 6f72 2873 656c 6629  ther_error(self)
-0001c120: 3a0a 2020 2020 2020 2020 7363 7269 7074  :.        script
-0001c130: 203d 2022 2222 6563 686f 2027 4552 524f   = """echo 'ERRO
-0001c140: 5220 6f74 6865 7220 6572 726f 7227 203e  R other error' >
-0001c150: 2632 3b20 6578 6974 2031 2222 220a 2020  &2; exit 1""".  
-0001c160: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
-0001c170: 7428 7365 6c66 2c20 2773 6563 7265 742d  t(self, 'secret-
-0001c180: 6765 7427 2c20 7363 7269 7074 290a 2020  get', script).  
-0001c190: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
-0001c1a0: 7428 7365 6c66 2c20 2773 6563 7265 742d  t(self, 'secret-
-0001c1b0: 696e 666f 2d67 6574 272c 2073 6372 6970  info-get', scrip
-0001c1c0: 7429 0a0a 2020 2020 2020 2020 7769 7468  t)..        with
-0001c1d0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0001c1e0: 6573 286f 7073 2e4d 6f64 656c 4572 726f  es(ops.ModelErro
-0001c1f0: 7229 2061 7320 636d 3a0a 2020 2020 2020  r) as cm:.      
-0001c200: 2020 2020 2020 7365 6c66 2e6d 6f64 656c        self.model
-0001c210: 2e67 6574 5f73 6563 7265 7428 6964 3d27  .get_secret(id='
-0001c220: 3132 3327 290a 2020 2020 2020 2020 7365  123').        se
-0001c230: 6c66 2e61 7373 6572 744e 6f74 4973 496e  lf.assertNotIsIn
-0001c240: 7374 616e 6365 2863 6d2e 6578 6365 7074  stance(cm.except
-0001c250: 696f 6e2c 206f 7073 2e53 6563 7265 744e  ion, ops.SecretN
-0001c260: 6f74 466f 756e 6445 7272 6f72 290a 0a0a  otFoundError)...
-0001c270: 636c 6173 7320 5465 7374 5365 6372 6574  class TestSecret
-0001c280: 496e 666f 2875 6e69 7474 6573 742e 5465  Info(unittest.Te
-0001c290: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
-0001c2a0: 2074 6573 745f 696e 6974 2873 656c 6629   test_init(self)
-0001c2b0: 3a0a 2020 2020 2020 2020 696e 666f 203d  :.        info =
-0001c2c0: 206f 7073 2e53 6563 7265 7449 6e66 6f28   ops.SecretInfo(
-0001c2d0: 0a20 2020 2020 2020 2020 2020 2069 643d  .            id=
-0001c2e0: 2733 272c 0a20 2020 2020 2020 2020 2020  '3',.           
-0001c2f0: 206c 6162 656c 3d27 6c62 6c27 2c0a 2020   label='lbl',.  
-0001c300: 2020 2020 2020 2020 2020 7265 7669 7369            revisi
-0001c310: 6f6e 3d37 2c0a 2020 2020 2020 2020 2020  on=7,.          
-0001c320: 2020 6578 7069 7265 733d 6461 7465 7469    expires=dateti
-0001c330: 6d65 2e64 6174 6574 696d 6528 3230 3232  me.datetime(2022
-0001c340: 2c20 3132 2c20 392c 2031 342c 2031 302c  , 12, 9, 14, 10,
-0001c350: 2030 292c 0a20 2020 2020 2020 2020 2020   0),.           
-0001c360: 2072 6f74 6174 696f 6e3d 6f70 732e 5365   rotation=ops.Se
-0001c370: 6372 6574 526f 7461 7465 2e4d 4f4e 5448  cretRotate.MONTH
-0001c380: 4c59 2c0a 2020 2020 2020 2020 2020 2020  LY,.            
-0001c390: 726f 7461 7465 733d 6461 7465 7469 6d65  rotates=datetime
-0001c3a0: 2e64 6174 6574 696d 6528 3230 3233 2c20  .datetime(2023, 
-0001c3b0: 312c 2039 2c20 3134 2c20 3130 2c20 3029  1, 9, 14, 10, 0)
-0001c3c0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-0001c3d0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001c3e0: 7175 616c 2869 6e66 6f2e 6964 2c20 2773  qual(info.id, 's
-0001c3f0: 6563 7265 743a 3327 290a 2020 2020 2020  ecret:3').      
-0001c400: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001c410: 616c 2869 6e66 6f2e 6c61 6265 6c2c 2027  al(info.label, '
-0001c420: 6c62 6c27 290a 2020 2020 2020 2020 7365  lbl').        se
-0001c430: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
-0001c440: 6e66 6f2e 7265 7669 7369 6f6e 2c20 3729  nfo.revision, 7)
-0001c450: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001c460: 7365 7274 4571 7561 6c28 696e 666f 2e65  sertEqual(info.e
-0001c470: 7870 6972 6573 2c20 6461 7465 7469 6d65  xpires, datetime
-0001c480: 2e64 6174 6574 696d 6528 3230 3232 2c20  .datetime(2022, 
-0001c490: 3132 2c20 392c 2031 342c 2031 302c 2030  12, 9, 14, 10, 0
-0001c4a0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-0001c4b0: 6173 7365 7274 4571 7561 6c28 696e 666f  assertEqual(info
-0001c4c0: 2e72 6f74 6174 696f 6e2c 206f 7073 2e53  .rotation, ops.S
-0001c4d0: 6563 7265 7452 6f74 6174 652e 4d4f 4e54  ecretRotate.MONT
-0001c4e0: 484c 5929 0a20 2020 2020 2020 2073 656c  HLY).        sel
-0001c4f0: 662e 6173 7365 7274 4571 7561 6c28 696e  f.assertEqual(in
-0001c500: 666f 2e72 6f74 6174 6573 2c20 6461 7465  fo.rotates, date
-0001c510: 7469 6d65 2e64 6174 6574 696d 6528 3230  time.datetime(20
-0001c520: 3233 2c20 312c 2039 2c20 3134 2c20 3130  23, 1, 9, 14, 10
-0001c530: 2c20 3029 290a 0a20 2020 2020 2020 2073  , 0))..        s
-0001c540: 656c 662e 6173 7365 7274 5472 7565 2872  elf.assertTrue(r
-0001c550: 6570 7228 696e 666f 292e 7374 6172 7473  epr(info).starts
-0001c560: 7769 7468 2827 5365 6372 6574 496e 666f  with('SecretInfo
-0001c570: 2827 2929 0a20 2020 2020 2020 2073 656c  (')).        sel
-0001c580: 662e 6173 7365 7274 5472 7565 2872 6570  f.assertTrue(rep
-0001c590: 7228 696e 666f 292e 656e 6473 7769 7468  r(info).endswith
-0001c5a0: 2827 2927 2929 0a0a 2020 2020 6465 6620  (')'))..    def 
-0001c5b0: 7465 7374 5f66 726f 6d5f 6469 6374 2873  test_from_dict(s
-0001c5c0: 656c 6629 3a0a 2020 2020 2020 2020 7574  elf):.        ut
-0001c5d0: 6320 3d20 6461 7465 7469 6d65 2e74 696d  c = datetime.tim
-0001c5e0: 657a 6f6e 652e 7574 630a 2020 2020 2020  ezone.utc.      
-0001c5f0: 2020 696e 666f 203d 206f 7073 2e53 6563    info = ops.Sec
-0001c600: 7265 7449 6e66 6f2e 6672 6f6d 5f64 6963  retInfo.from_dic
-0001c610: 7428 2773 6563 7265 743a 3427 2c20 7b0a  t('secret:4', {.
-0001c620: 2020 2020 2020 2020 2020 2020 276c 6162              'lab
-0001c630: 656c 273a 2027 6672 6f6d 6469 6374 272c  el': 'fromdict',
-0001c640: 0a20 2020 2020 2020 2020 2020 2027 7265  .            're
-0001c650: 7669 7369 6f6e 273a 2038 2c0a 2020 2020  vision': 8,.    
-0001c660: 2020 2020 2020 2020 2765 7870 6972 6573          'expires
-0001c670: 273a 2027 3230 3232 2d31 322d 3039 5431  ': '2022-12-09T1
-0001c680: 343a 3130 3a30 305a 272c 0a20 2020 2020  4:10:00Z',.     
-0001c690: 2020 2020 2020 2027 726f 7461 7469 6f6e         'rotation
-0001c6a0: 273a 2027 7965 6172 6c79 272c 0a20 2020  ': 'yearly',.   
-0001c6b0: 2020 2020 2020 2020 2027 726f 7461 7465           'rotate
-0001c6c0: 7327 3a20 2732 3032 332d 3031 2d30 3954  s': '2023-01-09T
-0001c6d0: 3134 3a31 303a 3030 5a27 2c0a 2020 2020  14:10:00Z',.    
-0001c6e0: 2020 2020 7d29 0a20 2020 2020 2020 2073      }).        s
-0001c6f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001c700: 696e 666f 2e69 642c 2027 7365 6372 6574  info.id, 'secret
-0001c710: 3a34 2729 0a20 2020 2020 2020 2073 656c  :4').        sel
-0001c720: 662e 6173 7365 7274 4571 7561 6c28 696e  f.assertEqual(in
-0001c730: 666f 2e6c 6162 656c 2c20 2766 726f 6d64  fo.label, 'fromd
-0001c740: 6963 7427 290a 2020 2020 2020 2020 7365  ict').        se
-0001c750: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
-0001c760: 6e66 6f2e 7265 7669 7369 6f6e 2c20 3829  nfo.revision, 8)
-0001c770: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001c780: 7365 7274 4571 7561 6c28 696e 666f 2e65  sertEqual(info.e
-0001c790: 7870 6972 6573 2c20 6461 7465 7469 6d65  xpires, datetime
-0001c7a0: 2e64 6174 6574 696d 6528 3230 3232 2c20  .datetime(2022, 
-0001c7b0: 3132 2c20 392c 2031 342c 2031 302c 2030  12, 9, 14, 10, 0
-0001c7c0: 2c20 747a 696e 666f 3d75 7463 2929 0a20  , tzinfo=utc)). 
-0001c7d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001c7e0: 7274 4571 7561 6c28 696e 666f 2e72 6f74  rtEqual(info.rot
-0001c7f0: 6174 696f 6e2c 206f 7073 2e53 6563 7265  ation, ops.Secre
-0001c800: 7452 6f74 6174 652e 5945 4152 4c59 290a  tRotate.YEARLY).
-0001c810: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001c820: 6572 7445 7175 616c 2869 6e66 6f2e 726f  ertEqual(info.ro
-0001c830: 7461 7465 732c 2064 6174 6574 696d 652e  tates, datetime.
-0001c840: 6461 7465 7469 6d65 2832 3032 332c 2031  datetime(2023, 1
-0001c850: 2c20 392c 2031 342c 2031 302c 2030 2c20  , 9, 14, 10, 0, 
-0001c860: 747a 696e 666f 3d75 7463 2929 0a0a 2020  tzinfo=utc))..  
-0001c870: 2020 2020 2020 696e 666f 203d 206f 7073        info = ops
-0001c880: 2e53 6563 7265 7449 6e66 6f2e 6672 6f6d  .SecretInfo.from
-0001c890: 5f64 6963 7428 2773 6563 7265 743a 3427  _dict('secret:4'
-0001c8a0: 2c20 7b0a 2020 2020 2020 2020 2020 2020  , {.            
-0001c8b0: 276c 6162 656c 273a 2027 6672 6f6d 6469  'label': 'fromdi
-0001c8c0: 6374 272c 0a20 2020 2020 2020 2020 2020  ct',.           
-0001c8d0: 2027 7265 7669 7369 6f6e 273a 2038 2c0a   'revision': 8,.
-0001c8e0: 2020 2020 2020 2020 2020 2020 2772 6f74              'rot
-0001c8f0: 6174 696f 6e27 3a20 2762 6164 7661 6c75  ation': 'badvalu
-0001c900: 6527 2c0a 2020 2020 2020 2020 7d29 0a20  e',.        }). 
-0001c910: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001c920: 7274 4571 7561 6c28 696e 666f 2e69 642c  rtEqual(info.id,
-0001c930: 2027 7365 6372 6574 3a34 2729 0a20 2020   'secret:4').   
-0001c940: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001c950: 4571 7561 6c28 696e 666f 2e6c 6162 656c  Equal(info.label
-0001c960: 2c20 2766 726f 6d64 6963 7427 290a 2020  , 'fromdict').  
-0001c970: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001c980: 7445 7175 616c 2869 6e66 6f2e 7265 7669  tEqual(info.revi
-0001c990: 7369 6f6e 2c20 3829 0a20 2020 2020 2020  sion, 8).       
-0001c9a0: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
-0001c9b0: 6e65 2869 6e66 6f2e 6578 7069 7265 7329  ne(info.expires)
-0001c9c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001c9d0: 7365 7274 4973 4e6f 6e65 2869 6e66 6f2e  sertIsNone(info.
-0001c9e0: 726f 7461 7469 6f6e 290a 2020 2020 2020  rotation).      
-0001c9f0: 2020 7365 6c66 2e61 7373 6572 7449 734e    self.assertIsN
-0001ca00: 6f6e 6528 696e 666f 2e72 6f74 6174 6573  one(info.rotates
-0001ca10: 290a 0a20 2020 2020 2020 2069 6e66 6f20  )..        info 
-0001ca20: 3d20 6f70 732e 5365 6372 6574 496e 666f  = ops.SecretInfo
-0001ca30: 2e66 726f 6d5f 6469 6374 2827 3527 2c20  .from_dict('5', 
-0001ca40: 7b27 7265 7669 7369 6f6e 273a 2039 7d29  {'revision': 9})
-0001ca50: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001ca60: 7365 7274 4571 7561 6c28 696e 666f 2e69  sertEqual(info.i
-0001ca70: 642c 2027 7365 6372 6574 3a35 2729 0a20  d, 'secret:5'). 
-0001ca80: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001ca90: 7274 4571 7561 6c28 696e 666f 2e72 6576  rtEqual(info.rev
-0001caa0: 6973 696f 6e2c 2039 290a 0a0a 636c 6173  ision, 9)...clas
-0001cab0: 7320 5465 7374 5365 6372 6574 436c 6173  s TestSecretClas
-0001cac0: 7328 756e 6974 7465 7374 2e54 6573 7443  s(unittest.TestC
-0001cad0: 6173 6529 3a0a 2020 2020 6d61 7844 6966  ase):.    maxDif
-0001cae0: 6620 3d20 3634 202a 2031 3032 340a 0a20  f = 64 * 1024.. 
-0001caf0: 2020 2064 6566 2073 6574 5570 2873 656c     def setUp(sel
-0001cb00: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-0001cb10: 2e6d 6f64 656c 203d 206f 7073 2e4d 6f64  .model = ops.Mod
-0001cb20: 656c 286f 7073 2e43 6861 726d 4d65 7461  el(ops.CharmMeta
-0001cb30: 2829 2c20 5f4d 6f64 656c 4261 636b 656e  (), _ModelBacken
-0001cb40: 6428 276d 7961 7070 2f30 2729 290a 0a20  d('myapp/0')).. 
-0001cb50: 2020 2064 6566 206d 616b 655f 7365 6372     def make_secr
-0001cb60: 6574 2873 656c 662c 2069 643d 4e6f 6e65  et(self, id=None
-0001cb70: 2c20 6c61 6265 6c3d 4e6f 6e65 2c20 636f  , label=None, co
-0001cb80: 6e74 656e 743d 4e6f 6e65 293a 0a20 2020  ntent=None):.   
-0001cb90: 2020 2020 2072 6574 7572 6e20 6f70 732e       return ops.
-0001cba0: 5365 6372 6574 2873 656c 662e 6d6f 6465  Secret(self.mode
-0001cbb0: 6c2e 5f62 6163 6b65 6e64 2c20 6964 3d69  l._backend, id=i
-0001cbc0: 642c 206c 6162 656c 3d6c 6162 656c 2c20  d, label=label, 
-0001cbd0: 636f 6e74 656e 743d 636f 6e74 656e 7429  content=content)
-0001cbe0: 0a0a 2020 2020 6465 6620 7465 7374 5f69  ..    def test_i
-0001cbf0: 645f 616e 645f 6c61 6265 6c28 7365 6c66  d_and_label(self
-0001cc00: 293a 0a20 2020 2020 2020 2073 6563 7265  ):.        secre
-0001cc10: 7420 3d20 7365 6c66 2e6d 616b 655f 7365  t = self.make_se
-0001cc20: 6372 6574 2869 643d 2720 6162 6320 272c  cret(id=' abc ',
-0001cc30: 206c 6162 656c 3d27 6c62 6c27 290a 2020   label='lbl').  
-0001cc40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001cc50: 7445 7175 616c 2873 6563 7265 742e 6964  tEqual(secret.id
-0001cc60: 2c20 2773 6563 7265 743a 6162 6327 290a  , 'secret:abc').
-0001cc70: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001cc80: 6572 7445 7175 616c 2873 6563 7265 742e  ertEqual(secret.
-0001cc90: 6c61 6265 6c2c 2027 6c62 6c27 290a 0a20  label, 'lbl').. 
-0001cca0: 2020 2020 2020 2073 6563 7265 7420 3d20         secret = 
-0001ccb0: 7365 6c66 2e6d 616b 655f 7365 6372 6574  self.make_secret
-0001ccc0: 2869 643d 2778 2729 0a20 2020 2020 2020  (id='x').       
-0001ccd0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001cce0: 6c28 7365 6372 6574 2e69 642c 2027 7365  l(secret.id, 'se
-0001ccf0: 6372 6574 3a78 2729 0a20 2020 2020 2020  cret:x').       
-0001cd00: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
-0001cd10: 6e65 2873 6563 7265 742e 6c61 6265 6c29  ne(secret.label)
-0001cd20: 0a0a 2020 2020 2020 2020 7365 6372 6574  ..        secret
-0001cd30: 203d 2073 656c 662e 6d61 6b65 5f73 6563   = self.make_sec
-0001cd40: 7265 7428 6c61 6265 6c3d 2779 2729 0a20  ret(label='y'). 
-0001cd50: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001cd60: 7274 4973 4e6f 6e65 2873 6563 7265 742e  rtIsNone(secret.
-0001cd70: 6964 290a 2020 2020 2020 2020 7365 6c66  id).        self
-0001cd80: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
-0001cd90: 7265 742e 6c61 6265 6c2c 2027 7927 290a  ret.label, 'y').
-0001cda0: 0a20 2020 2064 6566 2074 6573 745f 6765  .    def test_ge
-0001cdb0: 745f 636f 6e74 656e 745f 6361 6368 6564  t_content_cached
-0001cdc0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0001cdd0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-0001cde0: 2c20 2773 6563 7265 742d 6765 7427 2c20  , 'secret-get', 
-0001cdf0: 2222 2265 7869 7420 3122 2222 290a 0a20  """exit 1""").. 
-0001ce00: 2020 2020 2020 2073 6563 7265 7420 3d20         secret = 
-0001ce10: 7365 6c66 2e6d 616b 655f 7365 6372 6574  self.make_secret
-0001ce20: 2869 643d 2778 272c 206c 6162 656c 3d27  (id='x', label='
-0001ce30: 7927 2c20 636f 6e74 656e 743d 7b27 666f  y', content={'fo
-0001ce40: 6f27 3a20 2762 6172 277d 290a 2020 2020  o': 'bar'}).    
-0001ce50: 2020 2020 636f 6e74 656e 7420 3d20 7365      content = se
-0001ce60: 6372 6574 2e67 6574 5f63 6f6e 7465 6e74  cret.get_content
-0001ce70: 2829 2020 2320 7769 6c6c 2075 7365 2063  ()  # will use c
-0001ce80: 6163 6865 6420 636f 6e74 656e 742c 206e  ached content, n
-0001ce90: 6f74 2072 756e 2073 6563 7265 742d 6765  ot run secret-ge
-0001cea0: 740a 2020 2020 2020 2020 7365 6c66 2e61  t.        self.a
-0001ceb0: 7373 6572 7445 7175 616c 2863 6f6e 7465  ssertEqual(conte
-0001cec0: 6e74 2c20 7b27 666f 6f27 3a20 2762 6172  nt, {'foo': 'bar
-0001ced0: 277d 290a 0a20 2020 2020 2020 2073 656c  '})..        sel
-0001cee0: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-0001cef0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-0001cf00: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
-0001cf10: 292c 205b 5d29 0a0a 2020 2020 6465 6620  ), [])..    def 
-0001cf20: 7465 7374 5f67 6574 5f63 6f6e 7465 6e74  test_get_content
-0001cf30: 5f72 6566 7265 7368 2873 656c 6629 3a0a  _refresh(self):.
-0001cf40: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-0001cf50: 6970 7428 7365 6c66 2c20 2773 6563 7265  ipt(self, 'secre
-0001cf60: 742d 6765 7427 2c20 2222 2265 6368 6f20  t-get', """echo 
-0001cf70: 277b 2266 6f6f 223a 2022 7265 6672 6573  '{"foo": "refres
-0001cf80: 6865 6422 7d27 2222 2229 0a0a 2020 2020  hed"}'""")..    
-0001cf90: 2020 2020 7365 6372 6574 203d 2073 656c      secret = sel
-0001cfa0: 662e 6d61 6b65 5f73 6563 7265 7428 6964  f.make_secret(id
-0001cfb0: 3d27 7927 2c20 636f 6e74 656e 743d 7b27  ='y', content={'
-0001cfc0: 666f 6f27 3a20 2762 6172 277d 290a 2020  foo': 'bar'}).  
-0001cfd0: 2020 2020 2020 636f 6e74 656e 7420 3d20        content = 
-0001cfe0: 7365 6372 6574 2e67 6574 5f63 6f6e 7465  secret.get_conte
-0001cff0: 6e74 2872 6566 7265 7368 3d54 7275 6529  nt(refresh=True)
-0001d000: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001d010: 7365 7274 4571 7561 6c28 636f 6e74 656e  sertEqual(conten
-0001d020: 742c 207b 2766 6f6f 273a 2027 7265 6672  t, {'foo': 'refr
-0001d030: 6573 6865 6427 7d29 0a0a 2020 2020 2020  eshed'})..      
-0001d040: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001d050: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
-0001d060: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
-0001d070: 3d54 7275 6529 2c0a 2020 2020 2020 2020  =True),.        
-0001d080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d090: 205b 5b27 7365 6372 6574 2d67 6574 272c   [['secret-get',
-0001d0a0: 2027 7365 6372 6574 3a79 272c 2027 2d2d   'secret:y', '--
-0001d0b0: 7265 6672 6573 6827 2c20 272d 2d66 6f72  refresh', '--for
-0001d0c0: 6d61 743d 6a73 6f6e 275d 5d29 0a0a 2020  mat=json']])..  
-0001d0d0: 2020 6465 6620 7465 7374 5f67 6574 5f63    def test_get_c
-0001d0e0: 6f6e 7465 6e74 5f75 6e63 6163 6865 6428  ontent_uncached(
-0001d0f0: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
-0001d100: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-0001d110: 2027 7365 6372 6574 2d67 6574 272c 2022   'secret-get', "
-0001d120: 2222 6563 686f 2027 7b22 666f 6f22 3a20  ""echo '{"foo": 
-0001d130: 226e 6f74 6361 6368 6564 227d 2722 2222  "notcached"}'"""
-0001d140: 290a 0a20 2020 2020 2020 2073 6563 7265  )..        secre
-0001d150: 7420 3d20 7365 6c66 2e6d 616b 655f 7365  t = self.make_se
-0001d160: 6372 6574 2869 643d 277a 2729 0a20 2020  cret(id='z').   
-0001d170: 2020 2020 2063 6f6e 7465 6e74 203d 2073       content = s
-0001d180: 6563 7265 742e 6765 745f 636f 6e74 656e  ecret.get_conten
-0001d190: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-0001d1a0: 2e61 7373 6572 7445 7175 616c 2863 6f6e  .assertEqual(con
-0001d1b0: 7465 6e74 2c20 7b27 666f 6f27 3a20 276e  tent, {'foo': 'n
-0001d1c0: 6f74 6361 6368 6564 277d 290a 0a20 2020  otcached'})..   
-0001d1d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001d1e0: 4571 7561 6c28 6661 6b65 5f73 6372 6970  Equal(fake_scrip
-0001d1f0: 745f 6361 6c6c 7328 7365 6c66 2c20 636c  t_calls(self, cl
-0001d200: 6561 723d 5472 7565 292c 0a20 2020 2020  ear=True),.     
-0001d210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d220: 2020 2020 5b5b 2773 6563 7265 742d 6765      [['secret-ge
-0001d230: 7427 2c20 2773 6563 7265 743a 7a27 2c20  t', 'secret:z', 
-0001d240: 272d 2d66 6f72 6d61 743d 6a73 6f6e 275d  '--format=json']
-0001d250: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0001d260: 5f70 6565 6b5f 636f 6e74 656e 7428 7365  _peek_content(se
-0001d270: 6c66 293a 0a20 2020 2020 2020 2066 616b  lf):.        fak
-0001d280: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-0001d290: 7365 6372 6574 2d67 6574 272c 2022 2222  secret-get', """
-0001d2a0: 6563 686f 2027 7b22 666f 6f22 3a20 2270  echo '{"foo": "p
-0001d2b0: 6565 6b65 6422 7d27 2222 2229 0a0a 2020  eeked"}'""")..  
-0001d2c0: 2020 2020 2020 7365 6372 6574 203d 2073        secret = s
-0001d2d0: 656c 662e 6d61 6b65 5f73 6563 7265 7428  elf.make_secret(
-0001d2e0: 6964 3d27 6127 2c20 6c61 6265 6c3d 2762  id='a', label='b
-0001d2f0: 2729 0a20 2020 2020 2020 2063 6f6e 7465  ').        conte
-0001d300: 6e74 203d 2073 6563 7265 742e 7065 656b  nt = secret.peek
-0001d310: 5f63 6f6e 7465 6e74 2829 0a20 2020 2020  _content().     
-0001d320: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001d330: 7561 6c28 636f 6e74 656e 742c 207b 2766  ual(content, {'f
-0001d340: 6f6f 273a 2027 7065 656b 6564 277d 290a  oo': 'peeked'}).
-0001d350: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001d360: 7365 7274 4571 7561 6c28 6661 6b65 5f73  sertEqual(fake_s
-0001d370: 6372 6970 745f 6361 6c6c 7328 7365 6c66  cript_calls(self
-0001d380: 2c20 636c 6561 723d 5472 7565 292c 0a20  , clear=True),. 
-0001d390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d3a0: 2020 2020 2020 2020 5b5b 2773 6563 7265          [['secre
-0001d3b0: 742d 6765 7427 2c20 2773 6563 7265 743a  t-get', 'secret:
-0001d3c0: 6127 2c20 272d 2d6c 6162 656c 272c 2027  a', '--label', '
-0001d3d0: 6227 2c20 272d 2d70 6565 6b27 2c20 272d  b', '--peek', '-
-0001d3e0: 2d66 6f72 6d61 743d 6a73 6f6e 275d 5d29  -format=json']])
-0001d3f0: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
-0001d400: 6574 5f69 6e66 6f28 7365 6c66 293a 0a20  et_info(self):. 
-0001d410: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-0001d420: 7074 2873 656c 662c 2027 7365 6372 6574  pt(self, 'secret
-0001d430: 2d69 6e66 6f2d 6765 7427 2c20 2222 2265  -info-get', """e
-0001d440: 6368 6f20 277b 2278 223a 207b 226c 6162  cho '{"x": {"lab
-0001d450: 656c 223a 2022 7922 2c20 2272 6576 6973  el": "y", "revis
-0001d460: 696f 6e22 3a20 377d 7d27 2222 2229 0a0a  ion": 7}}'""")..
-0001d470: 2020 2020 2020 2020 2320 5365 6372 6574          # Secret
-0001d480: 2077 6974 6820 4944 206f 6e6c 790a 2020   with ID only.  
-0001d490: 2020 2020 2020 7365 6372 6574 203d 2073        secret = s
-0001d4a0: 656c 662e 6d61 6b65 5f73 6563 7265 7428  elf.make_secret(
-0001d4b0: 6964 3d27 7827 290a 2020 2020 2020 2020  id='x').        
-0001d4c0: 696e 666f 203d 2073 6563 7265 742e 6765  info = secret.ge
-0001d4d0: 745f 696e 666f 2829 0a20 2020 2020 2020  t_info().       
-0001d4e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001d4f0: 6c28 696e 666f 2e69 642c 2027 7365 6372  l(info.id, 'secr
-0001d500: 6574 3a78 2729 0a20 2020 2020 2020 2073  et:x').        s
-0001d510: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001d520: 696e 666f 2e6c 6162 656c 2c20 2779 2729  info.label, 'y')
-0001d530: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001d540: 7365 7274 4571 7561 6c28 696e 666f 2e72  sertEqual(info.r
-0001d550: 6576 6973 696f 6e2c 2037 290a 0a20 2020  evision, 7)..   
-0001d560: 2020 2020 2023 2053 6563 7265 7420 7769       # Secret wi
-0001d570: 7468 206c 6162 656c 206f 6e6c 790a 2020  th label only.  
-0001d580: 2020 2020 2020 7365 6372 6574 203d 2073        secret = s
-0001d590: 656c 662e 6d61 6b65 5f73 6563 7265 7428  elf.make_secret(
-0001d5a0: 6c61 6265 6c3d 2779 2729 0a20 2020 2020  label='y').     
-0001d5b0: 2020 2069 6e66 6f20 3d20 7365 6372 6574     info = secret
-0001d5c0: 2e67 6574 5f69 6e66 6f28 290a 2020 2020  .get_info().    
-0001d5d0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001d5e0: 7175 616c 2869 6e66 6f2e 6964 2c20 2773  qual(info.id, 's
-0001d5f0: 6563 7265 743a 7827 290a 2020 2020 2020  ecret:x').      
-0001d600: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001d610: 616c 2869 6e66 6f2e 6c61 6265 6c2c 2027  al(info.label, '
-0001d620: 7927 290a 2020 2020 2020 2020 7365 6c66  y').        self
-0001d630: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
-0001d640: 6f2e 7265 7669 7369 6f6e 2c20 3729 0a0a  o.revision, 7)..
-0001d650: 2020 2020 2020 2020 2320 5365 6372 6574          # Secret
-0001d660: 2077 6974 6820 4944 2061 6e64 206c 6162   with ID and lab
-0001d670: 656c 0a20 2020 2020 2020 2073 6563 7265  el.        secre
-0001d680: 7420 3d20 7365 6c66 2e6d 616b 655f 7365  t = self.make_se
-0001d690: 6372 6574 2869 643d 2778 272c 206c 6162  cret(id='x', lab
-0001d6a0: 656c 3d27 7927 290a 2020 2020 2020 2020  el='y').        
-0001d6b0: 696e 666f 203d 2073 6563 7265 742e 6765  info = secret.ge
-0001d6c0: 745f 696e 666f 2829 0a20 2020 2020 2020  t_info().       
-0001d6d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001d6e0: 6c28 696e 666f 2e69 642c 2027 7365 6372  l(info.id, 'secr
-0001d6f0: 6574 3a78 2729 0a20 2020 2020 2020 2073  et:x').        s
-0001d700: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001d710: 696e 666f 2e6c 6162 656c 2c20 2779 2729  info.label, 'y')
-0001d720: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001d730: 7365 7274 4571 7561 6c28 696e 666f 2e72  sertEqual(info.r
-0001d740: 6576 6973 696f 6e2c 2037 290a 0a20 2020  evision, 7)..   
-0001d750: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001d760: 4571 7561 6c28 0a20 2020 2020 2020 2020  Equal(.         
-0001d770: 2020 2066 616b 655f 7363 7269 7074 5f63     fake_script_c
-0001d780: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
-0001d790: 3d54 7275 6529 2c0a 2020 2020 2020 2020  =True),.        
-0001d7a0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0001d7b0: 2020 2020 2020 5b27 7365 6372 6574 2d69        ['secret-i
-0001d7c0: 6e66 6f2d 6765 7427 2c20 2773 6563 7265  nfo-get', 'secre
-0001d7d0: 743a 7827 2c20 272d 2d66 6f72 6d61 743d  t:x', '--format=
-0001d7e0: 6a73 6f6e 275d 2c0a 2020 2020 2020 2020  json'],.        
-0001d7f0: 2020 2020 2020 2020 5b27 7365 6372 6574          ['secret
-0001d800: 2d69 6e66 6f2d 6765 7427 2c20 272d 2d6c  -info-get', '--l
-0001d810: 6162 656c 272c 2027 7927 2c20 272d 2d66  abel', 'y', '--f
-0001d820: 6f72 6d61 743d 6a73 6f6e 275d 2c0a 2020  ormat=json'],.  
-0001d830: 2020 2020 2020 2020 2020 2020 2020 5b27                ['
-0001d840: 7365 6372 6574 2d69 6e66 6f2d 6765 7427  secret-info-get'
-0001d850: 2c20 2773 6563 7265 743a 7827 2c20 272d  , 'secret:x', '-
-0001d860: 2d66 6f72 6d61 743d 6a73 6f6e 275d 2c0a  -format=json'],.
-0001d870: 2020 2020 2020 2020 2020 2020 5d29 0a0a              ])..
-0001d880: 2020 2020 6465 6620 7465 7374 5f73 6574      def test_set
-0001d890: 5f63 6f6e 7465 6e74 2873 656c 6629 3a0a  _content(self):.
-0001d8a0: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-0001d8b0: 6970 7428 7365 6c66 2c20 2773 6563 7265  ipt(self, 'secre
-0001d8c0: 742d 7365 7427 2c20 2222 2265 7869 7420  t-set', """exit 
-0001d8d0: 3022 2222 290a 2020 2020 2020 2020 6661  0""").        fa
-0001d8e0: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-0001d8f0: 2773 6563 7265 742d 696e 666f 2d67 6574  'secret-info-get
-0001d900: 272c 2022 2222 6563 686f 2027 7b22 7a22  ', """echo '{"z"
-0001d910: 3a20 7b22 6c61 6265 6c22 3a20 2279 222c  : {"label": "y",
-0001d920: 2022 7265 7669 7369 6f6e 223a 2037 7d7d   "revision": 7}}
-0001d930: 2722 2222 290a 0a20 2020 2020 2020 2073  '""")..        s
-0001d940: 6563 7265 7420 3d20 7365 6c66 2e6d 616b  ecret = self.mak
-0001d950: 655f 7365 6372 6574 2869 643d 2778 2729  e_secret(id='x')
-0001d960: 0a20 2020 2020 2020 2073 6563 7265 742e  .        secret.
-0001d970: 7365 745f 636f 6e74 656e 7428 7b27 666f  set_content({'fo
-0001d980: 6f27 3a20 2762 6172 277d 290a 0a20 2020  o': 'bar'})..   
-0001d990: 2020 2020 2023 2049 6620 7365 6372 6574       # If secret
-0001d9a0: 2064 6f65 736e 2774 2068 6176 6520 616e   doesn't have an
-0001d9b0: 2049 442c 2077 6527 6c6c 2072 756e 2073   ID, we'll run s
-0001d9c0: 6563 7265 742d 696e 666f 2d67 6574 2074  ecret-info-get t
-0001d9d0: 6f20 6665 7463 6820 6974 0a20 2020 2020  o fetch it.     
-0001d9e0: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
-0001d9f0: 2e6d 616b 655f 7365 6372 6574 286c 6162  .make_secret(lab
-0001da00: 656c 3d27 7927 290a 2020 2020 2020 2020  el='y').        
-0001da10: 7365 6c66 2e61 7373 6572 7449 734e 6f6e  self.assertIsNon
-0001da20: 6528 7365 6372 6574 2e69 6429 0a20 2020  e(secret.id).   
-0001da30: 2020 2020 2073 6563 7265 742e 7365 745f       secret.set_
-0001da40: 636f 6e74 656e 7428 7b27 6261 7227 3a20  content({'bar': 
-0001da50: 2766 6f6f 277d 290a 2020 2020 2020 2020  'foo'}).        
-0001da60: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001da70: 2873 6563 7265 742e 6964 2c20 2773 6563  (secret.id, 'sec
-0001da80: 7265 743a 7a27 290a 0a20 2020 2020 2020  ret:z')..       
-0001da90: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-0001daa0: 7452 6169 7365 7328 5661 6c75 6545 7272  tRaises(ValueErr
-0001dab0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-0001dac0: 2073 6563 7265 742e 7365 745f 636f 6e74   secret.set_cont
-0001dad0: 656e 7428 7b27 7327 3a20 2774 277d 2920  ent({'s': 't'}) 
-0001dae0: 2023 2065 6e73 7572 6520 6974 2076 616c   # ensure it val
-0001daf0: 6964 6174 6573 2063 6f6e 7465 6e74 2028  idates content (
-0001db00: 6b65 7920 746f 6f20 7368 6f72 7429 0a0a  key too short)..
-0001db10: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001db20: 6572 7445 7175 616c 2866 616b 655f 7363  ertEqual(fake_sc
-0001db30: 7269 7074 5f63 616c 6c73 2873 656c 662c  ript_calls(self,
-0001db40: 2063 6c65 6172 3d54 7275 6529 2c20 5b0a   clear=True), [.
-0001db50: 2020 2020 2020 2020 2020 2020 5b27 7365              ['se
-0001db60: 6372 6574 2d73 6574 272c 2027 7365 6372  cret-set', 'secr
-0001db70: 6574 3a78 272c 2027 666f 6f3d 6261 7227  et:x', 'foo=bar'
-0001db80: 5d2c 0a20 2020 2020 2020 2020 2020 205b  ],.            [
-0001db90: 2773 6563 7265 742d 696e 666f 2d67 6574  'secret-info-get
-0001dba0: 272c 2027 2d2d 6c61 6265 6c27 2c20 2779  ', '--label', 'y
-0001dbb0: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
-0001dbc0: 6e27 5d2c 0a20 2020 2020 2020 2020 2020  n'],.           
-0001dbd0: 205b 2773 6563 7265 742d 7365 7427 2c20   ['secret-set', 
-0001dbe0: 2773 6563 7265 743a 7a27 2c20 2762 6172  'secret:z', 'bar
-0001dbf0: 3d66 6f6f 275d 2c0a 2020 2020 2020 2020  =foo'],.        
-0001dc00: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0001dc10: 5f73 6574 5f69 6e66 6f28 7365 6c66 293a  _set_info(self):
-0001dc20: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
-0001dc30: 7269 7074 2873 656c 662c 2027 7365 6372  ript(self, 'secr
-0001dc40: 6574 2d73 6574 272c 2022 2222 6578 6974  et-set', """exit
-0001dc50: 2030 2222 2229 0a20 2020 2020 2020 2066   0""").        f
-0001dc60: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-0001dc70: 2027 7365 6372 6574 2d69 6e66 6f2d 6765   'secret-info-ge
-0001dc80: 7427 2c20 2222 2265 6368 6f20 277b 227a  t', """echo '{"z
-0001dc90: 223a 207b 226c 6162 656c 223a 2022 7922  ": {"label": "y"
-0001dca0: 2c20 2272 6576 6973 696f 6e22 3a20 377d  , "revision": 7}
-0001dcb0: 7d27 2222 2229 0a0a 2020 2020 2020 2020  }'""")..        
-0001dcc0: 7365 6372 6574 203d 2073 656c 662e 6d61  secret = self.ma
-0001dcd0: 6b65 5f73 6563 7265 7428 6964 3d27 7827  ke_secret(id='x'
-0001dce0: 290a 2020 2020 2020 2020 6578 7069 7265  ).        expire
-0001dcf0: 203d 2064 6174 6574 696d 652e 6461 7465   = datetime.date
-0001dd00: 7469 6d65 2832 3032 322c 2031 322c 2039  time(2022, 12, 9
-0001dd10: 2c20 3136 2c20 3539 2c20 3029 0a20 2020  , 16, 59, 0).   
-0001dd20: 2020 2020 2073 6563 7265 742e 7365 745f       secret.set_
-0001dd30: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
-0001dd40: 2020 6c61 6265 6c3d 276c 6162 272c 0a20    label='lab',. 
-0001dd50: 2020 2020 2020 2020 2020 2064 6573 6372             descr
-0001dd60: 6970 7469 6f6e 3d27 6465 7363 272c 0a20  iption='desc',. 
-0001dd70: 2020 2020 2020 2020 2020 2065 7870 6972             expir
-0001dd80: 653d 6578 7069 7265 2c0a 2020 2020 2020  e=expire,.      
-0001dd90: 2020 2020 2020 726f 7461 7465 3d6f 7073        rotate=ops
-0001dda0: 2e53 6563 7265 7452 6f74 6174 652e 4d4f  .SecretRotate.MO
-0001ddb0: 4e54 484c 592c 0a20 2020 2020 2020 2029  NTHLY,.        )
-0001ddc0: 0a0a 2020 2020 2020 2020 2320 4966 2073  ..        # If s
-0001ddd0: 6563 7265 7420 646f 6573 6e27 7420 6861  ecret doesn't ha
-0001dde0: 7665 2061 6e20 4944 2c20 7765 276c 6c20  ve an ID, we'll 
-0001ddf0: 7275 6e20 7365 6372 6574 2d69 6e66 6f2d  run secret-info-
-0001de00: 6765 7420 746f 2066 6574 6368 2069 740a  get to fetch it.
-0001de10: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
-0001de20: 2073 656c 662e 6d61 6b65 5f73 6563 7265   self.make_secre
-0001de30: 7428 6c61 6265 6c3d 2779 2729 0a20 2020  t(label='y').   
-0001de40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001de50: 4973 4e6f 6e65 2873 6563 7265 742e 6964  IsNone(secret.id
-0001de60: 290a 2020 2020 2020 2020 7365 6372 6574  ).        secret
-0001de70: 2e73 6574 5f69 6e66 6f28 6c61 6265 6c3d  .set_info(label=
-0001de80: 276c 626c 2729 0a20 2020 2020 2020 2073  'lbl').        s
-0001de90: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001dea0: 7365 6372 6574 2e69 642c 2027 7365 6372  secret.id, 'secr
-0001deb0: 6574 3a7a 2729 0a0a 2020 2020 2020 2020  et:z')..        
-0001dec0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001ded0: 2866 616b 655f 7363 7269 7074 5f63 616c  (fake_script_cal
-0001dee0: 6c73 2873 656c 662c 2063 6c65 6172 3d54  ls(self, clear=T
-0001def0: 7275 6529 2c20 5b0a 2020 2020 2020 2020  rue), [.        
-0001df00: 2020 2020 5b27 7365 6372 6574 2d73 6574      ['secret-set
-0001df10: 272c 2027 7365 6372 6574 3a78 272c 2027  ', 'secret:x', '
-0001df20: 2d2d 6c61 6265 6c27 2c20 276c 6162 272c  --label', 'lab',
-0001df30: 2027 2d2d 6465 7363 7269 7074 696f 6e27   '--description'
-0001df40: 2c20 2764 6573 6327 2c0a 2020 2020 2020  , 'desc',.      
-0001df50: 2020 2020 2020 2027 2d2d 6578 7069 7265         '--expire
-0001df60: 272c 2027 3230 3232 2d31 322d 3039 5431  ', '2022-12-09T1
-0001df70: 363a 3539 3a30 3027 2c20 272d 2d72 6f74  6:59:00', '--rot
-0001df80: 6174 6527 2c20 276d 6f6e 7468 6c79 275d  ate', 'monthly']
-0001df90: 2c0a 2020 2020 2020 2020 2020 2020 5b27  ,.            ['
-0001dfa0: 7365 6372 6574 2d69 6e66 6f2d 6765 7427  secret-info-get'
-0001dfb0: 2c20 272d 2d6c 6162 656c 272c 2027 7927  , '--label', 'y'
-0001dfc0: 2c20 272d 2d66 6f72 6d61 743d 6a73 6f6e  , '--format=json
-0001dfd0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-0001dfe0: 5b27 7365 6372 6574 2d73 6574 272c 2027  ['secret-set', '
-0001dff0: 7365 6372 6574 3a7a 272c 2027 2d2d 6c61  secret:z', '--la
-0001e000: 6265 6c27 2c20 276c 626c 275d 2c0a 2020  bel', 'lbl'],.  
-0001e010: 2020 2020 2020 5d29 0a0a 2020 2020 2020        ])..      
-0001e020: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-0001e030: 7274 5261 6973 6573 2854 7970 6545 7272  rtRaises(TypeErr
-0001e040: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-0001e050: 2073 6563 7265 742e 7365 745f 696e 666f   secret.set_info
-0001e060: 2829 2020 2320 6e6f 2061 7267 7320 7072  ()  # no args pr
-0001e070: 6f76 6964 6564 0a0a 2020 2020 6465 6620  ovided..    def 
-0001e080: 7465 7374 5f67 7261 6e74 2873 656c 6629  test_grant(self)
-0001e090: 3a0a 2020 2020 2020 2020 6661 6b65 5f73  :.        fake_s
-0001e0a0: 6372 6970 7428 7365 6c66 2c20 2773 6563  cript(self, 'sec
-0001e0b0: 7265 742d 6772 616e 7427 2c20 2222 2265  ret-grant', """e
-0001e0c0: 7869 7420 3022 2222 290a 2020 2020 2020  xit 0""").      
-0001e0d0: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-0001e0e0: 6c66 2c20 2773 6563 7265 742d 696e 666f  lf, 'secret-info
-0001e0f0: 2d67 6574 272c 2022 2222 6563 686f 2027  -get', """echo '
-0001e100: 7b22 7a22 3a20 7b22 6c61 6265 6c22 3a20  {"z": {"label": 
-0001e110: 2279 222c 2022 7265 7669 7369 6f6e 223a  "y", "revision":
-0001e120: 2037 7d7d 2722 2222 290a 0a20 2020 2020   7}}'""")..     
-0001e130: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
-0001e140: 2e6d 616b 655f 7365 6372 6574 2869 643d  .make_secret(id=
-0001e150: 2778 2729 0a20 2020 2020 2020 2073 6563  'x').        sec
-0001e160: 7265 742e 6772 616e 7428 7479 7065 732e  ret.grant(types.
-0001e170: 5369 6d70 6c65 4e61 6d65 7370 6163 6528  SimpleNamespace(
-0001e180: 6964 3d31 3233 2929 0a20 2020 2020 2020  id=123)).       
-0001e190: 2073 6563 7265 742e 6772 616e 7428 7479   secret.grant(ty
-0001e1a0: 7065 732e 5369 6d70 6c65 4e61 6d65 7370  pes.SimpleNamesp
-0001e1b0: 6163 6528 6964 3d32 3334 292c 2075 6e69  ace(id=234), uni
-0001e1c0: 743d 7479 7065 732e 5369 6d70 6c65 4e61  t=types.SimpleNa
-0001e1d0: 6d65 7370 6163 6528 6e61 6d65 3d27 6170  mespace(name='ap
-0001e1e0: 702f 3027 2929 0a0a 2020 2020 2020 2020  p/0'))..        
-0001e1f0: 2320 4966 2073 6563 7265 7420 646f 6573  # If secret does
-0001e200: 6e27 7420 6861 7665 2061 6e20 4944 2c20  n't have an ID, 
-0001e210: 7765 276c 6c20 7275 6e20 7365 6372 6574  we'll run secret
-0001e220: 2d69 6e66 6f2d 6765 7420 746f 2066 6574  -info-get to fet
-0001e230: 6368 2069 740a 2020 2020 2020 2020 7365  ch it.        se
-0001e240: 6372 6574 203d 2073 656c 662e 6d61 6b65  cret = self.make
-0001e250: 5f73 6563 7265 7428 6c61 6265 6c3d 2779  _secret(label='y
-0001e260: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001e270: 6173 7365 7274 4973 4e6f 6e65 2873 6563  assertIsNone(sec
-0001e280: 7265 742e 6964 290a 2020 2020 2020 2020  ret.id).        
-0001e290: 7365 6372 6574 2e67 7261 6e74 2874 7970  secret.grant(typ
-0001e2a0: 6573 2e53 696d 706c 654e 616d 6573 7061  es.SimpleNamespa
-0001e2b0: 6365 2869 643d 3334 3529 290a 2020 2020  ce(id=345)).    
-0001e2c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001e2d0: 7175 616c 2873 6563 7265 742e 6964 2c20  qual(secret.id, 
-0001e2e0: 2773 6563 7265 743a 7a27 290a 0a20 2020  'secret:z')..   
-0001e2f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001e300: 4571 7561 6c28 6661 6b65 5f73 6372 6970  Equal(fake_scrip
-0001e310: 745f 6361 6c6c 7328 7365 6c66 2c20 636c  t_calls(self, cl
-0001e320: 6561 723d 5472 7565 292c 205b 0a20 2020  ear=True), [.   
-0001e330: 2020 2020 2020 2020 205b 2773 6563 7265           ['secre
-0001e340: 742d 6772 616e 7427 2c20 2773 6563 7265  t-grant', 'secre
-0001e350: 743a 7827 2c20 272d 2d72 656c 6174 696f  t:x', '--relatio
-0001e360: 6e27 2c20 2731 3233 275d 2c0a 2020 2020  n', '123'],.    
-0001e370: 2020 2020 2020 2020 5b27 7365 6372 6574          ['secret
-0001e380: 2d67 7261 6e74 272c 2027 7365 6372 6574  -grant', 'secret
-0001e390: 3a78 272c 2027 2d2d 7265 6c61 7469 6f6e  :x', '--relation
-0001e3a0: 272c 2027 3233 3427 2c20 272d 2d75 6e69  ', '234', '--uni
-0001e3b0: 7427 2c20 2761 7070 2f30 275d 2c0a 2020  t', 'app/0'],.  
-0001e3c0: 2020 2020 2020 2020 2020 5b27 7365 6372            ['secr
-0001e3d0: 6574 2d69 6e66 6f2d 6765 7427 2c20 272d  et-info-get', '-
-0001e3e0: 2d6c 6162 656c 272c 2027 7927 2c20 272d  -label', 'y', '-
-0001e3f0: 2d66 6f72 6d61 743d 6a73 6f6e 275d 2c0a  -format=json'],.
-0001e400: 2020 2020 2020 2020 2020 2020 5b27 7365              ['se
-0001e410: 6372 6574 2d67 7261 6e74 272c 2027 7365  cret-grant', 'se
-0001e420: 6372 6574 3a7a 272c 2027 2d2d 7265 6c61  cret:z', '--rela
-0001e430: 7469 6f6e 272c 2027 3334 3527 5d2c 0a20  tion', '345'],. 
-0001e440: 2020 2020 2020 205d 290a 0a20 2020 2064         ])..    d
-0001e450: 6566 2074 6573 745f 7265 766f 6b65 2873  ef test_revoke(s
-0001e460: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
-0001e470: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-0001e480: 2773 6563 7265 742d 7265 766f 6b65 272c  'secret-revoke',
-0001e490: 2022 2222 6578 6974 2030 2222 2229 0a20   """exit 0"""). 
-0001e4a0: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-0001e4b0: 7074 2873 656c 662c 2027 7365 6372 6574  pt(self, 'secret
-0001e4c0: 2d69 6e66 6f2d 6765 7427 2c20 2222 2265  -info-get', """e
-0001e4d0: 6368 6f20 277b 227a 223a 207b 226c 6162  cho '{"z": {"lab
-0001e4e0: 656c 223a 2022 7922 2c20 2272 6576 6973  el": "y", "revis
-0001e4f0: 696f 6e22 3a20 377d 7d27 2222 2229 0a0a  ion": 7}}'""")..
-0001e500: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
-0001e510: 2073 656c 662e 6d61 6b65 5f73 6563 7265   self.make_secre
-0001e520: 7428 6964 3d27 7827 290a 2020 2020 2020  t(id='x').      
-0001e530: 2020 7365 6372 6574 2e72 6576 6f6b 6528    secret.revoke(
-0001e540: 7479 7065 732e 5369 6d70 6c65 4e61 6d65  types.SimpleName
-0001e550: 7370 6163 6528 6964 3d31 3233 2929 0a20  space(id=123)). 
-0001e560: 2020 2020 2020 2073 6563 7265 742e 7265         secret.re
-0001e570: 766f 6b65 2874 7970 6573 2e53 696d 706c  voke(types.Simpl
-0001e580: 654e 616d 6573 7061 6365 2869 643d 3233  eNamespace(id=23
-0001e590: 3429 2c20 756e 6974 3d74 7970 6573 2e53  4), unit=types.S
-0001e5a0: 696d 706c 654e 616d 6573 7061 6365 286e  impleNamespace(n
-0001e5b0: 616d 653d 2761 7070 2f30 2729 290a 0a20  ame='app/0')).. 
-0001e5c0: 2020 2020 2020 2023 2049 6620 7365 6372         # If secr
-0001e5d0: 6574 2064 6f65 736e 2774 2068 6176 6520  et doesn't have 
-0001e5e0: 616e 2049 442c 2077 6527 6c6c 2072 756e  an ID, we'll run
-0001e5f0: 2073 6563 7265 742d 696e 666f 2d67 6574   secret-info-get
-0001e600: 2074 6f20 6665 7463 6820 6974 0a20 2020   to fetch it.   
-0001e610: 2020 2020 2073 6563 7265 7420 3d20 7365       secret = se
-0001e620: 6c66 2e6d 616b 655f 7365 6372 6574 286c  lf.make_secret(l
-0001e630: 6162 656c 3d27 7927 290a 2020 2020 2020  abel='y').      
-0001e640: 2020 7365 6c66 2e61 7373 6572 7449 734e    self.assertIsN
-0001e650: 6f6e 6528 7365 6372 6574 2e69 6429 0a20  one(secret.id). 
-0001e660: 2020 2020 2020 2073 6563 7265 742e 7265         secret.re
-0001e670: 766f 6b65 2874 7970 6573 2e53 696d 706c  voke(types.Simpl
-0001e680: 654e 616d 6573 7061 6365 2869 643d 3334  eNamespace(id=34
-0001e690: 3529 290a 2020 2020 2020 2020 7365 6c66  5)).        self
-0001e6a0: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
-0001e6b0: 7265 742e 6964 2c20 2773 6563 7265 743a  ret.id, 'secret:
-0001e6c0: 7a27 290a 0a20 2020 2020 2020 2073 656c  z')..        sel
-0001e6d0: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-0001e6e0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-0001e6f0: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
-0001e700: 292c 205b 0a20 2020 2020 2020 2020 2020  ), [.           
-0001e710: 205b 2773 6563 7265 742d 7265 766f 6b65   ['secret-revoke
-0001e720: 272c 2027 7365 6372 6574 3a78 272c 2027  ', 'secret:x', '
-0001e730: 2d2d 7265 6c61 7469 6f6e 272c 2027 3132  --relation', '12
-0001e740: 3327 5d2c 0a20 2020 2020 2020 2020 2020  3'],.           
-0001e750: 205b 2773 6563 7265 742d 7265 766f 6b65   ['secret-revoke
-0001e760: 272c 2027 7365 6372 6574 3a78 272c 2027  ', 'secret:x', '
-0001e770: 2d2d 7265 6c61 7469 6f6e 272c 2027 3233  --relation', '23
-0001e780: 3427 2c20 272d 2d75 6e69 7427 2c20 2761  4', '--unit', 'a
-0001e790: 7070 2f30 275d 2c0a 2020 2020 2020 2020  pp/0'],.        
-0001e7a0: 2020 2020 5b27 7365 6372 6574 2d69 6e66      ['secret-inf
-0001e7b0: 6f2d 6765 7427 2c20 272d 2d6c 6162 656c  o-get', '--label
-0001e7c0: 272c 2027 7927 2c20 272d 2d66 6f72 6d61  ', 'y', '--forma
-0001e7d0: 743d 6a73 6f6e 275d 2c0a 2020 2020 2020  t=json'],.      
-0001e7e0: 2020 2020 2020 5b27 7365 6372 6574 2d72        ['secret-r
-0001e7f0: 6576 6f6b 6527 2c20 2773 6563 7265 743a  evoke', 'secret:
-0001e800: 7a27 2c20 272d 2d72 656c 6174 696f 6e27  z', '--relation'
-0001e810: 2c20 2733 3435 275d 2c0a 2020 2020 2020  , '345'],.      
-0001e820: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
-0001e830: 7374 5f72 656d 6f76 655f 7265 7669 7369  st_remove_revisi
-0001e840: 6f6e 2873 656c 6629 3a0a 2020 2020 2020  on(self):.      
-0001e850: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-0001e860: 6c66 2c20 2773 6563 7265 742d 7265 6d6f  lf, 'secret-remo
-0001e870: 7665 272c 2022 2222 6578 6974 2030 2222  ve', """exit 0""
-0001e880: 2229 0a20 2020 2020 2020 2066 616b 655f  ").        fake_
-0001e890: 7363 7269 7074 2873 656c 662c 2027 7365  script(self, 'se
-0001e8a0: 6372 6574 2d69 6e66 6f2d 6765 7427 2c20  cret-info-get', 
-0001e8b0: 2222 2265 6368 6f20 277b 227a 223a 207b  """echo '{"z": {
-0001e8c0: 226c 6162 656c 223a 2022 7922 2c20 2272  "label": "y", "r
-0001e8d0: 6576 6973 696f 6e22 3a20 377d 7d27 2222  evision": 7}}'""
-0001e8e0: 2229 0a0a 2020 2020 2020 2020 7365 6372  ")..        secr
-0001e8f0: 6574 203d 2073 656c 662e 6d61 6b65 5f73  et = self.make_s
-0001e900: 6563 7265 7428 6964 3d27 7827 290a 2020  ecret(id='x').  
-0001e910: 2020 2020 2020 7365 6372 6574 2e72 656d        secret.rem
-0001e920: 6f76 655f 7265 7669 7369 6f6e 2831 3233  ove_revision(123
-0001e930: 290a 0a20 2020 2020 2020 2023 2049 6620  )..        # If 
-0001e940: 7365 6372 6574 2064 6f65 736e 2774 2068  secret doesn't h
-0001e950: 6176 6520 616e 2049 442c 2077 6527 6c6c  ave an ID, we'll
-0001e960: 2072 756e 2073 6563 7265 742d 696e 666f   run secret-info
-0001e970: 2d67 6574 2074 6f20 6665 7463 6820 6974  -get to fetch it
-0001e980: 0a20 2020 2020 2020 2073 6563 7265 7420  .        secret 
-0001e990: 3d20 7365 6c66 2e6d 616b 655f 7365 6372  = self.make_secr
-0001e9a0: 6574 286c 6162 656c 3d27 7927 290a 2020  et(label='y').  
-0001e9b0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001e9c0: 7449 734e 6f6e 6528 7365 6372 6574 2e69  tIsNone(secret.i
-0001e9d0: 6429 0a20 2020 2020 2020 2073 6563 7265  d).        secre
-0001e9e0: 742e 7265 6d6f 7665 5f72 6576 6973 696f  t.remove_revisio
-0001e9f0: 6e28 3233 3429 0a20 2020 2020 2020 2073  n(234).        s
-0001ea00: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001ea10: 7365 6372 6574 2e69 642c 2027 7365 6372  secret.id, 'secr
-0001ea20: 6574 3a7a 2729 0a0a 2020 2020 2020 2020  et:z')..        
-0001ea30: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001ea40: 2866 616b 655f 7363 7269 7074 5f63 616c  (fake_script_cal
-0001ea50: 6c73 2873 656c 662c 2063 6c65 6172 3d54  ls(self, clear=T
-0001ea60: 7275 6529 2c20 5b0a 2020 2020 2020 2020  rue), [.        
-0001ea70: 2020 2020 5b27 7365 6372 6574 2d72 656d      ['secret-rem
-0001ea80: 6f76 6527 2c20 2773 6563 7265 743a 7827  ove', 'secret:x'
-0001ea90: 2c20 272d 2d72 6576 6973 696f 6e27 2c20  , '--revision', 
-0001eaa0: 2731 3233 275d 2c0a 2020 2020 2020 2020  '123'],.        
-0001eab0: 2020 2020 5b27 7365 6372 6574 2d69 6e66      ['secret-inf
-0001eac0: 6f2d 6765 7427 2c20 272d 2d6c 6162 656c  o-get', '--label
-0001ead0: 272c 2027 7927 2c20 272d 2d66 6f72 6d61  ', 'y', '--forma
-0001eae0: 743d 6a73 6f6e 275d 2c0a 2020 2020 2020  t=json'],.      
-0001eaf0: 2020 2020 2020 5b27 7365 6372 6574 2d72        ['secret-r
-0001eb00: 656d 6f76 6527 2c20 2773 6563 7265 743a  emove', 'secret:
-0001eb10: 7a27 2c20 272d 2d72 6576 6973 696f 6e27  z', '--revision'
-0001eb20: 2c20 2732 3334 275d 2c0a 2020 2020 2020  , '234'],.      
-0001eb30: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
-0001eb40: 7374 5f72 656d 6f76 655f 616c 6c5f 7265  st_remove_all_re
-0001eb50: 7669 7369 6f6e 7328 7365 6c66 293a 0a20  visions(self):. 
-0001eb60: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-0001eb70: 7074 2873 656c 662c 2027 7365 6372 6574  pt(self, 'secret
-0001eb80: 2d72 656d 6f76 6527 2c20 2222 2265 7869  -remove', """exi
-0001eb90: 7420 3022 2222 290a 2020 2020 2020 2020  t 0""").        
-0001eba0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-0001ebb0: 2c20 2773 6563 7265 742d 696e 666f 2d67  , 'secret-info-g
-0001ebc0: 6574 272c 2022 2222 6563 686f 2027 7b22  et', """echo '{"
-0001ebd0: 7a22 3a20 7b22 6c61 6265 6c22 3a20 2279  z": {"label": "y
-0001ebe0: 222c 2022 7265 7669 7369 6f6e 223a 2037  ", "revision": 7
-0001ebf0: 7d7d 2722 2222 290a 0a20 2020 2020 2020  }}'""")..       
-0001ec00: 2073 6563 7265 7420 3d20 7365 6c66 2e6d   secret = self.m
-0001ec10: 616b 655f 7365 6372 6574 2869 643d 2778  ake_secret(id='x
-0001ec20: 2729 0a20 2020 2020 2020 2073 6563 7265  ').        secre
-0001ec30: 742e 7265 6d6f 7665 5f61 6c6c 5f72 6576  t.remove_all_rev
-0001ec40: 6973 696f 6e73 2829 0a0a 2020 2020 2020  isions()..      
-0001ec50: 2020 2320 4966 2073 6563 7265 7420 646f    # If secret do
-0001ec60: 6573 6e27 7420 6861 7665 2061 6e20 4944  esn't have an ID
-0001ec70: 2c20 7765 276c 6c20 7275 6e20 7365 6372  , we'll run secr
-0001ec80: 6574 2d69 6e66 6f2d 6765 7420 746f 2066  et-info-get to f
-0001ec90: 6574 6368 2069 740a 2020 2020 2020 2020  etch it.        
-0001eca0: 7365 6372 6574 203d 2073 656c 662e 6d61  secret = self.ma
-0001ecb0: 6b65 5f73 6563 7265 7428 6c61 6265 6c3d  ke_secret(label=
-0001ecc0: 2779 2729 0a20 2020 2020 2020 2073 656c  'y').        sel
-0001ecd0: 662e 6173 7365 7274 4973 4e6f 6e65 2873  f.assertIsNone(s
-0001ece0: 6563 7265 742e 6964 290a 2020 2020 2020  ecret.id).      
-0001ecf0: 2020 7365 6372 6574 2e72 656d 6f76 655f    secret.remove_
-0001ed00: 616c 6c5f 7265 7669 7369 6f6e 7328 290a  all_revisions().
-0001ed10: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001ed20: 6572 7445 7175 616c 2873 6563 7265 742e  ertEqual(secret.
-0001ed30: 6964 2c20 2773 6563 7265 743a 7a27 290a  id, 'secret:z').
-0001ed40: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001ed50: 7365 7274 4571 7561 6c28 6661 6b65 5f73  sertEqual(fake_s
-0001ed60: 6372 6970 745f 6361 6c6c 7328 7365 6c66  cript_calls(self
-0001ed70: 2c20 636c 6561 723d 5472 7565 292c 205b  , clear=True), [
-0001ed80: 0a20 2020 2020 2020 2020 2020 205b 2773  .            ['s
-0001ed90: 6563 7265 742d 7265 6d6f 7665 272c 2027  ecret-remove', '
-0001eda0: 7365 6372 6574 3a78 275d 2c0a 2020 2020  secret:x'],.    
-0001edb0: 2020 2020 2020 2020 5b27 7365 6372 6574          ['secret
-0001edc0: 2d69 6e66 6f2d 6765 7427 2c20 272d 2d6c  -info-get', '--l
-0001edd0: 6162 656c 272c 2027 7927 2c20 272d 2d66  abel', 'y', '--f
-0001ede0: 6f72 6d61 743d 6a73 6f6e 275d 2c0a 2020  ormat=json'],.  
-0001edf0: 2020 2020 2020 2020 2020 5b27 7365 6372            ['secr
-0001ee00: 6574 2d72 656d 6f76 6527 2c20 2773 6563  et-remove', 'sec
-0001ee10: 7265 743a 7a27 5d2c 0a20 2020 2020 2020  ret:z'],.       
-0001ee20: 205d 290a 0a0a 636c 6173 7320 5465 7374   ])...class Test
-0001ee30: 506f 7274 7328 756e 6974 7465 7374 2e54  Ports(unittest.T
-0001ee40: 6573 7443 6173 6529 3a0a 2020 2020 6465  estCase):.    de
-0001ee50: 6620 7365 7455 7028 7365 6c66 293a 0a20  f setUp(self):. 
-0001ee60: 2020 2020 2020 2073 656c 662e 6d6f 6465         self.mode
-0001ee70: 6c20 3d20 6f70 732e 6d6f 6465 6c2e 4d6f  l = ops.model.Mo
-0001ee80: 6465 6c28 6f70 732e 6368 6172 6d2e 4368  del(ops.charm.Ch
-0001ee90: 6172 6d4d 6574 6128 292c 206f 7073 2e6d  armMeta(), ops.m
-0001eea0: 6f64 656c 2e5f 4d6f 6465 6c42 6163 6b65  odel._ModelBacke
-0001eeb0: 6e64 2827 6d79 6170 702f 3027 2929 0a20  nd('myapp/0')). 
-0001eec0: 2020 2020 2020 2073 656c 662e 756e 6974         self.unit
-0001eed0: 203d 2073 656c 662e 6d6f 6465 6c2e 756e   = self.model.un
-0001eee0: 6974 0a0a 2020 2020 6465 6620 7465 7374  it..    def test
-0001eef0: 5f6f 7065 6e5f 706f 7274 2873 656c 6629  _open_port(self)
-0001ef00: 3a0a 2020 2020 2020 2020 6661 6b65 5f73  :.        fake_s
-0001ef10: 6372 6970 7428 7365 6c66 2c20 276f 7065  cript(self, 'ope
-0001ef20: 6e2d 706f 7274 272c 2027 6578 6974 2030  n-port', 'exit 0
-0001ef30: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
-0001ef40: 2e75 6e69 742e 6f70 656e 5f70 6f72 7428  .unit.open_port(
-0001ef50: 2774 6370 272c 2038 3038 3029 0a20 2020  'tcp', 8080).   
-0001ef60: 2020 2020 2073 656c 662e 756e 6974 2e6f       self.unit.o
-0001ef70: 7065 6e5f 706f 7274 2827 5544 5027 2c20  pen_port('UDP', 
-0001ef80: 3430 3030 290a 2020 2020 2020 2020 7365  4000).        se
-0001ef90: 6c66 2e75 6e69 742e 6f70 656e 5f70 6f72  lf.unit.open_por
-0001efa0: 7428 2769 636d 7027 290a 0a20 2020 2020  t('icmp')..     
-0001efb0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001efc0: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
-0001efd0: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
-0001efe0: 723d 5472 7565 292c 205b 0a20 2020 2020  r=True), [.     
-0001eff0: 2020 2020 2020 205b 276f 7065 6e2d 706f         ['open-po
-0001f000: 7274 272c 2027 3830 3830 2f74 6370 275d  rt', '8080/tcp']
-0001f010: 2c0a 2020 2020 2020 2020 2020 2020 5b27  ,.            ['
-0001f020: 6f70 656e 2d70 6f72 7427 2c20 2734 3030  open-port', '400
-0001f030: 302f 7564 7027 5d2c 0a20 2020 2020 2020  0/udp'],.       
-0001f040: 2020 2020 205b 276f 7065 6e2d 706f 7274       ['open-port
-0001f050: 272c 2027 6963 6d70 275d 2c0a 2020 2020  ', 'icmp'],.    
-0001f060: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
-0001f070: 7465 7374 5f6f 7065 6e5f 706f 7274 5f65  test_open_port_e
-0001f080: 7272 6f72 2873 656c 6629 3a0a 2020 2020  rror(self):.    
-0001f090: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-0001f0a0: 7365 6c66 2c20 276f 7065 6e2d 706f 7274  self, 'open-port
-0001f0b0: 272c 2022 6563 686f 2027 4552 524f 5220  ', "echo 'ERROR 
-0001f0c0: 6261 6420 7072 6f74 6f63 6f6c 2720 3e26  bad protocol' >&
-0001f0d0: 323b 2065 7869 7420 3122 290a 0a20 2020  2; exit 1")..   
-0001f0e0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0001f0f0: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
-0001f100: 4d6f 6465 6c45 7272 6f72 2920 6173 2063  ModelError) as c
-0001f110: 6d3a 0a20 2020 2020 2020 2020 2020 2073  m:.            s
-0001f120: 656c 662e 756e 6974 2e6f 7065 6e5f 706f  elf.unit.open_po
-0001f130: 7274 2827 6674 7027 2c20 3830 3830 290a  rt('ftp', 8080).
-0001f140: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001f150: 6572 7445 7175 616c 2873 7472 2863 6d2e  ertEqual(str(cm.
-0001f160: 6578 6365 7074 696f 6e29 2c20 2745 5252  exception), 'ERR
-0001f170: 4f52 2062 6164 2070 726f 746f 636f 6c5c  OR bad protocol\
-0001f180: 6e27 290a 0a20 2020 2020 2020 2073 656c  n')..        sel
-0001f190: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-0001f1a0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-0001f1b0: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
-0001f1c0: 292c 205b 0a20 2020 2020 2020 2020 2020  ), [.           
-0001f1d0: 205b 276f 7065 6e2d 706f 7274 272c 2027   ['open-port', '
-0001f1e0: 3830 3830 2f66 7470 275d 2c0a 2020 2020  8080/ftp'],.    
-0001f1f0: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
-0001f200: 7465 7374 5f63 6c6f 7365 5f70 6f72 7428  test_close_port(
-0001f210: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
-0001f220: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-0001f230: 2027 636c 6f73 652d 706f 7274 272c 2027   'close-port', '
-0001f240: 6578 6974 2030 2729 0a0a 2020 2020 2020  exit 0')..      
-0001f250: 2020 7365 6c66 2e75 6e69 742e 636c 6f73    self.unit.clos
-0001f260: 655f 706f 7274 2827 7463 7027 2c20 3830  e_port('tcp', 80
-0001f270: 3830 290a 2020 2020 2020 2020 7365 6c66  80).        self
-0001f280: 2e75 6e69 742e 636c 6f73 655f 706f 7274  .unit.close_port
-0001f290: 2827 5544 5027 2c20 3430 3030 290a 2020  ('UDP', 4000).  
-0001f2a0: 2020 2020 2020 7365 6c66 2e75 6e69 742e        self.unit.
-0001f2b0: 636c 6f73 655f 706f 7274 2827 6963 6d70  close_port('icmp
-0001f2c0: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
-0001f2d0: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
-0001f2e0: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
-0001f2f0: 656c 662c 2063 6c65 6172 3d54 7275 6529  elf, clear=True)
-0001f300: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-0001f310: 5b27 636c 6f73 652d 706f 7274 272c 2027  ['close-port', '
-0001f320: 3830 3830 2f74 6370 275d 2c0a 2020 2020  8080/tcp'],.    
-0001f330: 2020 2020 2020 2020 5b27 636c 6f73 652d          ['close-
-0001f340: 706f 7274 272c 2027 3430 3030 2f75 6470  port', '4000/udp
-0001f350: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-0001f360: 5b27 636c 6f73 652d 706f 7274 272c 2027  ['close-port', '
-0001f370: 6963 6d70 275d 2c0a 2020 2020 2020 2020  icmp'],.        
-0001f380: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0001f390: 5f63 6c6f 7365 5f70 6f72 745f 6572 726f  _close_port_erro
-0001f3a0: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
-0001f3b0: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-0001f3c0: 662c 2027 636c 6f73 652d 706f 7274 272c  f, 'close-port',
-0001f3d0: 2022 6563 686f 2027 4552 524f 5220 6261   "echo 'ERROR ba
-0001f3e0: 6420 7072 6f74 6f63 6f6c 2720 3e26 323b  d protocol' >&2;
-0001f3f0: 2065 7869 7420 3122 290a 0a20 2020 2020   exit 1")..     
-0001f400: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0001f410: 6572 7452 6169 7365 7328 6f70 732e 4d6f  ertRaises(ops.Mo
-0001f420: 6465 6c45 7272 6f72 2920 6173 2063 6d3a  delError) as cm:
-0001f430: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001f440: 662e 756e 6974 2e63 6c6f 7365 5f70 6f72  f.unit.close_por
-0001f450: 7428 2766 7470 272c 2038 3038 3029 0a20  t('ftp', 8080). 
-0001f460: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001f470: 7274 4571 7561 6c28 7374 7228 636d 2e65  rtEqual(str(cm.e
-0001f480: 7863 6570 7469 6f6e 292c 2027 4552 524f  xception), 'ERRO
-0001f490: 5220 6261 6420 7072 6f74 6f63 6f6c 5c6e  R bad protocol\n
-0001f4a0: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
-0001f4b0: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
-0001f4c0: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
-0001f4d0: 656c 662c 2063 6c65 6172 3d54 7275 6529  elf, clear=True)
-0001f4e0: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-0001f4f0: 5b27 636c 6f73 652d 706f 7274 272c 2027  ['close-port', '
-0001f500: 3830 3830 2f66 7470 275d 2c0a 2020 2020  8080/ftp'],.    
-0001f510: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
-0001f520: 7465 7374 5f6f 7065 6e65 645f 706f 7274  test_opened_port
-0001f530: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-0001f540: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-0001f550: 662c 2027 6f70 656e 6564 2d70 6f72 7473  f, 'opened-ports
-0001f560: 272c 2022 2222 6563 686f 2038 3038 302f  ', """echo 8080/
-0001f570: 7463 703b 2065 6368 6f20 6963 6d70 2222  tcp; echo icmp""
-0001f580: 2229 0a0a 2020 2020 2020 2020 706f 7274  ")..        port
-0001f590: 735f 7365 7420 3d20 7365 6c66 2e75 6e69  s_set = self.uni
-0001f5a0: 742e 6f70 656e 6564 5f70 6f72 7473 2829  t.opened_ports()
-0001f5b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001f5c0: 7365 7274 4973 496e 7374 616e 6365 2870  sertIsInstance(p
-0001f5d0: 6f72 7473 5f73 6574 2c20 7365 7429 0a20  orts_set, set). 
-0001f5e0: 2020 2020 2020 2070 6f72 7473 203d 2073         ports = s
-0001f5f0: 6f72 7465 6428 706f 7274 735f 7365 742c  orted(ports_set,
-0001f600: 206b 6579 3d6c 616d 6264 6120 703a 2028   key=lambda p: (
-0001f610: 702e 7072 6f74 6f63 6f6c 2c20 702e 706f  p.protocol, p.po
-0001f620: 7274 2929 0a20 2020 2020 2020 2073 656c  rt)).        sel
-0001f630: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
-0001f640: 6e28 706f 7274 7329 2c20 3229 0a20 2020  n(ports), 2).   
-0001f650: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001f660: 4973 496e 7374 616e 6365 2870 6f72 7473  IsInstance(ports
-0001f670: 5b30 5d2c 206f 7073 2e4f 7065 6e65 6450  [0], ops.OpenedP
-0001f680: 6f72 7429 0a20 2020 2020 2020 2073 656c  ort).        sel
-0001f690: 662e 6173 7365 7274 4571 7561 6c28 706f  f.assertEqual(po
-0001f6a0: 7274 735b 305d 2e70 726f 746f 636f 6c2c  rts[0].protocol,
-0001f6b0: 2027 6963 6d70 2729 0a20 2020 2020 2020   'icmp').       
-0001f6c0: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
-0001f6d0: 6e65 2870 6f72 7473 5b30 5d2e 706f 7274  ne(ports[0].port
-0001f6e0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001f6f0: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
-0001f700: 706f 7274 735b 315d 2c20 6f70 732e 4f70  ports[1], ops.Op
-0001f710: 656e 6564 506f 7274 290a 2020 2020 2020  enedPort).      
-0001f720: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001f730: 616c 2870 6f72 7473 5b31 5d2e 7072 6f74  al(ports[1].prot
-0001f740: 6f63 6f6c 2c20 2774 6370 2729 0a20 2020  ocol, 'tcp').   
-0001f750: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001f760: 4571 7561 6c28 706f 7274 735b 315d 2e70  Equal(ports[1].p
-0001f770: 6f72 742c 2038 3038 3029 0a0a 2020 2020  ort, 8080)..    
-0001f780: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001f790: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
-0001f7a0: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
-0001f7b0: 6172 3d54 7275 6529 2c20 5b0a 2020 2020  ar=True), [.    
-0001f7c0: 2020 2020 2020 2020 5b27 6f70 656e 6564          ['opened
-0001f7d0: 2d70 6f72 7473 272c 2027 275d 2c0a 2020  -ports', ''],.  
-0001f7e0: 2020 2020 2020 5d29 0a0a 2020 2020 6465        ])..    de
-0001f7f0: 6620 7465 7374 5f6f 7065 6e65 645f 706f  f test_opened_po
-0001f800: 7274 735f 7761 726e 696e 6773 2873 656c  rts_warnings(sel
-0001f810: 6629 3a0a 2020 2020 2020 2020 6661 6b65  f):.        fake
-0001f820: 5f73 6372 6970 7428 7365 6c66 2c20 276f  _script(self, 'o
-0001f830: 7065 6e65 642d 706f 7274 7327 2c20 2222  pened-ports', ""
-0001f840: 2265 6368 6f20 3830 3830 2f74 6370 3b20  "echo 8080/tcp; 
-0001f850: 6563 686f 2031 3233 342f 6674 703b 2065  echo 1234/ftp; e
-0001f860: 6368 6f20 3130 3030 2d32 3030 302f 7564  cho 1000-2000/ud
-0001f870: 7022 2222 290a 0a20 2020 2020 2020 2077  p""")..        w
-0001f880: 6974 6820 7365 6c66 2e61 7373 6572 744c  ith self.assertL
-0001f890: 6f67 7328 276f 7073 2e6d 6f64 656c 272c  ogs('ops.model',
-0001f8a0: 206c 6576 656c 3d27 5741 524e 494e 4727   level='WARNING'
-0001f8b0: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
-0001f8c0: 2020 2020 2070 6f72 7473 5f73 6574 203d       ports_set =
-0001f8d0: 2073 656c 662e 756e 6974 2e6f 7065 6e65   self.unit.opene
-0001f8e0: 645f 706f 7274 7328 290a 2020 2020 2020  d_ports().      
-0001f8f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001f900: 616c 286c 656e 2863 6d2e 6f75 7470 7574  al(len(cm.output
-0001f910: 292c 2032 290a 2020 2020 2020 2020 7365  ), 2).        se
-0001f920: 6c66 2e61 7373 6572 7452 6567 6578 2863  lf.assertRegex(c
-0001f930: 6d2e 6f75 7470 7574 5b30 5d2c 2072 2757  m.output[0], r'W
-0001f940: 4152 4e49 4e47 3a6f 7073 2e6d 6f64 656c  ARNING:ops.model
-0001f950: 3a2e 2a70 726f 746f 636f 6c2e 2a27 290a  :.*protocol.*').
-0001f960: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001f970: 6572 7452 6567 6578 2863 6d2e 6f75 7470  ertRegex(cm.outp
-0001f980: 7574 5b31 5d2c 2072 2757 4152 4e49 4e47  ut[1], r'WARNING
-0001f990: 3a6f 7073 2e6d 6f64 656c 3a2e 2a72 616e  :ops.model:.*ran
-0001f9a0: 6765 2e2a 2729 0a0a 2020 2020 2020 2020  ge.*')..        
-0001f9b0: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
-0001f9c0: 7461 6e63 6528 706f 7274 735f 7365 742c  tance(ports_set,
-0001f9d0: 2073 6574 290a 2020 2020 2020 2020 706f   set).        po
-0001f9e0: 7274 7320 3d20 736f 7274 6564 2870 6f72  rts = sorted(por
-0001f9f0: 7473 5f73 6574 2c20 6b65 793d 6c61 6d62  ts_set, key=lamb
-0001fa00: 6461 2070 3a20 2870 2e70 726f 746f 636f  da p: (p.protoco
-0001fa10: 6c2c 2070 2e70 6f72 7429 290a 2020 2020  l, p.port)).    
-0001fa20: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001fa30: 7175 616c 286c 656e 2870 6f72 7473 292c  qual(len(ports),
-0001fa40: 2032 290a 2020 2020 2020 2020 7365 6c66   2).        self
-0001fa50: 2e61 7373 6572 7449 7349 6e73 7461 6e63  .assertIsInstanc
-0001fa60: 6528 706f 7274 735b 305d 2c20 6f70 732e  e(ports[0], ops.
-0001fa70: 4f70 656e 6564 506f 7274 290a 2020 2020  OpenedPort).    
-0001fa80: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001fa90: 7175 616c 2870 6f72 7473 5b30 5d2e 7072  qual(ports[0].pr
-0001faa0: 6f74 6f63 6f6c 2c20 2774 6370 2729 0a20  otocol, 'tcp'). 
-0001fab0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001fac0: 7274 4571 7561 6c28 706f 7274 735b 305d  rtEqual(ports[0]
-0001fad0: 2e70 6f72 742c 2038 3038 3029 0a20 2020  .port, 8080).   
-0001fae0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001faf0: 4973 496e 7374 616e 6365 2870 6f72 7473  IsInstance(ports
-0001fb00: 5b31 5d2c 206f 7073 2e4f 7065 6e65 6450  [1], ops.OpenedP
-0001fb10: 6f72 7429 0a20 2020 2020 2020 2073 656c  ort).        sel
-0001fb20: 662e 6173 7365 7274 4571 7561 6c28 706f  f.assertEqual(po
-0001fb30: 7274 735b 315d 2e70 726f 746f 636f 6c2c  rts[1].protocol,
-0001fb40: 2027 7564 7027 290a 2020 2020 2020 2020   'udp').        
-0001fb50: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001fb60: 2870 6f72 7473 5b31 5d2e 706f 7274 2c20  (ports[1].port, 
-0001fb70: 3130 3030 290a 0a20 2020 2020 2020 2073  1000)..        s
-0001fb80: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001fb90: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
-0001fba0: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
-0001fbb0: 7565 292c 205b 0a20 2020 2020 2020 2020  ue), [.         
-0001fbc0: 2020 205b 276f 7065 6e65 642d 706f 7274     ['opened-port
-0001fbd0: 7327 2c20 2727 5d2c 0a20 2020 2020 2020  s', ''],.       
-0001fbe0: 205d 290a 0a0a 6966 205f 5f6e 616d 655f   ])...if __name_
-0001fbf0: 5f20 3d3d 2022 5f5f 6d61 696e 5f5f 223a  _ == "__main__":
-0001fc00: 0a20 2020 2075 6e69 7474 6573 742e 6d61  .    unittest.ma
-0001fc10: 696e 2829 0a                             in().
+000184b0: 6563 686f 2066 6f6f 6572 726f 7220 3e26  echo fooerror >&
+000184c0: 3220 3b20 6578 6974 2031 2729 0a20 2020  2 ; exit 1').   
+000184d0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+000184e0: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
+000184f0: 4d6f 6465 6c45 7272 6f72 293a 0a20 2020  ModelError):.   
+00018500: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
+00018510: 636b 656e 642e 6163 7469 6f6e 5f73 6574  ckend.action_set
+00018520: 284f 7264 6572 6564 4469 6374 285b 2827  (OrderedDict([('
+00018530: 666f 6f27 2c20 2762 6172 2729 2c20 2827  foo', 'bar'), ('
+00018540: 6465 6164 272c 2027 6265 6566 2063 6166  dead', 'beef caf
+00018550: 6527 295d 2929 0a20 2020 2020 2020 2073  e')])).        s
+00018560: 656c 662e 6173 7365 7274 436f 756e 7445  elf.assertCountE
+00018570: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
+00018580: 2020 5b22 6163 7469 6f6e 2d73 6574 222c    ["action-set",
+00018590: 2022 6465 6164 3d62 6565 6620 6361 6665   "dead=beef cafe
+000185a0: 222c 2022 666f 6f3d 6261 7222 5d2c 2066  ", "foo=bar"], f
+000185b0: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
+000185c0: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
+000185d0: 6529 5b30 5d29 0a0a 2020 2020 6465 6620  e)[0])..    def 
+000185e0: 7465 7374 5f61 6374 696f 6e5f 6c6f 675f  test_action_log_
+000185f0: 6572 726f 7228 7365 6c66 293a 0a20 2020  error(self):.   
+00018600: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+00018610: 2873 656c 662c 2027 6163 7469 6f6e 2d67  (self, 'action-g
+00018620: 6574 272c 2027 2729 0a20 2020 2020 2020  et', '').       
+00018630: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+00018640: 662c 2027 6163 7469 6f6e 2d6c 6f67 272c  f, 'action-log',
+00018650: 2027 6563 686f 2066 6f6f 6572 726f 7220   'echo fooerror 
+00018660: 3e26 3220 3b20 6578 6974 2031 2729 0a20  >&2 ; exit 1'). 
+00018670: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00018680: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
+00018690: 732e 4d6f 6465 6c45 7272 6f72 293a 0a20  s.ModelError):. 
+000186a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000186b0: 6261 636b 656e 642e 6163 7469 6f6e 5f6c  backend.action_l
+000186c0: 6f67 2827 6c6f 672d 6d65 7373 6167 6527  og('log-message'
+000186d0: 290a 2020 2020 2020 2020 6361 6c6c 7320  ).        calls 
+000186e0: 3d20 5b5b 2261 6374 696f 6e2d 6c6f 6722  = [["action-log"
+000186f0: 2c20 226c 6f67 2d6d 6573 7361 6765 225d  , "log-message"]
+00018700: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
+00018710: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
+00018720: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
+00018730: 662c 2063 6c65 6172 3d54 7275 6529 2c20  f, clear=True), 
+00018740: 6361 6c6c 7329 0a0a 2020 2020 6465 6620  calls)..    def 
+00018750: 7465 7374 5f61 6374 696f 6e5f 6765 7428  test_action_get(
+00018760: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
+00018770: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+00018780: 2027 6163 7469 6f6e 2d67 6574 272c 2022   'action-get', "
+00018790: 2222 6563 686f 2027 7b22 666f 6f2d 6e61  ""echo '{"foo-na
+000187a0: 6d65 223a 2022 6261 7222 2c20 2273 696c  me": "bar", "sil
+000187b0: 656e 7422 3a20 6661 6c73 657d 2722 2222  ent": false}'"""
+000187c0: 290a 2020 2020 2020 2020 7061 7261 6d73  ).        params
+000187d0: 203d 2073 656c 662e 6261 636b 656e 642e   = self.backend.
+000187e0: 6163 7469 6f6e 5f67 6574 2829 0a20 2020  action_get().   
+000187f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00018800: 4571 7561 6c28 7061 7261 6d73 5b27 666f  Equal(params['fo
+00018810: 6f2d 6e61 6d65 275d 2c20 2762 6172 2729  o-name'], 'bar')
+00018820: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00018830: 7365 7274 4571 7561 6c28 7061 7261 6d73  sertEqual(params
+00018840: 5b27 7369 6c65 6e74 275d 2c20 4661 6c73  ['silent'], Fals
+00018850: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
+00018860: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
+00018870: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
+00018880: 6c66 292c 205b 5b27 6163 7469 6f6e 2d67  lf), [['action-g
+00018890: 6574 272c 2027 2d2d 666f 726d 6174 3d6a  et', '--format=j
+000188a0: 736f 6e27 5d5d 290a 0a20 2020 2064 6566  son']])..    def
+000188b0: 2074 6573 745f 6163 7469 6f6e 5f73 6574   test_action_set
+000188c0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000188d0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+000188e0: 2c20 2761 6374 696f 6e2d 6765 7427 2c20  , 'action-get', 
+000188f0: 2765 7869 7420 3127 290a 2020 2020 2020  'exit 1').      
+00018900: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+00018910: 6c66 2c20 2761 6374 696f 6e2d 7365 7427  lf, 'action-set'
+00018920: 2c20 2765 7869 7420 3027 290a 2020 2020  , 'exit 0').    
+00018930: 2020 2020 7365 6c66 2e62 6163 6b65 6e64      self.backend
+00018940: 2e61 6374 696f 6e5f 7365 7428 7b27 7827  .action_set({'x'
+00018950: 3a20 2764 6561 6420 6265 6566 272c 2027  : 'dead beef', '
+00018960: 7927 3a20 317d 290a 2020 2020 2020 2020  y': 1}).        
+00018970: 7365 6c66 2e61 7373 6572 7443 6f75 6e74  self.assertCount
+00018980: 4571 7561 6c28 5b27 6163 7469 6f6e 2d73  Equal(['action-s
+00018990: 6574 272c 2027 783d 6465 6164 2062 6565  et', 'x=dead bee
+000189a0: 6627 2c20 2779 3d31 275d 2c20 6661 6b65  f', 'y=1'], fake
+000189b0: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
+000189c0: 6c66 295b 305d 290a 0a20 2020 2064 6566  lf)[0])..    def
+000189d0: 2074 6573 745f 6163 7469 6f6e 5f73 6574   test_action_set
+000189e0: 5f6b 6579 5f76 616c 6964 6174 696f 6e28  _key_validation(
+000189f0: 7365 6c66 293a 0a20 2020 2020 2020 2077  self):.        w
+00018a00: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+00018a10: 6169 7365 7328 5661 6c75 6545 7272 6f72  aises(ValueError
+00018a20: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00018a30: 656c 662e 6261 636b 656e 642e 6163 7469  elf.backend.acti
+00018a40: 6f6e 5f73 6574 287b 2758 273a 2027 6465  on_set({'X': 'de
+00018a50: 6164 2062 6565 6627 2c20 2779 273a 2031  ad beef', 'y': 1
+00018a60: 7d29 0a20 2020 2020 2020 2077 6974 6820  }).        with 
+00018a70: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+00018a80: 7328 5661 6c75 6545 7272 6f72 293a 0a20  s(ValueError):. 
+00018a90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00018aa0: 6261 636b 656e 642e 6163 7469 6f6e 5f73  backend.action_s
+00018ab0: 6574 287b 2773 6f6d 6526 6b65 7927 3a20  et({'some&key': 
+00018ac0: 2764 6561 6420 6265 6566 272c 2027 7927  'dead beef', 'y'
+00018ad0: 3a20 317d 290a 2020 2020 2020 2020 7769  : 1}).        wi
+00018ae0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+00018af0: 6973 6573 2856 616c 7565 4572 726f 7229  ises(ValueError)
+00018b00: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00018b10: 6c66 2e62 6163 6b65 6e64 2e61 6374 696f  lf.backend.actio
+00018b20: 6e5f 7365 7428 7b27 736f 6d65 4b65 7927  n_set({'someKey'
+00018b30: 3a20 2764 6561 6420 6265 6566 272c 2027  : 'dead beef', '
+00018b40: 7927 3a20 317d 290a 2020 2020 2020 2020  y': 1}).        
+00018b50: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00018b60: 5261 6973 6573 2856 616c 7565 4572 726f  Raises(ValueErro
+00018b70: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00018b80: 7365 6c66 2e62 6163 6b65 6e64 2e61 6374  self.backend.act
+00018b90: 696f 6e5f 7365 7428 7b27 736f 6d65 5f6b  ion_set({'some_k
+00018ba0: 6579 273a 2027 6465 6164 2062 6565 6627  ey': 'dead beef'
+00018bb0: 2c20 2779 273a 2031 7d29 0a0a 2020 2020  , 'y': 1})..    
+00018bc0: 6465 6620 7465 7374 5f61 6374 696f 6e5f  def test_action_
+00018bd0: 7365 745f 6e65 7374 6564 2873 656c 6629  set_nested(self)
+00018be0: 3a0a 2020 2020 2020 2020 6661 6b65 5f73  :.        fake_s
+00018bf0: 6372 6970 7428 7365 6c66 2c20 2761 6374  cript(self, 'act
+00018c00: 696f 6e2d 6765 7427 2c20 2765 7869 7420  ion-get', 'exit 
+00018c10: 3127 290a 2020 2020 2020 2020 6661 6b65  1').        fake
+00018c20: 5f73 6372 6970 7428 7365 6c66 2c20 2761  _script(self, 'a
+00018c30: 6374 696f 6e2d 7365 7427 2c20 2765 7869  ction-set', 'exi
+00018c40: 7420 3027 290a 2020 2020 2020 2020 7365  t 0').        se
+00018c50: 6c66 2e62 6163 6b65 6e64 2e61 6374 696f  lf.backend.actio
+00018c60: 6e5f 7365 7428 7b27 6127 3a20 7b27 6227  n_set({'a': {'b'
+00018c70: 3a20 312c 2027 6327 3a20 327d 2c20 2764  : 1, 'c': 2}, 'd
+00018c80: 273a 2033 7d29 0a20 2020 2020 2020 2073  ': 3}).        s
+00018c90: 656c 662e 6173 7365 7274 436f 756e 7445  elf.assertCountE
+00018ca0: 7175 616c 285b 2761 6374 696f 6e2d 7365  qual(['action-se
+00018cb0: 7427 2c20 2761 2e62 3d31 272c 2027 612e  t', 'a.b=1', 'a.
+00018cc0: 633d 3227 2c20 2764 3d33 275d 2c20 6661  c=2', 'd=3'], fa
+00018cd0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
+00018ce0: 7365 6c66 295b 305d 290a 0a20 2020 2064  self)[0])..    d
+00018cf0: 6566 2074 6573 745f 6163 7469 6f6e 5f73  ef test_action_s
+00018d00: 6574 5f6d 6f72 655f 6e65 7374 6564 2873  et_more_nested(s
+00018d10: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
+00018d20: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+00018d30: 2761 6374 696f 6e2d 6765 7427 2c20 2765  'action-get', 'e
+00018d40: 7869 7420 3127 290a 2020 2020 2020 2020  xit 1').        
+00018d50: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+00018d60: 2c20 2761 6374 696f 6e2d 7365 7427 2c20  , 'action-set', 
+00018d70: 2765 7869 7420 3027 290a 2020 2020 2020  'exit 0').      
+00018d80: 2020 7365 6c66 2e62 6163 6b65 6e64 2e61    self.backend.a
+00018d90: 6374 696f 6e5f 7365 7428 7b27 6127 3a20  ction_set({'a': 
+00018da0: 7b27 6227 3a20 312c 2027 6327 3a20 322c  {'b': 1, 'c': 2,
+00018db0: 2027 6427 3a20 7b27 6527 3a20 337d 7d2c   'd': {'e': 3}},
+00018dc0: 2027 6627 3a20 347d 290a 2020 2020 2020   'f': 4}).      
+00018dd0: 2020 7365 6c66 2e61 7373 6572 7443 6f75    self.assertCou
+00018de0: 6e74 4571 7561 6c28 0a20 2020 2020 2020  ntEqual(.       
+00018df0: 2020 2020 205b 2761 6374 696f 6e2d 7365       ['action-se
+00018e00: 7427 2c20 2761 2e62 3d31 272c 2027 612e  t', 'a.b=1', 'a.
+00018e10: 633d 3227 2c20 2761 2e64 2e65 3d33 272c  c=2', 'a.d.e=3',
+00018e20: 2027 663d 3427 5d2c 2066 616b 655f 7363   'f=4'], fake_sc
+00018e30: 7269 7074 5f63 616c 6c73 2873 656c 6629  ript_calls(self)
+00018e40: 5b30 5d29 0a0a 2020 2020 6465 6620 7465  [0])..    def te
+00018e50: 7374 5f61 6374 696f 6e5f 7365 745f 646f  st_action_set_do
+00018e60: 7474 6564 5f64 6963 7428 7365 6c66 293a  tted_dict(self):
+00018e70: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+00018e80: 7269 7074 2873 656c 662c 2027 6163 7469  ript(self, 'acti
+00018e90: 6f6e 2d67 6574 272c 2027 6578 6974 2031  on-get', 'exit 1
+00018ea0: 2729 0a20 2020 2020 2020 2066 616b 655f  ').        fake_
+00018eb0: 7363 7269 7074 2873 656c 662c 2027 6163  script(self, 'ac
+00018ec0: 7469 6f6e 2d73 6574 272c 2027 6578 6974  tion-set', 'exit
+00018ed0: 2030 2729 0a20 2020 2020 2020 2073 656c   0').        sel
+00018ee0: 662e 6261 636b 656e 642e 6163 7469 6f6e  f.backend.action
+00018ef0: 5f73 6574 287b 2761 2e62 273a 2031 2c20  _set({'a.b': 1, 
+00018f00: 2761 273a 207b 2763 273a 2032 7d2c 2027  'a': {'c': 2}, '
+00018f10: 6427 3a20 337d 290a 2020 2020 2020 2020  d': 3}).        
+00018f20: 7365 6c66 2e61 7373 6572 7443 6f75 6e74  self.assertCount
+00018f30: 4571 7561 6c28 5b27 6163 7469 6f6e 2d73  Equal(['action-s
+00018f40: 6574 272c 2027 612e 623d 3127 2c20 2761  et', 'a.b=1', 'a
+00018f50: 2e63 3d32 272c 2027 643d 3327 5d2c 2066  .c=2', 'd=3'], f
+00018f60: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
+00018f70: 2873 656c 6629 5b30 5d29 0a0a 2020 2020  (self)[0])..    
+00018f80: 6465 6620 7465 7374 5f61 6374 696f 6e5f  def test_action_
+00018f90: 7365 745f 6475 706c 6963 6174 6564 5f6b  set_duplicated_k
+00018fa0: 6579 7328 7365 6c66 293a 0a20 2020 2020  eys(self):.     
+00018fb0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+00018fc0: 656c 662c 2027 6163 7469 6f6e 2d67 6574  elf, 'action-get
+00018fd0: 272c 2027 6578 6974 2031 2729 0a20 2020  ', 'exit 1').   
+00018fe0: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+00018ff0: 2873 656c 662c 2027 6163 7469 6f6e 2d73  (self, 'action-s
+00019000: 6574 272c 2027 6578 6974 2030 2729 0a20  et', 'exit 0'). 
+00019010: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00019020: 2e61 7373 6572 7452 6169 7365 7328 5661  .assertRaises(Va
+00019030: 6c75 6545 7272 6f72 293a 0a20 2020 2020  lueError):.     
+00019040: 2020 2020 2020 2073 656c 662e 6261 636b         self.back
+00019050: 656e 642e 6163 7469 6f6e 5f73 6574 287b  end.action_set({
+00019060: 2761 2e62 273a 2031 2c20 2761 273a 207b  'a.b': 1, 'a': {
+00019070: 2762 273a 2032 7d2c 2027 6427 3a20 337d  'b': 2}, 'd': 3}
+00019080: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+00019090: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+000190a0: 2856 616c 7565 4572 726f 7229 3a0a 2020  (ValueError):.  
+000190b0: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
+000190c0: 6163 6b65 6e64 2e61 6374 696f 6e5f 7365  ackend.action_se
+000190d0: 7428 7b27 6127 3a20 7b27 6227 3a20 312c  t({'a': {'b': 1,
+000190e0: 2027 6327 3a20 322c 2027 6427 3a20 7b27   'c': 2, 'd': {'
+000190f0: 6527 3a20 337d 7d2c 2027 6627 3a20 342c  e': 3}}, 'f': 4,
+00019100: 2027 612e 642e 6527 3a20 2766 6f6f 277d   'a.d.e': 'foo'}
+00019110: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00019120: 6163 7469 6f6e 5f66 6169 6c28 7365 6c66  action_fail(self
+00019130: 293a 0a20 2020 2020 2020 2066 616b 655f  ):.        fake_
+00019140: 7363 7269 7074 2873 656c 662c 2027 6163  script(self, 'ac
+00019150: 7469 6f6e 2d67 6574 272c 2027 6578 6974  tion-get', 'exit
+00019160: 2031 2729 0a20 2020 2020 2020 2066 616b   1').        fak
+00019170: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
+00019180: 6163 7469 6f6e 2d66 6169 6c27 2c20 2765  action-fail', 'e
+00019190: 7869 7420 3027 290a 2020 2020 2020 2020  xit 0').        
+000191a0: 7365 6c66 2e62 6163 6b65 6e64 2e61 6374  self.backend.act
+000191b0: 696f 6e5f 6661 696c 2827 6572 726f 7220  ion_fail('error 
+000191c0: 3432 2729 0a20 2020 2020 2020 2073 656c  42').        sel
+000191d0: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
+000191e0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
+000191f0: 7365 6c66 292c 205b 5b27 6163 7469 6f6e  self), [['action
+00019200: 2d66 6169 6c27 2c20 2765 7272 6f72 2034  -fail', 'error 4
+00019210: 3227 5d5d 290a 0a20 2020 2064 6566 2074  2']])..    def t
+00019220: 6573 745f 6163 7469 6f6e 5f6c 6f67 2873  est_action_log(s
+00019230: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
+00019240: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+00019250: 2761 6374 696f 6e2d 6765 7427 2c20 2765  'action-get', 'e
+00019260: 7869 7420 3127 290a 2020 2020 2020 2020  xit 1').        
+00019270: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+00019280: 2c20 2761 6374 696f 6e2d 6c6f 6727 2c20  , 'action-log', 
+00019290: 2765 7869 7420 3027 290a 2020 2020 2020  'exit 0').      
+000192a0: 2020 7365 6c66 2e62 6163 6b65 6e64 2e61    self.backend.a
+000192b0: 6374 696f 6e5f 6c6f 6728 2770 726f 6772  ction_log('progr
+000192c0: 6573 733a 2034 3225 2729 0a20 2020 2020  ess: 42%').     
+000192d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000192e0: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
+000192f0: 6361 6c6c 7328 7365 6c66 292c 205b 5b27  calls(self), [['
+00019300: 6163 7469 6f6e 2d6c 6f67 272c 2027 7072  action-log', 'pr
+00019310: 6f67 7265 7373 3a20 3432 2527 5d5d 290a  ogress: 42%']]).
+00019320: 0a20 2020 2064 6566 2074 6573 745f 6170  .    def test_ap
+00019330: 706c 6963 6174 696f 6e5f 7665 7273 696f  plication_versio
+00019340: 6e5f 7365 7428 7365 6c66 293a 0a20 2020  n_set(self):.   
+00019350: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+00019360: 2873 656c 662c 2027 6170 706c 6963 6174  (self, 'applicat
+00019370: 696f 6e2d 7665 7273 696f 6e2d 7365 7427  ion-version-set'
+00019380: 2c20 2765 7869 7420 3027 290a 2020 2020  , 'exit 0').    
+00019390: 2020 2020 7365 6c66 2e62 6163 6b65 6e64      self.backend
+000193a0: 2e61 7070 6c69 6361 7469 6f6e 5f76 6572  .application_ver
+000193b0: 7369 6f6e 5f73 6574 2827 312e 3262 3327  sion_set('1.2b3'
+000193c0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000193d0: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
+000193e0: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
+000193f0: 6629 2c20 5b5b 2761 7070 6c69 6361 7469  f), [['applicati
+00019400: 6f6e 2d76 6572 7369 6f6e 2d73 6574 272c  on-version-set',
+00019410: 2027 2d2d 272c 2027 312e 3262 3327 5d5d   '--', '1.2b3']]
+00019420: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00019430: 6170 706c 6963 6174 696f 6e5f 7665 7273  application_vers
+00019440: 696f 6e5f 7365 745f 696e 7661 6c69 6428  ion_set_invalid(
+00019450: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
+00019460: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+00019470: 2027 6170 706c 6963 6174 696f 6e2d 7665   'application-ve
+00019480: 7273 696f 6e2d 7365 7427 2c20 2765 7869  rsion-set', 'exi
+00019490: 7420 3027 290a 2020 2020 2020 2020 7769  t 0').        wi
+000194a0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+000194b0: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
+000194c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000194d0: 662e 6261 636b 656e 642e 6170 706c 6963  f.backend.applic
+000194e0: 6174 696f 6e5f 7665 7273 696f 6e5f 7365  ation_version_se
+000194f0: 7428 3229 0a20 2020 2020 2020 2077 6974  t(2).        wit
+00019500: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00019510: 7365 7328 5479 7065 4572 726f 7229 3a0a  ses(TypeError):.
+00019520: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00019530: 2e62 6163 6b65 6e64 2e61 7070 6c69 6361  .backend.applica
+00019540: 7469 6f6e 5f76 6572 7369 6f6e 5f73 6574  tion_version_set
+00019550: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+00019560: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
+00019570: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
+00019580: 6c66 292c 205b 5d29 0a0a 2020 2020 6465  lf), [])..    de
+00019590: 6620 7465 7374 5f6a 756a 755f 6c6f 6728  f test_juju_log(
+000195a0: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
+000195b0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+000195c0: 2027 6a75 6a75 2d6c 6f67 272c 2027 6578   'juju-log', 'ex
+000195d0: 6974 2030 2729 0a20 2020 2020 2020 2073  it 0').        s
+000195e0: 656c 662e 6261 636b 656e 642e 6a75 6a75  elf.backend.juju
+000195f0: 5f6c 6f67 2827 5741 524e 494e 4727 2c20  _log('WARNING', 
+00019600: 2766 6f6f 2729 0a20 2020 2020 2020 2073  'foo').        s
+00019610: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00019620: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
+00019630: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
+00019640: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
+00019650: 2020 2020 2020 2020 2020 2020 2020 5b5b                [[
+00019660: 276a 756a 752d 6c6f 6727 2c20 272d 2d6c  'juju-log', '--l
+00019670: 6f67 2d6c 6576 656c 272c 2027 5741 524e  og-level', 'WARN
+00019680: 494e 4727 2c20 272d 2d27 2c20 2766 6f6f  ING', '--', 'foo
+00019690: 275d 5d29 0a0a 2020 2020 2020 2020 7769  ']])..        wi
+000196a0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+000196b0: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
+000196c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000196d0: 662e 6261 636b 656e 642e 6a75 6a75 5f6c  f.backend.juju_l
+000196e0: 6f67 2827 4445 4255 4727 290a 2020 2020  og('DEBUG').    
+000196f0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00019700: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
+00019710: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
+00019720: 6172 3d54 7275 6529 2c20 5b5d 290a 0a20  ar=True), []).. 
+00019730: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+00019740: 7074 2873 656c 662c 2027 6a75 6a75 2d6c  pt(self, 'juju-l
+00019750: 6f67 272c 2027 6578 6974 2031 2729 0a20  og', 'exit 1'). 
+00019760: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00019770: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
+00019780: 732e 4d6f 6465 6c45 7272 6f72 293a 0a20  s.ModelError):. 
+00019790: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000197a0: 6261 636b 656e 642e 6a75 6a75 5f6c 6f67  backend.juju_log
+000197b0: 2827 4241 5227 2c20 2766 6f6f 2729 0a20  ('BAR', 'foo'). 
+000197c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000197d0: 7274 4571 7561 6c28 6661 6b65 5f73 6372  rtEqual(fake_scr
+000197e0: 6970 745f 6361 6c6c 7328 7365 6c66 2c20  ipt_calls(self, 
+000197f0: 636c 6561 723d 5472 7565 292c 0a20 2020  clear=True),.   
+00019800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019810: 2020 2020 2020 5b5b 276a 756a 752d 6c6f        [['juju-lo
+00019820: 6727 2c20 272d 2d6c 6f67 2d6c 6576 656c  g', '--log-level
+00019830: 272c 2027 4241 5227 2c20 272d 2d27 2c20  ', 'BAR', '--', 
+00019840: 2766 6f6f 275d 5d29 0a0a 2020 2020 6465  'foo']])..    de
+00019850: 6620 7465 7374 5f76 616c 6964 5f6d 6574  f test_valid_met
+00019860: 7269 6373 2873 656c 6629 3a0a 2020 2020  rics(self):.    
+00019870: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+00019880: 7365 6c66 2c20 2761 6464 2d6d 6574 7269  self, 'add-metri
+00019890: 6327 2c20 2765 7869 7420 3027 290a 2020  c', 'exit 0').  
+000198a0: 2020 2020 2020 7465 7374 5f63 6173 6573        test_cases
+000198b0: 203d 205b 280a 2020 2020 2020 2020 2020   = [(.          
+000198c0: 2020 4f72 6465 7265 6444 6963 7428 5b28    OrderedDict([(
+000198d0: 2766 6f6f 272c 2034 3229 2c20 2827 622d  'foo', 42), ('b-
+000198e0: 6172 272c 2034 2e35 292c 2028 2762 615f  ar', 4.5), ('ba_
+000198f0: 2d7a 272c 2034 2e35 292c 2028 2761 272c  -z', 4.5), ('a',
+00019900: 2031 295d 292c 0a20 2020 2020 2020 2020   1)]),.         
+00019910: 2020 204f 7264 6572 6564 4469 6374 285b     OrderedDict([
+00019920: 2827 6465 272c 2027 6164 2729 2c20 2827  ('de', 'ad'), ('
+00019930: 6265 272c 2027 6566 5f20 2d27 295d 292c  be', 'ef_ -')]),
+00019940: 0a20 2020 2020 2020 2020 2020 205b 5b27  .            [['
+00019950: 6164 642d 6d65 7472 6963 272c 2027 2d2d  add-metric', '--
+00019960: 6c61 6265 6c73 272c 2027 6465 3d61 642c  labels', 'de=ad,
+00019970: 6265 3d65 665f 202d 272c 0a20 2020 2020  be=ef_ -',.     
+00019980: 2020 2020 2020 2020 2027 666f 6f3d 3432           'foo=42
+00019990: 272c 2027 622d 6172 3d34 2e35 272c 2027  ', 'b-ar=4.5', '
+000199a0: 6261 5f2d 7a3d 342e 3527 2c20 2761 3d31  ba_-z=4.5', 'a=1
+000199b0: 275d 5d0a 2020 2020 2020 2020 292c 2028  ']].        ), (
+000199c0: 0a20 2020 2020 2020 2020 2020 204f 7264  .            Ord
+000199d0: 6572 6564 4469 6374 285b 2827 666f 6f31  eredDict([('foo1
+000199e0: 272c 2030 292c 2028 2762 3272 272c 2034  ', 0), ('b2r', 4
+000199f0: 2e35 295d 292c 0a20 2020 2020 2020 2020  .5)]),.         
+00019a00: 2020 204f 7264 6572 6564 4469 6374 285b     OrderedDict([
+00019a10: 2827 6433 272c 2027 61d0 b427 292c 2028  ('d3', 'a..'), (
+00019a20: 2762 3333 6627 2c20 2733 5f20 2d27 295d  'b33f', '3_ -')]
+00019a30: 292c 0a20 2020 2020 2020 2020 2020 205b  ),.            [
+00019a40: 5b27 6164 642d 6d65 7472 6963 272c 2027  ['add-metric', '
+00019a50: 2d2d 6c61 6265 6c73 272c 2027 6433 3d61  --labels', 'd3=a
+00019a60: d0b4 2c62 3333 663d 335f 202d 272c 2027  ..,b33f=3_ -', '
+00019a70: 666f 6f31 3d30 272c 2027 6232 723d 342e  foo1=0', 'b2r=4.
+00019a80: 3527 5d5d 2c0a 2020 2020 2020 2020 295d  5']],.        )]
+00019a90: 0a20 2020 2020 2020 2066 6f72 206d 6574  .        for met
+00019aa0: 7269 6373 2c20 6c61 6265 6c73 2c20 6578  rics, labels, ex
+00019ab0: 7065 6374 6564 5f63 616c 6c73 2069 6e20  pected_calls in 
+00019ac0: 7465 7374 5f63 6173 6573 3a0a 2020 2020  test_cases:.    
+00019ad0: 2020 2020 2020 2020 7365 6c66 2e62 6163          self.bac
+00019ae0: 6b65 6e64 2e61 6464 5f6d 6574 7269 6373  kend.add_metrics
+00019af0: 286d 6574 7269 6373 2c20 6c61 6265 6c73  (metrics, labels
+00019b00: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00019b10: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
+00019b20: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
+00019b30: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
+00019b40: 6529 2c20 6578 7065 6374 6564 5f63 616c  e), expected_cal
+00019b50: 6c73 290a 0a20 2020 2064 6566 2074 6573  ls)..    def tes
+00019b60: 745f 696e 7661 6c69 645f 6d65 7472 6963  t_invalid_metric
+00019b70: 5f6e 616d 6573 2873 656c 6629 3a0a 2020  _names(self):.  
+00019b80: 2020 2020 2020 696e 7661 6c69 645f 696e        invalid_in
+00019b90: 7075 7473 203d 205b 0a20 2020 2020 2020  puts = [.       
+00019ba0: 2020 2020 2028 7b27 273a 2034 2e32 7d2c       ({'': 4.2},
+00019bb0: 207b 7d29 2c0a 2020 2020 2020 2020 2020   {}),.          
+00019bc0: 2020 287b 2731 273a 2034 2e32 7d2c 207b    ({'1': 4.2}, {
+00019bd0: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
+00019be0: 287b 2731 273a 202d 342e 327d 2c20 7b7d  ({'1': -4.2}, {}
+00019bf0: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+00019c00: 7b27 3132 3327 3a20 342e 327d 2c20 7b7d  {'123': 4.2}, {}
+00019c10: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+00019c20: 7b27 3166 6f6f 273a 2034 2e32 7d2c 207b  {'1foo': 4.2}, {
+00019c30: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
+00019c40: 287b 272d 666f 6f27 3a20 342e 327d 2c20  ({'-foo': 4.2}, 
+00019c50: 7b7d 292c 0a20 2020 2020 2020 2020 2020  {}),.           
+00019c60: 2028 7b27 5f66 6f6f 273a 2034 2e32 7d2c   ({'_foo': 4.2},
+00019c70: 207b 7d29 2c0a 2020 2020 2020 2020 2020   {}),.          
+00019c80: 2020 287b 2766 6f6f 2d27 3a20 342e 327d    ({'foo-': 4.2}
+00019c90: 2c20 7b7d 292c 0a20 2020 2020 2020 2020  , {}),.         
+00019ca0: 2020 2028 7b27 666f 6f5f 273a 2034 2e32     ({'foo_': 4.2
+00019cb0: 7d2c 207b 7d29 2c0a 2020 2020 2020 2020  }, {}),.        
+00019cc0: 2020 2020 287b 2761 2d27 3a20 342e 327d      ({'a-': 4.2}
+00019cd0: 2c20 7b7d 292c 0a20 2020 2020 2020 2020  , {}),.         
+00019ce0: 2020 2028 7b27 615f 273a 2034 2e32 7d2c     ({'a_': 4.2},
+00019cf0: 207b 7d29 2c0a 2020 2020 2020 2020 2020   {}),.          
+00019d00: 2020 287b 2742 41d0 af27 3a20 342e 327d    ({'BA..': 4.2}
+00019d10: 2c20 7b7d 292c 0a20 2020 2020 2020 205d  , {}),.        ]
+00019d20: 0a20 2020 2020 2020 2066 6f72 206d 6574  .        for met
+00019d30: 7269 6373 2c20 6c61 6265 6c73 2069 6e20  rics, labels in 
+00019d40: 696e 7661 6c69 645f 696e 7075 7473 3a0a  invalid_inputs:.
+00019d50: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00019d60: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+00019d70: 6573 286f 7073 2e4d 6f64 656c 4572 726f  es(ops.ModelErro
+00019d80: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00019d90: 2020 2020 7365 6c66 2e62 6163 6b65 6e64      self.backend
+00019da0: 2e61 6464 5f6d 6574 7269 6373 286d 6574  .add_metrics(met
+00019db0: 7269 6373 2c20 6c61 6265 6c73 290a 0a20  rics, labels).. 
+00019dc0: 2020 2064 6566 2074 6573 745f 696e 7661     def test_inva
+00019dd0: 6c69 645f 6d65 7472 6963 5f76 616c 7565  lid_metric_value
+00019de0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+00019df0: 2069 6e76 616c 6964 5f69 6e70 7574 7320   invalid_inputs 
+00019e00: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00019e10: 287b 2761 273a 2066 6c6f 6174 2827 2b69  ({'a': float('+i
+00019e20: 6e66 2729 7d2c 207b 7d29 2c0a 2020 2020  nf')}, {}),.    
+00019e30: 2020 2020 2020 2020 287b 2761 273a 2066          ({'a': f
+00019e40: 6c6f 6174 2827 2d69 6e66 2729 7d2c 207b  loat('-inf')}, {
+00019e50: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
+00019e60: 287b 2761 273a 2066 6c6f 6174 2827 6e61  ({'a': float('na
+00019e70: 6e27 297d 2c20 7b7d 292c 0a20 2020 2020  n')}, {}),.     
+00019e80: 2020 2020 2020 2028 7b27 666f 6f27 3a20         ({'foo': 
+00019e90: 2762 6172 277d 2c20 7b7d 292c 0a20 2020  'bar'}, {}),.   
+00019ea0: 2020 2020 2020 2020 2028 7b27 666f 6f27           ({'foo'
+00019eb0: 3a20 2731 4f27 7d2c 207b 7d29 2c0a 2020  : '1O'}, {}),.  
+00019ec0: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+00019ed0: 666f 7220 6d65 7472 6963 732c 206c 6162  for metrics, lab
+00019ee0: 656c 7320 696e 2069 6e76 616c 6964 5f69  els in invalid_i
+00019ef0: 6e70 7574 733a 0a20 2020 2020 2020 2020  nputs:.         
+00019f00: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00019f10: 6572 7452 6169 7365 7328 6f70 732e 4d6f  ertRaises(ops.Mo
+00019f20: 6465 6c45 7272 6f72 293a 0a20 2020 2020  delError):.     
+00019f30: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00019f40: 6261 636b 656e 642e 6164 645f 6d65 7472  backend.add_metr
+00019f50: 6963 7328 6d65 7472 6963 732c 206c 6162  ics(metrics, lab
+00019f60: 656c 7329 0a0a 2020 2020 6465 6620 7465  els)..    def te
+00019f70: 7374 5f69 6e76 616c 6964 5f6d 6574 7269  st_invalid_metri
+00019f80: 635f 6c61 6265 6c73 2873 656c 6629 3a0a  c_labels(self):.
+00019f90: 2020 2020 2020 2020 696e 7661 6c69 645f          invalid_
+00019fa0: 696e 7075 7473 203d 205b 0a20 2020 2020  inputs = [.     
+00019fb0: 2020 2020 2020 2028 7b27 666f 6f27 3a20         ({'foo': 
+00019fc0: 342e 327d 2c20 7b27 273a 2027 6261 7a27  4.2}, {'': 'baz'
+00019fd0: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
+00019fe0: 287b 2766 6f6f 273a 2034 2e32 7d2c 207b  ({'foo': 4.2}, {
+00019ff0: 272c 6261 7227 3a20 2762 617a 277d 292c  ',bar': 'baz'}),
+0001a000: 0a20 2020 2020 2020 2020 2020 2028 7b27  .            ({'
+0001a010: 666f 6f27 3a20 342e 327d 2c20 7b27 623d  foo': 4.2}, {'b=
+0001a020: 613d 7227 3a20 2762 617a 277d 292c 0a20  a=r': 'baz'}),. 
+0001a030: 2020 2020 2020 2020 2020 2028 7b27 666f             ({'fo
+0001a040: 6f27 3a20 342e 327d 2c20 7b27 4241 d0af  o': 4.2}, {'BA..
+0001a050: 273a 2027 6261 7a27 7d29 2c0a 2020 2020  ': 'baz'}),.    
+0001a060: 2020 2020 5d0a 2020 2020 2020 2020 666f      ].        fo
+0001a070: 7220 6d65 7472 6963 732c 206c 6162 656c  r metrics, label
+0001a080: 7320 696e 2069 6e76 616c 6964 5f69 6e70  s in invalid_inp
+0001a090: 7574 733a 0a20 2020 2020 2020 2020 2020  uts:.           
+0001a0a0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+0001a0b0: 7452 6169 7365 7328 6f70 732e 4d6f 6465  tRaises(ops.Mode
+0001a0c0: 6c45 7272 6f72 293a 0a20 2020 2020 2020  lError):.       
+0001a0d0: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
+0001a0e0: 636b 656e 642e 6164 645f 6d65 7472 6963  ckend.add_metric
+0001a0f0: 7328 6d65 7472 6963 732c 206c 6162 656c  s(metrics, label
+0001a100: 7329 0a0a 2020 2020 6465 6620 7465 7374  s)..    def test
+0001a110: 5f69 6e76 616c 6964 5f6d 6574 7269 635f  _invalid_metric_
+0001a120: 6c61 6265 6c5f 7661 6c75 6573 2873 656c  label_values(sel
+0001a130: 6629 3a0a 2020 2020 2020 2020 696e 7661  f):.        inva
+0001a140: 6c69 645f 696e 7075 7473 203d 205b 0a20  lid_inputs = [. 
+0001a150: 2020 2020 2020 2020 2020 2028 7b27 666f             ({'fo
+0001a160: 6f27 3a20 342e 327d 2c20 7b27 6261 7227  o': 4.2}, {'bar'
+0001a170: 3a20 2727 7d29 2c0a 2020 2020 2020 2020  : ''}),.        
+0001a180: 2020 2020 287b 2766 6f6f 273a 2034 2e32      ({'foo': 4.2
+0001a190: 7d2c 207b 2762 6172 273a 2027 622c 617a  }, {'bar': 'b,az
+0001a1a0: 277d 292c 0a20 2020 2020 2020 2020 2020  '}),.           
+0001a1b0: 2028 7b27 666f 6f27 3a20 342e 327d 2c20   ({'foo': 4.2}, 
+0001a1c0: 7b27 6261 7227 3a20 2762 3d61 7a27 7d29  {'bar': 'b=az'})
+0001a1d0: 2c0a 2020 2020 2020 2020 5d0a 2020 2020  ,.        ].    
+0001a1e0: 2020 2020 666f 7220 6d65 7472 6963 732c      for metrics,
+0001a1f0: 206c 6162 656c 7320 696e 2069 6e76 616c   labels in inval
+0001a200: 6964 5f69 6e70 7574 733a 0a20 2020 2020  id_inputs:.     
+0001a210: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+0001a220: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
+0001a230: 732e 4d6f 6465 6c45 7272 6f72 293a 0a20  s.ModelError):. 
+0001a240: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001a250: 656c 662e 6261 636b 656e 642e 6164 645f  elf.backend.add_
+0001a260: 6d65 7472 6963 7328 6d65 7472 6963 732c  metrics(metrics,
+0001a270: 206c 6162 656c 7329 0a0a 2020 2020 6465   labels)..    de
+0001a280: 6620 7465 7374 5f72 656c 6174 696f 6e5f  f test_relation_
+0001a290: 7265 6d6f 7465 5f61 7070 5f6e 616d 655f  remote_app_name_
+0001a2a0: 656e 7628 7365 6c66 293a 0a20 2020 2020  env(self):.     
+0001a2b0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+0001a2c0: 7570 286f 732e 656e 7669 726f 6e2e 706f  up(os.environ.po
+0001a2d0: 702c 2027 4a55 4a55 5f52 454c 4154 494f  p, 'JUJU_RELATIO
+0001a2e0: 4e5f 4944 272c 204e 6f6e 6529 0a20 2020  N_ID', None).   
+0001a2f0: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
+0001a300: 616e 7570 286f 732e 656e 7669 726f 6e2e  anup(os.environ.
+0001a310: 706f 702c 2027 4a55 4a55 5f52 454d 4f54  pop, 'JUJU_REMOT
+0001a320: 455f 4150 5027 2c20 4e6f 6e65 290a 0a20  E_APP', None).. 
+0001a330: 2020 2020 2020 206f 732e 656e 7669 726f         os.enviro
+0001a340: 6e5b 274a 554a 555f 5245 4c41 5449 4f4e  n['JUJU_RELATION
+0001a350: 5f49 4427 5d20 3d20 2778 3a35 270a 2020  _ID'] = 'x:5'.  
+0001a360: 2020 2020 2020 6f73 2e65 6e76 6972 6f6e        os.environ
+0001a370: 5b27 4a55 4a55 5f52 454d 4f54 455f 4150  ['JUJU_REMOTE_AP
+0001a380: 5027 5d20 3d20 2772 656d 6f74 6561 7070  P'] = 'remoteapp
+0001a390: 3127 0a20 2020 2020 2020 2073 656c 662e  1'.        self.
+0001a3a0: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+0001a3b0: 2e62 6163 6b65 6e64 2e72 656c 6174 696f  .backend.relatio
+0001a3c0: 6e5f 7265 6d6f 7465 5f61 7070 5f6e 616d  n_remote_app_nam
+0001a3d0: 6528 3529 2c20 2772 656d 6f74 6561 7070  e(5), 'remoteapp
+0001a3e0: 3127 290a 2020 2020 2020 2020 6f73 2e65  1').        os.e
+0001a3f0: 6e76 6972 6f6e 5b27 4a55 4a55 5f52 454c  nviron['JUJU_REL
+0001a400: 4154 494f 4e5f 4944 275d 203d 2027 3527  ATION_ID'] = '5'
+0001a410: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001a420: 7365 7274 4571 7561 6c28 7365 6c66 2e62  sertEqual(self.b
+0001a430: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
+0001a440: 7265 6d6f 7465 5f61 7070 5f6e 616d 6528  remote_app_name(
+0001a450: 3529 2c20 2772 656d 6f74 6561 7070 3127  5), 'remoteapp1'
+0001a460: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001a470: 7265 6c61 7469 6f6e 5f72 656d 6f74 655f  relation_remote_
+0001a480: 6170 705f 6e61 6d65 5f73 6372 6970 745f  app_name_script_
+0001a490: 7375 6363 6573 7328 7365 6c66 293a 0a20  success(self):. 
+0001a4a0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+0001a4b0: 6c65 616e 7570 286f 732e 656e 7669 726f  leanup(os.enviro
+0001a4c0: 6e2e 706f 702c 2027 4a55 4a55 5f52 454c  n.pop, 'JUJU_REL
+0001a4d0: 4154 494f 4e5f 4944 272c 204e 6f6e 6529  ATION_ID', None)
+0001a4e0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0001a4f0: 6443 6c65 616e 7570 286f 732e 656e 7669  dCleanup(os.envi
+0001a500: 726f 6e2e 706f 702c 2027 4a55 4a55 5f52  ron.pop, 'JUJU_R
+0001a510: 454d 4f54 455f 4150 5027 2c20 4e6f 6e65  EMOTE_APP', None
+0001a520: 290a 0a20 2020 2020 2020 2023 204a 554a  )..        # JUJ
+0001a530: 555f 5245 4c41 5449 4f4e 5f49 4420 616e  U_RELATION_ID an
+0001a540: 6420 4a55 4a55 5f52 454d 4f54 455f 4150  d JUJU_REMOTE_AP
+0001a550: 5020 626f 7468 2075 6e73 6574 0a20 2020  P both unset.   
+0001a560: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+0001a570: 2873 656c 662c 2027 7265 6c61 7469 6f6e  (self, 'relation
+0001a580: 2d6c 6973 7427 2c20 7222 2222 0a65 6368  -list', r""".ech
+0001a590: 6f20 2722 7265 6d6f 7465 6170 7032 2227  o '"remoteapp2"'
+0001a5a0: 0a22 2222 290a 2020 2020 2020 2020 7365  .""").        se
+0001a5b0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0001a5c0: 656c 662e 6261 636b 656e 642e 7265 6c61  elf.backend.rela
+0001a5d0: 7469 6f6e 5f72 656d 6f74 655f 6170 705f  tion_remote_app_
+0001a5e0: 6e61 6d65 2831 292c 2027 7265 6d6f 7465  name(1), 'remote
+0001a5f0: 6170 7032 2729 0a20 2020 2020 2020 2073  app2').        s
+0001a600: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001a610: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
+0001a620: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
+0001a630: 7565 292c 205b 0a20 2020 2020 2020 2020  ue), [.         
+0001a640: 2020 205b 2772 656c 6174 696f 6e2d 6c69     ['relation-li
+0001a650: 7374 272c 2027 2d72 272c 2027 3127 2c20  st', '-r', '1', 
+0001a660: 272d 2d61 7070 272c 2027 2d2d 666f 726d  '--app', '--form
+0001a670: 6174 3d6a 736f 6e27 5d2c 0a20 2020 2020  at=json'],.     
+0001a680: 2020 205d 290a 0a20 2020 2020 2020 2023     ])..        #
+0001a690: 204a 554a 555f 5245 4c41 5449 4f4e 5f49   JUJU_RELATION_I
+0001a6a0: 4420 7365 7420 6275 7420 4a55 4a55 5f52  D set but JUJU_R
+0001a6b0: 454d 4f54 455f 4150 5020 756e 7365 740a  EMOTE_APP unset.
+0001a6c0: 2020 2020 2020 2020 6f73 2e65 6e76 6972          os.envir
+0001a6d0: 6f6e 5b27 4a55 4a55 5f52 454c 4154 494f  on['JUJU_RELATIO
+0001a6e0: 4e5f 4944 275d 203d 2027 783a 3527 0a20  N_ID'] = 'x:5'. 
+0001a6f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001a700: 7274 4571 7561 6c28 7365 6c66 2e62 6163  rtEqual(self.bac
+0001a710: 6b65 6e64 2e72 656c 6174 696f 6e5f 7265  kend.relation_re
+0001a720: 6d6f 7465 5f61 7070 5f6e 616d 6528 3529  mote_app_name(5)
+0001a730: 2c20 2772 656d 6f74 6561 7070 3227 290a  , 'remoteapp2').
+0001a740: 0a20 2020 2020 2020 2023 204a 554a 555f  .        # JUJU_
+0001a750: 5245 4c41 5449 4f4e 5f49 4420 756e 7365  RELATION_ID unse
+0001a760: 7420 6275 7420 4a55 4a55 5f52 454d 4f54  t but JUJU_REMOT
+0001a770: 455f 4150 5020 7365 740a 2020 2020 2020  E_APP set.      
+0001a780: 2020 6465 6c20 6f73 2e65 6e76 6972 6f6e    del os.environ
+0001a790: 5b27 4a55 4a55 5f52 454c 4154 494f 4e5f  ['JUJU_RELATION_
+0001a7a0: 4944 275d 0a20 2020 2020 2020 206f 732e  ID'].        os.
+0001a7b0: 656e 7669 726f 6e5b 274a 554a 555f 5245  environ['JUJU_RE
+0001a7c0: 4d4f 5445 5f41 5050 275d 203d 2027 7265  MOTE_APP'] = 're
+0001a7d0: 6d6f 7465 6170 7031 270a 2020 2020 2020  moteapp1'.      
+0001a7e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001a7f0: 616c 2873 656c 662e 6261 636b 656e 642e  al(self.backend.
+0001a800: 7265 6c61 7469 6f6e 5f72 656d 6f74 655f  relation_remote_
+0001a810: 6170 705f 6e61 6d65 2835 292c 2027 7265  app_name(5), 're
+0001a820: 6d6f 7465 6170 7032 2729 0a0a 2020 2020  moteapp2')..    
+0001a830: 2020 2020 2320 426f 7468 2073 6574 2c20      # Both set, 
+0001a840: 6275 7420 4a55 4a55 5f52 454c 4154 494f  but JUJU_RELATIO
+0001a850: 4e5f 4944 2061 2064 6966 6665 7265 6e74  N_ID a different
+0001a860: 2072 656c 6174 696f 6e0a 2020 2020 2020   relation.      
+0001a870: 2020 6f73 2e65 6e76 6972 6f6e 5b27 4a55    os.environ['JU
+0001a880: 4a55 5f52 454c 4154 494f 4e5f 4944 275d  JU_RELATION_ID']
+0001a890: 203d 2027 783a 3627 0a20 2020 2020 2020   = 'x:6'.       
+0001a8a0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001a8b0: 6c28 7365 6c66 2e62 6163 6b65 6e64 2e72  l(self.backend.r
+0001a8c0: 656c 6174 696f 6e5f 7265 6d6f 7465 5f61  elation_remote_a
+0001a8d0: 7070 5f6e 616d 6528 3529 2c20 2772 656d  pp_name(5), 'rem
+0001a8e0: 6f74 6561 7070 3227 290a 0a20 2020 2064  oteapp2')..    d
+0001a8f0: 6566 2074 6573 745f 7265 6c61 7469 6f6e  ef test_relation
+0001a900: 5f72 656d 6f74 655f 6170 705f 6e61 6d65  _remote_app_name
+0001a910: 5f73 6372 6970 745f 6572 726f 7273 2873  _script_errors(s
+0001a920: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
+0001a930: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+0001a940: 2772 656c 6174 696f 6e2d 6c69 7374 272c  'relation-list',
+0001a950: 2072 2222 220a 6563 686f 2022 4552 524f   r""".echo "ERRO
+0001a960: 5220 696e 7661 6c69 6420 7661 6c75 6520  R invalid value 
+0001a970: 5c22 365c 2220 666f 7220 6f70 7469 6f6e  \"6\" for option
+0001a980: 202d 723a 2072 656c 6174 696f 6e20 6e6f   -r: relation no
+0001a990: 7420 666f 756e 6422 203e 2632 2020 2320  t found" >&2  # 
+0001a9a0: 4e4f 5141 0a65 7869 7420 320a 2222 2229  NOQA.exit 2.""")
+0001a9b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001a9c0: 7365 7274 4973 2873 656c 662e 6261 636b  sertIs(self.back
+0001a9d0: 656e 642e 7265 6c61 7469 6f6e 5f72 656d  end.relation_rem
+0001a9e0: 6f74 655f 6170 705f 6e61 6d65 2836 292c  ote_app_name(6),
+0001a9f0: 204e 6f6e 6529 0a20 2020 2020 2020 2073   None).        s
+0001aa00: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001aa10: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
+0001aa20: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
+0001aa30: 7565 292c 205b 0a20 2020 2020 2020 2020  ue), [.         
+0001aa40: 2020 205b 2772 656c 6174 696f 6e2d 6c69     ['relation-li
+0001aa50: 7374 272c 2027 2d72 272c 2027 3627 2c20  st', '-r', '6', 
+0001aa60: 272d 2d61 7070 272c 2027 2d2d 666f 726d  '--app', '--form
+0001aa70: 6174 3d6a 736f 6e27 5d2c 0a20 2020 2020  at=json'],.     
+0001aa80: 2020 205d 290a 0a20 2020 2020 2020 2066     ])..        f
+0001aa90: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+0001aaa0: 2027 7265 6c61 7469 6f6e 2d6c 6973 7427   'relation-list'
+0001aab0: 2c20 7222 2222 0a65 6368 6f20 2245 5252  , r""".echo "ERR
+0001aac0: 4f52 206f 7074 696f 6e20 7072 6f76 6964  OR option provid
+0001aad0: 6564 2062 7574 206e 6f74 2064 6566 696e  ed but not defin
+0001aae0: 6564 3a20 2d2d 6170 7022 203e 2632 0a65  ed: --app" >&2.e
+0001aaf0: 7869 7420 320a 2222 2229 0a20 2020 2020  xit 2.""").     
+0001ab00: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+0001ab10: 2873 656c 662e 6261 636b 656e 642e 7265  (self.backend.re
+0001ab20: 6c61 7469 6f6e 5f72 656d 6f74 655f 6170  lation_remote_ap
+0001ab30: 705f 6e61 6d65 2836 292c 204e 6f6e 6529  p_name(6), None)
+0001ab40: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001ab50: 7365 7274 4571 7561 6c28 6661 6b65 5f73  sertEqual(fake_s
+0001ab60: 6372 6970 745f 6361 6c6c 7328 7365 6c66  cript_calls(self
+0001ab70: 2c20 636c 6561 723d 5472 7565 292c 205b  , clear=True), [
+0001ab80: 0a20 2020 2020 2020 2020 2020 205b 2772  .            ['r
+0001ab90: 656c 6174 696f 6e2d 6c69 7374 272c 2027  elation-list', '
+0001aba0: 2d72 272c 2027 3627 2c20 272d 2d61 7070  -r', '6', '--app
+0001abb0: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
+0001abc0: 6e27 5d2c 0a20 2020 2020 2020 205d 290a  n'],.        ]).
+0001abd0: 0a20 2020 2064 6566 2074 6573 745f 706c  .    def test_pl
+0001abe0: 616e 6e65 645f 756e 6974 7328 7365 6c66  anned_units(self
+0001abf0: 293a 0a20 2020 2020 2020 2023 206e 6f20  ):.        # no 
+0001ac00: 756e 6974 730a 2020 2020 2020 2020 6661  units.        fa
+0001ac10: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+0001ac20: 2767 6f61 6c2d 7374 6174 6527 2c20 2222  'goal-state', ""
+0001ac30: 220a 6563 686f 2027 7b22 756e 6974 7322  ".echo '{"units"
+0001ac40: 3a7b 7d2c 2022 7265 6c61 7469 6f6e 7322  :{}, "relations"
+0001ac50: 3a7b 7d7d 270a 2222 2229 0a20 2020 2020  :{}}'.""").     
+0001ac60: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001ac70: 7561 6c28 7365 6c66 2e62 6163 6b65 6e64  ual(self.backend
+0001ac80: 2e70 6c61 6e6e 6564 5f75 6e69 7473 2829  .planned_units()
+0001ac90: 2c20 3029 0a0a 2020 2020 2020 2020 2320  , 0)..        # 
+0001aca0: 6f6e 6c79 2061 6374 6976 6520 756e 6974  only active unit
+0001acb0: 730a 2020 2020 2020 2020 6661 6b65 5f73  s.        fake_s
+0001acc0: 6372 6970 7428 7365 6c66 2c20 2767 6f61  cript(self, 'goa
+0001acd0: 6c2d 7374 6174 6527 2c20 2222 220a 6563  l-state', """.ec
+0001ace0: 686f 2027 7b0a 2020 2020 2275 6e69 7473  ho '{.    "units
+0001acf0: 223a 7b0a 2020 2020 2020 2020 2261 7070  ":{.        "app
+0001ad00: 2f30 223a 207b 2273 7461 7475 7322 3a22  /0": {"status":"
+0001ad10: 6163 7469 7665 222c 2273 696e 6365 223a  active","since":
+0001ad20: 2232 3032 332d 3035 2d32 3320 3137 3a30  "2023-05-23 17:0
+0001ad30: 353a 3035 5a22 7d2c 0a20 2020 2020 2020  5:05Z"},.       
+0001ad40: 2022 6170 702f 3122 3a20 7b22 7374 6174   "app/1": {"stat
+0001ad50: 7573 223a 2261 6374 6976 6522 2c22 7369  us":"active","si
+0001ad60: 6e63 6522 3a22 3230 3233 2d30 352d 3233  nce":"2023-05-23
+0001ad70: 2031 373a 3537 3a30 355a 227d 0a20 2020   17:57:05Z"}.   
+0001ad80: 207d 2c0a 2020 2020 2272 656c 6174 696f   },.    "relatio
+0001ad90: 6e73 223a 207b 7d0a 7d27 2222 2229 0a20  ns": {}.}'"""). 
+0001ada0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001adb0: 7274 4571 7561 6c28 7365 6c66 2e62 6163  rtEqual(self.bac
+0001adc0: 6b65 6e64 2e70 6c61 6e6e 6564 5f75 6e69  kend.planned_uni
+0001add0: 7473 2829 2c20 3229 0a0a 2020 2020 2020  ts(), 2)..      
+0001ade0: 2020 2320 6163 7469 7665 2061 6e64 2064    # active and d
+0001adf0: 7969 6e67 2075 6e69 7473 0a20 2020 2020  ying units.     
+0001ae00: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+0001ae10: 656c 662c 2027 676f 616c 2d73 7461 7465  elf, 'goal-state
+0001ae20: 272c 2022 2222 0a65 6368 6f20 277b 0a20  ', """.echo '{. 
+0001ae30: 2020 2022 756e 6974 7322 3a7b 0a20 2020     "units":{.   
+0001ae40: 2020 2020 2022 6170 702f 3022 3a20 7b22       "app/0": {"
+0001ae50: 7374 6174 7573 223a 2261 6374 6976 6522  status":"active"
+0001ae60: 2c22 7369 6e63 6522 3a22 3230 3233 2d30  ,"since":"2023-0
+0001ae70: 352d 3233 2031 373a 3035 3a30 355a 227d  5-23 17:05:05Z"}
+0001ae80: 2c0a 2020 2020 2020 2020 2261 7070 2f31  ,.        "app/1
+0001ae90: 223a 207b 2273 7461 7475 7322 3a22 6479  ": {"status":"dy
+0001aea0: 696e 6722 2c22 7369 6e63 6522 3a22 3230  ing","since":"20
+0001aeb0: 3233 2d30 352d 3233 2031 373a 3537 3a30  23-05-23 17:57:0
+0001aec0: 355a 227d 0a20 2020 207d 2c0a 2020 2020  5Z"}.    },.    
+0001aed0: 2272 656c 6174 696f 6e73 223a 207b 7d0a  "relations": {}.
+0001aee0: 7d27 2222 2229 0a20 2020 2020 2020 2073  }'""").        s
+0001aef0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001af00: 7365 6c66 2e62 6163 6b65 6e64 2e70 6c61  self.backend.pla
+0001af10: 6e6e 6564 5f75 6e69 7473 2829 2c20 3129  nned_units(), 1)
+0001af20: 0a0a 0a63 6c61 7373 2054 6573 744c 617a  ...class TestLaz
+0001af30: 794d 6170 7069 6e67 2875 6e69 7474 6573  yMapping(unittes
+0001af40: 742e 5465 7374 4361 7365 293a 0a0a 2020  t.TestCase):..  
+0001af50: 2020 6465 6620 7465 7374 5f69 6e76 616c    def test_inval
+0001af60: 6964 6174 6528 7365 6c66 293a 0a20 2020  idate(self):.   
+0001af70: 2020 2020 206c 6f61 6465 6420 3d20 5b5d       loaded = []
+0001af80: 0a0a 2020 2020 2020 2020 636c 6173 7320  ..        class 
+0001af90: 4d79 4c61 7a79 4d61 7028 6f70 732e 4c61  MyLazyMap(ops.La
+0001afa0: 7a79 4d61 7070 696e 6729 3a0a 2020 2020  zyMapping):.    
+0001afb0: 2020 2020 2020 2020 6465 6620 5f6c 6f61          def _loa
+0001afc0: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
+0001afd0: 2020 2020 2020 2020 206c 6f61 6465 642e           loaded.
+0001afe0: 6170 7065 6e64 2831 290a 2020 2020 2020  append(1).      
+0001aff0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001b000: 207b 2766 6f6f 273a 2027 6261 7227 7d0a   {'foo': 'bar'}.
+0001b010: 0a20 2020 2020 2020 206d 6170 203d 204d  .        map = M
+0001b020: 794c 617a 794d 6170 2829 0a20 2020 2020  yLazyMap().     
+0001b030: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001b040: 7561 6c28 6d61 705b 2766 6f6f 275d 2c20  ual(map['foo'], 
+0001b050: 2762 6172 2729 0a20 2020 2020 2020 2073  'bar').        s
+0001b060: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001b070: 6c6f 6164 6564 2c20 5b31 5d29 0a20 2020  loaded, [1]).   
+0001b080: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001b090: 4571 7561 6c28 6d61 705b 2766 6f6f 275d  Equal(map['foo']
+0001b0a0: 2c20 2762 6172 2729 0a20 2020 2020 2020  , 'bar').       
+0001b0b0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001b0c0: 6c28 6c6f 6164 6564 2c20 5b31 5d29 0a20  l(loaded, [1]). 
+0001b0d0: 2020 2020 2020 206d 6170 2e5f 696e 7661         map._inva
+0001b0e0: 6c69 6461 7465 2829 0a20 2020 2020 2020  lidate().       
+0001b0f0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001b100: 6c28 6d61 705b 2766 6f6f 275d 2c20 2762  l(map['foo'], 'b
+0001b110: 6172 2729 0a20 2020 2020 2020 2073 656c  ar').        sel
+0001b120: 662e 6173 7365 7274 4571 7561 6c28 6c6f  f.assertEqual(lo
+0001b130: 6164 6564 2c20 5b31 2c20 315d 290a 0a0a  aded, [1, 1])...
+0001b140: 636c 6173 7320 5465 7374 5365 6372 6574  class TestSecret
+0001b150: 7328 756e 6974 7465 7374 2e54 6573 7443  s(unittest.TestC
+0001b160: 6173 6529 3a0a 2020 2020 6465 6620 7365  ase):.    def se
+0001b170: 7455 7028 7365 6c66 293a 0a20 2020 2020  tUp(self):.     
+0001b180: 2020 2073 656c 662e 6d6f 6465 6c20 3d20     self.model = 
+0001b190: 6f70 732e 4d6f 6465 6c28 6f70 732e 4368  ops.Model(ops.Ch
+0001b1a0: 6172 6d4d 6574 6128 292c 205f 4d6f 6465  armMeta(), _Mode
+0001b1b0: 6c42 6163 6b65 6e64 2827 6d79 6170 702f  lBackend('myapp/
+0001b1c0: 3027 2929 0a20 2020 2020 2020 2073 656c  0')).        sel
+0001b1d0: 662e 6170 7020 3d20 7365 6c66 2e6d 6f64  f.app = self.mod
+0001b1e0: 656c 2e61 7070 0a20 2020 2020 2020 2073  el.app.        s
+0001b1f0: 656c 662e 756e 6974 203d 2073 656c 662e  elf.unit = self.
+0001b200: 6d6f 6465 6c2e 756e 6974 0a0a 2020 2020  model.unit..    
+0001b210: 6465 6620 7465 7374 5f61 7070 5f61 6464  def test_app_add
+0001b220: 5f73 6563 7265 745f 7369 6d70 6c65 2873  _secret_simple(s
+0001b230: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
+0001b240: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+0001b250: 2773 6563 7265 742d 6164 6427 2c20 2765  'secret-add', 'e
+0001b260: 6368 6f20 7365 6372 6574 3a31 3233 2729  cho secret:123')
+0001b270: 0a0a 2020 2020 2020 2020 7365 6372 6574  ..        secret
+0001b280: 203d 2073 656c 662e 6170 702e 6164 645f   = self.app.add_
+0001b290: 7365 6372 6574 287b 2766 6f6f 273a 2027  secret({'foo': '
+0001b2a0: 7827 7d29 0a20 2020 2020 2020 2073 656c  x'}).        sel
+0001b2b0: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
+0001b2c0: 6365 2873 6563 7265 742c 206f 7073 2e53  ce(secret, ops.S
+0001b2d0: 6563 7265 7429 0a20 2020 2020 2020 2073  ecret).        s
+0001b2e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001b2f0: 7365 6372 6574 2e69 642c 2027 7365 6372  secret.id, 'secr
+0001b300: 6574 3a31 3233 2729 0a20 2020 2020 2020  et:123').       
+0001b310: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
+0001b320: 6e65 2873 6563 7265 742e 6c61 6265 6c29  ne(secret.label)
+0001b330: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+0001b340: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
+0001b350: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
+0001b360: 662c 2063 6c65 6172 3d54 7275 6529 2c0a  f, clear=True),.
+0001b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b380: 2020 2020 2020 2020 205b 5b27 7365 6372           [['secr
+0001b390: 6574 2d61 6464 272c 2027 2d2d 6f77 6e65  et-add', '--owne
+0001b3a0: 7227 2c20 2761 7070 6c69 6361 7469 6f6e  r', 'application
+0001b3b0: 272c 2027 666f 6f3d 7827 5d5d 290a 0a20  ', 'foo=x']]).. 
+0001b3c0: 2020 2064 6566 2074 6573 745f 6170 705f     def test_app_
+0001b3d0: 6164 645f 7365 6372 6574 5f61 7267 7328  add_secret_args(
+0001b3e0: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
+0001b3f0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+0001b400: 2027 7365 6372 6574 2d61 6464 272c 2027   'secret-add', '
+0001b410: 6563 686f 2073 6563 7265 743a 3233 3427  echo secret:234'
+0001b420: 290a 0a20 2020 2020 2020 2065 7870 6972  )..        expir
+0001b430: 6520 3d20 6461 7465 7469 6d65 2e64 6174  e = datetime.dat
+0001b440: 6574 696d 6528 3230 3232 2c20 3132 2c20  etime(2022, 12, 
+0001b450: 392c 2031 362c 2031 372c 2030 290a 2020  9, 16, 17, 0).  
+0001b460: 2020 2020 2020 7365 6372 6574 203d 2073        secret = s
+0001b470: 656c 662e 6170 702e 6164 645f 7365 6372  elf.app.add_secr
+0001b480: 6574 287b 2766 6f6f 273a 2027 7827 2c20  et({'foo': 'x', 
+0001b490: 2762 6172 273a 2027 7927 7d2c 206c 6162  'bar': 'y'}, lab
+0001b4a0: 656c 3d27 6c62 6c27 2c20 6465 7363 7269  el='lbl', descri
+0001b4b0: 7074 696f 6e3d 2764 6573 6327 2c0a 2020  ption='desc',.  
+0001b4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b4e0: 2020 2065 7870 6972 653d 6578 7069 7265     expire=expire
+0001b4f0: 2c20 726f 7461 7465 3d6f 7073 2e53 6563  , rotate=ops.Sec
+0001b500: 7265 7452 6f74 6174 652e 484f 5552 4c59  retRotate.HOURLY
+0001b510: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001b520: 7373 6572 7445 7175 616c 2873 6563 7265  ssertEqual(secre
+0001b530: 742e 6964 2c20 2773 6563 7265 743a 3233  t.id, 'secret:23
+0001b540: 3427 290a 2020 2020 2020 2020 7365 6c66  4').        self
+0001b550: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
+0001b560: 7265 742e 6c61 6265 6c2c 2027 6c62 6c27  ret.label, 'lbl'
+0001b570: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001b580: 7373 6572 7445 7175 616c 2873 6563 7265  ssertEqual(secre
+0001b590: 742e 6765 745f 636f 6e74 656e 7428 292c  t.get_content(),
+0001b5a0: 207b 2766 6f6f 273a 2027 7827 2c20 2762   {'foo': 'x', 'b
+0001b5b0: 6172 273a 2027 7927 7d29 0a0a 2020 2020  ar': 'y'})..    
+0001b5c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001b5d0: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
+0001b5e0: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
+0001b5f0: 6172 3d54 7275 6529 2c0a 2020 2020 2020  ar=True),.      
+0001b600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b610: 2020 205b 5b27 7365 6372 6574 2d61 6464     [['secret-add
+0001b620: 272c 2027 2d2d 6c61 6265 6c27 2c20 276c  ', '--label', 'l
+0001b630: 626c 272c 2027 2d2d 6465 7363 7269 7074  bl', '--descript
+0001b640: 696f 6e27 2c20 2764 6573 6327 2c0a 2020  ion', 'desc',.  
+0001b650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b660: 2020 2020 2020 2020 2027 2d2d 6578 7069           '--expi
+0001b670: 7265 272c 2027 3230 3232 2d31 322d 3039  re', '2022-12-09
+0001b680: 5431 363a 3137 3a30 3027 2c20 272d 2d72  T16:17:00', '--r
+0001b690: 6f74 6174 6527 2c20 2768 6f75 726c 7927  otate', 'hourly'
+0001b6a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001b6b0: 2020 2020 2020 2020 2020 2020 2027 2d2d               '--
+0001b6c0: 6f77 6e65 7227 2c20 2761 7070 6c69 6361  owner', 'applica
+0001b6d0: 7469 6f6e 272c 2027 666f 6f3d 7827 2c20  tion', 'foo=x', 
+0001b6e0: 2762 6172 3d79 275d 5d29 0a0a 2020 2020  'bar=y']])..    
+0001b6f0: 6465 6620 7465 7374 5f75 6e69 745f 6164  def test_unit_ad
+0001b700: 645f 7365 6372 6574 5f73 696d 706c 6528  d_secret_simple(
+0001b710: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
+0001b720: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+0001b730: 2027 7365 6372 6574 2d61 6464 272c 2027   'secret-add', '
+0001b740: 6563 686f 2073 6563 7265 743a 3334 3527  echo secret:345'
+0001b750: 290a 0a20 2020 2020 2020 2073 6563 7265  )..        secre
+0001b760: 7420 3d20 7365 6c66 2e75 6e69 742e 6164  t = self.unit.ad
+0001b770: 645f 7365 6372 6574 287b 2766 6f6f 273a  d_secret({'foo':
+0001b780: 2027 7827 7d29 0a20 2020 2020 2020 2073   'x'}).        s
+0001b790: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
+0001b7a0: 616e 6365 2873 6563 7265 742c 206f 7073  ance(secret, ops
+0001b7b0: 2e53 6563 7265 7429 0a20 2020 2020 2020  .Secret).       
+0001b7c0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001b7d0: 6c28 7365 6372 6574 2e69 642c 2027 7365  l(secret.id, 'se
+0001b7e0: 6372 6574 3a33 3435 2729 0a20 2020 2020  cret:345').     
+0001b7f0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+0001b800: 4e6f 6e65 2873 6563 7265 742e 6c61 6265  None(secret.labe
+0001b810: 6c29 0a0a 2020 2020 2020 2020 7365 6c66  l)..        self
+0001b820: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
+0001b830: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
+0001b840: 656c 662c 2063 6c65 6172 3d54 7275 6529  elf, clear=True)
+0001b850: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001b860: 2020 2020 2020 2020 2020 205b 5b27 7365             [['se
+0001b870: 6372 6574 2d61 6464 272c 2027 2d2d 6f77  cret-add', '--ow
+0001b880: 6e65 7227 2c20 2775 6e69 7427 2c20 2766  ner', 'unit', 'f
+0001b890: 6f6f 3d78 275d 5d29 0a0a 2020 2020 6465  oo=x']])..    de
+0001b8a0: 6620 7465 7374 5f75 6e69 745f 6164 645f  f test_unit_add_
+0001b8b0: 7365 6372 6574 5f61 7267 7328 7365 6c66  secret_args(self
+0001b8c0: 293a 0a20 2020 2020 2020 2066 616b 655f  ):.        fake_
+0001b8d0: 7363 7269 7074 2873 656c 662c 2027 7365  script(self, 'se
+0001b8e0: 6372 6574 2d61 6464 272c 2027 6563 686f  cret-add', 'echo
+0001b8f0: 2073 6563 7265 743a 3435 3627 290a 0a20   secret:456').. 
+0001b900: 2020 2020 2020 2065 7870 6972 6520 3d20         expire = 
+0001b910: 6461 7465 7469 6d65 2e64 6174 6574 696d  datetime.datetim
+0001b920: 6528 3230 3232 2c20 3132 2c20 392c 2031  e(2022, 12, 9, 1
+0001b930: 362c 2032 322c 2030 290a 2020 2020 2020  6, 22, 0).      
+0001b940: 2020 7365 6372 6574 203d 2073 656c 662e    secret = self.
+0001b950: 756e 6974 2e61 6464 5f73 6563 7265 7428  unit.add_secret(
+0001b960: 7b27 666f 6f27 3a20 2777 272c 2027 6261  {'foo': 'w', 'ba
+0001b970: 7227 3a20 277a 277d 2c20 6c61 6265 6c3d  r': 'z'}, label=
+0001b980: 276c 3227 2c20 6465 7363 7269 7074 696f  'l2', descriptio
+0001b990: 6e3d 2778 797a 272c 0a20 2020 2020 2020  n='xyz',.       
+0001b9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b9b0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001b9c0: 7870 6972 653d 6578 7069 7265 2c20 726f  xpire=expire, ro
+0001b9d0: 7461 7465 3d6f 7073 2e53 6563 7265 7452  tate=ops.SecretR
+0001b9e0: 6f74 6174 652e 5945 4152 4c59 290a 2020  otate.YEARLY).  
+0001b9f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001ba00: 7445 7175 616c 2873 6563 7265 742e 6964  tEqual(secret.id
+0001ba10: 2c20 2773 6563 7265 743a 3435 3627 290a  , 'secret:456').
+0001ba20: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001ba30: 6572 7445 7175 616c 2873 6563 7265 742e  ertEqual(secret.
+0001ba40: 6c61 6265 6c2c 2027 6c32 2729 0a20 2020  label, 'l2').   
+0001ba50: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001ba60: 4571 7561 6c28 7365 6372 6574 2e67 6574  Equal(secret.get
+0001ba70: 5f63 6f6e 7465 6e74 2829 2c20 7b27 666f  _content(), {'fo
+0001ba80: 6f27 3a20 2777 272c 2027 6261 7227 3a20  o': 'w', 'bar': 
+0001ba90: 277a 277d 290a 0a20 2020 2020 2020 2073  'z'})..        s
+0001baa0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001bab0: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
+0001bac0: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
+0001bad0: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
+0001bae0: 2020 2020 2020 2020 2020 2020 2020 5b5b                [[
+0001baf0: 2773 6563 7265 742d 6164 6427 2c20 272d  'secret-add', '-
+0001bb00: 2d6c 6162 656c 272c 2027 6c32 272c 2027  -label', 'l2', '
+0001bb10: 2d2d 6465 7363 7269 7074 696f 6e27 2c20  --description', 
+0001bb20: 2778 797a 272c 0a20 2020 2020 2020 2020  'xyz',.         
+0001bb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bb40: 2020 272d 2d65 7870 6972 6527 2c20 2732    '--expire', '2
+0001bb50: 3032 322d 3132 2d30 3954 3136 3a32 323a  022-12-09T16:22:
+0001bb60: 3030 272c 2027 2d2d 726f 7461 7465 272c  00', '--rotate',
+0001bb70: 2027 7965 6172 6c79 272c 0a20 2020 2020   'yearly',.     
+0001bb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bb90: 2020 2020 2020 272d 2d6f 776e 6572 272c        '--owner',
+0001bba0: 2027 756e 6974 272c 2027 666f 6f3d 7727   'unit', 'foo=w'
+0001bbb0: 2c20 2762 6172 3d7a 275d 5d29 0a0a 2020  , 'bar=z']])..  
+0001bbc0: 2020 6465 6620 7465 7374 5f75 6e69 745f    def test_unit_
+0001bbd0: 6164 645f 7365 6372 6574 5f65 7272 6f72  add_secret_error
+0001bbe0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0001bbf0: 2023 2041 6464 6974 696f 6e61 6c20 6164   # Additional ad
+0001bc00: 645f 7365 6372 6574 2074 6573 7473 2061  d_secret tests a
+0001bc10: 7265 2064 6f6e 6520 696e 2054 6573 7441  re done in TestA
+0001bc20: 7070 6c69 6361 7469 6f6e 0a20 2020 2020  pplication.     
+0001bc30: 2020 2065 7272 6f72 7320 3d20 5b0a 2020     errors = [.  
+0001bc40: 2020 2020 2020 2020 2020 287b 2778 7927            ({'xy'
+0001bc50: 3a20 2762 6172 277d 2c20 7b7d 2c20 5661  : 'bar'}, {}, Va
+0001bc60: 6c75 6545 7272 6f72 292c 0a20 2020 2020  lueError),.     
+0001bc70: 2020 2020 2020 2028 7b27 666f 6f27 3a20         ({'foo': 
+0001bc80: 2778 277d 2c20 7b27 6578 7069 7265 273a  'x'}, {'expire':
+0001bc90: 2037 7d2c 2054 7970 6545 7272 6f72 292c   7}, TypeError),
+0001bca0: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
+0001bcb0: 2020 2066 6f72 2063 6f6e 7465 6e74 2c20     for content, 
+0001bcc0: 6b77 6172 6773 2c20 6578 635f 7479 7065  kwargs, exc_type
+0001bcd0: 2069 6e20 6572 726f 7273 3a0a 2020 2020   in errors:.    
+0001bce0: 2020 2020 2020 2020 6d73 6720 3d20 6627          msg = f'
+0001bcf0: 6578 7065 6374 6564 207b 6578 635f 7479  expected {exc_ty
+0001bd00: 7065 2e5f 5f6e 616d 655f 5f7d 2077 6865  pe.__name__} whe
+0001bd10: 6e20 6164 6469 6e67 2073 6563 7265 7420  n adding secret 
+0001bd20: 636f 6e74 656e 7420 7b63 6f6e 7465 6e74  content {content
+0001bd30: 7d27 0a20 2020 2020 2020 2020 2020 2077  }'.            w
+0001bd40: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+0001bd50: 6169 7365 7328 6578 635f 7479 7065 2c20  aises(exc_type, 
+0001bd60: 6d73 673d 6d73 6729 3a0a 2020 2020 2020  msg=msg):.      
+0001bd70: 2020 2020 2020 2020 2020 7365 6c66 2e75            self.u
+0001bd80: 6e69 742e 6164 645f 7365 6372 6574 2863  nit.add_secret(c
+0001bd90: 6f6e 7465 6e74 2c20 2a2a 6b77 6172 6773  ontent, **kwargs
+0001bda0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001bdb0: 6164 645f 7365 6372 6574 5f65 7272 6f72  add_secret_error
+0001bdc0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0001bdd0: 2065 7272 6f72 7320 3d20 5b0a 2020 2020   errors = [.    
+0001bde0: 2020 2020 2020 2020 2320 496e 7661 6c69          # Invali
+0001bdf0: 6420 636f 6e74 656e 7420 6469 6374 206f  d content dict o
+0001be00: 7220 7479 7065 730a 2020 2020 2020 2020  r types.        
+0001be10: 2020 2020 284e 6f6e 652c 207b 7d2c 2054      (None, {}, T
+0001be20: 7970 6545 7272 6f72 292c 0a20 2020 2020  ypeError),.     
+0001be30: 2020 2020 2020 2028 7b7d 2c20 7b7d 2c20         ({}, {}, 
+0001be40: 5661 6c75 6545 7272 6f72 292c 0a20 2020  ValueError),.   
+0001be50: 2020 2020 2020 2020 2028 7b62 2766 6f6f           ({b'foo
+0001be60: 272c 2027 6261 7227 7d2c 207b 7d2c 2054  ', 'bar'}, {}, T
+0001be70: 7970 6545 7272 6f72 292c 0a20 2020 2020  ypeError),.     
+0001be80: 2020 2020 2020 2028 7b33 3a20 2762 6172         ({3: 'bar
+0001be90: 277d 2c20 7b7d 2c20 5479 7065 4572 726f  '}, {}, TypeErro
+0001bea0: 7229 2c0a 2020 2020 2020 2020 2020 2020  r),.            
+0001beb0: 287b 2766 6f6f 273a 2031 2c20 2762 6172  ({'foo': 1, 'bar
+0001bec0: 273a 2032 7d2c 207b 7d2c 2054 7970 6545  ': 2}, {}, TypeE
+0001bed0: 7272 6f72 292c 0a20 2020 2020 2020 2020  rror),.         
+0001bee0: 2020 2023 2049 6e76 616c 6964 2063 6f6e     # Invalid con
+0001bef0: 7465 6e74 206b 6579 730a 2020 2020 2020  tent keys.      
+0001bf00: 2020 2020 2020 287b 2778 7927 3a20 2762        ({'xy': 'b
+0001bf10: 6172 277d 2c20 7b7d 2c20 5661 6c75 6545  ar'}, {}, ValueE
+0001bf20: 7272 6f72 292c 0a20 2020 2020 2020 2020  rror),.         
+0001bf30: 2020 2028 7b27 464f 4f27 3a20 2762 6172     ({'FOO': 'bar
+0001bf40: 277d 2c20 7b7d 2c20 5661 6c75 6545 7272  '}, {}, ValueErr
+0001bf50: 6f72 292c 0a20 2020 2020 2020 2020 2020  or),.           
+0001bf60: 2028 7b27 666f 6f2d 273a 2027 6261 7227   ({'foo-': 'bar'
+0001bf70: 7d2c 207b 7d2c 2056 616c 7565 4572 726f  }, {}, ValueErro
+0001bf80: 7229 2c0a 2020 2020 2020 2020 2020 2020  r),.            
+0001bf90: 287b 272d 666f 6f27 3a20 2762 6172 277d  ({'-foo': 'bar'}
+0001bfa0: 2c20 7b7d 2c20 5661 6c75 6545 7272 6f72  , {}, ValueError
+0001bfb0: 292c 0a20 2020 2020 2020 2020 2020 2023  ),.            #
+0001bfc0: 2049 6e76 616c 6964 2022 6578 7069 7265   Invalid "expire
+0001bfd0: 2220 7479 7065 0a20 2020 2020 2020 2020  " type.         
+0001bfe0: 2020 2028 7b27 666f 6f27 3a20 2778 277d     ({'foo': 'x'}
+0001bff0: 2c20 7b27 6578 7069 7265 273a 2037 7d2c  , {'expire': 7},
+0001c000: 2054 7970 6545 7272 6f72 292c 0a20 2020   TypeError),.   
+0001c010: 2020 2020 205d 0a20 2020 2020 2020 2066       ].        f
+0001c020: 6f72 2063 6f6e 7465 6e74 2c20 6b77 6172  or content, kwar
+0001c030: 6773 2c20 6578 635f 7479 7065 2069 6e20  gs, exc_type in 
+0001c040: 6572 726f 7273 3a0a 2020 2020 2020 2020  errors:.        
+0001c050: 2020 2020 6d73 6720 3d20 6627 6578 7065      msg = f'expe
+0001c060: 6374 6564 207b 6578 635f 7479 7065 2e5f  cted {exc_type._
+0001c070: 5f6e 616d 655f 5f7d 2077 6865 6e20 6164  _name__} when ad
+0001c080: 6469 6e67 2073 6563 7265 7420 636f 6e74  ding secret cont
+0001c090: 656e 7420 7b63 6f6e 7465 6e74 7d27 0a20  ent {content}'. 
+0001c0a0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+0001c0b0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+0001c0c0: 7328 6578 635f 7479 7065 2c20 6d73 673d  s(exc_type, msg=
+0001c0d0: 6d73 6729 3a0a 2020 2020 2020 2020 2020  msg):.          
+0001c0e0: 2020 2020 2020 7365 6c66 2e61 7070 2e61        self.app.a
+0001c0f0: 6464 5f73 6563 7265 7428 636f 6e74 656e  dd_secret(conten
+0001c100: 742c 202a 2a6b 7761 7267 7329 0a20 2020  t, **kwargs).   
+0001c110: 2020 2020 2020 2020 2077 6974 6820 7365           with se
+0001c120: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+0001c130: 6578 635f 7479 7065 2c20 6d73 673d 6d73  exc_type, msg=ms
+0001c140: 6729 3a0a 2020 2020 2020 2020 2020 2020  g):.            
+0001c150: 2020 2020 7365 6c66 2e75 6e69 742e 6164      self.unit.ad
+0001c160: 645f 7365 6372 6574 2863 6f6e 7465 6e74  d_secret(content
+0001c170: 2c20 2a2a 6b77 6172 6773 290a 0a20 2020  , **kwargs)..   
+0001c180: 2064 6566 2074 6573 745f 6765 745f 7365   def test_get_se
+0001c190: 6372 6574 5f69 6428 7365 6c66 293a 0a20  cret_id(self):. 
+0001c1a0: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+0001c1b0: 7074 2873 656c 662c 2027 7365 6372 6574  pt(self, 'secret
+0001c1c0: 2d67 6574 272c 2022 2222 6563 686f 2027  -get', """echo '
+0001c1d0: 7b22 666f 6f22 3a20 2267 227d 2722 2222  {"foo": "g"}'"""
+0001c1e0: 290a 0a20 2020 2020 2020 2073 6563 7265  )..        secre
+0001c1f0: 7420 3d20 7365 6c66 2e6d 6f64 656c 2e67  t = self.model.g
+0001c200: 6574 5f73 6563 7265 7428 6964 3d27 3132  et_secret(id='12
+0001c210: 3327 290a 2020 2020 2020 2020 7365 6c66  3').        self
+0001c220: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
+0001c230: 7265 742e 6964 2c20 2773 6563 7265 743a  ret.id, 'secret:
+0001c240: 3132 3327 290a 2020 2020 2020 2020 7365  123').        se
+0001c250: 6c66 2e61 7373 6572 7449 734e 6f6e 6528  lf.assertIsNone(
+0001c260: 7365 6372 6574 2e6c 6162 656c 290a 2020  secret.label).  
+0001c270: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001c280: 7445 7175 616c 2873 6563 7265 742e 6765  tEqual(secret.ge
+0001c290: 745f 636f 6e74 656e 7428 292c 207b 2766  t_content(), {'f
+0001c2a0: 6f6f 273a 2027 6727 7d29 0a0a 2020 2020  oo': 'g'})..    
+0001c2b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001c2c0: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
+0001c2d0: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
+0001c2e0: 6172 3d54 7275 6529 2c0a 2020 2020 2020  ar=True),.      
+0001c2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c300: 2020 205b 5b27 7365 6372 6574 2d67 6574     [['secret-get
+0001c310: 272c 2027 7365 6372 6574 3a31 3233 272c  ', 'secret:123',
+0001c320: 2027 2d2d 666f 726d 6174 3d6a 736f 6e27   '--format=json'
+0001c330: 5d5d 290a 0a20 2020 2064 6566 2074 6573  ]])..    def tes
+0001c340: 745f 6765 745f 7365 6372 6574 5f6c 6162  t_get_secret_lab
+0001c350: 656c 2873 656c 6629 3a0a 2020 2020 2020  el(self):.      
+0001c360: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+0001c370: 6c66 2c20 2773 6563 7265 742d 6765 7427  lf, 'secret-get'
+0001c380: 2c20 2222 2265 6368 6f20 277b 2266 6f6f  , """echo '{"foo
+0001c390: 223a 2022 6722 7d27 2222 2229 0a0a 2020  ": "g"}'""")..  
+0001c3a0: 2020 2020 2020 7365 6372 6574 203d 2073        secret = s
+0001c3b0: 656c 662e 6d6f 6465 6c2e 6765 745f 7365  elf.model.get_se
+0001c3c0: 6372 6574 286c 6162 656c 3d27 6c62 6c27  cret(label='lbl'
+0001c3d0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001c3e0: 7373 6572 7449 734e 6f6e 6528 7365 6372  ssertIsNone(secr
+0001c3f0: 6574 2e69 6429 0a20 2020 2020 2020 2073  et.id).        s
+0001c400: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001c410: 7365 6372 6574 2e6c 6162 656c 2c20 276c  secret.label, 'l
+0001c420: 626c 2729 0a20 2020 2020 2020 2073 656c  bl').        sel
+0001c430: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0001c440: 6372 6574 2e67 6574 5f63 6f6e 7465 6e74  cret.get_content
+0001c450: 2829 2c20 7b27 666f 6f27 3a20 2767 277d  (), {'foo': 'g'}
+0001c460: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0001c470: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
+0001c480: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
+0001c490: 6c66 2c20 636c 6561 723d 5472 7565 292c  lf, clear=True),
+0001c4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c4b0: 2020 2020 2020 2020 2020 5b5b 2773 6563            [['sec
+0001c4c0: 7265 742d 6765 7427 2c20 272d 2d6c 6162  ret-get', '--lab
+0001c4d0: 656c 272c 2027 6c62 6c27 2c20 272d 2d66  el', 'lbl', '--f
+0001c4e0: 6f72 6d61 743d 6a73 6f6e 275d 5d29 0a0a  ormat=json']])..
+0001c4f0: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
+0001c500: 5f73 6563 7265 745f 6964 5f61 6e64 5f6c  _secret_id_and_l
+0001c510: 6162 656c 2873 656c 6629 3a0a 2020 2020  abel(self):.    
+0001c520: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+0001c530: 7365 6c66 2c20 2773 6563 7265 742d 6765  self, 'secret-ge
+0001c540: 7427 2c20 2222 2265 6368 6f20 277b 2266  t', """echo '{"f
+0001c550: 6f6f 223a 2022 6822 7d27 2222 2229 0a0a  oo": "h"}'""")..
+0001c560: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
+0001c570: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
+0001c580: 7365 6372 6574 2869 643d 2731 3233 272c  secret(id='123',
+0001c590: 206c 6162 656c 3d27 6c27 290a 2020 2020   label='l').    
+0001c5a0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001c5b0: 7175 616c 2873 6563 7265 742e 6964 2c20  qual(secret.id, 
+0001c5c0: 2773 6563 7265 743a 3132 3327 290a 2020  'secret:123').  
+0001c5d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001c5e0: 7445 7175 616c 2873 6563 7265 742e 6c61  tEqual(secret.la
+0001c5f0: 6265 6c2c 2027 6c27 290a 2020 2020 2020  bel, 'l').      
+0001c600: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001c610: 616c 2873 6563 7265 742e 6765 745f 636f  al(secret.get_co
+0001c620: 6e74 656e 7428 292c 207b 2766 6f6f 273a  ntent(), {'foo':
+0001c630: 2027 6827 7d29 0a0a 2020 2020 2020 2020   'h'})..        
+0001c640: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001c650: 2866 616b 655f 7363 7269 7074 5f63 616c  (fake_script_cal
+0001c660: 6c73 2873 656c 662c 2063 6c65 6172 3d54  ls(self, clear=T
+0001c670: 7275 6529 2c0a 2020 2020 2020 2020 2020  rue),.          
+0001c680: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+0001c690: 5b27 7365 6372 6574 2d67 6574 272c 2027  ['secret-get', '
+0001c6a0: 7365 6372 6574 3a31 3233 272c 2027 2d2d  secret:123', '--
+0001c6b0: 6c61 6265 6c27 2c20 276c 272c 2027 2d2d  label', 'l', '--
+0001c6c0: 666f 726d 6174 3d6a 736f 6e27 5d5d 290a  format=json']]).
+0001c6d0: 0a20 2020 2064 6566 2074 6573 745f 6765  .    def test_ge
+0001c6e0: 745f 7365 6372 6574 5f6e 6f5f 6172 6773  t_secret_no_args
+0001c6f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001c700: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0001c710: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
+0001c720: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+0001c730: 656c 662e 6d6f 6465 6c2e 6765 745f 7365  elf.model.get_se
+0001c740: 6372 6574 2829 0a0a 2020 2020 6465 6620  cret()..    def 
+0001c750: 7465 7374 5f67 6574 5f73 6563 7265 745f  test_get_secret_
+0001c760: 6e6f 745f 666f 756e 6428 7365 6c66 293a  not_found(self):
+0001c770: 0a20 2020 2020 2020 2073 6372 6970 7420  .        script 
+0001c780: 3d20 2222 2265 6368 6f20 2745 5252 4f52  = """echo 'ERROR
+0001c790: 2073 6563 7265 7420 2231 3233 2220 6e6f   secret "123" no
+0001c7a0: 7420 666f 756e 6427 203e 2632 3b20 6578  t found' >&2; ex
+0001c7b0: 6974 2031 2222 220a 2020 2020 2020 2020  it 1""".        
+0001c7c0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+0001c7d0: 2c20 2773 6563 7265 742d 6765 7427 2c20  , 'secret-get', 
+0001c7e0: 7363 7269 7074 290a 2020 2020 2020 2020  script).        
+0001c7f0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+0001c800: 2c20 2773 6563 7265 742d 696e 666f 2d67  , 'secret-info-g
+0001c810: 6574 272c 2073 6372 6970 7429 0a0a 2020  et', script)..  
+0001c820: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+0001c830: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
+0001c840: 2e53 6563 7265 744e 6f74 466f 756e 6445  .SecretNotFoundE
+0001c850: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+0001c860: 2020 2073 656c 662e 6d6f 6465 6c2e 6765     self.model.ge
+0001c870: 745f 7365 6372 6574 2869 643d 2731 3233  t_secret(id='123
+0001c880: 2729 0a0a 2020 2020 6465 6620 7465 7374  ')..    def test
+0001c890: 5f67 6574 5f73 6563 7265 745f 6f74 6865  _get_secret_othe
+0001c8a0: 725f 6572 726f 7228 7365 6c66 293a 0a20  r_error(self):. 
+0001c8b0: 2020 2020 2020 2073 6372 6970 7420 3d20         script = 
+0001c8c0: 2222 2265 6368 6f20 2745 5252 4f52 206f  """echo 'ERROR o
+0001c8d0: 7468 6572 2065 7272 6f72 2720 3e26 323b  ther error' >&2;
+0001c8e0: 2065 7869 7420 3122 2222 0a20 2020 2020   exit 1""".     
+0001c8f0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+0001c900: 656c 662c 2027 7365 6372 6574 2d67 6574  elf, 'secret-get
+0001c910: 272c 2073 6372 6970 7429 0a20 2020 2020  ', script).     
+0001c920: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+0001c930: 656c 662c 2027 7365 6372 6574 2d69 6e66  elf, 'secret-inf
+0001c940: 6f2d 6765 7427 2c20 7363 7269 7074 290a  o-get', script).
+0001c950: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+0001c960: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+0001c970: 6f70 732e 4d6f 6465 6c45 7272 6f72 2920  ops.ModelError) 
+0001c980: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
+0001c990: 2020 2073 656c 662e 6d6f 6465 6c2e 6765     self.model.ge
+0001c9a0: 745f 7365 6372 6574 2869 643d 2731 3233  t_secret(id='123
+0001c9b0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0001c9c0: 6173 7365 7274 4e6f 7449 7349 6e73 7461  assertNotIsInsta
+0001c9d0: 6e63 6528 636d 2e65 7863 6570 7469 6f6e  nce(cm.exception
+0001c9e0: 2c20 6f70 732e 5365 6372 6574 4e6f 7446  , ops.SecretNotF
+0001c9f0: 6f75 6e64 4572 726f 7229 0a0a 0a63 6c61  oundError)...cla
+0001ca00: 7373 2054 6573 7453 6563 7265 7449 6e66  ss TestSecretInf
+0001ca10: 6f28 756e 6974 7465 7374 2e54 6573 7443  o(unittest.TestC
+0001ca20: 6173 6529 3a0a 2020 2020 6465 6620 7465  ase):.    def te
+0001ca30: 7374 5f69 6e69 7428 7365 6c66 293a 0a20  st_init(self):. 
+0001ca40: 2020 2020 2020 2069 6e66 6f20 3d20 6f70         info = op
+0001ca50: 732e 5365 6372 6574 496e 666f 280a 2020  s.SecretInfo(.  
+0001ca60: 2020 2020 2020 2020 2020 6964 3d27 3327            id='3'
+0001ca70: 2c0a 2020 2020 2020 2020 2020 2020 6c61  ,.            la
+0001ca80: 6265 6c3d 276c 626c 272c 0a20 2020 2020  bel='lbl',.     
+0001ca90: 2020 2020 2020 2072 6576 6973 696f 6e3d         revision=
+0001caa0: 372c 0a20 2020 2020 2020 2020 2020 2065  7,.            e
+0001cab0: 7870 6972 6573 3d64 6174 6574 696d 652e  xpires=datetime.
+0001cac0: 6461 7465 7469 6d65 2832 3032 322c 2031  datetime(2022, 1
+0001cad0: 322c 2039 2c20 3134 2c20 3130 2c20 3029  2, 9, 14, 10, 0)
+0001cae0: 2c0a 2020 2020 2020 2020 2020 2020 726f  ,.            ro
+0001caf0: 7461 7469 6f6e 3d6f 7073 2e53 6563 7265  tation=ops.Secre
+0001cb00: 7452 6f74 6174 652e 4d4f 4e54 484c 592c  tRotate.MONTHLY,
+0001cb10: 0a20 2020 2020 2020 2020 2020 2072 6f74  .            rot
+0001cb20: 6174 6573 3d64 6174 6574 696d 652e 6461  ates=datetime.da
+0001cb30: 7465 7469 6d65 2832 3032 332c 2031 2c20  tetime(2023, 1, 
+0001cb40: 392c 2031 342c 2031 302c 2030 292c 0a20  9, 14, 10, 0),. 
+0001cb50: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001cb60: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001cb70: 6c28 696e 666f 2e69 642c 2027 7365 6372  l(info.id, 'secr
+0001cb80: 6574 3a33 2729 0a20 2020 2020 2020 2073  et:3').        s
+0001cb90: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001cba0: 696e 666f 2e6c 6162 656c 2c20 276c 626c  info.label, 'lbl
+0001cbb0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0001cbc0: 6173 7365 7274 4571 7561 6c28 696e 666f  assertEqual(info
+0001cbd0: 2e72 6576 6973 696f 6e2c 2037 290a 2020  .revision, 7).  
+0001cbe0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001cbf0: 7445 7175 616c 2869 6e66 6f2e 6578 7069  tEqual(info.expi
+0001cc00: 7265 732c 2064 6174 6574 696d 652e 6461  res, datetime.da
+0001cc10: 7465 7469 6d65 2832 3032 322c 2031 322c  tetime(2022, 12,
+0001cc20: 2039 2c20 3134 2c20 3130 2c20 3029 290a   9, 14, 10, 0)).
+0001cc30: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001cc40: 6572 7445 7175 616c 2869 6e66 6f2e 726f  ertEqual(info.ro
+0001cc50: 7461 7469 6f6e 2c20 6f70 732e 5365 6372  tation, ops.Secr
+0001cc60: 6574 526f 7461 7465 2e4d 4f4e 5448 4c59  etRotate.MONTHLY
+0001cc70: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001cc80: 7373 6572 7445 7175 616c 2869 6e66 6f2e  ssertEqual(info.
+0001cc90: 726f 7461 7465 732c 2064 6174 6574 696d  rotates, datetim
+0001cca0: 652e 6461 7465 7469 6d65 2832 3032 332c  e.datetime(2023,
+0001ccb0: 2031 2c20 392c 2031 342c 2031 302c 2030   1, 9, 14, 10, 0
+0001ccc0: 2929 0a0a 2020 2020 2020 2020 7365 6c66  ))..        self
+0001ccd0: 2e61 7373 6572 7454 7275 6528 7265 7072  .assertTrue(repr
+0001cce0: 2869 6e66 6f29 2e73 7461 7274 7377 6974  (info).startswit
+0001ccf0: 6828 2753 6563 7265 7449 6e66 6f28 2729  h('SecretInfo(')
+0001cd00: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001cd10: 7373 6572 7454 7275 6528 7265 7072 2869  ssertTrue(repr(i
+0001cd20: 6e66 6f29 2e65 6e64 7377 6974 6828 2729  nfo).endswith(')
+0001cd30: 2729 290a 0a20 2020 2064 6566 2074 6573  '))..    def tes
+0001cd40: 745f 6672 6f6d 5f64 6963 7428 7365 6c66  t_from_dict(self
+0001cd50: 293a 0a20 2020 2020 2020 2075 7463 203d  ):.        utc =
+0001cd60: 2064 6174 6574 696d 652e 7469 6d65 7a6f   datetime.timezo
+0001cd70: 6e65 2e75 7463 0a20 2020 2020 2020 2069  ne.utc.        i
+0001cd80: 6e66 6f20 3d20 6f70 732e 5365 6372 6574  nfo = ops.Secret
+0001cd90: 496e 666f 2e66 726f 6d5f 6469 6374 2827  Info.from_dict('
+0001cda0: 7365 6372 6574 3a34 272c 207b 0a20 2020  secret:4', {.   
+0001cdb0: 2020 2020 2020 2020 2027 6c61 6265 6c27           'label'
+0001cdc0: 3a20 2766 726f 6d64 6963 7427 2c0a 2020  : 'fromdict',.  
+0001cdd0: 2020 2020 2020 2020 2020 2772 6576 6973            'revis
+0001cde0: 696f 6e27 3a20 382c 0a20 2020 2020 2020  ion': 8,.       
+0001cdf0: 2020 2020 2027 6578 7069 7265 7327 3a20       'expires': 
+0001ce00: 2732 3032 322d 3132 2d30 3954 3134 3a31  '2022-12-09T14:1
+0001ce10: 303a 3030 5a27 2c0a 2020 2020 2020 2020  0:00Z',.        
+0001ce20: 2020 2020 2772 6f74 6174 696f 6e27 3a20      'rotation': 
+0001ce30: 2779 6561 726c 7927 2c0a 2020 2020 2020  'yearly',.      
+0001ce40: 2020 2020 2020 2772 6f74 6174 6573 273a        'rotates':
+0001ce50: 2027 3230 3233 2d30 312d 3039 5431 343a   '2023-01-09T14:
+0001ce60: 3130 3a30 305a 272c 0a20 2020 2020 2020  10:00Z',.       
+0001ce70: 207d 290a 2020 2020 2020 2020 7365 6c66   }).        self
+0001ce80: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
+0001ce90: 6f2e 6964 2c20 2773 6563 7265 743a 3427  o.id, 'secret:4'
+0001cea0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001ceb0: 7373 6572 7445 7175 616c 2869 6e66 6f2e  ssertEqual(info.
+0001cec0: 6c61 6265 6c2c 2027 6672 6f6d 6469 6374  label, 'fromdict
+0001ced0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0001cee0: 6173 7365 7274 4571 7561 6c28 696e 666f  assertEqual(info
+0001cef0: 2e72 6576 6973 696f 6e2c 2038 290a 2020  .revision, 8).  
+0001cf00: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001cf10: 7445 7175 616c 2869 6e66 6f2e 6578 7069  tEqual(info.expi
+0001cf20: 7265 732c 2064 6174 6574 696d 652e 6461  res, datetime.da
+0001cf30: 7465 7469 6d65 2832 3032 322c 2031 322c  tetime(2022, 12,
+0001cf40: 2039 2c20 3134 2c20 3130 2c20 302c 2074   9, 14, 10, 0, t
+0001cf50: 7a69 6e66 6f3d 7574 6329 290a 2020 2020  zinfo=utc)).    
+0001cf60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001cf70: 7175 616c 2869 6e66 6f2e 726f 7461 7469  qual(info.rotati
+0001cf80: 6f6e 2c20 6f70 732e 5365 6372 6574 526f  on, ops.SecretRo
+0001cf90: 7461 7465 2e59 4541 524c 5929 0a20 2020  tate.YEARLY).   
+0001cfa0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001cfb0: 4571 7561 6c28 696e 666f 2e72 6f74 6174  Equal(info.rotat
+0001cfc0: 6573 2c20 6461 7465 7469 6d65 2e64 6174  es, datetime.dat
+0001cfd0: 6574 696d 6528 3230 3233 2c20 312c 2039  etime(2023, 1, 9
+0001cfe0: 2c20 3134 2c20 3130 2c20 302c 2074 7a69  , 14, 10, 0, tzi
+0001cff0: 6e66 6f3d 7574 6329 290a 0a20 2020 2020  nfo=utc))..     
+0001d000: 2020 2069 6e66 6f20 3d20 6f70 732e 5365     info = ops.Se
+0001d010: 6372 6574 496e 666f 2e66 726f 6d5f 6469  cretInfo.from_di
+0001d020: 6374 2827 7365 6372 6574 3a34 272c 207b  ct('secret:4', {
+0001d030: 0a20 2020 2020 2020 2020 2020 2027 6c61  .            'la
+0001d040: 6265 6c27 3a20 2766 726f 6d64 6963 7427  bel': 'fromdict'
+0001d050: 2c0a 2020 2020 2020 2020 2020 2020 2772  ,.            'r
+0001d060: 6576 6973 696f 6e27 3a20 382c 0a20 2020  evision': 8,.   
+0001d070: 2020 2020 2020 2020 2027 726f 7461 7469           'rotati
+0001d080: 6f6e 273a 2027 6261 6476 616c 7565 272c  on': 'badvalue',
+0001d090: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
+0001d0a0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001d0b0: 7175 616c 2869 6e66 6f2e 6964 2c20 2773  qual(info.id, 's
+0001d0c0: 6563 7265 743a 3427 290a 2020 2020 2020  ecret:4').      
+0001d0d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001d0e0: 616c 2869 6e66 6f2e 6c61 6265 6c2c 2027  al(info.label, '
+0001d0f0: 6672 6f6d 6469 6374 2729 0a20 2020 2020  fromdict').     
+0001d100: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001d110: 7561 6c28 696e 666f 2e72 6576 6973 696f  ual(info.revisio
+0001d120: 6e2c 2038 290a 2020 2020 2020 2020 7365  n, 8).        se
+0001d130: 6c66 2e61 7373 6572 7449 734e 6f6e 6528  lf.assertIsNone(
+0001d140: 696e 666f 2e65 7870 6972 6573 290a 2020  info.expires).  
+0001d150: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001d160: 7449 734e 6f6e 6528 696e 666f 2e72 6f74  tIsNone(info.rot
+0001d170: 6174 696f 6e29 0a20 2020 2020 2020 2073  ation).        s
+0001d180: 656c 662e 6173 7365 7274 4973 4e6f 6e65  elf.assertIsNone
+0001d190: 2869 6e66 6f2e 726f 7461 7465 7329 0a0a  (info.rotates)..
+0001d1a0: 2020 2020 2020 2020 696e 666f 203d 206f          info = o
+0001d1b0: 7073 2e53 6563 7265 7449 6e66 6f2e 6672  ps.SecretInfo.fr
+0001d1c0: 6f6d 5f64 6963 7428 2735 272c 207b 2772  om_dict('5', {'r
+0001d1d0: 6576 6973 696f 6e27 3a20 397d 290a 2020  evision': 9}).  
+0001d1e0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001d1f0: 7445 7175 616c 2869 6e66 6f2e 6964 2c20  tEqual(info.id, 
+0001d200: 2773 6563 7265 743a 3527 290a 2020 2020  'secret:5').    
+0001d210: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001d220: 7175 616c 2869 6e66 6f2e 7265 7669 7369  qual(info.revisi
+0001d230: 6f6e 2c20 3929 0a0a 0a63 6c61 7373 2054  on, 9)...class T
+0001d240: 6573 7453 6563 7265 7443 6c61 7373 2875  estSecretClass(u
+0001d250: 6e69 7474 6573 742e 5465 7374 4361 7365  nittest.TestCase
+0001d260: 293a 0a20 2020 206d 6178 4469 6666 203d  ):.    maxDiff =
+0001d270: 2036 3420 2a20 3130 3234 0a0a 2020 2020   64 * 1024..    
+0001d280: 6465 6620 7365 7455 7028 7365 6c66 293a  def setUp(self):
+0001d290: 0a20 2020 2020 2020 2073 656c 662e 6d6f  .        self.mo
+0001d2a0: 6465 6c20 3d20 6f70 732e 4d6f 6465 6c28  del = ops.Model(
+0001d2b0: 6f70 732e 4368 6172 6d4d 6574 6128 292c  ops.CharmMeta(),
+0001d2c0: 205f 4d6f 6465 6c42 6163 6b65 6e64 2827   _ModelBackend('
+0001d2d0: 6d79 6170 702f 3027 2929 0a0a 2020 2020  myapp/0'))..    
+0001d2e0: 6465 6620 6d61 6b65 5f73 6563 7265 7428  def make_secret(
+0001d2f0: 7365 6c66 2c20 6964 3d4e 6f6e 652c 206c  self, id=None, l
+0001d300: 6162 656c 3d4e 6f6e 652c 2063 6f6e 7465  abel=None, conte
+0001d310: 6e74 3d4e 6f6e 6529 3a0a 2020 2020 2020  nt=None):.      
+0001d320: 2020 7265 7475 726e 206f 7073 2e53 6563    return ops.Sec
+0001d330: 7265 7428 7365 6c66 2e6d 6f64 656c 2e5f  ret(self.model._
+0001d340: 6261 636b 656e 642c 2069 643d 6964 2c20  backend, id=id, 
+0001d350: 6c61 6265 6c3d 6c61 6265 6c2c 2063 6f6e  label=label, con
+0001d360: 7465 6e74 3d63 6f6e 7465 6e74 290a 0a20  tent=content).. 
+0001d370: 2020 2064 6566 2074 6573 745f 6964 5f61     def test_id_a
+0001d380: 6e64 5f6c 6162 656c 2873 656c 6629 3a0a  nd_label(self):.
+0001d390: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
+0001d3a0: 2073 656c 662e 6d61 6b65 5f73 6563 7265   self.make_secre
+0001d3b0: 7428 6964 3d27 2061 6263 2027 2c20 6c61  t(id=' abc ', la
+0001d3c0: 6265 6c3d 276c 626c 2729 0a20 2020 2020  bel='lbl').     
+0001d3d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001d3e0: 7561 6c28 7365 6372 6574 2e69 642c 2027  ual(secret.id, '
+0001d3f0: 7365 6372 6574 3a61 6263 2729 0a20 2020  secret:abc').   
+0001d400: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001d410: 4571 7561 6c28 7365 6372 6574 2e6c 6162  Equal(secret.lab
+0001d420: 656c 2c20 276c 626c 2729 0a0a 2020 2020  el, 'lbl')..    
+0001d430: 2020 2020 7365 6372 6574 203d 2073 656c      secret = sel
+0001d440: 662e 6d61 6b65 5f73 6563 7265 7428 6964  f.make_secret(id
+0001d450: 3d27 7827 290a 2020 2020 2020 2020 7365  ='x').        se
+0001d460: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0001d470: 6563 7265 742e 6964 2c20 2773 6563 7265  ecret.id, 'secre
+0001d480: 743a 7827 290a 2020 2020 2020 2020 7365  t:x').        se
+0001d490: 6c66 2e61 7373 6572 7449 734e 6f6e 6528  lf.assertIsNone(
+0001d4a0: 7365 6372 6574 2e6c 6162 656c 290a 0a20  secret.label).. 
+0001d4b0: 2020 2020 2020 2073 6563 7265 7420 3d20         secret = 
+0001d4c0: 7365 6c66 2e6d 616b 655f 7365 6372 6574  self.make_secret
+0001d4d0: 286c 6162 656c 3d27 7927 290a 2020 2020  (label='y').    
+0001d4e0: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
+0001d4f0: 734e 6f6e 6528 7365 6372 6574 2e69 6429  sNone(secret.id)
+0001d500: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001d510: 7365 7274 4571 7561 6c28 7365 6372 6574  sertEqual(secret
+0001d520: 2e6c 6162 656c 2c20 2779 2729 0a0a 2020  .label, 'y')..  
+0001d530: 2020 6465 6620 7465 7374 5f67 6574 5f63    def test_get_c
+0001d540: 6f6e 7465 6e74 5f63 6163 6865 6428 7365  ontent_cached(se
+0001d550: 6c66 293a 0a20 2020 2020 2020 2066 616b  lf):.        fak
+0001d560: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
+0001d570: 7365 6372 6574 2d67 6574 272c 2022 2222  secret-get', """
+0001d580: 6578 6974 2031 2222 2229 0a0a 2020 2020  exit 1""")..    
+0001d590: 2020 2020 7365 6372 6574 203d 2073 656c      secret = sel
+0001d5a0: 662e 6d61 6b65 5f73 6563 7265 7428 6964  f.make_secret(id
+0001d5b0: 3d27 7827 2c20 6c61 6265 6c3d 2779 272c  ='x', label='y',
+0001d5c0: 2063 6f6e 7465 6e74 3d7b 2766 6f6f 273a   content={'foo':
+0001d5d0: 2027 6261 7227 7d29 0a20 2020 2020 2020   'bar'}).       
+0001d5e0: 2063 6f6e 7465 6e74 203d 2073 6563 7265   content = secre
+0001d5f0: 742e 6765 745f 636f 6e74 656e 7428 2920  t.get_content() 
+0001d600: 2023 2077 696c 6c20 7573 6520 6361 6368   # will use cach
+0001d610: 6564 2063 6f6e 7465 6e74 2c20 6e6f 7420  ed content, not 
+0001d620: 7275 6e20 7365 6372 6574 2d67 6574 0a20  run secret-get. 
+0001d630: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001d640: 7274 4571 7561 6c28 636f 6e74 656e 742c  rtEqual(content,
+0001d650: 207b 2766 6f6f 273a 2027 6261 7227 7d29   {'foo': 'bar'})
+0001d660: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+0001d670: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
+0001d680: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
+0001d690: 662c 2063 6c65 6172 3d54 7275 6529 2c20  f, clear=True), 
+0001d6a0: 5b5d 290a 0a20 2020 2064 6566 2074 6573  [])..    def tes
+0001d6b0: 745f 6765 745f 636f 6e74 656e 745f 7265  t_get_content_re
+0001d6c0: 6672 6573 6828 7365 6c66 293a 0a20 2020  fresh(self):.   
+0001d6d0: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+0001d6e0: 2873 656c 662c 2027 7365 6372 6574 2d67  (self, 'secret-g
+0001d6f0: 6574 272c 2022 2222 6563 686f 2027 7b22  et', """echo '{"
+0001d700: 666f 6f22 3a20 2272 6566 7265 7368 6564  foo": "refreshed
+0001d710: 227d 2722 2222 290a 0a20 2020 2020 2020  "}'""")..       
+0001d720: 2073 6563 7265 7420 3d20 7365 6c66 2e6d   secret = self.m
+0001d730: 616b 655f 7365 6372 6574 2869 643d 2779  ake_secret(id='y
+0001d740: 272c 2063 6f6e 7465 6e74 3d7b 2766 6f6f  ', content={'foo
+0001d750: 273a 2027 6261 7227 7d29 0a20 2020 2020  ': 'bar'}).     
+0001d760: 2020 2063 6f6e 7465 6e74 203d 2073 6563     content = sec
+0001d770: 7265 742e 6765 745f 636f 6e74 656e 7428  ret.get_content(
+0001d780: 7265 6672 6573 683d 5472 7565 290a 2020  refresh=True).  
+0001d790: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001d7a0: 7445 7175 616c 2863 6f6e 7465 6e74 2c20  tEqual(content, 
+0001d7b0: 7b27 666f 6f27 3a20 2772 6566 7265 7368  {'foo': 'refresh
+0001d7c0: 6564 277d 290a 0a20 2020 2020 2020 2073  ed'})..        s
+0001d7d0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001d7e0: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
+0001d7f0: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
+0001d800: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
+0001d810: 2020 2020 2020 2020 2020 2020 2020 5b5b                [[
+0001d820: 2773 6563 7265 742d 6765 7427 2c20 2773  'secret-get', 's
+0001d830: 6563 7265 743a 7927 2c20 272d 2d72 6566  ecret:y', '--ref
+0001d840: 7265 7368 272c 2027 2d2d 666f 726d 6174  resh', '--format
+0001d850: 3d6a 736f 6e27 5d5d 290a 0a20 2020 2064  =json']])..    d
+0001d860: 6566 2074 6573 745f 6765 745f 636f 6e74  ef test_get_cont
+0001d870: 656e 745f 756e 6361 6368 6564 2873 656c  ent_uncached(sel
+0001d880: 6629 3a0a 2020 2020 2020 2020 6661 6b65  f):.        fake
+0001d890: 5f73 6372 6970 7428 7365 6c66 2c20 2773  _script(self, 's
+0001d8a0: 6563 7265 742d 6765 7427 2c20 2222 2265  ecret-get', """e
+0001d8b0: 6368 6f20 277b 2266 6f6f 223a 2022 6e6f  cho '{"foo": "no
+0001d8c0: 7463 6163 6865 6422 7d27 2222 2229 0a0a  tcached"}'""")..
+0001d8d0: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
+0001d8e0: 2073 656c 662e 6d61 6b65 5f73 6563 7265   self.make_secre
+0001d8f0: 7428 6964 3d27 7a27 290a 2020 2020 2020  t(id='z').      
+0001d900: 2020 636f 6e74 656e 7420 3d20 7365 6372    content = secr
+0001d910: 6574 2e67 6574 5f63 6f6e 7465 6e74 2829  et.get_content()
+0001d920: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001d930: 7365 7274 4571 7561 6c28 636f 6e74 656e  sertEqual(conten
+0001d940: 742c 207b 2766 6f6f 273a 2027 6e6f 7463  t, {'foo': 'notc
+0001d950: 6163 6865 6427 7d29 0a0a 2020 2020 2020  ached'})..      
+0001d960: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001d970: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
+0001d980: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
+0001d990: 3d54 7275 6529 2c0a 2020 2020 2020 2020  =True),.        
+0001d9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d9b0: 205b 5b27 7365 6372 6574 2d67 6574 272c   [['secret-get',
+0001d9c0: 2027 7365 6372 6574 3a7a 272c 2027 2d2d   'secret:z', '--
+0001d9d0: 666f 726d 6174 3d6a 736f 6e27 5d5d 290a  format=json']]).
+0001d9e0: 0a20 2020 2064 6566 2074 6573 745f 7065  .    def test_pe
+0001d9f0: 656b 5f63 6f6e 7465 6e74 2873 656c 6629  ek_content(self)
+0001da00: 3a0a 2020 2020 2020 2020 6661 6b65 5f73  :.        fake_s
+0001da10: 6372 6970 7428 7365 6c66 2c20 2773 6563  cript(self, 'sec
+0001da20: 7265 742d 6765 7427 2c20 2222 2265 6368  ret-get', """ech
+0001da30: 6f20 277b 2266 6f6f 223a 2022 7065 656b  o '{"foo": "peek
+0001da40: 6564 227d 2722 2222 290a 0a20 2020 2020  ed"}'""")..     
+0001da50: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
+0001da60: 2e6d 616b 655f 7365 6372 6574 2869 643d  .make_secret(id=
+0001da70: 2761 272c 206c 6162 656c 3d27 6227 290a  'a', label='b').
+0001da80: 2020 2020 2020 2020 636f 6e74 656e 7420          content 
+0001da90: 3d20 7365 6372 6574 2e70 6565 6b5f 636f  = secret.peek_co
+0001daa0: 6e74 656e 7428 290a 2020 2020 2020 2020  ntent().        
+0001dab0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001dac0: 2863 6f6e 7465 6e74 2c20 7b27 666f 6f27  (content, {'foo'
+0001dad0: 3a20 2770 6565 6b65 6427 7d29 0a0a 2020  : 'peeked'})..  
+0001dae0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001daf0: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
+0001db00: 7074 5f63 616c 6c73 2873 656c 662c 2063  pt_calls(self, c
+0001db10: 6c65 6172 3d54 7275 6529 2c0a 2020 2020  lear=True),.    
+0001db20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001db30: 2020 2020 205b 5b27 7365 6372 6574 2d67       [['secret-g
+0001db40: 6574 272c 2027 7365 6372 6574 3a61 272c  et', 'secret:a',
+0001db50: 2027 2d2d 6c61 6265 6c27 2c20 2762 272c   '--label', 'b',
+0001db60: 2027 2d2d 7065 656b 272c 2027 2d2d 666f   '--peek', '--fo
+0001db70: 726d 6174 3d6a 736f 6e27 5d5d 290a 0a20  rmat=json']]).. 
+0001db80: 2020 2064 6566 2074 6573 745f 6765 745f     def test_get_
+0001db90: 696e 666f 2873 656c 6629 3a0a 2020 2020  info(self):.    
+0001dba0: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+0001dbb0: 7365 6c66 2c20 2773 6563 7265 742d 696e  self, 'secret-in
+0001dbc0: 666f 2d67 6574 272c 2022 2222 6563 686f  fo-get', """echo
+0001dbd0: 2027 7b22 7822 3a20 7b22 6c61 6265 6c22   '{"x": {"label"
+0001dbe0: 3a20 2279 222c 2022 7265 7669 7369 6f6e  : "y", "revision
+0001dbf0: 223a 2037 7d7d 2722 2222 290a 0a20 2020  ": 7}}'""")..   
+0001dc00: 2020 2020 2023 2053 6563 7265 7420 7769       # Secret wi
+0001dc10: 7468 2049 4420 6f6e 6c79 0a20 2020 2020  th ID only.     
+0001dc20: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
+0001dc30: 2e6d 616b 655f 7365 6372 6574 2869 643d  .make_secret(id=
+0001dc40: 2778 2729 0a20 2020 2020 2020 2069 6e66  'x').        inf
+0001dc50: 6f20 3d20 7365 6372 6574 2e67 6574 5f69  o = secret.get_i
+0001dc60: 6e66 6f28 290a 2020 2020 2020 2020 7365  nfo().        se
+0001dc70: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
+0001dc80: 6e66 6f2e 6964 2c20 2773 6563 7265 743a  nfo.id, 'secret:
+0001dc90: 7827 290a 2020 2020 2020 2020 7365 6c66  x').        self
+0001dca0: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
+0001dcb0: 6f2e 6c61 6265 6c2c 2027 7927 290a 2020  o.label, 'y').  
+0001dcc0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001dcd0: 7445 7175 616c 2869 6e66 6f2e 7265 7669  tEqual(info.revi
+0001dce0: 7369 6f6e 2c20 3729 0a0a 2020 2020 2020  sion, 7)..      
+0001dcf0: 2020 2320 5365 6372 6574 2077 6974 6820    # Secret with 
+0001dd00: 6c61 6265 6c20 6f6e 6c79 0a20 2020 2020  label only.     
+0001dd10: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
+0001dd20: 2e6d 616b 655f 7365 6372 6574 286c 6162  .make_secret(lab
+0001dd30: 656c 3d27 7927 290a 2020 2020 2020 2020  el='y').        
+0001dd40: 696e 666f 203d 2073 6563 7265 742e 6765  info = secret.ge
+0001dd50: 745f 696e 666f 2829 0a20 2020 2020 2020  t_info().       
+0001dd60: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001dd70: 6c28 696e 666f 2e69 642c 2027 7365 6372  l(info.id, 'secr
+0001dd80: 6574 3a78 2729 0a20 2020 2020 2020 2073  et:x').        s
+0001dd90: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001dda0: 696e 666f 2e6c 6162 656c 2c20 2779 2729  info.label, 'y')
+0001ddb0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001ddc0: 7365 7274 4571 7561 6c28 696e 666f 2e72  sertEqual(info.r
+0001ddd0: 6576 6973 696f 6e2c 2037 290a 0a20 2020  evision, 7)..   
+0001dde0: 2020 2020 2023 2053 6563 7265 7420 7769       # Secret wi
+0001ddf0: 7468 2049 4420 616e 6420 6c61 6265 6c0a  th ID and label.
+0001de00: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
+0001de10: 2073 656c 662e 6d61 6b65 5f73 6563 7265   self.make_secre
+0001de20: 7428 6964 3d27 7827 2c20 6c61 6265 6c3d  t(id='x', label=
+0001de30: 2779 2729 0a20 2020 2020 2020 2069 6e66  'y').        inf
+0001de40: 6f20 3d20 7365 6372 6574 2e67 6574 5f69  o = secret.get_i
+0001de50: 6e66 6f28 290a 2020 2020 2020 2020 7365  nfo().        se
+0001de60: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
+0001de70: 6e66 6f2e 6964 2c20 2773 6563 7265 743a  nfo.id, 'secret:
+0001de80: 7827 290a 2020 2020 2020 2020 7365 6c66  x').        self
+0001de90: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
+0001dea0: 6f2e 6c61 6265 6c2c 2027 7927 290a 2020  o.label, 'y').  
+0001deb0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001dec0: 7445 7175 616c 2869 6e66 6f2e 7265 7669  tEqual(info.revi
+0001ded0: 7369 6f6e 2c20 3729 0a0a 2020 2020 2020  sion, 7)..      
+0001dee0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001def0: 616c 280a 2020 2020 2020 2020 2020 2020  al(.            
+0001df00: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
+0001df10: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
+0001df20: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
+0001df30: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+0001df40: 2020 205b 2773 6563 7265 742d 696e 666f     ['secret-info
+0001df50: 2d67 6574 272c 2027 7365 6372 6574 3a78  -get', 'secret:x
+0001df60: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
+0001df70: 6e27 5d2c 0a20 2020 2020 2020 2020 2020  n'],.           
+0001df80: 2020 2020 205b 2773 6563 7265 742d 696e       ['secret-in
+0001df90: 666f 2d67 6574 272c 2027 2d2d 6c61 6265  fo-get', '--labe
+0001dfa0: 6c27 2c20 2779 272c 2027 2d2d 666f 726d  l', 'y', '--form
+0001dfb0: 6174 3d6a 736f 6e27 5d2c 0a20 2020 2020  at=json'],.     
+0001dfc0: 2020 2020 2020 2020 2020 205b 2773 6563             ['sec
+0001dfd0: 7265 742d 696e 666f 2d67 6574 272c 2027  ret-info-get', '
+0001dfe0: 7365 6372 6574 3a78 272c 2027 2d2d 666f  secret:x', '--fo
+0001dff0: 726d 6174 3d6a 736f 6e27 5d2c 0a20 2020  rmat=json'],.   
+0001e000: 2020 2020 2020 2020 205d 290a 0a20 2020           ])..   
+0001e010: 2064 6566 2074 6573 745f 7365 745f 636f   def test_set_co
+0001e020: 6e74 656e 7428 7365 6c66 293a 0a20 2020  ntent(self):.   
+0001e030: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+0001e040: 2873 656c 662c 2027 7365 6372 6574 2d73  (self, 'secret-s
+0001e050: 6574 272c 2022 2222 6578 6974 2030 2222  et', """exit 0""
+0001e060: 2229 0a20 2020 2020 2020 2066 616b 655f  ").        fake_
+0001e070: 7363 7269 7074 2873 656c 662c 2027 7365  script(self, 'se
+0001e080: 6372 6574 2d69 6e66 6f2d 6765 7427 2c20  cret-info-get', 
+0001e090: 2222 2265 6368 6f20 277b 227a 223a 207b  """echo '{"z": {
+0001e0a0: 226c 6162 656c 223a 2022 7922 2c20 2272  "label": "y", "r
+0001e0b0: 6576 6973 696f 6e22 3a20 377d 7d27 2222  evision": 7}}'""
+0001e0c0: 2229 0a0a 2020 2020 2020 2020 7365 6372  ")..        secr
+0001e0d0: 6574 203d 2073 656c 662e 6d61 6b65 5f73  et = self.make_s
+0001e0e0: 6563 7265 7428 6964 3d27 7827 290a 2020  ecret(id='x').  
+0001e0f0: 2020 2020 2020 7365 6372 6574 2e73 6574        secret.set
+0001e100: 5f63 6f6e 7465 6e74 287b 2766 6f6f 273a  _content({'foo':
+0001e110: 2027 6261 7227 7d29 0a0a 2020 2020 2020   'bar'})..      
+0001e120: 2020 2320 4966 2073 6563 7265 7420 646f    # If secret do
+0001e130: 6573 6e27 7420 6861 7665 2061 6e20 4944  esn't have an ID
+0001e140: 2c20 7765 276c 6c20 7275 6e20 7365 6372  , we'll run secr
+0001e150: 6574 2d69 6e66 6f2d 6765 7420 746f 2066  et-info-get to f
+0001e160: 6574 6368 2069 740a 2020 2020 2020 2020  etch it.        
+0001e170: 7365 6372 6574 203d 2073 656c 662e 6d61  secret = self.ma
+0001e180: 6b65 5f73 6563 7265 7428 6c61 6265 6c3d  ke_secret(label=
+0001e190: 2779 2729 0a20 2020 2020 2020 2073 656c  'y').        sel
+0001e1a0: 662e 6173 7365 7274 4973 4e6f 6e65 2873  f.assertIsNone(s
+0001e1b0: 6563 7265 742e 6964 290a 2020 2020 2020  ecret.id).      
+0001e1c0: 2020 7365 6372 6574 2e73 6574 5f63 6f6e    secret.set_con
+0001e1d0: 7465 6e74 287b 2762 6172 273a 2027 666f  tent({'bar': 'fo
+0001e1e0: 6f27 7d29 0a20 2020 2020 2020 2073 656c  o'}).        sel
+0001e1f0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0001e200: 6372 6574 2e69 642c 2027 7365 6372 6574  cret.id, 'secret
+0001e210: 3a7a 2729 0a0a 2020 2020 2020 2020 7769  :z')..        wi
+0001e220: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0001e230: 6973 6573 2856 616c 7565 4572 726f 7229  ises(ValueError)
+0001e240: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0001e250: 6372 6574 2e73 6574 5f63 6f6e 7465 6e74  cret.set_content
+0001e260: 287b 2773 273a 2027 7427 7d29 2020 2320  ({'s': 't'})  # 
+0001e270: 656e 7375 7265 2069 7420 7661 6c69 6461  ensure it valida
+0001e280: 7465 7320 636f 6e74 656e 7420 286b 6579  tes content (key
+0001e290: 2074 6f6f 2073 686f 7274 290a 0a20 2020   too short)..   
+0001e2a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001e2b0: 4571 7561 6c28 6661 6b65 5f73 6372 6970  Equal(fake_scrip
+0001e2c0: 745f 6361 6c6c 7328 7365 6c66 2c20 636c  t_calls(self, cl
+0001e2d0: 6561 723d 5472 7565 292c 205b 0a20 2020  ear=True), [.   
+0001e2e0: 2020 2020 2020 2020 205b 2773 6563 7265           ['secre
+0001e2f0: 742d 7365 7427 2c20 2773 6563 7265 743a  t-set', 'secret:
+0001e300: 7827 2c20 2766 6f6f 3d62 6172 275d 2c0a  x', 'foo=bar'],.
+0001e310: 2020 2020 2020 2020 2020 2020 5b27 7365              ['se
+0001e320: 6372 6574 2d69 6e66 6f2d 6765 7427 2c20  cret-info-get', 
+0001e330: 272d 2d6c 6162 656c 272c 2027 7927 2c20  '--label', 'y', 
+0001e340: 272d 2d66 6f72 6d61 743d 6a73 6f6e 275d  '--format=json']
+0001e350: 2c0a 2020 2020 2020 2020 2020 2020 5b27  ,.            ['
+0001e360: 7365 6372 6574 2d73 6574 272c 2027 7365  secret-set', 'se
+0001e370: 6372 6574 3a7a 272c 2027 6261 723d 666f  cret:z', 'bar=fo
+0001e380: 6f27 5d2c 0a20 2020 2020 2020 205d 290a  o'],.        ]).
+0001e390: 0a20 2020 2064 6566 2074 6573 745f 7365  .    def test_se
+0001e3a0: 745f 696e 666f 2873 656c 6629 3a0a 2020  t_info(self):.  
+0001e3b0: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
+0001e3c0: 7428 7365 6c66 2c20 2773 6563 7265 742d  t(self, 'secret-
+0001e3d0: 7365 7427 2c20 2222 2265 7869 7420 3022  set', """exit 0"
+0001e3e0: 2222 290a 2020 2020 2020 2020 6661 6b65  "").        fake
+0001e3f0: 5f73 6372 6970 7428 7365 6c66 2c20 2773  _script(self, 's
+0001e400: 6563 7265 742d 696e 666f 2d67 6574 272c  ecret-info-get',
+0001e410: 2022 2222 6563 686f 2027 7b22 7a22 3a20   """echo '{"z": 
+0001e420: 7b22 6c61 6265 6c22 3a20 2279 222c 2022  {"label": "y", "
+0001e430: 7265 7669 7369 6f6e 223a 2037 7d7d 2722  revision": 7}}'"
+0001e440: 2222 290a 0a20 2020 2020 2020 2073 6563  "")..        sec
+0001e450: 7265 7420 3d20 7365 6c66 2e6d 616b 655f  ret = self.make_
+0001e460: 7365 6372 6574 2869 643d 2778 2729 0a20  secret(id='x'). 
+0001e470: 2020 2020 2020 2065 7870 6972 6520 3d20         expire = 
+0001e480: 6461 7465 7469 6d65 2e64 6174 6574 696d  datetime.datetim
+0001e490: 6528 3230 3232 2c20 3132 2c20 392c 2031  e(2022, 12, 9, 1
+0001e4a0: 362c 2035 392c 2030 290a 2020 2020 2020  6, 59, 0).      
+0001e4b0: 2020 7365 6372 6574 2e73 6574 5f69 6e66    secret.set_inf
+0001e4c0: 6f28 0a20 2020 2020 2020 2020 2020 206c  o(.            l
+0001e4d0: 6162 656c 3d27 6c61 6227 2c0a 2020 2020  abel='lab',.    
+0001e4e0: 2020 2020 2020 2020 6465 7363 7269 7074          descript
+0001e4f0: 696f 6e3d 2764 6573 6327 2c0a 2020 2020  ion='desc',.    
+0001e500: 2020 2020 2020 2020 6578 7069 7265 3d65          expire=e
+0001e510: 7870 6972 652c 0a20 2020 2020 2020 2020  xpire,.         
+0001e520: 2020 2072 6f74 6174 653d 6f70 732e 5365     rotate=ops.Se
+0001e530: 6372 6574 526f 7461 7465 2e4d 4f4e 5448  cretRotate.MONTH
+0001e540: 4c59 2c0a 2020 2020 2020 2020 290a 0a20  LY,.        ).. 
+0001e550: 2020 2020 2020 2023 2049 6620 7365 6372         # If secr
+0001e560: 6574 2064 6f65 736e 2774 2068 6176 6520  et doesn't have 
+0001e570: 616e 2049 442c 2077 6527 6c6c 2072 756e  an ID, we'll run
+0001e580: 2073 6563 7265 742d 696e 666f 2d67 6574   secret-info-get
+0001e590: 2074 6f20 6665 7463 6820 6974 0a20 2020   to fetch it.   
+0001e5a0: 2020 2020 2073 6563 7265 7420 3d20 7365       secret = se
+0001e5b0: 6c66 2e6d 616b 655f 7365 6372 6574 286c  lf.make_secret(l
+0001e5c0: 6162 656c 3d27 7927 290a 2020 2020 2020  abel='y').      
+0001e5d0: 2020 7365 6c66 2e61 7373 6572 7449 734e    self.assertIsN
+0001e5e0: 6f6e 6528 7365 6372 6574 2e69 6429 0a20  one(secret.id). 
+0001e5f0: 2020 2020 2020 2073 6563 7265 742e 7365         secret.se
+0001e600: 745f 696e 666f 286c 6162 656c 3d27 6c62  t_info(label='lb
+0001e610: 6c27 290a 2020 2020 2020 2020 7365 6c66  l').        self
+0001e620: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
+0001e630: 7265 742e 6964 2c20 2773 6563 7265 743a  ret.id, 'secret:
+0001e640: 7a27 290a 0a20 2020 2020 2020 2073 656c  z')..        sel
+0001e650: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
+0001e660: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
+0001e670: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
+0001e680: 292c 205b 0a20 2020 2020 2020 2020 2020  ), [.           
+0001e690: 205b 2773 6563 7265 742d 7365 7427 2c20   ['secret-set', 
+0001e6a0: 2773 6563 7265 743a 7827 2c20 272d 2d6c  'secret:x', '--l
+0001e6b0: 6162 656c 272c 2027 6c61 6227 2c20 272d  abel', 'lab', '-
+0001e6c0: 2d64 6573 6372 6970 7469 6f6e 272c 2027  -description', '
+0001e6d0: 6465 7363 272c 0a20 2020 2020 2020 2020  desc',.         
+0001e6e0: 2020 2020 272d 2d65 7870 6972 6527 2c20      '--expire', 
+0001e6f0: 2732 3032 322d 3132 2d30 3954 3136 3a35  '2022-12-09T16:5
+0001e700: 393a 3030 272c 2027 2d2d 726f 7461 7465  9:00', '--rotate
+0001e710: 272c 2027 6d6f 6e74 686c 7927 5d2c 0a20  ', 'monthly'],. 
+0001e720: 2020 2020 2020 2020 2020 205b 2773 6563             ['sec
+0001e730: 7265 742d 696e 666f 2d67 6574 272c 2027  ret-info-get', '
+0001e740: 2d2d 6c61 6265 6c27 2c20 2779 272c 2027  --label', 'y', '
+0001e750: 2d2d 666f 726d 6174 3d6a 736f 6e27 5d2c  --format=json'],
+0001e760: 0a20 2020 2020 2020 2020 2020 205b 2773  .            ['s
+0001e770: 6563 7265 742d 7365 7427 2c20 2773 6563  ecret-set', 'sec
+0001e780: 7265 743a 7a27 2c20 272d 2d6c 6162 656c  ret:z', '--label
+0001e790: 272c 2027 6c62 6c27 5d2c 0a20 2020 2020  ', 'lbl'],.     
+0001e7a0: 2020 205d 290a 0a20 2020 2020 2020 2077     ])..        w
+0001e7b0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+0001e7c0: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
+0001e7d0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0001e7e0: 6372 6574 2e73 6574 5f69 6e66 6f28 2920  cret.set_info() 
+0001e7f0: 2023 206e 6f20 6172 6773 2070 726f 7669   # no args provi
+0001e800: 6465 640a 0a20 2020 2064 6566 2074 6573  ded..    def tes
+0001e810: 745f 6772 616e 7428 7365 6c66 293a 0a20  t_grant(self):. 
+0001e820: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+0001e830: 7074 2873 656c 662c 2027 7365 6372 6574  pt(self, 'secret
+0001e840: 2d67 7261 6e74 272c 2022 2222 6578 6974  -grant', """exit
+0001e850: 2030 2222 2229 0a20 2020 2020 2020 2066   0""").        f
+0001e860: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+0001e870: 2027 7365 6372 6574 2d69 6e66 6f2d 6765   'secret-info-ge
+0001e880: 7427 2c20 2222 2265 6368 6f20 277b 227a  t', """echo '{"z
+0001e890: 223a 207b 226c 6162 656c 223a 2022 7922  ": {"label": "y"
+0001e8a0: 2c20 2272 6576 6973 696f 6e22 3a20 377d  , "revision": 7}
+0001e8b0: 7d27 2222 2229 0a0a 2020 2020 2020 2020  }'""")..        
+0001e8c0: 7365 6372 6574 203d 2073 656c 662e 6d61  secret = self.ma
+0001e8d0: 6b65 5f73 6563 7265 7428 6964 3d27 7827  ke_secret(id='x'
+0001e8e0: 290a 2020 2020 2020 2020 7365 6372 6574  ).        secret
+0001e8f0: 2e67 7261 6e74 2874 7970 6573 2e53 696d  .grant(types.Sim
+0001e900: 706c 654e 616d 6573 7061 6365 2869 643d  pleNamespace(id=
+0001e910: 3132 3329 290a 2020 2020 2020 2020 7365  123)).        se
+0001e920: 6372 6574 2e67 7261 6e74 2874 7970 6573  cret.grant(types
+0001e930: 2e53 696d 706c 654e 616d 6573 7061 6365  .SimpleNamespace
+0001e940: 2869 643d 3233 3429 2c20 756e 6974 3d74  (id=234), unit=t
+0001e950: 7970 6573 2e53 696d 706c 654e 616d 6573  ypes.SimpleNames
+0001e960: 7061 6365 286e 616d 653d 2761 7070 2f30  pace(name='app/0
+0001e970: 2729 290a 0a20 2020 2020 2020 2023 2049  '))..        # I
+0001e980: 6620 7365 6372 6574 2064 6f65 736e 2774  f secret doesn't
+0001e990: 2068 6176 6520 616e 2049 442c 2077 6527   have an ID, we'
+0001e9a0: 6c6c 2072 756e 2073 6563 7265 742d 696e  ll run secret-in
+0001e9b0: 666f 2d67 6574 2074 6f20 6665 7463 6820  fo-get to fetch 
+0001e9c0: 6974 0a20 2020 2020 2020 2073 6563 7265  it.        secre
+0001e9d0: 7420 3d20 7365 6c66 2e6d 616b 655f 7365  t = self.make_se
+0001e9e0: 6372 6574 286c 6162 656c 3d27 7927 290a  cret(label='y').
+0001e9f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001ea00: 6572 7449 734e 6f6e 6528 7365 6372 6574  ertIsNone(secret
+0001ea10: 2e69 6429 0a20 2020 2020 2020 2073 6563  .id).        sec
+0001ea20: 7265 742e 6772 616e 7428 7479 7065 732e  ret.grant(types.
+0001ea30: 5369 6d70 6c65 4e61 6d65 7370 6163 6528  SimpleNamespace(
+0001ea40: 6964 3d33 3435 2929 0a20 2020 2020 2020  id=345)).       
+0001ea50: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001ea60: 6c28 7365 6372 6574 2e69 642c 2027 7365  l(secret.id, 'se
+0001ea70: 6372 6574 3a7a 2729 0a0a 2020 2020 2020  cret:z')..      
+0001ea80: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001ea90: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
+0001eaa0: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
+0001eab0: 3d54 7275 6529 2c20 5b0a 2020 2020 2020  =True), [.      
+0001eac0: 2020 2020 2020 5b27 7365 6372 6574 2d67        ['secret-g
+0001ead0: 7261 6e74 272c 2027 7365 6372 6574 3a78  rant', 'secret:x
+0001eae0: 272c 2027 2d2d 7265 6c61 7469 6f6e 272c  ', '--relation',
+0001eaf0: 2027 3132 3327 5d2c 0a20 2020 2020 2020   '123'],.       
+0001eb00: 2020 2020 205b 2773 6563 7265 742d 6772       ['secret-gr
+0001eb10: 616e 7427 2c20 2773 6563 7265 743a 7827  ant', 'secret:x'
+0001eb20: 2c20 272d 2d72 656c 6174 696f 6e27 2c20  , '--relation', 
+0001eb30: 2732 3334 272c 2027 2d2d 756e 6974 272c  '234', '--unit',
+0001eb40: 2027 6170 702f 3027 5d2c 0a20 2020 2020   'app/0'],.     
+0001eb50: 2020 2020 2020 205b 2773 6563 7265 742d         ['secret-
+0001eb60: 696e 666f 2d67 6574 272c 2027 2d2d 6c61  info-get', '--la
+0001eb70: 6265 6c27 2c20 2779 272c 2027 2d2d 666f  bel', 'y', '--fo
+0001eb80: 726d 6174 3d6a 736f 6e27 5d2c 0a20 2020  rmat=json'],.   
+0001eb90: 2020 2020 2020 2020 205b 2773 6563 7265           ['secre
+0001eba0: 742d 6772 616e 7427 2c20 2773 6563 7265  t-grant', 'secre
+0001ebb0: 743a 7a27 2c20 272d 2d72 656c 6174 696f  t:z', '--relatio
+0001ebc0: 6e27 2c20 2733 3435 275d 2c0a 2020 2020  n', '345'],.    
+0001ebd0: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
+0001ebe0: 7465 7374 5f72 6576 6f6b 6528 7365 6c66  test_revoke(self
+0001ebf0: 293a 0a20 2020 2020 2020 2066 616b 655f  ):.        fake_
+0001ec00: 7363 7269 7074 2873 656c 662c 2027 7365  script(self, 'se
+0001ec10: 6372 6574 2d72 6576 6f6b 6527 2c20 2222  cret-revoke', ""
+0001ec20: 2265 7869 7420 3022 2222 290a 2020 2020  "exit 0""").    
+0001ec30: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+0001ec40: 7365 6c66 2c20 2773 6563 7265 742d 696e  self, 'secret-in
+0001ec50: 666f 2d67 6574 272c 2022 2222 6563 686f  fo-get', """echo
+0001ec60: 2027 7b22 7a22 3a20 7b22 6c61 6265 6c22   '{"z": {"label"
+0001ec70: 3a20 2279 222c 2022 7265 7669 7369 6f6e  : "y", "revision
+0001ec80: 223a 2037 7d7d 2722 2222 290a 0a20 2020  ": 7}}'""")..   
+0001ec90: 2020 2020 2073 6563 7265 7420 3d20 7365       secret = se
+0001eca0: 6c66 2e6d 616b 655f 7365 6372 6574 2869  lf.make_secret(i
+0001ecb0: 643d 2778 2729 0a20 2020 2020 2020 2073  d='x').        s
+0001ecc0: 6563 7265 742e 7265 766f 6b65 2874 7970  ecret.revoke(typ
+0001ecd0: 6573 2e53 696d 706c 654e 616d 6573 7061  es.SimpleNamespa
+0001ece0: 6365 2869 643d 3132 3329 290a 2020 2020  ce(id=123)).    
+0001ecf0: 2020 2020 7365 6372 6574 2e72 6576 6f6b      secret.revok
+0001ed00: 6528 7479 7065 732e 5369 6d70 6c65 4e61  e(types.SimpleNa
+0001ed10: 6d65 7370 6163 6528 6964 3d32 3334 292c  mespace(id=234),
+0001ed20: 2075 6e69 743d 7479 7065 732e 5369 6d70   unit=types.Simp
+0001ed30: 6c65 4e61 6d65 7370 6163 6528 6e61 6d65  leNamespace(name
+0001ed40: 3d27 6170 702f 3027 2929 0a0a 2020 2020  ='app/0'))..    
+0001ed50: 2020 2020 2320 4966 2073 6563 7265 7420      # If secret 
+0001ed60: 646f 6573 6e27 7420 6861 7665 2061 6e20  doesn't have an 
+0001ed70: 4944 2c20 7765 276c 6c20 7275 6e20 7365  ID, we'll run se
+0001ed80: 6372 6574 2d69 6e66 6f2d 6765 7420 746f  cret-info-get to
+0001ed90: 2066 6574 6368 2069 740a 2020 2020 2020   fetch it.      
+0001eda0: 2020 7365 6372 6574 203d 2073 656c 662e    secret = self.
+0001edb0: 6d61 6b65 5f73 6563 7265 7428 6c61 6265  make_secret(labe
+0001edc0: 6c3d 2779 2729 0a20 2020 2020 2020 2073  l='y').        s
+0001edd0: 656c 662e 6173 7365 7274 4973 4e6f 6e65  elf.assertIsNone
+0001ede0: 2873 6563 7265 742e 6964 290a 2020 2020  (secret.id).    
+0001edf0: 2020 2020 7365 6372 6574 2e72 6576 6f6b      secret.revok
+0001ee00: 6528 7479 7065 732e 5369 6d70 6c65 4e61  e(types.SimpleNa
+0001ee10: 6d65 7370 6163 6528 6964 3d33 3435 2929  mespace(id=345))
+0001ee20: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001ee30: 7365 7274 4571 7561 6c28 7365 6372 6574  sertEqual(secret
+0001ee40: 2e69 642c 2027 7365 6372 6574 3a7a 2729  .id, 'secret:z')
+0001ee50: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+0001ee60: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
+0001ee70: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
+0001ee80: 662c 2063 6c65 6172 3d54 7275 6529 2c20  f, clear=True), 
+0001ee90: 5b0a 2020 2020 2020 2020 2020 2020 5b27  [.            ['
+0001eea0: 7365 6372 6574 2d72 6576 6f6b 6527 2c20  secret-revoke', 
+0001eeb0: 2773 6563 7265 743a 7827 2c20 272d 2d72  'secret:x', '--r
+0001eec0: 656c 6174 696f 6e27 2c20 2731 3233 275d  elation', '123']
+0001eed0: 2c0a 2020 2020 2020 2020 2020 2020 5b27  ,.            ['
+0001eee0: 7365 6372 6574 2d72 6576 6f6b 6527 2c20  secret-revoke', 
+0001eef0: 2773 6563 7265 743a 7827 2c20 272d 2d72  'secret:x', '--r
+0001ef00: 656c 6174 696f 6e27 2c20 2732 3334 272c  elation', '234',
+0001ef10: 2027 2d2d 756e 6974 272c 2027 6170 702f   '--unit', 'app/
+0001ef20: 3027 5d2c 0a20 2020 2020 2020 2020 2020  0'],.           
+0001ef30: 205b 2773 6563 7265 742d 696e 666f 2d67   ['secret-info-g
+0001ef40: 6574 272c 2027 2d2d 6c61 6265 6c27 2c20  et', '--label', 
+0001ef50: 2779 272c 2027 2d2d 666f 726d 6174 3d6a  'y', '--format=j
+0001ef60: 736f 6e27 5d2c 0a20 2020 2020 2020 2020  son'],.         
+0001ef70: 2020 205b 2773 6563 7265 742d 7265 766f     ['secret-revo
+0001ef80: 6b65 272c 2027 7365 6372 6574 3a7a 272c  ke', 'secret:z',
+0001ef90: 2027 2d2d 7265 6c61 7469 6f6e 272c 2027   '--relation', '
+0001efa0: 3334 3527 5d2c 0a20 2020 2020 2020 205d  345'],.        ]
+0001efb0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001efc0: 7265 6d6f 7665 5f72 6576 6973 696f 6e28  remove_revision(
+0001efd0: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
+0001efe0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+0001eff0: 2027 7365 6372 6574 2d72 656d 6f76 6527   'secret-remove'
+0001f000: 2c20 2222 2265 7869 7420 3022 2222 290a  , """exit 0""").
+0001f010: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
+0001f020: 6970 7428 7365 6c66 2c20 2773 6563 7265  ipt(self, 'secre
+0001f030: 742d 696e 666f 2d67 6574 272c 2022 2222  t-info-get', """
+0001f040: 6563 686f 2027 7b22 7a22 3a20 7b22 6c61  echo '{"z": {"la
+0001f050: 6265 6c22 3a20 2279 222c 2022 7265 7669  bel": "y", "revi
+0001f060: 7369 6f6e 223a 2037 7d7d 2722 2222 290a  sion": 7}}'""").
+0001f070: 0a20 2020 2020 2020 2073 6563 7265 7420  .        secret 
+0001f080: 3d20 7365 6c66 2e6d 616b 655f 7365 6372  = self.make_secr
+0001f090: 6574 2869 643d 2778 2729 0a20 2020 2020  et(id='x').     
+0001f0a0: 2020 2073 6563 7265 742e 7265 6d6f 7665     secret.remove
+0001f0b0: 5f72 6576 6973 696f 6e28 3132 3329 0a0a  _revision(123)..
+0001f0c0: 2020 2020 2020 2020 2320 4966 2073 6563          # If sec
+0001f0d0: 7265 7420 646f 6573 6e27 7420 6861 7665  ret doesn't have
+0001f0e0: 2061 6e20 4944 2c20 7765 276c 6c20 7275   an ID, we'll ru
+0001f0f0: 6e20 7365 6372 6574 2d69 6e66 6f2d 6765  n secret-info-ge
+0001f100: 7420 746f 2066 6574 6368 2069 740a 2020  t to fetch it.  
+0001f110: 2020 2020 2020 7365 6372 6574 203d 2073        secret = s
+0001f120: 656c 662e 6d61 6b65 5f73 6563 7265 7428  elf.make_secret(
+0001f130: 6c61 6265 6c3d 2779 2729 0a20 2020 2020  label='y').     
+0001f140: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+0001f150: 4e6f 6e65 2873 6563 7265 742e 6964 290a  None(secret.id).
+0001f160: 2020 2020 2020 2020 7365 6372 6574 2e72          secret.r
+0001f170: 656d 6f76 655f 7265 7669 7369 6f6e 2832  emove_revision(2
+0001f180: 3334 290a 2020 2020 2020 2020 7365 6c66  34).        self
+0001f190: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
+0001f1a0: 7265 742e 6964 2c20 2773 6563 7265 743a  ret.id, 'secret:
+0001f1b0: 7a27 290a 0a20 2020 2020 2020 2073 656c  z')..        sel
+0001f1c0: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
+0001f1d0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
+0001f1e0: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
+0001f1f0: 292c 205b 0a20 2020 2020 2020 2020 2020  ), [.           
+0001f200: 205b 2773 6563 7265 742d 7265 6d6f 7665   ['secret-remove
+0001f210: 272c 2027 7365 6372 6574 3a78 272c 2027  ', 'secret:x', '
+0001f220: 2d2d 7265 7669 7369 6f6e 272c 2027 3132  --revision', '12
+0001f230: 3327 5d2c 0a20 2020 2020 2020 2020 2020  3'],.           
+0001f240: 205b 2773 6563 7265 742d 696e 666f 2d67   ['secret-info-g
+0001f250: 6574 272c 2027 2d2d 6c61 6265 6c27 2c20  et', '--label', 
+0001f260: 2779 272c 2027 2d2d 666f 726d 6174 3d6a  'y', '--format=j
+0001f270: 736f 6e27 5d2c 0a20 2020 2020 2020 2020  son'],.         
+0001f280: 2020 205b 2773 6563 7265 742d 7265 6d6f     ['secret-remo
+0001f290: 7665 272c 2027 7365 6372 6574 3a7a 272c  ve', 'secret:z',
+0001f2a0: 2027 2d2d 7265 7669 7369 6f6e 272c 2027   '--revision', '
+0001f2b0: 3233 3427 5d2c 0a20 2020 2020 2020 205d  234'],.        ]
+0001f2c0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001f2d0: 7265 6d6f 7665 5f61 6c6c 5f72 6576 6973  remove_all_revis
+0001f2e0: 696f 6e73 2873 656c 6629 3a0a 2020 2020  ions(self):.    
+0001f2f0: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+0001f300: 7365 6c66 2c20 2773 6563 7265 742d 7265  self, 'secret-re
+0001f310: 6d6f 7665 272c 2022 2222 6578 6974 2030  move', """exit 0
+0001f320: 2222 2229 0a20 2020 2020 2020 2066 616b  """).        fak
+0001f330: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
+0001f340: 7365 6372 6574 2d69 6e66 6f2d 6765 7427  secret-info-get'
+0001f350: 2c20 2222 2265 6368 6f20 277b 227a 223a  , """echo '{"z":
+0001f360: 207b 226c 6162 656c 223a 2022 7922 2c20   {"label": "y", 
+0001f370: 2272 6576 6973 696f 6e22 3a20 377d 7d27  "revision": 7}}'
+0001f380: 2222 2229 0a0a 2020 2020 2020 2020 7365  """)..        se
+0001f390: 6372 6574 203d 2073 656c 662e 6d61 6b65  cret = self.make
+0001f3a0: 5f73 6563 7265 7428 6964 3d27 7827 290a  _secret(id='x').
+0001f3b0: 2020 2020 2020 2020 7365 6372 6574 2e72          secret.r
+0001f3c0: 656d 6f76 655f 616c 6c5f 7265 7669 7369  emove_all_revisi
+0001f3d0: 6f6e 7328 290a 0a20 2020 2020 2020 2023  ons()..        #
+0001f3e0: 2049 6620 7365 6372 6574 2064 6f65 736e   If secret doesn
+0001f3f0: 2774 2068 6176 6520 616e 2049 442c 2077  't have an ID, w
+0001f400: 6527 6c6c 2072 756e 2073 6563 7265 742d  e'll run secret-
+0001f410: 696e 666f 2d67 6574 2074 6f20 6665 7463  info-get to fetc
+0001f420: 6820 6974 0a20 2020 2020 2020 2073 6563  h it.        sec
+0001f430: 7265 7420 3d20 7365 6c66 2e6d 616b 655f  ret = self.make_
+0001f440: 7365 6372 6574 286c 6162 656c 3d27 7927  secret(label='y'
+0001f450: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001f460: 7373 6572 7449 734e 6f6e 6528 7365 6372  ssertIsNone(secr
+0001f470: 6574 2e69 6429 0a20 2020 2020 2020 2073  et.id).        s
+0001f480: 6563 7265 742e 7265 6d6f 7665 5f61 6c6c  ecret.remove_all
+0001f490: 5f72 6576 6973 696f 6e73 2829 0a20 2020  _revisions().   
+0001f4a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001f4b0: 4571 7561 6c28 7365 6372 6574 2e69 642c  Equal(secret.id,
+0001f4c0: 2027 7365 6372 6574 3a7a 2729 0a0a 2020   'secret:z')..  
+0001f4d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001f4e0: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
+0001f4f0: 7074 5f63 616c 6c73 2873 656c 662c 2063  pt_calls(self, c
+0001f500: 6c65 6172 3d54 7275 6529 2c20 5b0a 2020  lear=True), [.  
+0001f510: 2020 2020 2020 2020 2020 5b27 7365 6372            ['secr
+0001f520: 6574 2d72 656d 6f76 6527 2c20 2773 6563  et-remove', 'sec
+0001f530: 7265 743a 7827 5d2c 0a20 2020 2020 2020  ret:x'],.       
+0001f540: 2020 2020 205b 2773 6563 7265 742d 696e       ['secret-in
+0001f550: 666f 2d67 6574 272c 2027 2d2d 6c61 6265  fo-get', '--labe
+0001f560: 6c27 2c20 2779 272c 2027 2d2d 666f 726d  l', 'y', '--form
+0001f570: 6174 3d6a 736f 6e27 5d2c 0a20 2020 2020  at=json'],.     
+0001f580: 2020 2020 2020 205b 2773 6563 7265 742d         ['secret-
+0001f590: 7265 6d6f 7665 272c 2027 7365 6372 6574  remove', 'secret
+0001f5a0: 3a7a 275d 2c0a 2020 2020 2020 2020 5d29  :z'],.        ])
+0001f5b0: 0a0a 0a63 6c61 7373 2054 6573 7450 6f72  ...class TestPor
+0001f5c0: 7473 2875 6e69 7474 6573 742e 5465 7374  ts(unittest.Test
+0001f5d0: 4361 7365 293a 0a20 2020 2064 6566 2073  Case):.    def s
+0001f5e0: 6574 5570 2873 656c 6629 3a0a 2020 2020  etUp(self):.    
+0001f5f0: 2020 2020 7365 6c66 2e6d 6f64 656c 203d      self.model =
+0001f600: 206f 7073 2e6d 6f64 656c 2e4d 6f64 656c   ops.model.Model
+0001f610: 286f 7073 2e63 6861 726d 2e43 6861 726d  (ops.charm.Charm
+0001f620: 4d65 7461 2829 2c20 6f70 732e 6d6f 6465  Meta(), ops.mode
+0001f630: 6c2e 5f4d 6f64 656c 4261 636b 656e 6428  l._ModelBackend(
+0001f640: 276d 7961 7070 2f30 2729 290a 2020 2020  'myapp/0')).    
+0001f650: 2020 2020 7365 6c66 2e75 6e69 7420 3d20      self.unit = 
+0001f660: 7365 6c66 2e6d 6f64 656c 2e75 6e69 740a  self.model.unit.
+0001f670: 0a20 2020 2064 6566 2074 6573 745f 6f70  .    def test_op
+0001f680: 656e 5f70 6f72 7428 7365 6c66 293a 0a20  en_port(self):. 
+0001f690: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+0001f6a0: 7074 2873 656c 662c 2027 6f70 656e 2d70  pt(self, 'open-p
+0001f6b0: 6f72 7427 2c20 2765 7869 7420 3027 290a  ort', 'exit 0').
+0001f6c0: 0a20 2020 2020 2020 2073 656c 662e 756e  .        self.un
+0001f6d0: 6974 2e6f 7065 6e5f 706f 7274 2827 7463  it.open_port('tc
+0001f6e0: 7027 2c20 3830 3830 290a 2020 2020 2020  p', 8080).      
+0001f6f0: 2020 7365 6c66 2e75 6e69 742e 6f70 656e    self.unit.open
+0001f700: 5f70 6f72 7428 2755 4450 272c 2034 3030  _port('UDP', 400
+0001f710: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
+0001f720: 756e 6974 2e6f 7065 6e5f 706f 7274 2827  unit.open_port('
+0001f730: 6963 6d70 2729 0a0a 2020 2020 2020 2020  icmp')..        
+0001f740: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001f750: 2866 616b 655f 7363 7269 7074 5f63 616c  (fake_script_cal
+0001f760: 6c73 2873 656c 662c 2063 6c65 6172 3d54  ls(self, clear=T
+0001f770: 7275 6529 2c20 5b0a 2020 2020 2020 2020  rue), [.        
+0001f780: 2020 2020 5b27 6f70 656e 2d70 6f72 7427      ['open-port'
+0001f790: 2c20 2738 3038 302f 7463 7027 5d2c 0a20  , '8080/tcp'],. 
+0001f7a0: 2020 2020 2020 2020 2020 205b 276f 7065             ['ope
+0001f7b0: 6e2d 706f 7274 272c 2027 3430 3030 2f75  n-port', '4000/u
+0001f7c0: 6470 275d 2c0a 2020 2020 2020 2020 2020  dp'],.          
+0001f7d0: 2020 5b27 6f70 656e 2d70 6f72 7427 2c20    ['open-port', 
+0001f7e0: 2769 636d 7027 5d2c 0a20 2020 2020 2020  'icmp'],.       
+0001f7f0: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
+0001f800: 745f 6f70 656e 5f70 6f72 745f 6572 726f  t_open_port_erro
+0001f810: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
+0001f820: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+0001f830: 662c 2027 6f70 656e 2d70 6f72 7427 2c20  f, 'open-port', 
+0001f840: 2265 6368 6f20 2745 5252 4f52 2062 6164  "echo 'ERROR bad
+0001f850: 2070 726f 746f 636f 6c27 203e 2632 3b20   protocol' >&2; 
+0001f860: 6578 6974 2031 2229 0a0a 2020 2020 2020  exit 1")..      
+0001f870: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+0001f880: 7274 5261 6973 6573 286f 7073 2e4d 6f64  rtRaises(ops.Mod
+0001f890: 656c 4572 726f 7229 2061 7320 636d 3a0a  elError) as cm:.
+0001f8a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001f8b0: 2e75 6e69 742e 6f70 656e 5f70 6f72 7428  .unit.open_port(
+0001f8c0: 2766 7470 272c 2038 3038 3029 0a20 2020  'ftp', 8080).   
+0001f8d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001f8e0: 4571 7561 6c28 7374 7228 636d 2e65 7863  Equal(str(cm.exc
+0001f8f0: 6570 7469 6f6e 292c 2027 4552 524f 5220  eption), 'ERROR 
+0001f900: 6261 6420 7072 6f74 6f63 6f6c 5c6e 2729  bad protocol\n')
+0001f910: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+0001f920: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
+0001f930: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
+0001f940: 662c 2063 6c65 6172 3d54 7275 6529 2c20  f, clear=True), 
+0001f950: 5b0a 2020 2020 2020 2020 2020 2020 5b27  [.            ['
+0001f960: 6f70 656e 2d70 6f72 7427 2c20 2738 3038  open-port', '808
+0001f970: 302f 6674 7027 5d2c 0a20 2020 2020 2020  0/ftp'],.       
+0001f980: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
+0001f990: 745f 636c 6f73 655f 706f 7274 2873 656c  t_close_port(sel
+0001f9a0: 6629 3a0a 2020 2020 2020 2020 6661 6b65  f):.        fake
+0001f9b0: 5f73 6372 6970 7428 7365 6c66 2c20 2763  _script(self, 'c
+0001f9c0: 6c6f 7365 2d70 6f72 7427 2c20 2765 7869  lose-port', 'exi
+0001f9d0: 7420 3027 290a 0a20 2020 2020 2020 2073  t 0')..        s
+0001f9e0: 656c 662e 756e 6974 2e63 6c6f 7365 5f70  elf.unit.close_p
+0001f9f0: 6f72 7428 2774 6370 272c 2038 3038 3029  ort('tcp', 8080)
+0001fa00: 0a20 2020 2020 2020 2073 656c 662e 756e  .        self.un
+0001fa10: 6974 2e63 6c6f 7365 5f70 6f72 7428 2755  it.close_port('U
+0001fa20: 4450 272c 2034 3030 3029 0a20 2020 2020  DP', 4000).     
+0001fa30: 2020 2073 656c 662e 756e 6974 2e63 6c6f     self.unit.clo
+0001fa40: 7365 5f70 6f72 7428 2769 636d 7027 290a  se_port('icmp').
+0001fa50: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001fa60: 7365 7274 4571 7561 6c28 6661 6b65 5f73  sertEqual(fake_s
+0001fa70: 6372 6970 745f 6361 6c6c 7328 7365 6c66  cript_calls(self
+0001fa80: 2c20 636c 6561 723d 5472 7565 292c 205b  , clear=True), [
+0001fa90: 0a20 2020 2020 2020 2020 2020 205b 2763  .            ['c
+0001faa0: 6c6f 7365 2d70 6f72 7427 2c20 2738 3038  lose-port', '808
+0001fab0: 302f 7463 7027 5d2c 0a20 2020 2020 2020  0/tcp'],.       
+0001fac0: 2020 2020 205b 2763 6c6f 7365 2d70 6f72       ['close-por
+0001fad0: 7427 2c20 2734 3030 302f 7564 7027 5d2c  t', '4000/udp'],
+0001fae0: 0a20 2020 2020 2020 2020 2020 205b 2763  .            ['c
+0001faf0: 6c6f 7365 2d70 6f72 7427 2c20 2769 636d  lose-port', 'icm
+0001fb00: 7027 5d2c 0a20 2020 2020 2020 205d 290a  p'],.        ]).
+0001fb10: 0a20 2020 2064 6566 2074 6573 745f 636c  .    def test_cl
+0001fb20: 6f73 655f 706f 7274 5f65 7272 6f72 2873  ose_port_error(s
+0001fb30: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
+0001fb40: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+0001fb50: 2763 6c6f 7365 2d70 6f72 7427 2c20 2265  'close-port', "e
+0001fb60: 6368 6f20 2745 5252 4f52 2062 6164 2070  cho 'ERROR bad p
+0001fb70: 726f 746f 636f 6c27 203e 2632 3b20 6578  rotocol' >&2; ex
+0001fb80: 6974 2031 2229 0a0a 2020 2020 2020 2020  it 1")..        
+0001fb90: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0001fba0: 5261 6973 6573 286f 7073 2e4d 6f64 656c  Raises(ops.Model
+0001fbb0: 4572 726f 7229 2061 7320 636d 3a0a 2020  Error) as cm:.  
+0001fbc0: 2020 2020 2020 2020 2020 7365 6c66 2e75            self.u
+0001fbd0: 6e69 742e 636c 6f73 655f 706f 7274 2827  nit.close_port('
+0001fbe0: 6674 7027 2c20 3830 3830 290a 2020 2020  ftp', 8080).    
+0001fbf0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001fc00: 7175 616c 2873 7472 2863 6d2e 6578 6365  qual(str(cm.exce
+0001fc10: 7074 696f 6e29 2c20 2745 5252 4f52 2062  ption), 'ERROR b
+0001fc20: 6164 2070 726f 746f 636f 6c5c 6e27 290a  ad protocol\n').
+0001fc30: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001fc40: 7365 7274 4571 7561 6c28 6661 6b65 5f73  sertEqual(fake_s
+0001fc50: 6372 6970 745f 6361 6c6c 7328 7365 6c66  cript_calls(self
+0001fc60: 2c20 636c 6561 723d 5472 7565 292c 205b  , clear=True), [
+0001fc70: 0a20 2020 2020 2020 2020 2020 205b 2763  .            ['c
+0001fc80: 6c6f 7365 2d70 6f72 7427 2c20 2738 3038  lose-port', '808
+0001fc90: 302f 6674 7027 5d2c 0a20 2020 2020 2020  0/ftp'],.       
+0001fca0: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
+0001fcb0: 745f 6f70 656e 6564 5f70 6f72 7473 2873  t_opened_ports(s
+0001fcc0: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
+0001fcd0: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+0001fce0: 276f 7065 6e65 642d 706f 7274 7327 2c20  'opened-ports', 
+0001fcf0: 2222 2265 6368 6f20 3830 3830 2f74 6370  """echo 8080/tcp
+0001fd00: 3b20 6563 686f 2069 636d 7022 2222 290a  ; echo icmp""").
+0001fd10: 0a20 2020 2020 2020 2070 6f72 7473 5f73  .        ports_s
+0001fd20: 6574 203d 2073 656c 662e 756e 6974 2e6f  et = self.unit.o
+0001fd30: 7065 6e65 645f 706f 7274 7328 290a 2020  pened_ports().  
+0001fd40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001fd50: 7449 7349 6e73 7461 6e63 6528 706f 7274  tIsInstance(port
+0001fd60: 735f 7365 742c 2073 6574 290a 2020 2020  s_set, set).    
+0001fd70: 2020 2020 706f 7274 7320 3d20 736f 7274      ports = sort
+0001fd80: 6564 2870 6f72 7473 5f73 6574 2c20 6b65  ed(ports_set, ke
+0001fd90: 793d 6c61 6d62 6461 2070 3a20 2870 2e70  y=lambda p: (p.p
+0001fda0: 726f 746f 636f 6c2c 2070 2e70 6f72 7429  rotocol, p.port)
+0001fdb0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001fdc0: 7373 6572 7445 7175 616c 286c 656e 2870  ssertEqual(len(p
+0001fdd0: 6f72 7473 292c 2032 290a 2020 2020 2020  orts), 2).      
+0001fde0: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
+0001fdf0: 6e73 7461 6e63 6528 706f 7274 735b 305d  nstance(ports[0]
+0001fe00: 2c20 6f70 732e 4f70 656e 6564 506f 7274  , ops.OpenedPort
+0001fe10: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001fe20: 7373 6572 7445 7175 616c 2870 6f72 7473  ssertEqual(ports
+0001fe30: 5b30 5d2e 7072 6f74 6f63 6f6c 2c20 2769  [0].protocol, 'i
+0001fe40: 636d 7027 290a 2020 2020 2020 2020 7365  cmp').        se
+0001fe50: 6c66 2e61 7373 6572 7449 734e 6f6e 6528  lf.assertIsNone(
+0001fe60: 706f 7274 735b 305d 2e70 6f72 7429 0a20  ports[0].port). 
+0001fe70: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001fe80: 7274 4973 496e 7374 616e 6365 2870 6f72  rtIsInstance(por
+0001fe90: 7473 5b31 5d2c 206f 7073 2e4f 7065 6e65  ts[1], ops.Opene
+0001fea0: 6450 6f72 7429 0a20 2020 2020 2020 2073  dPort).        s
+0001feb0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001fec0: 706f 7274 735b 315d 2e70 726f 746f 636f  ports[1].protoco
+0001fed0: 6c2c 2027 7463 7027 290a 2020 2020 2020  l, 'tcp').      
+0001fee0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001fef0: 616c 2870 6f72 7473 5b31 5d2e 706f 7274  al(ports[1].port
+0001ff00: 2c20 3830 3830 290a 0a20 2020 2020 2020  , 8080)..       
+0001ff10: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001ff20: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
+0001ff30: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
+0001ff40: 5472 7565 292c 205b 0a20 2020 2020 2020  True), [.       
+0001ff50: 2020 2020 205b 276f 7065 6e65 642d 706f       ['opened-po
+0001ff60: 7274 7327 2c20 2727 5d2c 0a20 2020 2020  rts', ''],.     
+0001ff70: 2020 205d 290a 0a20 2020 2064 6566 2074     ])..    def t
+0001ff80: 6573 745f 6f70 656e 6564 5f70 6f72 7473  est_opened_ports
+0001ff90: 5f77 6172 6e69 6e67 7328 7365 6c66 293a  _warnings(self):
+0001ffa0: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+0001ffb0: 7269 7074 2873 656c 662c 2027 6f70 656e  ript(self, 'open
+0001ffc0: 6564 2d70 6f72 7473 272c 2022 2222 6563  ed-ports', """ec
+0001ffd0: 686f 2038 3038 302f 7463 703b 2065 6368  ho 8080/tcp; ech
+0001ffe0: 6f20 3132 3334 2f66 7470 3b20 6563 686f  o 1234/ftp; echo
+0001fff0: 2031 3030 302d 3230 3030 2f75 6470 2222   1000-2000/udp""
+00020000: 2229 0a0a 2020 2020 2020 2020 7769 7468  ")..        with
+00020010: 2073 656c 662e 6173 7365 7274 4c6f 6773   self.assertLogs
+00020020: 2827 6f70 732e 6d6f 6465 6c27 2c20 6c65  ('ops.model', le
+00020030: 7665 6c3d 2757 4152 4e49 4e47 2729 2061  vel='WARNING') a
+00020040: 7320 636d 3a0a 2020 2020 2020 2020 2020  s cm:.          
+00020050: 2020 706f 7274 735f 7365 7420 3d20 7365    ports_set = se
+00020060: 6c66 2e75 6e69 742e 6f70 656e 6564 5f70  lf.unit.opened_p
+00020070: 6f72 7473 2829 0a20 2020 2020 2020 2073  orts().        s
+00020080: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00020090: 6c65 6e28 636d 2e6f 7574 7075 7429 2c20  len(cm.output), 
+000200a0: 3229 0a20 2020 2020 2020 2073 656c 662e  2).        self.
+000200b0: 6173 7365 7274 5265 6765 7828 636d 2e6f  assertRegex(cm.o
+000200c0: 7574 7075 745b 305d 2c20 7227 5741 524e  utput[0], r'WARN
+000200d0: 494e 473a 6f70 732e 6d6f 6465 6c3a 2e2a  ING:ops.model:.*
+000200e0: 7072 6f74 6f63 6f6c 2e2a 2729 0a20 2020  protocol.*').   
+000200f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00020100: 5265 6765 7828 636d 2e6f 7574 7075 745b  Regex(cm.output[
+00020110: 315d 2c20 7227 5741 524e 494e 473a 6f70  1], r'WARNING:op
+00020120: 732e 6d6f 6465 6c3a 2e2a 7261 6e67 652e  s.model:.*range.
+00020130: 2a27 290a 0a20 2020 2020 2020 2073 656c  *')..        sel
+00020140: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
+00020150: 6365 2870 6f72 7473 5f73 6574 2c20 7365  ce(ports_set, se
+00020160: 7429 0a20 2020 2020 2020 2070 6f72 7473  t).        ports
+00020170: 203d 2073 6f72 7465 6428 706f 7274 735f   = sorted(ports_
+00020180: 7365 742c 206b 6579 3d6c 616d 6264 6120  set, key=lambda 
+00020190: 703a 2028 702e 7072 6f74 6f63 6f6c 2c20  p: (p.protocol, 
+000201a0: 702e 706f 7274 2929 0a20 2020 2020 2020  p.port)).       
+000201b0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000201c0: 6c28 6c65 6e28 706f 7274 7329 2c20 3229  l(len(ports), 2)
+000201d0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000201e0: 7365 7274 4973 496e 7374 616e 6365 2870  sertIsInstance(p
+000201f0: 6f72 7473 5b30 5d2c 206f 7073 2e4f 7065  orts[0], ops.Ope
+00020200: 6e65 6450 6f72 7429 0a20 2020 2020 2020  nedPort).       
+00020210: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00020220: 6c28 706f 7274 735b 305d 2e70 726f 746f  l(ports[0].proto
+00020230: 636f 6c2c 2027 7463 7027 290a 2020 2020  col, 'tcp').    
+00020240: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00020250: 7175 616c 2870 6f72 7473 5b30 5d2e 706f  qual(ports[0].po
+00020260: 7274 2c20 3830 3830 290a 2020 2020 2020  rt, 8080).      
+00020270: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
+00020280: 6e73 7461 6e63 6528 706f 7274 735b 315d  nstance(ports[1]
+00020290: 2c20 6f70 732e 4f70 656e 6564 506f 7274  , ops.OpenedPort
+000202a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000202b0: 7373 6572 7445 7175 616c 2870 6f72 7473  ssertEqual(ports
+000202c0: 5b31 5d2e 7072 6f74 6f63 6f6c 2c20 2775  [1].protocol, 'u
+000202d0: 6470 2729 0a20 2020 2020 2020 2073 656c  dp').        sel
+000202e0: 662e 6173 7365 7274 4571 7561 6c28 706f  f.assertEqual(po
+000202f0: 7274 735b 315d 2e70 6f72 742c 2031 3030  rts[1].port, 100
+00020300: 3029 0a0a 2020 2020 2020 2020 7365 6c66  0)..        self
+00020310: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
+00020320: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
+00020330: 656c 662c 2063 6c65 6172 3d54 7275 6529  elf, clear=True)
+00020340: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+00020350: 5b27 6f70 656e 6564 2d70 6f72 7473 272c  ['opened-ports',
+00020360: 2027 275d 2c0a 2020 2020 2020 2020 5d29   ''],.        ])
+00020370: 0a0a 0a69 6620 5f5f 6e61 6d65 5f5f 203d  ...if __name__ =
+00020380: 3d20 225f 5f6d 6169 6e5f 5f22 3a0a 2020  = "__main__":.  
+00020390: 2020 756e 6974 7465 7374 2e6d 6169 6e28    unittest.main(
+000203a0: 290a                                     ).
```

### Comparing `ops-2.3.0/test/test_pebble.py` & `ops-2.4.0/test/test_pebble.py`

 * *Files identical despite different names*

### Comparing `ops-2.3.0/test/test_private.py` & `ops-2.4.0/test/test_private.py`

 * *Files identical despite different names*

### Comparing `ops-2.3.0/test/test_storage.py` & `ops-2.4.0/test/test_storage.py`

 * *Files identical despite different names*

### Comparing `ops-2.3.0/test/test_testing.py` & `ops-2.4.0/test/test_testing.py`

 * *Files identical despite different names*

